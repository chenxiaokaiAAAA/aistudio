# 本地测试配置指南

## 测试场景

- **云端服务器（模拟阿里云）**：本机 `192.168.2.54`
- **门店设备**：`sm003`（连接打印机 `\\sm003\HP OfficeJet Pro 7730 series`）

## 方案：直接使用内网IP（无需frp）

由于都在同一局域网，可以直接使用内网IP，不需要frp内网穿透。

---

## 步骤1：在门店设备（sm003）上运行打印代理服务

### 1.1 安装依赖

在 `sm003` 设备上打开命令行，执行：

```bash
pip install flask flask-cors pywin32 requests Pillow
```

### 1.2 配置并运行打印代理服务

在 `sm003` 设备上：

```bash
# 设置环境变量（Windows PowerShell）
$env:LOCAL_PRINTER_PATH = "\\sm003\HP OfficeJet Pro 7730 series"
$env:PRINT_PROXY_PORT = "8888"
$env:PRINT_PROXY_API_KEY = "test-key-123"  # 可选，用于测试

# 或者使用CMD
set LOCAL_PRINTER_PATH=\\sm003\HP OfficeJet Pro 7730 series
set PRINT_PROXY_PORT=8888
set PRINT_PROXY_API_KEY=test-key-123

# 运行打印代理服务
python print_proxy_server.py
```

**预期输出：**
```
🚀 打印代理服务启动
   打印机路径: \\sm003\HP OfficeJet Pro 7730 series
   监听端口: 8888
   平台: win32
   API密钥: 已启用
 * Running on http://0.0.0.0:8888
```

### 1.3 获取sm003的内网IP地址

在 `sm003` 设备上执行：

```bash
# Windows
ipconfig

# 查找 IPv4 地址，例如：192.168.2.100
```

**假设 sm003 的IP是：`192.168.2.100`**

---

## 步骤2：在本机（192.168.2.54）配置打印代理服务地址

### 2.1 访问管理后台

1. 打开浏览器，访问：`http://192.168.2.54:8002/admin/print-config`（根据您的实际端口调整）
2. 登录管理后台

### 2.2 填写打印代理服务配置

在"本地打印机配置"部分：

- **打印代理服务地址（远程部署）**：`http://192.168.2.100:8888`
  - 格式：`http://sm003的IP地址:8888`
  
- **打印代理服务API密钥（可选）**：`test-key-123`
  - 如果设置了API密钥，这里也要填写相同的值

### 2.3 测试连接

点击"测试打印空白页"按钮，应该会：
- ✅ 成功：打印一张空白测试页
- ❌ 失败：检查网络连接、防火墙、服务是否运行

---

## 步骤3：测试完整流程

### 3.1 测试打印代理服务是否运行

在本机（192.168.2.54）打开浏览器或使用curl：

```bash
# 测试健康检查
curl http://192.168.2.100:8888/health

# 预期返回：
# {"status":"ok","printer_path":"\\\\sm003\\HP OfficeJet Pro 7730 series",...}
```

### 3.2 测试打印功能

在管理后台点击"测试打印空白页"按钮，或使用curl：

```bash
# 测试打印空白页
curl -X POST http://192.168.2.100:8888/print/blank \
  -H "Content-Type: application/json" \
  -H "X-API-Key: test-key-123" \
  -d "{\"api_key\":\"test-key-123\"}"

# 预期返回：
# {"success":true,"message":"空白测试页打印成功",...}
```

---

## 故障排查

### 问题1：无法连接到打印代理服务

**检查项：**
1. ✅ sm003设备上的打印代理服务是否运行？
   ```bash
   # 在sm003上检查端口是否监听
   netstat -an | findstr 8888
   ```

2. ✅ 防火墙是否阻止了8888端口？
   - 在sm003上，打开Windows防火墙
   - 添加入站规则，允许8888端口

3. ✅ 本机能否ping通sm003？
   ```bash
   ping 192.168.2.100
   ```

### 问题2：打印失败

**检查项：**
1. ✅ 打印机是否在线？
   - 在sm003上，打开"设备和打印机"，检查打印机状态

2. ✅ 打印机路径是否正确？
   - 确认 `\\sm003\HP OfficeJet Pro 7730 series` 是正确的打印机名称

3. ✅ 是否有打印权限？
   - 确保运行打印代理服务的用户有打印权限

### 问题3：API密钥验证失败

**检查项：**
1. ✅ sm003上的API密钥是否与配置一致？
   - 检查环境变量 `PRINT_PROXY_API_KEY`
   - 检查管理后台配置的API密钥

---

## 完整测试流程

### 测试1：健康检查
```bash
curl http://192.168.2.100:8888/health
```

### 测试2：测试打印机连接
```bash
curl http://192.168.2.100:8888/test
```

### 测试3：打印空白页
```bash
curl -X POST http://192.168.2.100:8888/print/blank \
  -H "Content-Type: application/json" \
  -H "X-API-Key: test-key-123"
```

### 测试4：通过管理后台测试
1. 访问：`http://192.168.2.54:8002/admin/print-config`
2. 填写配置：`http://192.168.2.100:8888`
3. 点击"测试打印空白页"

---

## 下一步：部署到阿里云

测试成功后，部署到阿里云时：

1. **在sm003上运行frp客户端**（将服务暴露到公网）
2. **在阿里云配置中使用frp公网地址**（而不是内网IP）

参考 `README_打印代理服务.md` 中的frp配置说明。
