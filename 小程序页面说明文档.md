# 小程序页面说明文档

## 产品详情页面

# 产品详情页面文档

## 页面路径
`pages/product-detail/product-detail`

## 页面说明
产品详情页面是一个独立的页面，用于展示产品详细信息，包括产品图片、特点、尺寸和颜色选择等。用户可以选择规格后点击"选择风格"按钮进入风格选择流程。

## 文件结构
- `product-detail.wxml` - 页面结构
- `product-detail.wxss` - 页面样式
- `product-detail.js` - 页面逻辑
- `product-detail.json` - 页面配置

## 页面结构

### 1. 顶部导航栏
- 返回按钮（左侧）
- 页面标题"产品详情"（居中）
- 右侧占位（预留）

### 2. 产品图片轮播
- 使用 `swiper` 组件展示多张产品图片
- 图片指示器显示当前图片位置（如：1/3）
- 点击图片可全屏预览

### 3. 产品信息
- **产品特点**：显示产品描述
- **选择尺寸**：展示可选的尺寸选项
- **选择颜色**：展示可选的颜色选项（如果有）

### 4. 底部操作栏（固定在底部）
- **返回按钮**：灰色背景，返回上一页
- **选择风格按钮**：渐变背景（红色到青色），跳转到风格选择页面

## 核心方法

### `onLoad(options)`
页面加载时调用，接收产品ID参数。

**参数：**
- `options.productId` 或 `options.id` - 产品ID

**功能：**
- 验证产品ID是否存在
- 调用 `loadProductDetail()` 加载产品详情
- 记录页面访问

### `loadProductDetail()`
加载产品详情数据。

**功能：**
- 请求产品列表API
- 转换图片URL为HTTPS
- 提取尺寸选项和颜色选项
- 更新页面数据

### `selectSize(e)`
选择尺寸规格。

**功能：**
- 从事件数据中获取选中的尺寸
- 更新 `selectedSize` 数据
- 调用 `updateSpec()` 更新规格信息

### `selectColor(e)`
选择颜色选项。

**功能：**
- 从事件数据中获取选中的颜色对象
- 更新 `selectedColor` 数据
- 如果颜色有图片，更新主图显示
- 调用 `updateSpec()` 更新规格信息

### `startCustom(e)`
开始定制流程。

**功能：**
- 验证是否选择了尺寸和颜色（如果有）
- 保存产品信息到全局数据
- 跳转到风格选择页面

**验证：**
- 必须选择尺寸
- 如果有颜色选项，必须选择颜色

### `navigateBack()`
返回上一页。

## 数据字段

### `data` 对象
```javascript
{
  productId: null,           // 产品ID
  currentProduct: {},        // 当前产品信息
  selectedSpec: '',          // 选中的规格名称
  selectedSpecPrice: '',     // 选中的规格价格
  selectedSize: '',          // 选中的尺寸
  selectedColor: {},         // 选中的颜色对象
  sizeOptions: [],           // 尺寸选项列表
  colorOptions: [],         // 颜色选项列表
  loading: true,             // 加载状态
  currentImageIndex: 0,      // 当前图片索引
  showImagePreview: false,   // 是否显示图片预览
  previewImageIndex: 0       // 预览图片索引
}
```

## 样式说明

### 底部操作栏样式
- 使用 `position: fixed` 固定在底部
- 高度：`100rpx`
- 使用 `flex` 布局，两个按钮并排显示
- 返回按钮：固定宽度 `160rpx`，灰色背景
- 选择风格按钮：`flex: 1` 占据剩余空间，渐变背景

### 按钮样式
- 使用 `view` 组件而非 `button` 组件，避免小程序默认样式问题
- 按钮高度：`80rpx`
- 圆角：`40rpx`
- 文字使用 `text` 组件包裹，便于样式控制

## API接口

### 获取产品列表
- **URL**: `/api/miniprogram/products`
- **方法**: `GET`
- **返回**: 产品列表数据，包含尺寸和颜色选项

## 跳转关系

### 进入页面
- 从产品馆页面（`pages/product/product`）点击产品进入

### 离开页面
- 点击"返回"按钮：返回上一页
- 点击"选择风格"按钮：跳转到 `pages/custom/select-style/select-style`

## 注意事项

1. **按钮显示问题**：使用 `view` + `text` 结构而非 `button` 组件，避免小程序默认样式干扰
2. **数据绑定**：使用 `productId || currentProduct.id` 确保按钮能获取到产品ID
3. **颜色选项**：颜色选项可能是对象格式 `{name: "黑色", image_url: "..."}`，需要正确处理
4. **图片URL**：所有图片URL都需要转换为HTTPS协议
5. **规格验证**：跳转到风格选择前，必须验证已选择尺寸和颜色（如果有）

## 常见问题

### Q: 底部按钮不显示？
A: 检查以下几点：
1. 确保使用 `view` 组件而非 `button` 组件
2. 检查CSS样式是否正确，特别是 `flex` 和 `width` 属性
3. 确保数据绑定正确，`currentProduct.id` 或 `productId` 有值
4. 检查是否有其他样式覆盖了按钮样式

### Q: 选择颜色后主图不更新？
A: 检查 `selectColor` 方法中是否正确处理了颜色对象的 `image_url` 字段。

### Q: 跳转到风格选择页面后，风格列表为空？
A: 检查产品是否绑定了风格分类，以及 `startCustom` 方法是否正确保存了产品信息到全局数据。

## 维护建议

1. **保持代码简洁**：避免过度嵌套的组件结构
2. **样式统一**：参考其他正常工作的页面（如 `shop-detail`）的样式实现
3. **数据验证**：在关键操作前进行数据验证
4. **错误处理**：添加适当的错误提示和异常处理
5. **日志记录**：在关键方法中添加 `console.log` 便于调试


---

## 登录授权页面-背景图配置说明

# 登录页面背景图配置说明

## 背景图配置位置

登录页面的背景图配置在以下文件中：

### 1. WXML文件
**文件路径**: `aistudio-小程序/pages/login/login.wxml`

**位置**: 第3-13行，`bg-container` 区域

```xml
<view class="bg-container">
  <!-- 方式1: 使用背景图片 -->
  <image class="bg-image" src="/images/login/bg.jpg" mode="aspectFill"></image>
  
  <!-- 方式2: 使用渐变背景（当前使用） -->
  <view class="bg-gradient"></view>
</view>
```

### 2. WXSS文件
**文件路径**: `aistudio-小程序/pages/login/login.wxss`

**位置**: 第25-34行，`.bg-gradient` 样式

## 配置方式

### 方式一：使用背景图片（推荐）

1. **准备背景图片**
   - 将背景图片放在 `aistudio-小程序/images/login/` 目录下
   - 建议图片尺寸：750x1334px（iPhone标准尺寸）
   - 建议格式：JPG或PNG
   - 建议文件大小：< 200KB（优化加载速度）

2. **修改WXML文件**
   - 打开 `pages/login/login.wxml`
   - 找到 `bg-container` 区域
   - 取消注释背景图片的代码：
   ```xml
   <image class="bg-image" src="/images/login/bg.jpg" mode="aspectFill"></image>
   ```
   - 注释掉渐变背景（可选）：
   ```xml
   <!-- <view class="bg-gradient"></view> -->
   ```

3. **修改WXSS文件（可选）**
   - 如果需要调整背景图片的显示效果，编辑 `pages/login/login.wxss`
   - `.bg-image` 样式已定义，可以直接使用
   - 如果需要添加遮罩效果，可以使用 `.bg-image-overlay`

### 方式二：使用CSS渐变背景（当前使用）

当前使用的是CSS渐变背景，颜色配置在：

**文件**: `pages/login/login.wxss`
**位置**: 第32行

```css
background: linear-gradient(135deg, #a8e6cf 0%, #7dd3a0 50%, #5cb88d 100%);
```

**修改颜色**：
- `#a8e6cf`: 浅绿色（顶部）
- `#7dd3a0`: 中绿色（中间）
- `#5cb88d`: 深绿色（底部）

## 背景图片路径说明

### 推荐路径结构
```
aistudio-小程序/
  └── images/
      └── login/
          ├── bg.jpg          (主背景图)
          ├── bg-mobile.jpg   (移动端优化版，可选)
          └── bg-tablet.jpg   (平板端优化版，可选)
```

### 图片路径格式
- 绝对路径：`/images/login/bg.jpg`（推荐）
- 相对路径：`../../images/login/bg.jpg`（不推荐）

## 样式配置选项

### 背景图片样式（.bg-image）
```css
.bg-image {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
}
```

### 图片显示模式
在WXML中使用 `mode` 属性控制图片显示方式：
- `aspectFill`: 保持宽高比，填充整个容器（推荐）
- `aspectFit`: 保持宽高比，完整显示图片
- `widthFix`: 宽度不变，高度自适应
- `heightFix`: 高度不变，宽度自适应

### 添加遮罩效果
如果需要让背景图片变暗，可以添加遮罩：

```xml
<view class="bg-container">
  <image class="bg-image" src="/images/login/bg.jpg" mode="aspectFill"></image>
  <view class="bg-image-overlay"></view> <!-- 添加遮罩 -->
</view>
```

遮罩样式：
```css
.bg-image-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.2); /* 调整透明度 */
  z-index: 1;
}
```

## 性能优化建议

1. **图片压缩**
   - 使用工具压缩图片（如 TinyPNG）
   - 目标大小：< 200KB

2. **图片格式**
   - JPG：适合照片类背景
   - PNG：适合有透明度的背景
   - WebP：如果小程序支持，优先使用

3. **懒加载**
   - 背景图片可以使用 `lazy-load="true"` 属性

4. **响应式图片**
   - 可以为不同屏幕尺寸准备不同尺寸的图片

## 快速配置步骤

1. 将背景图片放到 `images/login/` 目录
2. 打开 `pages/login/login.wxml`
3. 取消注释背景图片代码
4. 修改图片路径为你的文件名
5. 保存并重新编译

## 示例配置

### 示例1：使用背景图片
```xml
<view class="bg-container">
  <image class="bg-image" src="/images/login/bg.jpg" mode="aspectFill" lazy-load="true"></image>
  <view class="bg-image-overlay"></view>
</view>
```

### 示例2：渐变背景 + 背景图片混合
```xml
<view class="bg-container">
  <image class="bg-image" src="/images/login/bg.jpg" mode="aspectFill"></image>
  <view class="bg-gradient" style="opacity: 0.3;"></view> <!-- 降低不透明度，混合效果 -->
</view>
```

## 注意事项

1. 图片路径必须是相对于小程序根目录的绝对路径
2. 图片文件需要在小程序编译时包含在项目中
3. 建议使用本地图片，避免使用网络图片（可能有加载延迟）
4. 背景图片会覆盖渐变背景，需要二选一或调整透明度混合


---

## 登录授权页面

# 登录授权页面文档

## 页面概述

登录授权页面是小程序的入口页面，采用海马体风格设计，包含隐私保护协议弹窗和自动注册功能。

**页面路径**: `pages/login/login`

## 功能特性

### 1. 隐私保护协议
- 首次打开小程序时显示隐私保护协议弹窗
- 用户必须同意协议才能继续使用
- 协议状态保存在本地存储中

### 2. 自动授权注册
- 用户同意协议后，自动获取微信openid
- 自动生成用户ID和推广码
- 自动注册用户到后端系统
- 注册成功后自动跳转到首页

### 3. 海马体风格设计
- 绿色渐变背景（#a8e6cf → #7dd3a0 → #5cb88d）
- 抽象装饰元素动画
- 白色圆角弹窗
- 绿色同意按钮，灰色不同意按钮

## 页面结构

### WXML结构
```
login-page
├── bg-container (背景容器)
│   ├── bg-gradient (渐变背景)
│   └── bg-decoration (装饰元素)
├── content-wrapper (主内容)
│   └── brand-section (品牌区域)
│       ├── brand-logo (Logo)
│       ├── brand-name (品牌名称)
│       └── brand-slogan (品牌标语)
├── privacy-modal (隐私协议弹窗)
│   └── modal-content
│       ├── modal-header (标题)
│       ├── modal-body (内容)
│       └── modal-footer (按钮)
├── loading-mask (加载遮罩)
└── footer-brand (底部品牌标识)
```

## 核心方法

### 1. onLoad(options)
页面加载时执行：
- 检查是否已登录
- 检查是否已同意隐私协议
- 显示隐私协议弹窗或开始授权流程

### 2. handleAgree()
用户点击"同意"按钮：
- 保存同意状态到本地存储
- 关闭弹窗
- 开始授权和注册流程

### 3. handleDisagree()
用户点击"不同意"按钮：
- 显示提示信息
- 保持弹窗显示

### 4. startAuthAndRegister()
开始授权和注册流程：
1. 获取openId
2. 生成用户ID和推广码
3. 获取用户信息（可选）
4. 注册用户到后端
5. 保存到本地存储
6. 跳转到首页

### 5. getOpenId()
获取微信openId：
- 先检查本地存储
- 调用wx.login获取code
- 请求后端接口获取openId
- 支持多种响应格式

### 6. getUserProfile()
获取用户信息（可选）：
- 使用wx.getUserProfile
- 不强制要求，失败时使用默认信息

### 7. generateUserInfo(openId)
生成用户ID和推广码：
- 基于openId生成稳定的用户信息
- 使用userGenerator工具

### 8. registerUser(data)
注册用户到后端：
- 发送用户信息到后端API
- 包含userId、promotionCode、openId等

## 数据存储

### 本地存储字段
- `hasAgreedPrivacy`: 是否已同意隐私协议
- `openId`: 微信openId
- `userId`: 用户ID
- `promotionCode`: 推广码
- `isRegistered`: 是否已注册
- `userInfo`: 用户信息（可选）

## 样式设计

### 颜色方案
- **主背景**: 绿色渐变 (#a8e6cf → #7dd3a0 → #5cb88d)
- **弹窗背景**: 白色 (#fff)
- **同意按钮**: 绿色渐变 (#5cb88d → #7dd3a0)
- **不同意按钮**: 灰色 (#f5f5f5)
- **文字颜色**: 
  - 标题: #333
  - 正文: #666
  - 链接: #5cb88d

### 动画效果
- 背景装饰元素浮动动画
- 弹窗滑入动画
- 品牌区域淡入动画

## API接口

### 1. 获取openId
```
POST /api/user/openid
Body: { code: string }
Response: { success: true, openid: string }
```

### 2. 注册用户
```
POST /api/user/register
Body: {
  userId: string,
  promotionCode: string,
  openId: string,
  userInfo: object,
  phoneNumber: string,
  promotion_params: object
}
Response: { success: true }
```

## 错误处理

1. **获取openId失败**: 显示错误提示，允许重试
2. **注册失败**: 显示错误提示，允许重试
3. **用户拒绝授权**: 使用默认用户信息继续注册

## 页面跳转

- **成功注册后**: 使用`wx.switchTab`跳转到首页
- **switchTab失败**: 使用`wx.reLaunch`作为降级方案

## 注意事项

1. 隐私协议弹窗只在首次打开时显示
2. 用户信息获取是可选的，不强制要求
3. 所有关键数据都会保存到本地存储
4. 注册流程是自动的，用户无需手动操作

## 维护说明

### 修改隐私政策内容
编辑 `login.wxml` 中的 `modal-text` 部分

### 修改品牌信息
编辑 `login.wxml` 中的 `brand-section` 部分

### 修改样式
编辑 `login.wxss` 文件，主要修改：
- `.bg-gradient`: 背景渐变颜色
- `.modal-content`: 弹窗样式
- `.btn-agree`: 同意按钮样式

### 修改API接口
编辑 `login.js` 中的：
- `getOpenId()`: openId接口地址
- `registerUser()`: 注册接口地址

## 版本历史

- **v1.0.0** (2024-01-XX): 初始版本，海马体风格设计


---

## 登录流程重构说明

# 登录流程重构说明（海马体风格）

## 概述

按照海马体小程序的登录逻辑，重构了登录流程，分为两个阶段：
1. **隐私保护授权**：首次打开小程序时的隐私协议确认
2. **用户登录注册**：提交订单前的登录/注册流程

## 页面结构

### 1. 隐私保护页面（pages/login/login）

**功能**：
- 只做隐私保护协议确认
- 不涉及任何用户注册或openID注册
- 同意后直接进入首页

**流程**：
1. 首次打开小程序，检查是否已同意隐私协议
2. 如果未同意，显示隐私协议弹窗
3. 用户点击"同意"后，保存同意状态
4. 直接跳转到首页

**文件位置**：
- `pages/login/login.wxml`
- `pages/login/login.js`
- `pages/login/login.wxss`
- `pages/login/login.json`

### 2. 登录注册页面（pages/auth-login/auth-login）

**功能**：
- 当用户准备提交订单时弹出
- 提供两种登录方式：
  - **快捷登录**：获取手机号授权，自动登录/注册
  - **手机号安全登录**：跳转到手机号登录页面

**流程**：
1. 用户点击"快捷登录"
2. 获取微信手机号授权
3. 调用后端接口获取手机号
4. 检查用户是否已注册
5. 如果已注册，直接登录；如果未注册，自动注册
6. 登录成功后返回之前的页面

**文件位置**：
- `pages/auth-login/auth-login.wxml`
- `pages/auth-login/auth-login.js`
- `pages/auth-login/auth-login.wxss`
- `pages/auth-login/auth-login.json`

### 3. 手机号登录页面（pages/phone-login/phone-login）

**功能**：
- 输入手机号
- 同意隐私协议
- 发送验证码

**流程**：
1. 用户输入手机号
2. 检查是否同意隐私协议（未同意时显示弹窗）
3. 点击提交按钮，发送验证码
4. 跳转到验证码输入页面

**文件位置**：
- `pages/phone-login/phone-login.wxml`
- `pages/phone-login/phone-login.js`
- `pages/phone-login/phone-login.wxss`
- `pages/phone-login/phone-login.json`

### 4. 验证码输入页面（pages/verify-code/verify-code）

**功能**：
- 输入4位验证码
- 自动验证
- 重新发送验证码

**流程**：
1. 显示手机号（部分隐藏）
2. 用户输入4位验证码
3. 输入完成后自动验证
4. 验证成功后，检查用户是否已注册
5. 如果已注册，直接登录；如果未注册，自动注册
6. 登录成功后返回之前的页面

**文件位置**：
- `pages/verify-code/verify-code.wxml`
- `pages/verify-code/verify-code.js`
- `pages/verify-code/verify-code.wxss`
- `pages/verify-code/verify-code.json`

## 登录状态检查

在以下页面提交订单前会检查登录状态：
- `pages/custom/confirm-order/confirm-order.js`
- `pages/order/order.js`
- `pages/shop-detail/shop-detail.js`

**检查逻辑**：
```javascript
checkLoginStatus() {
  const userId = wx.getStorageSync('userId');
  const userPhone = wx.getStorageSync('userPhone');
  return !!(userId && userPhone);
}
```

**未登录处理**：
- 显示提示弹窗
- 用户确认后跳转到登录页面
- 保存当前页面路径作为返回URL
- 登录成功后自动返回

## 数据存储

### 本地存储字段

- `hasAgreedPrivacy`: 是否已同意隐私协议
- `userId`: 用户ID
- `userPhone`: 用户手机号
- `openId`: 微信openId
- `promotionCode`: 推广码
- `isRegistered`: 是否已注册

## API接口

### 1. 获取手机号
```
POST /api/user/getPhoneNumber
Body: { code: string }
Response: { success: true, phoneNumber: string }
```

### 2. 检查用户是否存在
```
POST /api/user/check
Body: { phoneNumber: string, openId: string }
Response: { success: true, exists: boolean, userId: string }
```

### 3. 发送短信验证码
```
POST /api/user/sendSmsCode
Body: { phoneNumber: string }
Response: { success: true }
```

### 4. 验证短信验证码
```
POST /api/user/verifySmsCode
Body: { phoneNumber: string, code: string }
Response: { success: true }
```

### 5. 用户注册
```
POST /api/user/register
Body: {
  userId: string,
  promotionCode: string,
  openId: string,
  phoneNumber: string,
  userInfo: object
}
Response: { success: true }
```

## 页面跳转流程

### 快捷登录流程
```
订单页面 → 登录页面 → 获取手机号授权 → 自动注册/登录 → 返回订单页面
```

### 手机号安全登录流程
```
订单页面 → 登录页面 → 手机号登录页面 → 验证码页面 → 自动注册/登录 → 返回订单页面
```

## 注意事项

1. **隐私协议**：首次打开小程序时必须同意，后续不再显示
2. **登录时机**：只在提交订单时检查登录状态
3. **自动注册**：未注册用户会自动完成注册
4. **返回逻辑**：登录成功后自动返回之前的页面
5. **页面路径**：使用`returnUrl`参数保存返回路径

## 维护说明

### 修改登录页面样式
编辑对应的 `.wxss` 文件

### 修改登录逻辑
编辑对应的 `.js` 文件

### 添加新的登录方式
1. 创建新页面
2. 在 `app.json` 中注册
3. 在 `auth-login` 页面添加入口

## 版本历史

- **v2.0.0** (2024-01-XX): 重构登录流程，采用海马体风格


---

