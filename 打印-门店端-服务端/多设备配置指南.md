# 多设备配置指南

## 📋 概述

当有多台门店设备需要同时使用打印服务时，每台设备需要使用不同的公网端口。

## 🚀 快速配置步骤

### 当前已配置的设备

- **设备1（本机）**：端口 **18888** → 使用 `一键启动服务.bat`
- **设备2（另一台）**：端口 **18889** → 使用 `一键启动服务_18889.bat`

### 为第3台设备添加配置（端口 18890）

如果需要添加更多设备，按以下步骤操作：

#### 步骤1：创建新的 FRP 配置文件

在 `frp_0.66.0_windows_amd64/` 目录下创建 `frpc_18890.toml`：

```toml
serverAddr = "121.43.143.59"
serverPort = 7000
auth.token = "your-secret-token-123456"

[[proxies]]
name = "print_proxy_18890"
type = "tcp"
localIP = "127.0.0.1"
localPort = 8888
remotePort = 18890
```

#### 步骤2：创建新的启动脚本

复制 `一键启动服务_18889.bat` 并重命名为 `一键启动服务_18890.bat`，然后修改：

1. 将标题中的端口号改为 18890
2. 将 `frpc_18889.toml` 改为 `frpc_18890.toml`
3. 将显示信息中的端口号改为 18890

#### 步骤3：配置服务器端

1. **阿里云安全组**：开放端口 **18890**
2. **管理后台**：为该门店配置打印代理地址为 `http://121.43.143.59:18890`

## 📝 配置模板

### FRP 配置文件模板

```toml
serverAddr = "121.43.143.59"
serverPort = 7000
auth.token = "your-secret-token-123456"

[[proxies]]
name = "print_proxy_XXXXX"  # 改为唯一的名称，如 print_proxy_18890
type = "tcp"
localIP = "127.0.0.1"
localPort = 8888
remotePort = XXXXX  # 改为新的端口号，如 18890
```

### 启动脚本模板

复制 `一键启动服务_18889.bat`，然后全局替换：
- `18889` → `新端口号`（如 `18890`）
- `print_proxy_18889` → `print_proxy_新端口号`

## ⚠️ 重要注意事项

1. **端口唯一性**：每台设备必须使用不同的 `remotePort`
2. **端口范围**：建议使用 18888-18999 范围内的端口
3. **安全组配置**：每添加一个新端口，都要在阿里云安全组中开放
4. **管理后台配置**：每个门店在管理后台需要配置对应的打印代理地址
5. **Token 一致性**：所有设备的 `auth.token` 必须与服务器端 `frps.toml` 中的一致

## 🔍 验证配置

### 检查端口是否被占用

在服务器上执行：
```bash
netstat -tuln | grep 18888
netstat -tuln | grep 18889
netstat -tuln | grep 18890
```

### 检查 FRP 连接状态

在客户端窗口应该看到：
```
login to server success, get run id [xxxxx]
start proxy success
```

### 测试打印代理服务

访问对应端口的健康检查：
- 端口 18888：`http://121.43.143.59:18888/health`
- 端口 18889：`http://121.43.143.59:18889/health`
- 端口 18890：`http://121.43.143.59:18890/health`

应该返回：`{"status": "ok"}`

## 📊 设备端口分配表

| 设备编号 | 门店名称 | 公网端口 | 启动脚本 | 配置文件 |
|---------|---------|---------|---------|---------|
| 设备1 | sm003 | 18888 | `一键启动服务.bat` | `frpc.toml` |
| 设备2 | （待填写） | 18889 | `一键启动服务_18889.bat` | `frpc_18889.toml` |
| 设备3 | （待填写） | 18890 | `一键启动服务_18890.bat` | `frpc_18890.toml` |

## 🔧 故障排查

### 问题：端口冲突

如果启动时提示端口已被占用：
1. 检查是否有其他设备正在使用该端口
2. 检查服务器端 FRP 日志：`journalctl -u frps -f`
3. 更换为其他未使用的端口

### 问题：连接失败

1. 检查服务器地址和端口是否正确
2. 检查 Token 是否与服务器端一致
3. 检查网络连接是否正常
4. 检查阿里云安全组是否开放了对应端口

## 📞 相关文档

- `使用说明.md` - 单设备使用说明
- `一键启动服务.bat` - 端口 18888 启动脚本
- `一键启动服务_18889.bat` - 端口 18889 启动脚本
