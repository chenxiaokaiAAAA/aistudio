# 打印服务一键启动说明

## 📋 概述

`一键启动服务.bat` 可以同时启动两个服务：
1. **打印代理服务** - 接收打印请求并转发到本地打印机
2. **FRP 客户端** - 将本地服务映射到公网

## 🚀 使用方法

### 方法一：一键启动（推荐）

**单设备配置（端口 18888）**：
- 直接双击运行 `一键启动服务.bat`，脚本会自动：
  - 在新窗口启动打印代理服务
  - 在当前窗口启动 FRP 客户端并显示连接状态
  - 映射到公网端口：**18888**

**多设备配置（端口 18889）**：
- 另一台设备运行 `一键启动服务_18889.bat`
  - 映射到公网端口：**18889**
  - 其他配置与 18888 相同

### 方法二：分别启动

如果需要单独启动某个服务：

1. **只启动打印代理服务**：
   - 运行 `start_print_proxy.bat`

2. **只启动 FRP 客户端**：
   - 端口 18888：运行 `frp_0.66.0_windows_amd64/启动客户端.bat`
   - 端口 18889：运行 `frpc.exe -c frpc_18889.toml`

## ⚙️ 配置说明

### 打印代理服务配置

在 `一键启动服务.bat` 中可以修改以下配置：

```batch
set LOCAL_PRINTER_PATH=\\sm003\HP OfficeJet Pro 7730 series  # 打印机路径
set PRINT_PROXY_PORT=8888                                      # 服务端口
set PRINT_PROXY_API_KEY=test-key-123                          # API密钥（可选）
```

### FRP 客户端配置

**端口 18888 配置**（`frp_0.66.0_windows_amd64/frpc.toml`）：

```toml
serverAddr = "121.43.143.59"  # FRP 服务器地址
serverPort = 7000             # FRP 服务器端口
auth.token = "your-secret-token-123456"  # 认证令牌（需与服务器一致）

[[proxies]]
name = "print_proxy"
type = "tcp"
localIP = "127.0.0.1"    # 本地服务地址
localPort = 8888         # 本地服务端口
remotePort = 18888       # 公网映射端口
```

**端口 18889 配置**（`frp_0.66.0_windows_amd64/frpc_18889.toml`）：

```toml
serverAddr = "121.43.143.59"  # FRP 服务器地址
serverPort = 7000             # FRP 服务器端口
auth.token = "your-secret-token-123456"  # 认证令牌（需与服务器一致）

[[proxies]]
name = "print_proxy_18889"
type = "tcp"
localIP = "127.0.0.1"    # 本地服务地址
localPort = 8888         # 本地服务端口
remotePort = 18889       # 公网映射端口（另一台设备）
```

### 多设备配置说明

如果有多台门店设备需要同时使用打印服务：

1. **设备1**：使用 `一键启动服务.bat` → 映射到端口 **18888**
2. **设备2**：使用 `一键启动服务_18889.bat` → 映射到端口 **18889**
3. **设备3**：可以创建 `frpc_18890.toml` 和 `一键启动服务_18890.bat`，映射到端口 **18890**

**重要提示**：
- 每台设备必须使用不同的 `remotePort`
- 在管理后台配置时，需要为每个门店配置对应的打印代理地址：
  - 门店1：`http://121.43.143.59:18888`
  - 门店2：`http://121.43.143.59:18889`
- 确保阿里云安全组开放了所有使用的端口（18888、18889 等）

## 🔍 验证服务状态

### 检查打印代理服务

1. 打开浏览器访问：`http://127.0.0.1:8888/health`
2. 应该看到 `{"status": "ok"}` 响应

### 检查 FRP 连接

在 FRP 客户端窗口应该看到类似输出：
```
login to server success, get run id [xxxxx]
start proxy success
```

## 🛑 停止服务

1. **停止 FRP 客户端**：在 FRP 客户端窗口按 `Ctrl+C`
2. **停止打印代理服务**：关闭打印代理服务的窗口

## ⚠️ 注意事项

1. **端口占用**：确保端口 8888 未被其他程序占用
2. **防火墙**：确保 Windows 防火墙允许 Python 和 frpc.exe 访问网络
3. **FRP Token**：确保 `frpc.toml` 中的 `auth.token` 与服务器端 `frps.toml` 中的一致
4. **打印机路径**：确保 `LOCAL_PRINTER_PATH` 指向正确的网络打印机路径

## 🔧 故障排查

### 问题1：打印代理服务启动失败

- 检查 Python 是否已安装
- 检查端口 8888 是否被占用：`netstat -ano | findstr :8888`
- 检查打印机路径是否正确

### 问题2：FRP 客户端连接失败

- 检查服务器地址和端口是否正确
- 检查 Token 是否与服务器端一致
- 检查网络连接是否正常
- 检查阿里云安全组是否开放了端口 7000

### 问题3：无法从公网访问

- 检查 FRP 服务器是否正常运行
- 检查阿里云安全组是否开放了对应端口（18888、18889 等）
- 检查管理后台配置的打印代理地址是否正确：
  - 端口 18888：`http://121.43.143.59:18888`
  - 端口 18889：`http://121.43.143.59:18889`

## 📞 相关文件

- `一键启动服务.bat` - 整合启动脚本（端口 18888，推荐使用）
- `一键启动服务_18889.bat` - 整合启动脚本（端口 18889，另一台设备使用）
- `start_print_proxy.bat` - 单独启动打印代理服务
- `print_proxy_server.py` - 打印代理服务主程序
- `frp_0.66.0_windows_amd64/启动客户端.bat` - 单独启动 FRP 客户端（端口 18888）
- `frp_0.66.0_windows_amd64/frpc.toml` - FRP 客户端配置文件（端口 18888）
- `frp_0.66.0_windows_amd64/frpc_18889.toml` - FRP 客户端配置文件（端口 18889）
