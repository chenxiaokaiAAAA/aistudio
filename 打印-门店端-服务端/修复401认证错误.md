# 修复 401 认证错误

## 问题描述

打印请求返回 `401 Unauthorized` 错误，原因是：
- 打印代理服务已启用 API_KEY 验证（`your-secret-token-123456`）
- 服务器端发送请求时没有包含 API_KEY

## 解决方案

### 方案一：在服务器端配置 API_KEY（推荐）

1. **登录管理后台**
   - 访问：`http://121.43.143.59/admin/system-config`

2. **配置打印代理服务**
   - 找到 "打印代理服务地址" 配置项
   - 填写：`http://121.43.143.59:18889`（或对应的端口）
   - 找到 "打印代理服务API密钥" 配置项
   - 填写：`your-secret-token-123456`
   - 点击保存

3. **验证配置**
   - 重新测试打印功能
   - 应该可以正常打印了

### 方案二：暂时禁用 API_KEY 验证（仅用于测试）

如果暂时不需要安全验证，可以禁用 API_KEY：

1. **修改启动脚本**

   编辑 `一键启动服务_18889.bat`，将：
   ```batch
   set PRINT_PROXY_API_KEY=your-secret-token-123456
   ```
   改为：
   ```batch
   set PRINT_PROXY_API_KEY=
   ```

2. **重启打印代理服务**
   - 关闭当前的打印代理服务窗口
   - 重新运行 `一键启动服务_18889.bat`

3. **验证**
   - 打印代理服务启动时应该显示：`API密钥: 未设置（建议设置以提高安全性）`
   - 重新测试打印功能

## 当前配置检查

### 打印代理服务端（本地）

- **API_KEY**：`your-secret-token-123456`（在启动脚本中设置）
- **验证方式**：请求头 `X-API-Key` 或 JSON 中的 `api_key` 字段

### 服务器端（阿里云）

需要在管理后台配置：
- **打印代理服务地址**：`http://121.43.143.59:18889`
- **打印代理服务API密钥**：`your-secret-token-123456`

## 验证步骤

1. **检查打印代理服务日志**
   - 应该看到请求到达，不再返回 401 错误

2. **检查服务器端日志**
   - 应该看到打印请求成功发送

3. **检查打印机**
   - 应该能看到打印任务

## 注意事项

- **安全性**：建议使用方案一，保持 API_KEY 验证以提高安全性
- **多设备**：每台设备的 API_KEY 可以相同，也可以不同（如果不同，需要在服务器端为每个门店分别配置）
- **Token 一致性**：确保服务器端配置的 API_KEY 与打印代理服务启动脚本中的一致
