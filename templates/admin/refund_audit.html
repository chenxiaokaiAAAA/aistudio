<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>退款审核 - AI拍照管理系统</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 80px;
        }
        .navbar-custom {
            background: #0a0a0a !important;
        }
        .stat-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: #fff;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
        }
        .badge-pending { background-color: #ffc107; color: #000; }
        .badge-approved { background-color: #28a745; color: #fff; }
        .badge-rejected { background-color: #dc3545; color: #fff; }
    </style>
</head>
<body>
    {% include 'admin/_navbar.html' %}

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="fas fa-undo"></i> 退款审核</h3>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="text-warning stat-number">{{ pending_count }}</div>
                    <div>待审核</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="text-success stat-number">{{ approved_count }}</div>
                    <div>已批准</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="text-danger stat-number">{{ rejected_count }}</div>
                    <div>已拒绝</div>
                </div>
            </div>
        </div>

        <!-- 筛选器 -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-4">
                        <label for="status" class="form-label">审核状态</label>
                        <select class="form-select" id="status" name="status">
                            <option value="all" {% if status == 'all' %}selected{% endif %}>全部</option>
                            <option value="pending" {% if status == 'pending' %}selected{% endif %}>待审核</option>
                            <option value="approved" {% if status == 'approved' %}selected{% endif %}>已批准</option>
                            <option value="rejected" {% if status == 'rejected' %}selected{% endif %}>已拒绝</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="franchisee_id" class="form-label">加盟商</label>
                        <select class="form-select" id="franchisee_id" name="franchisee_id">
                            <option value="">全部</option>
                            {% for franchisee in franchisees %}
                            <option value="{{ franchisee.id }}" {% if franchisee_id == franchisee.id|string %}selected{% endif %}>{{ franchisee.company_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">筛选</button>
                        <a href="/admin/payment/refunds" class="btn btn-secondary">重置</a>
                    </div>
                </form>
            </div>
        </div>

        <!-- 退款申请列表 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">退款申请列表（共 {{ total_count }} 条）</h5>
            </div>
            <div class="card-body">
                {% if refund_requests %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>订单号</th>
                                <th>客户信息</th>
                                <th>加盟商</th>
                                <th>订单金额</th>
                                <th>退款原因</th>
                                <th>申请时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in refund_requests %}
                            <tr>
                                <td>{{ order.order_number }}</td>
                                <td>
                                    {{ order.customer_name or '-' }}<br>
                                    <small class="text-muted">{{ order.customer_phone }}</small>
                                </td>
                                <td>
                                    {% if order.franchisee_id %}
                                        {% for franchisee in franchisees %}
                                            {% if franchisee.id == order.franchisee_id %}
                                                {{ franchisee.company_name }}
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>¥{{ '%.2f'|format(order.price or 0) }}</td>
                                <td>
                                    <small>{{ order.refund_request_reason[:50] }}{% if order.refund_request_reason|length > 50 %}...{% endif %}</small>
                                </td>
                                <td>
                                    {% if order.refund_request_time %}
                                        {{ order.refund_request_time.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order.refund_request_status == 'pending' %}
                                        <span class="badge badge-pending">待审核</span>
                                    {% elif order.refund_request_status == 'approved' %}
                                        <span class="badge badge-approved">已批准</span>
                                    {% elif order.refund_request_status == 'rejected' %}
                                        <span class="badge badge-rejected">已拒绝</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order.refund_request_status == 'pending' %}
                                        <button class="btn btn-sm btn-success" onclick="approveRefund({{ order.id }})">批准</button>
                                        <button class="btn btn-sm btn-danger" onclick="rejectRefund({{ order.id }})">拒绝</button>
                                    {% else %}
                                        <a href="/admin/order/{{ order.id }}" class="btn btn-sm btn-primary">查看订单</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                {% if total_pages > 1 %}
                <nav aria-label="退款申请分页">
                    <ul class="pagination justify-content-center">
                        {% if current_page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ current_page - 1 }}{% if status != 'all' %}&status={{ status }}{% endif %}{% if franchisee_id %}&franchisee_id={{ franchisee_id }}{% endif %}">上一页</a>
                        </li>
                        {% endif %}
                        {% for page_num in range(1, total_pages + 1) %}
                            {% if page_num == current_page %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% elif page_num <= 3 or page_num > total_pages - 3 or (page_num >= current_page - 1 and page_num <= current_page + 1) %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_num }}{% if status != 'all' %}&status={{ status }}{% endif %}{% if franchisee_id %}&franchisee_id={{ franchisee_id }}{% endif %}">{{ page_num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                        {% if current_page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ current_page + 1 }}{% if status != 'all' %}&status={{ status }}{% endif %}{% if franchisee_id %}&franchisee_id={{ franchisee_id }}{% endif %}">下一页</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>暂无退款申请</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 拒绝退款模态框 -->
    <div class="modal fade" id="rejectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">拒绝退款申请</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="rejectReason" class="form-label">拒绝原因</label>
                        <textarea class="form-control" id="rejectReason" rows="3" placeholder="请输入拒绝原因"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" onclick="confirmReject()">确认拒绝</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentRefundId = null;
        let rejectModal = null;

        function approveRefund(orderId) {
            if (!confirm('确定要批准这个退款申请吗？资金将返还到加盟商账户。')) {
                return;
            }

            fetch(`/api/admin/refund/approve/${orderId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('退款已批准，资金已返还到加盟商账户');
                    location.reload();
                } else {
                    alert('操作失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('操作失败，请重试');
            });
        }

        function rejectRefund(orderId) {
            currentRefundId = orderId;
            if (!rejectModal) {
                rejectModal = new bootstrap.Modal(document.getElementById('rejectModal'));
            }
            document.getElementById('rejectReason').value = '';
            rejectModal.show();
        }

        function confirmReject() {
            const reason = document.getElementById('rejectReason').value.trim();
            if (!reason) {
                alert('请输入拒绝原因');
                return;
            }

            fetch(`/api/admin/refund/reject/${currentRefundId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reason: reason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('退款申请已拒绝');
                    rejectModal.hide();
                    location.reload();
                } else {
                    alert('操作失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('操作失败，请重试');
            });
        }
    </script>
</body>
</html>
