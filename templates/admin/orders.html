<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单管理 - {{ brand_name }}后台</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: #f5f5f5;
            padding-top: 80px;
        }
        .navbar-custom {
            background: #0a0a0a !important;
            border-bottom: 1px solid #1a1a1a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .navbar-brand, .nav-link {
            color: #e0e0e0 !important;
        }
        .nav-link:hover {
            color: #ffffff !important;
        }
        .nav-link.active {
            color: #ffffff !important;
            font-weight: 600;
        }
        .main-content {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .table {
            width: 100%;
            margin-bottom: 0;
        }
        .table th {
            white-space: nowrap;
            font-weight: 500;
        }
        .table td {
            word-break: break-word;
            vertical-align: middle;
        }
        .clickable-stat-card {
            transition: transform 0.2s;
        }
        .clickable-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    {% include 'admin/_navbar.html' %}

    <div class="container main-content">
        <div class="row">
            <div class="col-12">
                <!-- 统计卡片 -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-primary text-white clickable-stat-card" onclick="showOrderStatsModal()" style="cursor: pointer;">
                            <div class="card-body">
                                <h5 class="card-title">总订单数</h5>
                                <h3>{{ total_orders }}</h3>
                                <small>点击查看详情</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-info text-white clickable-stat-card" onclick="showOrderStatsModal()" style="cursor: pointer;">
                            <div class="card-body">
                                <h5 class="card-title">今日订单</h5>
                                <h3>{{ daily_orders }}</h3>
                                <small>点击查看详情</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-warning text-white clickable-stat-card" onclick="showOrderStatsModal()" style="cursor: pointer;">
                            <div class="card-body">
                                <h5 class="card-title">待发货订单</h5>
                                <h3>{{ pending_shipment_orders }}</h3>
                                <small>点击查看详情</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 筛选器 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">订单筛选</h6>
                    </div>
                    <div class="card-body">
                        <form method="GET" class="row g-3">
                            <div class="col-md-3">
                                <label for="search" class="form-label">订单搜索</label>
                                <input type="text" class="form-control" id="search" name="search" 
                                       placeholder="订单号/客户姓名/电话" value="{{ search or '' }}">
                            </div>
                            <div class="col-md-3">
                                <label for="franchisee_id" class="form-label">订单来源（门店）</label>
                                <select class="form-select" id="franchisee_id" name="franchisee_id">
                                    <option value="">全部门店</option>
                                    {% for franchisee in franchisees %}
                                    <option value="{{ franchisee.id }}" {% if franchisee_id == franchisee.id|string %}selected{% endif %}>{{ franchisee.company_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="status" class="form-label">订单状态</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="">全部状态（已支付）</option>
                                    <option value="pending" {% if status == 'pending' %}selected{% endif %}>待制作</option>
                                    <option value="已支付" {% if status == '已支付' %}selected{% endif %}>已支付</option>
                                    <option value="processing" {% if status == 'processing' %}selected{% endif %}>处理中</option>
                                    <option value="completed" {% if status == 'completed' %}selected{% endif %}>已完成</option>
                                    <option value="hd_ready" {% if status == 'hd_ready' %}selected{% endif %}>高清放大</option>
                                    <option value="selection_completed" {% if status == 'selection_completed' %}selected{% endif %}>选片已完成</option>
                                    <option value="manufacturing" {% if status == 'manufacturing' %}selected{% endif %}>厂家制作中</option>
                                    <option value="delivered" {% if status == 'delivered' %}selected{% endif %}>已送达</option>
                                    <option value="shipped" {% if status == 'shipped' %}selected{% endif %}>已发货</option>
                                    <option value="unpaid" {% if status == 'unpaid' %}selected{% endif %}>未支付（查看全部）</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="order_mode" class="form-label">订单类型</label>
                                <select class="form-select" id="order_mode" name="order_mode">
                                    <option value="">全部类型</option>
                                    <option value="shooting" {% if order_mode == 'shooting' %}selected{% endif %}>立即拍摄</option>
                                    <option value="making" {% if order_mode == 'making' %}selected{% endif %}>立即制作</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">筛选</button>
                                <a href="/admin/orders" class="btn btn-secondary">重置</a>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">订单列表</h5>
                        <div class="d-flex align-items-center">
                            <small class="text-muted me-3">共 {{ total_count }} 条记录，第 {{ current_page }}/{{ total_pages }} 页（每页10条）</small>
                            <!-- 批量更新订单状态按钮 -->
                            <button type="button" class="btn btn-warning btn-sm me-2" onclick="batchUpdateOrderStatus()" title="批量更新所有已完成AI任务的订单状态为'待选片'">
                                <i class="fas fa-sync-alt"></i> 批量更新状态
                            </button>
                            <!-- 订单导出按钮 -->
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-download"></i> 导出数据
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/admin/orders/export" target="_blank">
                                        <i class="fas fa-file-csv"></i> 导出为CSV
                                    </a></li>
                                    <li><a class="dropdown-item" href="/admin/orders/export/json" target="_blank">
                                        <i class="fas fa-file-code"></i> 导出为JSON
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-3">
                        <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                            <table class="table table-striped table-sm mb-0" style="font-size: 0.9rem;">
                                <thead>
                                    <tr>
                                        <th style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap;">订单号</th>
                                        <th style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap;">客户姓名</th>
                                        <th style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap;">手机号</th>
                                        <th style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap;">产品名称</th>
                                        <th style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap;">来源（门店）</th>
                                        <th style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap;">状态</th>
                                        <th style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap;">订单类型</th>
                                        <th style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap;">下单时间</th>
                                        <th style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap;">完成时间</th>
                                        <th style="font-size: 0.9rem; padding: 0.6rem; text-align: center; white-space: nowrap;">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in orders %}
                                    <tr>
                                        <td style="font-size: 0.9rem; padding: 0.6rem; word-break: break-all;">{{ order.order_number }}</td>
                                        <td style="font-size: 0.9rem; padding: 0.6rem; word-wrap: break-word;" title="{{ order.customer_name }}">{{ order.customer_name or '-' }}</td>
                                        <td style="font-size: 0.9rem; padding: 0.6rem; word-break: break-all;">{{ order.customer_phone or '-' }}</td>
                                        <td style="font-size: 0.9rem; padding: 0.6rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ order.product_name or order.size or '-' }}">{{ order.product_name or order.size or '-' }}</td>
                                        <td style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap;">
                                            {% if order.franchisee_id and order.franchisee_account %}
                                            <span class="badge bg-warning" style="font-size: 0.8rem;" title="门店：{{ order.franchisee_account.company_name }}">{{ order.franchisee_account.company_name }}</span>
                                            {% elif order.external_platform %}
                                            <span class="badge bg-info" style="font-size: 0.8rem;" title="自拍机：{{ order.external_platform }}">{{ order.external_platform }}</span>
                                            {% else %}
                                            <span class="badge bg-secondary" style="font-size: 0.8rem;">未分配门店</span>
                                            {% endif %}
                                        </td>
                                        <td style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap;">
                                            {% if order.status == 'unpaid' %}
                                            <span class="badge bg-secondary" style="font-size: 0.8rem;">未支付</span>
                                            {% elif order.status == 'paid' %}
                                            <span class="badge bg-info" style="font-size: 0.8rem;">已支付</span>
                                            {% elif order.status == 'shooting' %}
                                            <span class="badge bg-primary" style="font-size: 0.8rem;">正在拍摄</span>
                                            {% elif order.status == 'retouching' %}
                                            <span class="badge bg-primary" style="font-size: 0.8rem;">美颜处理中</span>
                                            {% elif order.status == 'ai_processing' %}
                                            <span class="badge bg-primary" style="font-size: 0.8rem;">AI任务处理中</span>
                                            {% elif order.status == 'pending_selection' %}
                                            <span class="badge bg-warning" style="font-size: 0.8rem;">待选片</span>
                                            {% elif order.status == 'selection_completed' %}
                                            <span class="badge bg-info" style="font-size: 0.8rem;">已选片</span>
                                            {% elif order.status == 'printing' %}
                                            <span class="badge bg-primary" style="font-size: 0.8rem;">打印中</span>
                                            {% elif order.status == 'pending_shipment' %}
                                            <span class="badge bg-warning" style="font-size: 0.8rem;">待发货</span>
                                            {% elif order.status == 'shipped' %}
                                            <span class="badge bg-success" style="font-size: 0.8rem;">已发货</span>
                                            {% elif order.status == 'pending' %}
                                            <span class="badge bg-warning" style="font-size: 0.8rem;">待制作</span>
                                            {% elif order.status == '已支付' %}
                                            <span class="badge bg-warning" style="font-size: 0.8rem;">待制作</span>
                                            {% elif order.status == 'completed' %}
                                            <span class="badge bg-success" style="font-size: 0.8rem;">已完成</span>
                                            {% elif order.status == 'hd_ready' %}
                                            <span class="badge bg-warning" style="font-size: 0.8rem;">高清放大</span>
                                            {% elif order.status == 'processing' %}
                                            <span class="badge bg-primary" style="font-size: 0.8rem;">处理中</span>
                                            {% else %}
                                            <span class="badge bg-secondary" style="font-size: 0.8rem;">{{ order.status or '未知' }}</span>
                                            {% endif %}
                                        </td>
                                        <td style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap;">
                                            {% if order.order_mode == 'shooting' %}
                                            <span class="badge bg-primary" style="font-size: 0.8rem;" title="立即拍摄-自拍机拍摄">立即拍摄</span>
                                            {% elif order.order_mode == 'making' %}
                                            <span class="badge bg-warning" style="font-size: 0.8rem;" title="立即制作-人工线上订单">立即制作</span>
                                            {% else %}
                                            <span class="badge bg-secondary" style="font-size: 0.8rem;">-</span>
                                            {% endif %}
                                        </td>
                                        <td style="font-size: 0.9rem; padding: 0.6rem; white-space: normal; line-height: 1.6;">
                                            <div style="margin-bottom: 4px;">{{ order.created_at.strftime('%Y-%m-%d') }}</div>
                                            <div style="margin-bottom: 4px;">{{ order.created_at.strftime('%H:%M') }}</div>
                                            <div class="text-muted" style="font-size: 0.85rem;">¥{{ '%.2f'|format(order.price or 0) }}</div>
                                        </td>
                                        <td style="font-size: 0.9rem; padding: 0.6rem; white-space: normal; line-height: 1.6;">
                                            {% if order.completed_at %}
                                                <div>{{ order.completed_at.strftime('%Y-%m-%d') }}</div>
                                                <div>{{ order.completed_at.strftime('%H:%M') }}</div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td style="font-size: 0.9rem; padding: 0.6rem; white-space: nowrap; text-align: center;">
                                            <a href="/admin/order/{{ order.id }}" class="btn btn-sm btn-primary" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">查看详情</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- 分页 -->
                    {% if total_pages > 1 %}
                    <div class="card-footer">
                        <nav aria-label="订单分页">
                            <ul class="pagination justify-content-center mb-0">
                                {% if current_page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ current_page - 1 }}{% if search %}&search={{ search }}{% endif %}{% if franchisee_id %}&franchisee_id={{ franchisee_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if order_mode %}&order_mode={{ order_mode }}{% endif %}">上一页</a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">上一页</span>
                                </li>
                                {% endif %}
                                
                                {% for page_num in range(1, total_pages + 1) %}
                                    {% if page_num == current_page %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% elif page_num <= 3 or page_num > total_pages - 3 or (page_num >= current_page - 1 and page_num <= current_page + 1) %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_num }}{% if search %}&search={{ search }}{% endif %}{% if franchisee_id %}&franchisee_id={{ franchisee_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if order_mode %}&order_mode={{ order_mode }}{% endif %}">{{ page_num }}</a>
                                    </li>
                                    {% elif page_num == 4 or page_num == total_pages - 3 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if current_page < total_pages %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ current_page + 1 }}{% if search %}&search={{ search }}{% endif %}{% if franchisee_id %}&franchisee_id={{ franchisee_id }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if order_mode %}&order_mode={{ order_mode }}{% endif %}">下一页</a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">下一页</span>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 订单统计模态框 -->
    <div class="modal fade" id="orderStatsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">订单统计详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row text-center mb-4">
                        <div class="col-md-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h4 class="card-title">总订单数</h4>
                                    <p class="card-text fs-2">{{ total_orders }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h4 class="card-title">今日订单</h4>
                                    <p class="card-text fs-2">{{ daily_orders }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h4 class="card-title">待发货订单</h4>
                                    <p class="card-text fs-2">{{ pending_shipment_orders }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">今日业绩</h6>
                                    <p class="card-text fs-3 text-success">¥{{ '%.2f'|format(daily_revenue) }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    {% include 'admin/_ux_scripts.html' %}
    <script>
        function showOrderStatsModal() {
            var modal = new bootstrap.Modal(document.getElementById('orderStatsModal'));
            modal.show();
        }
        
        function batchUpdateOrderStatus() {
            if (!confirm('确定要批量更新订单状态吗？\n\n将检查所有"AI任务处理中"的订单，如果所有AI任务都已完成，将状态更新为"待选片"。')) {
                return;
            }
            
            // 显示加载提示
            var btn = event.target.closest('button');
            var originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 更新中...';
            
            fetch('/admin/orders/batch-update-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                
                if (data.status === 'success') {
                    alert('批量更新成功！\n\n更新了 ' + data.data.updated_count + ' 个订单状态为"待选片"\n跳过了 ' + data.data.skipped_count + ' 个订单');
                    // 刷新页面
                    location.reload();
                } else if (data.status === 'info') {
                    alert('没有订单需要更新\n\n跳过了 ' + data.data.skipped_count + ' 个订单（无任务或任务未全部完成）');
                } else {
                    alert('批量更新失败：' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                console.error('批量更新失败:', error);
                alert('批量更新失败：' + error.message);
            });
        }
    </script>
</body>
</html>
