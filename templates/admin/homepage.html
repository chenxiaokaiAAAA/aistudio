<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–é¡µé…ç½®ç®¡ç† - {{ brand_name }}åå°</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .navbar-custom {
            background: #0a0a0a !important;
            border-bottom: 1px solid #1a1a1a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .navbar-brand, .nav-link {
            color: #e0e0e0 !important;
        }
        .nav-link:hover {
            color: #ffffff !important;
        }
        .nav-link.active {
            color: #ffffff !important;
            font-weight: 600;
        }
        
        .main-content {
            margin-top: 100px;
            padding: 20px;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
        }
        
        .card-header {
            background: rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px 15px 0 0 !important;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #ff5252, #26a69a);
        }
        
        .form-control {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
        }
        
        .form-control:focus {
            background: rgba(255,255,255,0.15);
            border-color: #4ecdc4;
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(78, 205, 196, 0.25);
        }
        
        .form-control::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        /* ä¸‹æ‹‰æ¡†æ ·å¼ */
        select.form-control {
            background: rgba(30, 30, 50, 0.95) !important;
            color: white !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 0.75rem center !important;
            background-size: 16px 12px !important;
            padding-right: 2.5rem !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
        }
        
        select.form-control option {
            background: #1a1a2e !important;
            color: white !important;
            padding: 10px !important;
        }
        
        select.form-control option:hover {
            background: #4ecdc4 !important;
            color: #1a1a2e !important;
        }
        
        select.form-control option:checked,
        select.form-control option:focus {
            background: #4ecdc4 !important;
            color: #1a1a2e !important;
        }
        
        /* ä¸‹æ‹‰æ¡†æ‰“å¼€æ—¶çš„æ ·å¼ */
        select.form-control:focus {
            background-color: rgba(30, 30, 50, 0.95) !important;
            color: white !important;
        }
        
        /* ç¡®ä¿ä¸‹æ‹‰åˆ—è¡¨èƒŒæ™¯å¯è§ */
        select.form-control::-ms-expand {
            display: none;
        }
        
        /* é’ˆå¯¹ä¸åŒæµè§ˆå™¨çš„ä¸‹æ‹‰é€‰é¡¹æ ·å¼ */
        @supports (-webkit-appearance: none) {
            select.form-control {
                background-color: rgba(30, 30, 50, 0.95) !important;
            }
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .modal-header {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .modal-footer {
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .close {
            color: white;
            opacity: 0.8;
        }
        
        .close:hover {
            color: #ff6b6b;
            opacity: 1;
        }
        
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }
        
        .upload-area.dragover {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }
        
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .banner-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .banner-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .sortable-handle {
            cursor: move;
            color: #4ecdc4;
        }
        
        .sortable-handle:hover {
            color: #ff6b6b;
        }
        
        /* äº§å“é€‰æ‹©å™¨æ ·å¼ */
        .product-selector-list {
            max-height: 500px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px;
        }
        
        .product-selector-item {
            position: relative;
        }
        
        .product-selector-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .product-selector-card:hover {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
            transform: translateY(-2px);
        }
        
        .product-selector-item.selected .product-selector-card {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }
        
        .product-selector-checkbox {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 10;
        }
        
        .product-selector-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .product-selector-image {
            width: 100%;
            height: 120px;
            overflow: hidden;
            border-radius: 8px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
        }
        
        .product-selector-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-selector-info {
            text-align: center;
        }
        
        .product-selector-name {
            font-size: 14px;
            color: white;
            font-weight: 500;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .product-selector-category {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
        }
        
        #selectedProductsPreview {
            padding: 8px;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 5px;
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        
        /* ä¸‰æ å¸ƒå±€æ ·å¼ï¼ˆå‚è€ƒé£æ ¼åˆ†ç±»ï¼‰ */
        .main-category-item {
            padding: 12px 15px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .main-category-item:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(78, 205, 196, 0.3);
        }
        .main-category-item.active {
            background: rgba(78, 205, 196, 0.15);
            border-color: rgba(78, 205, 196, 0.5);
        }
        .sub-category-item {
            padding: 10px 12px;
            margin-bottom: 6px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .sub-category-item:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(78, 205, 196, 0.3);
        }
        .sub-category-item.active {
            background: rgba(78, 205, 196, 0.12);
            border-color: rgba(78, 205, 196, 0.4);
        }
        .detail-panel-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
        }
        .detail-panel-placeholder {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    {% include 'admin/_navbar.html' %}

    <div class="main-content">
        <div class="container-fluid">
            <!-- é¡¶éƒ¨å·¥å…·æ  -->
            <div class="card mb-3">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">ğŸ  é¦–é¡µé…ç½®ç®¡ç†</h4>
                            <small class="text-muted">ç®¡ç†é¦–é¡µè½®æ’­å›¾ã€åˆ†ç±»å¯¼èˆªå’Œæ¨¡å—é…ç½®ï¼Œå°ç¨‹åºå’Œç½‘é¡µç‰ˆå°†åŒæ­¥æ›´æ–°</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒºåŸŸï¼šä¸‰æ å¸ƒå±€ï¼ˆå¤§åˆ†ç±» / äºŒçº§åˆ†ç±» / é…ç½®å±•ç¤ºï¼‰ -->
            <div class="row g-3" style="min-height: calc(100vh - 300px);">
                <!-- å·¦ä¾§ï¼šå¤§åˆ†ç±» -->
                <div class="col-lg-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="mb-0">åŠŸèƒ½åˆ†ç±»</h6>
                        </div>
                        <div class="card-body" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                            <div class="main-category-item active" data-category="banners" onclick="selectMainCategory('banners')">
                                <i class="fas fa-images me-2"></i>è½®æ’­å›¾ç®¡ç†
                            </div>
                            <div class="main-category-item" data-category="category-navs" onclick="selectMainCategory('category-navs')">
                                <i class="fas fa-th-large me-2"></i>åˆ†ç±»å¯¼èˆªç®¡ç†
                            </div>
                            <div class="main-category-item" data-category="modules" onclick="selectMainCategory('modules')">
                                <i class="fas fa-puzzle-piece me-2"></i>é¦–é¡µæ¨¡å—é…ç½®
                            </div>
                            <div class="main-category-item" data-category="homepage-config" onclick="selectMainCategory('homepage-config')">
                                <i class="fas fa-cog me-2"></i>é¦–é¡µé…ç½®
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¸­é—´ï¼šäºŒçº§åˆ†ç±» -->
                <div class="col-lg-3">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" id="subCategoryTitle">è½®æ’­å›¾åˆ—è¡¨</h6>
                            <div id="subCategoryActions">
                                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#bannerModal" id="addBannerBtn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                            <div id="subCategoryList">
                                <!-- äºŒçº§åˆ†ç±»/åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šé…ç½®å±•ç¤ºå¡ç‰‡ -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="mb-0" id="detailPanelTitle">é…ç½®è¯¦æƒ…</h6>
                        </div>
                        <div class="card-body" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                            <div id="detailPanel">
                                <div class="detail-panel-placeholder" id="detailPanelPlaceholder">
                                    <i class="fas fa-hand-pointer fa-3x mb-3"></i>
                                    <p>è¯·ä»å·¦ä¾§é€‰æ‹©åŠŸèƒ½åˆ†ç±»ï¼Œä¸­é—´é€‰æ‹©å…·ä½“é¡¹æŸ¥çœ‹æˆ–ç¼–è¾‘</p>
                                </div>
                                <div id="detailPanelContent" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è½®æ’­å›¾ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="bannerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bannerModalTitle">æ·»åŠ è½®æ’­å›¾</h5>
                    <button type="button" class="close" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="bannerForm">
                        <input type="hidden" id="bannerId" name="id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="bannerTitle" class="form-label">æ ‡é¢˜</label>
                                    <input type="text" class="form-control" id="bannerTitle" name="title" placeholder="å¦‚ï¼šæ–°å“ä¸Šå¸‚">
                                </div>
                                <div class="mb-3">
                                    <label for="bannerSubtitle" class="form-label">å‰¯æ ‡é¢˜</label>
                                    <input type="text" class="form-control" id="bannerSubtitle" name="subtitle" placeholder="å¦‚ï¼šé™æ—¶ä¼˜æƒ ">
                                </div>
                                <div class="mb-3">
                                    <label for="bannerLink" class="form-label">é“¾æ¥åœ°å€</label>
                                    <input type="text" class="form-control" id="bannerLink" name="link" placeholder="å¦‚ï¼š/pages/product/product">
                                </div>
                                <div class="mb-3">
                                    <label for="bannerSortOrder" class="form-label">æ’åº</label>
                                    <input type="number" class="form-control" id="bannerSortOrder" name="sort_order" value="0">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bannerIsActive" name="is_active" checked>
                                        <label class="form-check-label" for="bannerIsActive">
                                            å¯ç”¨
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="bannerUpload" class="form-label">è½®æ’­å›¾ç‰‡</label>
                                    <div class="upload-area" onclick="document.getElementById('bannerFile').click()">
                                        <div id="bannerUploadArea">
                                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                            <p>ç‚¹å‡»ä¸Šä¼ è½®æ’­å›¾ç‰‡</p>
                                            <small class="text-muted">å»ºè®®å°ºå¯¸ï¼š750x400px</small>
                                        </div>
                                        <img id="bannerPreview" class="preview-image" style="display: none;">
                                    </div>
                                    <input type="file" id="bannerFile" accept="image/*" style="display: none;" onchange="uploadBannerImage(this)">
                                    <input type="hidden" id="bannerImageUrl" name="image_url">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveBanner()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    {% include 'admin/_ux_scripts.html' %}
    <script>
        // å…¨å±€å˜é‡ï¼ˆå¿…é¡»åœ¨æœ€å‰å£°æ˜ï¼Œä¾›åç»­å‡½æ•°ä½¿ç”¨ï¼‰
        let banners = [];
        let homepageConfig = {};
        let currentMainCategory = 'banners';
        let currentSubSelection = null;
        let moduleItemsDirty = false;
        let categoryNavs = [];
        let productSections = [];

        // ä¸‰æ å¸ƒå±€ï¼šé€‰æ‹©å·¦ä¾§å¤§åˆ†ç±»
        function selectMainCategory(category) {
            currentMainCategory = category;
            currentSubSelection = null;
            document.querySelectorAll('.main-category-item').forEach(el => {
                el.classList.toggle('active', el.dataset.category === category);
            });
            updateSubCategoryList();
            updateDetailPanel();
        }

        // ä¸‰æ å¸ƒå±€ï¼šé€‰æ‹©ä¸­é—´äºŒçº§é¡¹
        function selectSubCategoryItem(type, id) {
            currentSubSelection = { type, id };
            if (type === 'module') moduleItemsDirty = false;
            document.querySelectorAll('#subCategoryList .sub-category-item').forEach(el => {
                el.classList.toggle('active', el.dataset.id == id && el.dataset.type === type);
            });
            updateDetailPanel();
        }

        // æ›´æ–°ä¸­é—´æ äºŒçº§åˆ†ç±»/åˆ—è¡¨
        function updateSubCategoryList() {
            const container = document.getElementById('subCategoryList');
            const titleEl = document.getElementById('subCategoryTitle');
            const actionsEl = document.getElementById('subCategoryActions');
            if (!container || !titleEl || !actionsEl) return;
            container.innerHTML = '';

            if (currentMainCategory === 'banners') {
                titleEl.textContent = 'è½®æ’­å›¾åˆ—è¡¨';
                actionsEl.innerHTML = '<button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#bannerModal"><i class="fas fa-plus"></i> æ·»åŠ </button>';
                banners.forEach(b => {
                    const div = document.createElement('div');
                    div.className = 'sub-category-item';
                    div.dataset.type = 'banner';
                    div.dataset.id = b.id;
                    div.onclick = () => selectSubCategoryItem('banner', b.id);
                    div.innerHTML = `
                        <div class="d-flex align-items-center">
                            <img src="${b.image_url}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;margin-right:10px;" onerror="this.style.display='none'">
                            <div>
                                <div class="fw-bold small">${b.title || 'æœªå‘½å'}</div>
                                <small class="text-muted">${b.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</small>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
                if (banners.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-4"><small>æš‚æ— è½®æ’­å›¾ï¼Œç‚¹å‡»ä¸Šæ–¹æ·»åŠ </small></div>';
                }
            } else if (currentMainCategory === 'category-navs') {
                titleEl.textContent = 'åˆ†ç±»å¯¼èˆªåˆ—è¡¨';
                actionsEl.innerHTML = '<button class="btn btn-sm btn-primary" onclick="addCategoryNav()"><i class="fas fa-plus"></i> æ·»åŠ </button>';
                categoryNavs.forEach(nav => {
                    const imgUrl = nav.image_url_preview || nav.image_url || '';
                    const div = document.createElement('div');
                    div.className = 'sub-category-item';
                    div.dataset.type = 'nav';
                    div.dataset.id = nav.id;
                    div.onclick = () => selectSubCategoryItem('nav', nav.id);
                    div.innerHTML = `
                        <div class="d-flex align-items-center">
                            ${imgUrl ? `<img src="${imgUrl}" style="width:36px;height:36px;object-fit:cover;border-radius:50%;margin-right:10px;" onerror="this.outerHTML='<span class=\\'me-2\\' style=\\'font-size:24px\\'>${(nav.icon || 'ğŸ“¦').replace(/'/g, "\\'")}</span>'">` : `<span class="me-2" style="font-size:24px;">${nav.icon || 'ğŸ“¦'}</span>`}
                            <div>
                                <div class="fw-bold small">${nav.name}</div>
                                <small class="text-muted">${nav.link_type === 'category' ? 'åˆ†ç±»' : nav.link_type === 'page' ? 'é¡µé¢' : 'é“¾æ¥'}</small>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
                if (categoryNavs.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted py-4"><small>æš‚æ— åˆ†ç±»å¯¼èˆªï¼Œç‚¹å‡»ä¸Šæ–¹æ·»åŠ </small></div>';
                }
            } else if (currentMainCategory === 'modules') {
                titleEl.textContent = 'é¦–é¡µæ¨¡å—';
                actionsEl.innerHTML = '';
                const modules = [
                    { id: 'featured_section', title: 'å½“å­£ä¸»æ¨', icon: 'fa-star' },
                    { id: 'time_journey', title: 'æ—¶å…‰æ—…ç¨‹', icon: 'fa-clock' },
                    { id: 'ip_collab', title: 'IPè”å', icon: 'fa-handshake' },
                    { id: 'works', title: 'ä½œå“å±•ç¤º', icon: 'fa-images' }
                ];
                modules.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'sub-category-item';
                    div.dataset.type = 'module';
                    div.dataset.id = m.id;
                    div.onclick = () => selectSubCategoryItem('module', m.id);
                    div.innerHTML = `<i class="fas ${m.icon} me-2"></i>${m.title}`;
                    container.appendChild(div);
                });
                selectSubCategoryItem('module', 'featured_section');
            } else if (currentMainCategory === 'homepage-config') {
                titleEl.textContent = 'é…ç½®é¡¹';
                actionsEl.innerHTML = '';
                const items = [
                    { id: 'info', title: 'é¦–é¡µä¿¡æ¯', icon: 'fa-info-circle' },
                    { id: 'features', title: 'åŠŸèƒ½å¼€å…³', icon: 'fa-toggle-on' }
                ];
                items.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'sub-category-item';
                    div.dataset.type = 'config';
                    div.dataset.id = m.id;
                    div.onclick = () => selectSubCategoryItem('config', m.id);
                    div.innerHTML = `<i class="fas ${m.icon} me-2"></i>${m.title}`;
                    container.appendChild(div);
                });
                selectSubCategoryItem('config', 'info');
            }
        }

        // æ›´æ–°å³ä¾§è¯¦æƒ…é¢æ¿
        function updateDetailPanel() {
            const panel = document.getElementById('detailPanel');
            const placeholder = document.getElementById('detailPanelPlaceholder');
            const content = document.getElementById('detailPanelContent');
            const titleEl = document.getElementById('detailPanelTitle');
            if (!panel || !placeholder || !content || !titleEl) return;

            if (currentMainCategory === 'banners') {
                titleEl.textContent = 'è½®æ’­å›¾è¯¦æƒ…';
                if (currentSubSelection && currentSubSelection.type === 'banner') {
                    const banner = banners.find(b => b.id == currentSubSelection.id);
                    if (banner) {
                        placeholder.style.display = 'none';
                        content.style.display = 'block';
                        content.innerHTML = `
                            <div class="detail-panel-card">
                                <div class="mb-3">
                                    <img src="${banner.image_url}" class="img-fluid rounded" style="max-height:200px;object-fit:cover;width:100%;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjEyMCIgZmlsbD0iI2NjYyIvPjx0ZXh0IHg9IjE1MCIgeT0iNjAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvuWJjzwvdGV4dD48L3N2Zz4='">
                                </div>
                                <p><strong>æ ‡é¢˜ï¼š</strong>${banner.title || 'æ— '}</p>
                                <p><strong>å‰¯æ ‡é¢˜ï¼š</strong>${banner.subtitle || 'æ— '}</p>
                                <p><strong>é“¾æ¥ï¼š</strong>${banner.link || 'æ— '}</p>
                                <p><strong>çŠ¶æ€ï¼š</strong>${banner.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</p>
                                <div class="mt-3">
                                    <button class="btn btn-primary me-2" onclick="editBanner(${banner.id})"><i class="fas fa-edit"></i> ç¼–è¾‘</button>
                                    <button class="btn btn-outline-danger" onclick="deleteBanner(${banner.id})"><i class="fas fa-trash"></i> åˆ é™¤</button>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    placeholder.style.display = 'block';
                    content.style.display = 'none';
                    content.innerHTML = '';
                    placeholder.innerHTML = banners.length === 0
                        ? '<i class="fas fa-images fa-3x mb-3"></i><p>æš‚æ— è½®æ’­å›¾</p><p class="small">è¯·ç‚¹å‡»ä¸­é—´æ ä¸Šæ–¹çš„ã€Œæ·»åŠ ã€æŒ‰é’®</p>'
                        : '<i class="fas fa-images fa-3x mb-3"></i><p>è¯·ä»ä¸­é—´åˆ—è¡¨é€‰æ‹©è½®æ’­å›¾æŸ¥çœ‹è¯¦æƒ…</p>';
                }
            } else if (currentMainCategory === 'category-navs') {
                titleEl.textContent = 'åˆ†ç±»å¯¼èˆªè¯¦æƒ…';
                if (currentSubSelection && currentSubSelection.type === 'nav') {
                    const nav = categoryNavs.find(n => n.id == currentSubSelection.id);
                    if (nav) {
                        const navImgUrl = nav.image_url_preview || nav.image_url || '';
                        placeholder.style.display = 'none';
                        content.style.display = 'block';
                        content.innerHTML = `
                            <div class="detail-panel-card">
                                <div class="mb-3">
                                    ${navImgUrl ? `<img src="${navImgUrl}" class="rounded" style="width:80px;height:80px;object-fit:cover;">` : `<span style="font-size:48px;">${nav.icon || 'ğŸ“¦'}</span>`}
                                </div>
                                <p><strong>åç§°ï¼š</strong>${nav.name}</p>
                                <p><strong>é“¾æ¥ç±»å‹ï¼š</strong>${nav.link_type === 'category' ? 'äº§å“åˆ†ç±»' : nav.link_type === 'page' ? 'é¡µé¢' : 'å¤–éƒ¨é“¾æ¥'}</p>
                                <p><strong>çŠ¶æ€ï¼š</strong>${nav.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</p>
                                <div class="mt-3">
                                    <button class="btn btn-primary me-2" onclick="editCategoryNav(${nav.id})"><i class="fas fa-edit"></i> ç¼–è¾‘</button>
                                    <button class="btn btn-outline-danger" onclick="deleteCategoryNav(${nav.id})"><i class="fas fa-trash"></i> åˆ é™¤</button>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    placeholder.style.display = 'block';
                    content.style.display = 'none';
                    content.innerHTML = '';
                    placeholder.innerHTML = categoryNavs.length === 0
                        ? '<i class="fas fa-th-large fa-3x mb-3"></i><p>æš‚æ— åˆ†ç±»å¯¼èˆª</p><p class="small">è¯·ç‚¹å‡»ä¸­é—´æ ä¸Šæ–¹çš„ã€Œæ·»åŠ ã€æŒ‰é’®</p>'
                        : '<i class="fas fa-th-large fa-3x mb-3"></i><p>è¯·ä»ä¸­é—´åˆ—è¡¨é€‰æ‹©åˆ†ç±»å¯¼èˆªæŸ¥çœ‹è¯¦æƒ…</p>';
                }
            } else if (currentMainCategory === 'modules') {
                const moduleType = currentSubSelection && currentSubSelection.type === 'module' ? currentSubSelection.id : 'featured_section';
                const moduleTitle = getModuleTitle(moduleType);
                titleEl.textContent = moduleTitle + ' - æ¨¡å—é¡¹';
                placeholder.style.display = 'none';
                content.style.display = 'block';
                content.innerHTML = renderModuleItemsPanel(moduleType);
            } else if (currentMainCategory === 'homepage-config') {
                titleEl.textContent = 'é¦–é¡µé…ç½®';
                placeholder.style.display = 'none';
                content.style.display = 'block';
                content.innerHTML = `
                    <div class="detail-panel-card mb-3">
                        <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>é¦–é¡µä¿¡æ¯</h6>
                        <div class="mb-3">
                            <label for="homepageTitle" class="form-label">é¦–é¡µæ ‡é¢˜</label>
                            <input type="text" class="form-control" id="homepageTitle" placeholder="å¦‚ï¼š{{ brand_name }} - ä¸“å±å®šåˆ¶">
                        </div>
                        <div class="mb-3">
                            <label for="homepageSubtitle" class="form-label">é¦–é¡µå‰¯æ ‡é¢˜</label>
                            <input type="text" class="form-control" id="homepageSubtitle" placeholder="å¦‚ï¼šä¸ºæ‚¨çš„å® ç‰©æ‰“é€ ä¸“å±è‰ºæœ¯å“">
                        </div>
                        <div class="mb-3">
                            <label for="homepageDescription" class="form-label">é¦–é¡µæè¿°</label>
                            <textarea class="form-control" id="homepageDescription" rows="3" placeholder="é¦–é¡µæè¿°æ–‡å­—"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveHomepageConfig()">ä¿å­˜é…ç½®</button>
                    </div>
                    <div class="detail-panel-card">
                        <h6 class="mb-3"><i class="fas fa-toggle-on me-2"></i>åŠŸèƒ½å¼€å…³</h6>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableCustomOrder">
                                <label class="form-check-label" for="enableCustomOrder">å¯ç”¨å®šåˆ¶åŠŸèƒ½</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableStyleLibrary">
                                <label class="form-check-label" for="enableStyleLibrary">å¯ç”¨é£æ ¼åº“</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableProductGallery">
                                <label class="form-check-label" for="enableProductGallery">å¯ç”¨äº§å“é¦†</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableWorksGallery">
                                <label class="form-check-label" for="enableWorksGallery">å¯ç”¨ä½œå“å±•ç¤º</label>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveFeatureConfig()">ä¿å­˜é…ç½®</button>
                    </div>
                `;
                updateHomepageConfigForm();
            }
        }

        // é€šç”¨ fetch å°è£…ï¼šå¸¦ credentialsï¼Œç»Ÿä¸€é”™è¯¯å¤„ç†
        async function fetchHomepageApi(url, options = {}) {
            const res = await fetch(url, { credentials: 'same-origin', ...options });
            const text = await res.text();
            if (!res.ok) {
                console.error(`API è¯·æ±‚å¤±è´¥: ${url}`, res.status, text?.slice(0, 200));
                throw new Error(`è¯·æ±‚å¤±è´¥: ${res.status}`);
            }
            try {
                return JSON.parse(text);
            } catch (e) {
                console.error(`API è¿”å›é JSON: ${url}`, text?.slice(0, 200));
                throw new Error('æœåŠ¡å™¨è¿”å›æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®è®¤æœåŠ¡å·²ç”¨ python test_server.py æˆ– start.py å¯åŠ¨');
            }
        }

        // åŠ è½½è½®æ’­å›¾æ•°æ®
        async function loadBanners() {
            try {
                const data = await fetchHomepageApi('/api/admin/homepage/banners');
                if (data.status === 'success') {
                    banners = data.data;
                    if (currentMainCategory === 'banners') updateSubCategoryList();
                }
            } catch (error) {
                console.error('åŠ è½½è½®æ’­å›¾å¤±è´¥:', error);
                throw error;
            }
        }

        // åŠ è½½é¦–é¡µé…ç½®
        async function loadHomepageConfig() {
            try {
                const data = await fetchHomepageApi('/api/admin/homepage/config');
                if (data.status === 'success') {
                    homepageConfig = data.data;
                    updateHomepageConfigForm();
                }
            } catch (error) {
                console.error('åŠ è½½é¦–é¡µé…ç½®å¤±è´¥:', error);
                throw error;
            }
        }

        // è½®æ’­å›¾åˆ—è¡¨å·²ç§»è‡³ä¸‰æ ä¸­é—´åˆ—ï¼Œç”± updateSubCategoryList æ¸²æŸ“

        // æ›´æ–°é¦–é¡µé…ç½®è¡¨å•ï¼ˆä»…å½“è¡¨å•å…ƒç´ å­˜åœ¨æ—¶ï¼Œå¦‚å·²åˆ‡æ¢åˆ°é¦–é¡µé…ç½®è§†å›¾ï¼‰
        function updateHomepageConfigForm() {
            const titleEl = document.getElementById('homepageTitle');
            if (!titleEl) return;
            titleEl.value = homepageConfig.title || '';
            const subtitleEl = document.getElementById('homepageSubtitle');
            if (subtitleEl) subtitleEl.value = homepageConfig.subtitle || '';
            const descEl = document.getElementById('homepageDescription');
            if (descEl) descEl.value = homepageConfig.description || '';
            const customOrderEl = document.getElementById('enableCustomOrder');
            if (customOrderEl) customOrderEl.checked = homepageConfig.enable_custom_order || false;
            const styleLibEl = document.getElementById('enableStyleLibrary');
            if (styleLibEl) styleLibEl.checked = homepageConfig.enable_style_library || false;
            const productGalEl = document.getElementById('enableProductGallery');
            if (productGalEl) productGalEl.checked = homepageConfig.enable_product_gallery || false;
            const worksGalEl = document.getElementById('enableWorksGallery');
            if (worksGalEl) worksGalEl.checked = homepageConfig.enable_works_gallery || false;
        }

        // ä¸Šä¼ è½®æ’­å›¾ç‰‡
        async function uploadBannerImage(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/admin/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                // æ£€æŸ¥HTTPçŠ¶æ€ç 
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('ä¸Šä¼ ç»“æœ:', result);
                
                // å…¼å®¹ä¸¤ç§è¿”å›æ ¼å¼ï¼šstatus === 'success' æˆ– success === true
                // ä¼˜å…ˆä½¿ç”¨ image_urlï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ url
                const imageUrl = result.image_url || result.url;
                
                if ((result.status === 'success' || result.success === true) && imageUrl) {
                    // ä¸Šä¼ æˆåŠŸ
                    document.getElementById('bannerImageUrl').value = imageUrl;
                    document.getElementById('bannerPreview').src = imageUrl;
                    document.getElementById('bannerPreview').style.display = 'block';
                    document.getElementById('bannerUploadArea').style.display = 'none';
                    console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', imageUrl);
                    // ä¸æ˜¾ç¤ºalertï¼Œé¿å…å¹²æ‰°ç”¨æˆ·æ“ä½œï¼Œå›¾ç‰‡é¢„è§ˆå·²è¶³å¤Ÿè¯´æ˜æˆåŠŸ
                } else {
                    // ä¸Šä¼ å¤±è´¥
                    const errorMsg = result.message || 'æœªçŸ¥é”™è¯¯';
                    console.error('ä¸Šä¼ å¤±è´¥:', errorMsg, result);
                    alert('ä¸Šä¼ å¤±è´¥: ' + errorMsg);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥: ' + (error.message || 'è¯·é‡è¯•'));
            }
        }

        // ç¼–è¾‘è½®æ’­å›¾
        function editBanner(id) {
            const banner = banners.find(b => b.id === id);
            if (banner) {
                document.getElementById('bannerModalTitle').textContent = 'ç¼–è¾‘è½®æ’­å›¾';
                document.getElementById('bannerId').value = banner.id;
                document.getElementById('bannerTitle').value = banner.title || '';
                document.getElementById('bannerSubtitle').value = banner.subtitle || '';
                document.getElementById('bannerLink').value = banner.link || '';
                document.getElementById('bannerImageUrl').value = banner.image_url || '';
                document.getElementById('bannerSortOrder').value = banner.sort_order || 0;
                document.getElementById('bannerIsActive').checked = banner.is_active;
                
                // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                if (banner.image_url) {
                    document.getElementById('bannerPreview').src = banner.image_url;
                    document.getElementById('bannerPreview').style.display = 'block';
                    document.getElementById('bannerUploadArea').style.display = 'none';
                } else {
                    document.getElementById('bannerPreview').style.display = 'none';
                    document.getElementById('bannerUploadArea').style.display = 'block';
                }
                
                const modal = new bootstrap.Modal(document.getElementById('bannerModal'));
                modal.show();
            }
        }

        // ä¿å­˜è½®æ’­å›¾
        async function saveBanner() {
            const form = document.getElementById('bannerForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // å¤„ç†å¤é€‰æ¡†
            data.is_active = document.getElementById('bannerIsActive').checked;
            
            try {
                const url = data.id ? `/api/admin/homepage/banners/${data.id}` : '/api/admin/homepage/banners';
                const method = data.id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('bannerModal')).hide();
                    await loadBanners();
                    updateDetailPanel();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜è½®æ’­å›¾å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆ é™¤è½®æ’­å›¾
        async function deleteBanner(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè½®æ’­å›¾å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`/api/admin/homepage/banners/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        await loadBanners();
                        updateDetailPanel();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + result.message);
                    }
                } catch (error) {
                    console.error('åˆ é™¤è½®æ’­å›¾å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }

        // ä¿å­˜é¦–é¡µé…ç½®
        async function saveHomepageConfig() {
            const titleEl = document.getElementById('homepageTitle');
            if (!titleEl) { alert('è¯·å…ˆåˆ‡æ¢åˆ°é¦–é¡µé…ç½®è§†å›¾'); return; }
            const subtitleEl = document.getElementById('homepageSubtitle');
            const descEl = document.getElementById('homepageDescription');
            const data = {
                title: titleEl.value,
                subtitle: subtitleEl ? subtitleEl.value : '',
                description: descEl ? descEl.value : ''
            };
            
            try {
                const response = await fetch('/api/admin/homepage/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    alert('ä¿å­˜æˆåŠŸ');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜é¦–é¡µé…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ä¿å­˜åŠŸèƒ½é…ç½®
        async function saveFeatureConfig() {
            const customOrderEl = document.getElementById('enableCustomOrder');
            if (!customOrderEl) { alert('è¯·å…ˆåˆ‡æ¢åˆ°é¦–é¡µé…ç½®è§†å›¾'); return; }
            const styleLibEl = document.getElementById('enableStyleLibrary');
            const productGalEl = document.getElementById('enableProductGallery');
            const worksGalEl = document.getElementById('enableWorksGallery');
            const data = {
                enable_custom_order: customOrderEl.checked,
                enable_style_library: styleLibEl ? styleLibEl.checked : false,
                enable_product_gallery: productGalEl ? productGalEl.checked : false,
                enable_works_gallery: worksGalEl ? worksGalEl.checked : false
            };
            
            try {
                const response = await fetch('/api/admin/homepage/features', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    alert('ä¿å­˜æˆåŠŸ');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜åŠŸèƒ½é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é‡ç½®è¡¨å•ï¼ˆéœ€åœ¨ DOM åŠ è½½åç»‘å®šï¼Œå›  moduleItemModal åœ¨è„šæœ¬ä¸‹æ–¹ï¼‰
        function bindModalEvents() {
            const bannerModal = document.getElementById('bannerModal');
            if (bannerModal) {
                bannerModal.addEventListener('hidden.bs.modal', function() {
                    const form = document.getElementById('bannerForm');
                    if (form) form.reset();
                    const title = document.getElementById('bannerModalTitle');
                    if (title) title.textContent = 'æ·»åŠ è½®æ’­å›¾';
                    const preview = document.getElementById('bannerPreview');
                    if (preview) preview.style.display = 'none';
                    const area = document.getElementById('bannerUploadArea');
                    if (area) area.style.display = 'block';
                });
            }
            const moduleItemModal = document.getElementById('moduleItemModal');
            if (moduleItemModal) {
                moduleItemModal.addEventListener('hidden.bs.modal', function() {
                    if (document.activeElement && document.activeElement.blur) document.activeElement.blur();
                });
            }
        }
        // ========== åˆ†ç±»å¯¼èˆªç®¡ç† ==========
        let products = [];
        let categories = [];

        // åŠ è½½åˆ†ç±»å¯¼èˆª
        async function loadCategoryNavs() {
            try {
                const data = await fetchHomepageApi('/api/admin/homepage/category-navs');
                if (data.status === 'success') {
                    categoryNavs = data.data || [];
                    if (currentMainCategory === 'category-navs') updateSubCategoryList();
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¯¼èˆªå¤±è´¥:', error);
                categoryNavs = [];
            }
        }

        // æ·»åŠ åˆ†ç±»å¯¼èˆª
        function addCategoryNav() {
            // é‡ç½®è¡¨å•
            document.getElementById('categoryNavId').value = '';
            document.getElementById('categoryNavName').value = '';
            document.getElementById('categoryNavIcon').value = '';
            document.getElementById('categoryNavImageUrl').value = '';
            document.getElementById('categoryNavLinkType').value = 'category';
            document.getElementById('categoryNavLinkValue').value = '';
            document.getElementById('categoryNavCategoryId').value = '';
            document.getElementById('categoryNavSortOrder').value = 0;
            document.getElementById('categoryNavIsActive').checked = true;
            
            // é‡ç½®å›¾ç‰‡é¢„è§ˆ
            document.getElementById('categoryNavPreview').style.display = 'none';
            document.getElementById('categoryNavUploadArea').style.display = 'block';
            
            // æ›´æ–°é“¾æ¥å€¼è¾“å…¥æ–¹å¼
            updateLinkValueInput();
            
            document.getElementById('categoryNavModalTitle').textContent = 'æ·»åŠ åˆ†ç±»å¯¼èˆª';
            new bootstrap.Modal(document.getElementById('categoryNavModal')).show();
        }
        
        // ç¼–è¾‘åˆ†ç±»å¯¼èˆª
        function editCategoryNav(id) {
            const nav = categoryNavs.find(n => n.id === id);
            if (!nav) return;
            
            document.getElementById('categoryNavId').value = nav.id;
            document.getElementById('categoryNavName').value = nav.name || '';
            document.getElementById('categoryNavIcon').value = nav.icon || '';
            // ä½¿ç”¨åŸå§‹è·¯å¾„ï¼Œè€Œä¸æ˜¯å®Œæ•´URL
            const imageUrl = nav.image_url || '';
            document.getElementById('categoryNavImageUrl').value = imageUrl;
            document.getElementById('categoryNavLinkType').value = nav.link_type || 'category';
            document.getElementById('categoryNavLinkValue').value = nav.link_value || '';
            document.getElementById('categoryNavCategoryId').value = nav.category_id || '';
            document.getElementById('categoryNavSortOrder').value = nav.sort_order || 0;
            document.getElementById('categoryNavIsActive').checked = nav.is_active;
            
            // æ˜¾ç¤ºé¢„è§ˆï¼ˆä½¿ç”¨å®Œæ•´URLï¼‰
            if (nav.image_url_preview || nav.image_url) {
                const previewUrl = nav.image_url_preview || (imageUrl.startsWith('http') ? imageUrl : '');
                if (previewUrl) {
                    document.getElementById('categoryNavPreview').src = previewUrl;
                    document.getElementById('categoryNavPreview').style.display = 'block';
                    document.getElementById('categoryNavUploadArea').style.display = 'none';
                } else {
                    document.getElementById('categoryNavPreview').style.display = 'none';
                    document.getElementById('categoryNavUploadArea').style.display = 'block';
                }
            } else {
                document.getElementById('categoryNavPreview').style.display = 'none';
                document.getElementById('categoryNavUploadArea').style.display = 'block';
            }
            
            // æ›´æ–°é“¾æ¥å€¼è¾“å…¥æ–¹å¼
            updateLinkValueInput();
            
            document.getElementById('categoryNavModalTitle').textContent = 'ç¼–è¾‘åˆ†ç±»å¯¼èˆª';
            new bootstrap.Modal(document.getElementById('categoryNavModal')).show();
        }
        
        // äº§å“åˆ†ç±»åˆ—è¡¨
        let productCategories = [];
        
        // åŠ è½½äº§å“åˆ†ç±»åˆ—è¡¨
        async function loadProductCategories() {
            try {
                const response = await fetch('/api/admin/product-categories');
                const data = await response.json();
                if (data.status === 'success') {
                    productCategories = data.data || [];
                    updateCategorySelect();
                }
            } catch (error) {
                console.error('åŠ è½½äº§å“åˆ†ç±»å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°åˆ†ç±»ä¸‹æ‹‰é€‰æ‹©
        function updateCategorySelect() {
            const select = document.getElementById('categoryNavCategorySelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>';
            productCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }
        
        // å¤„ç†åˆ†ç±»é€‰æ‹©å˜åŒ–
        function handleCategorySelectChange(categoryId) {
            document.getElementById('categoryNavCategoryId').value = categoryId;
            document.getElementById('categoryNavLinkValue').value = categoryId;
        }
        
        // æ ¹æ®é“¾æ¥ç±»å‹æ›´æ–°è¾“å…¥æ–¹å¼
        function updateLinkValueInput() {
            const linkType = document.getElementById('categoryNavLinkType').value;
            const linkValueInput = document.getElementById('categoryNavLinkValue');
            const categorySelect = document.getElementById('categoryNavCategorySelect');
            const pageSelect = document.getElementById('categoryNavPageSelect');
            const hintText = document.getElementById('categoryNavLinkHintText');
            
            // éšè—æ‰€æœ‰é€‰é¡¹
            if (categorySelect) categorySelect.style.display = 'none';
            if (pageSelect) pageSelect.style.display = 'none';
            linkValueInput.style.display = 'none';
            
            if (linkType === 'category') {
                // æ˜¾ç¤ºåˆ†ç±»ä¸‹æ‹‰é€‰æ‹©
                if (categorySelect) {
                    categorySelect.style.display = 'block';
                    // è®¾ç½®å½“å‰å€¼
                    const currentCategoryId = document.getElementById('categoryNavCategoryId').value;
                    if (currentCategoryId) {
                        categorySelect.value = currentCategoryId;
                    }
                }
                if (hintText) {
                    hintText.textContent = 'é€‰æ‹©äº§å“åˆ†ç±»åï¼Œç‚¹å‡»å¯¼èˆªå°†è·³è½¬åˆ°è¯¥åˆ†ç±»çš„äº§å“åˆ—è¡¨';
                }
            } else if (linkType === 'page') {
                // æ˜¾ç¤ºé¡µé¢è·¯å¾„ä¸‹æ‹‰é€‰æ‹©
                if (pageSelect) {
                    pageSelect.style.display = 'block';
                    // è®¾ç½®å½“å‰å€¼
                    if (linkValueInput.value) {
                        pageSelect.value = linkValueInput.value;
                    }
                }
                if (hintText) {
                    hintText.textContent = 'é€‰æ‹©å°ç¨‹åºé¡µé¢è·¯å¾„ï¼Œç‚¹å‡»å¯¼èˆªå°†è·³è½¬åˆ°è¯¥é¡µé¢';
                }
            } else {
                // æ˜¾ç¤ºæ–‡æœ¬è¾“å…¥
                linkValueInput.style.display = 'block';
                if (hintText) {
                    hintText.textContent = 'è¾“å…¥å®Œæ•´çš„å¤–éƒ¨é“¾æ¥URLï¼ˆå¦‚ï¼šhttps://example.comï¼‰';
                }
            }
        }

        // åˆ é™¤åˆ†ç±»å¯¼èˆª
        async function deleteCategoryNav(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å¯¼èˆªå—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/admin/homepage/category-navs/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.status === 'success') {
                    await loadCategoryNavs();
                    updateDetailPanel();
                    alert('åˆ é™¤æˆåŠŸ');
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // ä¿å­˜åˆ†ç±»å¯¼èˆª
        async function saveCategoryNav() {
            const id = document.getElementById('categoryNavId').value;
            const linkType = document.getElementById('categoryNavLinkType').value;
            let linkValue = '';
            let categoryId = null;
            
            // æ ¹æ®é“¾æ¥ç±»å‹è·å–é“¾æ¥å€¼
            if (linkType === 'category') {
                const categorySelect = document.getElementById('categoryNavCategorySelect');
                categoryId = categorySelect ? parseInt(categorySelect.value) : null;
                linkValue = categoryId ? categoryId.toString() : '';
                if (!categoryId) {
                    alert('è¯·é€‰æ‹©äº§å“åˆ†ç±»');
                    return;
                }
            } else if (linkType === 'page') {
                const pageSelect = document.getElementById('categoryNavPageSelect');
                linkValue = pageSelect ? pageSelect.value : document.getElementById('categoryNavLinkValue').value;
                if (!linkValue) {
                    alert('è¯·é€‰æ‹©æˆ–è¾“å…¥é¡µé¢è·¯å¾„');
                    return;
                }
            } else {
                linkValue = document.getElementById('categoryNavLinkValue').value;
                if (!linkValue) {
                    alert('è¯·è¾“å…¥å¤–éƒ¨é“¾æ¥URL');
                    return;
                }
            }
            
            // å¤„ç†å›¾ç‰‡URLï¼šå¦‚æœæ˜¯å®Œæ•´URLï¼Œæå–ç›¸å¯¹è·¯å¾„
            let imageUrl = document.getElementById('categoryNavImageUrl').value;
            if (imageUrl) {
                // å¦‚æœæ˜¯å®Œæ•´URLï¼Œå°è¯•æå–ç›¸å¯¹è·¯å¾„
                if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                    // å°è¯•æå– /media/ æˆ– /static/ ä¹‹åçš„éƒ¨åˆ†
                    const mediaMatch = imageUrl.match(/\/(media|static)\/(.+)$/);
                    if (mediaMatch) {
                        imageUrl = `/${mediaMatch[1]}/${mediaMatch[2]}`;
                    }
                }
            }
            
            const data = {
                name: document.getElementById('categoryNavName').value,
                icon: document.getElementById('categoryNavIcon').value,
                image_url: imageUrl,
                link_type: linkType,
                link_value: linkValue,
                category_id: categoryId,
                sort_order: parseInt(document.getElementById('categoryNavSortOrder').value) || 0,
                is_active: document.getElementById('categoryNavIsActive').checked
            };
            
            if (!data.name) {
                alert('è¯·å¡«å†™åç§°');
                return;
            }
            
            try {
                const url = id ? `/api/admin/homepage/category-navs/${id}` : '/api/admin/homepage/category-navs';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('categoryNavModal')).hide();
                    await loadCategoryNavs();
                    updateDetailPanel();
                    alert('ä¿å­˜æˆåŠŸ');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥');
            }
        }

        // ä¸Šä¼ åˆ†ç±»å¯¼èˆªå›¾æ ‡
        async function uploadCategoryNavImage(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('image', file);
            formData.append('subfolder', 'category_nav');
            
            try {
                const response = await fetch('/api/admin/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                let imageUrl = result.image_url || result.url;
                
                if ((result.status === 'success' || result.success === true) && imageUrl) {
                    // å¦‚æœæ˜¯å®Œæ•´URLï¼Œæå–ç›¸å¯¹è·¯å¾„
                    if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                        const mediaMatch = imageUrl.match(/\/(media|static)\/(.+)$/);
                        if (mediaMatch) {
                            imageUrl = `/${mediaMatch[1]}/${mediaMatch[2]}`;
                        }
                    }
                    
                    // ä¿å­˜ç›¸å¯¹è·¯å¾„
                    document.getElementById('categoryNavImageUrl').value = imageUrl;
                    
                    // æ˜¾ç¤ºé¢„è§ˆï¼ˆä½¿ç”¨å®Œæ•´URLï¼‰
                    const previewUrl = result.image_url || result.url;
                    document.getElementById('categoryNavPreview').src = previewUrl;
                    document.getElementById('categoryNavPreview').style.display = 'block';
                    document.getElementById('categoryNavUploadArea').style.display = 'none';
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥');
            }
        }

        // ========== äº§å“æ¨èæ¨¡å—ç®¡ç† ==========

        // åŠ è½½äº§å“æ¨èæ¨¡å—
        async function loadProductSections() {
            try {
                const data = await fetchHomepageApi('/api/admin/homepage/product-sections');
                if (data.status === 'success') {
                    productSections = data.data || [];
                    if (currentMainCategory === 'modules') {
                        updateDetailPanel();
                    } else {
                        updateFixedModuleStatus();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½äº§å“æ¨èæ¨¡å—å¤±è´¥:', error);
                productSections = [];
            }
        }
        
        // æ›´æ–°å›ºå®šæ¨¡å—çŠ¶æ€
        function updateFixedModuleStatus() {
            const fixedModules = ['featured_section', 'time_journey', 'ip_collab', 'works'];
            fixedModules.forEach(moduleType => {
                const section = productSections.find(s => s.section_type === moduleType);
                const statusEl = document.getElementById(`${moduleType}SectionStatus`);
                if (statusEl) {
                    if (section && section.is_active) {
                        statusEl.textContent = 'å·²é…ç½®';
                        statusEl.className = 'badge bg-success ms-2';
                    } else {
                        statusEl.textContent = 'æœªé…ç½®';
                        statusEl.className = 'badge bg-secondary ms-2';
                    }
                }
            });
        }
        
        // è·å–æŒ‡å®šæ¨¡å—çš„é…ç½®é¡¹åˆ—è¡¨
        function getModuleItemsForType(moduleType) {
            const section = productSections.find(s => s.section_type === moduleType);
            if (!section || !section.config) return [];
            try {
                const config = typeof section.config === 'string' ? JSON.parse(section.config) : section.config;
                if (moduleType === 'featured_section') return config.items || [];
                if (moduleType === 'time_journey') return config.categories || [];
                if (moduleType === 'ip_collab' || moduleType === 'works') return config.tabs || [];
            } catch (e) { return []; }
            return [];
        }

        // æ¸²æŸ“æ¨¡å—é¡¹åˆ°å³ä¾§é¢æ¿ï¼ˆå·²æ·»åŠ çš„æ¨¡å—é¡¹å¡ç‰‡ï¼‰
        function renderModuleItemsPanel(moduleType) {
            if (!moduleItemsDirty) {
                prepareModuleContextForEditing(moduleType);
            }
            const items = [...moduleItems];
            const baseUrl = window.location.origin;
            const imageUrl = (url) => {
                if (!url) return '';
                if (url.startsWith('http')) return url;
                return baseUrl + (url.startsWith('/') ? url : '/' + url);
            };
            let cardsHtml = items.map((item, index) => {
                let img = item.image_url || item.main_image;
                if (!img && item.images && item.images[0]) {
                    img = typeof item.images[0] === 'object' ? item.images[0].url : item.images[0];
                }
                const imgUrl = imageUrl(img);
                const title = item.title || item.category_name || item.name || 'æœªå‘½å';
                const desc = item.desc || item.overlay_text || '';
                return `
                    <div class="detail-panel-card mb-3">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                ${imgUrl ? `<img src="${imgUrl}" class="rounded" style="width:80px;height:80px;object-fit:cover;" onerror="this.parentElement.innerHTML='<div class=\\'bg-secondary rounded d-flex align-items-center justify-content-center\\' style=\\'width:80px;height:80px\\'><small>æ— å›¾</small></div>'">` : '<div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width:80px;height:80px"><small>æ— å›¾</small></div>'}
                            </div>
                            <div class="col">
                                <h6 class="mb-1">${title}</h6>
                                ${desc ? `<small class="text-muted">${desc}</small>` : ''}
                                ${item.tag ? `<span class="badge bg-danger ms-2">${item.tag}</span>` : ''}
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editModuleItemFromPanel(${index}, '${moduleType}')"><i class="fas fa-edit"></i> ç¼–è¾‘</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteModuleItemFromPanel(${index}, '${moduleType}')"><i class="fas fa-trash"></i> åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            if (items.length === 0) {
                cardsHtml = '<div class="text-center text-muted py-4"><p>æš‚æ— æ¨¡å—é¡¹</p><p class="small">ç‚¹å‡»ä¸‹æ–¹ã€Œæ·»åŠ é¡¹ã€æŒ‰é’®æ·»åŠ äº§å“æˆ–åˆ†ç±»</p></div>';
            }
            return `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-muted">å…± ${items.length} é¡¹</span>
                    <div>
                        <button class="btn btn-sm btn-primary me-2" onclick="addModuleItemFromPanel('${moduleType}')"><i class="fas fa-plus"></i> æ·»åŠ é¡¹</button>
                        <button class="btn btn-sm btn-outline-success" onclick="saveModuleFromPanel('${moduleType}')"><i class="fas fa-save"></i> ä¿å­˜</button>
                    </div>
                </div>
                <div id="moduleItemsCardsContainer">${cardsHtml}</div>
            `;
        }

        let currentModuleTypeForItem = '';  // å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ¨¡å—ç±»å‹ï¼ˆç”¨äºæç¤ºï¼‰
        // å‡†å¤‡æ¨¡å—ç¼–è¾‘ä¸Šä¸‹æ–‡ï¼ˆè®¾ç½® productSectionModal è¡¨å•å’Œ moduleItemsï¼‰
        function prepareModuleContextForEditing(moduleType) {
            currentModuleTypeForItem = moduleType || '';
            const idEl = document.getElementById('productSectionId');
            const typeEl = document.getElementById('productSectionType');
            if (!idEl || !typeEl) return;
            const section = productSections.find(s => s.section_type === moduleType);
            if (section) {
                idEl.value = section.id;
                typeEl.value = section.section_type;
                const titleEl = document.getElementById('productSectionTitle');
                if (titleEl) titleEl.value = getModuleTitle(section.section_type);
                const subtitleEl = document.getElementById('productSectionSubtitle');
                if (subtitleEl) subtitleEl.value = section.subtitle || '';
                const sortEl = document.getElementById('productSectionSortOrder');
                if (sortEl) sortEl.value = section.sort_order || getModuleSortOrder(section.section_type);
                const activeEl = document.getElementById('productSectionIsActive');
                if (activeEl) activeEl.checked = section.is_active;
                if (!moduleItemsDirty) {
                    const config = section.config ? (typeof section.config === 'string' ? JSON.parse(section.config) : section.config) : {};
                    if (moduleType === 'featured_section') moduleItems = config.items || [];
                    else if (moduleType === 'time_journey') moduleItems = config.categories || [];
                    else if (moduleType === 'ip_collab' || moduleType === 'works') moduleItems = config.tabs || [];
                    else moduleItems = [];
                }
            } else {
                idEl.value = '';
                typeEl.value = moduleType;
                const titleEl = document.getElementById('productSectionTitle');
                if (titleEl) titleEl.value = getModuleTitle(moduleType);
                const subtitleEl = document.getElementById('productSectionSubtitle');
                if (subtitleEl) subtitleEl.value = '';
                const sortEl = document.getElementById('productSectionSortOrder');
                if (sortEl) sortEl.value = getModuleSortOrder(moduleType);
                const activeEl = document.getElementById('productSectionIsActive');
                if (activeEl) activeEl.checked = true;
                if (!moduleItemsDirty) moduleItems = [];
            }
        }

        // ä»å³ä¾§é¢æ¿æ·»åŠ æ¨¡å—é¡¹
        function addModuleItemFromPanel(moduleType) {
            prepareModuleContextForEditing(moduleType);
            addModuleItem();
        }

        // ä»å³ä¾§é¢æ¿ç¼–è¾‘æ¨¡å—é¡¹
        function editModuleItemFromPanel(index, moduleType) {
            prepareModuleContextForEditing(moduleType);
            editModuleItem(index);
        }

        // ä»å³ä¾§é¢æ¿åˆ é™¤æ¨¡å—é¡¹
        function deleteModuleItemFromPanel(index, moduleType) {
            prepareModuleContextForEditing(moduleType);
            moduleItems.splice(index, 1);
            moduleItemsDirty = true;
            updateDetailPanel();
        }

        // ä»å³ä¾§é¢æ¿ä¿å­˜æ¨¡å—
        async function saveModuleFromPanel(moduleType) {
            prepareModuleContextForEditing(moduleType);
            await saveProductSection();
            moduleItemsDirty = false;
            updateDetailPanel();
        }

        // ç¼–è¾‘å›ºå®šæ¨¡å—
        function editFixedModule(moduleType) {
            // æŸ¥æ‰¾æˆ–åˆ›å»ºå¯¹åº”çš„æ¨¡å—é…ç½®
            let section = productSections.find(s => s.section_type === moduleType);
            
            if (section) {
                // ç¼–è¾‘ç°æœ‰æ¨¡å—
                editProductSection(section.id);
            } else {
                // åˆ›å»ºæ–°æ¨¡å—
                document.getElementById('productSectionId').value = '';
                document.getElementById('productSectionType').value = moduleType;
                document.getElementById('productSectionTitle').value = getModuleTitle(moduleType);
                document.getElementById('productSectionSubtitle').value = '';
                document.getElementById('productSectionSortOrder').value = getModuleSortOrder(moduleType);
                document.getElementById('productSectionIsActive').checked = true;
                
                // é‡ç½®æ¨¡å—é¡¹
                moduleItems = [];
                renderModuleItems();
                
                // å¤„ç†æ¨¡å—ç±»å‹åˆ‡æ¢
                handleSectionTypeChange();
                
                document.getElementById('productSectionModalTitle').textContent = `é…ç½®${getModuleTitle(moduleType)}`;
                new bootstrap.Modal(document.getElementById('productSectionModal')).show();
            }
        }
        
        // è·å–æ¨¡å—æ ‡é¢˜
        function getModuleTitle(moduleType) {
            const titles = {
                'featured_section': 'å½“å­£ä¸»æ¨',
                'time_journey': 'æ—¶å…‰æ—…ç¨‹',
                'ip_collab': 'IPè”å',
                'works': 'ä½œå“å±•ç¤º'
            };
            return titles[moduleType] || '';
        }
        
        // è·å–æ¨¡å—æ’åº
        function getModuleSortOrder(moduleType) {
            const orders = {
                'featured_section': 1,
                'time_journey': 2,
                'ip_collab': 3,
                'works': 4
            };
            return orders[moduleType] || 0;
        }

        // ç¼–è¾‘äº§å“æ¨èæ¨¡å—
        function editProductSection(id) {
            const section = productSections.find(s => s.id === id);
            if (!section) return;
            
            document.getElementById('productSectionId').value = section.id;
            document.getElementById('productSectionType').value = section.section_type;
            // å›ºå®šæ¨¡å—çš„æ ‡é¢˜ç”±å‰ç«¯å†³å®šï¼Œæ˜¾ç¤ºå›ºå®šæ ‡é¢˜
            document.getElementById('productSectionTitle').value = getModuleTitle(section.section_type) || section.title || '';
            document.getElementById('productSectionSubtitle').value = section.subtitle || '';
            document.getElementById('productSectionSortOrder').value = section.sort_order || getModuleSortOrder(section.section_type);
            document.getElementById('productSectionIsActive').checked = section.is_active;
            
            // å¤„ç†æ¨¡å—ç±»å‹åˆ‡æ¢
            handleSectionTypeChange();
            
            const itemBasedTypes = ['featured_section', 'time_journey', 'ip_collab', 'works'];
            if (itemBasedTypes.includes(section.section_type)) {
                // åŸºäºé¡¹çš„æ¨¡å—ï¼ŒåŠ è½½é…ç½®
                if (section.config) {
                    try {
                        const config = typeof section.config === 'string' ? JSON.parse(section.config) : section.config;
                        const sectionType = section.section_type;
                        
                        if (sectionType === 'featured_section') {
                            moduleItems = config.items || [];
                        } else if (sectionType === 'time_journey') {
                            moduleItems = config.categories || [];
                        } else if (sectionType === 'ip_collab') {
                            moduleItems = config.tabs || [];
                        } else if (sectionType === 'works') {
                            moduleItems = config.tabs || [];
                        } else {
                            moduleItems = [];
                        }
                    } catch (e) {
                        console.error('è§£æé…ç½®å¤±è´¥:', e);
                        moduleItems = [];
                    }
                } else {
                    moduleItems = [];
                }
                renderModuleItems();
            } else {
                // ä¼ ç»Ÿäº§å“æ¨èæ¨¡å—
                document.getElementById('productSectionShowMore').checked = section.show_more_button;
                document.getElementById('productSectionMoreLink').value = section.more_link || '';
                document.getElementById('productSectionLayout').value = section.layout_type;
                document.getElementById('productSectionCategoryId').value = section.category_id || '';
                document.getElementById('productSectionLimit').value = section.limit || 6;
                
                // è®¾ç½®äº§å“IDåˆ—è¡¨
                if (section.product_ids && section.product_ids.length > 0) {
                    document.getElementById('productSectionProductIds').value = section.product_ids.join(',');
                } else {
                    document.getElementById('productSectionProductIds').value = '';
                }
            }
            
            const moduleTitle = getModuleTitle(section.section_type) || section.title || 'äº§å“æ¨èæ¨¡å—';
            document.getElementById('productSectionModalTitle').textContent = `é…ç½®${moduleTitle}`;
            new bootstrap.Modal(document.getElementById('productSectionModal')).show();
        }

        // åˆ é™¤äº§å“æ¨èæ¨¡å—
        async function deleteProductSection(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº§å“æ¨èæ¨¡å—å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/api/admin/homepage/product-sections/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.status === 'success') {
                    loadProductSections();
                    alert('åˆ é™¤æˆåŠŸ');
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // ä¿å­˜äº§å“æ¨èæ¨¡å—
        async function saveProductSection() {
            const id = document.getElementById('productSectionId').value;
            const sectionType = document.getElementById('productSectionType').value;
            const itemBasedTypes = ['featured_section', 'time_journey', 'ip_collab', 'works'];
            
            // å›ºå®šæ¨¡å—çš„æ ‡é¢˜ç”±å‰ç«¯å†³å®šï¼Œä½¿ç”¨å›ºå®šæ ‡é¢˜
            const fixedTitle = getModuleTitle(sectionType);
            const title = fixedTitle || document.getElementById('productSectionTitle').value;
            
            let data = {
                section_type: sectionType,
                title: title, // ä½¿ç”¨å›ºå®šæ ‡é¢˜
                subtitle: document.getElementById('productSectionSubtitle').value,
                sort_order: parseInt(document.getElementById('productSectionSortOrder').value) || getModuleSortOrder(sectionType),
                is_active: document.getElementById('productSectionIsActive').checked
            };
            
            if (itemBasedTypes.includes(sectionType)) {
                // åŸºäºé¡¹çš„æ¨¡å—ï¼ˆå½“å­£ä¸»æ¨ã€æ—¶å…‰æ—…ç¨‹ã€IPè”åã€ä½œå“å±•ç¤ºï¼‰
                // å¤„ç†æ¨¡å—é¡¹ï¼Œä»äº§å“/åˆ†ç±»è·å–å›¾ç‰‡
                const processedItems = await processModuleItems(moduleItems, sectionType);
                
                let config = {};
                if (sectionType === 'featured_section') {
                    config = {
                        items: processedItems,
                        show_subscribe: true
                    };
                } else if (sectionType === 'time_journey') {
                    config = {
                        categories: processedItems
                    };
                } else if (sectionType === 'ip_collab') {
                    config = {
                        tabs: processedItems,
                        active_tab: processedItems.length > 0 ? processedItems[0].id : null
                    };
                } else if (sectionType === 'works') {
                    config = {
                        tabs: processedItems,
                        active_tab: processedItems.length > 0 ? processedItems[0].id : null
                    };
                }
                
                data.config = config;
            } else {
                // ä¼ ç»Ÿäº§å“æ¨èæ¨¡å—
                const productIdsStr = document.getElementById('productSectionProductIds').value;
                const productIds = productIdsStr ? productIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id)) : [];
                
                data.show_more_button = document.getElementById('productSectionShowMore').checked;
                data.more_link = document.getElementById('productSectionMoreLink').value;
                data.layout_type = document.getElementById('productSectionLayout').value;
                data.product_ids = productIds;
                data.category_id = document.getElementById('productSectionCategoryId').value || null;
                data.limit = parseInt(document.getElementById('productSectionLimit').value) || 6;
            }
            
            if (!data.title || !data.section_type) {
                alert('è¯·å¡«å†™æ ‡é¢˜å’Œæ¨¡å—ç±»å‹');
                return;
            }
            
            try {
                const url = id ? `/api/admin/homepage/product-sections/${id}` : '/api/admin/homepage/product-sections';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const text = await response.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    console.error('ä¿å­˜å¤±è´¥: æœåŠ¡å™¨è¿”å›éJSON', text.substring(0, 200));
                    const msg = response.status >= 500 ? 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•' : 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
                    if (typeof UX !== 'undefined' && UX.Toast) UX.Toast.error(msg);
                    else alert(msg);
                    return;
                }
                if (result.status === 'success') {
                    const productSectionModalEl = document.getElementById('productSectionModal');
                    const productSectionModalInstance = productSectionModalEl ? bootstrap.Modal.getInstance(productSectionModalEl) : null;
                    if (productSectionModalInstance) productSectionModalInstance.hide();
                    await loadProductSections();
                    if (typeof UX !== 'undefined' && UX.Toast) UX.Toast.success('ä¿å­˜æˆåŠŸ');
                    else alert('ä¿å­˜æˆåŠŸ');
                    setTimeout(() => updateFixedModuleStatus(), 500);
                } else {
                    const errMsg = result.message || 'ä¿å­˜å¤±è´¥';
                    if (typeof UX !== 'undefined' && UX.Toast) UX.Toast.error(errMsg);
                    else alert('ä¿å­˜å¤±è´¥: ' + errMsg);
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                const msg = 'ä¿å­˜å¤±è´¥: ' + (error.message || 'è¯·é‡è¯•');
                if (typeof UX !== 'undefined' && UX.Toast) UX.Toast.error(msg);
                else alert(msg);
            }
        }

        // å¤„ç†æ¨¡å—é¡¹ï¼Œä»äº§å“/åˆ†ç±»è·å–å›¾ç‰‡URL
        async function processModuleItems(items, sectionType) {
            const processedItems = [];
            
            for (let item of items) {
                let processedItem = {
                    id: item.id || Date.now() + Math.random(),
                    title: item.title,
                    desc: item.desc,
                    tag: item.tag,
                    link_type: item.link_type,
                    link_value: item.link_value
                };
                
                // ä»äº§å“è·å–å›¾ç‰‡
                if (item.product_id) {
                    // ç¡®ä¿ allProducts å·²åŠ è½½
                    if (allProducts.length === 0) {
                        await loadProductsForSelector();
                    }
                    const product = allProducts.find(p => p.id === item.product_id);
                    if (product) {
                        processedItem.product_id = product.id;
                        processedItem.product_name = product.name;
                        // ç¡®ä¿å›¾ç‰‡URLæ˜¯ç›¸å¯¹è·¯å¾„
                        let imageUrl = product.image_url || '';
                        if (imageUrl && imageUrl.startsWith('http')) {
                            // æå–ç›¸å¯¹è·¯å¾„
                            const mediaMatch = imageUrl.match(/\/(media|static)\/(.+)$/);
                            if (mediaMatch) {
                                imageUrl = `/${mediaMatch[1]}/${mediaMatch[2]}`;
                            }
                        }
                        processedItem.image_url = imageUrl;
                        
                        // å¦‚æœé…ç½®äº†è·³è½¬åˆ°äº§å“ï¼Œè‡ªåŠ¨è®¾ç½®
                        if (!processedItem.link_type || processedItem.link_type === 'none') {
                            processedItem.link_type = 'product';
                            processedItem.link_value = product.id.toString();
                        }
                    } else {
                        console.warn(`äº§å“ID ${item.product_id} æœªæ‰¾åˆ°`);
                    }
                }
                
                // ä»åˆ†ç±»è·å–å›¾ç‰‡
                if (item.category_id) {
                    if (productCategoriesTree.length === 0) {
                        await loadCategoriesForItem();
                    }
                    const cat1 = productCategoriesTree.find(c => c.id == item.category_id);
                    if (cat1) {
                        let categoryName = cat1.name;
                        let imageUrl = cat1.image_url || '';
                        if (item.subcategory_id && cat1.subcategories) {
                            const sub = cat1.subcategories.find(s => s.id == item.subcategory_id);
                            if (sub) {
                                categoryName = sub.name;
                                imageUrl = sub.image_url || imageUrl;
                            }
                        }
                        processedItem.category_id = cat1.id;
                        processedItem.subcategory_id = item.subcategory_id || undefined;
                        processedItem.category_name = categoryName;
                        if (imageUrl && imageUrl.startsWith('http')) {
                            const mediaMatch = imageUrl.match(/\/(media|static)\/(.+)$/);
                            if (mediaMatch) imageUrl = `/${mediaMatch[1]}/${mediaMatch[2]}`;
                        }
                        processedItem.image_url = imageUrl;
                        if (sectionType === 'time_journey') {
                            processedItem.main_image = imageUrl;
                            processedItem.category_name = categoryName;
                        }
                        if (!processedItem.link_type || processedItem.link_type === 'none') {
                            processedItem.link_type = 'category';
                            processedItem.link_value = (item.subcategory_id || cat1.id).toString();
                        }
                    } else {
                        console.warn(`åˆ†ç±»ID ${item.category_id} æœªæ‰¾åˆ°`);
                    }
                }
                // é£æ ¼å›¾ç‰‡ï¼ˆå•å¼ ï¼‰
                if (item.style_image_id) {
                    processedItem.style_image_id = item.style_image_id;
                    processedItem.style_category_id = item.style_category_id;
                    processedItem.style_subcategory_id = item.style_subcategory_id || undefined;
                    processedItem.category_name = item.category_name || item.title;
                    let styleImgUrl = item.image_url || '';
                    if (styleImgUrl && styleImgUrl.startsWith('http')) {
                        const m = styleImgUrl.match(/\/(media|static)\/(.+)$/);
                        if (m) styleImgUrl = `/${m[1]}/${m[2]}`;
                    }
                    processedItem.image_url = styleImgUrl;
                }
                // é£æ ¼åˆ†ç±»ç›®å½•ï¼ˆä»… IPè”åï¼šæŒ‰åˆ†ç±»æ‹‰å–å…¨éƒ¨é£æ ¼å›¾ç‰‡ï¼‰
                else if (item.style_category_id && !item.style_image_id) {
                    processedItem.style_category_id = item.style_category_id;
                    processedItem.style_subcategory_id = item.style_subcategory_id || undefined;
                    processedItem.category_name = item.category_name || item.title;
                }
                
                // æ ¹æ®æ¨¡å—ç±»å‹è®¾ç½®ç‰¹å®šå­—æ®µ
                if (sectionType === 'time_journey') {
                    processedItem.category_name = processedItem.category_name || processedItem.title;
                    processedItem.overlay_text = processedItem.desc;
                } else if (sectionType === 'ip_collab') {
                    processedItem.name = processedItem.title || processedItem.category_name || processedItem.product_name || 'æœªå‘½å';
                    // IPè”åï¼šåˆ†ç±»ç›®å½•ï¼ˆcategory_id æˆ– style_category_idï¼‰æ—¶ç”±åç«¯æŒ‰åˆ†ç±»å±•å¼€å…¨éƒ¨å›¾ç‰‡ï¼›å¦åˆ™ç”¨å•å¼ 
                    if ((processedItem.category_id || processedItem.style_category_id) && !processedItem.product_id && !processedItem.style_image_id) {
                        processedItem.images = [];
                    } else {
                        processedItem.images = processedItem.image_url ? [processedItem.image_url] : [];
                    }
                } else if (sectionType === 'works') {
                    processedItem.name = processedItem.title;
                    processedItem.main_image = processedItem.image_url;
                    processedItem.images = processedItem.image_url ? [{ url: processedItem.image_url }] : [];
                }
                
                processedItems.push(processedItem);
            }
            
            return processedItems;
        }

        // ========== äº§å“é€‰æ‹©å™¨ ==========
        let allProducts = [];
        let selectedProductIds = new Set();
        let productCategoriesTree = [];  // ä¸€çº§+äºŒçº§åˆ†ç±»æ ‘

        // åŠ è½½äº§å“åˆ†ç±»æ ‘
        async function loadProductCategoriesTree() {
            try {
                const data = await fetchHomepageApi('/api/admin/homepage/product-categories-tree');
                if (data.status === 'success') {
                    productCategoriesTree = data.data || [];
                    populateProductSelectorCategoryFilters();
                }
            } catch (error) {
                console.error('åŠ è½½äº§å“åˆ†ç±»æ ‘å¤±è´¥:', error);
            }
        }

        // å¡«å……äº§å“é€‰æ‹©å™¨çš„åˆ†ç±»ç­›é€‰ä¸‹æ‹‰
        function populateProductSelectorCategoryFilters() {
            const sel1 = document.getElementById('productSelectorCategory1');
            const sel2 = document.getElementById('productSelectorCategory2');
            const itemSel1 = document.getElementById('itemProductSelectorCategory1');
            const itemSel2 = document.getElementById('itemProductSelectorCategory2');
            [sel1, itemSel1].forEach(select => {
                if (!select) return;
                select.innerHTML = '<option value="">å…¨éƒ¨</option>';
                productCategoriesTree.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.id;
                    opt.textContent = cat.name;
                    select.appendChild(opt);
                });
            });
        }

        // äº§å“é€‰æ‹©å™¨åˆ†ç±»ç­›é€‰å˜åŒ–
        async function onProductSelectorCategoryChange() {
            const cat1 = document.getElementById('productSelectorCategory1')?.value || '';
            const cat2 = document.getElementById('productSelectorCategory2')?.value || '';
            const sel2 = document.getElementById('productSelectorCategory2');
            sel2.innerHTML = '<option value="">å…¨éƒ¨</option>';
            if (cat1) {
                const cat = productCategoriesTree.find(c => c.id == cat1);
                if (cat && cat.subcategories) {
                    cat.subcategories.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub.id;
                        opt.textContent = sub.name;
                        sel2.appendChild(opt);
                    });
                }
            }
            await loadProductsForSelector(cat1 ? parseInt(cat1) : null, cat2 ? parseInt(cat2) : null);
        }

        // æ¨¡å—é¡¹äº§å“é€‰æ‹©å™¨åˆ†ç±»ç­›é€‰å˜åŒ–
        async function onItemProductSelectorCategoryChange() {
            const cat1 = document.getElementById('itemProductSelectorCategory1')?.value || '';
            const cat2 = document.getElementById('itemProductSelectorCategory2')?.value || '';
            const sel2 = document.getElementById('itemProductSelectorCategory2');
            sel2.innerHTML = '<option value="">å…¨éƒ¨</option>';
            if (cat1) {
                const cat = productCategoriesTree.find(c => c.id == cat1);
                if (cat && cat.subcategories) {
                    cat.subcategories.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub.id;
                        opt.textContent = sub.name;
                        sel2.appendChild(opt);
                    });
                }
            }
            await loadProductsForItemSelector(cat1 ? parseInt(cat1) : null, cat2 ? parseInt(cat2) : null);
        }

        // åŠ è½½äº§å“åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†ç±»ç­›é€‰ï¼‰
        async function loadProductsForSelector(categoryId, subcategoryId) {
            try {
                let url = '/api/admin/homepage/products';
                const params = [];
                if (categoryId) params.push('category_id=' + categoryId);
                if (subcategoryId) params.push('subcategory_id=' + subcategoryId);
                if (params.length) url += '?' + params.join('&');
                const data = await fetchHomepageApi(url);
                if (data.status === 'success') {
                    allProducts = data.data || [];
                    renderProductSelector();
                }
            } catch (error) {
                console.error('åŠ è½½äº§å“åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ‰“å¼€äº§å“é€‰æ‹©å™¨
        function openProductSelector() {
            // ä»è¾“å…¥æ¡†è¯»å–å·²é€‰æ‹©çš„äº§å“ID
            const productIdsStr = document.getElementById('productSectionProductIds').value;
            if (productIdsStr) {
                selectedProductIds = new Set(
                    productIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id))
                );
            } else {
                selectedProductIds = new Set();
            }
            
            document.getElementById('productSelectorCategory1').value = '';
            document.getElementById('productSelectorCategory2').innerHTML = '<option value="">å…¨éƒ¨</option>';
            loadProductsForSelector(null, null).then(() => {
                renderProductSelector();
                new bootstrap.Modal(document.getElementById('productSelectorModal')).show();
            });
        }

        // æ¸²æŸ“äº§å“é€‰æ‹©å™¨
        function renderProductSelector() {
            const container = document.getElementById('productSelectorList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (allProducts.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">æš‚æ— äº§å“</p>';
                return;
            }
            
            allProducts.forEach(product => {
                const isSelected = selectedProductIds.has(product.id);
                const div = document.createElement('div');
                div.className = `product-selector-item ${isSelected ? 'selected' : ''}`;
                div.innerHTML = `
                    <div class="product-selector-card" onclick="toggleProductSelection(${product.id})">
                        <div class="product-selector-checkbox">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleProductSelection(${product.id})">
                        </div>
                        <div class="product-selector-image">
                            <img src="${product.image_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzMzMzMzMyIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77liqE8L3RleHQ+PC9zdmc+'}" 
                                 alt="${product.name}" 
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzMzMzMzMyIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77liqE8L3RleHQ+PC9zdmc+'; this.onerror=null;">
                        </div>
                        <div class="product-selector-info">
                            <div class="product-selector-name">${product.name}</div>
                            <div class="product-selector-category">${[product.category_name, product.subcategory_name].filter(Boolean).join(' / ') || 'æœªåˆ†ç±»'}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            updateSelectedProductsCount();
        }

        // åˆ‡æ¢äº§å“é€‰æ‹©
        function toggleProductSelection(productId) {
            if (selectedProductIds.has(productId)) {
                selectedProductIds.delete(productId);
            } else {
                selectedProductIds.add(productId);
            }
            renderProductSelector();
        }

        // ç¡®è®¤é€‰æ‹©äº§å“
        function confirmProductSelection() {
            const productIdsArray = Array.from(selectedProductIds).sort((a, b) => a - b);
            document.getElementById('productSectionProductIds').value = productIdsArray.join(',');
            updateSelectedProductsCount();
            bootstrap.Modal.getInstance(document.getElementById('productSelectorModal')).hide();
        }

        // æ›´æ–°å·²é€‰æ‹©äº§å“æ•°é‡æ˜¾ç¤º
        function updateSelectedProductsCount() {
            const count = selectedProductIds.size;
            const preview = document.getElementById('selectedProductsPreview');
            const countSpan = document.getElementById('selectedProductsCount');
            const selectorCount = document.getElementById('productSelectorCount');
            
            if (count > 0 && preview && countSpan) {
                preview.style.display = 'block';
                countSpan.textContent = count;
            } else if (preview) {
                preview.style.display = 'none';
            }
            
            if (selectorCount) {
                selectorCount.textContent = count;
            }
        }

        // ============================================================================
        // æ¨¡å—é¡¹ç®¡ç†ï¼ˆå½“å­£ä¸»æ¨ã€æ—¶å…‰æ—…ç¨‹ã€IPè”åã€ä½œå“å±•ç¤ºç­‰ï¼‰
        // ============================================================================
        
        let moduleItems = []; // å½“å‰æ¨¡å—é¡¹åˆ—è¡¨
        let currentEditingItemIndex = -1; // å½“å‰ç¼–è¾‘çš„é¡¹ç´¢å¼•
        let selectedItemProduct = null; // ä¸ºæ¨¡å—é¡¹é€‰æ‹©çš„äº§å“
        // productCategories å·²åœ¨ä¸Šé¢å£°æ˜ï¼Œä¸å†é‡å¤å£°æ˜

        // å¤„ç†æ¨¡å—ç±»å‹åˆ‡æ¢
        function handleSectionTypeChange() {
            const sectionType = document.getElementById('productSectionType').value;
            const itemBasedTypes = ['featured_section', 'time_journey', 'ip_collab', 'works'];
            const itemBasedConfig = document.getElementById('itemBasedConfig');
            const productBasedConfig = document.getElementById('productBasedConfig');
            const productBasedConfigRight = document.getElementById('productBasedConfigRight');
            
            if (itemBasedTypes.includes(sectionType)) {
                // æ˜¾ç¤ºåŸºäºé¡¹çš„é…ç½®
                if (itemBasedConfig) itemBasedConfig.style.display = 'block';
                if (productBasedConfig) productBasedConfig.style.display = 'none';
                if (productBasedConfigRight) productBasedConfigRight.style.display = 'none';
                // åŠ è½½æ¨¡å—é¡¹
                loadModuleItems();
            } else {
                // æ˜¾ç¤ºåŸºäºäº§å“çš„é…ç½®
                if (itemBasedConfig) itemBasedConfig.style.display = 'none';
                if (productBasedConfig) productBasedConfig.style.display = 'block';
                if (productBasedConfigRight) productBasedConfigRight.style.display = 'block';
            }
        }

        // åŠ è½½æ¨¡å—é¡¹åˆ—è¡¨
        function loadModuleItems() {
            const sectionId = document.getElementById('productSectionId').value;
            if (!sectionId) {
                moduleItems = [];
                renderModuleItems();
                return;
            }
            
            // ä»å·²åŠ è½½çš„productSectionsä¸­è·å–é…ç½®
            const section = productSections.find(s => s.id == sectionId);
            if (section && section.config) {
                try {
                    const config = typeof section.config === 'string' ? JSON.parse(section.config) : section.config;
                    const sectionType = document.getElementById('productSectionType').value;
                    
                    if (sectionType === 'featured_section') {
                        moduleItems = config.items || [];
                    } else if (sectionType === 'time_journey') {
                        moduleItems = config.categories || [];
                    } else if (sectionType === 'ip_collab') {
                        moduleItems = config.tabs || [];
                    } else if (sectionType === 'works') {
                        moduleItems = config.tabs || [];
                    } else {
                        moduleItems = [];
                    }
                } catch (e) {
                    console.error('è§£æé…ç½®å¤±è´¥:', e);
                    moduleItems = [];
                }
            } else {
                moduleItems = [];
            }
            
            renderModuleItems();
        }

        // æ¸²æŸ“æ¨¡å—é¡¹åˆ—è¡¨
        function renderModuleItems() {
            const container = document.getElementById('moduleItemsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (moduleItems.length === 0) {
                container.innerHTML = '<p class="text-muted">æš‚æ— æ¨¡å—é¡¹ï¼Œè¯·æ·»åŠ </p>';
                return;
            }
            
            moduleItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'banner-item mb-2';
                const imageUrl = item.image_url || item.main_image || '';
                const title = item.title || item.category_name || item.name || 'æœªå‘½å';
                
                div.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            ${imageUrl ? `<img src="${imageUrl}" class="banner-preview" alt="${title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjEyMCIgZmlsbD0iI2NjYyIvPjx0ZXh0IHg9IjE1MCIgeT0iNjAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvuWJjzwvdGV4dD48L3N2Zz4='">` : '<div class="banner-preview bg-secondary d-flex align-items-center justify-content-center"><small>æ— å›¾ç‰‡</small></div>'}
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-1">${title}</h6>
                            <small class="text-muted">${item.desc || item.overlay_text || ''}</small>
                            ${item.tag ? `<br><span class="badge bg-danger">${item.tag}</span>` : ''}
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editModuleItem(${index})">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteModuleItem(${index})">åˆ é™¤</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // æ·»åŠ æ¨¡å—é¡¹
        function addModuleItem() {
            currentEditingItemIndex = -1;
            resetModuleItemForm();
            document.getElementById('moduleItemModalTitle').textContent = 'æ·»åŠ æ¨¡å—é¡¹';
            const hintEl = document.getElementById('moduleItemTitleHint');
            if (hintEl) {
                hintEl.style.display = (currentModuleTypeForItem === 'ip_collab' || currentModuleTypeForItem === 'works') ? 'block' : 'none';
            }
            new bootstrap.Modal(document.getElementById('moduleItemModal')).show();
        }

        // ç¼–è¾‘æ¨¡å—é¡¹
        async function editModuleItem(index) {
            currentEditingItemIndex = index;
            const item = moduleItems[index];
            if (!item) return;
            
            // å¡«å……è¡¨å•
            document.getElementById('moduleItemIndex').value = index;
            document.getElementById('moduleItemTitle').value = item.title || item.category_name || item.name || '';
            document.getElementById('moduleItemDesc').value = item.desc || item.overlay_text || '';
            document.getElementById('moduleItemTag').value = item.tag || '';
            document.getElementById('moduleItemLinkType').value = item.link_type || 'none';
            document.getElementById('moduleItemLinkValue').value = item.link_value || '';
            
            // åˆ¤æ–­å›¾ç‰‡æ¥æºç±»å‹
            if (item.product_id) {
                document.getElementById('moduleItemSourceType').value = 'product';
                document.getElementById('moduleItemProductIdValue').value = item.product_id;
                // ä»äº§å“åˆ—è¡¨è·å–äº§å“åç§°
                const product = allProducts.find(p => p.id === item.product_id);
                document.getElementById('moduleItemProductId').value = product ? product.name : `äº§å“ID: ${item.product_id}`;
                handleItemSourceTypeChange();
                
                // æ˜¾ç¤ºäº§å“å›¾ç‰‡é¢„è§ˆ
                const productImageUrl = product ? (product.image_url || '') : (item.image_url || '');
                if (productImageUrl) {
                    document.getElementById('moduleItemImagePreview').innerHTML = `<img src="${productImageUrl}" style="max-width: 100%; border-radius: 8px;" onerror="this.parentElement.innerHTML='<p class=\\'text-muted\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</p>'">`;
                }
            } else if (item.category_id) {
                document.getElementById('moduleItemSourceType').value = 'category';
                handleItemSourceTypeChange();
                if (productCategoriesTree.length === 0) {
                    await loadCategoriesForItem();
                }
                const cat1 = productCategoriesTree.find(c => c.id == item.category_id);
                if (cat1) {
                    document.getElementById('moduleItemCategory1').value = cat1.id;
                    const sel2 = document.getElementById('moduleItemCategory2');
                    sel2.innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
                    if (cat1.subcategories) {
                        cat1.subcategories.forEach(sub => {
                            const opt = document.createElement('option');
                            opt.value = sub.id;
                            opt.textContent = sub.name;
                            sel2.appendChild(opt);
                        });
                    }
                    if (item.subcategory_id) {
                        document.getElementById('moduleItemCategory2').value = item.subcategory_id;
                    }
                    document.getElementById('moduleItemCategoryId').value = item.subcategory_id || item.category_id;
                    updateModuleItemCategoryPreview(cat1.id, item.subcategory_id || '');
                } else {
                    document.getElementById('moduleItemCategory1').value = item.category_id;
                    document.getElementById('moduleItemCategoryId').value = item.category_id;
                    const imgUrl = item.image_url || item.main_image || '';
                    if (imgUrl) {
                        document.getElementById('moduleItemImagePreview').innerHTML = `<img src="${imgUrl}" style="max-width: 100%; border-radius: 8px;" onerror="this.parentElement.innerHTML='<p class=\\'text-muted\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</p>'">`;
                    }
                }
            } else if (item.style_category_id && !item.style_image_id) {
                document.getElementById('moduleItemSourceType').value = 'style_category';
                handleItemSourceTypeChange();
                await loadStyleCategoriesForDir();
                const cat1 = styleCategoriesTree.find(c => c.id == item.style_category_id);
                if (cat1) {
                    document.getElementById('moduleItemStyleCategoryDir1').value = item.style_category_id;
                    const sel2 = document.getElementById('moduleItemStyleCategoryDir2');
                    sel2.innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§é£æ ¼åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
                    if (cat1.subcategories) {
                        cat1.subcategories.forEach(sub => {
                            const opt = document.createElement('option');
                            opt.value = sub.id;
                            opt.textContent = sub.name;
                            sel2.appendChild(opt);
                        });
                    }
                    if (item.style_subcategory_id) {
                        document.getElementById('moduleItemStyleCategoryDir2').value = item.style_subcategory_id;
                    }
                    document.getElementById('moduleItemTitle').value = item.title || item.category_name || cat1.name;
                }
            } else if (item.style_image_id) {
                document.getElementById('moduleItemSourceType').value = 'style';
                handleItemSourceTypeChange();
                if (styleCategoriesTree.length === 0) {
                    await loadStyleCategoriesForItem();
                }
                const cat1 = styleCategoriesTree.find(c => c.id == item.style_category_id);
                if (cat1) {
                    document.getElementById('moduleItemStyleCategory1').value = item.style_category_id;
                    const cat2 = item.style_subcategory_id || '';
                    const sel2 = document.getElementById('moduleItemStyleCategory2');
                    sel2.innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§é£æ ¼åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
                    if (cat1.subcategories) {
                        cat1.subcategories.forEach(sub => {
                            const opt = document.createElement('option');
                            opt.value = sub.id;
                            opt.textContent = sub.name;
                            sel2.appendChild(opt);
                        });
                    }
                    if (cat2) sel2.value = cat2;
                    await loadStyleImagesForItem(item.style_category_id, cat2, String(item.style_image_id));
                    document.getElementById('moduleItemStyleImageId').value = item.style_image_id;
                    const imgUrl = item.image_url || item.main_image || '';
                    if (imgUrl) {
                        document.getElementById('moduleItemImagePreview').innerHTML = `<img src="${imgUrl}" style="max-width: 100%; border-radius: 8px;" onerror="this.parentElement.innerHTML='<p class=\\'text-muted\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</p>'">`;
                    }
                }
            } else {
                // å¦‚æœæ²¡æœ‰äº§å“IDå’Œåˆ†ç±»IDï¼Œæ˜¾ç¤ºå·²æœ‰å›¾ç‰‡
                const imageUrl = item.image_url || item.main_image || '';
                if (imageUrl) {
                    document.getElementById('moduleItemImagePreview').innerHTML = `<img src="${imageUrl}" style="max-width: 100%; border-radius: 8px;" onerror="this.parentElement.innerHTML='<p class=\\'text-muted\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</p>'">`;
                }
            }
            
            handleItemLinkTypeChange();
            document.getElementById('moduleItemModalTitle').textContent = 'ç¼–è¾‘æ¨¡å—é¡¹';
            const hintEl = document.getElementById('moduleItemTitleHint');
            if (hintEl) {
                hintEl.style.display = (currentModuleTypeForItem === 'ip_collab' || currentModuleTypeForItem === 'works') ? 'block' : 'none';
            }
            new bootstrap.Modal(document.getElementById('moduleItemModal')).show();
        }

        // åˆ é™¤æ¨¡å—é¡¹
        function deleteModuleItem(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡å—é¡¹å—ï¼Ÿ')) return;
            moduleItems.splice(index, 1);
            renderModuleItems();
        }

        // ä¿å­˜æ¨¡å—é¡¹
        async function saveModuleItem() {
            const sourceType = document.getElementById('moduleItemSourceType').value;
            const title = document.getElementById('moduleItemTitle').value;
            const desc = document.getElementById('moduleItemDesc').value;
            const tag = document.getElementById('moduleItemTag').value;
            const linkType = document.getElementById('moduleItemLinkType').value;
            const linkValue = document.getElementById('moduleItemLinkValue').value;
            
            let item = {
                title: title,
                desc: desc,
                tag: tag,
                link_type: linkType !== 'none' ? linkType : undefined,
                link_value: linkType !== 'none' ? linkValue : undefined
            };
            
            if (sourceType === 'product') {
                const productId = document.getElementById('moduleItemProductIdValue').value;
                if (!productId) {
                    alert('è¯·é€‰æ‹©äº§å“');
                    return;
                }
                // ç¡®ä¿äº§å“åˆ—è¡¨å·²åŠ è½½
                if (allProducts.length === 0) {
                    await loadProductsForSelector(null, null);
                }
                const product = allProducts.find(p => p.id === parseInt(productId));
                if (!product) {
                    alert('äº§å“ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°é€‰æ‹©');
                    return;
                }
                item.product_id = parseInt(productId);
                item.product_name = product.name;
                // ä¿å­˜å›¾ç‰‡URLï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
                let imageUrl = product.image_url || '';
                if (imageUrl && imageUrl.startsWith('http')) {
                    const mediaMatch = imageUrl.match(/\/(media|static)\/(.+)$/);
                    if (mediaMatch) {
                        imageUrl = `/${mediaMatch[1]}/${mediaMatch[2]}`;
                    }
                }
                item.image_url = imageUrl;
            } else if (sourceType === 'category') {
                const cat1Id = document.getElementById('moduleItemCategory1')?.value;
                const cat2Id = document.getElementById('moduleItemCategory2')?.value;
                if (!cat1Id) {
                    alert('è¯·é€‰æ‹©ä¸€çº§åˆ†ç±»');
                    return;
                }
                if (productCategoriesTree.length === 0) {
                    await loadCategoriesForItem();
                }
                const cat1 = productCategoriesTree.find(c => c.id == cat1Id);
                if (!cat1) {
                    alert('åˆ†ç±»ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°é€‰æ‹©');
                    return;
                }
                let categoryName = cat1.name;
                let imageUrl = cat1.image_url || '';
                if (cat2Id && cat1.subcategories) {
                    const sub = cat1.subcategories.find(s => s.id == cat2Id);
                    if (sub) {
                        categoryName = sub.name;
                        imageUrl = sub.image_url || imageUrl;
                        item.subcategory_id = parseInt(cat2Id);
                    }
                }
                item.category_id = parseInt(cat1Id);
                item.category_name = categoryName;
                if (imageUrl && imageUrl.startsWith('http')) {
                    const mediaMatch = imageUrl.match(/\/(media|static)\/(.+)$/);
                    if (mediaMatch) {
                        imageUrl = `/${mediaMatch[1]}/${mediaMatch[2]}`;
                    }
                }
                item.image_url = imageUrl;
            } else if (sourceType === 'style') {
                const styleImageId = document.getElementById('moduleItemStyleImageId')?.value;
                if (!styleImageId) {
                    alert('è¯·é€‰æ‹©é£æ ¼å›¾ç‰‡');
                    return;
                }
                const cat1 = document.getElementById('moduleItemStyleCategory1')?.value;
                if (!cat1) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€çº§é£æ ¼åˆ†ç±»');
                    return;
                }
                try {
                    let imgUrl = '/api/admin/styles/images?per_page=100&category_id=' + cat1;
                    const cat2Val = document.getElementById('moduleItemStyleCategory2')?.value;
                    if (cat2Val) imgUrl += '&subcategory_id=' + cat2Val;
                    const imgRes = await fetch(imgUrl);
                    const imgData = await imgRes.json();
                    if (imgData.status !== 'success' || !imgData.data) {
                        alert('è·å–é£æ ¼å›¾ç‰‡å¤±è´¥');
                        return;
                    }
                    const styleImg = imgData.data.find(i => i.id == styleImageId);
                    if (!styleImg) {
                        alert('é£æ ¼å›¾ç‰‡ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°é€‰æ‹©');
                        return;
                    }
                    item.style_image_id = parseInt(styleImageId);
                    item.style_category_id = parseInt(cat1);
                    if (cat2Val) item.style_subcategory_id = parseInt(cat2Val);
                    item.category_name = styleImg.name;
                    let imageUrl = styleImg.image_url || '';
                    if (imageUrl && imageUrl.startsWith('http')) {
                        const mediaMatch = imageUrl.match(/\/(media|static)\/(.+)$/);
                        if (mediaMatch) {
                            imageUrl = `/${mediaMatch[1]}/${mediaMatch[2]}`;
                        }
                    }
                    item.image_url = imageUrl;
                } catch (e) {
                    console.error(e);
                    alert('ä¿å­˜é£æ ¼å›¾ç‰‡å¤±è´¥');
                    return;
                }
            } else if (sourceType === 'style_category') {
                const cat1Id = document.getElementById('moduleItemStyleCategoryDir1')?.value;
                const cat2Id = document.getElementById('moduleItemStyleCategoryDir2')?.value;
                if (!cat1Id) {
                    alert('è¯·é€‰æ‹©ä¸€çº§é£æ ¼åˆ†ç±»');
                    return;
                }
                if (styleCategoriesTree.length === 0) {
                    await loadStyleCategoriesForDir();
                }
                const cat1 = styleCategoriesTree.find(c => c.id == cat1Id);
                if (!cat1) {
                    alert('é£æ ¼åˆ†ç±»ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°é€‰æ‹©');
                    return;
                }
                let categoryName = cat1.name;
                if (cat2Id && cat1.subcategories) {
                    const sub = cat1.subcategories.find(s => s.id == cat2Id);
                    if (sub) categoryName = sub.name;
                }
                item.style_category_id = parseInt(cat1Id);
                item.style_subcategory_id = cat2Id ? parseInt(cat2Id) : undefined;
                item.category_name = categoryName;
                if (!item.title) item.title = categoryName;
            }
            
            if (currentEditingItemIndex >= 0) {
                // ç¼–è¾‘æ¨¡å¼
                moduleItems[currentEditingItemIndex] = item;
            } else {
                // æ·»åŠ æ¨¡å¼
                moduleItems.push(item);
            }
            
            renderModuleItems();
            moduleItemsDirty = true;
            bootstrap.Modal.getInstance(document.getElementById('moduleItemModal')).hide();
            if (currentMainCategory === 'modules' && currentSubSelection?.type === 'module') {
                updateDetailPanel();
            }
        }

        // å¤„ç†æ¨¡å—é¡¹å›¾ç‰‡æ¥æºç±»å‹åˆ‡æ¢
        function handleItemSourceTypeChange() {
            const sourceType = document.getElementById('moduleItemSourceType').value;
            const productContainer = document.getElementById('moduleItemProductContainer');
            const categoryContainer = document.getElementById('moduleItemCategoryContainer');
            const styleContainer = document.getElementById('moduleItemStyleContainer');
            const styleCategoryDirContainer = document.getElementById('moduleItemStyleCategoryDirContainer');
            
            [productContainer, categoryContainer, styleContainer, styleCategoryDirContainer].forEach(c => { if (c) c.style.display = 'none'; });
            if (sourceType === 'product') {
                if (productContainer) productContainer.style.display = 'block';
            } else if (sourceType === 'category') {
                if (categoryContainer) categoryContainer.style.display = 'block';
                loadCategoriesForItem();
            } else if (sourceType === 'style') {
                if (styleContainer) styleContainer.style.display = 'block';
                loadStyleCategoriesForItem();
            } else if (sourceType === 'style_category') {
                if (styleCategoryDirContainer) styleCategoryDirContainer.style.display = 'block';
                loadStyleCategoriesForDir();
            }
        }

        // å¤„ç†æ¨¡å—é¡¹è·³è½¬ç±»å‹åˆ‡æ¢
        function handleItemLinkTypeChange() {
            const linkType = document.getElementById('moduleItemLinkType').value;
            const container = document.getElementById('moduleItemLinkValueContainer');
            const hint = document.getElementById('moduleItemLinkHint');
            
            if (linkType === 'none') {
                if (container) container.style.display = 'none';
            } else {
                if (container) container.style.display = 'block';
                if (hint) {
                    const hints = {
                        'category': 'å¡«å†™åˆ†ç±»IDï¼ˆæ•°å­—ï¼‰',
                        'product': 'å¡«å†™äº§å“IDï¼ˆæ•°å­—ï¼‰',
                        'page': 'å¡«å†™é¡µé¢è·¯å¾„ï¼Œå¦‚ï¼š/pages/product/product',
                        'url': 'å¡«å†™å®Œæ•´URLï¼Œå¦‚ï¼šhttps://example.com'
                    };
                    hint.textContent = hints[linkType] || 'æ ¹æ®è·³è½¬ç±»å‹å¡«å†™';
                }
            }
        }

        // åŠ è½½äº§å“åˆ—è¡¨ï¼ˆç”¨äºæ¨¡å—é¡¹é€‰æ‹©å™¨ï¼Œæ”¯æŒåˆ†ç±»ç­›é€‰ï¼‰
        async function loadProductsForItemSelector(categoryId, subcategoryId) {
            try {
                let url = '/api/admin/homepage/products';
                const params = [];
                if (categoryId) params.push('category_id=' + categoryId);
                if (subcategoryId) params.push('subcategory_id=' + subcategoryId);
                if (params.length) url += '?' + params.join('&');
                const data = await fetchHomepageApi(url);
                if (data.status === 'success') {
                    allProducts = data.data || [];
                    renderItemProductSelector();
                }
            } catch (error) {
                console.error('åŠ è½½äº§å“åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // ä¸ºæ¨¡å—é¡¹æ‰“å¼€äº§å“é€‰æ‹©å™¨
        async function openProductSelectorForItem() {
            selectedItemProduct = null;
            document.getElementById('itemProductSelectorCategory1').value = '';
            document.getElementById('itemProductSelectorCategory2').innerHTML = '<option value="">å…¨éƒ¨</option>';
            await loadProductsForItemSelector(null, null);
            new bootstrap.Modal(document.getElementById('itemProductSelectorModal')).show();
        }

        // æ¸²æŸ“æ¨¡å—é¡¹äº§å“é€‰æ‹©å™¨
        function renderItemProductSelector() {
            const container = document.getElementById('itemProductSelectorList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!allProducts || allProducts.length === 0) {
                container.innerHTML = '<p class="text-muted">æš‚æ— äº§å“ï¼Œè¯·å…ˆæ·»åŠ äº§å“</p>';
                return;
            }
            
            allProducts.forEach(product => {
                const div = document.createElement('div');
                div.className = `product-selector-item ${selectedItemProduct && selectedItemProduct.id === product.id ? 'selected' : ''}`;
                div.innerHTML = `
                    <div class="product-selector-card" onclick="selectItemProduct(${product.id})">
                        <div class="product-selector-checkbox">
                            <input type="radio" name="itemProduct" ${selectedItemProduct && selectedItemProduct.id === product.id ? 'checked' : ''} onchange="selectItemProduct(${product.id})">
                        </div>
                        <div class="product-selector-image">
                            <img src="${product.image_url || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2NjYyIvPjx0ZXh0IHg9IjE1MCIgeT0iMjAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77liY88L3RleHQ+PC9zdmc+'}" alt="${product.name}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2NjYyIvPjx0ZXh0IHg9IjE1MCIgeT0iMjAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77liY88L3RleHQ+PC9zdmc+'">
                        </div>
                        <div class="product-selector-info">
                            <div class="product-selector-name">${product.name}</div>
                            <div class="product-selector-category">${[product.category_name, product.subcategory_name].filter(Boolean).join(' / ') || 'æœªåˆ†ç±»'}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // é€‰æ‹©æ¨¡å—é¡¹äº§å“
        function selectItemProduct(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                selectedItemProduct = product;
                renderItemProductSelector();
            }
        }

        // ç¡®è®¤æ¨¡å—é¡¹äº§å“é€‰æ‹©
        function confirmItemProductSelection() {
            if (!selectedItemProduct) {
                alert('è¯·é€‰æ‹©äº§å“');
                return;
            }
            
            document.getElementById('moduleItemProductIdValue').value = selectedItemProduct.id;
            document.getElementById('moduleItemProductId').value = selectedItemProduct.name;
            
            // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
            const imageUrl = selectedItemProduct.image_url || '';
            if (imageUrl) {
                document.getElementById('moduleItemImagePreview').innerHTML = `<img src="${imageUrl}" style="max-width: 100%; border-radius: 8px;" onerror="this.parentElement.innerHTML='<p class=\\'text-muted\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</p>'">`;
            }
            
            bootstrap.Modal.getInstance(document.getElementById('itemProductSelectorModal')).hide();
        }

        // åŠ è½½åˆ†ç±»åˆ—è¡¨ï¼ˆç”¨äºæ¨¡å—é¡¹ï¼Œä½¿ç”¨åˆ†ç±»æ ‘ï¼‰
        async function loadCategoriesForItem() {
            if (productCategoriesTree.length === 0) {
                await loadProductCategoriesTree();
            }
            renderCategoriesForItem();
        }

        // æ¸²æŸ“åˆ†ç±»ä¸‹æ‹‰åˆ—è¡¨ï¼ˆç”¨äºæ¨¡å—é¡¹ï¼Œä¸€çº§->äºŒçº§çº§è”ï¼‰
        function renderCategoriesForItem() {
            const sel1 = document.getElementById('moduleItemCategory1');
            const sel2 = document.getElementById('moduleItemCategory2');
            if (!sel1) return;
            
            sel1.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸€çº§åˆ†ç±»</option>';
            productCategoriesTree.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.textContent = cat.name;
                sel1.appendChild(opt);
            });
            sel2.innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
        }

        // æ¨¡å—é¡¹ä¸€çº§åˆ†ç±»å˜åŒ–
        function onModuleItemCategory1Change() {
            const sel1 = document.getElementById('moduleItemCategory1');
            const sel2 = document.getElementById('moduleItemCategory2');
            const cat1 = sel1?.value || '';
            sel2.innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
            document.getElementById('moduleItemCategoryId').value = '';
            if (cat1) {
                const cat = productCategoriesTree.find(c => c.id == cat1);
                if (cat && cat.subcategories && cat.subcategories.length) {
                    cat.subcategories.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub.id;
                        opt.textContent = sub.name;
                        sel2.appendChild(opt);
                    });
                }
                document.getElementById('moduleItemCategoryId').value = cat1;
                updateModuleItemCategoryPreview(cat1, '');
            } else {
                document.getElementById('moduleItemImagePreview').innerHTML = '<p class="text-muted">é€‰æ‹©åˆ†ç±»åæ˜¾ç¤ºå›¾ç‰‡</p>';
            }
        }

        // æ¨¡å—é¡¹äºŒçº§åˆ†ç±»å˜åŒ–
        function onModuleItemCategory2Change() {
            const sel1 = document.getElementById('moduleItemCategory1');
            const sel2 = document.getElementById('moduleItemCategory2');
            const cat1 = sel1?.value || '';
            const cat2 = sel2?.value || '';
            document.getElementById('moduleItemCategoryId').value = cat2 || cat1 || '';
            updateModuleItemCategoryPreview(cat1, cat2);
        }

        // æ›´æ–°æ¨¡å—é¡¹åˆ†ç±»å›¾ç‰‡é¢„è§ˆ
        function updateModuleItemCategoryPreview(cat1Id, cat2Id) {
            const preview = document.getElementById('moduleItemImagePreview');
            if (!preview) return;
            let imageUrl = '';
            let cat = productCategoriesTree.find(c => c.id == cat1Id);
            if (cat2Id && cat && cat.subcategories) {
                const sub = cat.subcategories.find(s => s.id == cat2Id);
                if (sub && sub.image_url) imageUrl = sub.image_url;
            }
            if (!imageUrl && cat && cat.image_url) imageUrl = cat.image_url;
            if (imageUrl) {
                preview.innerHTML = `<img src="${imageUrl}" style="max-width: 100%; border-radius: 8px;" onerror="this.parentElement.innerHTML='<p class=\\'text-muted\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</p>'">`;
            } else {
                preview.innerHTML = '<p class="text-muted">è¯¥åˆ†ç±»æš‚æ— å›¾ç‰‡</p>';
            }
        }

        // ========== é£æ ¼å›¾ç‰‡é€‰æ‹© ==========
        let styleCategoriesTree = [];

        async function loadStyleCategoriesForItem() {
            try {
                const response = await fetch('/api/admin/styles/categories');
                const data = await response.json();
                if (data.status === 'success') {
                    styleCategoriesTree = data.data || [];
                    const sel1 = document.getElementById('moduleItemStyleCategory1');
                    sel1.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸€çº§é£æ ¼åˆ†ç±»</option>';
                    styleCategoriesTree.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.name;
                        sel1.appendChild(opt);
                    });
                    document.getElementById('moduleItemStyleCategory2').innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§é£æ ¼åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
                    document.getElementById('moduleItemStyleImagesGrid').innerHTML = '<p class="text-muted small">é€‰æ‹©é£æ ¼åˆ†ç±»åæ˜¾ç¤ºé£æ ¼å›¾ç‰‡</p>';
                }
            } catch (error) {
                console.error('åŠ è½½é£æ ¼åˆ†ç±»å¤±è´¥:', error);
            }
        }

        function onModuleItemStyleCategory1Change() {
            const cat1 = document.getElementById('moduleItemStyleCategory1')?.value;
            const sel2 = document.getElementById('moduleItemStyleCategory2');
            sel2.innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§é£æ ¼åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
            document.getElementById('moduleItemStyleImageId').value = '';
            if (cat1) {
                const cat = styleCategoriesTree.find(c => c.id == cat1);
                if (cat && cat.subcategories && cat.subcategories.length) {
                    cat.subcategories.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub.id;
                        opt.textContent = sub.name;
                        sel2.appendChild(opt);
                    });
                }
                loadStyleImagesForItem(cat1, '');
            } else {
                document.getElementById('moduleItemStyleImagesGrid').innerHTML = '<p class="text-muted small">é€‰æ‹©é£æ ¼åˆ†ç±»åæ˜¾ç¤ºé£æ ¼å›¾ç‰‡</p>';
            }
        }

        function onModuleItemStyleCategory2Change() {
            const cat1 = document.getElementById('moduleItemStyleCategory1')?.value;
            const cat2 = document.getElementById('moduleItemStyleCategory2')?.value;
            document.getElementById('moduleItemStyleImageId').value = '';
            if (cat1) {
                loadStyleImagesForItem(cat1, cat2);
            }
        }

        async function loadStyleCategoriesForDir() {
            try {
                if (styleCategoriesTree.length === 0) {
                    const response = await fetch('/api/admin/styles/categories');
                    const data = await response.json();
                    if (data.status === 'success') styleCategoriesTree = data.data || [];
                }
                const sel1 = document.getElementById('moduleItemStyleCategoryDir1');
                if (sel1) {
                    sel1.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸€çº§é£æ ¼åˆ†ç±»</option>';
                    styleCategoriesTree.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.name;
                        sel1.appendChild(opt);
                    });
                }
                const sel2 = document.getElementById('moduleItemStyleCategoryDir2');
                if (sel2) sel2.innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§é£æ ¼åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
            } catch (e) { console.error('åŠ è½½é£æ ¼åˆ†ç±»ç›®å½•å¤±è´¥:', e); }
        }

        function onModuleItemStyleCategoryDir1Change() {
            const cat1 = document.getElementById('moduleItemStyleCategoryDir1')?.value;
            const sel2 = document.getElementById('moduleItemStyleCategoryDir2');
            sel2.innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§é£æ ¼åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
            if (cat1) {
                const cat = styleCategoriesTree.find(c => c.id == cat1);
                if (cat && cat.subcategories && cat.subcategories.length) {
                    cat.subcategories.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub.id;
                        opt.textContent = sub.name;
                        sel2.appendChild(opt);
                    });
                }
            }
        }

        function onModuleItemStyleCategoryDir2Change() {}

        async function loadStyleImagesForItem(categoryId, subcategoryId, preserveSelectedId) {
            const grid = document.getElementById('moduleItemStyleImagesGrid');
            grid.innerHTML = '<p class="text-muted small">åŠ è½½ä¸­...</p>';
            try {
                let url = '/api/admin/styles/images?per_page=100&category_id=' + categoryId;
                if (subcategoryId) url += '&subcategory_id=' + subcategoryId;
                const response = await fetch(url);
                const data = await response.json();
                if (data.status === 'success' && data.data && Array.isArray(data.data)) {
                    const images = data.data;
                    grid.innerHTML = '';
                    if (images.length === 0) {
                        grid.innerHTML = '<p class="text-muted small">è¯¥åˆ†ç±»ä¸‹æš‚æ— é£æ ¼å›¾ç‰‡</p>';
                        return;
                    }
                    const selectedId = preserveSelectedId || document.getElementById('moduleItemStyleImageId')?.value;
                    images.forEach(img => {
                        const div = document.createElement('div');
                        div.className = 'style-image-item border rounded p-1 ' + (selectedId == img.id ? 'border-primary' : '');
                        div.style.cssText = 'cursor:pointer;width:80px;height:80px;flex-shrink:0;';
                        div.innerHTML = `<img src="${img.image_url || ''}" alt="${img.name}" style="width:100%;height:100%;object-fit:cover;border-radius:4px;" onerror="this.parentElement.innerHTML='<span class=\\'small\\'>æ— å›¾</span>'">`;
                        div.onclick = () => {
                            document.querySelectorAll('.style-image-item').forEach(el => el.classList.remove('border-primary'));
                            div.classList.add('border-primary');
                            document.getElementById('moduleItemStyleImageId').value = img.id;
                            document.getElementById('moduleItemImagePreview').innerHTML = `<img src="${img.image_url || ''}" style="max-width:100%;border-radius:8px;" onerror="this.parentElement.innerHTML='<p class=\\'text-muted\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</p>'">`;
                        };
                        grid.appendChild(div);
                    });
                } else {
                    grid.innerHTML = '<p class="text-muted small">åŠ è½½å¤±è´¥</p>';
                }
            } catch (error) {
                console.error('åŠ è½½é£æ ¼å›¾ç‰‡å¤±è´¥:', error);
                grid.innerHTML = '<p class="text-muted small">åŠ è½½å¤±è´¥</p>';
            }
        }

        // é‡ç½®æ¨¡å—é¡¹è¡¨å•
        function resetModuleItemForm() {
            document.getElementById('moduleItemIndex').value = '';
            document.getElementById('moduleItemSourceType').value = 'product';
            document.getElementById('moduleItemProductId').value = '';
            document.getElementById('moduleItemProductIdValue').value = '';
            document.getElementById('moduleItemCategoryId').value = '';
            document.getElementById('moduleItemCategory1').value = '';
            document.getElementById('moduleItemCategory2').innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
            document.getElementById('moduleItemStyleCategory1').value = '';
            document.getElementById('moduleItemStyleCategory2').innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§é£æ ¼åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
            document.getElementById('moduleItemStyleCategoryDir1').value = '';
            document.getElementById('moduleItemStyleCategoryDir2').innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§é£æ ¼åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
            document.getElementById('moduleItemStyleImageId').value = '';
            document.getElementById('moduleItemStyleImagesGrid').innerHTML = '<p class="text-muted small">é€‰æ‹©é£æ ¼åˆ†ç±»åæ˜¾ç¤ºé£æ ¼å›¾ç‰‡</p>';
            document.getElementById('moduleItemTitle').value = '';
            document.getElementById('moduleItemDesc').value = '';
            document.getElementById('moduleItemTag').value = '';
            document.getElementById('moduleItemLinkType').value = 'none';
            document.getElementById('moduleItemLinkValue').value = '';
            document.getElementById('moduleItemImagePreview').innerHTML = '<p class="text-muted">é€‰æ‹©äº§å“æˆ–åˆ†ç±»åæ˜¾ç¤ºå›¾ç‰‡</p>';
            handleItemSourceTypeChange();
            handleItemLinkTypeChange();
        }

        // åˆå§‹åŒ–æ—¶åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', async function() {
            bindModalEvents();
            try {
                await Promise.all([
                    loadBanners(),
                    loadHomepageConfig(),
                    loadCategoryNavs(),
                    loadProductSections(),
                    loadProductCategories(),
                    loadProductCategoriesTree(),
                    loadProductsForSelector(null, null)
                ]);
            } catch (e) {
                console.error('é¦–é¡µé…ç½®æ•°æ®åŠ è½½å¤±è´¥:', e);
                alert('æ•°æ®åŠ è½½å¤±è´¥ã€‚è¯·ç¡®è®¤ï¼š\n1. æœåŠ¡å·²ç”¨ python test_server.py æˆ– python start.py å¯åŠ¨\n2. æ§åˆ¶å°æ˜¯å¦æœ‰ã€Œç®¡ç†åå°é¦–é¡µé…ç½®APIè“å›¾å·²æ³¨å†Œã€æç¤º');
            }
            populateProductSelectorCategoryFilters();
            updateSubCategoryList();
            updateDetailPanel();
        });
        
    </script>

    <!-- åˆ†ç±»å¯¼èˆªç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="categoryNavModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryNavModalTitle">æ·»åŠ åˆ†ç±»å¯¼èˆª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryNavForm">
                        <input type="hidden" id="categoryNavId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">åç§° *</label>
                                    <input type="text" class="form-control" id="categoryNavName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">å›¾æ ‡ï¼ˆEmojiï¼‰</label>
                                    <input type="text" class="form-control" id="categoryNavIcon" placeholder="å¦‚ï¼šğŸ“¦">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">å›¾æ ‡å›¾ç‰‡è·¯å¾„</label>
                                    <input type="text" class="form-control" id="categoryNavImageUrl" placeholder="ç›¸å¯¹è·¯å¾„ï¼Œå¦‚ï¼š/media/original/xxx.jpg" readonly>
                                    <small class="text-muted">å›¾ç‰‡è·¯å¾„å°†åœ¨ä¸Šä¼ åè‡ªåŠ¨å¡«å……ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">é“¾æ¥ç±»å‹</label>
                                    <select class="form-control" id="categoryNavLinkType" onchange="updateLinkValueInput()">
                                        <option value="category">äº§å“åˆ†ç±»</option>
                                        <option value="page">å°ç¨‹åºé¡µé¢</option>
                                        <option value="url">å¤–éƒ¨é“¾æ¥</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="categoryNavLinkValueContainer">
                                    <label class="form-label">é“¾æ¥å€¼</label>
                                    <!-- åˆ†ç±»é€‰æ‹©ä¸‹æ‹‰ -->
                                    <select class="form-control" id="categoryNavCategorySelect" style="display: none;" onchange="handleCategorySelectChange(this.value)">
                                        <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                                    </select>
                                    <!-- é¡µé¢è·¯å¾„é€‰æ‹©ä¸‹æ‹‰ -->
                                    <select class="form-control" id="categoryNavPageSelect" style="display: none;" onchange="document.getElementById('categoryNavLinkValue').value = this.value;">
                                        <option value="">è¯·é€‰æ‹©é¡µé¢</option>
                                        <option value="/pages/product/product">äº§å“é¦†</option>
                                        <option value="/pages/style/style">é£æ ¼åº“</option>
                                        <option value="/pages/orders/orders">è®¢å•åˆ—è¡¨</option>
                                        <option value="/pages/mine/mine">æˆ‘çš„</option>
                                    </select>
                                    <!-- æ–‡æœ¬è¾“å…¥ï¼ˆç”¨äºå¤–éƒ¨é“¾æ¥ï¼‰ -->
                                    <input type="text" class="form-control" id="categoryNavLinkValue" placeholder="åˆ†ç±»IDã€é¡µé¢è·¯å¾„æˆ–URL" style="display: none;">
                                    <small class="text-muted" id="categoryNavLinkHint">
                                        <span id="categoryNavLinkHintText">é€‰æ‹©é“¾æ¥ç±»å‹åæ˜¾ç¤ºå¯¹åº”è¾“å…¥æ–¹å¼</span>
                                    </small>
                                </div>
                                <input type="hidden" id="categoryNavCategoryId">
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">å›¾æ ‡å›¾ç‰‡</label>
                                    <div class="upload-area" onclick="document.getElementById('categoryNavFile').click()">
                                        <div id="categoryNavUploadArea">
                                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                            <p>ç‚¹å‡»ä¸Šä¼ å›¾æ ‡</p>
                                            <small class="text-muted">å»ºè®®å°ºå¯¸ï¼š80x80px</small>
                                        </div>
                                        <img id="categoryNavPreview" class="preview-image" style="display: none;">
                                    </div>
                                    <input type="file" id="categoryNavFile" accept="image/*" style="display: none;" onchange="uploadCategoryNavImage(this)">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æ’åº</label>
                                    <input type="number" class="form-control" id="categoryNavSortOrder" value="0">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="categoryNavIsActive" checked>
                                        <label class="form-check-label" for="categoryNavIsActive">å¯ç”¨</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveCategoryNav()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- äº§å“æ¨èæ¨¡å—ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="productSectionModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productSectionModalTitle">æ·»åŠ äº§å“æ¨èæ¨¡å—</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productSectionForm">
                        <input type="hidden" id="productSectionId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">æ¨¡å—ç±»å‹ *</label>
                                    <input type="text" class="form-control" id="productSectionType" readonly>
                                    <small class="text-muted">æ¨¡å—ç±»å‹ç”±å‰ç«¯å›ºå®šï¼Œä¸å¯ä¿®æ”¹</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æ¨¡å—æ ‡é¢˜</label>
                                    <input type="text" class="form-control" id="productSectionTitle" readonly>
                                    <small class="text-muted">æ¨¡å—æ ‡é¢˜ç”±å‰ç«¯å›ºå®šï¼Œä¸å¯ä¿®æ”¹</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">å‰¯æ ‡é¢˜</label>
                                    <input type="text" class="form-control" id="productSectionSubtitle">
                                </div>
                                <!-- æ¨¡å—é…ç½®åŒºåŸŸï¼ˆæ ¹æ®æ¨¡å—ç±»å‹åŠ¨æ€æ˜¾ç¤ºï¼‰ -->
                                <div id="moduleConfigArea">
                                    <!-- å½“å­£ä¸»æ¨ã€æ—¶å…‰æ—…ç¨‹ã€IPè”åã€ä½œå“å±•ç¤ºç­‰æ¨¡å—çš„é…ç½® -->
                                    <div id="itemBasedConfig" style="display: none;">
                                        <div class="mb-3">
                                            <label class="form-label">æ¨¡å—é¡¹é…ç½®</label>
                                            <div id="moduleItemsList" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                                                <!-- æ¨¡å—é¡¹åˆ—è¡¨ -->
                                            </div>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addModuleItem()">
                                                <i class="fas fa-plus"></i> æ·»åŠ é¡¹
                                            </button>
                                            <small class="text-muted d-block mt-2">ç‚¹å‡»"æ·»åŠ é¡¹"æŒ‰é’®ï¼Œä»äº§å“åº“æˆ–åˆ†ç±»åº“é€‰æ‹©å›¾ç‰‡</small>
                                        </div>
                                    </div>
                                    
                                    <!-- ä¼ ç»Ÿäº§å“æ¨èæ¨¡å—çš„é…ç½® -->
                                    <div id="productBasedConfig">
                                        <div class="mb-3">
                                            <label class="form-label">å¸ƒå±€ç±»å‹</label>
                                            <select class="form-control" id="productSectionLayout">
                                                <option value="grid">ç½‘æ ¼</option>
                                                <option value="list">åˆ—è¡¨</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">äº§å“åˆ—è¡¨</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="productSectionProductIds" placeholder="å¦‚ï¼š1,2,3" readonly>
                                                <button type="button" class="btn btn-outline-primary" onclick="openProductSelector()">
                                                    <i class="fas fa-th"></i> é€‰æ‹©äº§å“
                                                </button>
                                            </div>
                                            <small class="text-muted">ç‚¹å‡»"é€‰æ‹©äº§å“"æŒ‰é’®å¯è§†åŒ–é€‰æ‹©ï¼Œæˆ–ç•™ç©ºåˆ™æŒ‰åˆ†ç±»ç­›é€‰</small>
                                            <div id="selectedProductsPreview" class="mt-2" style="display: none;">
                                                <small class="text-muted">å·²é€‰æ‹© <span id="selectedProductsCount">0</span> ä¸ªäº§å“</small>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">åˆ†ç±»IDï¼ˆå¯é€‰ï¼‰</label>
                                            <input type="number" class="form-control" id="productSectionCategoryId">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!-- ä¼ ç»Ÿäº§å“æ¨èæ¨¡å—çš„é…ç½®ï¼ˆä»…å½“æ¨¡å—ç±»å‹ä¸æ˜¯åŸºäºé¡¹çš„ç±»å‹æ—¶æ˜¾ç¤ºï¼‰ -->
                                <div id="productBasedConfigRight" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label">æ˜¾ç¤ºæ•°é‡é™åˆ¶</label>
                                        <input type="number" class="form-control" id="productSectionLimit" value="6">
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="productSectionShowMore" checked>
                                            <label class="form-check-label" for="productSectionShowMore">æ˜¾ç¤º"æ›´å¤š"æŒ‰é’®</label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">"æ›´å¤š"æŒ‰é’®é“¾æ¥</label>
                                        <input type="text" class="form-control" id="productSectionMoreLink" placeholder="å¦‚ï¼š/pages/product/product">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æ’åº</label>
                                    <input type="number" class="form-control" id="productSectionSortOrder" value="0">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="productSectionIsActive" checked>
                                        <label class="form-check-label" for="productSectionIsActive">å¯ç”¨</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveProductSection()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- äº§å“é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
    <div class="modal fade" id="productSelectorModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">é€‰æ‹©äº§å“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3 align-items-end">
                        <div class="col-auto">
                            <label class="form-label small mb-1">ä¸€çº§åˆ†ç±»</label>
                            <select class="form-control form-control-sm" id="productSelectorCategory1" style="min-width: 120px;" onchange="onProductSelectorCategoryChange()">
                                <option value="">å…¨éƒ¨</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <label class="form-label small mb-1">äºŒçº§åˆ†ç±»</label>
                            <select class="form-control form-control-sm" id="productSelectorCategory2" style="min-width: 120px;" onchange="onProductSelectorCategoryChange()">
                                <option value="">å…¨éƒ¨</option>
                            </select>
                        </div>
                        <div class="col">
                            <small class="text-muted">å·²é€‰æ‹© <span id="productSelectorCount">0</span> ä¸ªäº§å“</small>
                        </div>
                    </div>
                    <div id="productSelectorList" class="product-selector-list">
                        <!-- äº§å“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmProductSelection()">ç¡®è®¤é€‰æ‹©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡å—é¡¹é…ç½®æ¨¡æ€æ¡†ï¼ˆç”¨äºå½“å­£ä¸»æ¨ã€æ—¶å…‰æ—…ç¨‹ã€IPè”åã€ä½œå“å±•ç¤ºç­‰ï¼‰ -->
    <div class="modal fade" id="moduleItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="moduleItemModalTitle">æ·»åŠ æ¨¡å—é¡¹</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="moduleItemForm">
                        <input type="hidden" id="moduleItemIndex">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">å›¾ç‰‡æ¥æº *</label>
                                    <select class="form-control" id="moduleItemSourceType" required onchange="handleItemSourceTypeChange()">
                                        <option value="product">äº§å“å›¾ç‰‡</option>
                                        <option value="category">åˆ†ç±»ç›®å½•</option>
                                        <option value="style">é£æ ¼å›¾ç‰‡</option>
                                        <option value="style_category">é£æ ¼åˆ†ç±»ç›®å½•</option>
                                    </select>
                                    <small class="text-muted">IPè”åï¼šé€‰ã€Œåˆ†ç±»ç›®å½•ã€æˆ–ã€Œé£æ ¼åˆ†ç±»ç›®å½•ã€åˆ™æŒ‰è¯¥åˆ†ç±»ä¸‹å…¨éƒ¨å›¾ç‰‡è½®æ’­ï¼›å…¶ä»–æ¨¡å—ç”¨å•å¼ </small>
                                </div>
                                <div class="mb-3" id="moduleItemProductContainer" style="display: none;">
                                    <label class="form-label">é€‰æ‹©äº§å“ *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="moduleItemProductId" placeholder="è¯·é€‰æ‹©äº§å“" readonly>
                                        <button type="button" class="btn btn-outline-primary" onclick="openProductSelectorForItem()">
                                            <i class="fas fa-th"></i> é€‰æ‹©äº§å“
                                        </button>
                                    </div>
                                    <input type="hidden" id="moduleItemProductIdValue">
                                </div>
                                <div class="mb-3" id="moduleItemCategoryContainer" style="display: none;">
                                    <label class="form-label">é€‰æ‹©åˆ†ç±» *</label>
                                    <div class="row g-2">
                                        <div class="col">
                                            <select class="form-control" id="moduleItemCategory1" onchange="onModuleItemCategory1Change()">
                                                <option value="">è¯·é€‰æ‹©ä¸€çº§åˆ†ç±»</option>
                                            </select>
                                        </div>
                                        <div class="col">
                                            <select class="form-control" id="moduleItemCategory2" onchange="onModuleItemCategory2Change()">
                                                <option value="">è¯·é€‰æ‹©äºŒçº§åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>
                                            </select>
                                        </div>
                                    </div>
                                    <input type="hidden" id="moduleItemCategoryId">
                                    <small class="text-muted">IPè”åï¼šé€‰è¯¥åˆ†ç±»åï¼Œå°†è½®æ’­è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰äº§å“å›¾ç‰‡ï¼›å…¶ä»–æ¨¡å—ç”¨åˆ†ç±»å°é¢å›¾</small>
                                </div>
                                <div class="mb-3" id="moduleItemStyleCategoryDirContainer" style="display: none;">
                                    <label class="form-label">é€‰æ‹©é£æ ¼åˆ†ç±»ç›®å½• *</label>
                                    <div class="row g-2">
                                        <div class="col">
                                            <select class="form-control" id="moduleItemStyleCategoryDir1" onchange="onModuleItemStyleCategoryDir1Change()">
                                                <option value="">è¯·é€‰æ‹©ä¸€çº§é£æ ¼åˆ†ç±»</option>
                                            </select>
                                        </div>
                                        <div class="col">
                                            <select class="form-control" id="moduleItemStyleCategoryDir2" onchange="onModuleItemStyleCategoryDir2Change()">
                                                <option value="">è¯·é€‰æ‹©äºŒçº§é£æ ¼åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>
                                            </select>
                                        </div>
                                    </div>
                                    <small class="text-muted">IPè”åä¸“æœ‰ï¼šé€‰è¯¥åˆ†ç±»åï¼Œå°†è½®æ’­è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰é£æ ¼å›¾ç‰‡</small>
                                </div>
                                <div class="mb-3" id="moduleItemStyleContainer" style="display: none;">
                                    <label class="form-label">é€‰æ‹©é£æ ¼ *</label>
                                    <div class="row g-2 mb-2">
                                        <div class="col">
                                            <select class="form-control" id="moduleItemStyleCategory1" onchange="onModuleItemStyleCategory1Change()">
                                                <option value="">è¯·é€‰æ‹©ä¸€çº§é£æ ¼åˆ†ç±»</option>
                                            </select>
                                        </div>
                                        <div class="col">
                                            <select class="form-control" id="moduleItemStyleCategory2" onchange="onModuleItemStyleCategory2Change()">
                                                <option value="">è¯·é€‰æ‹©äºŒçº§é£æ ¼åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="moduleItemStyleImagesGrid" class="d-flex flex-wrap gap-2" style="max-height: 200px; overflow-y: auto;">
                                        <p class="text-muted small">é€‰æ‹©é£æ ¼åˆ†ç±»åæ˜¾ç¤ºé£æ ¼å›¾ç‰‡</p>
                                    </div>
                                    <input type="hidden" id="moduleItemStyleImageId">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æ ‡é¢˜</label>
                                    <input type="text" class="form-control" id="moduleItemTitle" placeholder="å¦‚ï¼šäº§å“æ ‡é¢˜">
                                    <small class="text-muted" id="moduleItemTitleHint" style="display:none;">IPè”å/ä½œå“å±•ç¤ºæ—¶ï¼Œæ­¤å¤„å¡«å†™äºŒçº§åˆ†ç±»åç§°ï¼ˆå¦‚ï¼šè¿ªå£«å°¼ã€æ¼«å¨ï¼‰ï¼Œå°†æ˜¾ç¤ºåœ¨å°ç¨‹åºå­åˆ†ç±»æ ‡ç­¾æ </small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æè¿°</label>
                                    <input type="text" class="form-control" id="moduleItemDesc" placeholder="å¦‚ï¼šäº§å“æè¿°">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æ ‡ç­¾</label>
                                    <input type="text" class="form-control" id="moduleItemTag" placeholder="å¦‚ï¼šæ–°å¹´é™å®š">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">å›¾ç‰‡é¢„è§ˆ</label>
                                    <div id="moduleItemImagePreview" style="min-height: 200px; border: 2px dashed rgba(255,255,255,0.3); border-radius: 8px; padding: 20px; text-align: center;">
                                        <p class="text-muted">é€‰æ‹©äº§å“æˆ–åˆ†ç±»åæ˜¾ç¤ºå›¾ç‰‡</p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">è·³è½¬ç±»å‹</label>
                                    <select class="form-control" id="moduleItemLinkType" onchange="handleItemLinkTypeChange()">
                                        <option value="none">æ— è·³è½¬</option>
                                        <option value="category">è·³è½¬åˆ°åˆ†ç±»</option>
                                        <option value="product">è·³è½¬åˆ°äº§å“</option>
                                        <option value="page">è·³è½¬åˆ°é¡µé¢</option>
                                        <option value="url">å¤–éƒ¨é“¾æ¥</option>
                                    </select>
                                </div>
                                <div class="mb-3" id="moduleItemLinkValueContainer" style="display: none;">
                                    <label class="form-label">è·³è½¬å€¼</label>
                                    <input type="text" class="form-control" id="moduleItemLinkValue" placeholder="æ ¹æ®è·³è½¬ç±»å‹å¡«å†™">
                                    <small class="text-muted" id="moduleItemLinkHint">é€‰æ‹©è·³è½¬ç±»å‹åæ˜¾ç¤ºæç¤º</small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveModuleItem()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- äº§å“/åˆ†ç±»é€‰æ‹©å™¨æ¨¡æ€æ¡†ï¼ˆç”¨äºæ¨¡å—é¡¹ï¼‰ -->
    <div class="modal fade" id="itemProductSelectorModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">é€‰æ‹©äº§å“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3 align-items-end">
                        <div class="col-auto">
                            <label class="form-label small mb-1">ä¸€çº§åˆ†ç±»</label>
                            <select class="form-control form-control-sm" id="itemProductSelectorCategory1" style="min-width: 120px;" onchange="onItemProductSelectorCategoryChange()">
                                <option value="">å…¨éƒ¨</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <label class="form-label small mb-1">äºŒçº§åˆ†ç±»</label>
                            <select class="form-control form-control-sm" id="itemProductSelectorCategory2" style="min-width: 120px;" onchange="onItemProductSelectorCategoryChange()">
                                <option value="">å…¨éƒ¨</option>
                            </select>
                        </div>
                    </div>
                    <div id="itemProductSelectorList" class="product-selector-list">
                        <!-- äº§å“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmItemProductSelection()">ç¡®è®¤é€‰æ‹©</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>


