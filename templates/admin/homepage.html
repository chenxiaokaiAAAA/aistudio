<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–é¡µé…ç½®ç®¡ç† - {{ brand_name }}åå°</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .navbar-custom {
            background: #0a0a0a !important;
            border-bottom: 1px solid #1a1a1a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .navbar-brand, .nav-link {
            color: #e0e0e0 !important;
        }
        .nav-link:hover {
            color: #ffffff !important;
        }
        .nav-link.active {
            color: #ffffff !important;
            font-weight: 600;
        }
        
        .main-content {
            margin-top: 100px;
            padding: 20px;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
        }
        
        .card-header {
            background: rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px 15px 0 0 !important;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #ff5252, #26a69a);
        }
        
        .form-control {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
        }
        
        .form-control:focus {
            background: rgba(255,255,255,0.15);
            border-color: #4ecdc4;
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(78, 205, 196, 0.25);
        }
        
        .form-control::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .modal-header {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .modal-footer {
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .close {
            color: white;
            opacity: 0.8;
        }
        
        .close:hover {
            color: #ff6b6b;
            opacity: 1;
        }
        
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }
        
        .upload-area.dragover {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.2);
        }
        
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .banner-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .banner-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .sortable-handle {
            cursor: move;
            color: #4ecdc4;
        }
        
        .sortable-handle:hover {
            color: #ff6b6b;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    {% include 'admin/_navbar.html' %}

    <div class="main-content">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0">ğŸ  é¦–é¡µé…ç½®ç®¡ç†</h4>
                            <p class="mb-0 text-muted">ç®¡ç†é¦–é¡µè½®æ’­å›¾å’Œç›¸å…³é…ç½®ï¼Œå°ç¨‹åºå’Œç½‘é¡µç‰ˆå°†åŒæ­¥æ›´æ–°</p>
                        </div>
                        <div class="card-body">
                            <!-- è½®æ’­å›¾ç®¡ç† -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5>è½®æ’­å›¾ç®¡ç†</h5>
                                    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#bannerModal">
                                        + æ·»åŠ è½®æ’­å›¾
                                    </button>
                                    <div id="bannerList">
                                        <!-- è½®æ’­å›¾åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å…¶ä»–é…ç½® -->
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>é¦–é¡µé…ç½®</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="homepageTitle" class="form-label">é¦–é¡µæ ‡é¢˜</label>
                                                <input type="text" class="form-control" id="homepageTitle" placeholder="å¦‚ï¼š{{ brand_name }} - ä¸“å±å®šåˆ¶">
                                            </div>
                                            <div class="mb-3">
                                                <label for="homepageSubtitle" class="form-label">é¦–é¡µå‰¯æ ‡é¢˜</label>
                                                <input type="text" class="form-control" id="homepageSubtitle" placeholder="å¦‚ï¼šä¸ºæ‚¨çš„å® ç‰©æ‰“é€ ä¸“å±è‰ºæœ¯å“">
                                            </div>
                                            <div class="mb-3">
                                                <label for="homepageDescription" class="form-label">é¦–é¡µæè¿°</label>
                                                <textarea class="form-control" id="homepageDescription" rows="3" placeholder="é¦–é¡µæè¿°æ–‡å­—"></textarea>
                                            </div>
                                            <button class="btn btn-primary" onclick="saveHomepageConfig()">ä¿å­˜é…ç½®</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h5>åŠŸèƒ½é…ç½®</h5>
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="enableCustomOrder">
                                                    <label class="form-check-label" for="enableCustomOrder">
                                                        å¯ç”¨å®šåˆ¶åŠŸèƒ½
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="enableStyleLibrary">
                                                    <label class="form-check-label" for="enableStyleLibrary">
                                                        å¯ç”¨é£æ ¼åº“
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="enableProductGallery">
                                                    <label class="form-check-label" for="enableProductGallery">
                                                        å¯ç”¨äº§å“é¦†
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="enableWorksGallery">
                                                    <label class="form-check-label" for="enableWorksGallery">
                                                        å¯ç”¨ä½œå“å±•ç¤º
                                                    </label>
                                                </div>
                                            </div>
                                            <button class="btn btn-primary" onclick="saveFeatureConfig()">ä¿å­˜é…ç½®</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è½®æ’­å›¾ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="bannerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bannerModalTitle">æ·»åŠ è½®æ’­å›¾</h5>
                    <button type="button" class="close" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="bannerForm">
                        <input type="hidden" id="bannerId" name="id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="bannerTitle" class="form-label">æ ‡é¢˜</label>
                                    <input type="text" class="form-control" id="bannerTitle" name="title" placeholder="å¦‚ï¼šæ–°å“ä¸Šå¸‚">
                                </div>
                                <div class="mb-3">
                                    <label for="bannerSubtitle" class="form-label">å‰¯æ ‡é¢˜</label>
                                    <input type="text" class="form-control" id="bannerSubtitle" name="subtitle" placeholder="å¦‚ï¼šé™æ—¶ä¼˜æƒ ">
                                </div>
                                <div class="mb-3">
                                    <label for="bannerLink" class="form-label">é“¾æ¥åœ°å€</label>
                                    <input type="text" class="form-control" id="bannerLink" name="link" placeholder="å¦‚ï¼š/pages/product/product">
                                </div>
                                <div class="mb-3">
                                    <label for="bannerSortOrder" class="form-label">æ’åº</label>
                                    <input type="number" class="form-control" id="bannerSortOrder" name="sort_order" value="0">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bannerIsActive" name="is_active" checked>
                                        <label class="form-check-label" for="bannerIsActive">
                                            å¯ç”¨
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="bannerUpload" class="form-label">è½®æ’­å›¾ç‰‡</label>
                                    <div class="upload-area" onclick="document.getElementById('bannerFile').click()">
                                        <div id="bannerUploadArea">
                                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                            <p>ç‚¹å‡»ä¸Šä¼ è½®æ’­å›¾ç‰‡</p>
                                            <small class="text-muted">å»ºè®®å°ºå¯¸ï¼š750x400px</small>
                                        </div>
                                        <img id="bannerPreview" class="preview-image" style="display: none;">
                                    </div>
                                    <input type="file" id="bannerFile" accept="image/*" style="display: none;" onchange="uploadBannerImage(this)">
                                    <input type="hidden" id="bannerImageUrl" name="image_url">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveBanner()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let banners = [];
        let homepageConfig = {};

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadBanners();
            loadHomepageConfig();
        });

        // åŠ è½½è½®æ’­å›¾æ•°æ®
        async function loadBanners() {
            try {
                const response = await fetch('/api/admin/homepage/banners');
                const data = await response.json();
                if (data.status === 'success') {
                    banners = data.data;
                    renderBanners();
                }
            } catch (error) {
                console.error('åŠ è½½è½®æ’­å›¾å¤±è´¥:', error);
            }
        }

        // åŠ è½½é¦–é¡µé…ç½®
        async function loadHomepageConfig() {
            try {
                const response = await fetch('/api/admin/homepage/config');
                const data = await response.json();
                if (data.status === 'success') {
                    homepageConfig = data.data;
                    updateHomepageConfigForm();
                }
            } catch (error) {
                console.error('åŠ è½½é¦–é¡µé…ç½®å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“è½®æ’­å›¾åˆ—è¡¨
        function renderBanners() {
            const container = document.getElementById('bannerList');
            container.innerHTML = '';
            
            banners.forEach(banner => {
                const div = document.createElement('div');
                div.className = 'banner-item';
                div.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-1">
                            <i class="fas fa-grip-vertical sortable-handle"></i>
                        </div>
                        <div class="col-md-3">
                            <img src="${banner.image_url}" class="banner-preview" alt="${banner.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjEyMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjEyMCIgZmlsbD0iI2NjYyIvPjx0ZXh0IHg9IjE1MCIgeT0iNjAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvuWJjzwvdGV4dD48L3N2Zz4='">
                        </div>
                        <div class="col-md-5">
                            <h6 class="mb-1">${banner.title || 'æ— æ ‡é¢˜'}</h6>
                            <small class="text-muted">${banner.subtitle || ''}</small>
                            <br>
                            <small class="text-info">é“¾æ¥: ${banner.link || 'æ— '}</small>
                        </div>
                        <div class="col-md-3 text-end">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editBanner(${banner.id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBanner(${banner.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // æ›´æ–°é¦–é¡µé…ç½®è¡¨å•
        function updateHomepageConfigForm() {
            document.getElementById('homepageTitle').value = homepageConfig.title || '';
            document.getElementById('homepageSubtitle').value = homepageConfig.subtitle || '';
            document.getElementById('homepageDescription').value = homepageConfig.description || '';
            document.getElementById('enableCustomOrder').checked = homepageConfig.enable_custom_order || false;
            document.getElementById('enableStyleLibrary').checked = homepageConfig.enable_style_library || false;
            document.getElementById('enableProductGallery').checked = homepageConfig.enable_product_gallery || false;
            document.getElementById('enableWorksGallery').checked = homepageConfig.enable_works_gallery || false;
        }

        // ä¸Šä¼ è½®æ’­å›¾ç‰‡
        async function uploadBannerImage(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/admin/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                // æ£€æŸ¥HTTPçŠ¶æ€ç 
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('ä¸Šä¼ ç»“æœ:', result);
                
                // å…¼å®¹ä¸¤ç§è¿”å›æ ¼å¼ï¼šstatus === 'success' æˆ– success === true
                // ä¼˜å…ˆä½¿ç”¨ image_urlï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ url
                const imageUrl = result.image_url || result.url;
                
                if ((result.status === 'success' || result.success === true) && imageUrl) {
                    // ä¸Šä¼ æˆåŠŸ
                    document.getElementById('bannerImageUrl').value = imageUrl;
                    document.getElementById('bannerPreview').src = imageUrl;
                    document.getElementById('bannerPreview').style.display = 'block';
                    document.getElementById('bannerUploadArea').style.display = 'none';
                    console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', imageUrl);
                    // ä¸æ˜¾ç¤ºalertï¼Œé¿å…å¹²æ‰°ç”¨æˆ·æ“ä½œï¼Œå›¾ç‰‡é¢„è§ˆå·²è¶³å¤Ÿè¯´æ˜æˆåŠŸ
                } else {
                    // ä¸Šä¼ å¤±è´¥
                    const errorMsg = result.message || 'æœªçŸ¥é”™è¯¯';
                    console.error('ä¸Šä¼ å¤±è´¥:', errorMsg, result);
                    alert('ä¸Šä¼ å¤±è´¥: ' + errorMsg);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥: ' + (error.message || 'è¯·é‡è¯•'));
            }
        }

        // ç¼–è¾‘è½®æ’­å›¾
        function editBanner(id) {
            const banner = banners.find(b => b.id === id);
            if (banner) {
                document.getElementById('bannerModalTitle').textContent = 'ç¼–è¾‘è½®æ’­å›¾';
                document.getElementById('bannerId').value = banner.id;
                document.getElementById('bannerTitle').value = banner.title || '';
                document.getElementById('bannerSubtitle').value = banner.subtitle || '';
                document.getElementById('bannerLink').value = banner.link || '';
                document.getElementById('bannerImageUrl').value = banner.image_url || '';
                document.getElementById('bannerSortOrder').value = banner.sort_order || 0;
                document.getElementById('bannerIsActive').checked = banner.is_active;
                
                // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                if (banner.image_url) {
                    document.getElementById('bannerPreview').src = banner.image_url;
                    document.getElementById('bannerPreview').style.display = 'block';
                    document.getElementById('bannerUploadArea').style.display = 'none';
                } else {
                    document.getElementById('bannerPreview').style.display = 'none';
                    document.getElementById('bannerUploadArea').style.display = 'block';
                }
                
                const modal = new bootstrap.Modal(document.getElementById('bannerModal'));
                modal.show();
            }
        }

        // ä¿å­˜è½®æ’­å›¾
        async function saveBanner() {
            const form = document.getElementById('bannerForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // å¤„ç†å¤é€‰æ¡†
            data.is_active = document.getElementById('bannerIsActive').checked;
            
            try {
                const url = data.id ? `/api/admin/homepage/banners/${data.id}` : '/api/admin/homepage/banners';
                const method = data.id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('bannerModal')).hide();
                    loadBanners();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜è½®æ’­å›¾å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆ é™¤è½®æ’­å›¾
        async function deleteBanner(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè½®æ’­å›¾å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`/api/admin/homepage/banners/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        loadBanners();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + result.message);
                    }
                } catch (error) {
                    console.error('åˆ é™¤è½®æ’­å›¾å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }

        // ä¿å­˜é¦–é¡µé…ç½®
        async function saveHomepageConfig() {
            const data = {
                title: document.getElementById('homepageTitle').value,
                subtitle: document.getElementById('homepageSubtitle').value,
                description: document.getElementById('homepageDescription').value
            };
            
            try {
                const response = await fetch('/api/admin/homepage/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    alert('ä¿å­˜æˆåŠŸ');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜é¦–é¡µé…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ä¿å­˜åŠŸèƒ½é…ç½®
        async function saveFeatureConfig() {
            const data = {
                enable_custom_order: document.getElementById('enableCustomOrder').checked,
                enable_style_library: document.getElementById('enableStyleLibrary').checked,
                enable_product_gallery: document.getElementById('enableProductGallery').checked,
                enable_works_gallery: document.getElementById('enableWorksGallery').checked
            };
            
            try {
                const response = await fetch('/api/admin/homepage/features', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    alert('ä¿å­˜æˆåŠŸ');
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜åŠŸèƒ½é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é‡ç½®è¡¨å•
        document.getElementById('bannerModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('bannerForm').reset();
            document.getElementById('bannerModalTitle').textContent = 'æ·»åŠ è½®æ’­å›¾';
            document.getElementById('bannerPreview').style.display = 'none';
            document.getElementById('bannerUploadArea').style.display = 'block';
        });
    </script>
</body>
</html>


