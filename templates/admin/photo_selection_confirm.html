<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡®è®¤è®¢å•ä¿¡æ¯ - {{ brand_name }}åå°</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            background: #fff;
            border-radius: 12px;
            padding: 32px 24px;
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .page-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        .image-list-container {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            margin-bottom: 20px;
        }
        .image-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 16px;
            align-items: flex-start;
            flex-shrink: 0;
        }
        .image-preview {
            display: none; /* éšè—å·¦ä¾§å¤§å›¾é¢„è§ˆï¼Œå› ä¸ºäº§å“å¡ç‰‡å·²æ˜¾ç¤ºç…§ç‰‡ */
        }
        .image-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .product-list {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 12px;
        }
        .product-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            min-width: 180px;
            max-width: 220px;
            flex: 0 0 auto;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .product-item-image {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 4px;
            background: #f8f9fa;
            margin-bottom: 4px;
        }
        .product-name {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            text-align: center;
            width: 100%;
        }
        .product-item-price {
            font-size: 16px;
            font-weight: 600;
            color: #4361ee;
            text-align: center;
            width: 100%;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        .quantity-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #e0e0e0;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            user-select: none;
            -webkit-user-select: none;
        }
        .quantity-btn:hover {
            background: #f5f5f5;
            border-color: #4361ee;
        }
        .quantity-btn:active {
            background: #e0e0e0;
        }
        .quantity-input {
            width: 45px;
            height: 32px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }
        .item-price {
            font-size: 16px;
            font-weight: 600;
            color: #4361ee;
        }
        .add-product-btn {
            padding: 8px 16px;
            background: #4361ee;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .remove-product-btn {
            padding: 4px 8px;
            background: #ff4444;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .total-section {
            padding: 16px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 0;
            margin-bottom: 0;
            flex-shrink: 0;
        }
        .total-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 16px;
        }
        .total-info-left {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }
        .total-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        .total-info-item {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        .total-info-item strong {
            color: #333;
            font-weight: 600;
        }
        .total-price {
            font-size: 24px;
            font-weight: 600;
            color: #4361ee;
            white-space: nowrap;
            margin-top: 0;
        }
        .total-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }
        .product-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .product-modal-content {
            background: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            padding: 24px;
            overflow-y: auto;
        }
        .product-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .product-modal-header h3 {
            margin: 0;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        .product-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 8px;
        }
        .product-card-name {
            font-weight: 600;
            margin-bottom: 8px;
        }
        .product-card-sizes {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .size-btn {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .size-btn:hover {
            background: #f5f5f5;
            border-color: #4361ee;
        }
        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .payment-modal-content {
            background: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            padding: 24px;
            text-align: center;
        }
        .payment-modal-header {
            margin-bottom: 20px;
        }
        .payment-modal-header h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
        }
        .payment-modal-header p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .qrcode-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .qrcode-container img {
            max-width: 250px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .payment-amount {
            font-size: 24px;
            font-weight: 600;
            color: #4361ee;
            margin: 16px 0;
        }
        .payment-status {
            margin: 16px 0;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
        }
        .payment-status.success {
            background: #d4edda;
            color: #155724;
        }
        .payment-status.pending {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title">ç¡®è®¤è®¢å•ä¿¡æ¯</h1>
        <div class="image-list-container">
            <div id="imageList"></div>
        </div>
        <div class="total-section">
            <div class="total-info">
                <div class="total-info-left">
                    <div class="total-title">æ€»è®¡</div>
                    <div class="total-info-item">å…± <strong id="photoCount">0</strong> å¼ ç…§ç‰‡ åŒ…å«ä¸€å¼ å…è´¹æ‰“å°</div>
                    <div class="total-info-item"><strong id="productCount">0</strong> ä¸ªå‘¨è¾¹äº§å“</div>
                </div>
                <div class="total-price">Â¥<span id="totalPrice">0.00</span></div>
            </div>
            <div class="total-actions">
                <button class="btn btn-secondary" onclick="goBack()">è¿”å›</button>
                <button class="btn btn-primary" onclick="submitSelection()">ç¡®è®¤æäº¤</button>
            </div>
        </div>
    </div>
    
    <!-- äº§å“é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="productModal" class="product-modal">
        <div class="product-modal-content">
            <div class="product-modal-header">
                <h3>é€‰æ‹©äº§å“</h3>
                <button onclick="closeProductModal()" style="background:none;border:none;font-size:24px;cursor:pointer">&times;</button>
            </div>
            <div id="productList" class="product-grid"></div>
        </div>
    </div>
    
    <!-- æ”¯ä»˜äºŒç»´ç æ¨¡æ€æ¡† -->
    <div id="paymentModal" class="payment-modal">
        <div class="payment-modal-content">
            <div class="payment-modal-header">
                <h3>è¯·æ‰«ç æ”¯ä»˜</h3>
                <p>ä½¿ç”¨å¾®ä¿¡æ‰«æä¸‹æ–¹äºŒç»´ç å®Œæˆæ”¯ä»˜</p>
            </div>
            <div class="payment-amount">Â¥<span id="paymentAmount">0.00</span></div>
            <div class="qrcode-container">
                <img id="paymentQrcode" src="" alt="æ”¯ä»˜äºŒç»´ç ">
            </div>
            <div id="paymentStatus" class="payment-status pending">ç­‰å¾…æ”¯ä»˜ä¸­...</div>
            <div id="skipPaymentBtn" style="margin-top: 12px; display: none;">
                <button class="btn btn-warning btn-sm" onclick="skipPayment()">æµ‹è¯•ï¼šè·³è¿‡æ”¯ä»˜</button>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closePaymentModal()">å–æ¶ˆæ”¯ä»˜</button>
            </div>
        </div>
    </div>
    
    <script>
        console.log('ğŸ” [ç¡®è®¤é€‰ç‰‡] é¡µé¢å¼€å§‹åˆå§‹åŒ–');
        const effectImages = {{ effect_images | tojson }};
        const shopProducts = {{ products_data | tojson }};
        const styleProductsMap = {{ style_products_map | tojson }};
        const orderId = {{ order.id }};
        const freeSelectionCount = {{ free_selection_count | default(1) }};
        
        console.log('ğŸ” [ç¡®è®¤é€‰ç‰‡] effectImages:', effectImages);
        console.log('ğŸ” [ç¡®è®¤é€‰ç‰‡] effectImages.length:', effectImages.length);
        console.log('ğŸ” [ç¡®è®¤é€‰ç‰‡] shopProducts:', shopProducts);
        console.log('ğŸ” [ç¡®è®¤é€‰ç‰‡] styleProductsMap:', styleProductsMap);
        console.log('ğŸ” [ç¡®è®¤é€‰ç‰‡] orderId:', orderId);
        console.log('ğŸ” [ç¡®è®¤é€‰ç‰‡] freeSelectionCount:', freeSelectionCount);
        
        // ä»URLå‚æ•°è·å–é€‰ä¸­çš„ç…§ç‰‡ID
        const urlParams = new URLSearchParams(window.location.search);
        const selectedImageIdsParam = urlParams.get('images') || '';
        console.log('ğŸ” [ç¡®è®¤é€‰ç‰‡] selectedImageIdsParam:', selectedImageIdsParam);
        
        let currentImageIndex = -1;
        // å­˜å‚¨æ¯ä¸ªå›¾ç‰‡çš„äº§å“åˆ—è¡¨ {imageIndex: [{productId, sizeId, name, price, quantity}]}
        let imageProducts = {};
        
        // è¿”å›æŒ‰é’®ï¼šä¿ç•™é€‰ä¸­çš„ç…§ç‰‡ID
        function goBack() {
            // è·å–å½“å‰é€‰ä¸­çš„ç…§ç‰‡IDï¼ˆä»URLå‚æ•°ä¸­è·å–ï¼‰
            if (selectedImageIdsParam) {
                window.location.href = '/admin/photo-selection/' + orderId + '?images=' + selectedImageIdsParam;
            } else {
                window.history.back();
            }
        }
        
        function initPage() {
            console.log('ğŸ” [ç¡®è®¤é€‰ç‰‡] initPage è¢«è°ƒç”¨');
            console.log('ğŸ” [ç¡®è®¤é€‰ç‰‡] effectImages:', effectImages);
            
            const imageList = document.getElementById('imageList');
            if (!imageList) {
                console.error('âŒ [ç¡®è®¤é€‰ç‰‡] æ‰¾ä¸åˆ° imageList å…ƒç´ ');
                return;
            }
            
            imageList.innerHTML = '';
            
            if (!effectImages || effectImages.length === 0) {
                console.warn('âš ï¸ [ç¡®è®¤é€‰ç‰‡] effectImages ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯');
                imageList.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;"><p>æ²¡æœ‰æ‰¾åˆ°é€‰ä¸­çš„æ•ˆæœå›¾</p><p>è¯·è¿”å›é‡æ–°é€‰æ‹©</p></div>';
                return;
            }
            
            console.log('ğŸ” [ç¡®è®¤é€‰ç‰‡] å¼€å§‹æ¸²æŸ“', effectImages.length, 'å¼ å›¾ç‰‡');
            
            // åˆå§‹åŒ–æ¯ä¸ªå›¾ç‰‡çš„äº§å“åˆ—è¡¨
            effectImages.forEach((image, index) => {
                console.log('ğŸ” [ç¡®è®¤é€‰ç‰‡] å¤„ç†å›¾ç‰‡', index, ':', image);
                imageProducts[index] = [];
                
                const item = document.createElement('div');
                item.className = 'image-item';
                item.dataset.imageId = image.id;
                item.dataset.imageUrl = image.url;
                
                // ç¬¬ä¸€å¼ å›¾ç‰‡é»˜è®¤æ·»åŠ å…è´¹åº•ç‰‡
                if (index === 0) {
                    imageProducts[index].push({
                        productId: null,
                        sizeId: null,
                        name: 'ç…§ç‰‡æ‰“å°',
                        price: 0.00,
                        quantity: 1,
                        isFree: true
                    });
                } else {
                    // å…¶ä»–å›¾ç‰‡é»˜è®¤æ·»åŠ ä»˜è´¹åº•ç‰‡
                    imageProducts[index].push({
                        productId: null,
                        sizeId: null,
                        name: 'ç…§ç‰‡æ‰“å°',
                        price: 10.00,
                        quantity: 1,
                        isFree: false
                    });
                }
                
                item.innerHTML = `
                    <div class="image-preview">
                        <img src="${image.url}" alt="æ•ˆæœå›¾">
                    </div>
                    <div class="image-info">
                        <div class="product-list" id="productList_${index}"></div>
                    </div>
                    <button class="add-product-btn" onclick="openProductModal(${index})">æ·»åŠ äº§å“</button>
                `;
                
                imageList.appendChild(item);
                renderImageProducts(index);
            });
            
            updateTotalPrice();
        }
        
        // è®¡ç®—äº§å“ä»·æ ¼ï¼šç¬¬ä¸€å¼ ç…§ç‰‡ç¬¬ä¸€å¼ 0å…ƒï¼Œåç»­æ¯å¼ 10å…ƒï¼›å…¶ä»–ç…§ç‰‡æ¯å¼ 10å…ƒ
        function calculateProductPrice(product, imageIndex) {
            if (product.isFree && imageIndex === 0) {
                // ç¬¬ä¸€å¼ ç…§ç‰‡ï¼šç¬¬ä¸€å¼ å…è´¹ï¼Œåç»­æ¯å¼ 10å…ƒ
                if (product.quantity <= 1) {
                    return 0.00;
                } else {
                    return (product.quantity - 1) * 10.00;
                }
            } else {
                // å…¶ä»–ç…§ç‰‡ï¼šæ¯å¼ 10å…ƒ
                return product.price * product.quantity;
            }
        }
        
        function renderImageProducts(imageIndex) {
            const productList = document.getElementById(`productList_${imageIndex}`);
            if (!productList) return;
            
            productList.innerHTML = '';
            
            // è·å–å½“å‰å›¾ç‰‡çš„URLï¼ˆç”¨äºé»˜è®¤åº•ç‰‡æ˜¾ç¤ºï¼‰
            const currentImage = effectImages[imageIndex];
            const currentImageUrl = currentImage ? currentImage.url : null;
            
            const products = imageProducts[imageIndex] || [];
            products.forEach((product, productIndex) => {
                // æŸ¥æ‰¾äº§å“å›¾ç‰‡
                let productImageUrl = null;
                if (product.productId) {
                    // å¦‚æœæ˜¯æ·»åŠ çš„äº§å“ï¼Œä½¿ç”¨äº§å“å›¾ç‰‡
                    const shopProduct = shopProducts.find(p => p.id === product.productId);
                    if (shopProduct && shopProduct.image_url) {
                        productImageUrl = shopProduct.image_url;
                    }
                } else {
                    // å¦‚æœæ˜¯é»˜è®¤åº•ç‰‡ï¼ˆç…§ç‰‡æ‰“å°ï¼‰ï¼Œä½¿ç”¨å®¢æˆ·é€‰ä¸­çš„ç…§ç‰‡
                    productImageUrl = currentImageUrl;
                }
                
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                
                // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºå›¾ç‰‡
                const imageHtml = productImageUrl 
                    ? `<img src="${productImageUrl}" alt="${product.name}" class="product-item-image" onerror="this.style.display='none'">`
                    : '';
                
                productItem.innerHTML = `
                    ${imageHtml}
                    <div class="product-name">${product.name}</div>
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="adjustProductQuantity(${imageIndex}, ${productIndex}, -1)">-</button>
                        <input type="number" class="quantity-input" data-image="${imageIndex}" data-product="${productIndex}" value="${product.quantity}" min="1" onchange="updateProductQuantity(${imageIndex}, ${productIndex}, this.value)">
                        <button class="quantity-btn" onclick="adjustProductQuantity(${imageIndex}, ${productIndex}, 1)">+</button>
                    </div>
                    <div class="product-item-price">Â¥<span class="product-price-value" data-image="${imageIndex}" data-product="${productIndex}">${calculateProductPrice(product, imageIndex).toFixed(2)}</span></div>
                `;
                productList.appendChild(productItem);
            });
        }
        
        function adjustProductQuantity(imageIndex, productIndex, delta) {
            const products = imageProducts[imageIndex];
            if (!products || !products[productIndex]) return;
            
            const product = products[productIndex];
            const newQuantity = Math.max(1, product.quantity + delta);
            product.quantity = newQuantity;
            
            // æ›´æ–°è¾“å…¥æ¡†çš„å€¼ï¼ˆä½¿ç”¨ data å±æ€§å®šä½ï¼‰
            const quantityInput = document.querySelector(`.quantity-input[data-image="${imageIndex}"][data-product="${productIndex}"]`);
            if (quantityInput) {
                quantityInput.value = newQuantity;
            }
            
            // æ›´æ–°ä»·æ ¼æ˜¾ç¤ºï¼ˆä½¿ç”¨æ–°çš„ä»·æ ¼è®¡ç®—é€»è¾‘ï¼‰
            const priceEl = document.querySelector(`.product-price-value[data-image="${imageIndex}"][data-product="${productIndex}"]`);
            if (priceEl) {
                priceEl.textContent = calculateProductPrice(product, imageIndex).toFixed(2);
            }
            
            updateTotalPrice();
        }
        
        function updateProductQuantity(imageIndex, productIndex, quantity) {
            const products = imageProducts[imageIndex];
            if (!products || !products[productIndex]) return;
            
            const product = products[productIndex];
            product.quantity = Math.max(1, parseInt(quantity) || 1);
            
            // æ›´æ–°ä»·æ ¼æ˜¾ç¤ºï¼ˆä½¿ç”¨æ–°çš„ä»·æ ¼è®¡ç®—é€»è¾‘ï¼‰
            const priceEl = document.querySelector(`.product-price-value[data-image="${imageIndex}"][data-product="${productIndex}"]`);
            if (priceEl) {
                priceEl.textContent = calculateProductPrice(product, imageIndex).toFixed(2);
            }
            
            updateTotalPrice();
        }
        
        function removeProduct(imageIndex, productIndex) {
            const products = imageProducts[imageIndex];
            if (!products || !products[productIndex]) return;
            
            const product = products[productIndex];
            // ä¸èƒ½åˆ é™¤å…è´¹åº•ç‰‡
            if (product.isFree) return;
            
            products.splice(productIndex, 1);
            renderImageProducts(imageIndex);
            updateTotalPrice();
        }
        
        function updateTotalPrice() {
            let total = 0;
            let photoCount = 0;  // ç…§ç‰‡æ•°é‡
            let productCount = 0;  // å‘¨è¾¹äº§å“æ•°é‡ï¼ˆä¸åŒ…æ‹¬é»˜è®¤åº•ç‰‡ï¼‰
            
            Object.keys(imageProducts).forEach(imageIndex => {
                const products = imageProducts[imageIndex] || [];
                let hasPhoto = false;
                
                products.forEach(product => {
                    // ä½¿ç”¨æ–°çš„ä»·æ ¼è®¡ç®—é€»è¾‘
                    const price = calculateProductPrice(product, parseInt(imageIndex));
                    total += price;
                    
                    // å¦‚æœæ˜¯é»˜è®¤åº•ç‰‡ï¼ˆisFreeæˆ–æ²¡æœ‰productIdï¼‰ï¼Œç®—ä½œç…§ç‰‡
                    if (product.isFree || !product.productId) {
                        hasPhoto = true;
                    } else {
                        // å¦‚æœæœ‰productIdï¼Œç®—ä½œå‘¨è¾¹äº§å“
                        productCount += product.quantity;
                    }
                });
                
                if (hasPhoto) {
                    photoCount += 1;
                }
            });
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalPrice').textContent = total.toFixed(2);
            document.getElementById('photoCount').textContent = photoCount;
            document.getElementById('productCount').textContent = productCount;
        }
        
        function openProductModal(index) {
            currentImageIndex = index;
            const modal = document.getElementById('productModal');
            modal.style.display = 'flex';
            // æŒ‰è¯¥ç…§ç‰‡çš„é£æ ¼è¿‡æ»¤å¯é€‰äº§å“ï¼šåªæ˜¾ç¤ºä¸è¯¥é£æ ¼ç»‘å®šçš„äº§å“
            const image = effectImages[index];
            const styleCategoryId = image ? image.style_category_id : null;
            const mapKey = styleCategoryId != null ? String(styleCategoryId) : 'all';
            const productsToShow = (styleProductsMap[mapKey] !== undefined)
                ? styleProductsMap[mapKey]
                : (styleProductsMap['all'] || shopProducts);
            console.log('ğŸ” [æ·»åŠ äº§å“] å›¾ç‰‡index=', index, 'style_category_id=', styleCategoryId, 'å¯é€‰äº§å“æ•°=', productsToShow.length);
            renderProducts(productsToShow);
        }
        
        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }
        
        function renderProducts(products) {
            const productList = document.getElementById('productList');
            productList.innerHTML = '';
            const list = products || shopProducts;
            if (list.length === 0) {
                productList.innerHTML = '<div style="padding: 20px; color: #999; text-align: center;">è¯¥é£æ ¼æš‚æ— ç»‘å®šäº§å“ï¼Œè¯·åœ¨äº§å“ç®¡ç†ä¸­ä¸ºé£æ ¼ç»‘å®šäº§å“</div>';
                return;
            }
            list.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <img src="${product.image_url || '/static/images/default-product.png'}" alt="${product.name}">
                    <div class="product-card-name">${product.name}</div>
                    <div class="product-card-sizes">
                        ${product.sizes.map(size => `
                            <button class="size-btn" onclick="selectProduct(${product.id}, ${size.id}, '${product.name}', '${size.name}', ${size.price})">
                                ${size.name} - Â¥${size.price}
                            </button>
                        `).join('')}
                    </div>
                `;
                productList.appendChild(card);
            });
        }
        
        function selectProduct(productId, sizeId, productName, sizeName, price) {
            if (currentImageIndex === -1) return;
            
            // æ·»åŠ æ–°äº§å“åˆ°å½“å‰å›¾ç‰‡
            if (!imageProducts[currentImageIndex]) {
                imageProducts[currentImageIndex] = [];
            }
            
            // ä½¿ç”¨å®Œæ•´çš„äº§å“åç§°æ ¼å¼ï¼šäº§å“åç§°-è§„æ ¼åç§°
            const fullName = `${productName}-${sizeName}`;
            
            // æŸ¥æ‰¾äº§å“å›¾ç‰‡
            const shopProduct = shopProducts.find(p => p.id === productId);
            const productImageUrl = shopProduct && shopProduct.image_url ? shopProduct.image_url : null;
            
            imageProducts[currentImageIndex].push({
                productId: productId,
                sizeId: sizeId,
                name: fullName,
                price: parseFloat(price),
                quantity: 1,
                isFree: false,
                imageUrl: productImageUrl
            });
            
            renderImageProducts(currentImageIndex);
            updateTotalPrice();
            closeProductModal();
        }
        
        let paymentCheckInterval = null;
        let shopOrderNumbers = [];
        let paymentConfig = null;  // æ”¯ä»˜é…ç½®
        
        // è·å–æ”¯ä»˜é…ç½®
        async function loadPaymentConfig() {
            try {
                const response = await fetch('/api/admin/payment-config');
                const result = await response.json();
                if (result.status === 'success') {
                    paymentConfig = result.data;
                } else {
                    // ä½¿ç”¨é»˜è®¤æµ‹è¯•é…ç½®
                    paymentConfig = {
                        test_mode: true,
                        skip_payment: true,
                        qrcode_url: null
                    };
                }
            } catch (error) {
                console.error('è·å–æ”¯ä»˜é…ç½®å¤±è´¥:', error);
                // ä½¿ç”¨é»˜è®¤æµ‹è¯•é…ç½®
                paymentConfig = {
                    test_mode: true,
                    skip_payment: true,
                    qrcode_url: null
                };
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ”¯ä»˜é…ç½®
        loadPaymentConfig();
        
        let isSubmitting = false;  // é˜²æ­¢é‡å¤æäº¤æ ‡å¿—
        
        function submitSelection() {
            // é˜²æ­¢é‡å¤æäº¤
            if (isSubmitting) {
                console.log('æ­£åœ¨æäº¤ä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»');
                return;
            }
            
            const items = document.querySelectorAll('.image-item');
            const selectedImageIds = [];
            const imageProductMappings = {};
            
            items.forEach((item, index) => {
                const imageId = parseInt(item.dataset.imageId);
                selectedImageIds.push(imageId);
                
                // è·å–è¯¥å›¾ç‰‡çš„æ‰€æœ‰äº§å“ï¼ˆæ’é™¤å…è´¹åº•ç‰‡ï¼‰
                const products = imageProducts[index] || [];
                const productMappings = [];
                
                products.forEach(product => {
                    // åªæäº¤ä»˜è´¹äº§å“
                    if (!product.isFree && product.productId && product.sizeId) {
                        productMappings.push({
                            product_id: product.productId,
                            size_id: product.sizeId,
                            quantity: product.quantity
                        });
                    }
                });
                
                if (productMappings.length > 0) {
                    // æ–°æ ¼å¼ï¼šæ”¯æŒä¸€ä¸ªå›¾ç‰‡å…³è”å¤šä¸ªäº§å“
                    imageProductMappings[imageId] = productMappings;
                }
            });
            
            // è®¡ç®—æ€»ä»·
            const totalPrice = parseFloat(document.getElementById('totalPrice').textContent);
            
            // è®¾ç½®æäº¤çŠ¶æ€
            isSubmitting = true;
            const submitBtn = document.querySelector('button[onclick="submitSelection()"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'æäº¤ä¸­...';
            }
            
            fetch('/admin/photo-selection/' + orderId + '/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    selected_image_ids: selectedImageIds,
                    image_product_mappings: imageProductMappings
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    shopOrderNumbers = data.created_orders || [];
                    
                    // å¦‚æœæœ‰éœ€è¦æ”¯ä»˜çš„è®¢å•ï¼Œæ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç 
                    if (totalPrice > 0 && shopOrderNumbers.length > 0) {
                        showPaymentModal(totalPrice, shopOrderNumbers);
                    } else {
                        // å¦‚æœä¸éœ€è¦æ”¯ä»˜ï¼Œç›´æ¥è§¦å‘æ‰“å°
                        if (shopOrderNumbers.length > 0) {
                            triggerPrint(shopOrderNumbers).then(() => {
                                alert(data.message || 'é€‰ç‰‡æˆåŠŸï¼Œå·²å¼€å§‹æ‰“å°');
                                window.location.href = '/admin/photo-selection';
                            }).catch(error => {
                                console.error('æ‰“å°å¤±è´¥:', error);
                                alert(data.message || 'é€‰ç‰‡æˆåŠŸï¼Œä½†æ‰“å°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤„ç†');
                                window.location.href = '/admin/photo-selection';
                            });
                        } else {
                            alert(data.message || 'é€‰ç‰‡æˆåŠŸ');
                            window.location.href = '/admin/photo-selection';
                        }
                    }
                } else {
                    alert(data.message || 'é€‰ç‰‡å¤±è´¥');
                    // æäº¤å¤±è´¥ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                    isSubmitting = false;
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ç¡®è®¤æäº¤';
                    }
                }
            })
            .catch(error => {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                // æäº¤å¤±è´¥ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
                isSubmitting = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ç¡®è®¤æäº¤';
                }
            });
        }
        
        function showPaymentModal(amount, orderNumbers) {
            document.getElementById('paymentAmount').textContent = amount.toFixed(2);
            document.getElementById('paymentStatus').textContent = 'ç­‰å¾…æ”¯ä»˜ä¸­...';
            document.getElementById('paymentStatus').className = 'payment-status pending';
            
            // æ£€æŸ¥æ˜¯å¦å¯ç”¨æµ‹è¯•æ¨¡å¼ï¼ˆè·³è¿‡æ”¯ä»˜ï¼‰
            const isTestMode = paymentConfig && paymentConfig.test_mode;
            const skipPayment = paymentConfig && paymentConfig.skip_payment;
            
            // æ˜¾ç¤º/éšè—è·³è¿‡æ”¯ä»˜æŒ‰é’®
            const skipBtn = document.getElementById('skipPaymentBtn');
            if (isTestMode && skipPayment) {
                skipBtn.style.display = 'block';
            } else {
                skipBtn.style.display = 'none';
            }
            
            // ç”Ÿæˆæ”¯ä»˜äºŒç»´ç 
            if (paymentConfig && paymentConfig.qrcode_url) {
                // ä½¿ç”¨é…ç½®çš„äºŒç»´ç URL
                document.getElementById('paymentQrcode').src = paymentConfig.qrcode_url;
            } else {
                // ä½¿ç”¨è®¢å•å·ç”Ÿæˆä¸´æ—¶æµ‹è¯•äºŒç»´ç 
                const qrContent = orderNumbers.length > 0 ? orderNumbers[0] : `order:${orderId}`;
                generateQrcode(qrContent);
            }
            
            document.getElementById('paymentModal').style.display = 'flex';
            
            // å¼€å§‹è½®è¯¢æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
            startPaymentCheck(orderNumbers);
        }
        
        function generateQrcode(content) {
            // ä½¿ç”¨qrcode.jsç”ŸæˆäºŒç»´ç ï¼ˆéœ€è¦å¼•å…¥qrcodeåº“ï¼‰
            // è¿™é‡Œä½¿ç”¨åœ¨çº¿APIç”ŸæˆäºŒç»´ç 
            const qrcodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(content)}`;
            document.getElementById('paymentQrcode').src = qrcodeUrl;
        }
        
        function startPaymentCheck(orderNumbers) {
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
            }
            
            paymentCheckInterval = setInterval(() => {
                checkPaymentStatus(orderNumbers);
            }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
        }
        
        function checkPaymentStatus(orderNumbers) {
            if (orderNumbers.length === 0) return;
            
            fetch('/admin/photo-selection/' + orderId + '/check-payment?orders=' + orderNumbers.join(','), {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data.paid) {
                    // æ”¯ä»˜æˆåŠŸ
                    document.getElementById('paymentStatus').textContent = 'æ”¯ä»˜æˆåŠŸï¼æ­£åœ¨å¼€å§‹æ‰“å°...';
                    document.getElementById('paymentStatus').className = 'payment-status success';
                    
                    if (paymentCheckInterval) {
                        clearInterval(paymentCheckInterval);
                        paymentCheckInterval = null;
                    }
                    
                    // è§¦å‘æ‰“å°
                    triggerPrint(orderNumbers).then(() => {
                        // 2ç§’åå…³é—­æ¨¡æ€æ¡†å¹¶è·³è½¬
                        setTimeout(() => {
                            closePaymentModal();
                            window.location.href = '/admin/photo-selection';
                        }, 2000);
                    }).catch(error => {
                        console.error('æ‰“å°å¤±è´¥:', error);
                        alert('æ”¯ä»˜æˆåŠŸï¼Œä½†æ‰“å°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤„ç†');
                        setTimeout(() => {
                            closePaymentModal();
                            window.location.href = '/admin/photo-selection';
                        }, 2000);
                    });
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥:', error);
            });
        }
        
        // è§¦å‘æ‰“å°
        async function triggerPrint(orderNumbers) {
            try {
                const response = await fetch('/admin/photo-selection/' + orderId + '/start-print', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        order_numbers: orderNumbers
                    })
                });
                const result = await response.json();
                if (result.success) {
                    console.log('æ‰“å°ä»»åŠ¡å·²å¯åŠ¨');
                    return Promise.resolve();
                } else {
                    return Promise.reject(new Error(result.message || 'æ‰“å°å¤±è´¥'));
                }
            } catch (error) {
                return Promise.reject(error);
            }
        }
        
        // è·³è¿‡æ”¯ä»˜ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰
        function skipPayment() {
            if (!paymentConfig || !paymentConfig.skip_payment) {
                alert('å½“å‰ä¸æ˜¯æµ‹è¯•æ¨¡å¼ï¼Œæ— æ³•è·³è¿‡æ”¯ä»˜');
                return;
            }
            
            // è°ƒç”¨åç«¯æ¥å£æ ‡è®°ä¸ºå·²æ”¯ä»˜
            fetch('/admin/photo-selection/' + orderId + '/skip-payment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    order_numbers: shopOrderNumbers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
                    document.getElementById('paymentStatus').textContent = 'æ”¯ä»˜æˆåŠŸï¼æ­£åœ¨å¼€å§‹æ‰“å°...';
                    document.getElementById('paymentStatus').className = 'payment-status success';
                    
                    if (paymentCheckInterval) {
                        clearInterval(paymentCheckInterval);
                        paymentCheckInterval = null;
                    }
                    
                    // è§¦å‘æ‰“å°
                    triggerPrint(shopOrderNumbers).then(() => {
                        setTimeout(() => {
                            closePaymentModal();
                            window.location.href = '/admin/photo-selection';
                        }, 2000);
                    }).catch(error => {
                        console.error('æ‰“å°å¤±è´¥:', error);
                        alert('æ”¯ä»˜æˆåŠŸï¼Œä½†æ‰“å°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤„ç†');
                        setTimeout(() => {
                            closePaymentModal();
                            window.location.href = '/admin/photo-selection';
                        }, 2000);
                    });
                } else {
                    alert(data.message || 'è·³è¿‡æ”¯ä»˜å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('è·³è¿‡æ”¯ä»˜å¤±è´¥:', error);
                alert('è·³è¿‡æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }
        
        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
                paymentCheckInterval = null;
            }
        }
        
        initPage();
    </script>
</body>
</html>
