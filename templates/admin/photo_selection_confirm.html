<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>确认订单信息 - {{ brand_name }}后台</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            background: #fff;
            border-radius: 12px;
            padding: 32px 24px;
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .page-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        .image-list-container {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            margin-bottom: 20px;
        }
        .image-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 16px;
            align-items: flex-start;
            flex-shrink: 0;
        }
        .image-preview {
            display: none; /* 隐藏左侧大图预览，因为产品卡片已显示照片 */
        }
        .image-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .product-list {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 12px;
        }
        .product-item {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            min-width: 180px;
            max-width: 220px;
            flex: 0 0 auto;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .product-item-image {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 4px;
            background: #f8f9fa;
            margin-bottom: 4px;
        }
        .product-name {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            text-align: center;
            width: 100%;
        }
        .product-item-price {
            font-size: 16px;
            font-weight: 600;
            color: #4361ee;
            text-align: center;
            width: 100%;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        .quantity-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #e0e0e0;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            user-select: none;
            -webkit-user-select: none;
        }
        .quantity-btn:hover {
            background: #f5f5f5;
            border-color: #4361ee;
        }
        .quantity-btn:active {
            background: #e0e0e0;
        }
        .quantity-input {
            width: 45px;
            height: 32px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }
        .item-price {
            font-size: 16px;
            font-weight: 600;
            color: #4361ee;
        }
        .add-product-btn {
            padding: 8px 16px;
            background: #4361ee;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .remove-product-btn {
            padding: 4px 8px;
            background: #ff4444;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .total-section {
            padding: 16px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 0;
            margin-bottom: 0;
            flex-shrink: 0;
        }
        .total-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 16px;
        }
        .total-info-left {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }
        .total-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        .total-info-item {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        .total-info-item strong {
            color: #333;
            font-weight: 600;
        }
        .total-price {
            font-size: 24px;
            font-weight: 600;
            color: #4361ee;
            white-space: nowrap;
            margin-top: 0;
        }
        .total-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }
        .product-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .product-modal-content {
            background: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            padding: 24px;
            overflow-y: auto;
        }
        .product-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .product-modal-header h3 {
            margin: 0;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }
        .product-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 8px;
        }
        .product-card-name {
            font-weight: 600;
            margin-bottom: 8px;
        }
        .product-card-sizes {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .size-btn {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .size-btn:hover {
            background: #f5f5f5;
            border-color: #4361ee;
        }
        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .payment-modal-content {
            background: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            padding: 24px;
            text-align: center;
        }
        .payment-modal-header {
            margin-bottom: 20px;
        }
        .payment-modal-header h3 {
            margin: 0 0 8px 0;
            font-size: 20px;
        }
        .payment-modal-header p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .qrcode-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .qrcode-container img {
            max-width: 250px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .payment-amount {
            font-size: 24px;
            font-weight: 600;
            color: #4361ee;
            margin: 16px 0;
        }
        .payment-status {
            margin: 16px 0;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
        }
        .payment-status.success {
            background: #d4edda;
            color: #155724;
        }
        .payment-status.pending {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-title">确认订单信息</h1>
        <div class="image-list-container">
            <div id="imageList"></div>
        </div>
        <div class="total-section">
            <div class="total-info">
                <div class="total-info-left">
                    <div class="total-title">总计</div>
                    <div class="total-info-item">共 <strong id="photoCount">0</strong> 张照片 包含一张免费打印</div>
                    <div class="total-info-item"><strong id="productCount">0</strong> 个周边产品</div>
                </div>
                <div class="total-price">¥<span id="totalPrice">0.00</span></div>
            </div>
            <div class="total-actions">
                <button class="btn btn-secondary" onclick="goBack()">返回</button>
                <button class="btn btn-primary" onclick="submitSelection()">确认提交</button>
            </div>
        </div>
    </div>
    
    <!-- 产品选择模态框 -->
    <div id="productModal" class="product-modal">
        <div class="product-modal-content">
            <div class="product-modal-header">
                <h3>选择产品</h3>
                <button onclick="closeProductModal()" style="background:none;border:none;font-size:24px;cursor:pointer">&times;</button>
            </div>
            <div id="productList" class="product-grid"></div>
        </div>
    </div>
    
    <!-- 支付二维码模态框 -->
    <div id="paymentModal" class="payment-modal">
        <div class="payment-modal-content">
            <div class="payment-modal-header">
                <h3>请扫码支付</h3>
                <p>使用微信扫描下方二维码完成支付</p>
            </div>
            <div class="payment-amount">¥<span id="paymentAmount">0.00</span></div>
            <div class="qrcode-container">
                <img id="paymentQrcode" src="" alt="支付二维码">
            </div>
            <div id="paymentStatus" class="payment-status pending">等待支付中...</div>
            <div id="skipPaymentBtn" style="margin-top: 12px; display: none;">
                <button class="btn btn-warning btn-sm" onclick="skipPayment()">测试：跳过支付</button>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closePaymentModal()">取消支付</button>
            </div>
        </div>
    </div>
    
    <script>
        console.log('🔍 [确认选片] 页面开始初始化');
        const effectImages = {{ effect_images | tojson }};
        const shopProducts = {{ shop_products | tojson }};
        const orderId = {{ order.id }};
        const freeSelectionCount = {{ free_selection_count | default(1) }};
        
        console.log('🔍 [确认选片] effectImages:', effectImages);
        console.log('🔍 [确认选片] effectImages.length:', effectImages.length);
        console.log('🔍 [确认选片] shopProducts:', shopProducts);
        console.log('🔍 [确认选片] orderId:', orderId);
        console.log('🔍 [确认选片] freeSelectionCount:', freeSelectionCount);
        
        // 从URL参数获取选中的照片ID
        const urlParams = new URLSearchParams(window.location.search);
        const selectedImageIdsParam = urlParams.get('images') || '';
        console.log('🔍 [确认选片] selectedImageIdsParam:', selectedImageIdsParam);
        
        let currentImageIndex = -1;
        // 存储每个图片的产品列表 {imageIndex: [{productId, sizeId, name, price, quantity}]}
        let imageProducts = {};
        
        // 返回按钮：保留选中的照片ID
        function goBack() {
            // 获取当前选中的照片ID（从URL参数中获取）
            if (selectedImageIdsParam) {
                window.location.href = '/admin/photo-selection/' + orderId + '?images=' + selectedImageIdsParam;
            } else {
                window.history.back();
            }
        }
        
        function initPage() {
            console.log('🔍 [确认选片] initPage 被调用');
            console.log('🔍 [确认选片] effectImages:', effectImages);
            
            const imageList = document.getElementById('imageList');
            if (!imageList) {
                console.error('❌ [确认选片] 找不到 imageList 元素');
                return;
            }
            
            imageList.innerHTML = '';
            
            if (!effectImages || effectImages.length === 0) {
                console.warn('⚠️ [确认选片] effectImages 为空，显示提示信息');
                imageList.innerHTML = '<div style="padding: 40px; text-align: center; color: #999;"><p>没有找到选中的效果图</p><p>请返回重新选择</p></div>';
                return;
            }
            
            console.log('🔍 [确认选片] 开始渲染', effectImages.length, '张图片');
            
            // 初始化每个图片的产品列表
            effectImages.forEach((image, index) => {
                console.log('🔍 [确认选片] 处理图片', index, ':', image);
                imageProducts[index] = [];
                
                const item = document.createElement('div');
                item.className = 'image-item';
                item.dataset.imageId = image.id;
                item.dataset.imageUrl = image.url;
                
                // 第一张图片默认添加免费底片
                if (index === 0) {
                    imageProducts[index].push({
                        productId: null,
                        sizeId: null,
                        name: '照片打印',
                        price: 0.00,
                        quantity: 1,
                        isFree: true
                    });
                } else {
                    // 其他图片默认添加付费底片
                    imageProducts[index].push({
                        productId: null,
                        sizeId: null,
                        name: '照片打印',
                        price: 10.00,
                        quantity: 1,
                        isFree: false
                    });
                }
                
                item.innerHTML = `
                    <div class="image-preview">
                        <img src="${image.url}" alt="效果图">
                    </div>
                    <div class="image-info">
                        <div class="product-list" id="productList_${index}"></div>
                    </div>
                    <button class="add-product-btn" onclick="openProductModal(${index})">添加产品</button>
                `;
                
                imageList.appendChild(item);
                renderImageProducts(index);
            });
            
            updateTotalPrice();
        }
        
        // 计算产品价格：第一张照片第一张0元，后续每张10元；其他照片每张10元
        function calculateProductPrice(product, imageIndex) {
            if (product.isFree && imageIndex === 0) {
                // 第一张照片：第一张免费，后续每张10元
                if (product.quantity <= 1) {
                    return 0.00;
                } else {
                    return (product.quantity - 1) * 10.00;
                }
            } else {
                // 其他照片：每张10元
                return product.price * product.quantity;
            }
        }
        
        function renderImageProducts(imageIndex) {
            const productList = document.getElementById(`productList_${imageIndex}`);
            if (!productList) return;
            
            productList.innerHTML = '';
            
            // 获取当前图片的URL（用于默认底片显示）
            const currentImage = effectImages[imageIndex];
            const currentImageUrl = currentImage ? currentImage.url : null;
            
            const products = imageProducts[imageIndex] || [];
            products.forEach((product, productIndex) => {
                // 查找产品图片
                let productImageUrl = null;
                if (product.productId) {
                    // 如果是添加的产品，使用产品图片
                    const shopProduct = shopProducts.find(p => p.id === product.productId);
                    if (shopProduct && shopProduct.image_url) {
                        productImageUrl = shopProduct.image_url;
                    }
                } else {
                    // 如果是默认底片（照片打印），使用客户选中的照片
                    productImageUrl = currentImageUrl;
                }
                
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                
                // 如果有图片，显示图片
                const imageHtml = productImageUrl 
                    ? `<img src="${productImageUrl}" alt="${product.name}" class="product-item-image" onerror="this.style.display='none'">`
                    : '';
                
                productItem.innerHTML = `
                    ${imageHtml}
                    <div class="product-name">${product.name}</div>
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="adjustProductQuantity(${imageIndex}, ${productIndex}, -1)">-</button>
                        <input type="number" class="quantity-input" data-image="${imageIndex}" data-product="${productIndex}" value="${product.quantity}" min="1" onchange="updateProductQuantity(${imageIndex}, ${productIndex}, this.value)">
                        <button class="quantity-btn" onclick="adjustProductQuantity(${imageIndex}, ${productIndex}, 1)">+</button>
                    </div>
                    <div class="product-item-price">¥<span class="product-price-value" data-image="${imageIndex}" data-product="${productIndex}">${calculateProductPrice(product, imageIndex).toFixed(2)}</span></div>
                `;
                productList.appendChild(productItem);
            });
        }
        
        function adjustProductQuantity(imageIndex, productIndex, delta) {
            const products = imageProducts[imageIndex];
            if (!products || !products[productIndex]) return;
            
            const product = products[productIndex];
            const newQuantity = Math.max(1, product.quantity + delta);
            product.quantity = newQuantity;
            
            // 更新输入框的值（使用 data 属性定位）
            const quantityInput = document.querySelector(`.quantity-input[data-image="${imageIndex}"][data-product="${productIndex}"]`);
            if (quantityInput) {
                quantityInput.value = newQuantity;
            }
            
            // 更新价格显示（使用新的价格计算逻辑）
            const priceEl = document.querySelector(`.product-price-value[data-image="${imageIndex}"][data-product="${productIndex}"]`);
            if (priceEl) {
                priceEl.textContent = calculateProductPrice(product, imageIndex).toFixed(2);
            }
            
            updateTotalPrice();
        }
        
        function updateProductQuantity(imageIndex, productIndex, quantity) {
            const products = imageProducts[imageIndex];
            if (!products || !products[productIndex]) return;
            
            const product = products[productIndex];
            product.quantity = Math.max(1, parseInt(quantity) || 1);
            
            // 更新价格显示（使用新的价格计算逻辑）
            const priceEl = document.querySelector(`.product-price-value[data-image="${imageIndex}"][data-product="${productIndex}"]`);
            if (priceEl) {
                priceEl.textContent = calculateProductPrice(product, imageIndex).toFixed(2);
            }
            
            updateTotalPrice();
        }
        
        function removeProduct(imageIndex, productIndex) {
            const products = imageProducts[imageIndex];
            if (!products || !products[productIndex]) return;
            
            const product = products[productIndex];
            // 不能删除免费底片
            if (product.isFree) return;
            
            products.splice(productIndex, 1);
            renderImageProducts(imageIndex);
            updateTotalPrice();
        }
        
        function updateTotalPrice() {
            let total = 0;
            let photoCount = 0;  // 照片数量
            let productCount = 0;  // 周边产品数量（不包括默认底片）
            
            Object.keys(imageProducts).forEach(imageIndex => {
                const products = imageProducts[imageIndex] || [];
                let hasPhoto = false;
                
                products.forEach(product => {
                    // 使用新的价格计算逻辑
                    const price = calculateProductPrice(product, parseInt(imageIndex));
                    total += price;
                    
                    // 如果是默认底片（isFree或没有productId），算作照片
                    if (product.isFree || !product.productId) {
                        hasPhoto = true;
                    } else {
                        // 如果有productId，算作周边产品
                        productCount += product.quantity;
                    }
                });
                
                if (hasPhoto) {
                    photoCount += 1;
                }
            });
            
            // 更新显示
            document.getElementById('totalPrice').textContent = total.toFixed(2);
            document.getElementById('photoCount').textContent = photoCount;
            document.getElementById('productCount').textContent = productCount;
        }
        
        function openProductModal(index) {
            currentImageIndex = index;
            const modal = document.getElementById('productModal');
            modal.style.display = 'flex';
            renderProducts();
        }
        
        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }
        
        function renderProducts() {
            const productList = document.getElementById('productList');
            productList.innerHTML = '';
            
            shopProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <img src="${product.image_url || '/static/images/default-product.png'}" alt="${product.name}">
                    <div class="product-card-name">${product.name}</div>
                    <div class="product-card-sizes">
                        ${product.sizes.map(size => `
                            <button class="size-btn" onclick="selectProduct(${product.id}, ${size.id}, '${product.name}', '${size.name}', ${size.price})">
                                ${size.name} - ¥${size.price}
                            </button>
                        `).join('')}
                    </div>
                `;
                productList.appendChild(card);
            });
        }
        
        function selectProduct(productId, sizeId, productName, sizeName, price) {
            if (currentImageIndex === -1) return;
            
            // 添加新产品到当前图片
            if (!imageProducts[currentImageIndex]) {
                imageProducts[currentImageIndex] = [];
            }
            
            // 使用完整的产品名称格式：产品名称-规格名称
            const fullName = `${productName}-${sizeName}`;
            
            // 查找产品图片
            const shopProduct = shopProducts.find(p => p.id === productId);
            const productImageUrl = shopProduct && shopProduct.image_url ? shopProduct.image_url : null;
            
            imageProducts[currentImageIndex].push({
                productId: productId,
                sizeId: sizeId,
                name: fullName,
                price: parseFloat(price),
                quantity: 1,
                isFree: false,
                imageUrl: productImageUrl
            });
            
            renderImageProducts(currentImageIndex);
            updateTotalPrice();
            closeProductModal();
        }
        
        let paymentCheckInterval = null;
        let shopOrderNumbers = [];
        let paymentConfig = null;  // 支付配置
        
        // 获取支付配置
        async function loadPaymentConfig() {
            try {
                const response = await fetch('/api/admin/payment-config');
                const result = await response.json();
                if (result.status === 'success') {
                    paymentConfig = result.data;
                } else {
                    // 使用默认测试配置
                    paymentConfig = {
                        test_mode: true,
                        skip_payment: true,
                        qrcode_url: null
                    };
                }
            } catch (error) {
                console.error('获取支付配置失败:', error);
                // 使用默认测试配置
                paymentConfig = {
                    test_mode: true,
                    skip_payment: true,
                    qrcode_url: null
                };
            }
        }
        
        // 页面加载时获取支付配置
        loadPaymentConfig();
        
        let isSubmitting = false;  // 防止重复提交标志
        
        function submitSelection() {
            // 防止重复提交
            if (isSubmitting) {
                console.log('正在提交中，请勿重复点击');
                return;
            }
            
            const items = document.querySelectorAll('.image-item');
            const selectedImageIds = [];
            const imageProductMappings = {};
            
            items.forEach((item, index) => {
                const imageId = parseInt(item.dataset.imageId);
                selectedImageIds.push(imageId);
                
                // 获取该图片的所有产品（排除免费底片）
                const products = imageProducts[index] || [];
                const productMappings = [];
                
                products.forEach(product => {
                    // 只提交付费产品
                    if (!product.isFree && product.productId && product.sizeId) {
                        productMappings.push({
                            product_id: product.productId,
                            size_id: product.sizeId,
                            quantity: product.quantity
                        });
                    }
                });
                
                if (productMappings.length > 0) {
                    // 新格式：支持一个图片关联多个产品
                    imageProductMappings[imageId] = productMappings;
                }
            });
            
            // 计算总价
            const totalPrice = parseFloat(document.getElementById('totalPrice').textContent);
            
            // 设置提交状态
            isSubmitting = true;
            const submitBtn = document.querySelector('button[onclick="submitSelection()"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = '提交中...';
            }
            
            fetch('/admin/photo-selection/' + orderId + '/submit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    selected_image_ids: selectedImageIds,
                    image_product_mappings: imageProductMappings
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    shopOrderNumbers = data.created_orders || [];
                    
                    // 如果有需要支付的订单，显示支付二维码
                    if (totalPrice > 0 && shopOrderNumbers.length > 0) {
                        showPaymentModal(totalPrice, shopOrderNumbers);
                    } else {
                        // 如果不需要支付，直接触发打印
                        if (shopOrderNumbers.length > 0) {
                            triggerPrint(shopOrderNumbers).then(() => {
                                alert(data.message || '选片成功，已开始打印');
                                window.location.href = '/admin/photo-selection';
                            }).catch(error => {
                                console.error('打印失败:', error);
                                alert(data.message || '选片成功，但打印失败，请手动处理');
                                window.location.href = '/admin/photo-selection';
                            });
                        } else {
                            alert(data.message || '选片成功');
                            window.location.href = '/admin/photo-selection';
                        }
                    }
                } else {
                    alert(data.message || '选片失败');
                    // 提交失败，恢复按钮状态
                    isSubmitting = false;
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = '确认提交';
                    }
                }
            })
            .catch(error => {
                console.error('提交失败:', error);
                alert('提交失败，请重试');
                // 提交失败，恢复按钮状态
                isSubmitting = false;
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '确认提交';
                }
            });
        }
        
        function showPaymentModal(amount, orderNumbers) {
            document.getElementById('paymentAmount').textContent = amount.toFixed(2);
            document.getElementById('paymentStatus').textContent = '等待支付中...';
            document.getElementById('paymentStatus').className = 'payment-status pending';
            
            // 检查是否启用测试模式（跳过支付）
            const isTestMode = paymentConfig && paymentConfig.test_mode;
            const skipPayment = paymentConfig && paymentConfig.skip_payment;
            
            // 显示/隐藏跳过支付按钮
            const skipBtn = document.getElementById('skipPaymentBtn');
            if (isTestMode && skipPayment) {
                skipBtn.style.display = 'block';
            } else {
                skipBtn.style.display = 'none';
            }
            
            // 生成支付二维码
            if (paymentConfig && paymentConfig.qrcode_url) {
                // 使用配置的二维码URL
                document.getElementById('paymentQrcode').src = paymentConfig.qrcode_url;
            } else {
                // 使用订单号生成临时测试二维码
                const qrContent = orderNumbers.length > 0 ? orderNumbers[0] : `order:${orderId}`;
                generateQrcode(qrContent);
            }
            
            document.getElementById('paymentModal').style.display = 'flex';
            
            // 开始轮询检查支付状态
            startPaymentCheck(orderNumbers);
        }
        
        function generateQrcode(content) {
            // 使用qrcode.js生成二维码（需要引入qrcode库）
            // 这里使用在线API生成二维码
            const qrcodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(content)}`;
            document.getElementById('paymentQrcode').src = qrcodeUrl;
        }
        
        function startPaymentCheck(orderNumbers) {
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
            }
            
            paymentCheckInterval = setInterval(() => {
                checkPaymentStatus(orderNumbers);
            }, 2000); // 每2秒检查一次
        }
        
        function checkPaymentStatus(orderNumbers) {
            if (orderNumbers.length === 0) return;
            
            fetch('/admin/photo-selection/' + orderId + '/check-payment?orders=' + orderNumbers.join(','), {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data.paid) {
                    // 支付成功
                    document.getElementById('paymentStatus').textContent = '支付成功！正在开始打印...';
                    document.getElementById('paymentStatus').className = 'payment-status success';
                    
                    if (paymentCheckInterval) {
                        clearInterval(paymentCheckInterval);
                        paymentCheckInterval = null;
                    }
                    
                    // 触发打印
                    triggerPrint(orderNumbers).then(() => {
                        // 2秒后关闭模态框并跳转
                        setTimeout(() => {
                            closePaymentModal();
                            window.location.href = '/admin/photo-selection';
                        }, 2000);
                    }).catch(error => {
                        console.error('打印失败:', error);
                        alert('支付成功，但打印失败，请手动处理');
                        setTimeout(() => {
                            closePaymentModal();
                            window.location.href = '/admin/photo-selection';
                        }, 2000);
                    });
                }
            })
            .catch(error => {
                console.error('检查支付状态失败:', error);
            });
        }
        
        // 触发打印
        async function triggerPrint(orderNumbers) {
            try {
                const response = await fetch('/admin/photo-selection/' + orderId + '/start-print', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        order_numbers: orderNumbers
                    })
                });
                const result = await response.json();
                if (result.success) {
                    console.log('打印任务已启动');
                    return Promise.resolve();
                } else {
                    return Promise.reject(new Error(result.message || '打印失败'));
                }
            } catch (error) {
                return Promise.reject(error);
            }
        }
        
        // 跳过支付（测试模式）
        function skipPayment() {
            if (!paymentConfig || !paymentConfig.skip_payment) {
                alert('当前不是测试模式，无法跳过支付');
                return;
            }
            
            // 调用后端接口标记为已支付
            fetch('/admin/photo-selection/' + orderId + '/skip-payment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    order_numbers: shopOrderNumbers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 模拟支付成功
                    document.getElementById('paymentStatus').textContent = '支付成功！正在开始打印...';
                    document.getElementById('paymentStatus').className = 'payment-status success';
                    
                    if (paymentCheckInterval) {
                        clearInterval(paymentCheckInterval);
                        paymentCheckInterval = null;
                    }
                    
                    // 触发打印
                    triggerPrint(shopOrderNumbers).then(() => {
                        setTimeout(() => {
                            closePaymentModal();
                            window.location.href = '/admin/photo-selection';
                        }, 2000);
                    }).catch(error => {
                        console.error('打印失败:', error);
                        alert('支付成功，但打印失败，请手动处理');
                        setTimeout(() => {
                            closePaymentModal();
                            window.location.href = '/admin/photo-selection';
                        }, 2000);
                    });
                } else {
                    alert(data.message || '跳过支付失败');
                }
            })
            .catch(error => {
                console.error('跳过支付失败:', error);
                alert('跳过支付失败，请重试');
            });
        }
        
        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
                paymentCheckInterval = null;
            }
        }
        
        initPage();
    </script>
</body>
</html>
