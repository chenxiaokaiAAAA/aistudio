<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIä»»åŠ¡ç®¡ç† - {{ brand_name }}åå°</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <style>
        body {
            background: #000000;
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        .navbar-custom {
            background: #0a0a0a !important;
            border-bottom: 1px solid #1a1a1a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .navbar-brand, .nav-link {
            color: #e0e0e0 !important;
        }
        
        .nav-link:hover {
            color: #ffffff !important;
        }
        
        .nav-link.active {
            color: #ffffff !important;
            font-weight: 600;
        }
        
        .main-content {
            margin-top: 80px;
            padding: 20px;
        }
        
        .card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        
        .card-header {
            background: #050505;
            border-bottom: 1px solid #1a1a1a;
            border-radius: 8px 8px 0 0 !important;
            color: #e0e0e0;
            padding: 0.75rem 1rem;
        }
        .card-header h5 {
            font-size: 1rem;
            margin: 0;
        }
        
        .btn-primary {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #ffffff;
        }
        
        .btn-primary:hover {
            background: #2a2a2a;
            border-color: #3a3a3a;
        }
        
        .btn-outline-primary {
            border-color: #2a2a2a;
            color: #b0b0b0;
        }
        
        .btn-outline-primary:hover {
            background: #1a1a1a;
            border-color: #2a2a2a;
            color: #ffffff;
        }
        
        .btn-outline-danger {
            border-color: #2a2a2a;
            color: #b0b0b0;
        }
        
        .btn-outline-danger:hover {
            background: #2a2a2a;
            border-color: #3a3a3a;
            color: #ffffff;
        }
        
        .form-control {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            color: #e0e0e0;
        }
        
        .form-control:focus {
            background: #0a0a0a;
            border-color: #3a3a3a;
            color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.05);
        }
        
        .form-control::placeholder {
            color: #666666;
        }
        
        .form-select {
            background-color: #0a0a0a !important;
            color: #e0e0e0 !important;
            border-color: #1a1a1a !important;
        }
        
        .table {
            color: #e0e0e0;
        }
        
        .table thead {
            background: #050505;
        }
        
        .table thead th {
            border-bottom: 2px solid #1a1a1a;
            color: #b0b0b0;
            padding: 0.5rem;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .table tbody tr {
            border-bottom: 1px solid #1a1a1a;
        }
        
        .table tbody td {
            padding: 0.5rem;
            font-size: 0.85rem;
            vertical-align: middle;
        }
        
        .table tbody tr:hover {
            background: #0f0f0f;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #0a0a0a;
            color: #b0b0b0;
            border: 1px solid #1a1a1a;
        }
        
        .status-processing {
            background: #0a1a1a;
            color: #7ab8d9;
            border: 1px solid #1a2a2a;
        }
        
        .status-completed {
            background: #0a1a0a;
            color: #7ab99a;
            border: 1px solid #1a2a1a;
        }
        
        .status-success {
            background: #0a1a0a;
            color: #7ab99a;
            border: 1px solid #1a2a1a;
        }
        
        .status-failed {
            background: #1a0a0a;
            color: #d97a7a;
            border: 1px solid #2a1a1a;
        }
        
        .status-timeout {
            background: #1a1a0a;
            color: #d9b87a;
            border: 1px solid #2a2a1a;
        }
        
        .status-cancelled {
            background: #0a0a0a;
            color: #666666;
            border: 1px solid #1a1a1a;
        }
        
        .image-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #1a1a1a;
        }
        
        .image-thumbnail:hover {
            border-color: #3a3a3a;
            opacity: 0.8;
        }
        
        .modal-content {
            background: #0a0a0a;
            color: #e0e0e0;
            border: 1px solid #1a1a1a;
        }
        
        .modal-header {
            border-bottom: 1px solid #1a1a1a;
            background: #050505;
        }
        
        .modal-footer {
            border-top: 1px solid #1a1a1a;
            background: #050505;
        }
        
        .close {
            color: #b0b0b0;
            opacity: 0.8;
        }
        
        .close:hover {
            color: #ffffff;
            opacity: 1;
        }
        
        .pagination .page-link {
            background: #0a0a0a;
            border-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        .pagination .page-link:hover {
            background: #1a1a1a;
            border-color: #2a2a2a;
            color: #ffffff;
        }
        
        .pagination .page-item.active .page-link {
            background: #1a1a1a;
            border-color: #2a2a2a;
        }
        
        .filter-section {
            background: #050505;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #1a1a1a;
        }
        .filter-section .row {
            margin-bottom: 0;
        }
        .filter-section .form-label {
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }
        .filter-section .form-select,
        .filter-section .form-control {
            font-size: 0.9rem;
            padding: 0.4rem 0.75rem;
        }
        
        .text-muted {
            color: #666666 !important;
        }
        
        .alert-danger {
            background: #1a0a0a;
            border-color: #2a1a1a;
            color: #d97a7a;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    {% include 'admin/_navbar.html' %}

    <div class="main-content">
        <div class="container-fluid">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">ğŸ¤– AIä»»åŠ¡ç®¡ç†</h5>
                <button class="btn btn-primary btn-sm" onclick="refreshTasks()">
                    <i class="fas fa-sync-alt"></i> åˆ·æ–°
                </button>
            </div>

            <!-- ç­›é€‰åŒºåŸŸ -->
            <div class="filter-section">
                <div class="row g-2">
                    <div class="col-md-2">
                        <label class="form-label">çŠ¶æ€ç­›é€‰</label>
                        <select class="form-select" id="statusFilter" onchange="filterTasks()">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="pending">å¾…å¤„ç†</option>
                            <option value="processing">å¤„ç†ä¸­</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="failed">å¤±è´¥</option>
                            <option value="cancelled">å·²å–æ¶ˆ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">è®¢å•å·</label>
                        <input type="text" class="form-control" id="orderNumberFilter" placeholder="è¾“å…¥è®¢å•å·" onkeyup="filterTasks()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">å›¾ç‰‡æ¥æº</label>
                        <select class="form-select" id="imageTypeFilter" onchange="filterTasks()">
                            <option value="">å…¨éƒ¨</option>
                            <option value="original">åŸå›¾</option>
                            <option value="retouched">ç¾é¢œå</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">å¼€å§‹æ—¶é—´</label>
                        <input type="datetime-local" class="form-control" id="startDateFilter" onchange="filterTasks()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ç»“æŸæ—¶é—´</label>
                        <input type="datetime-local" class="form-control" id="endDateFilter" onchange="filterTasks()">
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ä»»åŠ¡åˆ—è¡¨</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>ä»»åŠ¡ID</th>
                                    <th>è®¢å•å·</th>
                                    <th>å·¥ä½œæµ</th>
                                    <th>APIæœåŠ¡å•†</th>
                                    <th>è¾“å…¥å›¾ç‰‡</th>
                                    <th>è¾“å‡ºå›¾ç‰‡</th>
                                    <th>çŠ¶æ€</th>
                                    <th>å¤‡æ³¨</th>
                                    <th>å®Œæˆè€—æ—¶ï¼ˆç§’ï¼‰</th>
                                    <th>è¯·æ±‚å‚æ•°</th>
                                    <th>ç»“æœæ•°æ®</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>å®Œæˆæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTableBody">
                                <tr>
                                    <td colspan="14" class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- åˆ†é¡µ -->
                    <nav aria-label="ä»»åŠ¡åˆ—è¡¨åˆ†é¡µ" class="mt-3">
                        <ul class="pagination justify-content-center mb-0" id="pagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="modal fade" id="imagePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å›¾ç‰‡é¢„è§ˆ</h5>
                    <button type="button" class="close" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <img id="previewImage" src="" alt="é¢„è§ˆå›¾ç‰‡" class="img-fluid">
                </div>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <!-- æ•°æ®æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="modal fade" id="dataModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: #0a0a0a; border: 1px solid #1a1a1a;">
                <div class="modal-header" style="border-bottom: 1px solid #1a1a1a;">
                    <h5 class="modal-title" id="dataModalTitle" style="color: #e0e0e0;">æ•°æ®è¯¦æƒ…</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="dataModalContent" style="color: #e0e0e0;">
                </div>
                <div class="modal-footer" style="border-top: 1px solid #1a1a1a;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="taskDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ä»»åŠ¡è¯¦æƒ…</h5>
                    <button type="button" class="close" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="taskDetailContent">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    {% include 'admin/_ux_scripts.html' %}
    <script>
        let currentPage = 1;
        let currentFilters = {};

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
            // åå°å·²æœ‰è‡ªåŠ¨è½®è¯¢æœåŠ¡ï¼Œå‰ç«¯ä¸å†è‡ªåŠ¨åˆ·æ–°
            // setInterval(loadTasks, 30000);
        });

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks(page = 1) {
            currentPage = page;
            const filters = getFilters();
            currentFilters = filters;
            
            const params = new URLSearchParams({
                page: page,
                per_page: 10,
                ...filters
            });
            
            try {
                const response = await fetch(`/admin/ai/api/tasks?${params}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    renderTasks(data.data.tasks || data.data);
                    const total = data.data.total || data.total || 0;
                    const pages = data.data.pages || data.pages || 1;
                    const page = data.data.page || data.page || 1;
                    renderPagination(total, pages, page);
                } else {
                    showError('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                showError('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // è·å–ç­›é€‰æ¡ä»¶
        function getFilters() {
            const filters = {};
            const status = document.getElementById('statusFilter').value;
            const orderNumber = document.getElementById('orderNumberFilter').value;
            const imageType = document.getElementById('imageTypeFilter').value;
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;
            
            if (status) filters.status = status;
            if (orderNumber) filters.order_number = orderNumber;
            if (imageType) filters.image_type = imageType;
            if (startDate) filters.start_date = startDate;
            if (endDate) filters.end_date = endDate;
            
            return filters;
        }

        // ç­›é€‰ä»»åŠ¡
        function filterTasks() {
            loadTasks(1);
        }

        // åˆ·æ–°ä»»åŠ¡
        function refreshTasks() {
            loadTasks(currentPage);
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        // ä¿å­˜å½“å‰ä»»åŠ¡åˆ—è¡¨ï¼ˆç”¨äºæŸ¥çœ‹è¯¦æƒ…ï¼‰
        let currentTasks = [];
        
        function renderTasks(tasks) {
            const tbody = document.getElementById('tasksTableBody');
            
            // ä¿å­˜å½“å‰ä»»åŠ¡åˆ—è¡¨
            currentTasks = tasks;
            
            if (tasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="14" class="text-center text-muted py-4">
                            æš‚æ— ä»»åŠ¡æ•°æ®
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = tasks.map(task => {
                const statusClass = `status-${task.status}`;
                const statusText = {
                    'pending': 'å¾…å¤„ç†',
                    'processing': 'å¤„ç†ä¸­',
                    'completed': 'å·²å®Œæˆ',
                    'success': 'æˆåŠŸ',
                    'failed': 'å¤±è´¥',
                    'timeout': 'è¶…æ—¶',
                    'cancelled': 'å·²å–æ¶ˆ'
                }[task.status] || task.status;
                
                // å¤„ç†è¾“å…¥å›¾ç‰‡è·¯å¾„ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼šURLã€ç›¸å¯¹è·¯å¾„ã€ç»å¯¹è·¯å¾„ï¼‰
                let inputImageUrl = '';
                if (task.input_image_path) {
                    if (task.input_image_path.startsWith('http://') || task.input_image_path.startsWith('https://')) {
                        inputImageUrl = task.input_image_path;
                    } else if (task.input_image_path.startsWith('/')) {
                        inputImageUrl = task.input_image_path;
                    } else if (task.input_image_path.includes('/uploads/') || task.input_image_path.includes('\\uploads\\') || task.input_image_path.includes('/media/')) {
                        // ç»Ÿä¸€è·¯å¾„æ ¼å¼ï¼ˆå°†åæ–œæ è½¬ä¸ºæ­£æ–œæ ï¼‰
                        let normalizedPath = task.input_image_path.replace(/\\/g, '/');
                        inputImageUrl = normalizedPath.startsWith('/') ? normalizedPath : '/' + normalizedPath;
                        // å¦‚æœæ˜¯uploadsè·¯å¾„ï¼Œè½¬æ¢ä¸ºmediaè·¯å¾„ï¼ˆç¼–ç æ–‡ä»¶åé¿å…ç©ºæ ¼ç­‰å¯¼è‡´404ï¼‰
                        if (inputImageUrl.includes('/uploads/')) {
                            const filename = inputImageUrl.split('/').pop();
                            inputImageUrl = `/media/original/${encodeURIComponent(filename)}`;
                        }
                    } else {
                        // å¤„ç†Windowsè·¯å¾„ï¼ˆåæ–œæ ï¼‰
                        const normalizedPath = task.input_image_path.replace(/\\/g, '/');
                        const filename = normalizedPath.split('/').pop();
                        inputImageUrl = `/media/original/${encodeURIComponent(filename)}`;
                    }
                }
                const inputImage = inputImageUrl ? 
                    `<img src="${inputImageUrl}" class="image-thumbnail" onclick="previewImage(this.src)" onerror="this.style.display='none'">` : 
                    '<span class="text-muted">-</span>';
                
                // å¤„ç†è¾“å‡ºå›¾ç‰‡è·¯å¾„ï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
                let outputImageUrl = '';
                if (task.output_image_path) {
                    if (task.output_image_path.startsWith('http://') || task.output_image_path.startsWith('https://')) {
                        outputImageUrl = task.output_image_path;
                    } else if (task.output_image_path.startsWith('/')) {
                        outputImageUrl = task.output_image_path;
                    } else if (task.output_image_path.includes('/uploads/') || task.output_image_path.includes('/media/')) {
                        // ç»Ÿä¸€è·¯å¾„æ ¼å¼ï¼ˆå°†åæ–œæ è½¬ä¸ºæ­£æ–œæ ï¼‰
                        let normalizedPath = task.output_image_path.replace(/\\/g, '/');
                        outputImageUrl = normalizedPath.startsWith('/') ? normalizedPath : '/' + normalizedPath;
                        // å¦‚æœæ˜¯final_worksè·¯å¾„ï¼Œè½¬æ¢ä¸ºmedia/finalè·¯å¾„ï¼ˆç¼–ç æ–‡ä»¶åé¿å…ç©ºæ ¼ç­‰å¯¼è‡´404ï¼‰
                        if (outputImageUrl.includes('/final_works/') || outputImageUrl.includes('\\final_works\\')) {
                            const filename = outputImageUrl.split('/').pop();
                            outputImageUrl = `/media/final/${encodeURIComponent(filename)}`;
                        }
                    } else {
                        // å¤„ç†Windowsè·¯å¾„ï¼ˆåæ–œæ ï¼‰å’Œfinal_worksè·¯å¾„
                        const normalizedPath = task.output_image_path.replace(/\\/g, '/');
                        const filename = normalizedPath.split('/').pop();
                        outputImageUrl = `/media/final/${encodeURIComponent(filename)}`;
                    }
                }
                const outputImage = outputImageUrl ? 
                    `<img src="${outputImageUrl}" class="image-thumbnail" onclick="previewImage(this.src)" onerror="this.style.display='none'">` : 
                    '<span class="text-muted">-</span>';
                
                // å®Œæˆæ—¶é—´ï¼ˆä½¿ç”¨completed_atï¼‰
                const completedTime = task.completed_at ? 
                    new Date(task.completed_at).toLocaleString('zh-CN') : 
                    '-';
                
                const createdTime = task.created_at ? 
                    new Date(task.created_at).toLocaleString('zh-CN') : 
                    '-';
                
                // å¤‡æ³¨ï¼ˆæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å’Œé‡è¯•ä¿¡æ¯ï¼‰
                let remarkText = '';
                if (task.notes && task.notes.includes('ã€è‡ªåŠ¨é‡è¯•')) {
                    // æå–é‡è¯•ä¿¡æ¯ï¼ˆæ”¯æŒå¤šè¡Œï¼‰
                    const retryLines = task.notes.split('\n').filter(line => line.includes('ã€è‡ªåŠ¨é‡è¯•'));
                    if (retryLines.length > 0) {
                        // æ˜¾ç¤ºæ‰€æœ‰é‡è¯•è®°å½•
                        remarkText = retryLines.join('; ');
                    }
                }
                if (task.error_message) {
                    if (remarkText) {
                        remarkText = `${remarkText} | ${task.error_message}`;
                    } else {
                        remarkText = task.error_message;
                    }
                }
                const remark = remarkText ? 
                    `<span class="text-danger" title="${remarkText}">${remarkText.length > 50 ? remarkText.substring(0, 50) + '...' : remarkText}</span>` : 
                    '-';
                
                let actionButtons = '';
                if (task.status === 'failed') {
                    // å¤±è´¥çŠ¶æ€ï¼šå¦‚æœæœ‰task_idï¼Œæ˜¾ç¤º"é‡æ–°è·å–"ï¼ˆå¯ä¿®å¤å¤±è´¥çŠ¶æ€çš„ä»»åŠ¡ï¼‰ï¼›å¦åˆ™æ˜¾ç¤º"é‡è¯•"
                    actionButtons = `
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewTaskDetail(${task.id})">
                            <i class="fas fa-info-circle"></i> è¯¦æƒ…
                        </button>
                        ${task.task_id ? `
                        <button class="btn btn-sm btn-outline-success" onclick="recheckTaskResult('${task.task_id}')" title="é‡æ–°è·å–ç»“æœï¼ˆå¯ä¿®å¤å¤±è´¥çŠ¶æ€ï¼‰">
                            <i class="fas fa-sync"></i> é‡æ–°è·å–
                        </button>
                        ` : `
                        <button class="btn btn-sm btn-outline-primary" onclick="retryTask(${task.id})">
                            <i class="fas fa-redo"></i> é‡è¯•
                        </button>
                        `}
                    `;
                } else if (task.status === 'pending' && !task.input_image_path && !task.task_id) {
                    // åªæœ‰åœ¨pendingçŠ¶æ€ã€æ²¡æœ‰è¾“å…¥å›¾ç‰‡ã€ä¸”æ²¡æœ‰task_idï¼ˆAPIä»»åŠ¡IDï¼‰çš„æƒ…å†µä¸‹ï¼Œæ‰æ˜¾ç¤º"ä¸Šä¼ "æŒ‰é’®
                    // å¦‚æœæœ‰task_idï¼Œè¯´æ˜æ˜¯APIä»»åŠ¡ï¼Œåº”è¯¥æ˜¾ç¤º"é‡æ–°è·å–"æŒ‰é’®
                    actionButtons = `
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewTaskDetail(${task.id})">
                            <i class="fas fa-info-circle"></i> è¯¦æƒ…
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="uploadTaskImage(${task.id})">
                            <i class="fas fa-upload"></i> ä¸Šä¼ 
                        </button>
                    `;
                } else {
                    // å…¶ä»–æƒ…å†µï¼šæ˜¾ç¤º"è¯¦æƒ…"å’Œ"é‡æ–°è·å–"ï¼ˆå¦‚æœæœ‰task_idä¸”æœªå®Œæˆï¼‰
                    actionButtons = `
                        <button class="btn btn-sm btn-outline-primary" onclick="viewTaskDetail(${task.id})">
                            <i class="fas fa-info-circle"></i> è¯¦æƒ…
                        </button>
                        ${task.task_id && task.status !== 'completed' ? `
                        <button class="btn btn-sm btn-outline-success ms-1" onclick="recheckTaskResult('${task.task_id}')" title="é‡æ–°è·å–ç»“æœ">
                            <i class="fas fa-sync"></i> é‡æ–°è·å–
                        </button>
                        ` : ''}
                    `;
                }
                
                // å¤„ç†è®¢å•é“¾æ¥ï¼ˆæµ‹è¯•è®¢å•order_id=0æ—¶æ˜¾ç¤ºç‰¹æ®Šé“¾æ¥ï¼‰
                const orderLink = task.order_id && task.order_id !== 0
                    ? `<a href="/admin/order/${task.order_id}" class="text-decoration-none" style="color: #b0b0b0;">${task.order_number}</a>`
                    : `<span class="text-muted">${task.order_number || 'æµ‹è¯•ä»»åŠ¡'}</span>`;
                
                // APIæœåŠ¡å•†ï¼ˆåªæ˜¾ç¤ºå‰10ä¸ªå­—ç¬¦ï¼‰
                const apiProviderFull = task.api_provider_name || '-';
                const apiProvider = apiProviderFull !== '-' && apiProviderFull.length > 10 ? 
                    `<span title="${apiProviderFull}">${apiProviderFull.substring(0, 10)}...</span>` : 
                    apiProviderFull;
                
                // ä»»åŠ¡IDï¼ˆåªæ˜¾ç¤ºå‰10ä¸ªå­—ç¬¦ï¼‰
                const taskIdFull = task.task_id || task.id;
                const taskIdDisplay = taskIdFull.toString().length > 10 ? 
                    `<code style="color: #b0b0b0; font-size: 0.85em;" title="${taskIdFull}">${taskIdFull.toString().substring(0, 10)}...</code>` : 
                    `<code style="color: #b0b0b0; font-size: 0.85em;">${taskIdFull}</code>`;
                
                // å®Œæˆè€—æ—¶
                const duration = task.duration_seconds !== null && task.duration_seconds !== undefined
                    ? `${task.duration_seconds}ç§’`
                    : '-';
                
                // è¯·æ±‚å‚æ•°ï¼ˆæ˜¾ç¤ºä¸ºå¯ç‚¹å‡»çš„æŒ‰é’®ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼‰
                const requestParamsBtn = task.request_params
                    ? `<button class="btn btn-sm btn-outline-info" onclick="showRequestParams(${task.id})" title="æŸ¥çœ‹è¯·æ±‚å‚æ•°">
                        <i class="fas fa-code"></i> æŸ¥çœ‹
                    </button>`
                    : '<span class="text-muted">-</span>';
                
                // ç»“æœæ•°æ®ï¼ˆæ˜¾ç¤ºä¸ºå¯ç‚¹å‡»çš„æŒ‰é’®ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼‰
                const responseDataBtn = task.response_data
                    ? `<button class="btn btn-sm btn-outline-success" onclick="showResponseData(${task.id})" title="æŸ¥çœ‹ç»“æœæ•°æ®">
                        <i class="fas fa-database"></i> æŸ¥çœ‹
                    </button>`
                    : '<span class="text-muted">-</span>';
                
                return `
                    <tr>
                        <td>${taskIdDisplay}</td>
                        <td>${orderLink}</td>
                        <td>${task.workflow_name || '-'}</td>
                        <td>${apiProvider}</td>
                        <td>${inputImage}</td>
                        <td>${outputImage}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${remark}</td>
                        <td>${duration}</td>
                        <td>${requestParamsBtn}</td>
                        <td>${responseDataBtn}</td>
                        <td>${createdTime}</td>
                        <td>${completedTime}</td>
                        <td>${actionButtons}</td>
                    </tr>
                `;
            }).join('');
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(total, pages, current) {
            const pagination = document.getElementById('pagination');
            
            if (pages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // ä¸Šä¸€é¡µ
            html += `
                <li class="page-item ${current === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadTasks(${current - 1}); return false;">ä¸Šä¸€é¡µ</a>
                </li>
            `;
            
            // é¡µç 
            for (let i = 1; i <= pages; i++) {
                if (i === 1 || i === pages || (i >= current - 2 && i <= current + 2)) {
                    html += `
                        <li class="page-item ${i === current ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadTasks(${i}); return false;">${i}</a>
                        </li>
                    `;
                } else if (i === current - 3 || i === current + 3) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            // ä¸‹ä¸€é¡µ
            html += `
                <li class="page-item ${current === pages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadTasks(${current + 1}); return false;">ä¸‹ä¸€é¡µ</a>
                </li>
            `;
            
            pagination.innerHTML = html;
        }

        // é¢„è§ˆå›¾ç‰‡
        function previewImage(src) {
            document.getElementById('previewImage').src = src;
            const modal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
            modal.show();
        }
        
        // é¢„è§ˆå›¾ç‰‡ï¼ˆç”¨äºä»»åŠ¡è¯¦æƒ…é¡µé¢ï¼‰
        function previewImageModal(imageUrl) {
            previewImage(imageUrl);
        }

        // æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
        async function viewTaskDetail(taskId) {
            const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            const content = document.getElementById('taskDetailContent');
            content.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...</div>';
            modal.show();
            
            try {
                const response = await fetch(`/admin/ai/api/tasks/${taskId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const task = data.data;
                    renderTaskDetail(task);
                } else {
                    content.innerHTML = `<div class="alert alert-danger">åŠ è½½å¤±è´¥: ${data.message}</div>`;
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
                content.innerHTML = '<div class="alert alert-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }

        // æ¸²æŸ“ä»»åŠ¡è¯¦æƒ…
        function renderTaskDetail(task) {
            const content = document.getElementById('taskDetailContent');
            
            const statusText = {
                'pending': 'å¾…å¤„ç†',
                'processing': 'å¤„ç†ä¸­',
                'completed': 'å·²å®Œæˆ',
                'success': 'æˆåŠŸ',
                'failed': 'å¤±è´¥',
                'timeout': 'è¶…æ—¶',
                'cancelled': 'å·²å–æ¶ˆ'
            }[task.status] || task.status;
            
            const statusClass = `status-${task.status}`;
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>åŸºæœ¬ä¿¡æ¯</h6>
                        <table class="table table-sm">
                            <tr>
                                <td style="width: 120px; color: #888888;">è®¢å•å·</td>
                                <td><a href="/admin/order/${task.order_id}" style="color: #b0b0b0;">${task.order_number}</a></td>
                            </tr>
                            <tr>
                                <td style="color: #888888;">å·¥ä½œæµåç§°</td>
                                <td>${task.workflow_name || '-'}</td>
                            </tr>
                            <tr>
                                <td style="color: #888888;">å·¥ä½œæµæ–‡ä»¶</td>
                                <td>${task.workflow_file || '-'}</td>
                            </tr>
                            <tr>
                                <td style="color: #888888;">é£æ ¼åˆ†ç±»</td>
                                <td>${task.style_category_name || '-'}</td>
                            </tr>
                            <tr>
                                <td style="color: #888888;">é£æ ¼å›¾ç‰‡</td>
                                <td>${task.style_image_name || '-'}</td>
                            </tr>
                            <tr>
                                <td style="color: #888888;">çŠ¶æ€</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                            </tr>
                            <tr>
                                <td style="color: #888888;">åˆ›å»ºæ—¶é—´</td>
                                <td>${task.created_at ? new Date(task.created_at).toLocaleString('zh-CN') : '-'}</td>
                            </tr>
                            <tr>
                                <td style="color: #888888;">å¼€å§‹æ—¶é—´</td>
                                <td>${task.started_at ? new Date(task.started_at).toLocaleString('zh-CN') : '-'}</td>
                            </tr>
                            <tr>
                                <td style="color: #888888;">å®Œæˆæ—¶é—´</td>
                                <td>${task.completed_at ? new Date(task.completed_at).toLocaleString('zh-CN') : '-'}</td>
                            </tr>
                            <tr>
                                <td style="color: #888888;">å®Œæˆæ—¶é—´</td>
                                <td>${task.completed_at ? new Date(task.completed_at).toLocaleString('zh-CN') : '-'}</td>
                            </tr>
                            <tr>
                                <td style="color: #888888;">é‡è¯•æ¬¡æ•°</td>
                                <td>${task.retry_count || 0}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>å›¾ç‰‡ä¿¡æ¯</h6>
                        <div class="mb-3">
                            <label class="form-label" style="color: #888888;">è¾“å…¥å›¾ç‰‡</label>
                            ${(() => {
                                if (!task.input_image_path) {
                                    return '<div class="text-muted">æœªä¸Šä¼ </div>';
                                }
                                // å¤„ç†è¾“å…¥å›¾ç‰‡è·¯å¾„
                                let inputImageUrl = '';
                                const inputPath = task.input_image_path;
                                if (inputPath.startsWith('http://') || inputPath.startsWith('https://')) {
                                    inputImageUrl = inputPath;
                                } else if (inputPath.startsWith('/')) {
                                    inputImageUrl = inputPath;
                                } else if (inputPath.includes('uploads/')) {
                                    // ä»å®Œæ•´è·¯å¾„ä¸­æå–æ–‡ä»¶åï¼ˆç¼–ç é¿å…404ï¼‰
                                    const filename = inputPath.split('/').pop();
                                    inputImageUrl = `/media/original/${encodeURIComponent(filename)}`;
                                } else {
                                    // ç›´æ¥ä½¿ç”¨æ–‡ä»¶å
                                    const filename = inputPath.split('/').pop();
                                    inputImageUrl = `/media/original/${encodeURIComponent(filename)}`;
                                }
                                return `
                                    <div>
                                        <img src="${inputImageUrl}" 
                                             class="img-fluid rounded mb-2" 
                                             style="max-height: 200px; cursor: pointer; border: 1px solid #333;" 
                                             onclick="previewImageModal('${inputImageUrl}')"
                                             onerror="this.onerror=null; this.src='/static/img/placeholder.png'; this.style.cursor='default';">
                                        <div><small class="text-muted">${task.input_image_path}</small></div>
                                    </div>
                                `;
                            })()}
                        </div>
                        <div class="mb-3">
                            <label class="form-label" style="color: #888888;">è¾“å‡ºå›¾ç‰‡</label>
                            ${(() => {
                                if (!task.output_image_path) {
                                    return '<div class="text-muted">æœªç”Ÿæˆ</div>';
                                }
                                // å¤„ç†è¾“å‡ºå›¾ç‰‡è·¯å¾„
                                let outputImageUrl = '';
                                const outputPath = task.output_image_path;
                                if (outputPath.startsWith('http://') || outputPath.startsWith('https://')) {
                                    outputImageUrl = outputPath;
                                } else if (outputPath.startsWith('/')) {
                                    outputImageUrl = outputPath;
                                } else if (outputPath.includes('final_works/') || outputPath.includes('final works/') || outputPath.includes('final_works\\') || outputPath.includes('final works\\')) {
                                    // ç»Ÿä¸€è·¯å¾„æ ¼å¼ï¼ˆå°†åæ–œæ è½¬ä¸ºæ­£æ–œæ ï¼‰ï¼Œç¼–ç æ–‡ä»¶åé¿å…404
                                    const normalizedPath = outputPath.replace(/\\/g, '/');
                                    const filename = normalizedPath.split('/').pop();
                                    outputImageUrl = `/media/final/${encodeURIComponent(filename)}`;
                                } else {
                                    const normalizedPath = outputPath.replace(/\\/g, '/');
                                    const filename = normalizedPath.split('/').pop();
                                    outputImageUrl = `/media/final/${encodeURIComponent(filename)}`;
                                }
                                return `
                                    <div>
                                        <img src="${outputImageUrl}" 
                                             class="img-fluid rounded mb-2" 
                                             style="max-height: 200px; cursor: pointer; border: 1px solid #333;" 
                                             onclick="previewImageModal('${outputImageUrl}')"
                                             onerror="this.onerror=null; this.src='/static/img/placeholder.png'; this.style.cursor='default';">
                                        <div><small class="text-muted">${task.output_image_path}</small></div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                </div>
                ${task.error_message ? `
                    <div class="alert alert-danger mt-3">
                        <h6>é”™è¯¯ä¿¡æ¯</h6>
                        <pre style="background: #050505; color: #d97a7a; padding: 10px; border-radius: 4px; border: 1px solid #2a1a1a;">${task.error_message}</pre>
                    </div>
                ` : ''}
                ${task.status === 'failed' ? `
                    <div class="mt-3 text-end">
                        <button class="btn btn-primary" onclick="retryTask(${task.id}); bootstrap.Modal.getInstance(document.getElementById('taskDetailModal')).hide();">
                            <i class="fas fa-redo"></i> é‡æ–°å¤„ç†
                        </button>
                    </div>
                ` : ''}
            `;
        }

        // é‡æ–°å¤„ç†ä»»åŠ¡
        async function retryTask(taskId) {
            if (!confirm('ç¡®å®šè¦é‡æ–°å¤„ç†è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`/admin/ai/api/tasks/${taskId}/retry`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('ä»»åŠ¡å·²é‡æ–°æäº¤å¤„ç†');
                    loadTasks(currentPage);
                } else {
                    alert('é‡æ–°å¤„ç†å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('é‡æ–°å¤„ç†å¤±è´¥:', error);
                alert('é‡æ–°å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ä¸Šä¼ ä»»åŠ¡å›¾ç‰‡
        function uploadTaskImage(taskId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch(`/admin/ai/api/tasks/${taskId}/upload-image`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        alert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ');
                        loadTasks(currentPage);
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥: ' + data.message);
                    }
                } catch (error) {
                    console.error('ä¸Šä¼ å¤±è´¥:', error);
                    alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            };
            input.click();
        }

        // é‡æ–°è·å–ä»»åŠ¡ç»“æœ
        async function recheckTaskResult(taskId) {
            if (!confirm('ç¡®å®šè¦é‡æ–°è·å–è¯¥ä»»åŠ¡çš„ç»“æœå—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/ai/api/tasks/recheck/${taskId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    alert('é‡æ–°è·å–æˆåŠŸï¼' + (data.message || ''));
                    // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                    loadTasks(currentPage);
                } else {
                    alert('é‡æ–°è·å–å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('é‡æ–°è·å–ä»»åŠ¡ç»“æœå¤±è´¥:', error);
                alert('é‡æ–°è·å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const tbody = document.getElementById('tasksTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="13" class="text-center text-danger py-4">
                        ${message}
                    </td>
                </tr>
            `;
        }
        
        // æ˜¾ç¤ºè¯·æ±‚å‚æ•°
        function showRequestParams(taskId) {
            // ä»ä»»åŠ¡åˆ—è¡¨ä¸­è·å–æ•°æ®
            const task = currentTasks.find(t => t.id === taskId);
            if (!task || !task.request_params) {
                alert('æ²¡æœ‰è¯·æ±‚å‚æ•°æ•°æ®');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('dataModal'));
            const title = document.getElementById('dataModalTitle');
            const content = document.getElementById('dataModalContent');
            
            title.textContent = 'è¯·æ±‚å‚æ•°';
            
            // è§£æè¯·æ±‚å‚æ•°ï¼Œç¡®ä¿URLå®Œæ•´æ˜¾ç¤º
            let requestParams = task.request_params;
            if (typeof requestParams === 'string') {
                try {
                    requestParams = JSON.parse(requestParams);
                } catch (e) {
                    console.error('è§£æè¯·æ±‚å‚æ•°å¤±è´¥:', e);
                }
            }
            
            // æ ¼å¼åŒ–JSONï¼Œç¡®ä¿URLå®Œæ•´æ˜¾ç¤ºï¼ˆä¸æˆªæ–­ï¼‰
            const formattedJson = JSON.stringify(requestParams, null, 2);
            
            // å¦‚æœåŒ…å«urlsæ•°ç»„ï¼Œå•ç‹¬æ˜¾ç¤ºæ¯ä¸ªURL
            let urlsSection = '';
            if (requestParams && requestParams.urls && Array.isArray(requestParams.urls)) {
                urlsSection = `
                    <div class="mb-3">
                        <h6 style="color: #4a9eff; margin-bottom: 10px;">å›¾ç‰‡URLåˆ—è¡¨ (å…± ${requestParams.urls.length} å¼ ):</h6>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${requestParams.urls.map((url, index) => `
                                <div class="mb-2 p-2" style="background: #1a1a1a; border-radius: 4px; border-left: 3px solid #4a9eff;">
                                    <div style="color: #888; font-size: 11px; margin-bottom: 5px;">å›¾ç‰‡ ${index + 1}:</div>
                                    <a href="${url}" target="_blank" style="color: #4a9eff; word-break: break-all; text-decoration: none;">
                                        ${url}
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = `
                ${urlsSection}
                <div class="mt-3">
                    <h6 style="color: #4a9eff; margin-bottom: 10px;">å®Œæ•´è¯·æ±‚å‚æ•°:</h6>
                    <pre style="background: #0a0a0a; color: #e0e0e0; padding: 15px; border-radius: 4px; overflow-x: auto; overflow-y: auto; max-height: 500px; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;">${formattedJson}</pre>
                </div>
            `;
            modal.show();
        }
        
        // æ˜¾ç¤ºç»“æœæ•°æ®
        function showResponseData(taskId) {
            // ä»ä»»åŠ¡åˆ—è¡¨ä¸­è·å–æ•°æ®
            const task = currentTasks.find(t => t.id === taskId);
            if (!task || !task.response_data) {
                alert('æ²¡æœ‰ç»“æœæ•°æ®');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('dataModal'));
            const title = document.getElementById('dataModalTitle');
            const content = document.getElementById('dataModalContent');
            
            title.textContent = 'ç»“æœæ•°æ®';
            // å°è¯•æ ¼å¼åŒ–JSONï¼Œå¦‚æœä¸æ˜¯JSONåˆ™ç›´æ¥æ˜¾ç¤º
            let formattedData = task.response_data;
            try {
                const parsed = typeof task.response_data === 'string' ? JSON.parse(task.response_data) : task.response_data;
                formattedData = JSON.stringify(parsed, null, 2);
            } catch (e) {
                // ä¸æ˜¯JSONæ ¼å¼ï¼Œç›´æ¥æ˜¾ç¤º
            }
            
            content.innerHTML = `
                <pre style="background: #0a0a0a; color: #e0e0e0; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 500px; font-size: 12px;">${formattedData}</pre>
            `;
            modal.show();
        }
        
    </script>
</body>
</html>
