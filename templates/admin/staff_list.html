<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­ç”¨æˆ·ç®¡ç† - {{ franchisee.company_name }}</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin/dashboard">AIæ‹ç…§ç®¡ç†ç³»ç»Ÿ</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="nav-link">ç®¡ç†å‘˜: {{ current_user.username }}</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">é€€å‡ºç™»å½•</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ‘¥ å­ç”¨æˆ·ç®¡ç† - {{ franchisee.company_name }}</h2>
            <div class="btn-group">
                <a href="/staff-permission/franchisee/{{ franchisee.id }}/staff/add" class="btn btn-primary">
                    <i class="fas fa-plus"></i> æ·»åŠ å­ç”¨æˆ·
                </a>
                <a href="/franchisee/admin/accounts/{{ franchisee.id }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> è¿”å›è¯¦æƒ…
                </a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">å­ç”¨æˆ·åˆ—è¡¨</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    <strong>è¯´æ˜ï¼š</strong>å­ç”¨æˆ·ï¼ˆåº—å‘˜ï¼‰å¯ä»¥é€šè¿‡æ‰‹æœºå·æˆ–openidè¿›è¡ŒåŒ¹é…ï¼Œé…ç½®ä¸åŒçš„æƒé™ï¼ˆå¦‚æŸ¥çœ‹ä»Šå¤©çš„è®¢å•ã€æŸ¥çœ‹é—¨åº—å›¾ç‰‡ç­‰ï¼‰ã€‚
                    å»ºè®®ä¼˜å…ˆä½¿ç”¨æ‰‹æœºå·è¿›è¡ŒåŒ¹é…ï¼Œæ›´ä¾¿äºç®¡ç†ã€‚
                </div>
                {% if staff_users %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>å§“å</th>
                                <th>æ‰‹æœºå·</th>
                                <th>OpenID</th>
                                <th>è§’è‰²</th>
                                <th>æƒé™</th>
                                <th>çŠ¶æ€</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for staff in staff_users %}
                            <tr>
                                <td><strong>{{ staff.name or '-' }}</strong></td>
                                <td>{{ staff.phone or '-' }}</td>
                                <td><code style="font-size: 0.8rem;">{{ staff.openid[:20] + '...' if staff.openid and staff.openid|length > 20 else (staff.openid or '-') }}</code></td>
                                <td>{{ staff.role }}</td>
                                        <td>
                                            {% if staff.permissions %}
                                                {% set perms = staff.permissions|from_json %}
                                            {% else %}
                                                {% set perms = {} %}
                                            {% endif %}
                                            {% if perms.get('view_today_orders') %}
                                                <span class="badge bg-info">ä»Šæ—¥è®¢å•</span>
                                            {% endif %}
                                            {% if perms.get('view_store_images') %}
                                                <span class="badge bg-success">é—¨åº—å›¾ç‰‡</span>
                                            {% endif %}
                                            {% if perms.get('view_all_orders') %}
                                                <span class="badge bg-primary">å…¨éƒ¨è®¢å•</span>
                                            {% endif %}
                                            {% if perms.get('view_statistics') %}
                                                <span class="badge bg-warning">ç»Ÿè®¡æ•°æ®</span>
                                            {% endif %}
                                            {% if perms.get('groupon_verify') %}
                                                <span class="badge bg-danger">å›¢è´­æ ¸é”€</span>
                                            {% endif %}
                                            {% if not perms or (not perms.get('view_today_orders') and not perms.get('view_store_images') and not perms.get('view_all_orders') and not perms.get('view_statistics') and not perms.get('groupon_verify')) %}
                                                <span class="text-muted">æ— æƒé™</span>
                                            {% endif %}
                                        </td>
                                <td>
                                    {% if staff.status == 'active' %}
                                        <span class="badge bg-success">æ­£å¸¸</span>
                                    {% else %}
                                        <span class="badge bg-secondary">åœç”¨</span>
                                    {% endif %}
                                </td>
                                <td>{{ staff.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <a href="/staff-permission/franchisee/{{ franchisee.id }}/staff/{{ staff.id }}/edit" class="btn btn-sm btn-outline-warning">
                                        <i class="fas fa-edit"></i> ç¼–è¾‘
                                    </a>
                                    <form method="POST" action="/staff-permission/franchisee/{{ franchisee.id }}/staff/{{ staff.id }}/delete" 
                                          style="display: inline;" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¯¥å­ç”¨æˆ·å—ï¼Ÿ');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash"></i> åˆ é™¤
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <p class="text-muted">æš‚æ— å­ç”¨æˆ·</p>
                    <a href="/staff-permission/franchisee/{{ franchisee.id }}/staff/add" class="btn btn-primary">
                        <i class="fas fa-plus"></i> æ·»åŠ ç¬¬ä¸€ä¸ªå­ç”¨æˆ·
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
</body>
</html>
