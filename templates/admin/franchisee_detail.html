<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ account.company_name }} - åŠ ç›Ÿå•†è¯¦æƒ…</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 80px;
        }
        .navbar-custom {
            background: #0a0a0a !important;
            border-bottom: 1px solid #1a1a1a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .navbar-brand, .nav-link {
            color: #e0e0e0 !important;
        }
        .nav-link:hover {
            color: #ffffff !important;
        }
        .nav-link.active {
            color: #ffffff !important;
            font-weight: 600;
        }
        /* åº•éƒ¨æ ‡ç­¾é¡µä½¿ç”¨æ·±è‰²æ–‡å­—ï¼ˆèƒŒæ™¯æ˜¯ç™½è‰²ï¼‰ */
        #detailTabs.nav-tabs {
            background-color: #fff;
            border-bottom: 1px solid #dee2e6;
        }
        #detailTabs.nav-tabs .nav-link {
            color: #495057 !important;
            background-color: transparent;
        }
        #detailTabs.nav-tabs .nav-link:hover {
            color: #495057 !important;
            border-color: #e9ecef #e9ecef #dee2e6;
        }
        #detailTabs.nav-tabs .nav-link.active {
            color: #495057 !important;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }
        /* ç¡®ä¿card-headerä¸­çš„æŒ‰é’®å’Œæ–‡å­—æ­£å¸¸æ˜¾ç¤º */
        .card-header {
            background-color: #fff !important;
        }
        .card-header h5,
        .card-header .btn {
            color: inherit !important;
        }
        .card-header .btn-primary {
            color: #fff !important;
        }
        .info-card { border-left: 4px solid #007bff; }
        .quota-card { border-left: 4px solid #28a745; }
        .order-card { border-left: 4px solid #ffc107; }
        .recharge-card { border-left: 4px solid #17a2b8; }
        .status-active { color: #28a745; }
        .status-inactive { color: #6c757d; }
        .status-suspended { color: #dc3545; }
        /* è‡ªæ‹æœºè®¾å¤‡ç®¡ç†æ ·å¼å¢å¼º */
        .card-header h5 {
            color: #212529;
            font-weight: 600;
        }
        .btn-primary {
            color: #fff !important;
            font-weight: 500;
        }
        .btn-outline-warning {
            color: #856404 !important;
            font-weight: 500;
        }
        .btn-outline-danger {
            color: #721c24 !important;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    {% include 'admin/_navbar.html' %}

    <div class="container mt-4">
        <!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œæŒ‰é’® -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ¢ {{ account.company_name }} - è´¦æˆ·è¯¦æƒ…</h2>
            <div class="btn-group">
                <a href="/franchisee/admin/accounts/{{ account.id }}/edit" class="btn btn-warning">
                    <i class="fas fa-edit"></i> ç¼–è¾‘
                </a>
                <a href="/franchisee/admin/accounts/{{ account.id }}/recharge" class="btn btn-success">
                    <i class="fas fa-plus"></i> å……å€¼
                </a>
                <a href="/admin/photo-selection?franchisee_id={{ account.id }}" class="btn btn-primary">
                    <i class="fas fa-images"></i> é€‰ç‰‡ç³»ç»Ÿ
                </a>
                <button type="button" class="btn btn-info" onclick="previewQrcode({{ account.id }})">
                    <i class="fas fa-qrcode"></i> é¢„è§ˆäºŒç»´ç 
                </button>
                <a href="/franchisee/api/generate-qrcode/{{ account.id }}" class="btn btn-outline-primary">
                    <i class="fas fa-download"></i> ä¸‹è½½äºŒç»´ç 
                </a>
                <button type="button" class="btn btn-danger" onclick="confirmDelete({{ account.id }}, '{{ account.company_name }}')">
                    <i class="fas fa-trash"></i> åˆ é™¤
                </button>
                <a href="/franchisee/admin/accounts" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> è¿”å›åˆ—è¡¨
                </a>
            </div>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="col-md-6">
                <div class="card info-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless table-sm">
                            <tr>
                                <td><strong>ç”¨æˆ·å:</strong></td>
                                <td>{{ account.username }}</td>
                            </tr>
                            <tr>
                                <td><strong>å…¬å¸åç§°:</strong></td>
                                <td>{{ account.company_name }}</td>
                            </tr>
                            <tr>
                                <td><strong>è”ç³»äºº:</strong></td>
                                <td>{{ account.contact_person }}</td>
                            </tr>
                            <tr>
                                <td><strong>è”ç³»ç”µè¯:</strong></td>
                                <td>{{ account.contact_phone }}</td>
                            </tr>
                            <tr>
                                <td><strong>è”ç³»é‚®ç®±:</strong></td>
                                <td>{{ account.contact_email or 'æœªè®¾ç½®' }}</td>
                            </tr>
                            <tr>
                                <td><strong>çŠ¶æ€:</strong></td>
                                <td>
                                    {% if account.status == 'active' %}
                                        <span class="badge bg-success">æ­£å¸¸</span>
                                    {% elif account.status == 'inactive' %}
                                        <span class="badge bg-secondary">æœªæ¿€æ´»</span>
                                    {% else %}
                                        <span class="badge bg-danger">å·²æš‚åœ</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>äºŒç»´ç :</strong></td>
                                <td>
                                    <code>{{ account.qr_code }}</code>
                                    <a href="/franchisee/api/generate-qrcode/{{ account.id }}" class="btn btn-sm btn-outline-primary ms-2">
                                        <i class="fas fa-download"></i> ä¸‹è½½äºŒç»´ç 
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>åˆ›å»ºæ—¶é—´:</strong></td>
                                <td>{{ account.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            </tr>
                        </table>
                        {% if account.address %}
                        <div class="mt-3">
                            <strong>å…¬å¸åœ°å€:</strong>
                            <p class="text-muted">{{ account.address }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="col-md-6">
                <div class="card order-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 class="text-primary">{{ total_orders }}</h4>
                                <small class="text-muted">æ€»è®¢å•æ•°</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-info">Â¥{{ "%.2f"|format(total_order_amount) }}</h4>
                                <small class="text-muted">è®¢å•æ€»é¢</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µ -->
        <ul class="nav nav-tabs" id="detailTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                    è®¢å•è®°å½• ({{ orders|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="machines-tab" data-bs-toggle="tab" data-bs-target="#machines" type="button" role="tab">
                    è‡ªæ‹æœºè®¾å¤‡ ({{ machines|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="staff-tab" data-bs-toggle="tab" data-bs-target="#staff" type="button" role="tab">
                    å­ç”¨æˆ·ç®¡ç† ({{ staff_users|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="refunds-tab" data-bs-toggle="tab" data-bs-target="#refunds" type="button" role="tab">
                    é€€æ¬¾ç”³è¯· ({{ refund_requests|length }})
                </button>
            </li>
        </ul>

        <div class="tab-content" id="detailTabsContent">
            <!-- è®¢å•è®°å½• -->
            <div class="tab-pane fade show active" id="orders" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        {% if orders %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>è®¢å•å·</th>
                                        <th>å®¢æˆ·ä¿¡æ¯</th>
                                        <th>äº§å“</th>
                                        <th>é‡‘é¢</th>
                                        <th>æ‰£é™¤</th>
                                        <th>çŠ¶æ€</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in orders %}
                                    <tr>
                                        <td><code>{{ order.order_number }}</code></td>
                                        <td>
                                            {{ order.customer_name }}<br>
                                            <small class="text-muted">{{ order.customer_phone }}</small>
                                        </td>
                                        <td>{{ order.product_name }}</td>
                                        <td>Â¥{{ "%.2f"|format(order.price) }}</td>
                                        <td class="text-warning">Â¥{{ "%.2f"|format(order.franchisee_deduction) }}</td>
                                        <td>
                                            {% if order.status == 'cancelled' %}
                                                <span class="badge bg-danger">å·²å–æ¶ˆ</span>
                                            {% elif order.status == 'completed' %}
                                                <span class="badge bg-success">å·²å®Œæˆ</span>
                                            {% elif order.status == 'processing' %}
                                                <span class="badge bg-warning">å¤„ç†ä¸­</span>
                                            {% elif order.status == 'shipped' %}
                                                <span class="badge bg-info">å·²å‘è´§</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ order.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ order.created_at.strftime('%m-%d %H:%M') }}</td>
                                        <td>
                                            {% if order.status != 'cancelled' and order.status != 'completed' and order.status != 'shipped' %}
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    onclick="cancelOrder({{ order.id }}, '{{ order.order_number }}', {{ order.franchisee_deduction }})">
                                                <i class="fas fa-times-circle"></i> å–æ¶ˆè®¢å•
                                            </button>
                                            {% else %}
                                            <a href="/admin/order/{{ order.id }}" class="btn btn-sm btn-primary">æŸ¥çœ‹</a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">æš‚æ— è®¢å•è®°å½•</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- è‡ªæ‹æœºè®¾å¤‡ -->
            <div class="tab-pane fade" id="machines" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ğŸ“± è‡ªæ‹æœºè®¾å¤‡ç®¡ç†</h5>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMachineModal">
                            <i class="fas fa-plus"></i> æ·»åŠ è®¾å¤‡
                        </button>
                    </div>
                    <div class="card-body">
                        {% if machines %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>è®¾å¤‡åç§°</th>
                                        <th>åºåˆ—å·</th>
                                        <th>ä½ç½®</th>
                                        <th>çŠ¶æ€</th>
                                        <th>å¤‡æ³¨</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for machine in machines %}
                                    <tr>
                                        <td><strong>{{ machine.machine_name }}</strong></td>
                                        <td><code>{{ machine.machine_serial_number }}</code></td>
                                        <td>{{ machine.location or 'æœªè®¾ç½®' }}</td>
                                        <td>
                                            {% if machine.status == 'active' %}
                                                <span class="badge bg-success">æ­£å¸¸</span>
                                            {% elif machine.status == 'inactive' %}
                                                <span class="badge bg-secondary">åœç”¨</span>
                                            {% else %}
                                                <span class="badge bg-warning">ç»´æŠ¤ä¸­</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ machine.notes or '-' }}</td>
                                        <td>{{ machine.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-warning" 
                                                    onclick="editMachine({{ machine.id }}, '{{ machine.machine_name }}', '{{ machine.machine_serial_number }}', '{{ machine.location or '' }}', '{{ machine.notes or '' }}', '{{ machine.status }}')">
                                                <i class="fas fa-edit"></i> ç¼–è¾‘
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="confirmDeleteMachine({{ machine.id }}, '{{ machine.machine_name }}')">
                                                <i class="fas fa-trash"></i> åˆ é™¤
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">æš‚æ— è‡ªæ‹æœºè®¾å¤‡</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMachineModal">
                                <i class="fas fa-plus"></i> æ·»åŠ ç¬¬ä¸€ä¸ªè®¾å¤‡
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- å­ç”¨æˆ·ç®¡ç† -->
            <div class="tab-pane fade" id="staff" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ğŸ‘¥ å­ç”¨æˆ·ç®¡ç†ï¼ˆåº—å‘˜æƒé™é…ç½®ï¼‰</h5>
                        <a href="/staff-permission/franchisee/{{ account.id }}/staff/add" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i> æ·»åŠ å­ç”¨æˆ·
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            <strong>è¯´æ˜ï¼š</strong>å­ç”¨æˆ·ï¼ˆåº—å‘˜ï¼‰å¯ä»¥é€šè¿‡æ‰‹æœºå·æˆ–openidè¿›è¡ŒåŒ¹é…ï¼Œé…ç½®ä¸åŒçš„æƒé™ï¼ˆå¦‚æŸ¥çœ‹ä»Šå¤©çš„è®¢å•ã€æŸ¥çœ‹é—¨åº—å›¾ç‰‡ç­‰ï¼‰ã€‚
                            å»ºè®®ä¼˜å…ˆä½¿ç”¨æ‰‹æœºå·è¿›è¡ŒåŒ¹é…ï¼Œæ›´ä¾¿äºç®¡ç†ã€‚
                        </div>
                        {% if staff_users %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>å§“å</th>
                                        <th>æ‰‹æœºå·</th>
                                        <th>OpenID</th>
                                        <th>è§’è‰²</th>
                                        <th>æƒé™</th>
                                        <th>çŠ¶æ€</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for staff in staff_users %}
                                    <tr>
                                        <td><strong>{{ staff.name or '-' }}</strong></td>
                                        <td>{{ staff.phone or '-' }}</td>
                                        <td><code style="font-size: 0.8rem;">{{ staff.openid[:20] + '...' if staff.openid and staff.openid|length > 20 else (staff.openid or '-') }}</code></td>
                                        <td>{{ staff.role }}</td>
                                        <td>
                                            {% if staff.permissions %}
                                                {% set perms = staff.permissions|from_json %}
                                            {% else %}
                                                {% set perms = {} %}
                                            {% endif %}
                                            {% if perms.get('groupon_verify') %}
                                                <span class="badge bg-danger">å›¢è´­æ ¸é”€</span>
                                            {% endif %}
                                            {% if perms.get('refund_request') %}
                                                <span class="badge bg-warning">é€€æ¬¾ç”³è¯·</span>
                                            {% endif %}
                                            {% if not perms or (not perms.get('groupon_verify') and not perms.get('refund_request')) %}
                                                <span class="text-muted">æ— æƒé™</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if staff.status == 'active' %}
                                                <span class="badge bg-success">æ­£å¸¸</span>
                                            {% else %}
                                                <span class="badge bg-secondary">åœç”¨</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ staff.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <a href="/staff-permission/franchisee/{{ account.id }}/staff/{{ staff.id }}/edit" class="btn btn-sm btn-outline-warning">
                                                <i class="fas fa-edit"></i> ç¼–è¾‘
                                            </a>
                                            <form method="POST" action="/staff-permission/franchisee/{{ account.id }}/staff/{{ staff.id }}/delete" 
                                                  style="display: inline;" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¯¥å­ç”¨æˆ·å—ï¼Ÿ');">
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash"></i> åˆ é™¤
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">æš‚æ— å­ç”¨æˆ·</p>
                            <a href="/staff-permission/franchisee/{{ account.id }}/staff/add" class="btn btn-primary">
                                <i class="fas fa-plus"></i> æ·»åŠ ç¬¬ä¸€ä¸ªå­ç”¨æˆ·
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- é€€æ¬¾ç”³è¯· -->
            <div class="tab-pane fade" id="refunds" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">é€€æ¬¾ç”³è¯·åˆ—è¡¨</h5>
                    </div>
                    <div class="card-body">
                        {% if refund_requests %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>è®¢å•å·</th>
                                        <th>å®¢æˆ·ä¿¡æ¯</th>
                                        <th>è®¢å•é‡‘é¢</th>
                                        <th>é€€æ¬¾åŸå› </th>
                                        <th>ç”³è¯·æ—¶é—´</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in refund_requests %}
                                    <tr>
                                        <td>{{ order.order_number }}</td>
                                        <td>
                                            {{ order.customer_name or '-' }}<br>
                                            <small class="text-muted">{{ order.customer_phone }}</small>
                                        </td>
                                        <td>Â¥{{ '%.2f'|format(order.price or 0) }}</td>
                                        <td>
                                            <small>{{ order.refund_request_reason[:50] }}{% if order.refund_request_reason|length > 50 %}...{% endif %}</small>
                                        </td>
                                        <td>
                                            {% if order.refund_request_time %}
                                                {{ order.refund_request_time.strftime('%Y-%m-%d %H:%M') }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if order.refund_request_status == 'pending' %}
                                                <span class="badge bg-warning">å¾…å®¡æ ¸</span>
                                            {% elif order.refund_request_status == 'approved' %}
                                                <span class="badge bg-success">å·²æ‰¹å‡†</span>
                                            {% elif order.refund_request_status == 'rejected' %}
                                                <span class="badge bg-danger">å·²æ‹’ç»</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="/admin/payment/refunds" class="btn btn-sm btn-primary">æŸ¥çœ‹è¯¦æƒ…</a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>æš‚æ— é€€æ¬¾ç”³è¯·</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- æ·»åŠ è®¾å¤‡æ¨¡æ€æ¡† -->
    <div class="modal fade" id="addMachineModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ·»åŠ è‡ªæ‹æœºè®¾å¤‡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/franchisee/admin/accounts/{{ account.id }}/machines/add">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="machine_name" class="form-label">è®¾å¤‡åç§° <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="machine_name" name="machine_name" 
                                   placeholder="å¦‚: SMå•†åŸ-1å·æœº" required>
                            <div class="form-text">è®¾å¤‡çš„æ˜¾ç¤ºåç§°</div>
                        </div>
                        <div class="mb-3">
                            <label for="machine_serial_number" class="form-label">è®¾å¤‡åºåˆ—å· <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="machine_serial_number" name="machine_serial_number" 
                                   placeholder="å¦‚: XMSM_001" required>
                            <div class="form-text">è®¾å¤‡çš„å”¯ä¸€åºåˆ—å·ï¼Œå¿…é¡»ä¸å®‰å“APPé…ç½®çš„åºåˆ—å·ä¸€è‡´</div>
                        </div>
                        <div class="mb-3">
                            <label for="location" class="form-label">è®¾å¤‡ä½ç½®</label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   placeholder="å¦‚: 1æ¥¼å¤§å…">
                            <div class="form-text">è®¾å¤‡å®‰è£…çš„å…·ä½“ä½ç½®ï¼ˆå¯é€‰ï¼‰</div>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">å¤‡æ³¨</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2" 
                                      placeholder="è®¾å¤‡å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">æ·»åŠ è®¾å¤‡</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è®¾å¤‡æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editMachineModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¼–è¾‘è‡ªæ‹æœºè®¾å¤‡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editMachineForm" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="edit_machine_name" class="form-label">è®¾å¤‡åç§° <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_machine_name" name="machine_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_machine_serial_number" class="form-label">è®¾å¤‡åºåˆ—å· <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_machine_serial_number" name="machine_serial_number" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_location" class="form-label">è®¾å¤‡ä½ç½®</label>
                            <input type="text" class="form-control" id="edit_location" name="location">
                        </div>
                        <div class="mb-3">
                            <label for="edit_status" class="form-label">çŠ¶æ€</label>
                            <select class="form-select" id="edit_status" name="status">
                                <option value="active">æ­£å¸¸</option>
                                <option value="inactive">åœç”¨</option>
                                <option value="maintenance">ç»´æŠ¤ä¸­</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_notes" class="form-label">å¤‡æ³¨</label>
                            <textarea class="form-control" id="edit_notes" name="notes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- äºŒç»´ç é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="modal fade" id="qrcodeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">äºŒç»´ç é¢„è§ˆ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="qrcodeContainer">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                    <div id="qrcodeInfo" class="mt-3" style="display: none;">
                        <p class="text-muted"><strong>å…¬å¸åç§°ï¼š</strong><span id="companyName"></span></p>
                        <p class="text-muted"><strong>äºŒç»´ç å†…å®¹ï¼š</strong></p>
                        <p class="small text-break" id="qrContent"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å°ç¨‹åºç é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="modal fade" id="miniprogramQrcodeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å°ç¨‹åºç é¢„è§ˆ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="miniprogramQrcodeContainer">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">ç”Ÿæˆä¸­...</span>
                        </div>
                    </div>
                    <div id="miniprogramQrcodeInfo" class="mt-3" style="display: none;">
                        <p class="text-muted"><strong>é—¨åº—åç§°ï¼š</strong><span id="miniprogramFranchiseeName"></span></p>
                        <p class="text-muted"><strong>äºŒç»´ç æ ‡è¯†ï¼š</strong><code id="miniprogramQrCode"></code></p>
                        <p class="text-muted small">ç”¨æˆ·é€šè¿‡æ­¤å°ç¨‹åºç è¿›å…¥å°ç¨‹åºä¸‹å•æ—¶ï¼Œè®¢å•å°†è‡ªåŠ¨å…³è”åˆ°è¯¥é—¨åº—</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="downloadMiniprogramQrcodeBtn" style="display: none;" onclick="downloadMiniprogramQrcode()">
                        <i class="fas fa-download"></i> ä¸‹è½½å°ç¨‹åºç 
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    
    <!-- å–æ¶ˆè®¢å•æ¨¡æ€æ¡† -->
    <div class="modal fade" id="cancelOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å–æ¶ˆè®¢å•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body authoritative">
                    <p>è®¢å•å·: <strong id="cancelOrderNumber"></strong></p>
                    <p>å°†è¿”è¿˜é‡‘é¢: <strong class="text-success">Â¥<span id="cancelOrderAmount"></span></strong></p>
                    <div class="mb-3">
                        <label for="cancelReason" class="form-label">å–æ¶ˆåŸå› :</label>
                        <textarea class="form-control" id="cancelReason" rows="3" placeholder="è¯·è¾“å…¥å–æ¶ˆè®¢å•çš„åŸå› ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" onclick="confirmCancelOrder()">ç¡®è®¤å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    let cancelOrderData = null;
    
    function cancelOrder(orderId, orderNumber, amount) {
        cancelOrderData = { orderId, orderNumber, amount };
        document.getElementById('cancelOrderNumber').textContent = orderNumber;
        document.getElementById('cancelOrderAmount').textContent = amount.toFixed(2);
        const modal = new bootstrap.Modal(document.getElementById('cancelOrderModal'));
        modal.show();
    }
    
    function confirmCancelOrder() {
        if (!cancelOrderData) return;
        
        const reason = document.getElementById('cancelReason').value || 'ç®¡ç†å‘˜å–æ¶ˆè®¢å•';
        
        fetch('/franchisee/api/cancel-order/' + cancelOrderData.orderId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reason: reason })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('è®¢å•å·²å–æ¶ˆï¼Œèµ„é‡‘å·²è¿”è¿˜åˆ°åŠ ç›Ÿå•†è´¦æˆ·');
                location.reload();
            } else {
                alert('å–æ¶ˆè®¢å•å¤±è´¥: ' + data.message);
            }
        })
        .catch(error => {
            alert('æ“ä½œå¤±è´¥: ' + error.message);
        });
    }
    
    // ç¼–è¾‘è®¾å¤‡
    function editMachine(machineId, machineName, serialNumber, location, notes, status) {
        document.getElementById('edit_machine_name').value = machineName;
        document.getElementById('edit_machine_serial_number').value = serialNumber;
        document.getElementById('edit_location').value = location || '';
        document.getElementById('edit_status').value = status;
        document.getElementById('edit_notes').value = notes || '';
        
        // è®¾ç½®è¡¨å•æäº¤åœ°å€
        document.getElementById('editMachineForm').action = `/franchisee/admin/accounts/{{ account.id }}/machines/${machineId}/edit`;
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('editMachineModal'));
        modal.show();
    }
    
    // ç¡®è®¤åˆ é™¤è®¾å¤‡
    function confirmDeleteMachine(machineId, machineName) {
        if (confirm(`ç¡®å®šè¦åˆ é™¤è®¾å¤‡ "${machineName}" å—ï¼Ÿ\n\næ³¨æ„ï¼šå¦‚æœè¯¥è®¾å¤‡å…³è”äº†è®¢å•ï¼Œå°†æ— æ³•åˆ é™¤ã€‚\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            // åˆ›å»ºè¡¨å•å¹¶æäº¤
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/franchisee/admin/accounts/{{ account.id }}/machines/${machineId}/delete`;
            
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    // ç¡®è®¤åˆ é™¤åŠ ç›Ÿå•†è´¦æˆ·
    function confirmDelete(accountId, companyName) {
        if (confirm(`ç¡®å®šè¦åˆ é™¤åŠ ç›Ÿå•†è´¦æˆ· "${companyName}" å—ï¼Ÿ\n\næ³¨æ„ï¼šå¦‚æœè¯¥è´¦æˆ·å…³è”äº†è®¢å•ï¼Œå°†æ— æ³•åˆ é™¤ã€‚\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            // åˆ›å»ºè¡¨å•å¹¶æäº¤
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/franchisee/admin/accounts/${accountId}/delete`;
            
            // æ·»åŠ CSRF tokenï¼ˆå¦‚æœæœ‰ï¼‰
            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = csrfToken.content;
                form.appendChild(csrfInput);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    function previewQrcode(accountId) {
            const modal = new bootstrap.Modal(document.getElementById('qrcodeModal'));
            const container = document.getElementById('qrcodeContainer');
            const info = document.getElementById('qrcodeInfo');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            container.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">åŠ è½½ä¸­...</span></div>';
            info.style.display = 'none';
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.show();
            
            // è·å–äºŒç»´ç æ•°æ®
            fetch(`/franchisee/admin/accounts/${accountId}/qrcode-preview`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        container.innerHTML = `<img src="${data.qrcode}" class="img-fluid" alt="äºŒç»´ç ">`;
                        document.getElementById('companyName').textContent = data.company_name;
                        document.getElementById('qrContent').textContent = data.content;
                        info.style.display = 'block';
                    } else {
                        container.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                    }
                })
                .catch(error => {
                    container.innerHTML = `<div class="alert alert-danger">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                });
        }

    // ç”Ÿæˆå°ç¨‹åºç 
    let currentMiniprogramQrcodeUrl = '';
    
    function generateMiniprogramQrcode(accountId) {
        const modal = new bootstrap.Modal(document.getElementById('miniprogramQrcodeModal'));
        const container = document.getElementById('miniprogramQrcodeContainer');
        const info = document.getElementById('miniprogramQrcodeInfo');
        const downloadBtn = document.getElementById('downloadMiniprogramQrcodeBtn');
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        container.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">ç”Ÿæˆä¸­...</span></div>';
        info.style.display = 'none';
        downloadBtn.style.display = 'none';
        currentMiniprogramQrcodeUrl = '';
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.show();
        
        // è°ƒç”¨APIç”Ÿæˆå°ç¨‹åºç 
        fetch('/api/qrcode/generate-franchisee', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                franchiseeId: accountId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                container.innerHTML = `<img src="${data.qrcode_url}" class="img-fluid" alt="å°ç¨‹åºç " style="max-width: 300px;">`;
                document.getElementById('miniprogramFranchiseeName').textContent = data.franchisee_name;
                document.getElementById('miniprogramQrCode').textContent = data.qr_code;
                info.style.display = 'block';
                downloadBtn.style.display = 'inline-block';
                currentMiniprogramQrcodeUrl = data.qrcode_url;
            } else {
                container.innerHTML = `<div class="alert alert-danger">${data.message || 'ç”Ÿæˆå¤±è´¥'}</div>`;
            }
        })
        .catch(error => {
            container.innerHTML = `<div class="alert alert-danger">ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
        });
    }
    
    // ä¸‹è½½å°ç¨‹åºç 
    function downloadMiniprogramQrcode() {
        if (!currentMiniprogramQrcodeUrl) {
            alert('æ²¡æœ‰å¯ä¸‹è½½çš„å°ç¨‹åºç ');
            return;
        }
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const link = document.createElement('a');
        link.href = currentMiniprogramQrcodeUrl;
        link.download = `miniprogram_qrcode_${Date.now()}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    </script>
</body>
</html>
