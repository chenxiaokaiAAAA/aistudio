<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>过期图片清理 - {{ brand_name }}系统</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: #f5f5f5;
            padding-top: 80px;
        }
        .navbar-custom {
            background: #0a0a0a !important;
            border-bottom: 1px solid #1a1a1a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .main-content {
            padding: 20px;
        }
        .config-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    {% include 'admin/_navbar.html' %}

    <div class="container-fluid main-content">
        <div class="row">
            <main class="col-12">
                <h2 class="mb-4">过期图片清理配置</h2>
                
                <!-- 清理规则配置 -->
                <div class="config-card">
                    <h5 class="mb-3">清理规则配置</h5>
                    <form id="cleanupConfigForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">用户最终效果图保存天数</label>
                                <input type="number" class="form-control" id="finalImageDays" value="3" min="1">
                                <small class="text-muted">订单完成后，用户最终效果图保存的天数</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">用户美颜后的图像保存天数</label>
                                <input type="number" class="form-control" id="retouchedImageDays" value="30" min="1">
                                <small class="text-muted">用户美颜后的图像保存的天数（长期保存）</small>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveConfig()">
                            <i class="bi bi-save"></i> 保存配置
                        </button>
                    </form>
                </div>

                <!-- 自定义清理规则 -->
                <div class="config-card">
                    <h5 class="mb-3">自定义清理规则</h5>
                    <div class="mb-3">
                        <label class="form-label">清理XX天前已完成订单的任务</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="customDays" placeholder="输入天数" min="1">
                            <button class="btn btn-warning" type="button" onclick="executeCustomCleanup()">
                                <i class="bi bi-trash"></i> 执行清理
                            </button>
                        </div>
                        <small class="text-muted">将清理指定天数前已完成订单的所有相关图片和任务数据</small>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        // 页面加载时获取配置
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
        });

        // 加载配置
        function loadConfig() {
            fetch('/api/admin/image-cleanup/config', {
                credentials: 'same-origin'
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success && data.config) {
                    document.getElementById('finalImageDays').value = data.config.final_image_days || 3;
                    document.getElementById('retouchedImageDays').value = data.config.retouched_image_days || 30;
                }
            })
            .catch(function(error) {
                console.error('加载配置失败:', error);
            });
        }

        // 保存配置
        function saveConfig() {
            var config = {
                final_image_days: parseInt(document.getElementById('finalImageDays').value),
                retouched_image_days: parseInt(document.getElementById('retouchedImageDays').value)
            };

            fetch('/api/admin/image-cleanup/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify(config)
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    alert('配置保存成功');
                } else {
                    alert('保存失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(function(error) {
                console.error('保存配置失败:', error);
                alert('保存失败，请重试');
            });
        }

        // 执行自定义清理
        function executeCustomCleanup() {
            var days = parseInt(document.getElementById('customDays').value);
            if (!days || days <= 0) {
                alert('请输入有效的天数');
                return;
            }

            if (!confirm('确定要清理' + days + '天前已完成订单的所有相关图片和任务数据吗？此操作不可恢复！')) {
                return;
            }

            fetch('/api/admin/image-cleanup/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify({ days: days })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    alert('清理完成: ' + (data.message || '') + '\n已删除 ' + (data.deleted_count || 0) + ' 个文件');
                } else {
                    alert('清理失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(function(error) {
                console.error('执行清理失败:', error);
                alert('清理失败，请重试');
            });
        }
    </script>
</body>
</html>
