<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼˜æƒ åˆ¸ç®¡ç† - AIæ‹ç…§ç®¡ç†ç³»ç»Ÿ</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 80px;
        }
        .navbar-custom {
            background: #0a0a0a !important;
            border-bottom: 1px solid #1a1a1a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .navbar-brand, .nav-link {
            color: #e0e0e0 !important;
        }
        .nav-link:hover {
            color: #ffffff !important;
        }
        .nav-link.active {
            color: #ffffff !important;
            font-weight: 600;
        }
        .coupon-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .coupon-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .type-cash { background-color: #28a745; color: white; font-size: 0.75rem; padding: 2px 6px; }
        .type-discount { background-color: #007bff; color: white; font-size: 0.75rem; padding: 2px 6px; }
        .type-free { background-color: #ffc107; color: black; font-size: 0.75rem; padding: 2px 6px; }
        .status-active { color: #28a745; }
        .status-inactive { color: #dc3545; }
        .status-expired { color: #6c757d; }
        .progress-bar-custom {
            height: 8px;
            border-radius: 4px;
        }
        /* ä¿®å¤é€‰ä¸­çŠ¶æ€æ–‡å­—é¢œè‰² */
        .list-group-item.active {
            background-color: #e7f3ff;
        }
        .list-group-item.active a {
            color: #333 !important;
            font-weight: bold;
        }
        /* è¡¨æ ¼æ–‡å­—å¤§å° */
        .table {
            font-size: 0.9rem;
        }
        .table td {
            font-size: 0.85rem;
            padding: 0.5rem;
        }
        .table th {
            font-size: 0.9rem;
            padding: 0.6rem 0.5rem;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    {% include 'admin/_navbar.html' %}

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">ğŸ« ä¼˜æƒ åˆ¸ç®¡ç†</h5>
                        <!-- å›¢è´­ç›¸å…³æŒ‰é’®å·²ç§»è‡³å›¢è´­æ ¸é”€é¡µé¢ -->
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCouponModal">
                                <i class="fas fa-plus"></i> åˆ›å»ºä¼˜æƒ åˆ¸
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- ç­›é€‰å™¨ -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter">
                                    <option value="active" selected>æœ‰æ•ˆ</option>
                                    <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                                    <option value="inactive">æ— æ•ˆ</option>
                                    <option value="expired">å·²è¿‡æœŸ</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="typeFilter">
                                    <option value="all">å…¨éƒ¨ç±»å‹</option>
                                    <option value="cash">ç°é‡‘åˆ¸</option>
                                    <option value="discount">æŠ˜æ‰£åˆ¸</option>
                                    <option value="free">å…è´¹åˆ¸</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary" onclick="refreshCoupons()">
                                    <i class="fas fa-sync"></i> åˆ·æ–°
                                </button>
                            </div>
                        </div>

                        <!-- ä¼˜æƒ åˆ¸åˆ—è¡¨ -->
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th style="width: 15%; font-size: 0.9rem;">ä¼˜æƒ åˆ¸åç§°</th>
                                        <th style="width: 10%; font-size: 0.9rem;">ç±»å‹</th>
                                        <th style="width: 10%; font-size: 0.9rem;">ä»£ç </th>
                                        <th style="width: 12%; font-size: 0.9rem;">ä¼˜æƒ å†…å®¹</th>
                                        <th style="width: 10%; font-size: 0.9rem;">æ¥æº</th>
                                        <th style="width: 8%; font-size: 0.9rem;">çŠ¶æ€</th>
                                        <th style="width: 10%; font-size: 0.9rem;">æœ‰æ•ˆæœŸ</th>
                                        <th style="width: 10%; font-size: 0.9rem;">å‘æ”¾æƒ…å†µ</th>
                                        <th style="width: 15%; text-align: center; font-size: 0.9rem;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="couponsList">
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- åˆ†é¡µ -->
                        <nav aria-label="ä¼˜æƒ åˆ¸åˆ†é¡µ">
                            <ul class="pagination justify-content-center" id="pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºä¼˜æƒ åˆ¸æ¨¡æ€æ¡† -->
    <div class="modal fade" id="createCouponModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">åˆ›å»ºä¼˜æƒ åˆ¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createCouponForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="couponName" class="form-label">ä¼˜æƒ åˆ¸åç§° *</label>
                                    <input type="text" class="form-control" id="couponName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="couponType" class="form-label">ä¼˜æƒ åˆ¸ç±»å‹ *</label>
                                    <select class="form-select" id="couponType" required>
                                        <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                                        <option value="cash">ç°é‡‘åˆ¸</option>
                                        <option value="discount">æŠ˜æ‰£åˆ¸</option>
                                        <option value="free">å…è´¹åˆ¸</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="couponValue" class="form-label">ä¼˜æƒ é‡‘é¢/æŠ˜æ‰£æ¯”ä¾‹ *</label>
                                    <input type="number" class="form-control" id="couponValue" step="0.01" required>
                                    <div class="form-text">ç°é‡‘åˆ¸å¡«å†™é‡‘é¢ï¼ŒæŠ˜æ‰£åˆ¸å¡«å†™ç™¾åˆ†æ¯”ï¼ˆå¦‚20è¡¨ç¤º8æŠ˜ï¼‰</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="minAmount" class="form-label">æœ€ä½æ¶ˆè´¹é‡‘é¢</label>
                                    <input type="number" class="form-control" id="minAmount" step="0.01" value="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="maxDiscount" class="form-label">æœ€å¤§æŠ˜æ‰£é‡‘é¢</label>
                                    <input type="number" class="form-control" id="maxDiscount" step="0.01">
                                    <div class="form-text">ä»…æŠ˜æ‰£åˆ¸æœ‰æ•ˆï¼Œé™åˆ¶æœ€å¤§ä¼˜æƒ é‡‘é¢</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="totalCount" class="form-label">æ€»å‘æ”¾æ•°é‡ *</label>
                                    <input type="number" class="form-control" id="totalCount" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="perUserLimit" class="form-label">æ¯ç”¨æˆ·é™é¢†æ•°é‡</label>
                                    <input type="number" class="form-control" id="perUserLimit" value="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="couponStatus" class="form-label">çŠ¶æ€</label>
                                    <select class="form-select" id="couponStatus">
                                        <option value="active">æœ‰æ•ˆ</option>
                                        <option value="inactive">æ— æ•ˆ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="startTime" class="form-label">å¼€å§‹æ—¶é—´</label>
                                    <input type="datetime-local" class="form-control" id="startTime">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="endTime" class="form-label">ç»“æŸæ—¶é—´</label>
                                    <input type="datetime-local" class="form-control" id="endTime">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="couponDescription" class="form-label">ä¼˜æƒ åˆ¸æè¿°</label>
                            <textarea class="form-control" id="couponDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="createCoupon()">åˆ›å»º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¢è´­æ ¸é”€æ¨¡æ€æ¡† -->
    <div class="modal fade" id="grouponVerifyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å›¢è´­è®¢å•æ ¸é”€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="grouponVerifyForm">
                        <div class="mb-3">
                            <label for="grouponOrderId" class="form-label">å›¢è´­è®¢å•å· *</label>
                            <input type="text" class="form-control" id="grouponOrderId" placeholder="è¯·è¾“å…¥å›¢è´­å¹³å°çš„è®¢å•å·" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="grouponPlatform" class="form-label">å¹³å° *</label>
                                    <select class="form-select" id="grouponPlatform" required onchange="loadPackagesByPlatform()">
                                        <option value="">è¯·é€‰æ‹©å¹³å°</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="grouponPackage" class="form-label">å›¢è´­å¥—é¤ *</label>
                                    <select class="form-select" id="grouponPackage" required onchange="updateVerifyAmount()">
                                        <option value="">è¯·å…ˆé€‰æ‹©å¹³å°</option>
                                    </select>
                                    <div class="form-text" id="packageAmountText">é€‰æ‹©å¥—é¤åè‡ªåŠ¨å¡«å……é‡‘é¢</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="verifyAmount" class="form-label">æ ¸é”€é‡‘é¢ *</label>
                                    <input type="number" class="form-control" id="verifyAmount" step="0.01" placeholder="0.00" readonly required>
                                    <div class="form-text">æ ¹æ®é€‰æ‹©çš„å¥—é¤è‡ªåŠ¨å¡«å……</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expireDays" class="form-label">æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰</label>
                                    <input type="number" class="form-control" id="expireDays" value="30" min="1" max="365">
                                    <div class="form-text">é»˜è®¤30å¤©</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerPhone" class="form-label">å®¢æˆ·æ‰‹æœºå· *</label>
                                    <input type="tel" class="form-control" id="customerPhone" placeholder="ç”¨äºè®°å½•å®¢æˆ·ä¿¡æ¯" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerName" class="form-label">å®¢æˆ·å§“å</label>
                                    <input type="text" class="form-control" id="customerName" placeholder="å¯é€‰">
                                </div>
                            </div>
                        </div>
                    </form>
                    
                    <!-- æ ¸é”€ç»“æœå±•ç¤ºåŒºåŸŸ -->
                    <div id="verifyResult" style="display: none;" class="mt-4">
                        <div class="alert alert-success">
                            <h6>âœ… æ ¸é”€æˆåŠŸï¼</h6>
                            <p class="mb-2">ä¼˜æƒ åˆ¸ä»£ç ï¼š<strong id="resultCouponCode"></strong></p>
                            <p class="mb-2">ä¼˜æƒ åˆ¸åç§°ï¼š<strong id="resultCouponName"></strong></p>
                            <p class="mb-2">æ ¸é”€é‡‘é¢ï¼š<strong id="resultVerifyAmount"></strong>å…ƒ</p>
                            <p class="mb-2">æœ‰æ•ˆæœŸè‡³ï¼š<strong id="resultExpireTime"></strong></p>
                        </div>
                        <div class="text-center mb-3">
                            <h6>é¢†å–äºŒç»´ç </h6>
                            <img id="resultQrCode" src="" alt="äºŒç»´ç " class="img-fluid" style="max-width: 300px;">
                            <p class="text-muted mt-2">ç”¨æˆ·æ‰«ç å³å¯é¢†å–ä¼˜æƒ åˆ¸</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetGrouponVerifyForm()">å…³é—­</button>
                    <button type="button" class="btn btn-success" onclick="verifyGrouponOrder()" id="verifyBtn">
                        <i class="fas fa-check"></i> ç¡®è®¤æ ¸é”€
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¢è´­å¥—é¤é…ç½®æ¨¡æ€æ¡† -->
    <div class="modal fade" id="grouponPackageModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å›¢è´­å¥—é¤é…ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button class="btn btn-primary" onclick="showAddPackageForm()">
                            <i class="fas fa-plus"></i> æ·»åŠ å¥—é¤
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>å¹³å°</th>
                                    <th>å¥—é¤åç§°</th>
                                    <th>å¥—é¤é‡‘é¢</th>
                                    <th>æè¿°</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ’åº</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="packageList">
                                <tr><td colspan="7" class="text-center">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- æ·»åŠ /ç¼–è¾‘å¥—é¤è¡¨å• -->
                    <div id="packageForm" style="display: none;" class="mt-4">
                        <hr>
                        <h6 id="packageFormTitle">æ·»åŠ å¥—é¤</h6>
                        <form id="packageFormData">
                            <input type="hidden" id="packageId">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="packagePlatform" class="form-label">å¹³å° *</label>
                                        <input type="text" class="form-control" id="packagePlatform" list="platformList" required>
                                        <datalist id="platformList">
                                            <option value="ç¾å›¢">
                                            <option value="æŠ–éŸ³">
                                            <option value="å¤§ä¼—ç‚¹è¯„">
                                            <option value="å…¶ä»–">
                                        </datalist>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="packageName" class="form-label">å¥—é¤åç§° *</label>
                                        <input type="text" class="form-control" id="packageName" placeholder="å¦‚ï¼šè¯ä»¶ç…§å¥—é¤" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="packageAmount" class="form-label">å¥—é¤é‡‘é¢ *</label>
                                        <input type="number" class="form-control" id="packageAmount" step="0.01" min="0.01" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="packageStatus" class="form-label">çŠ¶æ€</label>
                                        <select class="form-select" id="packageStatus">
                                            <option value="active">å¯ç”¨</option>
                                            <option value="inactive">åœç”¨</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="packageDescription" class="form-label">å¥—é¤æè¿°</label>
                                <textarea class="form-control" id="packageDescription" rows="2"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="packageSortOrder" class="form-label">æ’åºé¡ºåº</label>
                                <input type="number" class="form-control" id="packageSortOrder" value="0">
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" onclick="savePackage()">ä¿å­˜</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelPackageForm()">å–æ¶ˆ</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¬¬ä¸‰æ–¹å›¢è´­APIé…ç½®æ¨¡æ€æ¡† -->
    <div class="modal fade" id="thirdPartyGrouponConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¬¬ä¸‰æ–¹å›¢è´­æ ¸é”€APIé…ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>è¯´æ˜ï¼š</strong>é…ç½®ç¬¬ä¸‰æ–¹å›¢è´­å¹³å°çš„APIæ¥å£ï¼Œç”¨äºéªŒè¯å’Œæ ¸é”€å›¢è´­åˆ¸ç ã€‚é…ç½®åï¼Œç”¨æˆ·å¯ä»¥åœ¨å°ç¨‹åºä¸­ä¸€é”®å¯¼å…¥æˆ–æ‰‹åŠ¨è¾“å…¥åˆ¸ç è¿›è¡Œæ ¸é”€ã€‚
                    </div>
                    <form id="thirdPartyGrouponConfigForm">
                        <div class="mb-3">
                            <label for="apiPlatform" class="form-label">å›¢è´­å¹³å° <span class="text-danger">*</span></label>
                            <select class="form-select" id="apiPlatform" required>
                                <option value="">è¯·é€‰æ‹©å¹³å°</option>
                                <option value="meituan">ç¾å›¢</option>
                                <option value="dianping">å¤§ä¼—ç‚¹è¯„</option>
                                <option value="custom">è‡ªå®šä¹‰</option>
                            </select>
                            <div class="form-text">é€‰æ‹©ç¬¬ä¸‰æ–¹å›¢è´­å¹³å°</div>
                        </div>
                        <div class="mb-3">
                            <label for="apiBaseUrl" class="form-label">APIåŸºç¡€åœ°å€ <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" id="apiBaseUrl" 
                                   placeholder="https://api.example.com" required>
                            <div class="form-text">ç¬¬ä¸‰æ–¹å¹³å°çš„APIåŸºç¡€URL</div>
                        </div>
                        <div class="mb-3">
                            <label for="verifyEndpoint" class="form-label">éªŒè¯åˆ¸ç æ¥å£è·¯å¾„</label>
                            <input type="text" class="form-control" id="verifyEndpoint" 
                                   placeholder="/api/v1/verify" value="/api/v1/verify">
                            <div class="form-text">ç”¨äºéªŒè¯å›¢è´­åˆ¸ç æ˜¯å¦æœ‰æ•ˆçš„æ¥å£è·¯å¾„</div>
                        </div>
                        <div class="mb-3">
                            <label for="redeemEndpoint" class="form-label">æ ¸é”€åˆ¸ç æ¥å£è·¯å¾„</label>
                            <input type="text" class="form-control" id="redeemEndpoint" 
                                   placeholder="/api/v1/redeem" value="/api/v1/redeem">
                            <div class="form-text">ç”¨äºæ ¸é”€å›¢è´­åˆ¸ç çš„æ¥å£è·¯å¾„</div>
                        </div>
                        <div class="mb-3">
                            <label for="queryEndpoint" class="form-label">æŸ¥è¯¢åˆ¸ç æ¥å£è·¯å¾„</label>
                            <input type="text" class="form-control" id="queryEndpoint" 
                                   placeholder="/api/v1/query" value="/api/v1/query">
                            <div class="form-text">ç”¨äºæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢åˆ¸ç åˆ—è¡¨çš„æ¥å£è·¯å¾„ï¼ˆå¯é€‰ï¼‰</div>
                        </div>
                        <div class="mb-3">
                            <label for="apiKey" class="form-label">APIå¯†é’¥</label>
                            <input type="text" class="form-control" id="apiKey" 
                                   placeholder="è¯·è¾“å…¥APIå¯†é’¥">
                            <div class="form-text">ç¬¬ä¸‰æ–¹å¹³å°æä¾›çš„APIå¯†é’¥ï¼ˆç”¨äºèº«ä»½éªŒè¯ï¼‰</div>
                        </div>
                        <div class="mb-3">
                            <label for="apiSecret" class="form-label">APIå¯†é’¥ï¼ˆSecretï¼‰</label>
                            <input type="password" class="form-control" id="apiSecret" 
                                   placeholder="è¯·è¾“å…¥APIå¯†é’¥Secret">
                            <div class="form-text">ç¬¬ä¸‰æ–¹å¹³å°æä¾›çš„APIå¯†é’¥Secretï¼ˆç”¨äºç­¾åéªŒè¯ï¼‰</div>
                        </div>
                        <div class="mb-3">
                            <label for="configStatus" class="form-label">é…ç½®çŠ¶æ€</label>
                            <select class="form-select" id="configStatus">
                                <option value="active" selected>å¯ç”¨</option>
                                <option value="inactive">ç¦ç”¨</option>
                            </select>
                            <div class="form-text">æ˜¯å¦å¯ç”¨æ­¤APIé…ç½®</div>
                        </div>
                        <div class="mb-3">
                            <label for="configNotes" class="form-label">å¤‡æ³¨</label>
                            <textarea class="form-control" id="configNotes" rows="3" 
                                      placeholder="é…ç½®è¯´æ˜ã€æ³¨æ„äº‹é¡¹ç­‰ï¼ˆå¯é€‰ï¼‰"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="resetThirdPartyConfigForm()">å…³é—­</button>
                    <button type="button" class="btn btn-primary" onclick="saveThirdPartyConfig()" id="saveConfigBtn">
                        <i class="fas fa-save"></i> ä¿å­˜é…ç½®
                    </button>
                    <button type="button" class="btn btn-info" onclick="testThirdPartyAPI()" id="testApiBtn">
                        <i class="fas fa-vial"></i> æµ‹è¯•è¿æ¥
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ä¼˜æƒ åˆ¸æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editCouponModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¼–è¾‘ä¼˜æƒ åˆ¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCouponForm">
                        <input type="hidden" id="editCouponId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCouponName" class="form-label">ä¼˜æƒ åˆ¸åç§° *</label>
                                    <input type="text" class="form-control" id="editCouponName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCouponType" class="form-label">ä¼˜æƒ åˆ¸ç±»å‹ *</label>
                                    <select class="form-select" id="editCouponType" required>
                                        <option value="">è¯·é€‰æ‹©ç±»å‹</option>
                                        <option value="cash">ç°é‡‘åˆ¸</option>
                                        <option value="discount">æŠ˜æ‰£åˆ¸</option>
                                        <option value="free">å…è´¹åˆ¸</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCouponValue" class="form-label">ä¼˜æƒ é‡‘é¢/æŠ˜æ‰£æ¯”ä¾‹ *</label>
                                    <input type="number" class="form-control" id="editCouponValue" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editMinAmount" class="form-label">æœ€ä½æ¶ˆè´¹é‡‘é¢</label>
                                    <input type="number" class="form-control" id="editMinAmount" step="0.01">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editMaxDiscount" class="form-label">æœ€å¤§æŠ˜æ‰£é‡‘é¢</label>
                                    <input type="number" class="form-control" id="editMaxDiscount" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTotalCount" class="form-label">æ€»å‘æ”¾æ•°é‡ *</label>
                                    <input type="number" class="form-control" id="editTotalCount" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editPerUserLimit" class="form-label">æ¯ç”¨æˆ·é™é¢†æ•°é‡</label>
                                    <input type="number" class="form-control" id="editPerUserLimit">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCouponStatus" class="form-label">çŠ¶æ€</label>
                                    <select class="form-select" id="editCouponStatus">
                                        <option value="active">æœ‰æ•ˆ</option>
                                        <option value="inactive">æ— æ•ˆ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStartTime" class="form-label">å¼€å§‹æ—¶é—´</label>
                                    <input type="datetime-local" class="form-control" id="editStartTime">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editEndTime" class="form-label">ç»“æŸæ—¶é—´</label>
                                    <input type="datetime-local" class="form-control" id="editEndTime">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editCouponDescription" class="form-label">ä¼˜æƒ åˆ¸æè¿°</label>
                            <textarea class="form-control" id="editCouponDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="updateCoupon()">æ›´æ–°</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    {% include 'admin/_ux_scripts.html' %}
    <script>
        let currentPage = 1;
        let currentStatus = 'active';  // é»˜è®¤æ˜¾ç¤ºæœ‰æ•ˆä¼˜æƒ åˆ¸
        let currentType = 'all';
        let currentSource = 'all';

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCoupons();
            
            // ç»‘å®šç­›é€‰å™¨äº‹ä»¶
            document.getElementById('statusFilter').addEventListener('change', function() {
                currentStatus = this.value;
                currentPage = 1;
                loadCoupons();
            });
            
            document.getElementById('typeFilter').addEventListener('change', function() {
                currentType = this.value;
                currentPage = 1;
                loadCoupons();
            });
            
            // æ¥æºç­›é€‰å™¨
            const sourceFilter = document.getElementById('sourceFilter');
            if (sourceFilter) {
                sourceFilter.addEventListener('change', function() {
                    currentSource = this.value;
                    currentPage = 1;
                    loadCoupons();
                });
            }
        });

        // åŠ è½½ä¼˜æƒ åˆ¸åˆ—è¡¨
        function loadCoupons() {
            // é»˜è®¤åŠ è½½æ‰€æœ‰çŠ¶æ€ï¼Œå‰ç«¯å†è¿‡æ»¤ï¼ˆå› ä¸ºéœ€è¦æ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼‰
            const params = new URLSearchParams({
                page: currentPage,
                per_page: 10,
                status: 'all'  // è·å–æ‰€æœ‰çŠ¶æ€ï¼Œå‰ç«¯æ ¹æ®è¿‡æœŸæ—¶é—´åˆ¤æ–­
            });
            
            fetch(`/api/coupons/list?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayCoupons(data.data);
                        updatePagination(data.total, data.pages);
                    } else {
                        showAlert('åŠ è½½ä¼˜æƒ åˆ¸åˆ—è¡¨å¤±è´¥: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('åŠ è½½ä¼˜æƒ åˆ¸åˆ—è¡¨å¤±è´¥', 'danger');
                });
        }

        // æ˜¾ç¤ºä¼˜æƒ åˆ¸åˆ—è¡¨
        function displayCoupons(coupons) {
            const container = document.getElementById('couponsList');
            
            if (coupons.length === 0) {
                container.innerHTML = '<tr><td colspan="9" class="text-center text-muted">æš‚æ— ä¼˜æƒ åˆ¸</td></tr>';
                return;
            }
            
            let html = '';
            const now = new Date();
            
            coupons.forEach(coupon => {
                // ç±»å‹è¿‡æ»¤
                if (currentType !== 'all' && coupon.type !== currentType) {
                    return;
                }
                
                // æ¥æºè¿‡æ»¤
                if (currentSource !== 'all' && coupon.source_type !== currentSource) {
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                const endTime = new Date(coupon.end_time);
                const isExpired = endTime < now;
                const actualStatus = isExpired ? 'expired' : coupon.status;
                
                // çŠ¶æ€è¿‡æ»¤ï¼ˆå¦‚æœé€‰æ‹©æœ‰æ•ˆï¼Œéœ€è¦æ’é™¤å·²è¿‡æœŸçš„ï¼‰
                if (currentStatus === 'active' && isExpired) {
                    return;
                }
                if (currentStatus === 'expired' && !isExpired) {
                    return;
                }
                if (currentStatus === 'inactive' && actualStatus !== 'inactive') {
                    return;
                }
                
                const typeClass = `type-${coupon.type}`;
                const typeText = {
                    'cash': 'ç°é‡‘åˆ¸',
                    'discount': 'æŠ˜æ‰£åˆ¸',
                    'free': 'å…è´¹åˆ¸'
                }[coupon.type];
                
                const statusClass = isExpired ? 'status-expired' : `status-${coupon.status}`;
                const statusText = isExpired ? 'å·²è¿‡æœŸ' : {
                    'active': 'æœ‰æ•ˆ',
                    'inactive': 'æ— æ•ˆ',
                    'expired': 'å·²è¿‡æœŸ'
                }[coupon.status] || 'æœªçŸ¥';
                
                // æ¥æºç±»å‹æ˜¾ç¤º
                const sourceText = {
                    'system': 'ç³»ç»Ÿå‘æ”¾',
                    'groupon': 'å›¢è´­æ ¸é”€',
                    'share': 'åˆ†äº«å¥–åŠ±',
                    'store': 'é—¨åº—ç”Ÿæˆ'
                }[coupon.source_type || 'system'] || 'ç³»ç»Ÿå‘æ”¾';
                
                const sourceClass = {
                    'system': 'badge-secondary',
                    'groupon': 'badge-success',
                    'share': 'badge-info',
                    'store': 'badge-warning'
                }[coupon.source_type || 'system'] || 'badge-secondary';
                
                // æ ¼å¼åŒ–æ—¥æœŸ
                const startDate = new Date(coupon.start_time);
                const endDate = new Date(coupon.end_time);
                const dateStr = `${startDate.toLocaleDateString('zh-CN')} - ${endDate.toLocaleDateString('zh-CN')}`;
                
                // ä¼˜æƒ å†…å®¹
                let contentText = '';
                if (coupon.type === 'cash') {
                    contentText = `å‡${coupon.value}å…ƒ`;
                } else if (coupon.type === 'discount') {
                    contentText = `${coupon.value}æŠ˜`;
                } else {
                    contentText = 'å…è´¹';
                }
                if (coupon.min_amount > 0) {
                    contentText += `ï¼Œæ»¡${coupon.min_amount}å…ƒå¯ç”¨`;
                } else {
                    contentText += 'ï¼Œæ— é—¨æ§›';
                }
                
                html += `
                    <tr>
                        <td style="font-size: 0.85rem;">
                            <div>${coupon.name}</div>
                            ${coupon.is_random_code ? '<small class="text-info">éšæœºç åˆ¸</small>' : ''}
                            ${coupon.groupon_order_id ? `<small class="text-muted">å›¢è´­: ${coupon.groupon_order_id}</small>` : ''}
                        </td>
                        <td style="font-size: 0.8rem;">
                            <span class="coupon-type ${typeClass}">${typeText}</span>
                        </td>
                        <td style="font-size: 0.8rem;"><code>${coupon.code}</code></td>
                        <td style="font-size: 0.8rem;">${contentText}</td>
                        <td style="font-size: 0.8rem;">
                            <span class="badge ${sourceClass}">${sourceText}</span>
                        </td>
                        <td style="font-size: 0.8rem;">
                            <span class="badge ${statusClass}">${statusText}</span>
                        </td>
                        <td style="font-size: 0.8rem;">
                            ${dateStr}
                        </td>
                        <td style="font-size: 0.8rem;">
                            ${coupon.used_count || 0}/${coupon.total_count || 0}<br>
                            <span class="text-muted">å‰©ä½™: ${coupon.remaining_count || 0}</span>
                        </td>
                        <td style="text-align: center; font-size: 0.8rem;">
                            <button class="btn btn-sm btn-outline-primary" onclick="editCoupon(${coupon.id})" title="ç¼–è¾‘" style="font-size: 0.75rem; padding: 0.2rem 0.4rem;">
                                ç¼–è¾‘
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCoupon(${coupon.id})" title="åˆ é™¤" style="font-size: 0.75rem; padding: 0.2rem 0.4rem; margin-left: 0.2rem;">
                                åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html || '<tr><td colspan="9" class="text-center text-muted">æš‚æ— ç¬¦åˆæ¡ä»¶çš„ä¼˜æƒ åˆ¸</td></tr>';
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination(total, pages) {
            const container = document.getElementById('pagination');
            let html = '';
            
            // ä¸Šä¸€é¡µ
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ä¸Šä¸€é¡µ</a>
            </li>`;
            
            // é¡µç 
            for (let i = 1; i <= pages; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>`;
            }
            
            // ä¸‹ä¸€é¡µ
            html += `<li class="page-item ${currentPage === pages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é¡µ</a>
            </li>`;
            
            container.innerHTML = html;
        }

        // åˆ‡æ¢é¡µé¢
        function changePage(page) {
            currentPage = page;
            loadCoupons();
        }

        // åˆ·æ–°ä¼˜æƒ åˆ¸åˆ—è¡¨
        function refreshCoupons() {
            currentPage = 1;
            loadCoupons();
        }

        // åŠ è½½å¹³å°åˆ—è¡¨
        let platforms = [];
        let packages = [];
        
        function loadPlatforms() {
            fetch('/api/admin/groupon-package/platforms')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        platforms = data.data;
                        const select = document.getElementById('grouponPlatform');
                        select.innerHTML = '<option value="">è¯·é€‰æ‹©å¹³å°</option>';
                        platforms.forEach(platform => {
                            const option = document.createElement('option');
                            option.value = platform;
                            option.textContent = platform;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½å¹³å°åˆ—è¡¨å¤±è´¥:', error);
                });
        }
        
        // æ ¹æ®å¹³å°åŠ è½½å¥—é¤åˆ—è¡¨
        function loadPackagesByPlatform() {
            const platform = document.getElementById('grouponPlatform').value;
            const packageSelect = document.getElementById('grouponPackage');
            packageSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å¥—é¤</option>';
            
            if (!platform) {
                return;
            }
            
            fetch('/api/admin/groupon-package/list')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        packages = data.data.filter(p => p.platform === platform && p.status === 'active');
                        packages.forEach(pkg => {
                            const option = document.createElement('option');
                            option.value = pkg.id;
                            option.textContent = `${pkg.package_name} - Â¥${pkg.package_amount}`;
                            option.dataset.amount = pkg.package_amount;
                            packageSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½å¥—é¤åˆ—è¡¨å¤±è´¥:', error);
                });
        }
        
        // æ›´æ–°æ ¸é”€é‡‘é¢
        function updateVerifyAmount() {
            const packageSelect = document.getElementById('grouponPackage');
            const amountInput = document.getElementById('verifyAmount');
            const amountText = document.getElementById('packageAmountText');
            
            if (packageSelect.value) {
                const selectedOption = packageSelect.options[packageSelect.selectedIndex];
                const amount = parseFloat(selectedOption.dataset.amount);
                amountInput.value = amount.toFixed(2);
                amountText.textContent = `å¥—é¤é‡‘é¢ï¼šÂ¥${amount.toFixed(2)}`;
            } else {
                amountInput.value = '';
                amountText.textContent = 'é€‰æ‹©å¥—é¤åè‡ªåŠ¨å¡«å……é‡‘é¢';
            }
        }
        
        // å›¢è´­è®¢å•æ ¸é”€
        function verifyGrouponOrder() {
            const platform = document.getElementById('grouponPlatform').value;
            const packageId = document.getElementById('grouponPackage').value;
            const formData = {
                groupon_order_id: document.getElementById('grouponOrderId').value,
                platform: platform,
                package_id: parseInt(packageId),
                verify_amount: parseFloat(document.getElementById('verifyAmount').value),
                customer_phone: document.getElementById('customerPhone').value,
                customer_name: document.getElementById('customerName').value || '',
                expire_days: parseInt(document.getElementById('expireDays').value) || 30
            };
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!formData.groupon_order_id || !formData.platform || !formData.package_id || !formData.verify_amount || !formData.customer_phone) {
                showAlert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'warning');
                return;
            }
            
            if (formData.verify_amount <= 0) {
                showAlert('æ ¸é”€é‡‘é¢å¿…é¡»å¤§äº0', 'warning');
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> æ ¸é”€ä¸­...';
            
            fetch('/api/admin/groupon/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i class="fas fa-check"></i> ç¡®è®¤æ ¸é”€';
                
                if (data.status === 'success') {
                    // æ˜¾ç¤ºæ ¸é”€ç»“æœ
                    document.getElementById('resultCouponCode').textContent = data.data.coupon_code;
                    document.getElementById('resultCouponName').textContent = data.data.coupon_name;
                    document.getElementById('resultVerifyAmount').textContent = data.data.verify_amount;
                    document.getElementById('resultExpireTime').textContent = data.data.expire_time;
                    document.getElementById('resultQrCode').src = data.data.qr_code_url;
                    document.getElementById('verifyResult').style.display = 'block';
                    
                    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                    document.getElementById('verifyResult').scrollIntoView({ behavior: 'smooth' });
                    
                    showAlert('å›¢è´­æ ¸é”€æˆåŠŸï¼ä¼˜æƒ åˆ¸å·²ç”Ÿæˆ', 'success');
                    
                    // åˆ·æ–°ä¼˜æƒ åˆ¸åˆ—è¡¨
                    setTimeout(() => {
                        loadCoupons();
                    }, 1000);
                } else {
                    showAlert('æ ¸é”€å¤±è´¥: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i class="fas fa-check"></i> ç¡®è®¤æ ¸é”€';
                console.error('Error:', error);
                showAlert('æ ¸é”€å¤±è´¥ï¼Œè¯·é‡è¯•', 'danger');
            });
        }

        // é‡ç½®å›¢è´­æ ¸é”€è¡¨å•
        function resetGrouponVerifyForm() {
            document.getElementById('grouponVerifyForm').reset();
            document.getElementById('verifyResult').style.display = 'none';
            document.getElementById('expireDays').value = '30';
            document.getElementById('grouponPackage').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©å¹³å°</option>';
            document.getElementById('verifyAmount').value = '';
            document.getElementById('packageAmountText').textContent = 'é€‰æ‹©å¥—é¤åè‡ªåŠ¨å¡«å……é‡‘é¢';
        }
        
        // åŠ è½½å›¢è´­å¥—é¤åˆ—è¡¨
        function loadPackageList() {
            fetch('/api/admin/groupon-package/list')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        displayPackageList(data.data);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½å¥—é¤åˆ—è¡¨å¤±è´¥:', error);
                    document.getElementById('packageList').innerHTML = '<tr><td colspan="7" class="text-center text-danger">åŠ è½½å¤±è´¥</td></tr>';
                });
        }
        
        // æ˜¾ç¤ºå¥—é¤åˆ—è¡¨
        function displayPackageList(packageList) {
            const tbody = document.getElementById('packageList');
            if (packageList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">æš‚æ— å¥—é¤ï¼Œè¯·æ·»åŠ </td></tr>';
                return;
            }
            
            let html = '';
            packageList.forEach(pkg => {
                html += `
                    <tr>
                        <td>${pkg.platform}</td>
                        <td>${pkg.package_name}</td>
                        <td>Â¥${pkg.package_amount.toFixed(2)}</td>
                        <td>${pkg.description || '-'}</td>
                        <td><span class="badge ${pkg.status === 'active' ? 'bg-success' : 'bg-secondary'}">${pkg.status === 'active' ? 'å¯ç”¨' : 'åœç”¨'}</span></td>
                        <td>${pkg.sort_order}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editPackage(${pkg.id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePackage(${pkg.id})">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }
        
        // æ˜¾ç¤ºæ·»åŠ å¥—é¤è¡¨å•
        function showAddPackageForm() {
            document.getElementById('packageForm').style.display = 'block';
            document.getElementById('packageFormTitle').textContent = 'æ·»åŠ å¥—é¤';
            document.getElementById('packageFormData').reset();
            document.getElementById('packageId').value = '';
            document.getElementById('packageStatus').value = 'active';
            document.getElementById('packageSortOrder').value = '0';
        }
        
        // ç¼–è¾‘å¥—é¤
        function editPackage(packageId) {
            fetch('/api/admin/groupon-package/list')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const pkg = data.data.find(p => p.id === packageId);
                        if (pkg) {
                            document.getElementById('packageForm').style.display = 'block';
                            document.getElementById('packageFormTitle').textContent = 'ç¼–è¾‘å¥—é¤';
                            document.getElementById('packageId').value = pkg.id;
                            document.getElementById('packagePlatform').value = pkg.platform;
                            document.getElementById('packageName').value = pkg.package_name;
                            document.getElementById('packageAmount').value = pkg.package_amount;
                            document.getElementById('packageDescription').value = pkg.description || '';
                            document.getElementById('packageStatus').value = pkg.status;
                            document.getElementById('packageSortOrder').value = pkg.sort_order;
                        }
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½å¥—é¤è¯¦æƒ…å¤±è´¥:', error);
                    showAlert('åŠ è½½å¥—é¤è¯¦æƒ…å¤±è´¥', 'danger');
                });
        }
        
        // ä¿å­˜å¥—é¤
        function savePackage() {
            const packageId = document.getElementById('packageId').value;
            const formData = {
                platform: document.getElementById('packagePlatform').value.trim(),
                package_name: document.getElementById('packageName').value.trim(),
                package_amount: parseFloat(document.getElementById('packageAmount').value),
                description: document.getElementById('packageDescription').value.trim(),
                status: document.getElementById('packageStatus').value,
                sort_order: parseInt(document.getElementById('packageSortOrder').value) || 0
            };
            
            if (!formData.platform || !formData.package_name || !formData.package_amount) {
                showAlert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'warning');
                return;
            }
            
            const url = packageId ? `/api/admin/groupon-package/update/${packageId}` : '/api/admin/groupon-package/create';
            const method = packageId ? 'POST' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert(data.message, 'success');
                    cancelPackageForm();
                    loadPackageList();
                    loadPlatforms();
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('ä¿å­˜å¥—é¤å¤±è´¥:', error);
                showAlert('ä¿å­˜å¥—é¤å¤±è´¥', 'danger');
            });
        }
        
        // åˆ é™¤å¥—é¤
        function deletePackage(packageId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥—é¤å—ï¼Ÿ')) {
                return;
            }
            
            fetch(`/api/admin/groupon-package/delete/${packageId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert(data.message, 'success');
                    loadPackageList();
                    loadPlatforms();
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤å¥—é¤å¤±è´¥:', error);
                showAlert('åˆ é™¤å¥—é¤å¤±è´¥', 'danger');
            });
        }
        
        // å–æ¶ˆå¥—é¤è¡¨å•
        function cancelPackageForm() {
            document.getElementById('packageForm').style.display = 'none';
            document.getElementById('packageFormData').reset();
        }
        
        // æ‰“å¼€å›¢è´­å¥—é¤é…ç½®æ¨¡æ€æ¡†æ—¶åŠ è½½æ•°æ®
        document.getElementById('grouponPackageModal')?.addEventListener('show.bs.modal', function() {
            loadPackageList();
        });
        
        // æ‰“å¼€å›¢è´­æ ¸é”€æ¨¡æ€æ¡†æ—¶åŠ è½½å¹³å°åˆ—è¡¨
        document.getElementById('grouponVerifyModal')?.addEventListener('show.bs.modal', function() {
            loadPlatforms();
        });

        // åŠ è½½ç¬¬ä¸‰æ–¹å›¢è´­APIé…ç½®
        function loadThirdPartyConfig() {
            fetch('/api/admin/third-party-groupon/config')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const config = data.data;
                        document.getElementById('apiPlatform').value = config.platform || '';
                        document.getElementById('apiBaseUrl').value = config.api_base_url || '';
                        document.getElementById('verifyEndpoint').value = config.verify_endpoint || '/api/v1/verify';
                        document.getElementById('redeemEndpoint').value = config.redeem_endpoint || '/api/v1/redeem';
                        document.getElementById('queryEndpoint').value = config.query_endpoint || '/api/v1/query';
                        document.getElementById('apiKey').value = config.api_key || '';
                        document.getElementById('apiSecret').value = config.api_secret || '';
                        document.getElementById('configStatus').value = config.status || 'active';
                        document.getElementById('configNotes').value = config.notes || '';
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                });
        }

        // ä¿å­˜ç¬¬ä¸‰æ–¹å›¢è´­APIé…ç½®
        function saveThirdPartyConfig() {
            const formData = {
                platform: document.getElementById('apiPlatform').value,
                api_base_url: document.getElementById('apiBaseUrl').value,
                verify_endpoint: document.getElementById('verifyEndpoint').value,
                redeem_endpoint: document.getElementById('redeemEndpoint').value,
                query_endpoint: document.getElementById('queryEndpoint').value,
                api_key: document.getElementById('apiKey').value,
                api_secret: document.getElementById('apiSecret').value,
                status: document.getElementById('configStatus').value,
                notes: document.getElementById('configNotes').value
            };

            if (!formData.platform || !formData.api_base_url) {
                showAlert('è¯·å¡«å†™å¹³å°å’ŒAPIåŸºç¡€åœ°å€', 'warning');
                return;
            }

            const btn = document.getElementById('saveConfigBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';

            fetch('/api/admin/third-party-groupon/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜é…ç½®';
                if (data.success) {
                    showAlert('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('thirdPartyGrouponConfigModal')).hide();
                } else {
                    showAlert('ä¿å­˜å¤±è´¥: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜é…ç½®';
                console.error('Error:', error);
                showAlert('ä¿å­˜å¤±è´¥', 'danger');
            });
        }

        // æµ‹è¯•ç¬¬ä¸‰æ–¹APIè¿æ¥
        function testThirdPartyAPI() {
            const apiBaseUrl = document.getElementById('apiBaseUrl').value;
            if (!apiBaseUrl) {
                showAlert('è¯·å…ˆå¡«å†™APIåŸºç¡€åœ°å€', 'warning');
                return;
            }

            const btn = document.getElementById('testApiBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';

            fetch('/api/admin/third-party-groupon/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    api_base_url: apiBaseUrl
                })
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-vial"></i> æµ‹è¯•è¿æ¥';
                if (data.success) {
                    showAlert('APIè¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    showAlert('æµ‹è¯•å¤±è´¥: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-vial"></i> æµ‹è¯•è¿æ¥';
                console.error('Error:', error);
                showAlert('æµ‹è¯•å¤±è´¥', 'danger');
            });
        }

        // é‡ç½®ç¬¬ä¸‰æ–¹é…ç½®è¡¨å•
        function resetThirdPartyConfigForm() {
            document.getElementById('thirdPartyGrouponConfigForm').reset();
            document.getElementById('verifyEndpoint').value = '/api/v1/verify';
            document.getElementById('redeemEndpoint').value = '/api/v1/redeem';
            document.getElementById('queryEndpoint').value = '/api/v1/query';
            document.getElementById('configStatus').value = 'active';
        }

        // é¡µé¢åŠ è½½æ—¶ç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // å½“æ‰“å¼€é…ç½®æ¨¡æ€æ¡†æ—¶åŠ è½½é…ç½®
            const configModal = document.getElementById('thirdPartyGrouponConfigModal');
            if (configModal) {
                configModal.addEventListener('show.bs.modal', function() {
                    loadThirdPartyConfig();
                });
            }
        });

        // åˆ›å»ºä¼˜æƒ åˆ¸
        function createCoupon() {
            const formData = {
                name: document.getElementById('couponName').value,
                type: document.getElementById('couponType').value,
                value: parseFloat(document.getElementById('couponValue').value),
                min_amount: parseFloat(document.getElementById('minAmount').value) || 0,
                max_discount: document.getElementById('maxDiscount').value ? parseFloat(document.getElementById('maxDiscount').value) : null,
                total_count: parseInt(document.getElementById('totalCount').value),
                per_user_limit: parseInt(document.getElementById('perUserLimit').value) || 1,
                status: document.getElementById('couponStatus').value,
                start_time: document.getElementById('startTime').value,
                end_time: document.getElementById('endTime').value,
                description: document.getElementById('couponDescription').value
            };
            
            fetch('/api/admin/coupons/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('ä¼˜æƒ åˆ¸åˆ›å»ºæˆåŠŸ', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createCouponModal')).hide();
                    document.getElementById('createCouponForm').reset();
                    loadCoupons();
                } else {
                    showAlert('åˆ›å»ºå¤±è´¥: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('åˆ›å»ºå¤±è´¥', 'danger');
            });
        }

        // ç¼–è¾‘ä¼˜æƒ åˆ¸
        function editCoupon(couponId) {
            // å…ˆè·å–ä¼˜æƒ åˆ¸è¯¦æƒ…
            fetch(`/api/admin/coupons/${couponId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.coupon) {
                        const coupon = data.coupon;
                        // å¡«å……è¡¨å•
                        document.getElementById('editCouponId').value = couponId;
                        document.getElementById('editCouponName').value = coupon.name || '';
                        document.getElementById('editCouponType').value = coupon.type || 'cash';
                        document.getElementById('editCouponValue').value = coupon.value || 0;
                        document.getElementById('editMinAmount').value = coupon.min_amount || 0;
                        document.getElementById('editMaxDiscount').value = coupon.max_discount || '';
                        document.getElementById('editTotalCount').value = coupon.total_count || 1;
                        document.getElementById('editPerUserLimit').value = coupon.per_user_limit || 1;
                        document.getElementById('editCouponStatus').value = coupon.status || 'active';
                        
                        // æ ¼å¼åŒ–æ—¶é—´
                        if (coupon.start_time) {
                            const startTime = new Date(coupon.start_time);
                            document.getElementById('editStartTime').value = startTime.toISOString().slice(0, 16);
                        }
                        if (coupon.end_time) {
                            const endTime = new Date(coupon.end_time);
                            document.getElementById('editEndTime').value = endTime.toISOString().slice(0, 16);
                        }
                        
                        document.getElementById('editCouponDescription').value = coupon.description || '';
                        
                        // æ˜¾ç¤ºæ¨¡æ€æ¡†
                        const modalElement = document.getElementById('editCouponModal');
                        if (modalElement) {
                            const modal = new bootstrap.Modal(modalElement);
                            modal.show();
                        } else {
                            console.error('ç¼–è¾‘ä¼˜æƒ åˆ¸æ¨¡æ€æ¡†ä¸å­˜åœ¨');
                            alert('ç¼–è¾‘åŠŸèƒ½æš‚ä¸å¯ç”¨');
                        }
                    } else {
                        alert('è·å–ä¼˜æƒ åˆ¸è¯¦æƒ…å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('è·å–ä¼˜æƒ åˆ¸è¯¦æƒ…å¤±è´¥');
                });
        }

        // æ›´æ–°ä¼˜æƒ åˆ¸
        function updateCoupon() {
            const couponId = document.getElementById('editCouponId').value;
            const formData = {
                name: document.getElementById('editCouponName').value,
                type: document.getElementById('editCouponType').value,
                value: parseFloat(document.getElementById('editCouponValue').value),
                min_amount: parseFloat(document.getElementById('editMinAmount').value) || 0,
                max_discount: document.getElementById('editMaxDiscount').value ? parseFloat(document.getElementById('editMaxDiscount').value) : null,
                total_count: parseInt(document.getElementById('editTotalCount').value),
                per_user_limit: parseInt(document.getElementById('editPerUserLimit').value) || 1,
                status: document.getElementById('editCouponStatus').value,
                start_time: document.getElementById('editStartTime').value,
                end_time: document.getElementById('editEndTime').value,
                description: document.getElementById('editCouponDescription').value
            };
            
            fetch(`/api/admin/coupons/${couponId}/update`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('ä¼˜æƒ åˆ¸æ›´æ–°æˆåŠŸ', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editCouponModal')).hide();
                    loadCoupons();
                } else {
                    showAlert('æ›´æ–°å¤±è´¥: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('æ›´æ–°å¤±è´¥', 'danger');
            });
        }

        // åˆ é™¤ä¼˜æƒ åˆ¸
        function deleteCoupon(couponId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼˜æƒ åˆ¸å—ï¼Ÿ')) {
                fetch(`/api/admin/coupons/${couponId}/delete`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('ä¼˜æƒ åˆ¸åˆ é™¤æˆåŠŸ', 'success');
                        loadCoupons();
                    } else {
                        showAlert('åˆ é™¤å¤±è´¥: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('åˆ é™¤å¤±è´¥', 'danger');
                });
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }
    </script>
</body>
</html>








