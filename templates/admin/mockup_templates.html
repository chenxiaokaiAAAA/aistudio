<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>样机套图 - 管理后台</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <style>
        body { background: #0a0a0a; color: #e0e0e0; min-height: 100vh; padding-top: 80px; }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .page-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 24px; }
        .card { background: #111; border: 1px solid #222; border-radius: 8px; }
        .card-header { background: #0a0a0a; border-bottom: 1px solid #222; padding: 12px 16px; font-weight: 600; }
        .template-card { padding: 16px; border: 1px solid #222; border-radius: 8px; margin-bottom: 12px; background: #0d0d0d; }
        .template-card:hover { border-color: #333; }
        .btn-primary { background: #1a1a1a; border-color: #333; }
        .btn-primary:hover { background: #2a2a2a; border-color: #444; }
        .form-control, .form-select { background: #1a1a1a; border-color: #333; color: #e0e0e0; }
        .form-control:focus { background: #1a1a1a; border-color: #4361ee; color: #e0e0e0; }
        .modal-content { background: #111; border: 1px solid #222; }
        .modal-header { border-bottom-color: #222; }
        .modal-footer { border-top-color: #222; }
        .product-tag { display: inline-block; padding: 4px 8px; background: #222; border-radius: 4px; font-size: 12px; margin: 2px; }
    </style>
</head>
<body>
    {% include 'admin/_navbar.html' %}

    <div class="main-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="page-title mb-0"><i class="fas fa-image me-2"></i>样机套图</h1>
            <div>
                <button type="button" class="btn btn-outline-secondary me-2" onclick="scanPsd()">
                    <i class="fas fa-search"></i> 扫描 PSD
                </button>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#templateModal" onclick="openAddModal()">
                    <i class="fas fa-plus"></i> 添加模板
                </button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">模板列表</div>
            <div class="card-body">
                <div id="templateList">
                    <div class="text-center text-muted py-5" id="emptyHint">
                        <i class="fas fa-folder-open fa-2x mb-3"></i>
                        <p>暂无样机模板，请添加或扫描 PSD 目录</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 传图测试模块 -->
        <div class="card">
            <div class="card-header"><i class="fas fa-vial me-2"></i>传图测试</div>
            <div class="card-body">
                <p class="text-muted small mb-3">选择样机模板并上传图片，快速测试套图效果</p>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">选择样机模板</label>
                        <select class="form-select" id="testTemplateSelect">
                            <option value="">请选择模板</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">上传测试图片</label>
                        <input type="file" class="form-control" id="testImageInput" accept="image/jpeg,image/png,image/jpg">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-primary" id="testGenerateBtn" onclick="runTestGenerate()">
                            <i class="fas fa-magic me-1"></i> 生成测试
                        </button>
                    </div>
                </div>
                <div id="testResult" class="mt-4" style="display: none;">
                    <hr class="border-secondary">
                    <label class="form-label">生成结果</label>
                    <div class="text-center p-4 bg-dark rounded">
                        <img id="testResultImg" src="" alt="样机套图" style="max-width: 100%; max-height: 400px; border-radius: 8px;">
                        <div class="mt-3">
                            <a id="testDownloadLink" href="#" download class="btn btn-outline-primary">
                                <i class="fas fa-download me-1"></i> 下载套图
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑模板模态框 -->
    <div class="modal fade" id="templateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="templateModalTitle">添加样机模板</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="templateId" value="">
                    <div class="mb-3">
                        <label class="form-label">模板名称 *</label>
                        <input type="text" class="form-control" id="templateName" placeholder="如：挂画相框">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">PSD 路径 *</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="templatePsdPath" placeholder="相对路径，如 data/mockup_templates/挂画相框.psd">
                            <button class="btn btn-outline-secondary" type="button" onclick="pickFromScan()">从扫描结果选择</button>
                        </div>
                        <small class="text-muted">相对于项目根目录，或绝对路径</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">智能对象图层名</label>
                        <input type="text" class="form-control" id="templateSmartLayer" value="photogo" placeholder="默认 photogo">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">绑定产品</label>
                        <button type="button" class="btn btn-sm btn-outline-primary mb-2" onclick="openProductSelector()">
                            <i class="fas fa-th"></i> 选择产品
                        </button>
                        <div id="selectedProductsDisplay" class="d-flex flex-wrap gap-1"></div>
                        <input type="hidden" id="selectedProductIds" value="">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="templateIsActive" checked>
                        <label class="form-check-label" for="templateIsActive">启用</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveTemplate()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 产品选择器模态框 -->
    <div class="modal fade" id="productSelectorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">选择产品</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="productSelectorList" class="row g-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="confirmProductSelection()">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 扫描结果选择 -->
    <div class="modal fade" id="scanResultModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">选择 PSD 文件</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="scanResultList"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        let templates = [];
        let allProducts = [];
        let selectedProductIds = new Set();
        let scanResults = [];

        async function loadTemplates() {
            try {
                const r = await fetch('/api/admin/mockup/templates');
                const data = await r.json();
                if (data.code === 0) {
                    templates = data.data || [];
                    renderTemplates();
                }
            } catch (e) {
                console.error('加载模板失败:', e);
            }
        }

        function renderTemplates() {
            const el = document.getElementById('templateList');
            const empty = document.getElementById('emptyHint');
            if (templates.length === 0) {
                empty.style.display = 'block';
                el.querySelectorAll('.template-card').forEach(n => n.remove());
                renderTestTemplateSelect();
                return;
            }
            empty.style.display = 'none';
            el.innerHTML = templates.map(t => `
                <div class="template-card d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${t.name}</strong>
                        <div class="text-muted small mt-1">${t.psd_path} | 智能图层: ${t.smart_layer_name}</div>
                        <div class="mt-2">${(t.products || []).map(p => `<span class="product-tag">${p.name}</span>`).join('') || '<span class="text-muted">未绑定产品</span>'}</div>
                    </div>
                    <div>
                        <span class="badge ${t.is_active ? 'bg-success' : 'bg-secondary'} me-2">${t.is_active ? '启用' : '禁用'}</span>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editTemplate(${t.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate(${t.id}, '${t.name}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
            renderTestTemplateSelect();
        }

        function renderTestTemplateSelect() {
            const sel = document.getElementById('testTemplateSelect');
            if (!sel) return;
            sel.innerHTML = '<option value="">请选择模板</option>' + templates.filter(t => t.is_active).map(t =>
                `<option value="${t.id}">${t.name}</option>`
            ).join('');
        }

        async function runTestGenerate() {
            const templateId = document.getElementById('testTemplateSelect').value;
            const fileInput = document.getElementById('testImageInput');
            const btn = document.getElementById('testGenerateBtn');

            if (!templateId) {
                alert('请选择样机模板');
                return;
            }
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('请选择要上传的测试图片');
                return;
            }

            const formData = new FormData();
            formData.append('template_id', templateId);
            formData.append('image', fileInput.files[0]);

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> 生成中...';
            document.getElementById('testResult').style.display = 'none';

            try {
                const r = await fetch('/api/admin/mockup/generate-test', {
                    method: 'POST',
                    body: formData
                });
                const data = await r.json();
                if (data.code === 0 && data.data) {
                    document.getElementById('testResultImg').src = data.data.preview_url;
                    document.getElementById('testDownloadLink').href = data.data.preview_url;
                    document.getElementById('testDownloadLink').download = data.data.filename || '样机套图.jpg';
                    document.getElementById('testResult').style.display = 'block';
                } else {
                    alert(data.message || '生成失败');
                }
            } catch (e) {
                alert('生成失败: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic me-1"></i> 生成测试';
            }
        }

        function openAddModal() {
            document.getElementById('templateModalTitle').textContent = '添加样机模板';
            document.getElementById('templateId').value = '';
            document.getElementById('templateName').value = '';
            document.getElementById('templatePsdPath').value = '';
            document.getElementById('templateSmartLayer').value = 'photogo';
            document.getElementById('templateIsActive').checked = true;
            selectedProductIds = new Set();
            renderSelectedProducts();
        }

        function editTemplate(id) {
            const t = templates.find(x => x.id === id);
            if (!t) return;
            document.getElementById('templateModalTitle').textContent = '编辑样机模板';
            document.getElementById('templateId').value = t.id;
            document.getElementById('templateName').value = t.name;
            document.getElementById('templatePsdPath').value = t.psd_path;
            document.getElementById('templateSmartLayer').value = t.smart_layer_name || 'photogo';
            document.getElementById('templateIsActive').checked = t.is_active;
            selectedProductIds = new Set(t.product_ids || []);
            renderSelectedProducts();
            new bootstrap.Modal(document.getElementById('templateModal')).show();
        }

        function renderSelectedProducts() {
            const ids = Array.from(selectedProductIds);
            document.getElementById('selectedProductIds').value = ids.join(',');
            const names = ids.map(pid => {
                const p = allProducts.find(x => x.id === pid);
                return p ? p.name : 'ID:' + pid;
            });
            document.getElementById('selectedProductsDisplay').innerHTML = names.map((n, i) =>
                `<span class="product-tag">${n} <a href="#" onclick="removeProduct(${ids[i]}); return false;" class="text-danger ms-1">×</a></span>`
            ).join('');
        }

        function removeProduct(pid) {
            selectedProductIds.delete(pid);
            renderSelectedProducts();
        }

        async function loadProducts() {
            try {
                const r = await fetch('/api/admin/mockup/products');
                const data = await r.json();
                if (data.code === 0 && data.data) {
                    allProducts = data.data;
                }
            } catch (e) {
                console.error('加载产品失败:', e);
            }
        }

        function openProductSelector() {
            if (allProducts.length === 0) loadProducts().then(() => renderProductSelector());
            else renderProductSelector();
            new bootstrap.Modal(document.getElementById('productSelectorModal')).show();
        }

        function renderProductSelector() {
            const el = document.getElementById('productSelectorList');
            if (allProducts.length === 0) {
                el.innerHTML = '<p class="text-muted">暂无产品，请先在产品管理中添加</p>';
                return;
            }
            el.innerHTML = allProducts.map(p => `
                <div class="col-6 col-md-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="prod_${p.id}" ${selectedProductIds.has(p.id) ? 'checked' : ''} onchange="toggleProduct(${p.id})">
                        <label class="form-check-label" for="prod_${p.id}">${p.name}</label>
                    </div>
                </div>
            `).join('');
        }

        function toggleProduct(pid) {
            if (selectedProductIds.has(pid)) selectedProductIds.delete(pid);
            else selectedProductIds.add(pid);
        }

        function confirmProductSelection() {
            const checkboxes = document.querySelectorAll('#productSelectorList input[type="checkbox"]:checked');
            selectedProductIds = new Set(Array.from(checkboxes).map(cb => parseInt(cb.id.replace('prod_', ''))));
            renderSelectedProducts();
            bootstrap.Modal.getInstance(document.getElementById('productSelectorModal')).hide();
        }

        async function saveTemplate() {
            const id = document.getElementById('templateId').value;
            const payload = {
                name: document.getElementById('templateName').value.trim(),
                psd_path: document.getElementById('templatePsdPath').value.trim(),
                smart_layer_name: document.getElementById('templateSmartLayer').value.trim() || 'photogo',
                product_ids: Array.from(selectedProductIds),
                is_active: document.getElementById('templateIsActive').checked,
            };
            if (!payload.name || !payload.psd_path) {
                alert('请填写模板名称和 PSD 路径');
                return;
            }
            try {
                const url = id ? `/api/admin/mockup/templates/${id}` : '/api/admin/mockup/templates';
                const method = id ? 'PUT' : 'POST';
                const r = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await r.json();
                if (data.code === 0) {
                    bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
                    loadTemplates();
                } else {
                    alert(data.message || '保存失败');
                }
            } catch (e) {
                alert('保存失败: ' + e.message);
            }
        }

        async function deleteTemplate(id, name) {
            if (!confirm(`确定要删除模板「${name}」吗？`)) return;
            try {
                const r = await fetch(`/api/admin/mockup/templates/${id}`, { method: 'DELETE' });
                const data = await r.json();
                if (data.code === 0) loadTemplates();
                else alert(data.message || '删除失败');
            } catch (e) {
                alert('删除失败: ' + e.message);
            }
        }

        async function scanPsd() {
            try {
                const r = await fetch('/api/admin/mockup/scan-psd');
                const data = await r.json();
                if (data.code === 0) {
                    scanResults = data.data || [];
                    const list = document.getElementById('scanResultList');
                    if (scanResults.length === 0) {
                        list.innerHTML = '<p class="text-muted">未找到 PSD 文件。请将 PSD 放入 data/mockup_templates 目录</p>';
                    } else {
                        list.innerHTML = scanResults.map(s => `
                            <div class="mb-2 p-2 border rounded cursor-pointer" onclick="selectScanned('${s.path.replace(/'/g, "\\'")}', '${(s.smart_layer_name || '').replace(/'/g, "\\'")}')">
                                <strong>${s.name}</strong><br>
                                <small class="text-muted">路径: ${s.path} | 智能图层: ${s.smart_layer_name}</small>
                            </div>
                        `).join('');
                    }
                    new bootstrap.Modal(document.getElementById('scanResultModal')).show();
                }
            } catch (e) {
                alert('扫描失败: ' + e.message);
            }
        }

        function selectScanned(path, smartLayer) {
            document.getElementById('templatePsdPath').value = path;
            if (smartLayer) document.getElementById('templateSmartLayer').value = smartLayer;
            bootstrap.Modal.getInstance(document.getElementById('scanResultModal')).hide();
        }

        function pickFromScan() {
            if (scanResults.length === 0) scanPsd();
            else {
                document.getElementById('scanResultList').innerHTML = scanResults.map(s => `
                    <div class="mb-2 p-2 border rounded cursor-pointer" onclick="selectScanned('${s.path.replace(/'/g, "\\'")}', '${(s.smart_layer_name || '').replace(/'/g, "\\'")}')">
                        <strong>${s.name}</strong><br>
                        <small class="text-muted">${s.path} | 智能图层: ${s.smart_layer_name}</small>
                    </div>
                `).join('');
                new bootstrap.Modal(document.getElementById('scanResultModal')).show();
            }
        }

        loadTemplates();
        loadProducts();
    </script>
</body>
</html>
