<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£æ ¼åˆ†ç±»ç®¡ç† - {{ brand_name }}åå°</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #000000;
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        .navbar-custom {
            background: #0a0a0a !important;
            border-bottom: 1px solid #1a1a1a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .navbar-brand, .nav-link {
            color: #e0e0e0 !important;
        }
        
        .nav-link:hover {
            color: #ffffff !important;
        }
        
        .nav-link.active {
            color: #ffffff !important;
            font-weight: 600;
        }
        
        .main-content {
            margin-top: 80px;
            padding: 20px;
        }
        
        .card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        
        .card-header {
            background: #050505;
            border-bottom: 1px solid #1a1a1a;
            border-radius: 8px 8px 0 0 !important;
            color: #e0e0e0;
        }
        
        .btn-primary {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #ffffff;
        }
        
        .btn-primary:hover {
            background: #2a2a2a;
            border-color: #3a3a3a;
        }
        
        .btn-success {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #ffffff;
        }
        
        .btn-success:hover {
            background: #2a2a2a;
            border-color: #3a3a3a;
        }
        
        .btn-outline-primary {
            border-color: #2a2a2a;
            color: #b0b0b0;
        }
        
        .btn-outline-primary:hover {
            background: #1a1a1a;
            border-color: #2a2a2a;
            color: #ffffff;
        }
        
        .btn-outline-danger {
            border-color: #2a2a2a;
            color: #b0b0b0;
        }
        
        .btn-outline-danger:hover {
            background: #2a2a2a;
            border-color: #3a3a3a;
            color: #ffffff;
        }
        
        .btn-outline-secondary {
            border-color: #1a1a1a;
            color: #b0b0b0;
        }
        
        .btn-outline-secondary:hover {
            background: #1a1a1a;
            border-color: #2a2a2a;
        }
        
        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .category-tab {
            padding: 8px 16px;
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #b0b0b0;
        }
        
        .category-tab:hover {
            background: #1a1a1a;
            border-color: #2a2a2a;
        }
        
        .category-tab.active {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            color: #ffffff;
        }
        
        .category-tab img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .image-card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .image-card:hover {
            border-color: #2a2a2a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.8);
        }
        
        .image-card.selected {
            border: 2px solid #3a3a3a;
            box-shadow: 0 2px 8px rgba(255,255,255,0.05);
        }
        
        .image-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .image-card-body {
            padding: 12px;
            background: #050505;
        }
        
        .form-control {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            color: #e0e0e0;
        }
        
        .form-control:focus {
            background: #2a2a2a;
            border-color: #4a4a4a;
            color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.1);
        }
        
        .form-control::placeholder {
            color: #666666;
        }
        
        textarea.form-control {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
        }
        
        textarea.form-control:focus {
            background: #2a2a2a;
            border-color: #4a4a4a;
        }
        
        input[type="text"].form-control,
        input[type="number"].form-control,
        input[type="email"].form-control,
        input[type="password"].form-control {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
        }
        
        input[type="text"].form-control:focus,
        input[type="number"].form-control:focus,
        input[type="email"].form-control:focus,
        input[type="password"].form-control:focus {
            background: #2a2a2a;
            border-color: #4a4a4a;
        }
        
        .modal-content {
            background: #0a0a0a;
            color: #e0e0e0;
            border: 1px solid #1a1a1a;
        }
        
        .modal-header {
            border-bottom: 1px solid #1a1a1a;
            background: #050505;
        }
        
        .modal-footer {
            border-top: 1px solid #1a1a1a;
            background: #050505;
        }
        
        .close {
            color: #b0b0b0;
            opacity: 0.8;
        }
        
        .close:hover {
            color: #ffffff;
            opacity: 1;
        }
        
        .upload-area {
            border: 2px dashed #1a1a1a;
            border-radius: 4px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #050505;
        }
        
        .upload-area:hover {
            border-color: #2a2a2a;
            background: #0a0a0a;
        }
        
        .upload-area.dragover {
            border-color: #3a3a3a;
            background: #0f0f0f;
        }
        
        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .category-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* å¯¹é½æ ·å¼ */
        .btn-group-aligned {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .card-aligned {
            margin-bottom: 15px;
        }
        
        .row-aligned {
            align-items: flex-start;
        }
        
        .col-md-4, .col-md-8 {
            padding-top: 0;
        }
        
        .image-section-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .category-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .category-tab {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #b0b0b0;
        }
        
        .category-tab:hover {
            background: #1a1a1a;
            border-color: #2a2a2a;
        }
        
        .category-tab.active {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            color: #ffffff;
        }
        
        .category-tab img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .category-tab .category-icon {
            font-size: 16px;
        }
        
        .category-tab small {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* ä¿®å¤ä¸‹æ‹‰èœå•é¢œè‰²æ˜¾ç¤ºé—®é¢˜ */
        .form-select {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
            border-color: #2a2a2a !important;
        }
        
        .form-select:focus {
            background-color: #2a2a2a !important;
            border-color: #4a4a4a !important;
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.1);
        }
        
        .form-select option {
            background-color: #1a1a1a !important;
            color: #e0e0e0 !important;
        }
        
        .form-select option:hover {
            background-color: #2a2a2a !important;
            color: #ffffff !important;
        }
        
        .form-select option:checked {
            background-color: #2a2a2a !important;
            color: #ffffff !important;
        }
        
        .form-check-input:checked {
            background-color: #2a2a2a;
            border-color: #2a2a2a;
        }
        
        .form-check-input:focus {
            border-color: #2a2a2a;
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.05);
        }
        
        .form-check-label {
            color: #e0e0e0;
        }
        
        .text-info {
            color: #b0b0b0 !important;
        }
        
        /* è¡¨å•æ ‡ç­¾æ ·å¼ */
        .form-label {
            color: #d0d0d0;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        /* æ¨¡æ€æ¡†è¡¨å•åŒºåŸŸ */
        .modal-body {
            background: #0a0a0a;
        }
        
        .modal-body .form-control,
        .modal-body .form-select {
            background: #1a1a1a;
            border-color: #2a2a2a;
        }
        
        .modal-body .form-control:focus,
        .modal-body .form-select:focus {
            background: #2a2a2a;
            border-color: #4a4a4a;
        }
        
        /* åªè¯»è¾“å…¥æ¡†æ ·å¼ */
        input[readonly].form-control,
        textarea[readonly].form-control {
            background: #0f0f0f !important;
            border-color: #1a1a1a !important;
            color: #888888 !important;
            cursor: not-allowed;
        }
        
        /* æ–°å¢æ ·å¼ï¼šä¸‰æ å¸ƒå±€å’Œè¯¦æƒ…é¢æ¿ */
        .category-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #050505;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #1a1a1a;
        }
        
        .category-item:hover {
            background: #0a0a0a;
            border-color: #2a2a2a;
        }
        
        .category-item.active {
            background: #0f0f0f;
            border-color: #3a3a3a;
        }
        
        .category-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .category-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .category-item-info {
            flex: 1;
            min-width: 0;
        }
        
        /* äºŒçº§åˆ†ç±»æ ·å¼ */
        .subcategory-list-item {
            padding: 10px 15px;
            margin-bottom: 6px;
            background: #050505;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #1a1a1a;
        }
        
        .subcategory-list-item:hover {
            background: #0a0a0a;
            border-color: #2a2a2a;
        }
        
        .subcategory-list-item.active {
            background: #0f0f0f;
            border-color: #3a3a3a;
        }
        
        .subcategory-name {
            font-weight: 500;
            color: #e0e0e0;
            margin-bottom: 4px;
        }
        
        .subcategory-count {
            font-size: 0.75rem;
            color: #888;
        }
        
        .subcategory-actions {
            display: flex;
            gap: 4px;
        }
        
        .category-item-name {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .category-item-count {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
        }
        
        .detail-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #1a1a1a;
        }
        
        .detail-section:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            font-size: 12px;
            color: #888888;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .detail-value {
            font-size: 14px;
            color: #e0e0e0;
            word-break: break-word;
            background: #0f0f0f;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #1a1a1a;
            display: inline-block;
            min-width: 100%;
        }
        
        .workflow-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 4px;
            margin-bottom: 4px;
            border: 1px solid #1a1a1a;
        }
        
        .workflow-badge.enabled {
            background: #0f0f0f;
            color: #b0b0b0;
            border-color: #2a2a2a;
        }
        
        .workflow-badge.disabled {
            background: #050505;
            color: #666666;
            border-color: #1a1a1a;
        }
        
        .image-card {
            cursor: pointer;
        }
        
        .image-card.selected {
            border: 2px solid #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }
        
        .nav-tabs {
            border-bottom: 1px solid #1a1a1a;
        }
        
        .nav-tabs .nav-link {
            color: #b0b0b0;
            border-color: transparent;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        .nav-tabs .nav-link.active {
            color: #ffffff;
            border-color: #1a1a1a #1a1a1a #0a0a0a;
            background: #0a0a0a;
            font-weight: 500;
        }
        
        .alert-info {
            background: #050505;
            border-color: #1a1a1a;
            color: #b0b0b0;
        }
        
        .text-muted {
            color: #666666 !important;
        }
        
        .badge.bg-success {
            background: #1a1a1a !important;
            border: 1px solid #2a2a2a;
        }
        
        .badge.bg-secondary {
            background: #0a0a0a !important;
            border: 1px solid #1a1a1a;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    {% include 'admin/_navbar.html' %} 

    <div class="main-content">
        <div class="container-fluid">
            <!-- é¡¶éƒ¨å·¥å…·æ  -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0">ğŸ¨ é£æ ¼åˆ†ç±»ç®¡ç†</h4>
                            <small class="text-muted">ç®¡ç†è‰ºæœ¯é£æ ¼åˆ†ç±»ã€å›¾ç‰‡å’ŒAIå·¥ä½œæµé…ç½®</small>
                        </div>
                        <div>
                            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#categoryModal">
                                <i class="fas fa-plus"></i> æ·»åŠ åˆ†ç±»
                            </button>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#imageModal">
                                <i class="fas fa-image"></i> æ·»åŠ å›¾ç‰‡
                            </button>
                            <button class="btn btn-info" onclick="openSortModal()" id="sortBtn" style="display: none;">
                                <i class="fas fa-sort"></i> æ’åº
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒºåŸŸï¼šä¸‰æ å¸ƒå±€ï¼ˆä¸€çº§åˆ†ç±» / äºŒçº§åˆ†ç±» / é£æ ¼å›¾ç‰‡ï¼‰ -->
            <div class="row g-3" style="min-height: calc(100vh - 300px);">
                <!-- å·¦ä¾§ï¼šä¸€çº§åˆ†ç±»åˆ—è¡¨ -->
                <div class="col-lg-3">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">ä¸€çº§åˆ†ç±»</h6>
                            <button class="btn btn-sm btn-outline-light" onclick="toggleCategoryList()">
                                <i class="fas fa-chevron-down" id="categoryToggleIcon"></i>
                            </button>
                        </div>
                        <div class="card-body" id="categoryListContainer" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                            <div id="categoryList">
                                <!-- åˆ†ç±»åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¸­é—´ï¼šäºŒçº§åˆ†ç±»åˆ—è¡¨ -->
                <div class="col-lg-3">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <span id="currentCategoryName">äºŒçº§åˆ†ç±»</span>
                                <small class="text-muted" id="subcategoryCount">(0)</small>
                            </h6>
                            <div>
                                <button class="btn btn-sm btn-outline-info me-1" id="sortSubcategoryBtn" onclick="openSortSubcategoryModal()" style="display: none;" title="æ’åº">
                                    <i class="fas fa-sort"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" id="addSubcategoryBtn" onclick="openAddSubcategoryModal()" style="display: none;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                            <div id="subcategoryList">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                                    <p>è¯·å…ˆé€‰æ‹©ä¸€çº§åˆ†ç±»</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šé£æ ¼å›¾ç‰‡ç½‘æ ¼ -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <span id="currentImageTitle">é£æ ¼å›¾ç‰‡</span>
                                    <small class="text-muted" id="imageCount">(0)</small>
                                </h6>
                                <div class="category-tabs" id="categoryTabs">
                                    <!-- åˆ†ç±»æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                                </div>
                            </div>
                        </div>
                        <div class="card-body" style="max-height: calc(100vh - 350px); overflow-y: auto;">
                            <div id="imageList">
                                <!-- å›¾ç‰‡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†ç±»ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">æ·»åŠ åˆ†ç±»</h5>
                    <button type="button" class="close" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId" name="id">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">åˆ†ç±»åç§°</label>
                            <input type="text" class="form-control" id="categoryName" name="name" placeholder="å¦‚ï¼šæ‹Ÿäººé£æ ¼" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryCode" class="form-label">åˆ†ç±»ä»£ç </label>
                            <input type="text" class="form-control" id="categoryCode" name="code" placeholder="å¦‚ï¼šanthropomorphic" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryDescription" class="form-label">åˆ†ç±»æè¿°</label>
                            <textarea class="form-control" id="categoryDescription" name="description" rows="3" placeholder="å¦‚ï¼šä¼¯çˆµå…¬ä¸»ã€çš‡å®¶å¤§è‡£ã€é“ ç”²æˆ˜å£«ç­‰"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="categoryIcon" class="form-label">å›¾æ ‡</label>
                            <input type="text" class="form-control" id="categoryIcon" name="icon" placeholder="å¦‚ï¼šğŸ‘‘" maxlength="10">
                        </div>
                        <div class="mb-3">
                            <label for="categoryCoverImage" class="form-label">å°é¢å›¾ç‰‡</label>
                            <div class="upload-area" onclick="document.getElementById('categoryCoverImageFile').click()">
                                <div id="categoryCoverImageUpload">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                    <p>ç‚¹å‡»ä¸Šä¼ å°é¢å›¾ç‰‡</p>
                                    <small class="text-muted">æ”¯æŒ JPGã€PNG æ ¼å¼</small>
                                </div>
                                <img id="categoryCoverImagePreview" class="preview-image" style="display: none;">
                            </div>
                            <input type="file" id="categoryCoverImageFile" accept="image/*" style="display: none;" onchange="uploadCategoryCoverImage(this)">
                            <input type="hidden" id="categoryCoverImageUrl" name="cover_image">
                        </div>
                        <div class="mb-3">
                            <label for="categorySortOrder" class="form-label">æ’åº</label>
                            <input type="number" class="form-control" id="categorySortOrder" name="sort_order" value="0">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="categoryIsActive" name="is_active" checked>
                                <label class="form-check-label" for="categoryIsActive">
                                    å¯ç”¨
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveCategory()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- äºŒçº§åˆ†ç±»ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="subcategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="subcategoryModalTitle">æ·»åŠ äºŒçº§åˆ†ç±»</h5>
                    <button type="button" class="close" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="subcategoryForm">
                        <input type="hidden" id="subcategoryId" name="id">
                        <input type="hidden" id="subcategoryCategoryId" name="category_id">
                        <div class="mb-3">
                            <label for="subcategoryName" class="form-label">äºŒçº§åˆ†ç±»åç§° *</label>
                            <input type="text" class="form-control" id="subcategoryName" name="name" placeholder="å¦‚ï¼šç”·ã€å¥³ã€å„¿ç«¥" required>
                        </div>
                        <div class="mb-3">
                            <label for="subcategoryCode" class="form-label">äºŒçº§åˆ†ç±»ä»£ç  *</label>
                            <input type="text" class="form-control" id="subcategoryCode" name="code" placeholder="å¦‚ï¼šmaleã€femaleã€child" required>
                            <small class="text-muted">åŒä¸€ä¸€çº§åˆ†ç±»ä¸‹ä»£ç ä¸èƒ½é‡å¤</small>
                        </div>
                        <div class="mb-3">
                            <label for="subcategoryIcon" class="form-label">å›¾æ ‡</label>
                            <input type="text" class="form-control" id="subcategoryIcon" name="icon" placeholder="å¦‚ï¼šğŸ‘¨" maxlength="10">
                        </div>
                        <div class="mb-3">
                            <label for="subcategoryCoverImage" class="form-label">å°é¢å›¾ç‰‡</label>
                            <div class="upload-area" onclick="document.getElementById('subcategoryCoverImageFile').click()">
                                <div id="subcategoryCoverImageUpload">
                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                    <p>ç‚¹å‡»ä¸Šä¼ å°é¢å›¾ç‰‡</p>
                                    <small class="text-muted">æ”¯æŒ JPGã€PNG æ ¼å¼</small>
                                </div>
                                <img id="subcategoryCoverImagePreview" class="preview-image" style="display: none;">
                            </div>
                            <input type="file" id="subcategoryCoverImageFile" accept="image/*" style="display: none;" onchange="uploadSubcategoryCoverImage(this)">
                            <input type="hidden" id="subcategoryCoverImageUrl" name="cover_image">
                        </div>
                        <div class="mb-3">
                            <label for="subcategorySortOrder" class="form-label">æ’åº</label>
                            <input type="number" class="form-control" id="subcategorySortOrder" name="sort_order" value="0">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="subcategoryIsActive" name="is_active" checked>
                                <label class="form-check-label" for="subcategoryIsActive">
                                    å¯ç”¨
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveSubcategory()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalTitle">æ·»åŠ å›¾ç‰‡</h5>
                    <button type="button" class="close" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="imageTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#imageBasicInfo">åŸºæœ¬ä¿¡æ¯</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#imageWorkflow">AIå·¥ä½œæµé…ç½®</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#imageWorkflowTest">æµ‹è¯•å·¥ä½œæµ</a>
                        </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#imageApiEdit">APIç¼–è¾‘</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#imageApiTest">APIæµ‹è¯•</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#imageApiComfyUI">API-ComfyUIå·¥ä½œæµ</a>
                            </li>
                    </ul>
                    <form id="imageForm">
                        <input type="hidden" id="imageId" name="id">
                        <div class="tab-content">
                            <!-- åŸºæœ¬ä¿¡æ¯æ ‡ç­¾é¡µ -->
                            <div class="tab-pane fade show active" id="imageBasicInfo">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="imageCategory" class="form-label">æ‰€å±åˆ†ç±»</label>
                                            <select class="form-control" id="imageCategory" name="category_id" required onchange="updateImageFormFields()">
                                                <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="imageSubcategoryId" class="form-label">æ‰€å±äºŒçº§åˆ†ç±»</label>
                                            <select class="form-control" id="imageSubcategoryId" name="subcategory_id">
                                                <option value="">è¯·é€‰æ‹©äºŒçº§åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>
                                            </select>
                                            <small class="form-text text-muted">å¯é€‰ï¼Œç”¨äºè¿›ä¸€æ­¥ç»†åˆ†åˆ†ç±»</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="imageName" class="form-label">é£æ ¼åç§°</label>
                                            <input type="text" class="form-control" id="imageName" name="name" placeholder="å¦‚ï¼šå¨å»‰å›½ç‹" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="imageCode" class="form-label">é£æ ¼ä»£ç </label>
                                            <input type="text" class="form-control" id="imageCode" name="code" readonly>
                                            <small class="form-text text-muted">è‡ªåŠ¨ä½¿ç”¨åˆ†ç±»çš„ä»£ç </small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="imageDescription" class="form-label">é£æ ¼æè¿°</label>
                                            <textarea class="form-control" id="imageDescription" name="description" rows="3" readonly></textarea>
                                            <small class="form-text text-muted">è‡ªåŠ¨ä½¿ç”¨åˆ†ç±»çš„æè¿°</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="imageUpload" class="form-label">å›¾ç‰‡ä¸Šä¼ </label>
                                            <div class="upload-area" onclick="document.getElementById('imageFile').click()">
                                                <div id="imageUploadArea">
                                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                                    <p>ç‚¹å‡»ä¸Šä¼ é£æ ¼å›¾ç‰‡</p>
                                                    <small class="text-muted">æ”¯æŒ JPGã€PNG æ ¼å¼</small>
                                                </div>
                                                <img id="imagePreview" class="preview-image" style="display: none;">
                                            </div>
                                            <input type="file" id="imageFile" accept="image/*" style="display: none;" onchange="uploadImage(this)">
                                            <input type="hidden" id="imageUrl" name="image_url">
                                        </div>
                                        <div class="mb-3">
                                            <label for="designImageUpload" class="form-label">è®¾è®¡æ°´å°å›¾ç‰‡</label>
                                            <div class="upload-area" onclick="document.getElementById('designImageFile').click()" style="min-height: 120px;">
                                                <div id="designImageUploadArea">
                                                    <i class="fas fa-water fa-2x mb-2"></i>
                                                    <p>ç‚¹å‡»ä¸Šä¼ è®¾è®¡æ°´å°</p>
                                                    <small class="text-muted">æ”¯æŒ PNG æ ¼å¼ï¼ˆé€æ˜èƒŒæ™¯ï¼‰</small>
                                                </div>
                                                <img id="designImagePreview" class="preview-image" style="display: none;">
                                            </div>
                                            <input type="file" id="designImageFile" accept="image/png" style="display: none;" onchange="uploadDesignImage(this)">
                                            <input type="hidden" id="designImageUrl" name="design_image_url">
                                            <small class="form-text text-muted">ç”¨äºé€‰ç‰‡é¡µé¢é¢„è§ˆè®¾è®¡æ•ˆæœï¼Œå»ºè®®ä½¿ç”¨é€æ˜èƒŒæ™¯çš„PNGå›¾ç‰‡</small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="imageSortOrder" class="form-label">æ’åº</label>
                                            <input type="number" class="form-control" id="imageSortOrder" name="sort_order" value="0">
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="imageIsActive" name="is_active" checked>
                                                <label class="form-check-label" for="imageIsActive">
                                                    å¯ç”¨
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AIå·¥ä½œæµé…ç½®æ ‡ç­¾é¡µ -->
                            <div class="tab-pane fade" id="imageWorkflow">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> é…ç½®æ­¤å›¾ç‰‡çš„ç‹¬ç«‹AIå·¥ä½œæµã€‚å¦‚æœå¯ç”¨ï¼Œå°†è¦†ç›–åˆ†ç±»çš„é»˜è®¤å·¥ä½œæµé…ç½®ã€‚
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="imageIsAiEnabled" name="is_ai_enabled">
                                        <label class="form-check-label" for="imageIsAiEnabled">
                                            å¯ç”¨ç‹¬ç«‹AIå·¥ä½œæµï¼ˆè¦†ç›–åˆ†ç±»é…ç½®ï¼‰
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">å¦‚æœä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨åˆ†ç±»çš„é»˜è®¤å·¥ä½œæµé…ç½®</small>
                                </div>
                                <div id="imageWorkflowConfig" style="display: none;">
                                    <div class="mb-3">
                                        <label for="imageWorkflowFile" class="form-label">å·¥ä½œæµæ–‡ä»¶</label>
                                        <div class="input-group">
                                            <input type="file" id="imageWorkflowFileInput" accept=".json" style="display: none;" onchange="uploadWorkflowFile(this, 'image')">
                                            <input type="text" class="form-control" id="imageWorkflowFile" name="workflow_file" placeholder="é€‰æ‹©å·¥ä½œæµJSONæ–‡ä»¶" readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('imageWorkflowFileInput').click()">
                                                <i class="fas fa-upload"></i> ä¸Šä¼ 
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">ä¸Šä¼ ComfyUIå·¥ä½œæµJSONæ–‡ä»¶</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageWorkflowName" class="form-label">å·¥ä½œæµåç§°</label>
                                        <input type="text" class="form-control" id="imageWorkflowName" name="workflow_name" placeholder="è‡ªåŠ¨ä»æ–‡ä»¶åæå–ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥">
                                        <small class="form-text text-muted">å·¥ä½œæµåç§°ï¼ˆä¸å«.jsonæ‰©å±•åï¼‰</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageWorkflowInputIds" class="form-label">è¾“å…¥å›¾ç‰‡èŠ‚ç‚¹ID</label>
                                        <input type="text" class="form-control" id="imageWorkflowInputIds" name="workflow_input_ids" placeholder='å¦‚ï¼š["199"] æˆ– 199'>
                                        <small class="form-text text-muted">JSONæ•°ç»„æ ¼å¼ï¼Œå¦‚ï¼š["199"] æˆ–å•ä¸ªIDï¼š199</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageWorkflowOutputId" class="form-label">è¾“å‡ºèŠ‚ç‚¹ID</label>
                                        <input type="text" class="form-control" id="imageWorkflowOutputId" name="workflow_output_id" placeholder="å¦‚ï¼š136">
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageWorkflowRefId" class="form-label">å‚è€ƒå›¾èŠ‚ç‚¹IDï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="text" class="form-control" id="imageWorkflowRefId" name="workflow_ref_id" placeholder="å¦‚ï¼š20">
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageWorkflowRefImage" class="form-label">å‚è€ƒå›¾æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="text" class="form-control" id="imageWorkflowRefImage" name="workflow_ref_image" placeholder="å‚è€ƒå›¾æ–‡ä»¶å">
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageWorkflowCustomPromptId" class="form-label">è‡ªå®šä¹‰æç¤ºè¯èŠ‚ç‚¹IDï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="text" class="form-control" id="imageWorkflowCustomPromptId" name="workflow_custom_prompt_id" placeholder="å¦‚ï¼š84">
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageWorkflowCustomPromptContent" class="form-label">è‡ªå®šä¹‰æç¤ºè¯å†…å®¹ï¼ˆå¯é€‰ï¼‰</label>
                                        <textarea class="form-control" id="imageWorkflowCustomPromptContent" name="workflow_custom_prompt_content" rows="3" placeholder="å¦‚ï¼špassport photo, white background"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æµ‹è¯•å·¥ä½œæµæ ‡ç­¾é¡µ -->
                            <div class="tab-pane fade" id="imageWorkflowTest">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> ä¸Šä¼ æµ‹è¯•å›¾ç‰‡ï¼Œå¿«é€Ÿæµ‹è¯•å½“å‰é…ç½®çš„å·¥ä½œæµæ˜¯å¦èƒ½æ­£å¸¸è°ƒç”¨ComfyUIã€‚
                                </div>
                                <div class="mb-3">
                                    <label for="testImageUpload" class="form-label">ä¸Šä¼ æµ‹è¯•å›¾ç‰‡ï¼ˆæ”¯æŒå¤šå›¾ï¼‰</label>
                                    <div class="upload-area" onclick="document.getElementById('testImageFile').click()" style="min-height: 200px; border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer;">
                                        <div id="testImageUploadArea">
                                            <i class="fas fa-cloud-upload-alt fa-3x mb-2 text-muted"></i>
                                            <p class="mb-0">ç‚¹å‡»ä¸Šä¼ æµ‹è¯•å›¾ç‰‡</p>
                                            <small class="text-muted">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå¯å¤šé€‰</small>
                                        </div>
                                        <div id="testImagePreviewContainer" style="display: none; margin-top: 10px;">
                                            <div id="testImagePreviews" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                                        </div>
                                    </div>
                                    <input type="file" id="testImageFile" accept="image/*" multiple style="display: none;" onchange="handleTestImageUpload(this)">
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary w-100" id="testWorkflowBtn" onclick="testWorkflow()" disabled>
                                        <i class="fas fa-play"></i> å¼€å§‹æµ‹è¯•
                                    </button>
                                </div>
                                <div id="testResult" style="display: none;">
                                    <div class="alert" id="testResultAlert">
                                        <h6>æµ‹è¯•ç»“æœ</h6>
                                        <div id="testResultContent"></div>
                                    </div>
                                </div>
                                <div id="testProgress" style="display: none;">
                                    <div class="progress mb-3">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">å¤„ç†ä¸­...</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- APIç¼–è¾‘æ ‡ç­¾é¡µ -->
                            <div class="tab-pane fade" id="imageApiEdit">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> é…ç½®æ­¤é£æ ¼å›¾ç‰‡çš„APIè°ƒç”¨æ¨¡æ¿ã€‚å¦‚æœå¯ç”¨ï¼Œå°†ä½¿ç”¨APIæœåŠ¡å•†è¿›è¡Œå›¾ç‰‡ç”Ÿæˆã€‚
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="imageApiTemplateEnabled" name="api_template_enabled" onchange="toggleApiTemplateConfig()">
                                        <label class="form-check-label" for="imageApiTemplateEnabled">
                                            å¯ç”¨APIæ¨¡æ¿ï¼ˆè¦†ç›–å·¥ä½œæµé…ç½®ï¼‰
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">å¦‚æœä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨AIå·¥ä½œæµé…ç½®</small>
                                </div>
                                <div id="imageApiTemplateConfig" style="display: none;">
                                    <div class="mb-3">
                                        <label for="imageApiConfigId" class="form-label">APIé…ç½®</label>
                                        <select class="form-select" id="imageApiConfigId" name="api_config_id" onchange="toggleApiConfigFields()">
                                            <option value="">ä½¿ç”¨å…¨å±€é»˜è®¤APIé…ç½®</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            <a href="/admin/ai-provider/config" target="_blank">ç®¡ç†APIé…ç½®</a>
                                        </small>
                                    </div>
                                    <!-- RunningHub ComfyUI å·¥ä½œæµé…ç½®ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                                    <div class="mb-3" id="imageWorkflowId" style="display: none;">
                                        <label for="imageWorkflowIdInput" class="form-label">å·¥ä½œæµID <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="imageWorkflowIdInput" name="workflow_id" placeholder="ä¾‹å¦‚: 2004148282525949953">
                                        <small class="form-text text-muted">
                                            ä» RunningHub å·¥ä½œæµé¡µé¢è·å–ï¼Œæ ¼å¼ï¼š/run/workflow/{workflow_id} ä¸­çš„ workflow_id
                                            <br>å‚è€ƒæ–‡æ¡£: <a href="https://www.runninghub.cn/call-api/api-detail/2004375142916210689?apiType=3" target="_blank">RunningHub ComfyUI å·¥ä½œæµ API</a>
                                        </small>
                                    </div>
                                    <div class="mb-3" id="imageRhWorkflowInputIds" style="display: none;">
                                        <label for="imageRhWorkflowInputIdsInput" class="form-label">è¾“å…¥å›¾ç‰‡èŠ‚ç‚¹ID <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="imageRhWorkflowInputIdsInput" name="rh_workflow_input_ids" placeholder='å¦‚ï¼š["7"] æˆ– 7'>
                                        <small class="form-text text-muted">JSONæ•°ç»„æ ¼å¼ï¼Œå¦‚ï¼š["7"] æˆ–å•ä¸ªIDï¼š7ï¼ˆå›¾ç‰‡å°†è‡ªåŠ¨æ˜ å°„åˆ°è¯¥èŠ‚ç‚¹çš„ image æˆ– imageUrls å‚æ•°ï¼‰</small>
                                    </div>
                                    <div class="mb-3" id="imageRhWorkflowOutputId" style="display: none;">
                                        <label for="imageRhWorkflowOutputIdInput" class="form-label">è¾“å‡ºèŠ‚ç‚¹ID</label>
                                        <input type="text" class="form-control" id="imageRhWorkflowOutputIdInput" name="rh_workflow_output_id" placeholder="å¦‚ï¼š4">
                                        <small class="form-text text-muted">å·¥ä½œæµçš„è¾“å‡ºèŠ‚ç‚¹IDï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰</small>
                                    </div>
                                    <div class="mb-3" id="imageRhWorkflowPromptId" style="display: none;">
                                        <label for="imageRhWorkflowPromptIdInput" class="form-label">æç¤ºè¯èŠ‚ç‚¹IDï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="text" class="form-control" id="imageRhWorkflowPromptIdInput" name="rh_workflow_prompt_id" placeholder="å¦‚ï¼š6ï¼ˆç•™ç©ºè¡¨ç¤ºå·¥ä½œæµå·²å†…ç½®æç¤ºè¯ï¼‰">
                                        <small class="form-text text-muted">
                                            æç¤ºè¯èŠ‚ç‚¹IDï¼Œç”¨æˆ·è¾“å…¥çš„æç¤ºè¯å°†è‡ªåŠ¨æ˜ å°„åˆ°è¯¥èŠ‚ç‚¹çš„ text å‚æ•°
                                            <br><span class="text-info">ğŸ’¡ å¦‚æœå·¥ä½œæµä¸­å·²ç»å†…ç½®äº†å›ºå®šæç¤ºè¯ï¼Œå¯ä»¥ç•™ç©ºï¼Œç³»ç»Ÿä¸ä¼šæ·»åŠ æç¤ºè¯èŠ‚ç‚¹</span>
                                        </small>
                                    </div>
                                    <div class="mb-3" id="imageRhWorkflowRefId" style="display: none;">
                                        <label for="imageRhWorkflowRefIdInput" class="form-label">å‚è€ƒå›¾èŠ‚ç‚¹IDï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="text" class="form-control" id="imageRhWorkflowRefIdInput" name="rh_workflow_ref_id" placeholder="å¦‚ï¼š20">
                                        <small class="form-text text-muted">å‚è€ƒå›¾èŠ‚ç‚¹IDï¼ˆå¦‚æœæœ‰å¤šä¸ªä¸Šä¼ å…¥å£ï¼Œç¬¬äºŒä¸ªå›¾ç‰‡å°†æ˜ å°„åˆ°æ­¤èŠ‚ç‚¹ï¼‰</small>
                                    </div>
                                    <div class="mb-3" id="imageRhWorkflowCustomPromptId" style="display: none;">
                                        <label for="imageRhWorkflowCustomPromptIdInput" class="form-label">è‡ªå®šä¹‰æç¤ºè¯èŠ‚ç‚¹IDï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="text" class="form-control" id="imageRhWorkflowCustomPromptIdInput" name="rh_workflow_custom_prompt_id" placeholder="å¦‚ï¼š84">
                                        <small class="form-text text-muted">è‡ªå®šä¹‰æç¤ºè¯èŠ‚ç‚¹IDï¼ˆç”¨äºå›ºå®šæç¤ºè¯ï¼Œä¸ä¼šä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯ï¼‰</small>
                                    </div>
                                    <div class="mb-3" id="imageRhWorkflowCustomPromptContent" style="display: none;">
                                        <label for="imageRhWorkflowCustomPromptContentInput" class="form-label">è‡ªå®šä¹‰æç¤ºè¯å†…å®¹ï¼ˆå¯é€‰ï¼‰</label>
                                        <textarea class="form-control" id="imageRhWorkflowCustomPromptContentInput" name="rh_workflow_custom_prompt_content" rows="3" placeholder="å¦‚ï¼špassport photo, white background"></textarea>
                                        <small class="form-text text-muted">è‡ªå®šä¹‰æç¤ºè¯å†…å®¹ï¼ˆå°†æ˜ å°„åˆ°è‡ªå®šä¹‰æç¤ºè¯èŠ‚ç‚¹ï¼‰</small>
                                    </div>
                                    <!-- æ¨¡å‹åç§°å·²ç§»é™¤ï¼šç›´æ¥ä½¿ç”¨APIæœåŠ¡å•†é…ç½®ä¸­çš„æ¨¡å‹åç§° -->
                                    <div class="mb-3">
                                        <!-- é»˜è®¤æç¤ºè¯å­—æ®µå·²ç§»é™¤ï¼Œç°åœ¨åªä½¿ç”¨æ‰¹é‡æç¤ºè¯ -->
                                        <label class="form-label">æ‰¹é‡æç¤ºè¯é…ç½®</label>
                                        <div class="card bg-light border">
                                            <div class="card-body">
                                                <p class="text-muted small mb-3">
                                                    é…ç½®å¤šä¸ªæç¤ºè¯ï¼Œç”¨æˆ·ä¸Šä¼ 1å¼ å›¾å°†æ ¹æ®æç¤ºè¯æ•°é‡åˆ›å»ºå¤šä¸ªä»»åŠ¡ï¼ˆæ¯ä¸ªæç¤ºè¯ä¸€ä¸ªä»»åŠ¡ï¼‰ã€‚
                                                    <br>å¦‚æœé…ç½®äº†æ‰¹é‡æç¤ºè¯ï¼Œå°†å¿½ç•¥ä¸Šé¢çš„"é»˜è®¤æç¤ºè¯"ã€‚
                                                </p>
                                                <div id="imagePromptsList">
                                                    <!-- æç¤ºè¯åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                                                </div>
                                                <button type="button" class="btn btn-sm btn-primary mt-2" onclick="addImagePrompt()">
                                                    <i class="fas fa-plus"></i> æ·»åŠ æç¤ºè¯
                                                </button>
                                                <input type="hidden" id="imagePromptsJson" name="prompts_json" value="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="imageApiPromptEditable" name="prompt_editable" checked>
                                            <label class="form-check-label" for="imageApiPromptEditable">
                                                å…è®¸ç”¨æˆ·ç¼–è¾‘æç¤ºè¯
                                            </label>
                                        </div>
                                        <small class="form-text text-muted">å¦‚æœå‹¾é€‰ï¼Œç”¨æˆ·åœ¨ç”Ÿæˆé¡µé¢å¯ä»¥ä¿®æ”¹æç¤ºè¯ï¼›å¦‚æœä¸å‹¾é€‰ï¼Œæç¤ºè¯å°†å›ºå®šä¸ºé»˜è®¤å€¼</small>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="imageApiDefaultSize" class="form-label">é»˜è®¤å°ºå¯¸</label>
                                            <select class="form-select" id="imageApiDefaultSize" name="default_size">
                                                <option value="1K">1K</option>
                                                <option value="2K">2K</option>
                                                <option value="4K">4K</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="imageApiDefaultAspectRatio" class="form-label">é»˜è®¤æ¯”ä¾‹</label>
                                            <select class="form-select" id="imageApiDefaultAspectRatio" name="default_aspect_ratio">
                                                <option value="auto">auto</option>
                                                <option value="1:1">1:1</option>
                                                <option value="16:9">16:9</option>
                                                <option value="9:16">9:16</option>
                                                <option value="4:3">4:3</option>
                                                <option value="3:4">3:4</option>
                                                <option value="3:2">3:2</option>
                                                <option value="2:3">2:3</option>
                                                <option value="5:4">5:4</option>
                                                <option value="4:5">4:5</option>
                                                <option value="21:9">21:9</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="imageApiSizeEditable" name="size_editable" checked>
                                            <label class="form-check-label" for="imageApiSizeEditable">
                                                å…è®¸ç”¨æˆ·é€‰æ‹©å°ºå¯¸
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="imageApiAspectRatioEditable" name="aspect_ratio_editable" checked>
                                            <label class="form-check-label" for="imageApiAspectRatioEditable">
                                                å…è®¸ç”¨æˆ·é€‰æ‹©æ¯”ä¾‹
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageApiPointsCost" class="form-label">ç§¯åˆ†æ‰£é™¤</label>
                                        <input type="number" class="form-control" id="imageApiPointsCost" name="points_cost" value="0" min="0">
                                        <small class="form-text text-muted">æ¯æ¬¡ç”Ÿæˆæ¶ˆè€—çš„ç§¯åˆ†æ•°é‡</small>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="imageApiEnhancePrompt" name="enhance_prompt">
                                            <label class="form-check-label" for="imageApiEnhancePrompt">
                                                å¼€å¯ä¸­æ–‡è‡ªåŠ¨è½¬è‹±æ–‡ï¼ˆVEOæ¨¡å‹ï¼‰
                                            </label>
                                        </div>
                                        <small class="form-text text-muted">VEOæ¨¡å‹åªæ”¯æŒè‹±æ–‡æç¤ºè¯ï¼Œå¼€å¯åä¼šè‡ªåŠ¨å°†ä¸­æ–‡æç¤ºè¯è½¬æ¢ä¸ºè‹±æ–‡</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">ä¸Šä¼ é…ç½®</label>
                                        <div class="card bg-light border">
                                            <div class="card-body">
                                                <p class="text-muted small mb-3">é…ç½®ç”Ÿæˆé¡µé¢çš„ä¸Šä¼ å…¥å£ï¼Œä¾‹å¦‚ï¼šå¯ä»¥é…ç½®"å‚è€ƒå›¾"å’Œ"æ¨¡ç‰¹å›¾"ä¸¤ä¸ªä¸Šä¼ å…¥å£ã€‚å¦‚æœä¸é…ç½®ï¼Œåˆ™åªæœ‰ä¸€ä¸ªé»˜è®¤ä¸Šä¼ å…¥å£ã€‚</p>
                                                <div id="imageUploadConfigList">
                                                    <!-- ä¸Šä¼ é…ç½®é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                                                </div>
                                                <button type="button" class="btn btn-sm btn-primary mt-2" onclick="addImageUploadConfig()">
                                                    <i class="fas fa-plus"></i> æ·»åŠ ä¸Šä¼ å…¥å£
                                                </button>
                                                <input type="hidden" id="imageUploadConfigJson" name="upload_config" value="">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- API-ComfyUIå·¥ä½œæµæ ‡ç­¾é¡µ -->
                            <div class="tab-pane fade" id="imageApiComfyUI">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> é…ç½®é€šè¿‡APIæœåŠ¡å•†è°ƒç”¨çš„ComfyUIå·¥ä½œæµï¼ˆå¦‚RunningHubï¼‰ã€‚ä¸æœ¬åœ°ComfyUIå·¥ä½œæµä¸åŒï¼Œè¿™é‡Œé€šè¿‡APIæœåŠ¡å•†è°ƒç”¨è¿œç¨‹ComfyUIæœåŠ¡å™¨ã€‚
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="imageApiComfyUIEnabled" name="api_comfyui_enabled" onchange="toggleApiComfyUIConfig()">
                                        <label class="form-check-label" for="imageApiComfyUIEnabled">
                                            å¯ç”¨API-ComfyUIå·¥ä½œæµï¼ˆè¦†ç›–å…¶ä»–é…ç½®ï¼‰
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">å¦‚æœå¯ç”¨ï¼Œå°†ä½¿ç”¨APIæœåŠ¡å•†çš„ComfyUIå·¥ä½œæµè¿›è¡Œå›¾ç‰‡ç”Ÿæˆ</small>
                                </div>
                                <div id="imageApiComfyUIConfig" style="display: none;">
                                    <div class="mb-3">
                                        <label for="imageApiComfyUIConfigId" class="form-label">APIé…ç½®</label>
                                        <select class="form-select" id="imageApiComfyUIConfigId" name="api_comfyui_config_id" onchange="handleApiComfyUIConfigChange()">
                                            <option value="">ä½¿ç”¨å…¨å±€é»˜è®¤APIé…ç½®</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            <a href="/admin/ai-provider/config" target="_blank">ç®¡ç†APIé…ç½®</a>
                                            <br><span class="text-warning">âš ï¸ è¯·é€‰æ‹© runninghub-comfyui-workflow ç±»å‹çš„APIé…ç½®</span>
                                        </small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageApiComfyUIWorkflowId" class="form-label">å·¥ä½œæµID <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="imageApiComfyUIWorkflowId" name="api_comfyui_workflow_id" placeholder="ä¾‹å¦‚: 2004148282525949953">
                                        <small class="form-text text-muted">
                                            ä» RunningHub å·¥ä½œæµé¡µé¢è·å–ï¼Œæ ¼å¼ï¼š/run/workflow/{workflow_id} ä¸­çš„ workflow_id
                                            <br>å‚è€ƒæ–‡æ¡£: <a href="https://www.runninghub.cn/call-api/api-detail/2004375142916210689?apiType=3" target="_blank">RunningHub ComfyUI å·¥ä½œæµ API</a>
                                        </small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageApiComfyUIInputIds" class="form-label">è¾“å…¥å›¾ç‰‡èŠ‚ç‚¹ID <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="imageApiComfyUIInputIds" name="api_comfyui_input_ids" placeholder='å¦‚ï¼š["7"] æˆ– 7'>
                                        <small class="form-text text-muted">JSONæ•°ç»„æ ¼å¼ï¼Œå¦‚ï¼š["7"] æˆ–å•ä¸ªIDï¼š7ï¼ˆå›¾ç‰‡å°†è‡ªåŠ¨æ˜ å°„åˆ°è¯¥èŠ‚ç‚¹çš„ image æˆ– imageUrls å‚æ•°ï¼‰</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageApiComfyUIOutputId" class="form-label">è¾“å‡ºèŠ‚ç‚¹ID</label>
                                        <input type="text" class="form-control" id="imageApiComfyUIOutputId" name="api_comfyui_output_id" placeholder="å¦‚ï¼š4">
                                        <small class="form-text text-muted">å·¥ä½œæµçš„è¾“å‡ºèŠ‚ç‚¹IDï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageApiComfyUIPromptId" class="form-label">æç¤ºè¯èŠ‚ç‚¹IDï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="text" class="form-control" id="imageApiComfyUIPromptId" name="api_comfyui_prompt_id" placeholder="å¦‚ï¼š6ï¼ˆç•™ç©ºè¡¨ç¤ºå·¥ä½œæµå·²å†…ç½®æç¤ºè¯ï¼‰">
                                        <small class="form-text text-muted">
                                            æç¤ºè¯èŠ‚ç‚¹IDï¼Œç”¨æˆ·è¾“å…¥çš„æç¤ºè¯å°†è‡ªåŠ¨æ˜ å°„åˆ°è¯¥èŠ‚ç‚¹çš„ text å‚æ•°
                                            <br><span class="text-info">ğŸ’¡ å¦‚æœå·¥ä½œæµä¸­å·²ç»å†…ç½®äº†å›ºå®šæç¤ºè¯ï¼Œå¯ä»¥ç•™ç©ºï¼Œç³»ç»Ÿä¸ä¼šæ·»åŠ æç¤ºè¯èŠ‚ç‚¹</span>
                                        </small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageApiComfyUIRefId" class="form-label">å‚è€ƒå›¾èŠ‚ç‚¹IDï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="text" class="form-control" id="imageApiComfyUIRefId" name="api_comfyui_ref_id" placeholder="å¦‚ï¼š20">
                                        <small class="form-text text-muted">å‚è€ƒå›¾èŠ‚ç‚¹IDï¼ˆå¦‚æœæœ‰å¤šä¸ªä¸Šä¼ å…¥å£ï¼Œç¬¬äºŒä¸ªå›¾ç‰‡å°†æ˜ å°„åˆ°æ­¤èŠ‚ç‚¹ï¼‰</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageApiComfyUICustomPromptId" class="form-label">è‡ªå®šä¹‰æç¤ºè¯èŠ‚ç‚¹IDï¼ˆå¯é€‰ï¼‰</label>
                                        <input type="text" class="form-control" id="imageApiComfyUICustomPromptId" name="api_comfyui_custom_prompt_id" placeholder="å¦‚ï¼š84">
                                        <small class="form-text text-muted">è‡ªå®šä¹‰æç¤ºè¯èŠ‚ç‚¹IDï¼ˆç”¨äºå›ºå®šæç¤ºè¯ï¼Œä¸ä¼šä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯ï¼‰</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageApiComfyUICustomPromptContent" class="form-label">è‡ªå®šä¹‰æç¤ºè¯å†…å®¹ï¼ˆå¯é€‰ï¼‰</label>
                                        <textarea class="form-control" id="imageApiComfyUICustomPromptContent" name="api_comfyui_custom_prompt_content" rows="3" placeholder="å¦‚ï¼špassport photo, white background"></textarea>
                                        <small class="form-text text-muted">è‡ªå®šä¹‰æç¤ºè¯å†…å®¹ï¼ˆå°†æ˜ å°„åˆ°è‡ªå®šä¹‰æç¤ºè¯èŠ‚ç‚¹ï¼‰</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imageApiComfyUIPointsCost" class="form-label">ç§¯åˆ†æ‰£é™¤</label>
                                        <input type="number" class="form-control" id="imageApiComfyUIPointsCost" name="api_comfyui_points_cost" value="0" min="0">
                                        <small class="form-text text-muted">æ¯æ¬¡ç”Ÿæˆæ¶ˆè€—çš„ç§¯åˆ†æ•°é‡</small>
                                    </div>
                                </div>
                                <div class="mb-3 mt-4">
                                    <hr>
                                    <h6>æµ‹è¯•API-ComfyUIå·¥ä½œæµ</h6>
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i> ä¸Šä¼ æµ‹è¯•å›¾ç‰‡ï¼Œå¿«é€Ÿæµ‹è¯•å½“å‰é…ç½®çš„API-ComfyUIå·¥ä½œæµæ˜¯å¦èƒ½æ­£å¸¸è°ƒç”¨ã€‚
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">ä¸Šä¼ æµ‹è¯•å›¾ç‰‡ï¼ˆæ”¯æŒå¤šå›¾ï¼‰</label>
                                        <div id="apiComfyUITestUploadArea" class="upload-area" onclick="document.getElementById('apiComfyUITestImageFile').click()" style="min-height: 200px; border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer;">
                                            <i class="fas fa-cloud-upload-alt fa-3x mb-2 text-muted"></i>
                                            <p class="mb-0">ç‚¹å‡»ä¸Šä¼ æµ‹è¯•å›¾ç‰‡</p>
                                            <small class="text-muted">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå¯å¤šé€‰</small>
                                        </div>
                                        <div id="apiComfyUITestImagePreviewContainer" style="display: none; margin-top: 10px;">
                                            <div id="apiComfyUITestImagePreviews" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                                        </div>
                                        <input type="file" id="apiComfyUITestImageFile" accept="image/*" multiple style="display: none;" onchange="handleApiComfyUITestImageUpload(this)">
                                    </div>
                                    <div class="mb-3">
                                        <label for="apiComfyUITestPrompt" class="form-label">æµ‹è¯•æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
                                        <textarea class="form-control" id="apiComfyUITestPrompt" rows="3" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤æç¤ºè¯ï¼ˆå¦‚æœå·¥ä½œæµå·²å†…ç½®æç¤ºè¯ï¼Œæ­¤å­—æ®µæ— æ•ˆï¼‰"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-primary w-100" id="testApiComfyUIBtn" onclick="testApiComfyUI()" disabled>
                                            <i class="fas fa-play"></i> å¼€å§‹æµ‹è¯•
                                        </button>
                                    </div>
                                    <div id="apiComfyUITestResult" style="display: none;">
                                        <div class="alert" id="apiComfyUITestResultAlert">
                                            <h6>æµ‹è¯•ç»“æœ</h6>
                                            <div id="apiComfyUITestResultContent"></div>
                                        </div>
                                    </div>
                                    <div id="apiComfyUITestProgress" style="display: none;">
                                        <div class="progress mb-3">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">å¤„ç†ä¸­...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- APIæµ‹è¯•æ ‡ç­¾é¡µ -->
                            <div class="tab-pane fade" id="imageApiTest">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> ä¸Šä¼ æµ‹è¯•å›¾ç‰‡ï¼Œå¿«é€Ÿæµ‹è¯•å½“å‰é…ç½®çš„APIæ¨¡æ¿æ˜¯å¦èƒ½æ­£å¸¸è°ƒç”¨APIæœåŠ¡å•†ã€‚
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ä¸Šä¼ æµ‹è¯•å›¾ç‰‡</label>
                                    <div id="apiTestUploadAreas">
                                        <!-- ä¸Šä¼ åŒºåŸŸå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="apiTestPrompt" class="form-label">æµ‹è¯•æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
                                    <textarea class="form-control" id="apiTestPrompt" rows="3" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨æ‰¹é‡æç¤ºè¯ï¼ˆprompts_jsonï¼‰"></textarea>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary w-100" id="testApiBtn" onclick="testApiTemplate()" disabled>
                                        <i class="fas fa-play"></i> å¼€å§‹æµ‹è¯•
                                    </button>
                                </div>
                                <div id="apiTestResult" style="display: none;">
                                    <div class="alert" id="apiTestResultAlert">
                                        <h6>æµ‹è¯•ç»“æœ</h6>
                                        <div id="apiTestResultContent"></div>
                                    </div>
                                </div>
                                <div id="apiTestProgress" style="display: none;">
                                    <div class="progress mb-3">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">å¤„ç†ä¸­...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveImage()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        // å®‰å…¨çš„æ ·å¼è®¾ç½®è¾…åŠ©å‡½æ•°
        function safeSetDisplay(elementId, display) {
            const el = document.getElementById(elementId);
            if (el) el.style.display = display;
        }
        
        // å…¨å±€å˜é‡
        let categories = [];
        let images = [];
        let currentCategoryId = null;
        let savedScrollPosition = 0; // ä¿å­˜æ»šåŠ¨ä½ç½®

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
        });
        
        // ä¿å­˜æ»šåŠ¨ä½ç½®
        function saveScrollPosition() {
            savedScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
        }
        
        // æ¢å¤æ»šåŠ¨ä½ç½®
        function restoreScrollPosition() {
            setTimeout(() => {
                window.scrollTo(0, savedScrollPosition);
            }, 100);
        }

        // åŠ è½½åˆ†ç±»æ•°æ®
        async function loadCategories() {
            try {
                const response = await fetch('/api/admin/styles/categories');
                const data = await response.json();
                if (data.status === 'success') {
                    categories = data.data;
                    renderCategories();
                    // å…ˆåŠ è½½åˆ†ç±»ï¼Œå†åŠ è½½å›¾ç‰‡ï¼Œç¡®ä¿æ•°æ®é¡ºåºæ­£ç¡®
                    await loadImages();
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
            }
        }

        // åŠ è½½å›¾ç‰‡æ•°æ®
        async function loadImages(preserveCategory = false) {
            try {
                // ä¿å­˜å½“å‰é€‰ä¸­çš„åˆ†ç±»ID
                const savedCategoryId = preserveCategory ? currentCategoryId : null;
                
                const response = await fetch('/api/admin/styles/images');
                const data = await response.json();
                if (data.status === 'success') {
                    images = data.data;
                    // è°ƒè¯•ï¼šæ£€æŸ¥"è¥¿è£…"çš„æ•°æ®
                    const xizhuang = images.find(img => img.name === 'è¥¿è£…');
                    if (xizhuang) {
                        console.log('ğŸ” åˆ·æ–°å"è¥¿è£…"çš„å®Œæ•´æ•°æ®:', xizhuang);
                        console.log('ğŸ” "è¥¿è£…"çš„APIæ¨¡æ¿å­—æ®µ:', {
                            api_template_id: xizhuang.api_template_id,
                            api_config_id: xizhuang.api_config_id,
                            api_provider: xizhuang.api_provider,
                            api_template_type: xizhuang.api_template_type
                        });
                    }
                    // å…ˆæ¸²æŸ“åˆ†ç±»åˆ—è¡¨ï¼ˆéœ€è¦å›¾ç‰‡æ•°æ®æ¥è®¡ç®—è®¡æ•°ï¼‰
                    renderCategories();
                    // æ¸²æŸ“åˆ†ç±»æ ‡ç­¾ï¼ˆéœ€è¦å›¾ç‰‡æ•°æ®æ¥è®¡ç®—è®¡æ•°ï¼‰
                    renderCategoryTabs();
                    // æ›´æ–°åˆ†ç±»é€‰æ‹©æ¡†
                    updateCategorySelect();
                    
                    // å¦‚æœè®¾ç½®äº†ä¿æŒåˆ†ç±»ï¼Œä¸”ä¿å­˜çš„åˆ†ç±»IDä»ç„¶å­˜åœ¨ï¼Œæ¢å¤é€‰ä¸­è¯¥åˆ†ç±»
                    if (preserveCategory && savedCategoryId) {
                        const category = categories.find(c => c.id === savedCategoryId);
                        if (category) {
                            // æ¢å¤é€‰ä¸­è¯¥åˆ†ç±»
                            currentCategoryId = savedCategoryId;
                            const filteredImages = images.filter(img => img.category_id === savedCategoryId);
                            
                            // æ›´æ–°ä¸­é—´æ æ ‡é¢˜
                            document.getElementById('currentCategoryName').textContent = category.name;
                            document.getElementById('imageCount').textContent = `(${filteredImages.length})`;
                            
                            // æ¸²æŸ“å›¾ç‰‡
                            renderImages(filteredImages);
                            
                            // æ›´æ–°åˆ†ç±»æ ‡ç­¾é€‰ä¸­çŠ¶æ€
                            document.querySelectorAll('.category-tab').forEach(tab => {
                                tab.classList.remove('active');
                            });
                            const activeTab = Array.from(document.querySelectorAll('.category-tab')).find(tab => {
                                const tabText = tab.textContent.trim();
                                return tabText.includes(category.name);
                            });
                            if (activeTab) {
                                activeTab.classList.add('active');
                            }
                            
                            // æ›´æ–°å·¦ä¾§åˆ†ç±»åˆ—è¡¨é€‰ä¸­çŠ¶æ€
                            document.querySelectorAll('.category-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            const activeCategoryItem = document.querySelector(`.category-item[data-category-id="${savedCategoryId}"]`);
                            if (activeCategoryItem) {
                                activeCategoryItem.classList.add('active');
                            }
                            
                            // æ˜¾ç¤ºåˆ†ç±»è¯¦æƒ…
                            showCategoryDetail(category);
                        } else {
                            // å¦‚æœåˆ†ç±»ä¸å­˜åœ¨äº†ï¼Œæ˜¾ç¤ºç¬¬ä¸€ä¸ªåˆ†ç±»
                            if (categories.length > 0) {
                                const firstCategoryId = categories[0].id;
                                const firstCategoryImages = images.filter(img => img.category_id === firstCategoryId);
                                renderImages(firstCategoryImages);
                                currentCategoryId = firstCategoryId;
                                selectCategory(firstCategoryId);
                            } else {
                                renderImages();
                            }
                        }
                    } else {
                        // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªåˆ†ç±»çš„å›¾ç‰‡
                        if (categories.length > 0) {
                            const firstCategoryId = categories[0].id;
                            const firstCategoryImages = images.filter(img => img.category_id === firstCategoryId);
                            renderImages(firstCategoryImages);
                            currentCategoryId = firstCategoryId;
                        } else {
                            renderImages();
                        }
                    }
                    // æ›´æ–°æ’åºæŒ‰é’®æ˜¾ç¤º
                    updateSortButtonVisibility();
                }
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨ï¼ˆå·¦ä¾§æ ï¼‰
        function renderCategories() {
            const container = document.getElementById('categoryList');
            container.innerHTML = '';
            
            if (categories.length === 0) {
                container.innerHTML = '<div class="text-center py-3" style="color: #999999;">æš‚æ— åˆ†ç±»</div>';
                return;
            }
            
            categories.forEach(category => {
                const categoryImages = images.filter(img => img.category_id === category.id);
                const div = document.createElement('div');
                div.className = 'category-item';
                div.setAttribute('data-category-id', category.id);
                div.onclick = (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯ç¼–è¾‘æŒ‰é’®ï¼Œä¸è§¦å‘åˆ†ç±»é€‰æ‹©
                    if (!e.target.closest('.category-edit-btn')) {
                        selectCategory(category.id);
                    }
                };
                div.innerHTML = `
                    <div class="category-item-header">
                        ${category.cover_image ? 
                            `<img src="${category.cover_image}" class="category-item-icon" alt="${category.name}">` : 
                            `<div class="category-item-icon bg-secondary d-flex align-items-center justify-content-center">
                                <span>${category.icon || 'ğŸ¨'}</span>
                            </div>`
                        }
                        <div class="category-item-info" style="flex: 1;">
                            <div class="category-item-name">${category.name}</div>
                            <div class="category-item-count">${categoryImages.length} å¼ å›¾ç‰‡</div>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary category-edit-btn" 
                                onclick="event.stopPropagation(); editCategory(${category.id})" 
                                style="margin-left: 8px; padding: 4px 8px; border-color: #2a2a2a; color: #b0b0b0;"
                                title="ç¼–è¾‘åˆ†ç±»">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // é€‰æ‹©åˆ†ç±»ï¼ˆæ˜¾ç¤ºè¯¦æƒ…å’ŒäºŒçº§åˆ†ç±»ï¼‰
        function selectCategory(categoryId) {
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
            });
            const clickedItem = document.querySelector(`.category-item[data-category-id="${categoryId}"]`);
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
            
            // ç­›é€‰å›¾ç‰‡
            currentCategoryId = categoryId;
            currentSubcategoryId = null; // é‡ç½®äºŒçº§åˆ†ç±»é€‰æ‹©
            const category = categories.find(c => c.id === categoryId);
            
            // åŠ è½½å¹¶æ¸²æŸ“äºŒçº§åˆ†ç±»
            if (category) {
                subcategories = category.subcategories || [];
                renderSubcategories();
                document.getElementById('currentCategoryName').textContent = category.name;
                document.getElementById('addSubcategoryBtn').style.display = 'inline-block';
            } else {
                subcategories = [];
                renderSubcategories();
                document.getElementById('currentCategoryName').textContent = 'äºŒçº§åˆ†ç±»';
                document.getElementById('addSubcategoryBtn').style.display = 'none';
            }
            
            // æ˜¾ç¤ºè¯¥ä¸€çº§åˆ†ç±»ä¸‹çš„æ‰€æœ‰å›¾ç‰‡ï¼ˆä¸ç­›é€‰äºŒçº§åˆ†ç±»ï¼‰
            const filteredImages = images.filter(img => img.category_id === categoryId);
            renderImages(filteredImages);
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('currentImageTitle').textContent = 'é£æ ¼å›¾ç‰‡';
            document.getElementById('imageCount').textContent = `(${filteredImages.length})`;
            
            // æ›´æ–°æ’åºæŒ‰é’®æ˜¾ç¤º
            updateSortButtonVisibility();
            
            // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿
            if (category) {
                showCategoryDetail(category);
            }
        }
        
        // æ¸²æŸ“äºŒçº§åˆ†ç±»åˆ—è¡¨
        function renderSubcategories() {
            const container = document.getElementById('subcategoryList');
            container.innerHTML = '';
            
            if (!currentCategoryId) {
                container.innerHTML = '<div class="text-center text-muted py-5"><i class="fas fa-info-circle fa-2x mb-3"></i><p>è¯·å…ˆé€‰æ‹©ä¸€çº§åˆ†ç±»</p></div>';
                document.getElementById('subcategoryCount').textContent = '(0)';
                document.getElementById('addSubcategoryBtn').style.display = 'none';
                document.getElementById('sortSubcategoryBtn').style.display = 'none';
                return;
            }
            
            if (subcategories.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-5"><i class="fas fa-folder-open fa-2x mb-3"></i><p>æš‚æ— äºŒçº§åˆ†ç±»</p><button class="btn btn-sm btn-outline-success" onclick="openAddSubcategoryModal()"><i class="fas fa-plus"></i> æ·»åŠ äºŒçº§åˆ†ç±»</button></div>';
                document.getElementById('subcategoryCount').textContent = '(0)';
                document.getElementById('sortSubcategoryBtn').style.display = 'none';
                return;
            }
            
            document.getElementById('subcategoryCount').textContent = `(${subcategories.length})`;
            document.getElementById('sortSubcategoryBtn').style.display = subcategories.length > 1 ? 'inline-block' : 'none';
            
            subcategories.forEach(subcategory => {
                const subcategoryImages = images.filter(img => img.subcategory_id === subcategory.id);
                const div = document.createElement('div');
                div.className = 'subcategory-list-item';
                div.setAttribute('data-subcategory-id', subcategory.id);
                div.onclick = () => selectSubcategory(subcategory.id);
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="subcategory-name">${subcategory.name}</div>
                            <div class="subcategory-count" style="font-size: 0.75rem; color: #888;">${subcategoryImages.length} å¼ å›¾ç‰‡</div>
                        </div>
                        <div class="subcategory-actions">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); editSubcategory(${subcategory.id})" title="ç¼–è¾‘">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteSubcategory(${subcategory.id})" title="åˆ é™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // é€‰æ‹©äºŒçº§åˆ†ç±»
        function selectSubcategory(subcategoryId) {
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.subcategory-list-item').forEach(item => {
                item.classList.remove('active');
            });
            const clickedItem = document.querySelector(`.subcategory-list-item[data-subcategory-id="${subcategoryId}"]`);
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
            
            currentSubcategoryId = subcategoryId;
            const subcategory = subcategories.find(s => s.id === subcategoryId);
            
            // ç­›é€‰å›¾ç‰‡ï¼ˆåªæ˜¾ç¤ºè¯¥äºŒçº§åˆ†ç±»ä¸‹çš„å›¾ç‰‡ï¼‰
            const filteredImages = images.filter(img => img.subcategory_id === subcategoryId);
            renderImages(filteredImages);
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('currentImageTitle').textContent = subcategory ? subcategory.name : 'é£æ ¼å›¾ç‰‡';
            document.getElementById('imageCount').textContent = `(${filteredImages.length})`;
        }
        
        // æ˜¾ç¤ºåˆ†ç±»è¯¦æƒ…
        function showCategoryDetail(category) {
            // detailPanel å…ƒç´ å¯èƒ½ä¸å­˜åœ¨ï¼ˆå·²ç§»é™¤ï¼‰ï¼Œç›´æ¥è¿”å›
            const panel = document.getElementById('detailPanel');
            if (!panel) {
                // ä¸å†æ˜¾ç¤ºé”™è¯¯ï¼Œå› ä¸ºè¯¥åŠŸèƒ½å¯èƒ½å·²è¢«ç§»é™¤
                return;
            }
            
            const categoryImages = images.filter(img => img.category_id === category.id);
            
            panel.innerHTML = `
                <div class="detail-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">åˆ†ç±»ä¿¡æ¯</h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="editCategory(${category.id})">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                    </div>
                    ${category.cover_image ? `<img src="${category.cover_image}" class="img-fluid rounded mb-3" alt="${category.name}">` : ''}
                    <div class="detail-label">åç§°</div>
                    <div class="detail-value mb-2">${category.name}</div>
                    <div class="detail-label">ä»£ç </div>
                    <div class="detail-value mb-2">${category.code}</div>
                    <div class="detail-label">æè¿°</div>
                    <div class="detail-value mb-2">${category.description || 'æ— '}</div>
                    <div class="detail-label">å›¾æ ‡</div>
                    <div class="detail-value mb-2">${category.icon || 'æ— '}</div>
                    <div class="detail-label">çŠ¶æ€</div>
                    <div class="detail-value mb-2">
                        <span class="badge ${category.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${category.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}
                        </span>
                    </div>
                    <div class="detail-label">å›¾ç‰‡æ•°é‡</div>
                    <div class="detail-value">${categoryImages.length} å¼ </div>
                </div>
                
                <div class="detail-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">AIå·¥ä½œæµé…ç½®</h6>
                    </div>
                    <div class="detail-label">å·¥ä½œæµçŠ¶æ€</div>
                    <div class="detail-value mb-2">
                        <span class="workflow-badge ${category.is_ai_enabled ? 'enabled' : 'disabled'}">
                            ${category.is_ai_enabled ? 'âœ“ å·²å¯ç”¨' : 'âœ— æœªå¯ç”¨'}
                        </span>
                    </div>
                    ${category.is_ai_enabled ? `
                        <div class="detail-label">å·¥ä½œæµæ–‡ä»¶</div>
                        <div class="detail-value mb-2">${category.workflow_file || 'æœªé…ç½®'}</div>
                        <div class="detail-label">å·¥ä½œæµåç§°</div>
                        <div class="detail-value mb-2">${category.workflow_name || 'æœªé…ç½®'}</div>
                        <div class="detail-label">è¾“å…¥èŠ‚ç‚¹ID</div>
                        <div class="detail-value mb-2">${category.workflow_input_ids || 'æœªé…ç½®'}</div>
                        <div class="detail-label">è¾“å‡ºèŠ‚ç‚¹ID</div>
                        <div class="detail-value mb-2">${category.workflow_output_id || 'æœªé…ç½®'}</div>
                    ` : ''}
                </div>
            `;
        }

        // æ¸²æŸ“åˆ†ç±»æ ‡ç­¾
        function renderCategoryTabs() {
            const container = document.getElementById('categoryTabs');
            container.innerHTML = '';
            
            // æ·»åŠ åˆ†ç±»æ ‡ç­¾ï¼ˆåˆ é™¤"å…¨éƒ¨"æ ‡ç­¾ï¼‰
            categories.forEach((category, index) => {
                const categoryImages = images.filter(img => img.category_id === category.id);
                const tab = document.createElement('div');
                tab.className = index === 0 ? 'category-tab active' : 'category-tab'; // ç¬¬ä¸€ä¸ªåˆ†ç±»é»˜è®¤æ¿€æ´»
                tab.innerHTML = `
                    ${category.cover_image ? 
                        `<img src="${category.cover_image}" alt="${category.name}">` : 
                        `<span class="category-icon">${category.icon || 'ğŸ¨'}</span>`
                    }
                    <span>${category.name}</span>
                    <small>(${categoryImages.length})</small>
                `;
                tab.onclick = () => filterImagesByCategory(category.id);
                container.appendChild(tab);
            });
        }

        // æ¸²æŸ“å›¾ç‰‡åˆ—è¡¨ï¼ˆä¸­é—´æ ï¼‰
        let selectedImageId = null;
        function renderImages(filteredImages = null) {
            const container = document.getElementById('imageList');
            const imagesToShow = filteredImages || images;
            
            if (imagesToShow.length === 0) {
                container.innerHTML = '<div class="text-center py-4" style="color: #999999;">æš‚æ— å›¾ç‰‡</div>';
                const detailPanel = document.getElementById('detailPanel');
                if (detailPanel) {
                    detailPanel.innerHTML = `
                        <div class="text-center py-5" style="color: #999999;">
                            <i class="fas fa-info-circle fa-3x mb-3" style="color: #cccccc;"></i>
                            <p>è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ç±»æˆ–å›¾ç‰‡æŸ¥çœ‹è¯¦æƒ…</p>
                        </div>
                    `;
                }
                return;
            }
            
            container.innerHTML = '<div class="images-grid"></div>';
            const grid = container.querySelector('.images-grid');
            
            imagesToShow.forEach(image => {
                const category = categories.find(c => c.id === image.category_id);
                const div = document.createElement('div');
                div.className = `image-card ${selectedImageId === image.id ? 'selected' : ''}`;
                div.onclick = () => selectImage(image.id);
                // æ£€æŸ¥æ˜¯å¦æœ‰å·¥ä½œæµæˆ–APIé…ç½®
                let workflowInfo = '';
                if (image.is_ai_enabled && image.workflow_file) {
                    workflowInfo = `<span class="badge bg-primary" style="font-size: 0.7rem; margin-top: 4px; display: inline-block;">å·¥ä½œæµ: ${image.workflow_name || image.workflow_file}</span>`;
                } else if (image.is_ai_enabled === null && category && category.is_ai_enabled && category.workflow_file) {
                    workflowInfo = `<span class="badge bg-info" style="font-size: 0.7rem; margin-top: 4px; display: inline-block;">å·¥ä½œæµ: ${category.workflow_name || category.workflow_file} (ç»§æ‰¿)</span>`;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰APIæ¨¡æ¿
                let apiInfo = '';
                // æ£€æŸ¥æ¡ä»¶ï¼šapi_template_idå­˜åœ¨ æˆ– api_template_typeå­˜åœ¨ æˆ– (api_config_idå’Œapi_provideréƒ½å­˜åœ¨)
                const hasApiTemplate = image.api_template_id || image.api_template_type || (image.api_config_id && image.api_provider);
                
                // è°ƒè¯•æ—¥å¿—ï¼ˆä»…å¯¹ç‰¹å®šå›¾ç‰‡ï¼‰
                if (image.name === 'è¥¿è£…' || image.id === 55) {
                    console.log(`ğŸ” æ£€æŸ¥å›¾ç‰‡ "${image.name}" (ID: ${image.id}) çš„APIæ¨¡æ¿ä¿¡æ¯:`, {
                        api_template_id: image.api_template_id,
                        api_config_id: image.api_config_id,
                        api_provider: image.api_provider,
                        api_template_type: image.api_template_type,
                        hasApiTemplate: hasApiTemplate
                    });
                }
                
                if (hasApiTemplate) {
                    // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ ‡ç­¾
                    if (image.api_template_type === 'comfyui') {
                        apiInfo = `<span class="badge bg-info" style="font-size: 0.7rem; margin-top: 4px; display: inline-block;">API-ComfyUIå·¥ä½œæµ</span>`;
                    } else if (image.api_template_type === 'api') {
                        apiInfo = `<span class="badge bg-success" style="font-size: 0.7rem; margin-top: 4px; display: inline-block;">APIç¼–è¾‘: ${image.api_provider || 'å·²é…ç½®'}</span>`;
                    } else {
                        // å…¼å®¹æ—§æ•°æ®ï¼šæ²¡æœ‰api_template_typeä½†æœ‰api_template_idæˆ–api_config_id
                        apiInfo = `<span class="badge bg-success" style="font-size: 0.7rem; margin-top: 4px; display: inline-block;">APIç¼–è¾‘: ${image.api_provider || 'å·²é…ç½®'}</span>`;
                    }
                }
                
                div.innerHTML = `
                    <img src="${image.image_url}" alt="${image.name}" onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2NjYyIvPjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvuWJjzwvdGV4dD48L3N2Zz4='; this.style.border='2px solid #ff6b6b';" loading="lazy">
                    <div class="image-card-body">
                        <h6 class="mb-1">${image.name}</h6>
                        <small class="text-muted">${image.description || ''}</small>
                        <br>
                        <small class="text-info">${category ? category.name : 'æœªçŸ¥åˆ†ç±»'}</small>
                        ${workflowInfo}
                        ${apiInfo}
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="event.stopPropagation(); editImage(${image.id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteImage(${image.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }
        
        // é€‰æ‹©å›¾ç‰‡ï¼ˆæ˜¾ç¤ºè¯¦æƒ…ï¼‰
        function selectImage(imageId) {
            selectedImageId = imageId;
            const image = images.find(i => i.id === imageId);
            if (image) {
                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.image-card').forEach(card => {
                    card.classList.remove('selected');
                });
                event.target.closest('.image-card')?.classList.add('selected');
                
                // æ˜¾ç¤ºè¯¦æƒ…
                showImageDetail(image);
            }
        }
        
        // æ˜¾ç¤ºå›¾ç‰‡è¯¦æƒ…
        function showImageDetail(image) {
            const panel = document.getElementById('detailPanel');
            const category = categories.find(c => c.id === image.category_id);
            
            panel.innerHTML = `
                <div class="detail-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">å›¾ç‰‡ä¿¡æ¯</h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="editImage(${image.id})">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                    </div>
                    <img src="${image.image_url}" class="img-fluid rounded mb-3" alt="${image.name}" onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling && (this.nextElementSibling.style.display='block');" loading="lazy">
                    <div style="display:none; padding:20px; text-align:center; color:#ff6b6b; background:#2a2a2a; border-radius:4px; margin-bottom:15px;">
                        <i class="fas fa-exclamation-triangle"></i> å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨
                    </div>
                    <div class="detail-label">åç§°</div>
                    <div class="detail-value mb-2">${image.name}</div>
                    <div class="detail-label">ä»£ç </div>
                    <div class="detail-value mb-2">${image.code}</div>
                    <div class="detail-label">æè¿°</div>
                    <div class="detail-value mb-2">${image.description || 'æ— '}</div>
                    <div class="detail-label">æ‰€å±åˆ†ç±»</div>
                    <div class="detail-value mb-2">${category ? category.name : 'æœªçŸ¥'}</div>
                    <div class="detail-label">çŠ¶æ€</div>
                    <div class="detail-value mb-2">
                        <span class="badge ${image.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${image.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}
                        </span>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">AIå·¥ä½œæµé…ç½®</h6>
                    </div>
                    <div class="detail-label">å·¥ä½œæµçŠ¶æ€</div>
                    <div class="detail-value mb-2">
                        ${image.is_ai_enabled === null ? `
                            <span class="workflow-badge disabled">ç»§æ‰¿åˆ†ç±»é…ç½®</span>
                        ` : `
                            <span class="workflow-badge ${image.is_ai_enabled ? 'enabled' : 'disabled'}">
                                ${image.is_ai_enabled ? 'âœ“ ç‹¬ç«‹é…ç½®å·²å¯ç”¨' : 'âœ— ç‹¬ç«‹é…ç½®æœªå¯ç”¨'}
                            </span>
                        `}
                    </div>
                    ${image.is_ai_enabled ? `
                        <div class="detail-label">å·¥ä½œæµæ–‡ä»¶</div>
                        <div class="detail-value mb-2">${image.workflow_file || 'æœªé…ç½®'}</div>
                        <div class="detail-label">å·¥ä½œæµåç§°</div>
                        <div class="detail-value mb-2">${image.workflow_name || 'æœªé…ç½®'}</div>
                        <div class="detail-label">è¾“å…¥èŠ‚ç‚¹ID</div>
                        <div class="detail-value mb-2">${image.workflow_input_ids || 'æœªé…ç½®'}</div>
                        <div class="detail-label">è¾“å‡ºèŠ‚ç‚¹ID</div>
                        <div class="detail-value mb-2">${image.workflow_output_id || 'æœªé…ç½®'}</div>
                    ` : image.is_ai_enabled === null && category && category.is_ai_enabled ? `
                        <div class="alert alert-info mb-0">
                            <small>ä½¿ç”¨åˆ†ç±»çš„é»˜è®¤å·¥ä½œæµé…ç½®</small>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // åˆ‡æ¢åˆ†ç±»åˆ—è¡¨æ˜¾ç¤º/éšè—
        function toggleCategoryList() {
            const container = document.getElementById('categoryListContainer');
            const icon = document.getElementById('categoryToggleIcon');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                container.style.display = 'none';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        }

        // æŒ‰åˆ†ç±»ç­›é€‰å›¾ç‰‡
        function filterImagesByCategory(categoryId) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.category-tab').classList.add('active');
            
            // ç­›é€‰å›¾ç‰‡
            currentCategoryId = categoryId;
            const filteredImages = categoryId ? 
                images.filter(img => img.category_id === categoryId) : 
                images;
            renderImages(filteredImages);
            // æ›´æ–°æ’åºæŒ‰é’®æ˜¾ç¤º
            updateSortButtonVisibility();
        }

        // æ›´æ–°åˆ†ç±»é€‰æ‹©æ¡†
        function updateCategorySelect() {
            const select = document.getElementById('imageCategory');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }
        
        // æ›´æ–°äºŒçº§åˆ†ç±»é€‰æ‹©å™¨ï¼ˆå½“ä¸€çº§åˆ†ç±»æ”¹å˜æ—¶ï¼‰
        function updateImageSubcategorySelect() {
            const categoryId = document.getElementById('imageCategory').value;
            const subcategorySelect = document.getElementById('imageSubcategoryId');
            
            if (!subcategorySelect) return;
            
            subcategorySelect.innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§åˆ†ç±»ï¼ˆå¯é€‰ï¼‰</option>';
            
            if (!categoryId) {
                subcategorySelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©ä¸€çº§åˆ†ç±»</option>';
                return;
            }
            
            const category = categories.find(c => c.id == categoryId);
            if (category && category.subcategories) {
                category.subcategories.forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory.id;
                    option.textContent = subcategory.name;
                    subcategorySelect.appendChild(option);
                });
            }
        }

        // æ ¹æ®é€‰æ‹©çš„åˆ†ç±»è‡ªåŠ¨å¡«å……è¡¨å•å­—æ®µ
        function updateImageFormFields() {
            const categoryId = document.getElementById('imageCategory').value;
            const imageId = document.getElementById('imageId').value;
            
            // æ›´æ–°äºŒçº§åˆ†ç±»é€‰æ‹©å™¨
            updateImageSubcategorySelect();
            
            // å¦‚æœæ˜¯ç¼–è¾‘ç°æœ‰å›¾ç‰‡ï¼Œä¸è¦è¦†ç›–åŸæœ‰çš„ä»£ç å’Œæè¿°
            if (imageId) {
                return;
            }
            
            if (categoryId) {
                const category = categories.find(c => c.id == categoryId);
                if (category) {
                    document.getElementById('imageCode').value = category.code;
                    document.getElementById('imageDescription').value = category.description;
                }
            } else {
                document.getElementById('imageCode').value = '';
                document.getElementById('imageDescription').value = '';
            }
        }

        // ä¸Šä¼ åˆ†ç±»å°é¢å›¾ç‰‡
        async function uploadCategoryCoverImage(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/admin/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                // å…¼å®¹ä¸¤ç§è¿”å›æ ¼å¼ï¼šstatus === 'success' æˆ– success === true
                if (result.status === 'success' || result.success === true) {
                    // ä¼˜å…ˆä½¿ç”¨ image_urlï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ url
                    const imageUrl = result.image_url || result.url;
                    if (imageUrl) {
                        const coverImageUrl = document.getElementById('categoryCoverImageUrl');
                        const coverImagePreview = document.getElementById('categoryCoverImagePreview');
                        const coverImageUpload = document.getElementById('categoryCoverImageUpload');
                        
                        if (coverImageUrl) coverImageUrl.value = imageUrl;
                        if (coverImagePreview) {
                            coverImagePreview.src = imageUrl;
                            coverImagePreview.style.display = 'block';
                        }
                        if (coverImageUpload) {
                            coverImageUpload.style.display = 'none';
                        }
                    } else {
                        alert('ä¸Šä¼ å¤±è´¥: æœªè¿”å›å›¾ç‰‡URL');
                    }
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ä¸Šä¼ å›¾ç‰‡
        async function uploadImage(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/admin/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    const imageUrlEl = document.getElementById('imageUrl');
                    const imagePreviewEl = document.getElementById('imagePreview');
                    const imageUploadAreaEl = document.getElementById('imageUploadArea');
                    if (imageUrlEl) imageUrlEl.value = result.image_url;
                    if (imagePreviewEl) {
                        imagePreviewEl.src = result.image_url;
                        imagePreviewEl.style.display = 'block';
                    }
                    if (imageUploadAreaEl) imageUploadAreaEl.style.display = 'none';
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ä¸Šä¼ è®¾è®¡æ°´å°å›¾ç‰‡
        async function uploadDesignImage(input) {
            const file = input.files[0];
            if (!file) {
                console.warn('æœªé€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹ï¼ˆå…è®¸PNGå’Œå…¶ä»–å›¾ç‰‡æ ¼å¼ï¼Œä½†å»ºè®®ä½¿ç”¨PNGï¼‰
            const isPng = file.type === 'image/png' || file.name.toLowerCase().endsWith('.png');
            if (!isPng) {
                const confirmUpload = confirm('å»ºè®®ä½¿ç”¨PNGæ ¼å¼ï¼ˆæ”¯æŒé€æ˜èƒŒæ™¯ï¼‰ã€‚æ˜¯å¦ç»§ç»­ä¸Šä¼ å½“å‰æ–‡ä»¶ï¼Ÿ');
                if (!confirmUpload) {
                    input.value = ''; // æ¸…ç©ºé€‰æ‹©
                    return;
                }
            }
            
            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º10MBï¼‰
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                input.value = '';
                return;
            }
            
            const formData = new FormData();
            formData.append('image', file);
            
            // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            const uploadArea = document.getElementById('designImageUploadArea');
            const originalContent = uploadArea.innerHTML;
            uploadArea.innerHTML = '<i class="fas fa-spinner fa-spin fa-2x mb-2"></i><p>ä¸Šä¼ ä¸­...</p>';
            
            try {
                const response = await fetch('/api/admin/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                // æ£€æŸ¥HTTPçŠ¶æ€ç 
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTPé”™è¯¯:', response.status, errorText);
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('ä¸Šä¼ ç»“æœ:', result);
                
                // å…¼å®¹å¤šç§è¿”å›æ ¼å¼
                if (result.status === 'success' || result.success === true) {
                    const imageUrl = result.image_url || result.url;
                    if (imageUrl) {
                        document.getElementById('designImageUrl').value = imageUrl;
                        document.getElementById('designImagePreview').src = imageUrl;
                        document.getElementById('designImagePreview').style.display = 'block';
                        document.getElementById('designImageUploadArea').style.display = 'none';
                        console.log('è®¾è®¡æ°´å°ä¸Šä¼ æˆåŠŸ:', imageUrl);
                    } else {
                        throw new Error('æœåŠ¡å™¨è¿”å›çš„å›¾ç‰‡URLä¸ºç©º');
                    }
                } else {
                    const errorMsg = result.message || 'æœªçŸ¥é”™è¯¯';
                    console.error('ä¸Šä¼ å¤±è´¥:', errorMsg, result);
                    throw new Error(errorMsg);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                // æ¢å¤ä¸Šä¼ åŒºåŸŸ
                uploadArea.innerHTML = originalContent;
                alert('ä¸Šä¼ å¤±è´¥: ' + (error.message || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜'));
            }
        }

        // ä¸Šä¼ å·¥ä½œæµæ–‡ä»¶
        async function uploadWorkflowFile(input, type) {
            const file = input.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                alert('è¯·é€‰æ‹©JSONæ ¼å¼çš„å·¥ä½œæµæ–‡ä»¶');
                return;
            }
            
            // ä¿å­˜åŸå§‹æ–‡ä»¶åä¾›åç»­ä½¿ç”¨
            const originalFileName = file.name;
            
            const formData = new FormData();
            formData.append('workflow', file);
            
            try {
                const response = await fetch('/api/admin/styles/workflow/upload', {
                    method: 'POST',
                    body: formData
                });
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    // å°è¯•è§£æé”™è¯¯å“åº”
                    let errorMessage = 'ä¸Šä¼ å¤±è´¥';
                    try {
                        const errorResult = await response.json();
                        errorMessage = errorResult.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTPé”™è¯¯ ${response.status}: ${response.statusText}`;
                    }
                    alert('ä¸Šä¼ å¤±è´¥: ' + errorMessage + '\n\næç¤ºï¼šè¯·ç¡®ä¿ä¸Šä¼ çš„JSONæ–‡ä»¶æ˜¯æœ‰æ•ˆçš„ComfyUIå·¥ä½œæµæ ¼å¼ã€‚');
                    return;
                }
                
                const result = await response.json();
                if (result.status === 'success') {
                    const filename = result.filename;
                    // ä¼˜å…ˆä½¿ç”¨åŸå§‹æ–‡ä»¶åæå–å·¥ä½œæµåç§°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å¤„ç†åçš„æ–‡ä»¶å
                    const sourceFilename = result.original_filename || filename;
                    // è‡ªåŠ¨ä»æ–‡ä»¶åæå–å·¥ä½œæµåç§°ï¼ˆå»æ‰.jsonæ‰©å±•åå’Œæ—¶é—´æˆ³ï¼‰
                    let workflowName = sourceFilename.replace(/\.json$/i, ''); // å…ˆå»æ‰æ‰©å±•å
                    workflowName = workflowName.replace(/_\d{8}_\d{6}$/, ''); // å»æ‰æ—¶é—´æˆ³åç¼€
                    // å¦‚æœæå–åä¸ºç©ºæˆ–åªæœ‰"json"ï¼Œä½¿ç”¨å¤„ç†åçš„æ–‡ä»¶å
                    if (!workflowName || workflowName === 'json' || workflowName.length < 2) {
                        workflowName = filename.replace(/\.json$/i, '').replace(/_\d{8}_\d{6}$/, '');
                    }
                    // å¦‚æœè¿˜æ˜¯æœ‰é—®é¢˜ï¼Œä½¿ç”¨æ–‡ä»¶å¯¹è±¡çš„åå­—
                    if (!workflowName || workflowName === 'json' || workflowName.length < 2) {
                        workflowName = originalFileName.replace(/\.json$/i, '').replace(/_\d{8}_\d{6}$/, '');
                    }
                    
                    if (type === 'category') {
                        const categoryWorkflowFileEl = document.getElementById('categoryWorkflowFile');
                        const categoryWorkflowNameEl = document.getElementById('categoryWorkflowName');
                        if (categoryWorkflowFileEl) {
                            categoryWorkflowFileEl.value = filename;
                        }
                        // æ€»æ˜¯è‡ªåŠ¨å¡«å……å·¥ä½œæµåç§°
                        if (categoryWorkflowNameEl) {
                            categoryWorkflowNameEl.value = workflowName;
                        }
                    } else if (type === 'image') {
                        const imageWorkflowFileEl = document.getElementById('imageWorkflowFile');
                        const imageWorkflowNameEl = document.getElementById('imageWorkflowName');
                        if (imageWorkflowFileEl) {
                            imageWorkflowFileEl.value = filename;
                        }
                        // æ€»æ˜¯è‡ªåŠ¨å¡«å……å·¥ä½œæµåç§°
                        if (imageWorkflowNameEl) {
                            imageWorkflowNameEl.value = workflowName;
                        }
                    }
                    alert('å·¥ä½œæµæ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼åé‡è¯•'));
            }
        }
        
        // ç¼–è¾‘åˆ†ç±»
        function editCategory(id) {
            const category = categories.find(c => c.id === id);
            if (category) {
                document.getElementById('categoryModalTitle').textContent = 'ç¼–è¾‘åˆ†ç±»';
                document.getElementById('categoryId').value = category.id;
                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryCode').value = category.code;
                document.getElementById('categoryDescription').value = category.description || '';
                document.getElementById('categoryIcon').value = category.icon || '';
                document.getElementById('categoryCoverImageUrl').value = category.cover_image || '';
                document.getElementById('categorySortOrder').value = category.sort_order || 0;
                document.getElementById('categoryIsActive').checked = category.is_active;
                
                // åŠ è½½AIå·¥ä½œæµé…ç½®ï¼ˆå¦‚æœå­—æ®µå­˜åœ¨ï¼‰
                const categoryIsAiEnabledEl = document.getElementById('categoryIsAiEnabled');
                if (categoryIsAiEnabledEl) {
                    categoryIsAiEnabledEl.checked = category.is_ai_enabled || false;
                }
                
                // å¤„ç†å·¥ä½œæµæ–‡ä»¶ï¼šç¡®ä¿æœ‰å®Œæ•´çš„æ–‡ä»¶åï¼ˆå¦‚æœå­—æ®µå­˜åœ¨ï¼‰
                const categoryWorkflowFileEl = document.getElementById('categoryWorkflowFile');
                if (categoryWorkflowFileEl) {
                    const categoryWorkflowFile = category.workflow_file || '';
                    categoryWorkflowFileEl.value = categoryWorkflowFile;
                }
                
                const categoryWorkflowNameEl = document.getElementById('categoryWorkflowName');
                if (categoryWorkflowNameEl) {
                    categoryWorkflowNameEl.value = category.workflow_name || '';
                }
                
                // å¤„ç†è¾“å…¥èŠ‚ç‚¹IDï¼šå¦‚æœæ˜¯JSONæ•°ç»„æ ¼å¼ï¼Œè§£æå¹¶æ˜¾ç¤ºä¸ºå•ä¸ªæ•°å­—æˆ–é€—å·åˆ†éš”ï¼ˆå¦‚æœå­—æ®µå­˜åœ¨ï¼‰
                const categoryWorkflowInputIdsEl = document.getElementById('categoryWorkflowInputIds');
                if (categoryWorkflowInputIdsEl) {
                    let categoryInputIds = category.workflow_input_ids || '';
                    if (categoryInputIds) {
                        try {
                            // å°è¯•è§£æä¸ºJSONæ•°ç»„
                            const parsed = JSON.parse(categoryInputIds);
                            if (Array.isArray(parsed)) {
                                // å¦‚æœæ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
                                categoryInputIds = parsed.join(',');
                            }
                        } catch (e) {
                            // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                        }
                    }
                    categoryWorkflowInputIdsEl.value = categoryInputIds;
                }
                
                const categoryWorkflowOutputIdEl = document.getElementById('categoryWorkflowOutputId');
                if (categoryWorkflowOutputIdEl) {
                    categoryWorkflowOutputIdEl.value = category.workflow_output_id || '';
                }
                
                const categoryWorkflowRefIdEl = document.getElementById('categoryWorkflowRefId');
                if (categoryWorkflowRefIdEl) {
                    categoryWorkflowRefIdEl.value = category.workflow_ref_id || '';
                }
                
                const categoryWorkflowRefImageEl = document.getElementById('categoryWorkflowRefImage');
                if (categoryWorkflowRefImageEl) {
                    categoryWorkflowRefImageEl.value = category.workflow_ref_image || '';
                }
                
                const categoryWorkflowCustomPromptIdEl = document.getElementById('categoryWorkflowCustomPromptId');
                if (categoryWorkflowCustomPromptIdEl) {
                    categoryWorkflowCustomPromptIdEl.value = category.workflow_custom_prompt_id || '';
                }
                
                const categoryWorkflowCustomPromptContentEl = document.getElementById('categoryWorkflowCustomPromptContent');
                if (categoryWorkflowCustomPromptContentEl) {
                    categoryWorkflowCustomPromptContentEl.value = category.workflow_custom_prompt_content || '';
                }
                
                // æ˜¾ç¤º/éšè—å·¥ä½œæµé…ç½®åŒºåŸŸï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const workflowConfig = document.getElementById('categoryWorkflowConfig');
                if (workflowConfig) {
                    workflowConfig.style.display = category.is_ai_enabled ? 'block' : 'none';
                }
                
                // æ˜¾ç¤ºå°é¢å›¾ç‰‡é¢„è§ˆ
                const coverPreview = document.getElementById('categoryCoverImagePreview');
                const coverUpload = document.getElementById('categoryCoverImageUpload');
                if (category.cover_image) {
                    if (coverPreview) {
                        coverPreview.src = category.cover_image;
                        coverPreview.style.display = 'block';
                    }
                    if (coverUpload) coverUpload.style.display = 'none';
                } else {
                    if (coverPreview) coverPreview.style.display = 'none';
                    if (coverUpload) coverUpload.style.display = 'block';
                }
                
                const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
                modal.show();
            }
        }
        
        // ç›‘å¬åˆ†ç±»AIå·¥ä½œæµå¼€å…³
        document.addEventListener('DOMContentLoaded', function() {
            const categoryAiEnabled = document.getElementById('categoryIsAiEnabled');
            if (categoryAiEnabled) {
                categoryAiEnabled.addEventListener('change', function() {
                    const workflowConfig = document.getElementById('categoryWorkflowConfig');
                    workflowConfig.style.display = this.checked ? 'block' : 'none';
                });
            }
            
            const imageAiEnabled = document.getElementById('imageIsAiEnabled');
            if (imageAiEnabled) {
                imageAiEnabled.addEventListener('change', function() {
                    const workflowConfig = document.getElementById('imageWorkflowConfig');
                    workflowConfig.style.display = this.checked ? 'block' : 'none';
                });
            }
        });

        // ç¼–è¾‘å›¾ç‰‡
        function editImage(id) {
            const image = images.find(i => i.id === id);
            if (image) {
                document.getElementById('imageModalTitle').textContent = 'ç¼–è¾‘å›¾ç‰‡';
                document.getElementById('imageId').value = image.id;
                document.getElementById('imageCategory').value = image.category_id;
                // æ›´æ–°äºŒçº§åˆ†ç±»é€‰æ‹©å™¨
                updateImageSubcategorySelect();
                // è®¾ç½®äºŒçº§åˆ†ç±»ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (image.subcategory_id) {
                    const subcategorySelect = document.getElementById('imageSubcategoryId');
                    if (subcategorySelect) {
                        subcategorySelect.value = image.subcategory_id;
                    }
                }
                document.getElementById('imageName').value = image.name;
                document.getElementById('imageCode').value = image.code;
                document.getElementById('imageDescription').value = image.description || '';
                document.getElementById('imageUrl').value = image.image_url;
                document.getElementById('imageSortOrder').value = image.sort_order || 0;
                document.getElementById('imageIsActive').checked = image.is_active;
                
                // åŠ è½½AIå·¥ä½œæµé…ç½®
                const imageIsAiEnabledEl = document.getElementById('imageIsAiEnabled');
                if (imageIsAiEnabledEl) {
                    imageIsAiEnabledEl.checked = image.is_ai_enabled === true;
                }
                // å¤„ç†å·¥ä½œæµæ–‡ä»¶ï¼šç¡®ä¿æœ‰å®Œæ•´çš„æ–‡ä»¶å
                const imageWorkflowFile = image.workflow_file || '';
                document.getElementById('imageWorkflowFile').value = imageWorkflowFile;
                document.getElementById('imageWorkflowName').value = image.workflow_name || '';
                
                // å¤„ç†è¾“å…¥èŠ‚ç‚¹IDï¼šå¦‚æœæ˜¯JSONæ•°ç»„æ ¼å¼ï¼Œè§£æå¹¶æ˜¾ç¤ºä¸ºå•ä¸ªæ•°å­—æˆ–é€—å·åˆ†éš”
                let imageInputIds = image.workflow_input_ids || '';
                if (imageInputIds) {
                    try {
                        // å°è¯•è§£æä¸ºJSONæ•°ç»„
                        const parsed = JSON.parse(imageInputIds);
                        if (Array.isArray(parsed)) {
                            // å¦‚æœæ˜¯æ•°ç»„ï¼Œè½¬æ¢ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
                            imageInputIds = parsed.join(',');
                        }
                    } catch (e) {
                        // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                    }
                }
                document.getElementById('imageWorkflowInputIds').value = imageInputIds;
                document.getElementById('imageWorkflowOutputId').value = image.workflow_output_id || '';
                document.getElementById('imageWorkflowRefId').value = image.workflow_ref_id || '';
                document.getElementById('imageWorkflowRefImage').value = image.workflow_ref_image || '';
                document.getElementById('imageWorkflowCustomPromptId').value = image.workflow_custom_prompt_id || '';
                document.getElementById('imageWorkflowCustomPromptContent').value = image.workflow_custom_prompt_content || '';
                
                // æ˜¾ç¤º/éšè—å·¥ä½œæµé…ç½®åŒºåŸŸ
                const workflowConfig = document.getElementById('imageWorkflowConfig');
                workflowConfig.style.display = image.is_ai_enabled === true ? 'block' : 'none';
                
                // åŠ è½½APIæ¨¡æ¿é…ç½®ï¼ˆå¦‚æœå‡½æ•°å­˜åœ¨ï¼‰
                if (typeof loadApiTemplateData === 'function') {
                    loadApiTemplateData(image.id);
                }
                if (typeof loadApiComfyUITemplateData === 'function') {
                    loadApiComfyUITemplateData(image.id);
                }
                
                // ç¼–è¾‘æ—¶ä¸è¦è‡ªåŠ¨å¡«å……åˆ†ç±»çš„ä»£ç å’Œæè¿°ï¼Œä¿æŒåŸæœ‰å€¼
                
                // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                document.getElementById('imagePreview').src = image.image_url;
                document.getElementById('imagePreview').style.display = 'block';
                document.getElementById('imageUploadArea').style.display = 'none';
                
                // åŠ è½½è®¾è®¡æ°´å°å›¾ç‰‡
                if (image.design_image_url) {
                    document.getElementById('designImageUrl').value = image.design_image_url;
                    document.getElementById('designImagePreview').src = image.design_image_url;
                    document.getElementById('designImagePreview').style.display = 'block';
                    document.getElementById('designImageUploadArea').style.display = 'none';
                } else {
                    document.getElementById('designImageUrl').value = '';
                    document.getElementById('designImagePreview').style.display = 'none';
                    document.getElementById('designImageUploadArea').style.display = 'block';
                }
                
                const modal = new bootstrap.Modal(document.getElementById('imageModal'));
                modal.show();
            }
        }

        // ä¿å­˜åˆ†ç±»
        async function saveCategory() {
            const form = document.getElementById('categoryForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // å¤„ç†å¤é€‰æ¡†
            data.is_active = document.getElementById('categoryIsActive').checked;
            
            // å¤„ç†AIå·¥ä½œæµé…ç½®ï¼ˆå¦‚æœå­—æ®µå­˜åœ¨ï¼‰
            const categoryIsAiEnabledEl = document.getElementById('categoryIsAiEnabled');
            if (categoryIsAiEnabledEl) {
                data.is_ai_enabled = categoryIsAiEnabledEl.checked;
            } else {
                data.is_ai_enabled = false;
            }
            
            // å¤„ç†å·¥ä½œæµé…ç½®ï¼ˆå¦‚æœå¯ç”¨ä¸”å­—æ®µå­˜åœ¨ï¼‰
            if (data.is_ai_enabled) {
                // å¤„ç†workflow_input_idsï¼šæ”¯æŒé€—å·åˆ†éš”çš„å¤šä¸ªIDï¼Œè½¬æ¢ä¸ºJSONæ•°ç»„
                let inputIds = data.workflow_input_ids || '';
                if (inputIds) {
                    // å¦‚æœå·²ç»æ˜¯JSONæ•°ç»„æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                    if (inputIds.trim().startsWith('[') && inputIds.trim().endsWith(']')) {
                        try {
                            // éªŒè¯æ˜¯å¦æ˜¯æœ‰æ•ˆçš„JSONæ•°ç»„
                            JSON.parse(inputIds);
                            // æœ‰æ•ˆï¼Œç›´æ¥ä½¿ç”¨
                        } catch {
                            // æ— æ•ˆçš„JSONï¼ŒæŒ‰é€—å·åˆ†éš”å¤„ç†
                            const ids = inputIds.split(',').map(id => id.trim()).filter(id => id);
                            inputIds = JSON.stringify(ids);
                        }
                    } else {
                        // ä¸æ˜¯JSONæ•°ç»„æ ¼å¼ï¼ŒæŒ‰é€—å·åˆ†éš”å¤„ç†
                        const ids = inputIds.split(',').map(id => id.trim()).filter(id => id);
                        if (ids.length > 0) {
                            inputIds = JSON.stringify(ids);
                        } else {
                            inputIds = '';
                        }
                    }
                }
                data.workflow_input_ids = inputIds;
            } else {
                // å¦‚æœæœªå¯ç”¨ï¼Œæ¸…ç©ºå·¥ä½œæµé…ç½®
                data.workflow_file = '';
                data.workflow_name = '';
                data.workflow_input_ids = '';
                data.workflow_output_id = '';
                data.workflow_ref_id = '';
                data.workflow_ref_image = '';
                data.workflow_custom_prompt_id = '';
                data.workflow_custom_prompt_content = '';
            }
            
            try {
                const url = data.id ? `/api/admin/styles/categories/${data.id}` : '/api/admin/styles/categories';
                const method = data.id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
                    saveScrollPosition(); // ä¿å­˜æ»šåŠ¨ä½ç½®
                    loadCategories();
                    loadImages(true); // ä¿æŒå½“å‰åˆ†ç±»
                    restoreScrollPosition(); // æ¢å¤æ»šåŠ¨ä½ç½®
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜åˆ†ç±»å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ä¿å­˜å›¾ç‰‡
        async function saveImage() {
            const form = document.getElementById('imageForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // ç¡®ä¿ design_image_url è¢«åŒ…å«ï¼ˆä»éšè—å­—æ®µè·å–ï¼‰
            const designImageUrl = document.getElementById('designImageUrl')?.value || '';
            if (designImageUrl) {
                data.design_image_url = designImageUrl;
            }
            
            // å¤„ç†å¤é€‰æ¡†
            data.is_active = document.getElementById('imageIsActive').checked;
            const isAiEnabled = document.getElementById('imageIsAiEnabled').checked;
            data.is_ai_enabled = isAiEnabled ? true : null; // nullè¡¨ç¤ºç»§æ‰¿åˆ†ç±»é…ç½®
            
            // å¤„ç†å·¥ä½œæµé…ç½®
            if (isAiEnabled) {
                // å¤„ç†workflow_input_idsï¼šæ”¯æŒé€—å·åˆ†éš”çš„å¤šä¸ªIDï¼Œè½¬æ¢ä¸ºJSONæ•°ç»„
                let inputIds = data.workflow_input_ids || '';
                if (inputIds) {
                    // å¦‚æœå·²ç»æ˜¯JSONæ•°ç»„æ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨
                    if (inputIds.trim().startsWith('[') && inputIds.trim().endsWith(']')) {
                        try {
                            // éªŒè¯æ˜¯å¦æ˜¯æœ‰æ•ˆçš„JSONæ•°ç»„
                            JSON.parse(inputIds);
                            // æœ‰æ•ˆï¼Œç›´æ¥ä½¿ç”¨
                        } catch {
                            // æ— æ•ˆçš„JSONï¼ŒæŒ‰é€—å·åˆ†éš”å¤„ç†
                            const ids = inputIds.split(',').map(id => id.trim()).filter(id => id);
                            inputIds = JSON.stringify(ids);
                        }
                    } else {
                        // ä¸æ˜¯JSONæ•°ç»„æ ¼å¼ï¼ŒæŒ‰é€—å·åˆ†éš”å¤„ç†
                        const ids = inputIds.split(',').map(id => id.trim()).filter(id => id);
                        if (ids.length > 0) {
                            inputIds = JSON.stringify(ids);
                        } else {
                            inputIds = '';
                        }
                    }
                }
                data.workflow_input_ids = inputIds;
            } else {
                // å¦‚æœæœªå¯ç”¨ç‹¬ç«‹é…ç½®ï¼Œæ¸…ç©ºå·¥ä½œæµé…ç½®ï¼ˆä½¿ç”¨nullè¡¨ç¤ºç»§æ‰¿ï¼‰
                data.workflow_file = null;
                data.workflow_name = null;
                data.workflow_input_ids = null;
                data.workflow_output_id = null;
                data.workflow_ref_id = null;
                data.workflow_ref_image = null;
                data.workflow_custom_prompt_id = null;
                data.workflow_custom_prompt_content = null;
            }
            
            try {
                const url = data.id ? `/api/admin/styles/images/${data.id}` : '/api/admin/styles/images';
                const method = data.id ? 'PUT' : 'POST';
                
                console.log('ğŸ“¤ ä¿å­˜å›¾ç‰‡è¯·æ±‚:', { url, method, data: { ...data, image_url: data.image_url ? '[å·²è®¾ç½®]' : '[æœªè®¾ç½®]' } });
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                // æ£€æŸ¥HTTPçŠ¶æ€ç 
                if (!response.ok) {
                    let errorMessage = `HTTPé”™è¯¯: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        // å¦‚æœå“åº”ä¸æ˜¯JSONï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯æ¶ˆæ¯
                    }
                    console.error('ä¿å­˜å›¾ç‰‡å¤±è´¥:', {
                        url: url,
                        method: method,
                        status: response.status,
                        statusText: response.statusText,
                        error: errorMessage
                    });
                    alert('ä¿å­˜å¤±è´¥: ' + errorMessage + '\n\nè¯·æ£€æŸ¥ï¼š\n1. æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ\n2. æ˜¯å¦å·²ç™»å½•\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
                    return;
                }
                
                const result = await response.json();
                if (result.status === 'success') {
                    const savedImageId = result.data?.id || data.id;
                    
                    // ä¿å­˜API-ComfyUIå·¥ä½œæµé…ç½®ï¼ˆä¼˜å…ˆäºAPIæ¨¡æ¿ï¼‰
                    const apiComfyUIEnabled = document.getElementById('imageApiComfyUIEnabled')?.checked || false;
                    console.log('ğŸ” æ£€æŸ¥API-ComfyUIå·¥ä½œæµé…ç½®:', { apiComfyUIEnabled, savedImageId });
                    
                    if (apiComfyUIEnabled && savedImageId) {
                        try {
                            const apiComfyUIConfigIdEl = document.getElementById('imageApiComfyUIConfigId');
                            const apiComfyUIConfigId = apiComfyUIConfigIdEl ? apiComfyUIConfigIdEl.value : '';
                            const workflowId = document.getElementById('imageApiComfyUIWorkflowId')?.value || '';
                            const inputIds = document.getElementById('imageApiComfyUIInputIds')?.value || '';
                            const outputId = document.getElementById('imageApiComfyUIOutputId')?.value || '';
                            const promptId = document.getElementById('imageApiComfyUIPromptId')?.value || '';
                            const refId = document.getElementById('imageApiComfyUIRefId')?.value || '';
                            const customPromptId = document.getElementById('imageApiComfyUICustomPromptId')?.value || '';
                            const customPromptContent = document.getElementById('imageApiComfyUICustomPromptContent')?.value || '';
                            const pointsCost = parseInt(document.getElementById('imageApiComfyUIPointsCost')?.value || '0');
                            
                            console.log('ğŸ“ ä¿å­˜API-ComfyUIå·¥ä½œæµé…ç½®æ•°æ®:', {
                                apiComfyUIConfigId, workflowId, inputIds, outputId, promptId, refId, customPromptId, customPromptContent, pointsCost
                            });
                            
                            // éªŒè¯å¿…å¡«å­—æ®µ
                            if (!workflowId || !inputIds) {
                                alert('è¯·å¡«å†™å·¥ä½œæµIDå’Œè¾“å…¥å›¾ç‰‡èŠ‚ç‚¹ID');
                                return;
                            }
                            
                            // éªŒè¯APIé…ç½®ID
                            if (!apiComfyUIConfigId) {
                                alert('è¯·é€‰æ‹©APIé…ç½®');
                                return;
                            }
                            
                            // æ„å»º nodeInfoList
                            const nodeInfoList = [];
                            
                            // å¤„ç†è¾“å…¥å›¾ç‰‡èŠ‚ç‚¹ID
                            let inputNodeIds = [];
                            if (inputIds) {
                                if (inputIds.trim().startsWith('[') && inputIds.trim().endsWith(']')) {
                                    try {
                                        inputNodeIds = JSON.parse(inputIds);
                                    } catch {
                                        inputNodeIds = [inputIds.trim()];
                                    }
                                } else {
                                    inputNodeIds = inputIds.split(',').map(id => id.trim()).filter(id => id);
                                }
                            }
                            
                            // æ·»åŠ è¾“å…¥å›¾ç‰‡èŠ‚ç‚¹
                            if (inputNodeIds.length > 0) {
                                nodeInfoList.push({
                                    nodeId: inputNodeIds[0],
                                    inputs: {
                                        image: "{{image_url}}"
                                    }
                                });
                            }
                            
                            // æ·»åŠ æç¤ºè¯èŠ‚ç‚¹
                            if (promptId && promptId.trim()) {
                                nodeInfoList.push({
                                    nodeId: promptId.trim(),
                                    inputs: {
                                        text: "{{prompt}}"
                                    }
                                });
                            }
                            
                            // æ·»åŠ å‚è€ƒå›¾èŠ‚ç‚¹
                            if (refId && refId.trim()) {
                                nodeInfoList.push({
                                    nodeId: refId.trim(),
                                    inputs: {
                                        image: "{{ref_image_url}}"
                                    }
                                });
                            }
                            
                            // æ·»åŠ è‡ªå®šä¹‰æç¤ºè¯èŠ‚ç‚¹
                            if (customPromptId && customPromptContent && customPromptId.trim() && customPromptContent.trim()) {
                                nodeInfoList.push({
                                    nodeId: customPromptId.trim(),
                                    inputs: {
                                        text: customPromptContent.trim()
                                    }
                                });
                            }
                            
                            // æ„å»º request_body_template
                            const requestBodyTemplate = {
                                workflow_id: workflowId,
                                nodeInfoList: nodeInfoList,
                                input_node_id: inputNodeIds.length > 0 ? inputNodeIds[0] : null,
                                prompt_node_id: promptId && promptId.trim() ? promptId.trim() : null,
                                ref_node_id: refId && refId.trim() ? refId.trim() : null,
                                output_id: outputId && outputId.trim() ? outputId.trim() : null,
                                custom_prompt_id: customPromptId && customPromptId.trim() ? customPromptId.trim() : null,
                                custom_prompt_content: customPromptContent && customPromptContent.trim() ? customPromptContent.trim() : null
                            };
                            
                            const apiComfyUITemplateData = {
                                enabled: true,
                                api_config_id: apiComfyUIConfigId ? parseInt(apiComfyUIConfigId) : null,  // ç¡®ä¿æ˜¯æ•´æ•°
                                request_body_template: JSON.stringify(requestBodyTemplate),
                                points_cost: pointsCost
                            };
                            
                            console.log('ğŸ“¤ å‡†å¤‡ä¿å­˜çš„ api_config_id:', apiComfyUITemplateData.api_config_id, 'ç±»å‹:', typeof apiComfyUITemplateData.api_config_id);
                            
                            console.log('ğŸ“¤ å‘é€ä¿å­˜è¯·æ±‚:', apiComfyUITemplateData);
                            
                            const apiComfyUIResponse = await fetch(`/api/admin/styles/images/${savedImageId}/api-template`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(apiComfyUITemplateData)
                            });
                            
                            const apiComfyUIResult = await apiComfyUIResponse.json();
                            console.log('ğŸ“¥ ä¿å­˜å“åº”:', apiComfyUIResult);
                            
                            if (apiComfyUIResult.status !== 'success') {
                                console.warn('ä¿å­˜API-ComfyUIå·¥ä½œæµé…ç½®å¤±è´¥:', apiComfyUIResult.message);
                                alert('ä¿å­˜API-ComfyUIå·¥ä½œæµé…ç½®å¤±è´¥: ' + apiComfyUIResult.message);
                            } else {
                                console.log('âœ… API-ComfyUIå·¥ä½œæµé…ç½®ä¿å­˜æˆåŠŸ');
                                
                                // å¦‚æœå¯ç”¨äº†API-ComfyUIå·¥ä½œæµï¼Œç¦ç”¨APIæ¨¡æ¿é…ç½®
                                const apiTemplateEnabledEl = document.getElementById('imageApiTemplateEnabled');
                                if (apiTemplateEnabledEl && apiTemplateEnabledEl.checked) {
                                    apiTemplateEnabledEl.checked = false;
                                    toggleApiTemplateConfig();
                                }
                            }
                        } catch (error) {
                            console.error('ä¿å­˜API-ComfyUIå·¥ä½œæµé…ç½®å¤±è´¥:', error);
                            alert('ä¿å­˜API-ComfyUIå·¥ä½œæµé…ç½®å¤±è´¥: ' + error.message);
                        }
                    }
                    
                    // ä¿å­˜APIæ¨¡æ¿é…ç½®ï¼ˆå¦‚æœæœªå¯ç”¨API-ComfyUIå·¥ä½œæµï¼‰
                    const apiTemplateEnabled = document.getElementById('imageApiTemplateEnabled')?.checked || false;
                    console.log('ğŸ” æ£€æŸ¥APIæ¨¡æ¿é…ç½®:', { 
                        apiComfyUIEnabled, 
                        apiTemplateEnabled, 
                        savedImageId,
                        willSave: !apiComfyUIEnabled && apiTemplateEnabled && savedImageId
                    });
                    
                    // æ³¨æ„ï¼šå¦‚æœå¯ç”¨äº†API-ComfyUIå·¥ä½œæµï¼Œä¸éœ€è¦ç¦ç”¨APIæ¨¡æ¿é…ç½®
                    // å› ä¸ºAPI-ComfyUIå·¥ä½œæµå’ŒAPIæ¨¡æ¿é…ç½®ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªAPITemplateè®°å½•
                    // åªéœ€è¦ç¡®ä¿APIæ¨¡æ¿é…ç½®çš„å¼€å…³æ˜¯å…³é—­çš„å³å¯
                    
                    if (!apiComfyUIEnabled && apiTemplateEnabled && savedImageId) {
                        try {
                            // è·å–é€‰ä¸­çš„APIé…ç½®ç±»å‹
                            const apiConfigSelect = document.getElementById('imageApiConfigId');
                            const selectedOption = apiConfigSelect ? apiConfigSelect.options[apiConfigSelect.selectedIndex] : null;
                            const apiType = selectedOption ? selectedOption.getAttribute('data-api-type') : '';
                            
                            // ä¿å­˜å‰ä»DOMæ”¶é›†æ‰€æœ‰æç¤ºè¯ï¼ˆç¡®ä¿è·å–æœ€æ–°å€¼ï¼‰
                            if (typeof collectImagePromptsFromDOM === 'function') {
                                collectImagePromptsFromDOM();
                            }
                            
                            // è·å–APIæ¨¡æ¿å¯ç”¨çŠ¶æ€
                            const apiTemplateEnabled = document.getElementById('imageApiTemplateEnabled')?.checked || false;
                            
                            const apiTemplateData = {
                                enabled: apiTemplateEnabled,
                                api_config_id: document.getElementById('imageApiConfigId')?.value || null,
                                // model_name å·²ç§»é™¤ï¼šç›´æ¥ä½¿ç”¨APIæœåŠ¡å•†é…ç½®ä¸­çš„æ¨¡å‹åç§°
                                // default_prompt å·²ç§»é™¤ï¼šç°åœ¨åªä½¿ç”¨æ‰¹é‡æç¤ºè¯ï¼ˆprompts_jsonï¼‰
                                prompts_json: document.getElementById('imagePromptsJson')?.value || null,  // æ‰¹é‡æç¤ºè¯
                                default_size: document.getElementById('imageApiDefaultSize')?.value || '1K',
                                default_aspect_ratio: document.getElementById('imageApiDefaultAspectRatio')?.value || 'auto',
                                points_cost: parseInt(document.getElementById('imageApiPointsCost')?.value || '0'),
                                prompt_editable: document.getElementById('imageApiPromptEditable')?.checked !== false,
                                size_editable: document.getElementById('imageApiSizeEditable')?.checked !== false,
                                aspect_ratio_editable: document.getElementById('imageApiAspectRatioEditable')?.checked !== false,
                                enhance_prompt: document.getElementById('imageApiEnhancePrompt')?.checked || false,
                                upload_config: document.getElementById('imageUploadConfigJson')?.value || null
                            };
                            
                            // RunningHub ComfyUI å·¥ä½œæµï¼šä¿å­˜å·¥ä½œæµé…ç½®åˆ° request_body_template
                            if (apiType === 'runninghub-comfyui-workflow') {
                                const workflowId = document.getElementById('imageWorkflowIdInput')?.value || '';
                                const inputIds = document.getElementById('imageRhWorkflowInputIdsInput')?.value || '';
                                const outputId = document.getElementById('imageRhWorkflowOutputIdInput')?.value || '';
                                const promptId = document.getElementById('imageRhWorkflowPromptIdInput')?.value || '';
                                const refId = document.getElementById('imageRhWorkflowRefIdInput')?.value || '';
                                const customPromptId = document.getElementById('imageRhWorkflowCustomPromptIdInput')?.value || '';
                                const customPromptContent = document.getElementById('imageRhWorkflowCustomPromptContentInput')?.value || '';
                                
                                // è°ƒè¯•æ—¥å¿—
                                console.log('ä¿å­˜ RunningHub ComfyUI å·¥ä½œæµé…ç½®:', {
                                    workflowId, inputIds, outputId, promptId, refId, customPromptId, customPromptContent
                                });
                                console.log('æç¤ºè¯èŠ‚ç‚¹IDå€¼:', promptId, 'ç±»å‹:', typeof promptId, 'æ˜¯å¦ä¸ºç©º:', !promptId);
                                
                                // æ„å»º nodeInfoList
                                const nodeInfoList = [];
                                
                                // å¤„ç†è¾“å…¥å›¾ç‰‡èŠ‚ç‚¹IDï¼ˆæ”¯æŒ JSON æ•°ç»„æˆ–å•ä¸ªIDï¼‰
                                let inputNodeIds = [];
                                if (inputIds) {
                                    if (inputIds.trim().startsWith('[') && inputIds.trim().endsWith(']')) {
                                        try {
                                            inputNodeIds = JSON.parse(inputIds);
                                        } catch {
                                            inputNodeIds = [inputIds.trim()];
                                        }
                                    } else {
                                        inputNodeIds = inputIds.split(',').map(id => id.trim()).filter(id => id);
                                    }
                                }
                                
                                // æ·»åŠ è¾“å…¥å›¾ç‰‡èŠ‚ç‚¹ï¼ˆç¬¬ä¸€ä¸ªå›¾ç‰‡èŠ‚ç‚¹ï¼‰
                                if (inputNodeIds.length > 0) {
                                    nodeInfoList.push({
                                        nodeId: inputNodeIds[0],
                                        inputs: {
                                            image: "{{image_url}}"  // å ä½ç¬¦ï¼Œå®é™…è°ƒç”¨æ—¶ä¼šè¢«æ›¿æ¢
                                        }
                                    });
                                }
                                
                                // æ·»åŠ æç¤ºè¯èŠ‚ç‚¹
                                if (promptId && promptId.trim()) {
                                    nodeInfoList.push({
                                        nodeId: promptId.trim(),
                                        inputs: {
                                            text: "{{prompt}}"  // å ä½ç¬¦ï¼Œå®é™…è°ƒç”¨æ—¶ä¼šè¢«æ›¿æ¢
                                        }
                                    });
                                    console.log('âœ… æ·»åŠ æç¤ºè¯èŠ‚ç‚¹:', promptId.trim());
                                } else {
                                    console.warn('âš ï¸ æç¤ºè¯èŠ‚ç‚¹IDä¸ºç©ºï¼Œæœªæ·»åŠ æç¤ºè¯èŠ‚ç‚¹');
                                }
                                
                                // æ·»åŠ å‚è€ƒå›¾èŠ‚ç‚¹ï¼ˆç¬¬äºŒä¸ªå›¾ç‰‡èŠ‚ç‚¹ï¼‰
                                if (refId) {
                                    nodeInfoList.push({
                                        nodeId: refId,
                                        inputs: {
                                            image: "{{ref_image_url}}"  // å ä½ç¬¦ï¼Œå®é™…è°ƒç”¨æ—¶ä¼šè¢«æ›¿æ¢
                                        }
                                    });
                                }
                                
                                // æ·»åŠ è‡ªå®šä¹‰æç¤ºè¯èŠ‚ç‚¹
                                if (customPromptId && customPromptContent) {
                                    nodeInfoList.push({
                                        nodeId: customPromptId,
                                        inputs: {
                                            text: customPromptContent
                                        }
                                    });
                                }
                                
                                // æ„å»º request_body_template
                                const requestBodyTemplate = {
                                    workflow_id: workflowId,
                                    nodeInfoList: nodeInfoList,
                                    input_node_id: inputNodeIds.length > 0 ? inputNodeIds[0] : null,  // ä¿å­˜è¾“å…¥èŠ‚ç‚¹ID
                                    prompt_node_id: promptId || null,  // ä¿å­˜æç¤ºè¯èŠ‚ç‚¹ID
                                    ref_node_id: refId || null,  // ä¿å­˜å‚è€ƒå›¾èŠ‚ç‚¹ID
                                    output_id: outputId || null,
                                    custom_prompt_id: customPromptId || null,
                                    custom_prompt_content: customPromptContent || null
                                };
                                apiTemplateData.request_body_template = JSON.stringify(requestBodyTemplate);
                                
                                // è°ƒè¯•æ—¥å¿—
                                console.log('ä¿å­˜çš„ request_body_template:', apiTemplateData.request_body_template);
                            }
                            
                            const apiTemplateResponse = await fetch(`/api/admin/styles/images/${savedImageId}/api-template`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(apiTemplateData)
                            });
                            
                            const apiTemplateResult = await apiTemplateResponse.json();
                            if (apiTemplateResult.status !== 'success') {
                                console.warn('âŒ ä¿å­˜APIæ¨¡æ¿å¤±è´¥:', apiTemplateResult.message);
                                alert('ä¿å­˜APIæ¨¡æ¿å¤±è´¥: ' + apiTemplateResult.message);
                            } else {
                                console.log('âœ… APIæ¨¡æ¿ä¿å­˜æˆåŠŸ:', apiTemplateResult.data);
                                console.log('ğŸ“Š APIæ¨¡æ¿çŠ¶æ€:', {
                                    enabled: apiTemplateEnabled,
                                    is_active: apiTemplateResult.data?.is_active,
                                    api_config_id: apiTemplateResult.data?.api_config_id
                                });
                                // ä¿å­˜æˆåŠŸåå»¶è¿Ÿåˆ·æ–°å›¾ç‰‡åˆ—è¡¨ä»¥æ›´æ–°æ ‡ç­¾ï¼ˆç»™æ•°æ®åº“æäº¤ä¸€ç‚¹æ—¶é—´ï¼‰
                                setTimeout(() => {
                                    console.log('ğŸ”„ åˆ·æ–°å›¾ç‰‡åˆ—è¡¨ä»¥æ›´æ–°æ ‡ç­¾...');
                                    loadImages(true);
                                }, 500);
                            }
                        } catch (error) {
                            console.error('ä¿å­˜APIæ¨¡æ¿å¤±è´¥:', error);
                        }
                    } else if (!apiComfyUIEnabled && savedImageId) {
                        // å¦‚æœç¦ç”¨äº†APIæ¨¡æ¿ä¸”æœªå¯ç”¨API-ComfyUIå·¥ä½œæµï¼Œåˆ é™¤ç°æœ‰é…ç½®
                        // æ³¨æ„ï¼šå¦‚æœå¯ç”¨äº†API-ComfyUIå·¥ä½œæµï¼Œä¸åº”è¯¥åˆ é™¤ï¼Œå› ä¸ºAPI-ComfyUIå·¥ä½œæµå’ŒAPIæ¨¡æ¿ä½¿ç”¨åŒä¸€ä¸ªAPITemplateè®°å½•
                        try {
                            await fetch(`/api/admin/styles/images/${savedImageId}/api-template`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ enabled: false })
                            });
                        } catch (error) {
                            console.error('åˆ é™¤APIæ¨¡æ¿å¤±è´¥:', error);
                        }
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('imageModal')).hide();
                    saveScrollPosition(); // ä¿å­˜æ»šåŠ¨ä½ç½®
                    loadImages(true); // ä¿æŒå½“å‰åˆ†ç±»
                    restoreScrollPosition(); // æ¢å¤æ»šåŠ¨ä½ç½®
                    // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯åˆšç¼–è¾‘çš„å›¾ç‰‡ï¼Œåˆ·æ–°è¯¦æƒ…é¢æ¿
                    if (selectedImageId == savedImageId) {
                        // é‡æ–°è·å–å›¾ç‰‡æ•°æ®ï¼ˆåŒ…å«æœ€æ–°çš„APIæ¨¡æ¿é…ç½®ï¼‰
                        try {
                            const imageResponse = await fetch(`/api/admin/styles/images/${savedImageId}`);
                            const imageData = await imageResponse.json();
                            if (imageData.status === 'success' && imageData.data) {
                                // æ›´æ–°imagesæ•°ç»„ä¸­çš„å›¾ç‰‡æ•°æ®
                                const imageIndex = images.findIndex(i => i.id == savedImageId);
                                if (imageIndex >= 0) {
                                    images[imageIndex] = imageData.data;
                                }
                                showImageDetail(imageData.data);
                            }
                        } catch (error) {
                            console.error('åˆ·æ–°å›¾ç‰‡è¯¦æƒ…å¤±è´¥:', error);
                            // å¦‚æœåˆ·æ–°å¤±è´¥ï¼Œä½¿ç”¨åŸæœ‰æ•°æ®
                            const image = images.find(i => i.id == savedImageId);
                            if (image) {
                                showImageDetail(image);
                            }
                        }
                    }
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜å›¾ç‰‡å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆ é™¤åˆ†ç±»
        async function deleteCategory(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿåˆ é™¤åè¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰å›¾ç‰‡ä¹Ÿä¼šè¢«åˆ é™¤ï¼')) {
                try {
                    const response = await fetch(`/api/admin/styles/categories/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        saveScrollPosition(); // ä¿å­˜æ»šåŠ¨ä½ç½®
                        loadCategories();
                        loadImages(true); // ä¿æŒå½“å‰åˆ†ç±»
                        restoreScrollPosition(); // æ¢å¤æ»šåŠ¨ä½ç½®
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + result.message);
                    }
                } catch (error) {
                    console.error('åˆ é™¤åˆ†ç±»å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }

        // ============================================================================
        // äºŒçº§åˆ†ç±»ç®¡ç†å‡½æ•°
        // ============================================================================
        
        // æ‰“å¼€æ·»åŠ äºŒçº§åˆ†ç±»æ¨¡æ€æ¡†
        function openAddSubcategoryModal() {
            if (!currentCategoryId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€çº§åˆ†ç±»');
                return;
            }
            
            const modalTitle = document.getElementById('subcategoryModalTitle');
            const modal = document.getElementById('subcategoryModal');
            
            if (!modal || !modalTitle) {
                console.error('äºŒçº§åˆ†ç±»æ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
                alert('é¡µé¢å…ƒç´ åŠ è½½é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            modalTitle.textContent = 'æ·»åŠ äºŒçº§åˆ†ç±»';
            
            const subcategoryId = document.getElementById('subcategoryId');
            const subcategoryCategoryId = document.getElementById('subcategoryCategoryId');
            const subcategoryName = document.getElementById('subcategoryName');
            const subcategoryCode = document.getElementById('subcategoryCode');
            const subcategoryIcon = document.getElementById('subcategoryIcon');
            const subcategoryCoverImageUrl = document.getElementById('subcategoryCoverImageUrl');
            const subcategorySortOrder = document.getElementById('subcategorySortOrder');
            const subcategoryIsActive = document.getElementById('subcategoryIsActive');
            
            if (subcategoryId) subcategoryId.value = '';
            if (subcategoryCategoryId) subcategoryCategoryId.value = currentCategoryId;
            if (subcategoryName) subcategoryName.value = '';
            if (subcategoryCode) subcategoryCode.value = '';
            if (subcategoryIcon) subcategoryIcon.value = '';
            if (subcategoryCoverImageUrl) subcategoryCoverImageUrl.value = '';
            if (subcategorySortOrder) subcategorySortOrder.value = 0;
            if (subcategoryIsActive) subcategoryIsActive.checked = true;
            
            // é‡ç½®å›¾ç‰‡é¢„è§ˆ
            const preview = document.getElementById('subcategoryCoverImagePreview');
            const upload = document.getElementById('subcategoryCoverImageUpload');
            if (preview) preview.style.display = 'none';
            if (upload) upload.style.display = 'block';
            
            new bootstrap.Modal(modal).show();
        }
        
        // ç¼–è¾‘äºŒçº§åˆ†ç±»
        function editSubcategory(id) {
            const subcategory = subcategories.find(s => s.id === id);
            if (!subcategory) return;
            
            document.getElementById('subcategoryModalTitle').textContent = 'ç¼–è¾‘äºŒçº§åˆ†ç±»';
            document.getElementById('subcategoryId').value = subcategory.id;
            document.getElementById('subcategoryCategoryId').value = subcategory.category_id;
            document.getElementById('subcategoryName').value = subcategory.name;
            document.getElementById('subcategoryCode').value = subcategory.code;
            document.getElementById('subcategoryIcon').value = subcategory.icon || '';
            document.getElementById('subcategoryCoverImageUrl').value = subcategory.cover_image || '';
            document.getElementById('subcategorySortOrder').value = subcategory.sort_order || 0;
            document.getElementById('subcategoryIsActive').checked = subcategory.is_active !== false;
            
            // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
            if (subcategory.cover_image) {
                document.getElementById('subcategoryCoverImagePreview').src = subcategory.cover_image;
                document.getElementById('subcategoryCoverImagePreview').style.display = 'block';
                document.getElementById('subcategoryCoverImageUpload').style.display = 'none';
            } else {
                document.getElementById('subcategoryCoverImagePreview').style.display = 'none';
                document.getElementById('subcategoryCoverImageUpload').style.display = 'block';
            }
            
            new bootstrap.Modal(document.getElementById('subcategoryModal')).show();
        }
        
        // ä¿å­˜äºŒçº§åˆ†ç±»
        async function saveSubcategory() {
            const form = document.getElementById('subcategoryForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // å¤„ç†å¤é€‰æ¡†
            data.is_active = document.getElementById('subcategoryIsActive').checked;
            
            // ç¡®ä¿category_idå­˜åœ¨
            if (!data.category_id) {
                data.category_id = currentCategoryId;
            }
            
            try {
                const url = data.id ? `/api/admin/styles/subcategories/${data.id}` : '/api/admin/styles/subcategories';
                const method = data.id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    bootstrap.Modal.getInstance(document.getElementById('subcategoryModal')).hide();
                    // é‡æ–°åŠ è½½åˆ†ç±»æ•°æ®ï¼ˆåŒ…å«äºŒçº§åˆ†ç±»ï¼‰
                    await loadCategories();
                    // é‡æ–°æ¸²æŸ“äºŒçº§åˆ†ç±»åˆ—è¡¨
                    if (currentCategoryId) {
                        const category = categories.find(c => c.id === currentCategoryId);
                        if (category) {
                            subcategories = category.subcategories || [];
                            console.log('ä¿å­˜åçš„äºŒçº§åˆ†ç±»æ•°æ®:', subcategories);
                            renderSubcategories();
                        } else {
                            console.warn('æœªæ‰¾åˆ°å½“å‰åˆ†ç±»:', currentCategoryId);
                        }
                    }
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¿å­˜äºŒçº§åˆ†ç±»å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // åˆ é™¤äºŒçº§åˆ†ç±»
        async function deleteSubcategory(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäºŒçº§åˆ†ç±»å—ï¼Ÿåˆ é™¤åè¯¥åˆ†ç±»ä¸‹çš„é£æ ¼å›¾ç‰‡å°†ä¸å†å…³è”åˆ°æ­¤äºŒçº§åˆ†ç±»ã€‚')) {
                try {
                    const response = await fetch(`/api/admin/styles/subcategories/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        // é‡æ–°åŠ è½½åˆ†ç±»æ•°æ®ï¼ˆåŒ…å«äºŒçº§åˆ†ç±»ï¼‰
                        await loadCategories();
                        // é‡æ–°æ¸²æŸ“äºŒçº§åˆ†ç±»åˆ—è¡¨
                        if (currentCategoryId) {
                            const category = categories.find(c => c.id === currentCategoryId);
                            if (category) {
                                subcategories = category.subcategories || [];
                                renderSubcategories();
                            }
                        }
                        // é‡æ–°åŠ è½½å›¾ç‰‡
                        await loadImages(true);
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + result.message);
                    }
                } catch (error) {
                    console.error('åˆ é™¤äºŒçº§åˆ†ç±»å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }
        
        // ä¸Šä¼ äºŒçº§åˆ†ç±»å°é¢å›¾ç‰‡
        async function uploadSubcategoryCoverImage(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                // ä½¿ç”¨ä¸ä¸€çº§åˆ†ç±»ç›¸åŒçš„ä¸Šä¼ APIï¼ˆäºŒçº§åˆ†ç±»ä¹Ÿä½¿ç”¨è¿™ä¸ªAPIï¼‰
                const response = await fetch('/api/admin/styles/categories/upload-cover-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    const imageUrl = result.data.image_url || result.data.url;
                    document.getElementById('subcategoryCoverImageUrl').value = imageUrl;
                    const preview = document.getElementById('subcategoryCoverImagePreview');
                    const upload = document.getElementById('subcategoryCoverImageUpload');
                    if (preview) {
                        preview.src = imageUrl;
                        preview.style.display = 'block';
                    }
                    if (upload) {
                        upload.style.display = 'none';
                    }
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ‰“å¼€äºŒçº§åˆ†ç±»æ’åºæ¨¡æ€æ¡†ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
        function openSortSubcategoryModal() {
            // TODO: å®ç°äºŒçº§åˆ†ç±»æ’åºåŠŸèƒ½
            alert('äºŒçº§åˆ†ç±»æ’åºåŠŸèƒ½å¾…å®ç°');
        }

        // åˆ é™¤å›¾ç‰‡
        async function deleteImage(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`/api/admin/styles/images/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        saveScrollPosition(); // ä¿å­˜æ»šåŠ¨ä½ç½®
                        loadImages(true); // ä¿æŒå½“å‰åˆ†ç±»
                        restoreScrollPosition(); // æ¢å¤æ»šåŠ¨ä½ç½®
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + result.message);
                    }
                } catch (error) {
                    console.error('åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }


        // é‡ç½®è¡¨å•
        document.getElementById('categoryModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('categoryForm').reset();
            // æ˜ç¡®æ¸…ç©ºåˆ†ç±»IDï¼Œç¡®ä¿æ˜¯æ·»åŠ æ–°åˆ†ç±»è€Œä¸æ˜¯æ›´æ–°
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryModalTitle').textContent = 'æ·»åŠ åˆ†ç±»';
            // æ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼Œé¿å…è®¿é—®ä¸å­˜åœ¨çš„å…ƒç´ 
            const coverImagePreview = document.getElementById('categoryCoverImagePreview');
            const coverImageUpload = document.getElementById('categoryCoverImageUpload');
            if (coverImagePreview) {
                coverImagePreview.style.display = 'none';
            }
            if (coverImageUpload) {
                coverImageUpload.style.display = 'block';
            }
        });

        // å¤„ç†æµ‹è¯•å›¾ç‰‡ä¸Šä¼ ï¼ˆæ”¯æŒå¤šå›¾ï¼‰
        let testImageDataArray = [];
        function handleTestImageUpload(input) {
            const files = Array.from(input.files);
            if (!files || files.length === 0) return;
            
            testImageDataArray = [];
            const previewContainer = document.getElementById('testImagePreviews');
            const uploadArea = document.getElementById('testImageUploadArea');
            const previewContainerWrapper = document.getElementById('testImagePreviewContainer');
            
            previewContainer.innerHTML = '';
            
            let loadedCount = 0;
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result;
                    testImageDataArray.push(base64Data);
                    
                    // åˆ›å»ºé¢„è§ˆ
                    const previewDiv = document.createElement('div');
                    previewDiv.style.cssText = 'position: relative; width: 150px; height: 150px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;';
                    const img = document.createElement('img');
                    img.src = base64Data;
                    img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                    previewDiv.appendChild(img);
                    
                    // æ·»åŠ åˆ é™¤æŒ‰é’®
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'btn btn-sm btn-danger';
                    deleteBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; padding: 2px 6px; font-size: 12px;';
                    deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                    deleteBtn.onclick = function() {
                        testImageDataArray.splice(index, 1);
                        previewDiv.remove();
                        if (testImageDataArray.length === 0) {
                            previewContainerWrapper.style.display = 'none';
                            uploadArea.style.display = 'block';
                            document.getElementById('testWorkflowBtn').disabled = true;
                        }
                    };
                    previewDiv.appendChild(deleteBtn);
                    previewContainer.appendChild(previewDiv);
                    
                    loadedCount++;
                    if (loadedCount === files.length) {
                        previewContainerWrapper.style.display = 'block';
                        uploadArea.style.display = 'none';
                        document.getElementById('testWorkflowBtn').disabled = false;
                        document.getElementById('testResult').style.display = 'none';
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        // æµ‹è¯•å·¥ä½œæµ
        async function testWorkflow() {
            const imageId = document.getElementById('imageId').value;
            const imageCategoryId = document.getElementById('imageCategory').value;
            
            if (!imageCategoryId) {
                alert('è¯·å…ˆé€‰æ‹©åˆ†ç±»');
                return;
            }
            
            if (!testImageDataArray || testImageDataArray.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æµ‹è¯•å›¾ç‰‡');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†AIå·¥ä½œæµ
            const isAiEnabled = document.getElementById('imageIsAiEnabled').checked;
            const categoryIsAiEnabled = categories.find(c => c.id == imageCategoryId)?.is_ai_enabled || false;
            
            if (!isAiEnabled && !categoryIsAiEnabled) {
                alert('è¯·å…ˆå¯ç”¨AIå·¥ä½œæµï¼ˆåœ¨åˆ†ç±»æˆ–å›¾ç‰‡çº§åˆ«ï¼‰');
                return;
            }
            
            // æ”¶é›†å½“å‰è¡¨å•ä¸­çš„å·¥ä½œæµé…ç½®
            let workflowConfig = null;
            if (isAiEnabled) {
                // ä½¿ç”¨å›¾ç‰‡çº§åˆ«çš„é…ç½®
                const workflowFile = document.getElementById('imageWorkflowFile').value;
                const workflowName = document.getElementById('imageWorkflowName').value;
                let workflowInputIds = document.getElementById('imageWorkflowInputIds').value;
                const workflowOutputId = document.getElementById('imageWorkflowOutputId').value;
                
                if (!workflowFile || !workflowInputIds || !workflowOutputId) {
                    alert('è¯·å…ˆé…ç½®å·¥ä½œæµæ–‡ä»¶ã€è¾“å…¥èŠ‚ç‚¹IDå’Œè¾“å‡ºèŠ‚ç‚¹ID');
                    return;
                }
                
                // å¤„ç†è¾“å…¥èŠ‚ç‚¹ID
                if (workflowInputIds && !workflowInputIds.trim().startsWith('[')) {
                    const ids = workflowInputIds.split(',').map(id => id.trim()).filter(id => id);
                    workflowInputIds = JSON.stringify(ids);
                }
                
                workflowConfig = {
                    workflow_file: workflowFile,
                    workflow_name: workflowName,
                    workflow_input_ids: workflowInputIds,
                    workflow_output_id: workflowOutputId,
                    workflow_ref_id: document.getElementById('imageWorkflowRefId').value || null,
                    workflow_ref_image: document.getElementById('imageWorkflowRefImage').value || null,
                    workflow_custom_prompt_id: document.getElementById('imageWorkflowCustomPromptId').value || null,
                    workflow_custom_prompt_content: document.getElementById('imageWorkflowCustomPromptContent').value || null
                };
            } else if (categoryIsAiEnabled) {
                // ä½¿ç”¨åˆ†ç±»çº§åˆ«çš„é…ç½®
                const category = categories.find(c => c.id == imageCategoryId);
                if (!category || !category.workflow_file) {
                    alert('åˆ†ç±»çš„å·¥ä½œæµé…ç½®ä¸å®Œæ•´ï¼Œè¯·å…ˆé…ç½®åˆ†ç±»çš„å·¥ä½œæµ');
                    return;
                }
                workflowConfig = {
                    workflow_file: category.workflow_file,
                    workflow_name: category.workflow_name,
                    workflow_input_ids: category.workflow_input_ids,
                    workflow_output_id: category.workflow_output_id,
                    workflow_ref_id: category.workflow_ref_id,
                    workflow_ref_image: category.workflow_ref_image,
                    workflow_custom_prompt_id: category.workflow_custom_prompt_id,
                    workflow_custom_prompt_content: category.workflow_custom_prompt_content
                };
            }
            
            if (!workflowConfig) {
                alert('æ— æ³•è·å–å·¥ä½œæµé…ç½®');
                return;
            }
            
            // æ˜¾ç¤ºè¿›åº¦
            document.getElementById('testProgress').style.display = 'block';
            document.getElementById('testResult').style.display = 'none';
            document.getElementById('testWorkflowBtn').disabled = true;
            
            try {
                // å¦‚æœå›¾ç‰‡å·²ä¿å­˜ï¼Œä½¿ç”¨image_idï¼›å¦åˆ™ä½¿ç”¨åˆ†ç±»ID
                const testUrl = imageId 
                    ? `/api/admin/styles/test-workflow/${imageId}`
                    : `/api/admin/styles/test-workflow-category/${imageCategoryId}`;
                
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_data: testImageDataArray, // æ”¹ä¸ºæ•°ç»„ï¼Œæ”¯æŒå¤šå›¾
                        workflow_config: workflowConfig
                    })
                });
                
                const result = await response.json();
                document.getElementById('testProgress').style.display = 'none';
                document.getElementById('testResult').style.display = 'block';
                document.getElementById('testWorkflowBtn').disabled = false;
                
                if (result.status === 'success') {
                    document.getElementById('testResultAlert').className = 'alert alert-success';
                    let content = '<p><strong>âœ… æµ‹è¯•æˆåŠŸï¼</strong></p>';
                    if (result.data) {
                        // æ˜¾ç¤ºè®¢å•ä¿¡æ¯
                        if (result.data.order_number) {
                            content += `<p><strong>è®¢å•å·:</strong> ${result.data.order_number}</p>`;
                            content += `<p><a href="/admin/orders?order_number=${result.data.order_number}" target="_blank" class="btn btn-sm btn-primary">æŸ¥çœ‹è®¢å•è¯¦æƒ…</a></p>`;
                        }
                        
                        // æ˜¾ç¤ºä»»åŠ¡ä¿¡æ¯ï¼ˆæ”¯æŒå¤šä»»åŠ¡ï¼‰
                        if (result.data.tasks && result.data.tasks.length > 0) {
                            content += `<p><strong>å·²åˆ›å»º ${result.data.tasks.length} ä¸ªAIä»»åŠ¡:</strong></p>`;
                            content += `<ul>`;
                            result.data.tasks.forEach((task, idx) => {
                                content += `<li>å›¾ç‰‡ ${idx + 1}: ä»»åŠ¡ID ${task.task_id}, çŠ¶æ€: ${task.status}`;
                                if (task.comfyui_prompt_id) {
                                    content += `, Prompt ID: ${task.comfyui_prompt_id}`;
                                }
                                content += `</li>`;
                            });
                            content += `</ul>`;
                            content += `<p><a href="/admin/ai/tasks" target="_blank" class="btn btn-sm btn-info">æŸ¥çœ‹AIä»»åŠ¡ç®¡ç†</a></p>`;
                        } else {
                            // å‘åå…¼å®¹ï¼šå•ä¸ªä»»åŠ¡çš„æƒ…å†µ
                            content += `<p>ä»»åŠ¡ID: ${result.data.task_id || 'N/A'}</p>`;
                            content += `<p>çŠ¶æ€: <span id="testStatus">${result.data.status || 'processing'}</span></p>`;
                            if (result.data.comfyui_prompt_id) {
                                content += `<p>ComfyUI Prompt ID: ${result.data.comfyui_prompt_id}</p>`;
                            }
                        }
                        
                        if (result.data.message) {
                            content += `<p>${result.data.message}</p>`;
                        }
                        
                        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                        if (result.data.errors && result.data.errors.length > 0) {
                            content += `<div class="alert alert-warning mt-2">`;
                            content += `<strong>éƒ¨åˆ†ä»»åŠ¡åˆ›å»ºå¤±è´¥:</strong>`;
                            content += `<ul class="mb-0">`;
                            result.data.errors.forEach(err => {
                                content += `<li>${err}</li>`;
                            });
                            content += `</ul></div>`;
                        }
                        
                        // æ·»åŠ å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸï¼ˆç”¨äºå•ä¸ªä»»åŠ¡çš„è½®è¯¢ç»“æœï¼‰
                        content += `<div id="testResultImageContainer" style="margin-top: 15px; display: none;">
                            <h6>ç”Ÿæˆç»“æœï¼š</h6>
                            <img id="testResultImage" style="max-width: 100%; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        </div>`;
                        content += `<div id="testResultLoading" style="margin-top: 15px; display: none;">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <span style="margin-left: 10px;">ç­‰å¾…ComfyUIå¤„ç†å®Œæˆ...</span>
                        </div>`;
                    }
                    document.getElementById('testResultContent').innerHTML = content;
                    
                    // å¦‚æœè¿”å›äº†å•ä¸ªä»»åŠ¡çš„prompt_idå’Œoutput_idï¼Œå¼€å§‹è½®è¯¢ç»“æœï¼ˆå‘åå…¼å®¹ï¼‰
                    if (result.data && result.data.comfyui_prompt_id && result.data.output_id && !result.data.tasks) {
                        pollTestResult(result.data.comfyui_prompt_id, result.data.output_id);
                    }
                } else {
                    document.getElementById('testResultAlert').className = 'alert alert-danger';
                    let content = '<p><strong>âŒ æµ‹è¯•å¤±è´¥</strong></p>';
                    content += `<p>${result.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    if (result.error) {
                        content += `<pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${result.error}</pre>`;
                    }
                    document.getElementById('testResultContent').innerHTML = content;
                }
            } catch (error) {
                document.getElementById('testProgress').style.display = 'none';
                document.getElementById('testResult').style.display = 'block';
                document.getElementById('testResultAlert').className = 'alert alert-danger';
                document.getElementById('testResultContent').innerHTML = `<p><strong>âŒ æµ‹è¯•å¤±è´¥</strong></p><p>${error.message || 'ç½‘ç»œé”™è¯¯'}</p>`;
                document.getElementById('testWorkflowBtn').disabled = false;
            }
        }
        
        // è½®è¯¢æµ‹è¯•ç»“æœ
        let pollInterval = null;
        function pollTestResult(promptId, outputId) {
            let attempts = 0;
            const maxAttempts = 60; // æœ€å¤šè½®è¯¢60æ¬¡ï¼ˆ5åˆ†é’Ÿï¼‰
            
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            
            // å‰ç«¯è½®è¯¢é—´éš”ï¼š3ç§’ï¼ˆæ¯”åå°è½®è¯¢æ›´é¢‘ç¹ï¼Œæé«˜ç”¨æˆ·ä½“éªŒï¼‰
            pollInterval = setInterval(async () => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(pollInterval);
                    const loadingEl = document.getElementById('testResultLoading');
                    if (loadingEl) {
                        loadingEl.innerHTML = '<span class="text-warning">â±ï¸ ç­‰å¾…è¶…æ—¶ï¼Œè¯·ç¨åæ‰‹åŠ¨åˆ·æ–°æŸ¥çœ‹ç»“æœ</span>';
                    }
                    return;
                }
                
                try {
                    const response = await fetch(`/api/admin/styles/test-workflow-result/${promptId}?output_id=${outputId}`);
                    const result = await response.json();
                    
                    if (result.status === 'success' && result.data && result.data.image_url) {
                        // æ‰¾åˆ°ç»“æœå›¾ç‰‡ï¼Œæ˜¾ç¤º
                        clearInterval(pollInterval);
                        
                        const loadingEl = document.getElementById('testResultLoading');
                        if (loadingEl) {
                            loadingEl.style.display = 'none';
                        }
                        
                        const imageContainer = document.getElementById('testResultImageContainer');
                        const resultImage = document.getElementById('testResultImage');
                        const statusEl = document.getElementById('testStatus');
                        
                        if (imageContainer && resultImage) {
                            resultImage.src = result.data.image_url;
                            imageContainer.style.display = 'block';
                        }
                        
                        if (statusEl) {
                            statusEl.textContent = 'completed';
                            statusEl.className = 'text-success';
                        }
                    } else if (result.status === 'processing') {
                        // è¿˜åœ¨å¤„ç†ä¸­ï¼Œç»§ç»­ç­‰å¾…
                        const statusEl = document.getElementById('testStatus');
                        if (statusEl) {
                            statusEl.textContent = 'processing';
                        }
                    } else if (result.status === 'error') {
                        // å‡ºé”™ï¼Œåœæ­¢è½®è¯¢
                        clearInterval(pollInterval);
                        const loadingEl = document.getElementById('testResultLoading');
                        if (loadingEl) {
                            loadingEl.innerHTML = `<span class="text-danger">âŒ ${result.message || 'æŸ¥è¯¢ç»“æœå¤±è´¥'}</span>`;
                        }
                    }
                } catch (error) {
                    console.error('è½®è¯¢ç»“æœå¤±è´¥:', error);
                    if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                    }
                }
            }, 3000); // æ¯3ç§’è½®è¯¢ä¸€æ¬¡ï¼ˆæé«˜å“åº”é€Ÿåº¦ï¼‰
        }
        
        document.getElementById('imageModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('imageForm').reset();
            // é‡è¦ï¼šæ¸…ç©º imageIdï¼Œç¡®ä¿ä¸‹æ¬¡æ‰“å¼€æ—¶æ˜¯æ·»åŠ æ¨¡å¼è€Œä¸æ˜¯ç¼–è¾‘æ¨¡å¼
            document.getElementById('imageId').value = '';
            document.getElementById('imageModalTitle').textContent = 'æ·»åŠ å›¾ç‰‡';
            const imagePreview = document.getElementById('imagePreview');
            const imageUploadArea = document.getElementById('imageUploadArea');
            const designImagePreview = document.getElementById('designImagePreview');
            const designImageUploadArea = document.getElementById('designImageUploadArea');
            const testImagePreview = document.getElementById('testImagePreview');
            const testImageUploadArea = document.getElementById('testImageUploadArea');
            const testResult = document.getElementById('testResult');
            const testProgress = document.getElementById('testProgress');
            
            if (imagePreview) imagePreview.style.display = 'none';
            if (imageUploadArea) imageUploadArea.style.display = 'block';
            // æ¸…ç©ºè®¾è®¡æ°´å°é¢„è§ˆ
            const designImageUrl = document.getElementById('designImageUrl');
            if (designImageUrl) designImageUrl.value = '';
            if (designImagePreview) designImagePreview.style.display = 'none';
            if (designImageUploadArea) designImageUploadArea.style.display = 'block';
            // æ¸…ç©ºæµ‹è¯•ç›¸å…³
            testImageData = null;
            if (testImagePreview) testImagePreview.style.display = 'none';
            if (testImageUploadArea) testImageUploadArea.style.display = 'block';
            const testWorkflowBtn = document.getElementById('testWorkflowBtn');
            if (testWorkflowBtn) testWorkflowBtn.disabled = true;
            if (testResult) testResult.style.display = 'none';
            if (testProgress) testProgress.style.display = 'none';
            // åœæ­¢è½®è¯¢
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            // æ¸…ç©ºåªè¯»å­—æ®µ
            const imageCode = document.getElementById('imageCode');
            const imageDescription = document.getElementById('imageDescription');
            if (imageCode) imageCode.value = '';
            if (imageDescription) imageDescription.value = '';
        });
        
        // æ·»åŠ å›¾ç‰‡æ—¶è‡ªåŠ¨å¡«å……å½“å‰é€‰ä¸­çš„åˆ†ç±»å’ŒäºŒçº§åˆ†ç±»
        document.getElementById('imageModal').addEventListener('show.bs.modal', function() {
            // å¦‚æœæ˜¯æ·»åŠ æ–°å›¾ç‰‡ï¼ˆä¸æ˜¯ç¼–è¾‘ï¼‰ï¼Œè‡ªåŠ¨å¡«å……å½“å‰åˆ†ç±»å’ŒäºŒçº§åˆ†ç±»
            const imageId = document.getElementById('imageId').value;
            if (!imageId) {
                // è‡ªåŠ¨å¡«å……ä¸€çº§åˆ†ç±»
                if (currentCategoryId) {
                    document.getElementById('imageCategory').value = currentCategoryId;
                    updateImageFormFields(); // è‡ªåŠ¨å¡«å……ä»£ç å’Œæè¿°ï¼Œå¹¶æ›´æ–°äºŒçº§åˆ†ç±»ä¸‹æ‹‰æ¡†
                    
                    // è‡ªåŠ¨å¡«å……äºŒçº§åˆ†ç±»ï¼ˆå¦‚æœå·²é€‰ä¸­ï¼‰
                    if (currentSubcategoryId) {
                        const subcategorySelect = document.getElementById('imageSubcategoryId');
                        if (subcategorySelect) {
                            // ç­‰å¾…äºŒçº§åˆ†ç±»ä¸‹æ‹‰æ¡†æ›´æ–°å®Œæˆ
                            setTimeout(() => {
                                subcategorySelect.value = currentSubcategoryId;
                            }, 100);
                        }
                    }
                }
            }
        });
        
        // ========== APIæ¨¡æ¿ç®¡ç†ç›¸å…³å‡½æ•° ==========
        
        // åŠ è½½APIé…ç½®åˆ—è¡¨
        async function loadApiConfigs() {
            try {
                const response = await fetch('/admin/ai-provider/api/configs');
                const data = await response.json();
                if (data.status === 'success' && data.data) {
                    const select = document.getElementById('imageApiConfigId');
                    if (select) {
                        // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
                        select.innerHTML = '<option value="">ä½¿ç”¨å…¨å±€é»˜è®¤APIé…ç½®</option>';
                        data.data.forEach(config => {
                            const option = document.createElement('option');
                            option.value = config.id;
                            option.textContent = config.name + (config.is_default ? ' (é»˜è®¤)' : '');
                            option.setAttribute('data-is-sync-api', config.is_sync_api ? '1' : '0');
                            option.setAttribute('data-api-type', config.api_type || '');
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('åŠ è½½APIé…ç½®åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // æ ¹æ®APIç±»å‹åŠ¨æ€æ˜¾ç¤º/éšè—é…ç½®é¡¹
        function toggleApiConfigFields() {
            const select = document.getElementById('imageApiConfigId');
            if (!select) return;
            
            const selectedOption = select.options[select.selectedIndex];
            const apiType = selectedOption ? selectedOption.getAttribute('data-api-type') : '';
            
            // æ ‡å‡†é…ç½®é¡¹ï¼ˆé»˜è®¤æ˜¾ç¤ºï¼‰
            const standardFields = [
                'imageApiPromptEditable',  // imageApiDefaultPrompt å·²ç§»é™¤
                'imageApiDefaultSize', 'imageApiDefaultAspectRatio',
                'imageApiSizeEditable', 'imageApiAspectRatioEditable',
                'imageApiEnhancePrompt'
            ];
            
            // RunningHub ComfyUIå·¥ä½œæµé…ç½®é¡¹ï¼ˆé»˜è®¤éšè—ï¼‰
            const rhWorkflowFields = [
                'imageWorkflowId', 'imageRhWorkflowInputIds', 'imageRhWorkflowOutputId',
                'imageRhWorkflowPromptId', 'imageRhWorkflowRefId',
                'imageRhWorkflowCustomPromptId', 'imageRhWorkflowCustomPromptContent'
            ];
            
            // RunningHub ComfyUI å·¥ä½œæµï¼šéšè—æ ‡å‡†é…ç½®ï¼Œæ˜¾ç¤ºå·¥ä½œæµé…ç½®
            if (apiType === 'runninghub-comfyui-workflow') {
                // éšè—æ ‡å‡†é…ç½®
                standardFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        const parent = field.closest('.mb-3') || field.closest('.row');
                        if (parent) parent.style.display = 'none';
                    }
                });
                
                // æ˜¾ç¤º RunningHub å·¥ä½œæµé…ç½®
                rhWorkflowFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        const parent = field.closest('.mb-3') || field.closest('.row');
                        if (parent) parent.style.display = '';
                    }
                });
            } else {
                // å…¶ä»–APIç±»å‹ï¼šæ˜¾ç¤ºæ ‡å‡†é…ç½®ï¼Œéšè—å·¥ä½œæµé…ç½®
                standardFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        const parent = field.closest('.mb-3') || field.closest('.row');
                        if (parent) parent.style.display = '';
                    }
                });
                
                rhWorkflowFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        const parent = field.closest('.mb-3') || field.closest('.row');
                        if (parent) parent.style.display = 'none';
                    }
                });
            }
        }
        
        // åŠ è½½APIæ¨¡æ¿æ•°æ®
        async function loadApiTemplateData(imageId) {
            if (!imageId) return;
            try {
                const response = await fetch(`/api/admin/styles/images/${imageId}/api-template`);
                const data = await response.json();
                if (data.status === 'success' && data.data) {
                    const template = data.data;
                    const enabledEl = document.getElementById('imageApiTemplateEnabled');
                    if (enabledEl) {
                        // æ ¹æ® is_active å­—æ®µè®¾ç½®å¯ç”¨çŠ¶æ€
                        enabledEl.checked = template.is_active !== false;
                        toggleApiTemplateConfig();
                    }
                    if (document.getElementById('imageApiConfigId')) {
                        document.getElementById('imageApiConfigId').value = template.api_config_id || '';
                        // è§¦å‘é…ç½®å­—æ®µæ˜¾ç¤º/éšè—ï¼ˆéœ€è¦å…ˆè®¾ç½®å€¼ï¼Œå†è§¦å‘ï¼‰
                        setTimeout(() => {
                            toggleApiConfigFields();
                            
                            // å¦‚æœæ˜¯ RunningHub ComfyUI å·¥ä½œæµï¼ŒåŠ è½½å·¥ä½œæµé…ç½®
                            const apiConfigSelect = document.getElementById('imageApiConfigId');
                            const selectedOption = apiConfigSelect ? apiConfigSelect.options[apiConfigSelect.selectedIndex] : null;
                            const apiType = selectedOption ? selectedOption.getAttribute('data-api-type') : '';
                            
                            if (apiType === 'runninghub-comfyui-workflow' && template.request_body_template) {
                                try {
                                    const requestBodyTemplate = typeof template.request_body_template === 'string' 
                                        ? JSON.parse(template.request_body_template) 
                                        : template.request_body_template;
                                    
                                    // åŠ è½½å·¥ä½œæµID
                                    if (requestBodyTemplate.workflow_id && document.getElementById('imageWorkflowIdInput')) {
                                        document.getElementById('imageWorkflowIdInput').value = requestBodyTemplate.workflow_id;
                                    }
                                    
                                    // ä¼˜å…ˆä»å•ç‹¬ä¿å­˜çš„å­—æ®µä¸­è¯»å–ï¼ˆæ›´å¯é ï¼‰
                                    if (requestBodyTemplate.input_node_id && document.getElementById('imageRhWorkflowInputIdsInput')) {
                                        document.getElementById('imageRhWorkflowInputIdsInput').value = requestBodyTemplate.input_node_id;
                                        console.log('âœ… åŠ è½½è¾“å…¥èŠ‚ç‚¹ID:', requestBodyTemplate.input_node_id);
                                    }
                                    
                                    if (requestBodyTemplate.prompt_node_id && document.getElementById('imageRhWorkflowPromptIdInput')) {
                                        document.getElementById('imageRhWorkflowPromptIdInput').value = requestBodyTemplate.prompt_node_id;
                                        console.log('âœ… åŠ è½½æç¤ºè¯èŠ‚ç‚¹ID:', requestBodyTemplate.prompt_node_id);
                                    } else {
                                        console.warn('âš ï¸ æœªæ‰¾åˆ° prompt_node_id æˆ–è¾“å…¥æ¡†ä¸å­˜åœ¨');
                                        console.log('requestBodyTemplate:', requestBodyTemplate);
                                    }
                                    
                                    if (requestBodyTemplate.ref_node_id && document.getElementById('imageRhWorkflowRefIdInput')) {
                                        document.getElementById('imageRhWorkflowRefIdInput').value = requestBodyTemplate.ref_node_id;
                                    }
                                    
                                    if (requestBodyTemplate.output_id && document.getElementById('imageRhWorkflowOutputIdInput')) {
                                        document.getElementById('imageRhWorkflowOutputIdInput').value = requestBodyTemplate.output_id;
                                    }
                                    
                                    if (requestBodyTemplate.custom_prompt_id && document.getElementById('imageRhWorkflowCustomPromptIdInput')) {
                                        document.getElementById('imageRhWorkflowCustomPromptIdInput').value = requestBodyTemplate.custom_prompt_id;
                                    }
                                    
                                    if (requestBodyTemplate.custom_prompt_content && document.getElementById('imageRhWorkflowCustomPromptContentInput')) {
                                        document.getElementById('imageRhWorkflowCustomPromptContentInput').value = requestBodyTemplate.custom_prompt_content;
                                    }
                                    
                                    // å¦‚æœæ²¡æœ‰å•ç‹¬ä¿å­˜çš„å­—æ®µï¼Œå°è¯•ä» nodeInfoList ä¸­è§£æï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
                                    if (!requestBodyTemplate.input_node_id && requestBodyTemplate.nodeInfoList && Array.isArray(requestBodyTemplate.nodeInfoList)) {
                                        const nodeInfoList = requestBodyTemplate.nodeInfoList;
                                        
                                        // è§£æè¾“å…¥å›¾ç‰‡èŠ‚ç‚¹ID
                                        const inputNode = nodeInfoList.find(node => 
                                            node.inputs && (node.inputs.image || node.inputs.imageUrls)
                                        );
                                        if (inputNode && document.getElementById('imageRhWorkflowInputIdsInput')) {
                                            document.getElementById('imageRhWorkflowInputIdsInput').value = inputNode.nodeId || '';
                                        }
                                        
                                        // è§£ææç¤ºè¯èŠ‚ç‚¹ID
                                        const promptNode = nodeInfoList.find(node => 
                                            node.inputs && node.inputs.text && node.inputs.text === '{{prompt}}'
                                        );
                                        if (promptNode && document.getElementById('imageRhWorkflowPromptIdInput')) {
                                            document.getElementById('imageRhWorkflowPromptIdInput').value = promptNode.nodeId || '';
                                        }
                                        
                                        // è§£æå‚è€ƒå›¾èŠ‚ç‚¹ID
                                        const refNode = nodeInfoList.find(node => 
                                            node.inputs && (node.inputs.image || node.inputs.imageUrls) && 
                                            (node.inputs.image === '{{ref_image_url}}' || node.nodeId !== inputNode?.nodeId)
                                        );
                                        if (refNode && document.getElementById('imageRhWorkflowRefIdInput')) {
                                            document.getElementById('imageRhWorkflowRefIdInput').value = refNode.nodeId || '';
                                        }
                                    }
                                } catch (e) {
                                    console.error('è§£æ request_body_template å¤±è´¥:', e);
                                }
                            }
                        }, 100);
                    }
                    // æ¨¡å‹åç§°é€‰æ‹©æ¡†å·²ç§»é™¤ï¼šç›´æ¥ä½¿ç”¨APIæœåŠ¡å•†é…ç½®ä¸­çš„æ¨¡å‹åç§°
                    // imageApiDefaultPrompt å­—æ®µå·²ç§»é™¤ï¼Œä¸å†åŠ è½½
                    if (document.getElementById('imageApiPromptEditable')) {
                        document.getElementById('imageApiPromptEditable').checked = template.prompt_editable !== false;
                    }
                    if (document.getElementById('imageApiDefaultSize')) {
                        document.getElementById('imageApiDefaultSize').value = template.default_size || '1K';
                    }
                    if (document.getElementById('imageApiDefaultAspectRatio')) {
                        document.getElementById('imageApiDefaultAspectRatio').value = template.default_aspect_ratio || 'auto';
                    }
                    if (document.getElementById('imageApiSizeEditable')) {
                        document.getElementById('imageApiSizeEditable').checked = template.size_editable !== false;
                    }
                    if (document.getElementById('imageApiAspectRatioEditable')) {
                        document.getElementById('imageApiAspectRatioEditable').checked = template.aspect_ratio_editable !== false;
                    }
                    if (document.getElementById('imageApiPointsCost')) {
                        document.getElementById('imageApiPointsCost').value = template.points_cost || 0;
                    }
                    if (document.getElementById('imageApiEnhancePrompt')) {
                        document.getElementById('imageApiEnhancePrompt').checked = template.enhance_prompt === true;
                    }
                    // åŠ è½½æ‰¹é‡æç¤ºè¯
                    if (template.prompts_json) {
                        try {
                            const prompts = typeof template.prompts_json === 'string' 
                                ? JSON.parse(template.prompts_json) 
                                : template.prompts_json;
                            if (Array.isArray(prompts)) {
                                imagePrompts = prompts;
                                renderImagePrompts();
                            }
                        } catch (e) {
                            console.error('è§£ææ‰¹é‡æç¤ºè¯å¤±è´¥:', e);
                            imagePrompts = [];
                            renderImagePrompts();
                        }
                    } else {
                        imagePrompts = [];
                        renderImagePrompts();
                    }
                    
                    // åŠ è½½ä¸Šä¼ é…ç½®
                    if (template.upload_config) {
                        try {
                            const uploadConfig = typeof template.upload_config === 'string' 
                                ? JSON.parse(template.upload_config) 
                                : template.upload_config;
                            if (uploadConfig && uploadConfig.uploads && Array.isArray(uploadConfig.uploads)) {
                                imageUploadConfigs = uploadConfig.uploads;
                                renderImageUploadConfigs();
                            }
                        } catch (e) {
                            console.error('è§£æä¸Šä¼ é…ç½®å¤±è´¥:', e);
                            imageUploadConfigs = [];
                            renderImageUploadConfigs();
                        }
                    } else {
                        imageUploadConfigs = [];
                        renderImageUploadConfigs();
                    }
                    
                    // åˆå§‹åŒ–æµ‹è¯•ä¸Šä¼ åŒºåŸŸ
                    initApiTestUploadAreas();
                    } else {
                        // æ²¡æœ‰APIæ¨¡æ¿é…ç½®ï¼Œé‡ç½®è¡¨å•
                        const enabledEl = document.getElementById('imageApiTemplateEnabled');
                        if (enabledEl) {
                            enabledEl.checked = false;
                            toggleApiTemplateConfig();
                        }
                        imagePrompts = [];
                        renderImagePrompts();
                        imageUploadConfigs = [];
                        renderImageUploadConfigs();
                    }
            } catch (error) {
                console.error('åŠ è½½APIæ¨¡æ¿æ•°æ®å¤±è´¥:', error);
                const enabledEl = document.getElementById('imageApiTemplateEnabled');
                if (enabledEl) {
                    enabledEl.checked = false;
                    toggleApiTemplateConfig();
                }
            }
        }
        
        // åˆ‡æ¢APIæ¨¡æ¿é…ç½®æ˜¾ç¤º
        function toggleApiTemplateConfig() {
            const enabledEl = document.getElementById('imageApiTemplateEnabled');
            const configDiv = document.getElementById('imageApiTemplateConfig');
            if (enabledEl && configDiv) {
                const isEnabled = enabledEl.checked;
                configDiv.style.display = isEnabled ? 'block' : 'none';
                console.log('ğŸ”„ APIæ¨¡æ¿å¼€å…³åˆ‡æ¢:', isEnabled ? 'å¯ç”¨' : 'ç¦ç”¨');
                // æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯åˆ‡æ¢æ˜¾ç¤ºï¼Œå®é™…ä¿å­˜éœ€è¦ç‚¹å‡»"ä¿å­˜"æŒ‰é’®
                // å¦‚æœéœ€è¦è‡ªåŠ¨ä¿å­˜ï¼Œå¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨ä¿å­˜é€»è¾‘
            }
        }
        
        // åˆ‡æ¢API-ComfyUIå·¥ä½œæµé…ç½®æ˜¾ç¤º
        function toggleApiComfyUIConfig() {
            const enabledEl = document.getElementById('imageApiComfyUIEnabled');
            const configDiv = document.getElementById('imageApiComfyUIConfig');
            if (enabledEl && configDiv) {
                configDiv.style.display = enabledEl.checked ? 'block' : 'none';
            }
        }
        
        // å¤„ç†API-ComfyUIé…ç½®åˆ‡æ¢ï¼ˆé˜²æ­¢æ¸…ç©ºæ•°æ®ï¼‰
        function handleApiComfyUIConfigChange() {
            const select = document.getElementById('imageApiComfyUIConfigId');
            if (!select) return;
            
            const selectedValue = select.value;
            console.log('ğŸ”„ API-ComfyUIé…ç½®åˆ‡æ¢:', selectedValue);
            
            // å¦‚æœåˆ‡æ¢åˆ°ç©ºå€¼ï¼ˆå…¨å±€é»˜è®¤ï¼‰ï¼Œä¸æ¸…ç©ºå…¶ä»–å­—æ®µ
            // å¦‚æœåˆ‡æ¢åˆ°å…¶ä»–é…ç½®ï¼Œä¹Ÿä¸æ¸…ç©ºå­—æ®µï¼ˆè®©ç”¨æˆ·è‡ªå·±å†³å®šæ˜¯å¦è¦ä¿®æ”¹ï¼‰
            // è¿™é‡Œä¸åšä»»ä½•æ¸…ç©ºæ“ä½œï¼Œä¿æŒç”¨æˆ·å·²å¡«å†™çš„æ•°æ®
        }
        
        // åŠ è½½API-ComfyUIå·¥ä½œæµé…ç½®åˆ—è¡¨
        async function loadApiComfyUIConfigs() {
            try {
                console.log('ğŸ“¥ å¼€å§‹åŠ è½½API-ComfyUIé…ç½®åˆ—è¡¨...');
                const response = await fetch('/admin/ai-provider/api/configs');
                const data = await response.json();
                console.log('ğŸ“¥ APIé…ç½®åˆ—è¡¨å“åº”:', data);
                
                if (data.status === 'success' && data.data) {
                    const select = document.getElementById('imageApiComfyUIConfigId');
                    if (select) {
                        // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼ï¼ˆå¦‚æœæœ‰ï¼‰
                        const currentValue = select.value;
                        console.log('ğŸ’¾ ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼:', currentValue);
                        
                        select.innerHTML = '<option value="">ä½¿ç”¨å…¨å±€é»˜è®¤APIé…ç½®</option>';
                        let foundCount = 0;
                        data.data.forEach(config => {
                            // åªæ˜¾ç¤º runninghub-comfyui-workflow ç±»å‹çš„é…ç½®
                            if (config.api_type === 'runninghub-comfyui-workflow') {
                                const option = document.createElement('option');
                                option.value = String(config.id);  // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²
                                option.textContent = config.name + (config.is_default ? ' (é»˜è®¤)' : '');
                                option.setAttribute('data-api-type', config.api_type || '');
                                select.appendChild(option);
                                foundCount++;
                                console.log('âœ… æ·»åŠ é…ç½®é€‰é¡¹:', config.id, config.name);
                            }
                        });
                        console.log(`âœ… å…±åŠ è½½ ${foundCount} ä¸ª runninghub-comfyui-workflow é…ç½®`);
                        
                        // å¦‚æœæœ‰ä¿å­˜çš„å€¼ï¼Œå°è¯•æ¢å¤
                        if (currentValue) {
                            select.value = currentValue;
                            if (select.value !== currentValue) {
                                console.warn('âš ï¸ æ¢å¤é€‰ä¸­å€¼å¤±è´¥ï¼Œå½“å‰å€¼:', select.value, 'æœŸæœ›å€¼:', currentValue);
                            } else {
                                console.log('âœ… æˆåŠŸæ¢å¤é€‰ä¸­å€¼:', currentValue);
                            }
                        }
                    }
                } else {
                    console.warn('âš ï¸ APIé…ç½®åˆ—è¡¨åŠ è½½å¤±è´¥æˆ–æ•°æ®ä¸ºç©º');
                }
            } catch (error) {
                console.error('åŠ è½½API-ComfyUIé…ç½®åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½API-ComfyUIå·¥ä½œæµæ¨¡æ¿æ•°æ®
        async function loadApiComfyUITemplateData(imageId) {
            if (!imageId) return;
            try {
                console.log('ğŸ“¥ åŠ è½½API-ComfyUIå·¥ä½œæµæ¨¡æ¿æ•°æ®:', imageId);
                const response = await fetch(`/api/admin/styles/images/${imageId}/api-template`);
                const data = await response.json();
                console.log('ğŸ“¥ APIæ¨¡æ¿æ•°æ®å“åº”:', data);
                
                if (data.status === 'success' && data.data) {
                    const template = data.data;
                    console.log('ğŸ“‹ APIæ¨¡æ¿æ•°æ®:', template);
                    
                    // å…ˆåŠ è½½é…ç½®åˆ—è¡¨
                    await loadApiComfyUIConfigs();
                    
                    // å…³é”®ä¿®å¤ï¼šåªæœ‰å½“ request_body_template å­˜åœ¨æ—¶ï¼Œæ‰è®¤ä¸ºæ˜¯ComfyUIå·¥ä½œæµ
                    // å¦‚æœåªæœ‰ api_config_id ä½†æ²¡æœ‰ request_body_templateï¼Œè¯´æ˜æ˜¯æ™®é€šAPIç¼–è¾‘é…ç½®ï¼Œä¸åº”è¯¥è®¾ç½®åˆ°ComfyUIä¸‹æ‹‰æ¡†
                    const isComfyUIWorkflow = !!template.request_body_template;
                    
                    console.log('ğŸ” åˆ¤æ–­APIæ¨¡æ¿ç±»å‹:', {
                        has_request_body_template: isComfyUIWorkflow,
                        api_config_id: template.api_config_id,
                        isComfyUI: isComfyUIWorkflow
                    });
                    
                    // åªæœ‰å½“ç¡®è®¤æ˜¯ComfyUIå·¥ä½œæµæ—¶ï¼Œæ‰è®¾ç½®ComfyUIç›¸å…³å­—æ®µ
                    if (isComfyUIWorkflow && template.api_config_id) {
                        // è·å–APIé…ç½®ç±»å‹
                        const apiConfigSelect = document.getElementById('imageApiComfyUIConfigId');
                        if (apiConfigSelect) {
                            // è®¾ç½®é€‰ä¸­çš„é…ç½®ï¼ˆç¡®ä¿å€¼æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼‰
                            const configIdStr = String(template.api_config_id);
                            
                            // ç­‰å¾…ä¸€ä¸‹ï¼Œç¡®ä¿é€‰é¡¹å·²åŠ è½½
                            await new Promise(resolve => setTimeout(resolve, 100));
                            
                            // æ£€æŸ¥é€‰é¡¹æ˜¯å¦å­˜åœ¨
                            const optionExists = Array.from(apiConfigSelect.options).some(opt => opt.value === configIdStr);
                            if (!optionExists) {
                                console.warn('âš ï¸ APIé…ç½®IDå¯¹åº”çš„é€‰é¡¹ä¸å­˜åœ¨ï¼Œé‡æ–°åŠ è½½é…ç½®åˆ—è¡¨');
                                await loadApiComfyUIConfigs();
                                await new Promise(resolve => setTimeout(resolve, 100));
                            }
                            
                            // å†æ¬¡æ£€æŸ¥é€‰é¡¹æ˜¯å¦å­˜åœ¨
                            const optionExistsAfterReload = Array.from(apiConfigSelect.options).some(opt => opt.value === configIdStr);
                            if (optionExistsAfterReload) {
                                apiConfigSelect.value = configIdStr;
                                console.log('âœ… è®¾ç½®APIé…ç½®ID:', configIdStr, 'åŸå§‹å€¼:', template.api_config_id, 'è®¾ç½®åå€¼:', apiConfigSelect.value);
                                
                                // éªŒè¯æ˜¯å¦è®¾ç½®æˆåŠŸ
                                if (apiConfigSelect.value !== configIdStr) {
                                    console.warn('âš ï¸ APIé…ç½®IDè®¾ç½®å¤±è´¥ï¼Œå½“å‰å€¼:', apiConfigSelect.value, 'æœŸæœ›å€¼:', configIdStr);
                                }
                            } else {
                                console.warn('âš ï¸ APIé…ç½®ID', configIdStr, 'åœ¨ComfyUIé…ç½®åˆ—è¡¨ä¸­ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯æ™®é€šAPIé…ç½®ï¼Œè·³è¿‡è®¾ç½®');
                            }
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯ runninghub-comfyui-workflow ç±»å‹
                            const selectedOption = apiConfigSelect.options[apiConfigSelect.selectedIndex];
                            const apiType = selectedOption ? selectedOption.getAttribute('data-api-type') : '';
                            console.log('ğŸ” APIç±»å‹:', apiType, 'é€‰ä¸­çš„é€‰é¡¹:', selectedOption ? selectedOption.textContent : 'æ— ');
                            
                            if (apiType === 'runninghub-comfyui-workflow' && template.request_body_template) {
                                console.log('âœ… æ£€æµ‹åˆ° runninghub-comfyui-workflow ç±»å‹ï¼ŒåŠ è½½é…ç½®');
                                const enabledEl = document.getElementById('imageApiComfyUIEnabled');
                                if (enabledEl) {
                                    enabledEl.checked = true;
                                    toggleApiComfyUIConfig();
                                }
                                
                                try {
                                    const requestBodyTemplate = typeof template.request_body_template === 'string' 
                                        ? JSON.parse(template.request_body_template) 
                                        : template.request_body_template;
                                    
                                    // åŠ è½½å·¥ä½œæµID
                                    if (requestBodyTemplate.workflow_id && document.getElementById('imageApiComfyUIWorkflowId')) {
                                        document.getElementById('imageApiComfyUIWorkflowId').value = requestBodyTemplate.workflow_id;
                                    }
                                    
                                    // ä»å•ç‹¬ä¿å­˜çš„å­—æ®µä¸­è¯»å–
                                    if (requestBodyTemplate.input_node_id && document.getElementById('imageApiComfyUIInputIds')) {
                                        document.getElementById('imageApiComfyUIInputIds').value = requestBodyTemplate.input_node_id;
                                    }
                                    
                                    if (requestBodyTemplate.prompt_node_id && document.getElementById('imageApiComfyUIPromptId')) {
                                        document.getElementById('imageApiComfyUIPromptId').value = requestBodyTemplate.prompt_node_id;
                                    }
                                    
                                    if (requestBodyTemplate.ref_node_id && document.getElementById('imageApiComfyUIRefId')) {
                                        document.getElementById('imageApiComfyUIRefId').value = requestBodyTemplate.ref_node_id;
                                    }
                                    
                                    if (requestBodyTemplate.output_id && document.getElementById('imageApiComfyUIOutputId')) {
                                        document.getElementById('imageApiComfyUIOutputId').value = requestBodyTemplate.output_id;
                                    }
                                    
                                    if (requestBodyTemplate.custom_prompt_id && document.getElementById('imageApiComfyUICustomPromptId')) {
                                        document.getElementById('imageApiComfyUICustomPromptId').value = requestBodyTemplate.custom_prompt_id;
                                    }
                                    
                                    if (requestBodyTemplate.custom_prompt_content && document.getElementById('imageApiComfyUICustomPromptContent')) {
                                        document.getElementById('imageApiComfyUICustomPromptContent').value = requestBodyTemplate.custom_prompt_content;
                                    }
                                    
                                    if (template.points_cost && document.getElementById('imageApiComfyUIPointsCost')) {
                                        document.getElementById('imageApiComfyUIPointsCost').value = template.points_cost;
                                    }
                                } catch (e) {
                                    console.error('è§£æ API-ComfyUI request_body_template å¤±è´¥:', e);
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('åŠ è½½API-ComfyUIå·¥ä½œæµæ¨¡æ¿æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // å¤„ç†API-ComfyUIå·¥ä½œæµæµ‹è¯•å›¾ç‰‡ä¸Šä¼ 
        let apiComfyUITestImageData = null;
        let apiComfyUITestImageCloudUrl = null;
        
        // API-ComfyUIæµ‹è¯•å›¾ç‰‡ï¼ˆæ”¯æŒå¤šå›¾ï¼‰
        let apiComfyUITestImageCloudUrls = [];
        let apiComfyUITestImageFiles = [];
        
        async function handleApiComfyUITestImageUpload(input) {
            const files = Array.from(input.files);
            if (!files || files.length === 0) return;
            
            apiComfyUITestImageCloudUrls = [];
            apiComfyUITestImageFiles = [];
            const previewContainer = document.getElementById('apiComfyUITestImagePreviews');
            const uploadArea = document.getElementById('apiComfyUITestUploadArea');
            const previewContainerWrapper = document.getElementById('apiComfyUITestImagePreviewContainer');
            
            previewContainer.innerHTML = '';
            previewContainerWrapper.style.display = 'block';
            uploadArea.style.display = 'none';
            
            // ä¸Šä¼ æ‰€æœ‰å›¾ç‰‡åˆ°grsaiæ–‡ä»¶æœåŠ¡å™¨
            const uploadPromises = files.map(async (file, index) => {
                try {
                    console.log(`ğŸ“¤ å¼€å§‹ä¸Šä¼ å›¾ç‰‡ ${index + 1}/${files.length} åˆ°grsaiæ–‡ä»¶æœåŠ¡å™¨ (API-ComfyUIæµ‹è¯•)...`);
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const uploadResponse = await fetch('/api/admin/styles/images/upload-to-grsai', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadResult = await uploadResponse.json();
                    
                    if (uploadResult.status === 'success' && uploadResult.data && uploadResult.data.url) {
                        apiComfyUITestImageCloudUrls.push(uploadResult.data.url);
                        apiComfyUITestImageFiles.push(file);
                        console.log(`âœ… å›¾ç‰‡ ${index + 1} å·²ä¸Šä¼ åˆ°grsai:`, uploadResult.data.url);
                        
                        // åˆ›å»ºé¢„è§ˆ
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const previewDiv = document.createElement('div');
                            previewDiv.style.cssText = 'position: relative; width: 150px; height: 150px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;';
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                            previewDiv.appendChild(img);
                            
                            // æ·»åŠ åˆ é™¤æŒ‰é’®
                            const deleteBtn = document.createElement('button');
                            deleteBtn.type = 'button';
                            deleteBtn.className = 'btn btn-sm btn-danger';
                            deleteBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; padding: 2px 6px; font-size: 12px;';
                            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                            deleteBtn.onclick = function() {
                                apiComfyUITestImageCloudUrls.splice(index, 1);
                                apiComfyUITestImageFiles.splice(index, 1);
                                previewDiv.remove();
                                if (apiComfyUITestImageCloudUrls.length === 0) {
                                    previewContainerWrapper.style.display = 'none';
                                    uploadArea.style.display = 'block';
                                    document.getElementById('testApiComfyUIBtn').disabled = true;
                                }
                            };
                            previewDiv.appendChild(deleteBtn);
                            previewContainer.appendChild(previewDiv);
                        };
                        reader.readAsDataURL(file);
                        
                        return true;
                    } else {
                        console.error(`âŒ å›¾ç‰‡ ${index + 1} ä¸Šä¼ å¤±è´¥:`, uploadResult.message);
                        return false;
                    }
                } catch (error) {
                    console.error(`âŒ å›¾ç‰‡ ${index + 1} ä¸Šä¼ å¼‚å¸¸:`, error);
                    return false;
                }
            });
            
            await Promise.all(uploadPromises);
            
            const testBtn = document.getElementById('testApiComfyUIBtn');
            if (testBtn && apiComfyUITestImageCloudUrls.length > 0) {
                testBtn.disabled = false;
            }
        }
        
        // æµ‹è¯•API-ComfyUIå·¥ä½œæµ
        async function testApiComfyUI() {
            const imageId = document.getElementById('imageId').value;
            if (!imageId) {
                alert('è¯·å…ˆä¿å­˜å›¾ç‰‡é…ç½®');
                return;
            }
            
            if (!apiComfyUITestImageCloudUrls || apiComfyUITestImageCloudUrls.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æµ‹è¯•å›¾ç‰‡');
                return;
            }
            
            const prompt = document.getElementById('apiComfyUITestPrompt')?.value || '';
            const resultEl = document.getElementById('apiComfyUITestResult');
            const progressEl = document.getElementById('apiComfyUITestProgress');
            const testBtn = document.getElementById('testApiComfyUIBtn');
            const resultAlert = document.getElementById('apiComfyUITestResultAlert');
            
            if (resultEl) resultEl.style.display = 'none';
            if (progressEl) progressEl.style.display = 'block';
            if (testBtn) testBtn.disabled = true;
            
            try {
                const formData = new FormData();
                // æ”¯æŒå¤šå›¾ï¼šå°†æ‰€æœ‰å›¾ç‰‡URLæ·»åŠ åˆ°formData
                apiComfyUITestImageCloudUrls.forEach((url, index) => {
                    formData.append('cloud_image_url', url);
                });
                if (prompt) {
                    formData.append('prompt', prompt);
                }
                
                const response = await fetch(`/api/admin/styles/images/${imageId}/test-api-comfyui`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (progressEl) progressEl.style.display = 'none';
                if (testBtn) testBtn.disabled = false;
                
                if (result.status === 'success') {
                    if (resultEl) {
                        resultEl.style.display = 'block';
                        if (resultAlert) {
                            resultAlert.className = 'alert alert-success';
                            resultAlert.innerHTML = `
                                <h6>æµ‹è¯•æˆåŠŸ!</h6>
                                <p>ä»»åŠ¡ID: ${result.data.task_id || 'N/A'}</p>
                                <p>${result.data.is_sync_api ? 'åŒæ­¥APIï¼Œç»“æœå·²è¿”å›' : 'å¼‚æ­¥APIï¼Œå¼€å§‹è½®è¯¢ç»“æœ...'}</p>
                            `;
                        }
                    }
                    
                    // å¦‚æœæ˜¯å¼‚æ­¥APIï¼Œå¼€å§‹è½®è¯¢
                    if (!result.data.is_sync_api && result.data.task_id) {
                        pollApiComfyUITestResult(result.data.task_id);
                    } else if (result.data.result_image_url) {
                        // åŒæ­¥APIï¼Œç›´æ¥æ˜¾ç¤ºç»“æœ
                        if (resultAlert) {
                            resultAlert.innerHTML += `
                                <div class="mt-3">
                                    <img src="${result.data.result_image_url}" class="img-fluid" style="max-width: 100%; border-radius: 8px;">
                                </div>
                            `;
                        }
                    }
                } else {
                    if (resultEl) {
                        resultEl.style.display = 'block';
                        if (resultAlert) {
                            resultAlert.className = 'alert alert-danger';
                            resultAlert.innerHTML = `<h6>æµ‹è¯•å¤±è´¥</h6><p>${result.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                        }
                    }
                }
            } catch (error) {
                console.error('æµ‹è¯•API-ComfyUIå·¥ä½œæµå¤±è´¥:', error);
                if (progressEl) progressEl.style.display = 'none';
                if (testBtn) testBtn.disabled = false;
                if (resultEl) {
                    resultEl.style.display = 'block';
                    if (resultAlert) {
                        resultAlert.className = 'alert alert-danger';
                        resultAlert.innerHTML = `<h6>æµ‹è¯•å¤±è´¥</h6><p>${error.message || 'ç½‘ç»œé”™è¯¯'}</p>`;
                    }
                }
            }
        }
        
        // è½®è¯¢API-ComfyUIå·¥ä½œæµæµ‹è¯•ç»“æœ
        async function pollApiComfyUITestResult(taskId) {
            const resultAlert = document.getElementById('apiComfyUITestResultAlert');
            let attempts = 0;
            const maxAttempts = 180; // æœ€å¤šè½®è¯¢15åˆ†é’Ÿï¼ˆæ¯5ç§’ä¸€æ¬¡ï¼‰
            
            const pollInterval = setInterval(async () => {
                attempts++;
                try {
                    const response = await fetch(`/api/admin/styles/images/test-api-comfyui/task/${taskId}`);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        if (result.data.status === 'completed' || result.data.status === 'success') {
                            clearInterval(pollInterval);
                            if (resultAlert) {
                                resultAlert.className = 'alert alert-success';
                                resultAlert.innerHTML = `
                                    <h6>æµ‹è¯•æˆåŠŸ!</h6>
                                    <p>ä»»åŠ¡ID: ${taskId}</p>
                                    ${result.data.result_image_url ? `
                                        <div class="mt-3">
                                            <img src="${result.data.result_image_url}" class="img-fluid" style="max-width: 100%; border-radius: 8px;">
                                        </div>
                                    ` : ''}
                                `;
                            }
                        } else if (result.data.status === 'failed') {
                            clearInterval(pollInterval);
                            if (resultAlert) {
                                resultAlert.className = 'alert alert-danger';
                                resultAlert.innerHTML = `<h6>æµ‹è¯•å¤±è´¥</h6><p>${result.data.error_message || 'ä»»åŠ¡æ‰§è¡Œå¤±è´¥'}</p>`;
                            }
                        }
                    } else if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                        if (resultAlert) {
                            resultAlert.className = 'alert alert-warning';
                            resultAlert.innerHTML = `<h6>è½®è¯¢è¶…æ—¶</h6><p>å·²è½®è¯¢15åˆ†é’Ÿï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ä»»åŠ¡çŠ¶æ€</p>`;
                        }
                    }
                } catch (error) {
                    console.error('è½®è¯¢API-ComfyUIæµ‹è¯•ç»“æœå¤±è´¥:', error);
                    if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                    }
                }
            }, 5000); // æ¯5ç§’è½®è¯¢ä¸€æ¬¡
        }
        
        // ä¸Šä¼ é…ç½®ç®¡ç†
        let imageUploadConfigs = [];
        let imagePrompts = [];  // æ‰¹é‡æç¤ºè¯åˆ—è¡¨
        
        // æ‰¹é‡æç¤ºè¯ç®¡ç†å‡½æ•°
        function addImagePrompt() {
            imagePrompts.push('');
            renderImagePrompts();
        }
        
        function removeImagePrompt(index) {
            imagePrompts.splice(index, 1);
            renderImagePrompts();
        }
        
        function updateImagePrompt(index, value) {
            if (imagePrompts[index] !== undefined) {
                imagePrompts[index] = value;
                updateImagePromptsJson();
            }
        }
        
        function renderImagePrompts() {
            const container = document.getElementById('imagePromptsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (imagePrompts.length === 0) {
                container.innerHTML = '<p class="text-muted small mb-0">æš‚æ— æç¤ºè¯ï¼Œç‚¹å‡»"æ·»åŠ æç¤ºè¯"æŒ‰é’®æ·»åŠ </p>';
            } else {
                imagePrompts.forEach((prompt, index) => {
                    const div = document.createElement('div');
                    div.className = 'mb-2';
                    div.innerHTML = `
                        <div class="input-group">
                            <span class="input-group-text">æç¤ºè¯ ${index + 1}</span>
                            <textarea class="form-control prompt-textarea" 
                                      id="prompt_${index}"
                                      rows="2" 
                                      placeholder="è¾“å…¥æç¤ºè¯"
                                      oninput="updateImagePrompt(${index}, this.value)"
                                      onblur="updateImagePrompt(${index}, this.value)">${(prompt || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}</textarea>
                            <button type="button" class="btn btn-outline-danger" 
                                    onclick="removeImagePrompt(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
            
            updateImagePromptsJson();
        }
        
        // ä»DOMè¯»å–æ‰€æœ‰æç¤ºè¯ï¼ˆä¿å­˜æ—¶è°ƒç”¨ï¼‰
        function collectImagePromptsFromDOM() {
            const container = document.getElementById('imagePromptsList');
            if (!container) return;
            
            const textareas = container.querySelectorAll('.prompt-textarea');
            imagePrompts = [];
            textareas.forEach(textarea => {
                const value = textarea.value.trim();
                if (value) {
                    imagePrompts.push(value);
                }
            });
            
            updateImagePromptsJson();
        }
        
        function updateImagePromptsJson() {
            const hiddenInput = document.getElementById('imagePromptsJson');
            if (hiddenInput) {
                // è¿‡æ»¤ç©ºæç¤ºè¯
                const validPrompts = imagePrompts.filter(p => p && p.trim());
                if (validPrompts.length > 0) {
                    hiddenInput.value = JSON.stringify(validPrompts);
                } else {
                    hiddenInput.value = '';
                }
            }
        }
        
        function addImageUploadConfig() {
            const index = imageUploadConfigs.length;
            imageUploadConfigs.push({
                name: '',
                key: '',
                required: true
            });
            renderImageUploadConfigs();
        }
        
        function removeImageUploadConfig(index) {
            imageUploadConfigs.splice(index, 1);
            renderImageUploadConfigs();
        }
        
        function updateImageUploadConfig(index, field, value) {
            if (imageUploadConfigs[index]) {
                imageUploadConfigs[index][field] = value;
                updateImageUploadConfigJson();
            }
        }
        
        function renderImageUploadConfigs() {
            const container = document.getElementById('imageUploadConfigList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (imageUploadConfigs.length === 0) {
                container.innerHTML = '<p class="text-muted small mb-0">æš‚æ— ä¸Šä¼ å…¥å£ï¼Œç‚¹å‡»"æ·»åŠ ä¸Šä¼ å…¥å£"æŒ‰é’®æ·»åŠ </p>';
            } else {
                imageUploadConfigs.forEach((config, index) => {
                    const div = document.createElement('div');
                    div.className = 'mb-3 p-3 bg-dark rounded border border-secondary';
                    div.innerHTML = `
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label small text-white">æ˜¾ç¤ºåç§°</label>
                                <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                       value="${config.name || ''}" 
                                       placeholder="å¦‚ï¼šå‚è€ƒå›¾ã€æ¨¡ç‰¹å›¾"
                                       onchange="updateImageUploadConfig(${index}, 'name', this.value)">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-white">å­—æ®µé”®å</label>
                                <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                                       value="${config.key || ''}" 
                                       placeholder="å¦‚ï¼šreferenceã€model"
                                       onchange="updateImageUploadConfig(${index}, 'key', this.value)">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small text-white">é¢„è®¾å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control bg-dark text-white border-secondary" 
                                           id="preset_image_${index}"
                                           value="${config.preset_image || config.example_image || ''}" 
                                           placeholder="é¢„è®¾å›¾ç‰‡URL"
                                           onchange="updateImageUploadConfig(${index}, 'preset_image', this.value)">
                                    <button type="button" class="btn btn-outline-secondary" 
                                            onclick="document.getElementById('preset_image_file_${index}').click()"
                                            title="ä¸Šä¼ é¢„è®¾å›¾ç‰‡">
                                        <i class="fas fa-upload"></i>
                                    </button>
                                    <input type="file" id="preset_image_file_${index}" 
                                           accept="image/*" 
                                           style="display: none;" 
                                           onchange="handlePresetImageUpload(${index}, this)">
                                </div>
                                ${(config.preset_image || config.example_image) ? `<img src="${config.preset_image || config.example_image}" class="mt-2" style="max-width: 100px; max-height: 100px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2);">` : ''}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-white">æ˜¯å¦å¿…å¡«</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" 
                                           ${config.required ? 'checked' : ''}
                                           onchange="updateImageUploadConfig(${index}, 'required', this.checked)">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small text-white">&nbsp;</label>
                                <button type="button" class="btn btn-sm btn-outline-danger w-100" 
                                        onclick="removeImageUploadConfig(${index})">
                                    <i class="fas fa-trash"></i> åˆ é™¤
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
            
            updateImageUploadConfigJson();
        }
        
        function updateImageUploadConfigJson() {
            const hiddenInput = document.getElementById('imageUploadConfigJson');
            if (hiddenInput) {
                if (imageUploadConfigs.length > 0) {
                    hiddenInput.value = JSON.stringify({ uploads: imageUploadConfigs });
                } else {
                    hiddenInput.value = '';
                }
            }
        }
        
        // ä¸Šä¼ é¢„è®¾å›¾ç‰‡ï¼ˆå…¼å®¹æ—§çš„example_imageå­—æ®µåï¼‰
        async function handlePresetImageUpload(index, input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/admin/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    const presetImageInput = document.getElementById(`preset_image_${index}`);
                    if (presetImageInput) {
                        presetImageInput.value = result.image_url;
                        // ä½¿ç”¨preset_imageå­—æ®µåï¼ŒåŒæ—¶å…¼å®¹æ—§çš„example_image
                        updateImageUploadConfig(index, 'preset_image', result.image_url);
                        // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                        renderImageUploadConfigs();
                    }
                } else {
                    alert('ä¸Šä¼ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å…¼å®¹æ—§çš„å‡½æ•°å
        const handleExampleImageUpload = handlePresetImageUpload;
        
        // å¤„ç†APIæµ‹è¯•å›¾ç‰‡ä¸Šä¼ ï¼ˆæ”¯æŒå¤šä¸ªä¸Šä¼ å…¥å£ï¼‰
        let apiTestImageFiles = {}; // æ”¹ä¸ºå¯¹è±¡ï¼Œæ”¯æŒå¤šä¸ªä¸Šä¼ å…¥å£ {key: file}
        let apiTestImageCloudUrls = {}; // ä¿å­˜äº‘ç«¯URL {key: url}
        
        // åˆå§‹åŒ–æµ‹è¯•ä¸Šä¼ åŒºåŸŸï¼ˆæ ¹æ®upload_configï¼‰
        function initApiTestUploadAreas() {
            const container = document.getElementById('apiTestUploadAreas');
            if (!container) return;
            
            container.innerHTML = '';
            
            // è·å–ä¸Šä¼ é…ç½®
            const uploadConfig = imageUploadConfigs.length > 0 
                ? { uploads: imageUploadConfigs } 
                : null;
            
            const uploadCount = uploadConfig && uploadConfig.uploads ? uploadConfig.uploads.length : 1;
            
            if (uploadConfig && uploadConfig.uploads && uploadConfig.uploads.length > 0) {
                // æœ‰é…ç½®ï¼Œæ˜¾ç¤ºå¤šä¸ªä¸Šä¼ çª—å£
                uploadConfig.uploads.forEach((config, index) => {
                    const uploadArea = createApiTestUploadArea(config, index);
                    container.appendChild(uploadArea);
                });
            } else {
                // æ— é…ç½®ï¼Œæ˜¾ç¤ºå•ä¸ªé»˜è®¤ä¸Šä¼ çª—å£
                const uploadArea = createApiTestUploadArea({name: 'ä¸Šä¼ æµ‹è¯•å›¾ç‰‡', key: 'default', required: false}, 0);
                container.appendChild(uploadArea);
            }
            
            // é‡ç½®æ–‡ä»¶æ•°æ®
            apiTestImageFiles = {};
            apiTestImageCloudUrls = {};
            checkApiTestButtonState();
        }
        
        // åˆ›å»ºæµ‹è¯•ä¸Šä¼ åŒºåŸŸ
        function createApiTestUploadArea(config, index) {
            const div = document.createElement('div');
            div.className = 'mb-3';
            const uploadKey = config.key || 'default';
            const uploadId = `apiTestImage_${index}_${uploadKey}`;
            div.innerHTML = `
                <label class="form-label">${config.name || 'ä¸Šä¼ æµ‹è¯•å›¾ç‰‡'}</label>
                <div class="upload-area" onclick="document.getElementById('${uploadId}').click()" style="min-height: 150px; border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer;">
                    <div id="${uploadId}_area">
                        <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-muted"></i>
                        <p class="mb-0 small">ç‚¹å‡»ä¸Šä¼ æµ‹è¯•å›¾ç‰‡</p>
                        <small class="text-muted">æ”¯æŒ JPGã€PNG æ ¼å¼</small>
                    </div>
                    <img id="${uploadId}_preview" class="preview-image" style="display: none; max-width: 100%; max-height: 200px; margin: 0 auto;">
                </div>
                <input type="file" id="${uploadId}" accept="image/*" style="display: none;" onchange="handleApiTestImageUpload(this, '${uploadKey}')">
            `;
            return div;
        }
        
        async function handleApiTestImageUpload(input, uploadKey) {
            const file = input.files[0];
            if (!file) return;
            
            apiTestImageFiles[uploadKey] = file;
            apiTestImageCloudUrls[uploadKey] = null; // é‡ç½®äº‘ç«¯URL
            
            const uploadId = input.id;
            const previewId = `${uploadId}_preview`;
            const areaId = `${uploadId}_area`;
            
            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById(previewId);
                const uploadArea = document.getElementById(areaId);
                if (preview) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                if (uploadArea) {
                    uploadArea.style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
            
            // ç«‹å³ä¸Šä¼ åˆ°grsaiæ–‡ä»¶æœåŠ¡å™¨
            try {
                console.log(`ğŸ“¤ å¼€å§‹ä¸Šä¼ å›¾ç‰‡åˆ°grsaiæ–‡ä»¶æœåŠ¡å™¨ (${uploadKey})...`);
                const formData = new FormData();
                formData.append('image', file);
                
                const uploadResponse = await fetch('/api/admin/styles/images/upload-to-grsai', {
                    method: 'POST',
                    body: formData
                });
                
                const uploadResult = await uploadResponse.json();
                
                if (uploadResult.status === 'success' && uploadResult.data && uploadResult.data.url) {
                    apiTestImageCloudUrls[uploadKey] = uploadResult.data.url;
                    console.log(`âœ… å›¾ç‰‡å·²ä¸Šä¼ åˆ°grsai (${uploadKey}):`, apiTestImageCloudUrls[uploadKey]);
                    
                    // æ˜¾ç¤ºä¸Šä¼ æˆåŠŸæç¤º
                    const uploadArea = document.getElementById(areaId);
                    if (uploadArea) {
                        uploadArea.innerHTML = `
                            <i class="fas fa-check-circle fa-2x mb-2 text-success"></i>
                            <p class="mb-0 text-success small">âœ… å·²ä¸Šä¼ </p>
                        `;
                        uploadArea.style.display = 'block';
                    }
                } else {
                    console.error('âŒ ä¸Šä¼ å¤±è´¥:', uploadResult.message);
                }
            } catch (error) {
                console.error('âŒ ä¸Šä¼ å¼‚å¸¸:', error);
            }
            
            checkApiTestButtonState();
        }
        
        function checkApiTestButtonState() {
            const testBtn = document.getElementById('testApiBtn');
            if (!testBtn) return;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¿…å¡«çš„ä¸Šä¼ å…¥å£æœªä¸Šä¼ 
            const uploadConfig = imageUploadConfigs.length > 0 
                ? { uploads: imageUploadConfigs } 
                : null;
            
            if (uploadConfig && uploadConfig.uploads) {
                const requiredUploads = uploadConfig.uploads.filter(u => u.required);
                const hasAllRequired = requiredUploads.every(u => {
                    const key = u.key || 'default';
                    return apiTestImageFiles[key] || apiTestImageCloudUrls[key];
                });
                testBtn.disabled = !hasAllRequired;
            } else {
                // é»˜è®¤ä¸Šä¼ å…¥å£
                const hasFile = apiTestImageFiles['default'] || apiTestImageCloudUrls['default'];
                testBtn.disabled = !hasFile;
            }
        }
        
        // æµ‹è¯•APIæ¨¡æ¿
        async function testApiTemplate() {
            const imageId = document.getElementById('imageId').value;
            if (!imageId) {
                alert('è¯·å…ˆä¿å­˜å›¾ç‰‡');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¼ çš„å›¾ç‰‡
            const hasAnyFile = Object.keys(apiTestImageFiles).length > 0 || Object.keys(apiTestImageCloudUrls).length > 0;
            if (!hasAnyFile) {
                alert('è¯·ä¸Šä¼ æµ‹è¯•å›¾ç‰‡');
                return;
            }
            
            const prompt = document.getElementById('apiTestPrompt') ? document.getElementById('apiTestPrompt').value : '';
            
            // æ˜¾ç¤ºè¿›åº¦
            const progressEl = document.getElementById('apiTestProgress');
            const resultEl = document.getElementById('apiTestResult');
            const testBtn = document.getElementById('testApiBtn');
            if (progressEl) progressEl.style.display = 'block';
            if (resultEl) resultEl.style.display = 'none';
            if (testBtn) testBtn.disabled = true;
            
            try {
                const formData = new FormData();
                
                // æ ¹æ®upload_configç»„ç»‡å›¾ç‰‡æ•°æ®
                const uploadConfig = imageUploadConfigs.length > 0 
                    ? { uploads: imageUploadConfigs } 
                    : null;
                
                if (uploadConfig && uploadConfig.uploads && uploadConfig.uploads.length > 0) {
                    // å¤šä¸ªä¸Šä¼ å…¥å£ï¼šæŒ‰keyç»„ç»‡ï¼Œæ”¯æŒç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡+é¢„è®¾å›¾ç‰‡
                    console.log('ğŸ” [testApiTemplate] å¤„ç†å¤šä¸ªä¸Šä¼ å…¥å£ï¼Œå…±', uploadConfig.uploads.length, 'ä¸ª');
                    console.log('ğŸ” [testApiTemplate] ä¸Šä¼ é…ç½®è¯¦æƒ…:', JSON.stringify(uploadConfig, null, 2));
                    console.log('ğŸ” [testApiTemplate] imageUploadConfigs:', JSON.stringify(imageUploadConfigs, null, 2));
                    console.log('ğŸ” [testApiTemplate] ä¸Šä¼ é…ç½®è¯¦æƒ…:', JSON.stringify(uploadConfig, null, 2));
                    
                    // å…ˆå¤„ç†é¢„è®¾å›¾ç‰‡ï¼ˆå¦‚æœæ˜¯æœ¬åœ°è·¯å¾„ï¼Œéœ€è¦ä¸Šä¼ åˆ°äº‘ç«¯ï¼‰
                    const processedUploads = await Promise.all(
                        uploadConfig.uploads.map(async (upload) => {
                            const presetImageUrl = upload.preset_image || upload.example_image;
                            console.log(`ğŸ” [testApiTemplate] æ£€æŸ¥ä¸Šä¼ å…¥å£ "${upload.name || upload.key}": presetImageUrl =`, presetImageUrl);
                            
                            if (!presetImageUrl) {
                                console.log(`âš ï¸ [testApiTemplate] ä¸Šä¼ å…¥å£ "${upload.name || upload.key}" æ²¡æœ‰é¢„è®¾å›¾ç‰‡`);
                                return upload; // æ²¡æœ‰é¢„è®¾å›¾ç‰‡ï¼Œç›´æ¥è¿”å›
                            }
                            
                            console.log(`ğŸ” [testApiTemplate] å¤„ç†é¢„è®¾å›¾ç‰‡: ${upload.name || upload.key} = ${presetImageUrl}`);
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°è·¯å¾„
                            const isLocalPath = presetImageUrl.startsWith('/media/') || 
                                               presetImageUrl.startsWith('/uploads/') ||
                                               (!presetImageUrl.startsWith('http://') && !presetImageUrl.startsWith('https://'));
                            
                            console.log(`ğŸ” [testApiTemplate] é¢„è®¾å›¾ç‰‡è·¯å¾„ç±»å‹: ${isLocalPath ? 'æœ¬åœ°è·¯å¾„' : 'äº‘ç«¯URL'}`);
                            
                            if (isLocalPath) {
                                // æœ¬åœ°è·¯å¾„ï¼šéœ€è¦ä¸Šä¼ åˆ°äº‘ç«¯è·å–URL
                                try {
                                    let fullUrl = presetImageUrl;
                                    if (presetImageUrl.startsWith('/')) {
                                        const baseUrl = window.location.origin;
                                        fullUrl = baseUrl + presetImageUrl;
                                    }
                                    
                                    console.log(`ğŸ“¤ [testApiTemplate] ä¸Šä¼ é¢„è®¾å›¾ç‰‡åˆ°äº‘ç«¯: ${fullUrl}`);
                                    
                                    const uploadResponse = await fetch('/api/admin/styles/images/upload-to-grsai', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ image_url: fullUrl })
                                    });
                                    
                                    const uploadResult = await uploadResponse.json();
                                    console.log(`ğŸ“¥ [testApiTemplate] é¢„è®¾å›¾ç‰‡ä¸Šä¼ å“åº”:`, uploadResult);
                                    
                                    if (uploadResult.status === 'success' && uploadResult.data && uploadResult.data.url) {
                                        console.log(`âœ… [testApiTemplate] é¢„è®¾å›¾ç‰‡å·²ä¸Šä¼ åˆ°äº‘ç«¯: ${presetImageUrl} -> ${uploadResult.data.url}`);
                                        return {
                                            ...upload,
                                            cloud_preset_image_url: uploadResult.data.url
                                        };
                                    } else {
                                        console.warn(`âš ï¸ [testApiTemplate] é¢„è®¾å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${presetImageUrl}`, uploadResult);
                                        // å³ä½¿ä¸Šä¼ å¤±è´¥ï¼Œä¹Ÿè¿”å›åŸå§‹URLï¼Œè®©åç«¯å°è¯•å¤„ç†
                                        return {
                                            ...upload,
                                            cloud_preset_image_url: presetImageUrl
                                        };
                                    }
                                } catch (error) {
                                    console.error(`âŒ [testApiTemplate] ä¸Šä¼ é¢„è®¾å›¾ç‰‡å¤±è´¥: ${presetImageUrl}`, error);
                                    // å³ä½¿ä¸Šä¼ å¤±è´¥ï¼Œä¹Ÿè¿”å›åŸå§‹URLï¼Œè®©åç«¯å°è¯•å¤„ç†
                                    return {
                                        ...upload,
                                        cloud_preset_image_url: presetImageUrl
                                    };
                                }
                            } else {
                                // å·²ç»æ˜¯äº‘ç«¯URLï¼Œç›´æ¥ä½¿ç”¨
                                console.log(`âœ… [testApiTemplate] é¢„è®¾å›¾ç‰‡å·²æ˜¯äº‘ç«¯URL: ${presetImageUrl}`);
                                return {
                                    ...upload,
                                    cloud_preset_image_url: presetImageUrl
                                };
                            }
                        })
                    );
                    
                    console.log('ğŸ” [testApiTemplate] å¤„ç†åçš„ä¸Šä¼ é…ç½®:', processedUploads);
                    
                    // æ„å»ºä¸Šä¼ é…ç½®ï¼ˆä¸åŒ…å«é¢„è®¾å›¾ç‰‡URLï¼ŒåªåŒ…å«é…ç½®ä¿¡æ¯ï¼‰
                    const uploadConfigToPass = {
                        uploads: processedUploads.map(upload => ({
                            name: upload.name,
                            key: upload.key || 'default',
                            required: upload.required || false
                        }))
                    };
                    
                    // æŒ‰keyç»„ç»‡å›¾ç‰‡ï¼šç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡åœ¨å‰ï¼Œé¢„è®¾å›¾ç‰‡åœ¨å
                    processedUploads.forEach((upload, index) => {
                        const key = upload.key || 'default';
                        console.log(`ğŸ” [testApiTemplate] å¤„ç†ä¸Šä¼ å…¥å£ ${index + 1}/${processedUploads.length}: key=${key}, name=${upload.name || 'N/A'}`);
                        
                        // å…ˆæ·»åŠ ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡
                        if (apiTestImageCloudUrls[key]) {
                            // æ”¯æŒå¤šä¸ªç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼ˆå¦‚æœæ˜¯æ•°ç»„ï¼‰
                            const userUrls = Array.isArray(apiTestImageCloudUrls[key]) 
                                ? apiTestImageCloudUrls[key] 
                                : [apiTestImageCloudUrls[key]];
                            
                            console.log(`ğŸ“¤ [testApiTemplate] æ‰¾åˆ°ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ (${key}):`, userUrls.length, 'å¼ ');
                            userUrls.forEach((url, urlIndex) => {
                                formData.append(`cloud_image_url_${key}`, url);
                                console.log(`  âœ… [testApiTemplate] æ·»åŠ ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ (${key}) [${urlIndex + 1}/${userUrls.length}]:`, url);
                            });
                        } else if (apiTestImageFiles[key]) {
                            // æ”¯æŒå¤šä¸ªæ–‡ä»¶ï¼ˆå¦‚æœæ˜¯æ•°ç»„ï¼‰
                            const files = Array.isArray(apiTestImageFiles[key]) 
                                ? apiTestImageFiles[key] 
                                : [apiTestImageFiles[key]];
                            
                            console.log(`ğŸ“¤ [testApiTemplate] æ‰¾åˆ°æœ¬åœ°æ–‡ä»¶ (${key}):`, files.length, 'ä¸ª');
                            files.forEach((file, fileIndex) => {
                                formData.append(`image_${key}`, file);
                                console.log(`  âœ… [testApiTemplate] æ·»åŠ æœ¬åœ°æ–‡ä»¶ (${key}) [${fileIndex + 1}/${files.length}]`);
                            });
                        } else {
                            console.log(`âš ï¸ [testApiTemplate] ä¸Šä¼ å…¥å£ "${key}" æ²¡æœ‰ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡`);
                        }
                        
                        // ç„¶åæ·»åŠ é¢„è®¾å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
                        const presetImageUrl = upload.cloud_preset_image_url || upload.preset_image || upload.example_image;
                        if (presetImageUrl) {
                            formData.append(`cloud_image_url_${key}`, presetImageUrl);
                            console.log(`  âœ… [testApiTemplate] æ·»åŠ é¢„è®¾å›¾ç‰‡ (${key}):`, presetImageUrl);
                        } else {
                            console.log(`âš ï¸ [testApiTemplate] ä¸Šä¼ å…¥å£ "${key}" æ²¡æœ‰é¢„è®¾å›¾ç‰‡`);
                        }
                    });
                    
                    // æ‰“å°FormDataä¸­çš„æ‰€æœ‰æ•°æ®ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                    console.log('ğŸ” [testApiTemplate] FormDataå†…å®¹:');
                    for (let pair of formData.entries()) {
                        console.log(`  - ${pair[0]}: ${pair[1]}`);
                    }
                    
                    // ä¼ é€’upload_config
                    formData.append('upload_config', JSON.stringify(uploadConfigToPass));
                    console.log('ğŸ” [testApiTemplate] æœ€ç»ˆä¸Šä¼ é…ç½®:', uploadConfigToPass);
                } else {
                    // å•ä¸ªé»˜è®¤ä¸Šä¼ å…¥å£
                    if (apiTestImageCloudUrls['default']) {
                        const defaultUrls = Array.isArray(apiTestImageCloudUrls['default']) 
                            ? apiTestImageCloudUrls['default'] 
                            : [apiTestImageCloudUrls['default']];
                        defaultUrls.forEach(url => {
                            formData.append('cloud_image_url', url);
                        });
                        console.log('ğŸ“¤ [testApiTemplate] ä½¿ç”¨å·²ä¸Šä¼ çš„äº‘ç«¯URL:', defaultUrls);
                    } else if (apiTestImageFiles['default']) {
                        const defaultFiles = Array.isArray(apiTestImageFiles['default']) 
                            ? apiTestImageFiles['default'] 
                            : [apiTestImageFiles['default']];
                        defaultFiles.forEach(file => {
                            formData.append('image', file);
                        });
                        console.log('ğŸ“¤ [testApiTemplate] ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ä¸Šä¼ ');
                    }
                }
                
                if (prompt) {
                    formData.append('prompt', prompt);
                }
                
                const response = await fetch(`/api/admin/styles/images/${imageId}/test-api`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (progressEl) progressEl.style.display = 'none';
                if (resultEl) resultEl.style.display = 'block';
                if (testBtn) testBtn.disabled = false;
                
                const resultAlert = document.getElementById('apiTestResultAlert');
                const resultContent = document.getElementById('apiTestResultContent');
                
                if (result.status === 'success') {
                    if (resultAlert) resultAlert.className = 'alert alert-success';
                    if (resultContent) {
                        let content = '<p><strong>âœ… æµ‹è¯•æˆåŠŸï¼</strong></p>';
                        if (result.data && result.data.task_id) {
                            content += `<p><strong>ä»»åŠ¡IDï¼š</strong>${result.data.task_id}</p>`;
                            if (result.data.is_sync_api) {
                                content += '<p>åŒæ­¥APIï¼Œç­‰å¾…ç»“æœ...</p>';
                                if (result.data.result_image_url) {
                                    content += `<p><strong>ç»“æœå›¾ç‰‡ï¼š</strong><a href="${result.data.result_image_url}" target="_blank">${result.data.result_image_url}</a></p>`;
                                    content += `<div class="mt-3"><img src="${result.data.result_image_url}" style="max-width: 100%; border: 1px solid #2a2a2a; border-radius: 4px;"></div>`;
                                }
                            } else {
                                content += '<p>å¼‚æ­¥APIï¼Œå¼€å§‹è½®è¯¢ç»“æœ...</p>';
                                pollApiTestResult(result.data.task_id, false);
                            }
                        }
                        resultContent.innerHTML = content;
                    }
                } else {
                    if (resultAlert) resultAlert.className = 'alert alert-danger';
                    if (resultContent) {
                        resultContent.innerHTML = `<p><strong>âŒ æµ‹è¯•å¤±è´¥</strong></p><p>${result.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    }
                }
            } catch (error) {
                if (progressEl) progressEl.style.display = 'none';
                if (resultEl) resultEl.style.display = 'block';
                if (resultAlert) resultAlert.className = 'alert alert-danger';
                if (resultContent) {
                    resultContent.innerHTML = `<p><strong>âŒ æµ‹è¯•å¤±è´¥</strong></p><p>${error.message || 'ç½‘ç»œé”™è¯¯'}</p>`;
                }
                if (testBtn) testBtn.disabled = false;
            }
        }
        
        // è½®è¯¢APIæµ‹è¯•ç»“æœï¼ˆä¼˜åŒ–ç‰ˆï¼šæ™ºèƒ½è½®è¯¢é—´éš”ï¼Œå‚è€ƒbk-photo-v4ï¼‰
        let apiTestPollInterval = null;
        let apiTestPollStopped = false;
        
        async function pollApiTestResult(taskId, isSyncApi) {
            // åŒæ­¥APIä¸éœ€è¦è½®è¯¢
            if (isSyncApi) {
                console.log('âœ… åŒæ­¥APIï¼Œè·³è¿‡è½®è¯¢');
                return;
            }
            
            // å¦‚æœå·²æœ‰è½®è¯¢åœ¨è¿›è¡Œï¼Œå…ˆåœæ­¢
            if (apiTestPollInterval) {
                clearTimeout(apiTestPollInterval);
                apiTestPollInterval = null;
            }
            
            apiTestPollStopped = false;
            const taskStartTime = Date.now();
            const MAX_POLL_TIME = 15 * 60 * 1000; // æœ€å¤§è½®è¯¢æ—¶é—´ï¼š15åˆ†é’Ÿ
            let pollCount = 0;
            const resultContent = document.getElementById('apiTestResultContent');
            
            // æ™ºèƒ½è½®è¯¢ï¼šæ ¹æ®ä»»åŠ¡è¿è¡Œæ—¶é—´åŠ¨æ€è°ƒæ•´è½®è¯¢é—´éš”
            // ä¼˜åŒ–ç­–ç•¥ï¼šå‰30ç§’ä¸è½®è¯¢ï¼Œ30-60ç§’æ¯15ç§’ï¼Œ60-120ç§’æ¯20ç§’ï¼Œ120-180ç§’æ¯30ç§’ï¼Œ180ç§’ä»¥ä¸Šæ¯45ç§’
            function scheduleNextPoll() {
                // å¦‚æœè½®è¯¢å·²åœæ­¢ï¼Œä¸å†å®‰æ’ä¸‹ä¸€æ¬¡
                if (apiTestPollStopped) {
                    return;
                }
                
                const elapsed = Date.now() - taskStartTime;
                const elapsedSeconds = elapsed / 1000;
                
                // è¶…è¿‡æœ€å¤§è½®è¯¢æ—¶é—´ï¼Œåœæ­¢è½®è¯¢
                if (elapsed >= MAX_POLL_TIME) {
                    console.warn('âš ï¸ APIæµ‹è¯•è½®è¯¢å·²è¶…è¿‡15åˆ†é’Ÿï¼Œåœæ­¢è½®è¯¢');
                    apiTestPollStopped = true;
                    if (apiTestPollInterval) {
                        clearTimeout(apiTestPollInterval);
                        apiTestPollInterval = null;
                    }
                    if (resultContent) {
                        resultContent.innerHTML += '<p class="text-warning">â±ï¸ ç­‰å¾…è¶…æ—¶ï¼Œè¯·ç¨åæ‰‹åŠ¨åˆ·æ–°æŸ¥çœ‹ç»“æœ</p>';
                    }
                    return;
                }
                
                // å‰30ç§’ä¸è½®è¯¢ï¼Œç›´æ¥å®‰æ’30ç§’åçš„ç¬¬ä¸€æ¬¡è½®è¯¢
                if (elapsedSeconds < 30) {
                    const waitTime = (30 - elapsedSeconds) * 1000;
                    apiTestPollInterval = setTimeout(() => {
                        if (!apiTestPollStopped) {
                            pollCount++;
                            pollApiTestTaskStatus(taskId);
                            scheduleNextPoll();
                        }
                    }, waitTime);
                    return;
                }
                
                // 30ç§’åå¼€å§‹è½®è¯¢ï¼Œæ ¹æ®æ—¶é—´è°ƒæ•´é—´éš”
                pollCount++;
                pollApiTestTaskStatus(taskId);
                
                let nextInterval;
                if (elapsedSeconds < 60) {
                    // 30-60ç§’ï¼šæ¯15ç§’è½®è¯¢ä¸€æ¬¡
                    nextInterval = 15000;
                } else if (elapsedSeconds < 120) {
                    // 60-120ç§’ï¼šæ¯20ç§’è½®è¯¢ä¸€æ¬¡
                    nextInterval = 20000;
                } else if (elapsedSeconds < 180) {
                    // 120-180ç§’ï¼šæ¯30ç§’è½®è¯¢ä¸€æ¬¡
                    nextInterval = 30000;
                } else {
                    // 180ç§’ä»¥ä¸Šï¼šæ¯45ç§’è½®è¯¢ä¸€æ¬¡
                    nextInterval = 45000;
                }
                
                apiTestPollInterval = setTimeout(() => {
                    if (!apiTestPollStopped) {
                        scheduleNextPoll();
                    }
                }, nextInterval);
            }
            
            // æ‰§è¡Œè½®è¯¢çš„å‡½æ•°
            async function pollApiTestTaskStatus(taskId) {
                try {
                    const response = await fetch(`/api/admin/styles/images/test-api/task/${taskId}`);
                    const result = await response.json();
                    
                    if (result.status === 'success' && result.data) {
                        if (result.data.status === 'completed' && result.data.result_image_url) {
                            // ä»»åŠ¡å®Œæˆï¼Œåœæ­¢è½®è¯¢
                            apiTestPollStopped = true;
                            if (apiTestPollInterval) {
                                clearTimeout(apiTestPollInterval);
                                apiTestPollInterval = null;
                            }
                            if (resultContent) {
                                let content = resultContent.innerHTML;
                                content += `<p><strong>âœ… å¤„ç†å®Œæˆï¼</strong></p>`;
                                content += `<p><strong>ç»“æœå›¾ç‰‡ï¼š</strong><a href="${result.data.result_image_url}" target="_blank">${result.data.result_image_url}</a></p>`;
                                content += `<div class="mt-3"><img src="${result.data.result_image_url}" style="max-width: 100%; border: 1px solid #2a2a2a; border-radius: 4px;"></div>`;
                                resultContent.innerHTML = content;
                            }
                        } else if (result.data.status === 'failed') {
                            // ä»»åŠ¡å¤±è´¥ï¼Œåœæ­¢è½®è¯¢
                            apiTestPollStopped = true;
                            if (apiTestPollInterval) {
                                clearTimeout(apiTestPollInterval);
                                apiTestPollInterval = null;
                            }
                            if (resultContent) {
                                resultContent.innerHTML += `<p class="text-danger">âŒ å¤„ç†å¤±è´¥ï¼š${result.data.error_message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                            }
                        }
                        // å¦‚æœçŠ¶æ€æ˜¯processingï¼Œç»§ç»­è½®è¯¢ï¼ˆç”±scheduleNextPollå®‰æ’ï¼‰
                    }
                } catch (error) {
                    console.error('è½®è¯¢APIæµ‹è¯•ç»“æœå¤±è´¥:', error);
                    // å‡ºé”™ä¸åœæ­¢è½®è¯¢ï¼Œç»§ç»­å°è¯•
                }
            }
            
            // å¼€å§‹æ™ºèƒ½è½®è¯¢ï¼ˆå‰30ç§’ä¸è½®è¯¢ï¼Œ30ç§’åå¼€å§‹ï¼‰
            scheduleNextPoll();
        }
        
        // ç»‘å®šAPIæ¨¡æ¿å¯ç”¨å¼€å…³äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const apiTemplateEnabled = document.getElementById('imageApiTemplateEnabled');
            if (apiTemplateEnabled) {
                apiTemplateEnabled.addEventListener('change', toggleApiTemplateConfig);
            }
            const apiComfyUIEnabled = document.getElementById('imageApiComfyUIEnabled');
            if (apiComfyUIEnabled) {
                apiComfyUIEnabled.addEventListener('change', toggleApiComfyUIConfig);
            }
            // é¡µé¢åŠ è½½æ—¶åŠ è½½APIé…ç½®åˆ—è¡¨
            loadApiConfigs();
            loadApiComfyUIConfigs();
        });
    </script>
    
    <!-- æ’åºæ¨¡æ€æ¡† -->
    <div class="modal fade" id="sortModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ‹–æ‹½æ’åº</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">æ‹–æ‹½ä¸‹æ–¹å›¾ç‰‡å¡ç‰‡æ¥è°ƒæ•´é¡ºåºï¼Œå®Œæˆåç‚¹å‡»"ä¿å­˜æ’åº"</p>
                    <div id="sortableImages" style="min-height: 300px;">
                        <!-- å¯æ‹–æ‹½çš„å›¾ç‰‡åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveSortOrder()">ä¿å­˜æ’åº</button>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        /* æ‹–æ‹½æ’åºæ ·å¼ */
        #sortableImages .sortable-item {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: move;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        #sortableImages .sortable-item:hover {
            background: #2a2a2a;
            border-color: #3a3a3a;
        }
        
        #sortableImages .sortable-item.dragging {
            opacity: 0.5;
            border-color: #667eea;
        }
        
        #sortableImages .sortable-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 15px;
        }
        
        #sortableImages .sortable-item .item-info {
            flex: 1;
        }
        
        #sortableImages .sortable-item .item-info h6 {
            margin: 0;
            color: #e0e0e0;
        }
        
        #sortableImages .sortable-item .item-info small {
            color: #999;
        }
        
        #sortableImages .sortable-item .drag-handle {
            color: #999;
            font-size: 20px;
            margin-left: 10px;
        }
    </style>
    
    <script>
        // æ‹–æ‹½æ’åºåŠŸèƒ½
        let sortableImages = [];
        
        function openSortModal() {
            if (!currentCategoryId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†ç±»');
                return;
            }
            
            // è·å–å½“å‰åˆ†ç±»ä¸‹çš„æ‰€æœ‰å›¾ç‰‡
            const categoryImages = images.filter(img => img.category_id == currentCategoryId);
            if (categoryImages.length === 0) {
                alert('å½“å‰åˆ†ç±»ä¸‹æ²¡æœ‰å›¾ç‰‡');
                return;
            }
            
            // æŒ‰å½“å‰æ’åºé¡ºåºæ’åº
            categoryImages.sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
            sortableImages = [...categoryImages];
            
            // æ¸²æŸ“å¯æ‹–æ‹½åˆ—è¡¨
            renderSortableList();
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('sortModal'));
            modal.show();
        }
        
        function renderSortableList() {
            const container = document.getElementById('sortableImages');
            container.innerHTML = '';
            
            sortableImages.forEach((image, index) => {
                const div = document.createElement('div');
                div.className = 'sortable-item';
                div.draggable = true;
                div.dataset.index = index;
                div.innerHTML = `
                    <img src="${image.image_url}" alt="${image.name}" onerror="this.style.display='none'">
                    <div class="item-info">
                        <h6>${image.name}</h6>
                        <small>${image.description || ''}</small>
                    </div>
                    <i class="fas fa-grip-vertical drag-handle"></i>
                `;
                
                // æ‹–æ‹½äº‹ä»¶
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('drop', handleDrop);
                div.addEventListener('dragend', handleDragEnd);
                
                container.appendChild(div);
            });
        }
        
        let draggedElement = null;
        
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const afterElement = getDragAfterElement(this.parentNode, e.clientY);
            const dragging = document.querySelector('.dragging');
            if (!dragging || dragging === this) return;
            
            if (afterElement == null) {
                this.parentNode.appendChild(dragging);
            } else {
                this.parentNode.insertBefore(dragging, afterElement);
            }
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (!draggedElement) return;
            
            // è·å–æ–°çš„é¡ºåº
            const container = document.getElementById('sortableImages');
            const items = Array.from(container.querySelectorAll('.sortable-item'));
            const newOrder = items.map(item => {
                const index = parseInt(item.dataset.index);
                return sortableImages[index];
            });
            
            // æ›´æ–°æ•°ç»„é¡ºåº
            sortableImages = newOrder;
            
            // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°ç´¢å¼•
            renderSortableList();
            
            return false;
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.sortable-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        async function saveSortOrder() {
            try {
                // æ›´æ–°æ¯ä¸ªå›¾ç‰‡çš„æ’åºå€¼
                const updates = sortableImages.map((image, index) => ({
                    id: image.id,
                    sort_order: index
                }));
                
                // æ‰¹é‡æ›´æ–°æ’åº
                for (const update of updates) {
                    const response = await fetch(`/api/admin/styles/images/${update.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sort_order: update.sort_order
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`æ›´æ–°å›¾ç‰‡ ${update.id} æ’åºå¤±è´¥`);
                    }
                }
                
                // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°
                bootstrap.Modal.getInstance(document.getElementById('sortModal')).hide();
                saveScrollPosition();
                loadImages(true); // ä¿æŒå½“å‰åˆ†ç±»
                restoreScrollPosition();
                alert('æ’åºä¿å­˜æˆåŠŸ');
            } catch (error) {
                console.error('ä¿å­˜æ’åºå¤±è´¥:', error);
                alert('ä¿å­˜æ’åºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // å½“é€‰æ‹©åˆ†ç±»æ—¶ï¼Œæ˜¾ç¤º/éšè—æ’åºæŒ‰é’®
        function updateSortButtonVisibility() {
            const sortBtn = document.getElementById('sortBtn');
            if (currentCategoryId) {
                const categoryImages = images.filter(img => img.category_id == currentCategoryId);
                if (categoryImages.length > 0) {
                    sortBtn.style.display = 'inline-block';
                } else {
                    sortBtn.style.display = 'none';
                }
            } else {
                sortBtn.style.display = 'none';
            }
        }
        
        // åœ¨selectCategoryå’ŒfilterImagesByCategoryå‡½æ•°ä¸­è°ƒç”¨ï¼ˆå¦‚æœupdateSortButtonVisibilityå‡½æ•°å­˜åœ¨ï¼‰
        if (typeof updateSortButtonVisibility === 'function' && typeof selectCategory === 'function') {
            const originalSelectCategory = selectCategory;
            selectCategory = function(categoryId) {
                originalSelectCategory(categoryId);
                updateSortButtonVisibility();
            };
        }
        
        if (typeof updateSortButtonVisibility === 'function' && typeof filterImagesByCategory === 'function') {
            const originalFilterImagesByCategory = filterImagesByCategory;
            filterImagesByCategory = function(categoryId) {
                originalFilterImagesByCategory(categoryId);
                updateSortButtonVisibility();
            };
        }
    </script>
</body>
</html>