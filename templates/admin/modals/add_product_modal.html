<!-- 添加产品模态框 -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加新产品</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                <form method="POST" action="{{ url_for('admin_products.admin_sizes') }}" enctype="multipart/form-data" id="productForm">
                    <input type="hidden" name="action" value="add_product_with_sizes">
                    <input type="hidden" name="product_id" id="productId" value="">
                    
                    <!-- 基本信息 -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">产品代码 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="code" id="productCode" required placeholder="如: keychain">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">产品名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" id="productName" required placeholder="如: 艺术钥匙扣">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">产品描述</label>
                            <input type="text" class="form-control" name="description" id="productDescription" placeholder="如: 精美钥匙扣定制">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">排序顺序</label>
                            <input type="number" class="form-control" name="sort_order" id="productSortOrder" value="0" min="0">
                        </div>
                    </div>
                    
                    <!-- 产品分类选择（自动填充） -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">一级分类 <span class="text-danger">*</span></label>
                            <select class="form-control" name="category_id" id="add_category_select" onchange="updateAddSubcategories(); updateEditSubcategories(this.value);" required>
                                <option value="">-- 请选择一级分类 --</option>
                                {% for category in product_categories %}
                                <option value="{{ category.id }}">
                                    {% if category.icon %}{{ category.icon }} {% endif %}{{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">二级分类（可选）</label>
                            <select class="form-control" name="subcategory_id" id="add_subcategory_select">
                                <option value="">-- 请选择二级分类 --</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 其他配置 -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">选片赠送张数</label>
                            <input type="number" class="form-control" name="free_selection_count" id="productFreeSelectionCount" value="1" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">每加一张照片价格</label>
                            <input type="number" class="form-control" name="extra_photo_price" id="productExtraPhotoPrice" value="10.0" min="0" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">上架状态</label>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="is_active" id="productIsActive" checked>
                                <label class="form-check-label" for="productIsActive">上架</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 产品图片上传 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">主图（留空则不更新）</label>
                            <input type="file" class="form-control" name="product_image" accept="image/*">
                            <div id="editMainImagePreview" class="mt-2"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">多图上传（追加新图片）</label>
                            <input type="file" class="form-control" name="product_images[]" accept="image/*" multiple>
                            <div id="editImagesPreview" class="mt-2"></div>
                        </div>
                    </div>
                    
                    <!-- 风格分类绑定 -->
                    <div class="mb-3">
                        <label><i class="fas fa-palette"></i> 绑定风格分类</label>
                        <div class="row">
                            {% for category in style_categories %}
                            <div class="col-md-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="style_category_ids[]" value="{{ category.id }}" id="style_cat_new_{{ category.id }}">
                                    <label class="form-check-label" for="style_cat_new_{{ category.id }}">
                                        {{ category.name }} {% if category.icon %}{{ category.icon }}{% endif %}
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- 尺寸规格 -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label><i class="fas fa-ruler"></i> 尺寸规格</label>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addSizeInModal()">+ 添加尺寸</button>
                        </div>
                        <div id="sizesContainer">
                            <div class="size-input-group border rounded p-3 mb-3">
                                <input type="hidden" name="existing_size_id[]" value="">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label small">尺寸名称 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" name="size_name[]" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">价格 <span class="text-danger">*</span></label>
                                        <input type="number" step="0.01" class="form-control" name="size_price[]" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">厂家ID</label>
                                        <input type="text" class="form-control" name="size_printer_id[]">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">效果图（小程序展示）</label>
                                        <input type="file" class="form-control form-control-sm" name="size_effect_image[]" accept="image/*" onchange="handleSizeEffectImageChange(this)">
                                        <input type="hidden" name="size_effect_image_url[]" value="">
                                        <div class="size-effect-image-preview mt-1"></div>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label small">&nbsp;</label>
                                        <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeSizeInModal(this)">删除</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 自定义字段 -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label><i class="fas fa-tags"></i> 自定义字段（如：颜色等）</label>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addCustomFieldInModal()">+ 添加字段</button>
                        </div>
                        <div id="customFieldsContainer"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitProductForm()">保存产品</button>
            </div>
        </div>
    </div>
</div>
