<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ brand_name }} - Playground</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        /* å¯¼èˆªæ  */
        .navbar-custom {
            background: rgba(0,0,0,0.3) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .navbar-brand {
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8) !important;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover {
            color: #fff !important;
        }
        
        /* ä¸»å®¹å™¨ */
        .playground-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 40px;
        }
        
        .playground-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .playground-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .playground-header p {
            color: rgba(255,255,255,0.7);
            font-size: 1.1rem;
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .playground-content {
            display: grid;
            grid-template-columns: 250px 1fr 400px;
            gap: 20px;
            margin-top: 30px;
        }
        
        /* å·¦ä¾§æ ‡ç­¾é¡µ */
        .mode-tabs {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .mode-tab {
            display: block;
            padding: 15px 20px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .mode-tab:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
            transform: translateX(5px);
        }
        
        .mode-tab.active {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: #fff;
            border-color: transparent;
        }
        
        /* ä¸­é—´ä¸Šä¼ åŒºåŸŸ */
        .upload-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .upload-area {
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.02);
            position: relative;
            min-height: 120px;
        }
        
        .upload-area.has-images {
            padding: 12px;
            min-height: auto;
        }
        
        .upload-area:hover {
            border-color: #4ecdc4;
            background: rgba(255,255,255,0.05);
        }
        
        .upload-area.dragover {
            border-color: #ff6b6b;
            background: rgba(255,107,107,0.1);
        }
        
        .upload-area-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .upload-area.has-images .upload-area-content {
            display: none;
        }
        
        .upload-icon {
            font-size: 2rem;
            color: rgba(255,255,255,0.5);
            margin-bottom: 8px;
        }
        
        .upload-text {
            color: rgba(255,255,255,0.8);
            font-size: 0.95rem;
            margin-bottom: 5px;
        }
        
        .upload-hint {
            color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
        }
        
        .uploaded-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            width: 100%;
        }
        
        .uploaded-image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            border: 2px solid rgba(255,255,255,0.2);
            transition: transform 0.2s ease;
        }
        
        .uploaded-image-item:hover {
            transform: scale(1.05);
            border-color: #4ecdc4;
        }
        
        .uploaded-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .uploaded-image-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,0,0,0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .uploaded-image-item .remove-btn:hover {
            background: rgba(255,0,0,1);
            transform: scale(1.1);
        }
        
        /* å½“æœ‰å›¾ç‰‡æ—¶ï¼Œæ˜¾ç¤ºæ·»åŠ æ›´å¤šå›¾ç‰‡çš„æç¤º */
        .upload-area.has-images::after {
            content: 'ç‚¹å‡»æˆ–æ‹–æ‹½æ·»åŠ æ›´å¤šå›¾ç‰‡';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.4);
            font-size: 0.75rem;
            pointer-events: none;
        }
        
        /* APIæœåŠ¡å•†é€‰æ‹©ï¼ˆä»…APIç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰ */
        .api-provider-selector {
            margin-bottom: 12px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .api-provider-selector label {
            display: block;
            margin-bottom: 6px;
            color: rgba(255,255,255,0.8);
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .api-provider-selector select {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
        }
        
        .api-provider-selector select option {
            background: #1a1a1a !important;
            color: #fff !important;
        }
        
        /* APIé…ç½®è¡¨å•ï¼ˆä»…APIç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰ */
        .api-config-form {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .api-config-form h4 {
            margin-bottom: 12px;
            color: rgba(255,255,255,0.9);
            font-size: 1rem;
        }
        
        .api-config-form .form-group {
            margin-bottom: 10px;
        }
        
        .api-config-form label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }
        
        .api-config-form input,
        .api-config-form select,
        .api-config-form textarea {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
        }
        
        .api-config-form select option {
            background: #1a1a1a !important;
            color: #fff !important;
        }
        
        /* å…¨å±€ä¸‹æ‹‰èœå•é€‰é¡¹æ ·å¼ï¼ˆè¦†ç›–Bootstrapé»˜è®¤æ ·å¼ï¼‰ */
        select option {
            background: #1a1a1a !important;
            color: #fff !important;
            padding: 8px 12px;
        }
        
        /* ä¸‹æ‹‰èœå•æ‰“å¼€æ—¶çš„æ ·å¼ */
        select:focus {
            background: rgba(255,255,255,0.15) !important;
            border-color: #4ecdc4 !important;
        }
        
        /* ç¡®ä¿æ‰€æœ‰selectå…ƒç´ éƒ½æœ‰æ­£ç¡®çš„æ ·å¼ */
        select {
            background-color: rgba(255,255,255,0.1) !important;
            color: #fff !important;
        }
        
        select::-ms-expand {
            display: none; /* éšè—IE/Edgeçš„é»˜è®¤ä¸‹æ‹‰ç®­å¤´ */
        }
        
        /* é’ˆå¯¹ä¸åŒæµè§ˆå™¨çš„ä¸‹æ‹‰èœå•æ ·å¼ */
        select option:checked {
            background: #4ecdc4 !important;
            color: #fff !important;
        }
        
        select option:hover {
            background: #2a2a2a !important;
        }
        
        .api-config-form input::placeholder,
        .api-config-form textarea::placeholder {
            color: rgba(255,255,255,0.4);
        }
        
        .api-config-form textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .api-config-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .api-config-form .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* å³ä¾§æ¨¡æ¿åˆ—è¡¨ */
        .templates-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .templates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .templates-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .batch-mode-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .template-card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            aspect-ratio: 1;
        }
        
        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        .template-card.selected {
            border-color: #4ecdc4;
            box-shadow: 0 0 20px rgba(78,205,196,0.5);
        }
        
        .template-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .template-card .template-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 10px 10px 35px 10px;
            font-size: 0.85rem;
            text-align: center;
            color: #fff;
        }
        
        .template-card .template-tags {
            position: absolute;
            bottom: 5px;
            left: 5px;
            right: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }
        
        .template-card .workflow-tag {
            background: #4ecdc4;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .template-card .select-checkbox {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            background: rgba(78,205,196,0.9);
            border: 2px solid #fff;
            border-radius: 4px;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .template-card.selected .select-checkbox {
            display: flex;
        }
        
        /* ç”ŸæˆæŒ‰é’®åŒºåŸŸ */
        .generate-section {
            margin-top: 15px;
            text-align: center;
        }
        
        .generate-btn {
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            border-radius: 25px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }
        
        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ç»“æœå±•ç¤ºåŒºåŸŸ */
        .results-section {
            margin-top: 30px;
            display: none;
        }
        
        .results-section.show {
            display: block;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .result-item {
            border-radius: 8px;
            overflow: hidden;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .result-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.7);
        }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid #4ecdc4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .playground-content {
                grid-template-columns: 200px 1fr 350px;
            }
        }
        
        @media (max-width: 992px) {
            .playground-content {
                grid-template-columns: 1fr;
            }
            
            .mode-tabs {
                display: flex;
                gap: 10px;
                overflow-x: auto;
            }
            
            .mode-tab {
                white-space: nowrap;
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">{{ brand_name }}</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/playground">ğŸ® Playground</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/playground/tasks">ğŸ“‹ ä»»åŠ¡æ—¥å¿—</a>
                    </li>
                    {% if current_user and current_user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/profile">
                            <i class="fas fa-user"></i> {{ current_user.username }}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">é€€å‡º</a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="/login">å•†å®¶å…¥å£</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="playground-container">
        <div class="playground-header">
            <h1>ğŸ® Playground</h1>
            <p>AIå·¥ä½œæµæµ‹è¯•å¹³å° - ç‹¬ç«‹æµ‹è¯•é£æ ¼æ¨¡æ¿</p>
        </div>

        <div class="playground-content">
            <!-- å·¦ä¾§æ ‡ç­¾é¡µ -->
            <div class="mode-tabs">
                <a href="#" class="mode-tab active" data-mode="workflow">
                    <i class="fas fa-project-diagram"></i> AIå·¥ä½œæµ
                </a>
                <a href="#" class="mode-tab" data-mode="api">
                    <i class="fas fa-code"></i> APIç¼–è¾‘
                </a>
                <a href="#" class="mode-tab" data-mode="comfyui">
                    <i class="fas fa-cogs"></i> ComfyUIå·¥ä½œæµ
                </a>
            </div>

            <!-- ä¸­é—´ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section">
                <!-- APIæœåŠ¡å•†é€‰æ‹©ï¼ˆä»…APIç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
                <div class="api-provider-selector" id="apiProviderSelector" style="display: none;">
                    <label for="apiProviderSelect">é€‰æ‹©APIæœåŠ¡å•†</label>
                    <select id="apiProviderSelect" class="form-control">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>

                <!-- APIé…ç½®è¡¨å•ï¼ˆä»…APIç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
                <div class="api-config-form" id="apiConfigForm" style="display: none;">
                    <h4>æ‰‹åŠ¨é…ç½®å‚æ•°</h4>
                    <!-- é¢„è®¾å›¾ç‰‡åŒºåŸŸï¼ˆå¦‚æœæœ‰å¤šä¸ªä¸Šä¼ å…¥å£ï¼‰ -->
                    <div id="presetImagesSection" style="display: none; margin-bottom: 20px;">
                        <h5 style="color: rgba(255,255,255,0.8); margin-bottom: 15px; font-size: 1rem;">é¢„è®¾å›¾ç‰‡</h5>
                        <div id="presetImagesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px;"></div>
                    </div>
                    <div class="form-group">
                        <label for="apiPrompt">æç¤ºè¯</label>
                        <textarea id="apiPrompt" placeholder="è¾“å…¥æç¤ºè¯ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸é€‰æ‹©æ¨¡æ¿åˆ™å¿…å¡«ï¼‰" rows="2"></textarea>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label for="apiSize">å°ºå¯¸</label>
                            <select id="apiSize">
                                <option value="1K">1K</option>
                                <option value="2K">2K</option>
                                <option value="4K" selected>4K</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="apiAspectRatio">æ¯”ä¾‹</label>
                            <select id="apiAspectRatio">
                                <option value="auto">è‡ªåŠ¨</option>
                                <option value="1:1">1:1</option>
                                <option value="16:9">16:9</option>
                                <option value="9:16">9:16</option>
                                <option value="2:3" selected>2:3</option>
                                <option value="3:2">3:2</option>
                                <option value="4:3">4:3</option>
                                <option value="3:4">3:4</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-area" id="uploadArea">
                    <div class="upload-area-content">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
                        <div class="upload-hint">æ”¯æŒ JPGã€JPEGã€PNGã€WEBP æ ¼å¼ï¼Œæ”¯æŒå•å›¾æˆ–å¤šå›¾</div>
                    </div>
                    <!-- å·²ä¸Šä¼ å›¾ç‰‡é¢„è§ˆï¼ˆæ˜¾ç¤ºåœ¨ä¸Šä¼ åŒºåŸŸå†…ï¼‰ -->
                    <div class="uploaded-images" id="uploadedImages"></div>
                    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                </div>

                <!-- ç”ŸæˆæŒ‰é’® -->
                <div class="generate-section">
                    <button class="generate-btn" id="generateBtn" disabled>
                        <i class="fas fa-magic"></i> ç”Ÿæˆå›¾ç‰‡
                    </button>
                </div>

                <!-- ç»“æœå±•ç¤º -->
                <div class="results-section" id="resultsSection">
                    <h4 style="margin-bottom: 20px;">ç”Ÿæˆç»“æœ</h4>
                    <div class="results-grid" id="resultsGrid"></div>
                </div>

                <!-- åŠ è½½çŠ¶æ€ -->
                <div class="loading" id="loadingSection" style="display: none;">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...</p>
                </div>
            </div>

            <!-- å³ä¾§æ¨¡æ¿åˆ—è¡¨ -->
            <div class="templates-section">
                <div class="templates-header">
                    <h3>æ¨¡æ¿åˆ—è¡¨</h3>
                    <div class="batch-mode-toggle">
                        <label style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                            <input type="checkbox" id="batchModeToggle" style="margin-right: 5px;">
                            æ‰¹é‡æ¨¡å¼
                        </label>
                    </div>
                </div>
                <div class="templates-grid" id="templatesGrid">
                    <div class="text-center" style="color: rgba(255,255,255,0.5); padding: 40px;">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>åŠ è½½æ¨¡æ¿ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    {% include 'admin/_ux_scripts.html' %}
    <script>
        // å…¨å±€çŠ¶æ€
        let currentMode = 'workflow';
        let templates = { workflow: [], api: [], comfyui: [] };
        let selectedTemplates = [];
        let uploadedImages = [];
        let apiProviders = [];
        let batchMode = false;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initEventListeners();
            loadTemplates();
            loadApiProviders();
        });

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEventListeners() {
            // æ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    const mode = this.dataset.mode;
                    switchMode(mode);
                });
            });

            // æ–‡ä»¶ä¸Šä¼ 
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);

            // æ‰¹é‡æ¨¡å¼åˆ‡æ¢
            document.getElementById('batchModeToggle').addEventListener('change', function() {
                batchMode = this.checked;
                updateTemplatesDisplay();
            });

            // ç”ŸæˆæŒ‰é’®
            document.getElementById('generateBtn').addEventListener('click', handleGenerate);
            
            // APIé…ç½®è¡¨å•è¾“å…¥ç›‘å¬ï¼ˆç”¨äºæ›´æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€ï¼‰
            if (document.getElementById('apiPrompt')) {
                document.getElementById('apiPrompt').addEventListener('input', updateGenerateButton);
                document.getElementById('apiSize').addEventListener('change', updateGenerateButton);
                document.getElementById('apiAspectRatio').addEventListener('change', updateGenerateButton);
                document.getElementById('apiProviderSelect').addEventListener('change', updateGenerateButton);
            }
        }

        // åˆ‡æ¢æ¨¡å¼
        function switchMode(mode) {
            currentMode = mode;
            
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.mode === mode) {
                    tab.classList.add('active');
                }
            });

            // æ˜¾ç¤º/éšè—APIæœåŠ¡å•†é€‰æ‹©å™¨å’Œé…ç½®è¡¨å•
            const apiProviderSelector = document.getElementById('apiProviderSelector');
            const apiConfigForm = document.getElementById('apiConfigForm');
            if (mode === 'api') {
                apiProviderSelector.style.display = 'block';
                apiConfigForm.style.display = 'block';
            } else {
                apiProviderSelector.style.display = 'none';
                apiConfigForm.style.display = 'none';
            }

            // æ¸…ç©ºé€‰æ‹©
            selectedTemplates = [];
            updateTemplatesDisplay();
            updateApiConfigForm();
        }
        
        // å­˜å‚¨å½“å‰æ¨¡æ¿çš„ä¸Šä¼ é…ç½®
        let currentUploadConfig = null;
        
        // æ›´æ–°APIé…ç½®è¡¨å•ï¼ˆæ ¹æ®é€‰ä¸­çš„æ¨¡æ¿åŠ è½½é…ç½®ï¼‰
        async function updateApiConfigForm() {
            if (currentMode !== 'api') return;
            
            const promptInput = document.getElementById('apiPrompt');
            const sizeInput = document.getElementById('apiSize');
            const aspectRatioInput = document.getElementById('apiAspectRatio');
            const presetImagesSection = document.getElementById('presetImagesSection');
            const presetImagesList = document.getElementById('presetImagesList');
            
            // é‡ç½®é¢„è®¾å›¾ç‰‡
            currentUploadConfig = null;
            presetImagesSection.style.display = 'none';
            presetImagesList.innerHTML = '';
            
            // å¦‚æœé€‰æ‹©äº†æ¨¡æ¿ï¼Œå°è¯•åŠ è½½æ¨¡æ¿é…ç½®
            if (selectedTemplates.length > 0) {
                const templateId = selectedTemplates[0];
                try {
                    // ä»å·²åŠ è½½çš„æ¨¡æ¿æ•°æ®ä¸­è·å–upload_config
                    const currentTemplates = templates[currentMode] || [];
                    const template = currentTemplates.find(t => t.id === templateId);
                    
                    if (template && template.api_template_info && template.api_template_info.upload_config) {
                        currentUploadConfig = template.api_template_info.upload_config;
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªä¸Šä¼ å…¥å£ä¸”é…ç½®äº†é¢„è®¾å›¾ç‰‡ï¼ˆå…¼å®¹æ—§çš„example_imageå­—æ®µåï¼‰
                        if (currentUploadConfig && currentUploadConfig.uploads && currentUploadConfig.uploads.length > 0) {
                            const hasPresetImages = currentUploadConfig.uploads.some(upload => upload.preset_image || upload.example_image);
                            
                            if (hasPresetImages) {
                                // æ˜¾ç¤ºé¢„è®¾å›¾ç‰‡
                                presetImagesSection.style.display = 'block';
                                presetImagesList.innerHTML = currentUploadConfig.uploads.map((upload, index) => {
                                    const presetImageUrl = upload.preset_image || upload.example_image;
                                    if (presetImageUrl) {
                                        return `
                                            <div class="preset-image-item" style="position: relative; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; overflow: hidden; background: rgba(255,255,255,0.05);">
                                                <img src="${presetImageUrl}" alt="${upload.name || upload.key}" 
                                                     style="width: 100%; height: 120px; object-fit: cover; display: block;"
                                                     onerror="this.src='/static/images/placeholder.png'">
                                                <div style="padding: 8px; text-align: center; color: rgba(255,255,255,0.8); font-size: 0.85rem;">
                                                    ${upload.name || upload.key}
                                                </div>
                                            </div>
                                        `;
                                    }
                                    return '';
                                }).filter(html => html).join('');
                            }
                        }
                    }
                    
                    // åŠ è½½æ¨¡æ¿çš„å…¶ä»–é…ç½®ï¼ˆæç¤ºè¯ã€å°ºå¯¸ã€æ¯”ä¾‹ï¼‰
                    const response = await fetch(`/api/admin/styles/images/${templateId}/api-template`);
                    const result = await response.json();
                    
                    if (result.status === 'success' && result.data) {
                        const template = result.data;
                        // å¡«å……è¡¨å•ï¼ˆå¦‚æœæ¨¡æ¿æœ‰é…ç½®ï¼‰
                        if (template.default_prompt) {
                            promptInput.value = template.default_prompt;
                        }
                        if (template.default_size) {
                            sizeInput.value = template.default_size;
                        }
                        if (template.default_aspect_ratio) {
                            aspectRatioInput.value = template.default_aspect_ratio;
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½æ¨¡æ¿é…ç½®å¤±è´¥:', error);
                }
            } else {
                // æœªé€‰æ‹©æ¨¡æ¿ï¼Œæ¸…ç©ºè¡¨å•ï¼ˆç”¨æˆ·å¯ä»¥æ‰‹åŠ¨è¾“å…¥ï¼‰
                // ä¿ç•™é»˜è®¤å€¼
            }
        }

        // åŠ è½½æ¨¡æ¿åˆ—è¡¨
        async function loadTemplates() {
            try {
                const response = await fetch(`/api/playground/templates?mode=all`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    templates = result.data;
                    updateTemplatesDisplay();
                } else {
                    showError('åŠ è½½æ¨¡æ¿å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
                showError('åŠ è½½æ¨¡æ¿å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // åŠ è½½APIæœåŠ¡å•†åˆ—è¡¨
        async function loadApiProviders() {
            try {
                const response = await fetch('/api/playground/api-providers');
                const result = await response.json();
                
                if (result.status === 'success') {
                    apiProviders = result.data;
                    const select = document.getElementById('apiProviderSelect');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©æœåŠ¡å•†</option>';
                    apiProviders.forEach(provider => {
                        const option = document.createElement('option');
                        option.value = provider.id;
                        option.textContent = provider.name + (provider.is_default ? ' (é»˜è®¤)' : '');
                        if (provider.is_default) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½APIæœåŠ¡å•†å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æ¨¡æ¿æ˜¾ç¤º
        function updateTemplatesDisplay() {
            const grid = document.getElementById('templatesGrid');
            const currentTemplates = templates[currentMode] || [];
            
            if (currentTemplates.length === 0) {
                grid.innerHTML = '<div class="text-center" style="color: rgba(255,255,255,0.5); padding: 40px;">æš‚æ— å¯ç”¨æ¨¡æ¿</div>';
                return;
            }

            grid.innerHTML = currentTemplates.map(template => {
                // æ ¹æ®å½“å‰æ¨¡å¼ç”Ÿæˆå¯¹åº”çš„æ ‡ç­¾
                let tagsHtml = '';
                if (currentMode === 'workflow' && template.has_workflow) {
                    tagsHtml = '<span class="workflow-tag">AIå·¥ä½œæµ</span>';
                } else if (currentMode === 'api' && template.has_api) {
                    tagsHtml = '<span class="workflow-tag">APIç¼–è¾‘</span>';
                } else if (currentMode === 'comfyui' && template.has_comfyui) {
                    tagsHtml = '<span class="workflow-tag">API-ComfyUIå·¥ä½œæµ</span>';
                } else if (template.workflow_tags && template.workflow_tags.length > 0) {
                    // å…¼å®¹ï¼šå¦‚æœæœ‰workflow_tagsï¼Œæ ¹æ®å½“å‰æ¨¡å¼è¿‡æ»¤
                    const modeTagMap = {
                        'workflow': 'AIå·¥ä½œæµ',
                        'api': 'APIç¼–è¾‘',
                        'comfyui': 'API-ComfyUIå·¥ä½œæµ'
                    };
                    const currentModeTag = modeTagMap[currentMode];
                    const filteredTags = template.workflow_tags.filter(tag => tag === currentModeTag);
                    if (filteredTags.length > 0) {
                        tagsHtml = filteredTags.map(tag => 
                            `<span class="workflow-tag">${tag}</span>`
                        ).join('');
                    }
                }
                
                return `
                <div class="template-card ${selectedTemplates.includes(template.id) ? 'selected' : ''}" 
                     data-template-id="${template.id}"
                     onclick="toggleTemplate(${template.id})">
                    <img src="${template.image_url}" alt="${template.name}" onerror="this.src='/static/images/placeholder.png'">
                    <div class="template-name">${template.name}</div>
                    ${tagsHtml ? `<div class="template-tags">${tagsHtml}</div>` : ''}
                    ${batchMode ? '<div class="select-checkbox"><i class="fas fa-check"></i></div>' : ''}
                </div>
            `;
            }).join('');
        }

        // åˆ‡æ¢æ¨¡æ¿é€‰æ‹©
        function toggleTemplate(templateId) {
            if (batchMode) {
                // æ‰¹é‡æ¨¡å¼ï¼šå¤šé€‰
                const index = selectedTemplates.indexOf(templateId);
                if (index > -1) {
                    selectedTemplates.splice(index, 1);
                } else {
                    selectedTemplates.push(templateId);
                }
            } else {
                // å•é€‰æ¨¡å¼ï¼šç‚¹å‡»å·²é€‰ä¸­çš„æ¨¡æ¿åˆ™å–æ¶ˆé€‰æ‹©
                if (selectedTemplates.includes(templateId)) {
                    selectedTemplates = [];
                } else {
                    selectedTemplates = [templateId];
                }
            }
            updateTemplatesDisplay();
            updateGenerateButton();
            updateApiConfigForm();
        }

        // æ›´æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€
        function updateGenerateButton() {
            const btn = document.getElementById('generateBtn');
            
            if (uploadedImages.length === 0) {
                btn.disabled = true;
                return;
            }
            
            // APIç¼–è¾‘æ¨¡å¼ï¼šå…è®¸ä¸é€‰æ‹©æ¨¡æ¿ï¼ˆä½¿ç”¨æ‰‹åŠ¨é…ç½®ï¼‰
            if (currentMode === 'api') {
                // å¦‚æœé€‰æ‹©äº†æ¨¡æ¿ï¼Œæˆ–è€…æœ‰æç¤ºè¯å’ŒæœåŠ¡å•†ï¼Œéƒ½å¯ä»¥ç”Ÿæˆ
                const hasTemplate = selectedTemplates.length > 0;
                const hasManualConfig = document.getElementById('apiPrompt').value.trim() && 
                                       document.getElementById('apiProviderSelect').value;
                btn.disabled = !(hasTemplate || hasManualConfig);
            } else {
                // å…¶ä»–æ¨¡å¼ï¼šå¿…é¡»é€‰æ‹©æ¨¡æ¿
                btn.disabled = selectedTemplates.length === 0;
            }
        }

        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files).filter(file => file.type.startsWith('image/'));
            handleFiles(files);
        }

        async function handleFiles(files) {
            if (files.length === 0) return;

            const formData = new FormData();
            files.forEach(file => {
                formData.append('images[]', file);
            });

            try {
                const response = await fetch('/api/playground/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    const uploaded = Array.isArray(result.data) ? result.data : [result.data];
                    uploaded.forEach(item => {
                        uploadedImages.push(item.url);
                    });
                    displayUploadedImages();
                    updateGenerateButton();
                } else {
                    showError('ä¸Šä¼ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showError('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºå·²ä¸Šä¼ å›¾ç‰‡
        function displayUploadedImages() {
            const container = document.getElementById('uploadedImages');
            const uploadArea = document.getElementById('uploadArea');
            
            if (uploadedImages.length === 0) {
                container.innerHTML = '';
                uploadArea.classList.remove('has-images');
                return;
            }
            
            uploadArea.classList.add('has-images');
            container.innerHTML = uploadedImages.map((url, index) => `
                <div class="uploaded-image-item">
                    <img src="${url}" alt="ä¸Šä¼ çš„å›¾ç‰‡ ${index + 1}">
                    <button class="remove-btn" onclick="removeImage(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // ç§»é™¤å›¾ç‰‡
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            displayUploadedImages();
            updateGenerateButton();
        }

        // ç”Ÿæˆå›¾ç‰‡
        async function handleGenerate() {
            if (uploadedImages.length === 0) {
                showError('è¯·ä¸Šä¼ å›¾ç‰‡');
                return;
            }
            
            // APIç¼–è¾‘æ¨¡å¼ï¼šå…è®¸ä¸é€‰æ‹©æ¨¡æ¿ï¼Œä½¿ç”¨æ‰‹åŠ¨é…ç½®
            if (currentMode === 'api') {
                if (selectedTemplates.length === 0) {
                    const prompt = document.getElementById('apiPrompt').value.trim();
                    const providerId = document.getElementById('apiProviderSelect').value;
                    
                    if (!prompt) {
                        showError('è¯·é€‰æ‹©æ¨¡æ¿æˆ–è¾“å…¥æç¤ºè¯');
                        return;
                    }
                    if (!providerId) {
                        showError('è¯·é€‰æ‹©APIæœåŠ¡å•†');
                        return;
                    }
                }
            } else {
                // å…¶ä»–æ¨¡å¼ï¼šå¿…é¡»é€‰æ‹©æ¨¡æ¿
                if (selectedTemplates.length === 0) {
                    showError('è¯·é€‰æ‹©æ¨¡æ¿');
                    return;
                }
            }

            const loadingSection = document.getElementById('loadingSection');
            const resultsSection = document.getElementById('resultsSection');
            const generateBtn = document.getElementById('generateBtn');

            loadingSection.style.display = 'block';
            resultsSection.classList.remove('show');
            generateBtn.disabled = true;

            try {
                let tasks = [];
                
                if (currentMode === 'api' && selectedTemplates.length === 0) {
                    // APIç¼–è¾‘æ¨¡å¼ä¸”æœªé€‰æ‹©æ¨¡æ¿ï¼šä½¿ç”¨æ‰‹åŠ¨é…ç½®ï¼ˆtemplateIdè®¾ä¸ºnullï¼‰
                    tasks = [generateSingleTemplate(null)];
                } else {
                    // æ‰¹é‡æ¨¡å¼æˆ–é€‰æ‹©äº†æ¨¡æ¿ï¼šä¾æ¬¡å¤„ç†æ¯ä¸ªæ¨¡æ¿
                    tasks = selectedTemplates.map(templateId => {
                        return generateSingleTemplate(templateId);
                    });
                }

                const results = await Promise.all(tasks);
                
                // æ˜¾ç¤ºç»“æœ
                displayResults(results);
                
            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                showError('ç”Ÿæˆå¤±è´¥: ' + error.message);
            } finally {
                loadingSection.style.display = 'none';
                generateBtn.disabled = false;
            }
        }

        // ç”Ÿæˆå•ä¸ªæ¨¡æ¿
        async function generateSingleTemplate(templateId) {
            let endpoint;
            let formData = new FormData();
            
            // æ ¹æ®ä¸åŒæ¨¡å¼å‡†å¤‡æ•°æ®å’Œendpoint
            if (currentMode === 'workflow') {
                // å·¥ä½œæµæ¨¡å¼ï¼šç›´æ¥å¤ç”¨é£æ ¼åˆ†ç±»çš„æµ‹è¯•å·¥ä½œæµAPI
                if (!templateId || templateId === 0) {
                    throw new Error('è¯·é€‰æ‹©æ¨¡æ¿');
                }
                const imageId = parseInt(templateId);
                endpoint = `/api/admin/styles/test-workflow/${imageId}`;
                const imageData = await prepareImageData();
                
                // ä»æ¨¡æ¿æ•°æ®ä¸­è·å–å·¥ä½œæµé…ç½®ï¼ˆä¸é£æ ¼åˆ†ç±»ç®¡ç†é¡µé¢ä¿æŒä¸€è‡´ï¼‰
                const currentTemplates = templates[currentMode] || [];
                const template = currentTemplates.find(t => t.id === imageId);
                
                let requestData = {
                    image_data: imageData
                };
                
                // å¦‚æœæ¨¡æ¿æœ‰å·¥ä½œæµé…ç½®ï¼Œä¼ é€’ç»™åç«¯ï¼ˆä¸é£æ ¼åˆ†ç±»ç®¡ç†é¡µé¢ä¿æŒä¸€è‡´ï¼‰
                if (template && template.workflow_config) {
                    requestData.workflow_config = template.workflow_config;
                    console.log('ğŸ” [Playground] ä½¿ç”¨æ¨¡æ¿çš„å·¥ä½œæµé…ç½®:', template.workflow_config);
                } else {
                    console.log('âš ï¸ [Playground] æ¨¡æ¿æ²¡æœ‰å·¥ä½œæµé…ç½®ï¼Œåç«¯å°†ä»æ•°æ®åº“è·å–');
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { message: errorText };
                    }
                    throw new Error(errorData.message || `HTTPé”™è¯¯: ${response.status}`);
                }
                
                return await response.json();
            } else if (currentMode === 'api') {
                // APIæ¨¡å¼ï¼šä½¿ç”¨FormDataï¼Œå¤ç”¨é£æ ¼åˆ†ç±»ç®¡ç†é¡µé¢çš„é€»è¾‘
                // ç¡®å®šimage_idï¼šå¦‚æœé€‰æ‹©äº†æ¨¡æ¿ï¼Œä½¿ç”¨æ¨¡æ¿çš„image_idï¼›å¦åˆ™éœ€è¦åç«¯æŸ¥æ‰¾
                let imageId = null;
                if (templateId !== null && templateId !== undefined && templateId !== 0) {
                    imageId = parseInt(templateId);
                }
                
                // å¦‚æœæ‰‹åŠ¨æ¨¡å¼ï¼ˆæ²¡æœ‰templateIdï¼‰ï¼Œå…ˆè·å–ä¸€ä¸ªå¯ç”¨çš„image_id
                if (!imageId) {
                    // æ‰‹åŠ¨æ¨¡å¼ï¼šéœ€è¦å…ˆæ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„æ¨¡æ¿æ¥è·å–image_id
                    // è¿™é‡Œæˆ‘ä»¬é€šè¿‡åç«¯APIæ¥è·å–
                    const providerId = document.getElementById('apiProviderSelect').value;
                    if (!providerId) {
                        throw new Error('è¯·é€‰æ‹©APIæœåŠ¡å•†');
                    }
                    
                    // è°ƒç”¨åç«¯è·å–å¯ç”¨çš„image_id
                    const findTemplateResponse = await fetch('/api/playground/find-template', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            api_config_id: parseInt(providerId)
                        })
                    });
                    
                    if (!findTemplateResponse.ok) {
                        throw new Error('æœªæ‰¾åˆ°å¯ç”¨çš„æ¨¡æ¿é…ç½®');
                    }
                    
                    const findResult = await findTemplateResponse.json();
                    if (findResult.status !== 'success' || !findResult.data || !findResult.data.image_id) {
                        throw new Error('æœªæ‰¾åˆ°å¯ç”¨çš„æ¨¡æ¿é…ç½®ï¼Œè¯·å…ˆé…ç½®ä¸€ä¸ªAPIæ¨¡æ¿');
                    }
                    
                    imageId = findResult.data.image_id;
                }
                
                endpoint = `/api/admin/styles/images/${imageId}/test-api`;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¼ é…ç½®å’Œé¢„è®¾å›¾ç‰‡
                let uploadConfig = null;
                if (currentUploadConfig && currentUploadConfig.uploads && currentUploadConfig.uploads.length > 0) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰é¢„è®¾å›¾ç‰‡
                    const hasPresetImages = currentUploadConfig.uploads.some(upload => upload.preset_image);
                    
                    if (hasPresetImages) {
                        console.log('ğŸ” [Playground] æ£€æµ‹åˆ°é¢„è®¾å›¾ç‰‡ï¼Œå¼€å§‹å¤„ç†...');
                        console.log('ğŸ” [Playground] ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æ•°é‡:', uploadedImages.length);
                        console.log('ğŸ” [Playground] ä¸Šä¼ é…ç½®:', currentUploadConfig);
                        
                        // æ„å»ºä¸Šä¼ é…ç½®ï¼Œå›¾ç‰‡é¡ºåºï¼šç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡åœ¨å‰ï¼Œé¢„è®¾å›¾ç‰‡åœ¨å
                        // å…ˆå¤„ç†é¢„è®¾å›¾ç‰‡ï¼šå¦‚æœæ˜¯æœ¬åœ°è·¯å¾„ï¼Œéœ€è¦ä¸Šä¼ åˆ°äº‘ç«¯è·å–URL
                        const processedPresetImages = await Promise.all(
                            currentUploadConfig.uploads.map(async (upload) => {
                                const presetImageUrl = upload.preset_image || upload.example_image;
                                if (!presetImageUrl) {
                                    console.log(`âš ï¸ [Playground] ä¸Šä¼ å…¥å£ "${upload.name || upload.key}" æ²¡æœ‰é¢„è®¾å›¾ç‰‡`);
                                    return upload; // è¿”å›åŸå§‹uploadå¯¹è±¡ï¼Œä¸è¿”å›null
                                }
                                
                                console.log(`ğŸ” [Playground] å¤„ç†é¢„è®¾å›¾ç‰‡: ${upload.name || upload.key} = ${presetImageUrl}`);
                                
                                // æ£€æŸ¥æ˜¯å¦æ˜¯æœ¬åœ°è·¯å¾„ï¼ˆ/media/original/ æˆ– /uploads/ï¼‰
                                const isLocalPath = presetImageUrl.startsWith('/media/') || 
                                                   presetImageUrl.startsWith('/uploads/') ||
                                                   (!presetImageUrl.startsWith('http://') && !presetImageUrl.startsWith('https://'));
                                
                                if (isLocalPath) {
                                    // æœ¬åœ°è·¯å¾„ï¼šéœ€è¦ä¸Šä¼ åˆ°äº‘ç«¯è·å–URL
                                    try {
                                        // æ„å»ºå®Œæ•´URLï¼ˆç”¨äºä¸Šä¼ ï¼‰
                                        let fullUrl = presetImageUrl;
                                        if (presetImageUrl.startsWith('/')) {
                                            // ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦è¡¥å…¨ä¸ºå®Œæ•´URL
                                            const baseUrl = window.location.origin;
                                            fullUrl = baseUrl + presetImageUrl;
                                        }
                                        
                                        console.log(`ğŸ“¤ [Playground] ä¸Šä¼ é¢„è®¾å›¾ç‰‡åˆ°äº‘ç«¯: ${fullUrl}`);
                                        
                                        // ä¸Šä¼ åˆ°GRSAIè·å–äº‘ç«¯URL
                                        const uploadResponse = await fetch('/api/admin/styles/images/upload-to-grsai', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify({
                                                image_url: fullUrl
                                            })
                                        });
                                        
                                        const uploadResult = await uploadResponse.json();
                                        if (uploadResult.status === 'success' && uploadResult.data && uploadResult.data.url) {
                                            console.log(`âœ… [Playground] é¢„è®¾å›¾ç‰‡å·²ä¸Šä¼ åˆ°äº‘ç«¯: ${presetImageUrl} -> ${uploadResult.data.url}`);
                                            return {
                                                ...upload,
                                                cloud_preset_image_url: uploadResult.data.url
                                            };
                                        } else {
                                            console.warn(`âš ï¸ [Playground] é¢„è®¾å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${presetImageUrl}`, uploadResult);
                                            return upload; // ä½¿ç”¨åŸå§‹URL
                                        }
                                    } catch (error) {
                                        console.error(`âŒ [Playground] ä¸Šä¼ é¢„è®¾å›¾ç‰‡å¤±è´¥: ${presetImageUrl}`, error);
                                        return upload; // ä½¿ç”¨åŸå§‹URL
                                    }
                                } else {
                                    // å·²ç»æ˜¯äº‘ç«¯URLï¼Œç›´æ¥ä½¿ç”¨
                                    console.log(`âœ… [Playground] é¢„è®¾å›¾ç‰‡å·²æ˜¯äº‘ç«¯URL: ${presetImageUrl}`);
                                    return {
                                        ...upload,
                                        cloud_preset_image_url: presetImageUrl
                                    };
                                }
                            })
                        );
                        
                        console.log('ğŸ” [Playground] å¤„ç†åçš„é¢„è®¾å›¾ç‰‡:', processedPresetImages);
                        
                        uploadConfig = {
                            uploads: processedPresetImages.map((upload, index) => {
                                const uploadItem = {
                                    name: upload.name,
                                    key: upload.key || 'default',
                                    required: upload.required || false
                                };
                                
                                // ä½¿ç”¨å¤„ç†åçš„äº‘ç«¯URL
                                const presetImageUrl = upload.cloud_preset_image_url || upload.preset_image || upload.example_image;
                                
                                console.log(`ğŸ” [Playground] æ„å»ºä¸Šä¼ é…ç½® - å…¥å£${index}: key=${upload.key}, presetImageUrl=${presetImageUrl}`);
                                
                                // å›¾ç‰‡é¡ºåºé€»è¾‘ï¼š
                                // 1. å…ˆæ·»åŠ ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼ˆæŒ‰é¡ºåºï¼‰
                                // 2. ç„¶åæ·»åŠ é¢„è®¾å›¾ç‰‡
                                
                                // å¯¹äºç¬¬ä¸€ä¸ªä¸Šä¼ å…¥å£ï¼ˆé€šå¸¸æ˜¯å‚è€ƒå›¾ï¼‰ï¼Œå…ˆæ·»åŠ æ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼Œå†æ·»åŠ é¢„è®¾å›¾ç‰‡
                                if (index === 0) {
                                    // ç¬¬ä¸€ä¸ªå…¥å£ï¼šå…ˆæ·»åŠ æ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡
                                    console.log(`ğŸ“¤ [Playground] ç¬¬ä¸€ä¸ªå…¥å£(${upload.key})ï¼šæ·»åŠ ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ ${uploadedImages.length} å¼ `);
                                    uploadedImages.forEach((userImageUrl, imgIndex) => {
                                        formData.append(`cloud_image_url_${upload.key || 'default'}`, userImageUrl);
                                        console.log(`  - ç”¨æˆ·å›¾ç‰‡${imgIndex + 1}: ${userImageUrl}`);
                                    });
                                    
                                    // ç„¶åæ·»åŠ é¢„è®¾å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
                                    if (presetImageUrl) {
                                        formData.append(`cloud_image_url_${upload.key || 'default'}`, presetImageUrl);
                                        console.log(`  - é¢„è®¾å›¾ç‰‡: ${presetImageUrl}`);
                                    } else {
                                        console.log(`  - æ— é¢„è®¾å›¾ç‰‡`);
                                    }
                                } else {
                                    // å…¶ä»–å…¥å£ï¼šåªæ·»åŠ å¯¹åº”çš„é¢„è®¾å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
                                    if (presetImageUrl) {
                                        formData.append(`cloud_image_url_${upload.key || 'default'}`, presetImageUrl);
                                        console.log(`ğŸ“¤ [Playground] å…¥å£${index}(${upload.key})ï¼šæ·»åŠ é¢„è®¾å›¾ç‰‡: ${presetImageUrl}`);
                                    }
                                }
                                
                                return uploadItem;
                            })
                        };
                        
                        console.log('ğŸ” [Playground] æœ€ç»ˆä¸Šä¼ é…ç½®:', uploadConfig);
                    } else {
                        // æ²¡æœ‰é¢„è®¾å›¾ç‰‡ï¼Œä½¿ç”¨é»˜è®¤æ–¹å¼
                        uploadedImages.forEach((url) => {
                            formData.append('cloud_image_url', url);
                        });
                    }
                } else {
                    // æ²¡æœ‰ä¸Šä¼ é…ç½®ï¼Œä½¿ç”¨é»˜è®¤æ–¹å¼
                    uploadedImages.forEach((url) => {
                        formData.append('cloud_image_url', url);
                    });
                }
                
                // å¦‚æœæœ‰ä¸Šä¼ é…ç½®ï¼Œä¼ é€’upload_config
                if (uploadConfig) {
                    formData.append('upload_config', JSON.stringify(uploadConfig));
                }
                
                // æ·»åŠ APIé…ç½®IDï¼ˆå¦‚æœæ‰‹åŠ¨æ¨¡å¼ï¼‰
                const providerId = document.getElementById('apiProviderSelect').value;
                if (providerId) {
                    formData.append('api_config_id', providerId);
                }
                
                // æ·»åŠ æç¤ºè¯ã€å°ºå¯¸ã€æ¯”ä¾‹ï¼ˆå¦‚æœç”¨æˆ·æä¾›äº†ï¼‰
                const prompt = document.getElementById('apiPrompt').value.trim();
                const size = document.getElementById('apiSize').value;
                const aspectRatio = document.getElementById('apiAspectRatio').value;
                
                if (prompt) {
                    formData.append('prompt', prompt);
                }
                if (size) {
                    formData.append('size', size);
                }
                if (aspectRatio) {
                    formData.append('aspect_ratio', aspectRatio);
                }
            } else if (currentMode === 'comfyui') {
                // ComfyUIæ¨¡å¼ï¼šä½¿ç”¨FormData
                if (!templateId || templateId === 0) {
                    throw new Error('è¯·é€‰æ‹©æ¨¡æ¿');
                }
                
                const imageId = parseInt(templateId);
                endpoint = `/api/admin/styles/images/${imageId}/test-api-comfyui`;
                
                // æ·»åŠ å›¾ç‰‡URLï¼ˆæ”¯æŒå¤šå›¾ï¼‰
                uploadedImages.forEach((url) => {
                    formData.append('cloud_image_url', url);
                });
            } else {
                throw new Error('æœªçŸ¥çš„æ¨¡å¼');
            }

            console.log('ğŸ“¤ æäº¤ä»»åŠ¡æ•°æ®:', {
                endpoint: endpoint,
                currentMode: currentMode,
                templateId: templateId,
                uploadedImages: uploadedImages
            });

            const response = await fetch(endpoint, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('âŒ HTTPé”™è¯¯:', response.status, errorText);
                let errorData;
                try {
                    errorData = JSON.parse(errorText);
                } catch {
                    errorData = { message: errorText || `HTTP ${response.status} é”™è¯¯` };
                }
                throw new Error(errorData.message || `HTTP ${response.status} é”™è¯¯`);
            }

            const result = await response.json();
            
            if (result.status !== 'success') {
                console.error('âŒ ä»»åŠ¡æäº¤å¤±è´¥:', result);
                throw new Error(result.message || 'ä»»åŠ¡æäº¤å¤±è´¥');
            }
            
            console.log('âœ… ä»»åŠ¡æäº¤æˆåŠŸ:', result);
            return result;
        }

        // è·å–å¯¹åº”æ¨¡å¼çš„APIç«¯ç‚¹
        function getEndpointForMode() {
            switch (currentMode) {
                case 'workflow':
                    return '/api/playground/test/workflow';
                case 'api':
                    return '/api/playground/test/api';
                case 'comfyui':
                    return '/api/playground/test/comfyui';
                default:
                    return '/api/playground/test/workflow';
            }
        }

        // å‡†å¤‡å›¾ç‰‡æ•°æ®ï¼ˆè½¬æ¢ä¸ºbase64ï¼‰
        async function prepareImageData() {
            const imageDataList = [];
            
            for (const url of uploadedImages) {
                try {
                    const response = await fetch(url);
                    const blob = await response.blob();
                    const base64 = await blobToBase64(blob);
                    imageDataList.push(base64);
                } catch (error) {
                    console.error('è½¬æ¢å›¾ç‰‡å¤±è´¥:', error);
                }
            }
            
            return imageDataList;
        }

        // Blobè½¬Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            const resultsGrid = document.getElementById('resultsGrid');
            const resultsSection = document.getElementById('resultsSection');
            
            resultsGrid.innerHTML = results.map((result, index) => {
                if (result.status === 'success') {
                    // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡URLï¼ˆåŒæ­¥APIç›´æ¥è¿”å›ç»“æœï¼‰
                    if (result.data && result.data.image_url) {
                        return `
                            <div class="result-item">
                                <img src="${result.data.image_url}" alt="ç»“æœ ${index + 1}">
                            </div>
                        `;
                    }
                    // æ£€æŸ¥æ˜¯å¦æœ‰ä»»åŠ¡IDï¼ˆå¼‚æ­¥APIï¼Œä»»åŠ¡å·²åˆ›å»ºï¼‰
                    if (result.data && (result.data.task_id || result.data.order_number)) {
                        const orderNumber = result.data.order_number || 'N/A';
                        const taskId = result.data.task_id || 'N/A';
                        return `
                            <div class="result-item" style="padding: 20px; text-align: center; color: rgba(255,255,255,0.9);">
                                <div style="margin-bottom: 15px;">
                                    <i class="fas fa-check-circle" style="color: #4ecdc4; font-size: 3rem; margin-bottom: 10px;"></i>
                                    <h5 style="color: #4ecdc4; margin-bottom: 10px;">âœ… ä»»åŠ¡å·²åˆ›å»º</h5>
                                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 5px;">è®¢å•å·: <code>${orderNumber}</code></p>
                                    <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">ä»»åŠ¡ID: <code>${taskId}</code></p>
                                    <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">ä»»åŠ¡æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·å‰å¾€ <a href="/playground/tasks" style="color: #4ecdc4; text-decoration: underline;">ä»»åŠ¡æ—¥å¿—</a> æŸ¥çœ‹è¿›åº¦</p>
                                </div>
                            </div>
                        `;
                    }
                    // å…¶ä»–æˆåŠŸæƒ…å†µ
                    return `
                        <div class="result-item" style="padding: 20px; text-align: center; color: rgba(255,255,255,0.9);">
                            <i class="fas fa-check-circle" style="color: #4ecdc4; font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>ä»»åŠ¡å·²æäº¤: ${result.message || 'æˆåŠŸ'}</p>
                        </div>
                    `;
                } else {
                    return `
                        <div class="result-item" style="padding: 20px; color: rgba(255,0,0,0.7);">
                            <p>ç”Ÿæˆå¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
            }).join('');
            
            resultsSection.classList.add('show');
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            alert(message);
        }

        // å…¨å±€å‡½æ•°ï¼ˆä¾›HTMLè°ƒç”¨ï¼‰
        window.toggleTemplate = toggleTemplate;
        window.removeImage = removeImage;
    </script>
</body>
</html>
