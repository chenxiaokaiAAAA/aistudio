<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>团购核销 - {{ account.company_name }}</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <style>
        body {
            background: #f5f7fa;
            min-height: 100vh;
            padding-top: 70px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .navbar-custom {
            background: #0a0a0a !important;
            border-bottom: 1px solid #1a1a1a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .navbar-brand, .nav-link {
            color: #e0e0e0 !important;
        }
        .nav-link:hover {
            color: #ffffff !important;
        }
        .nav-link.active {
            color: #ffffff !important;
            font-weight: 600;
        }
        .container {
            max-width: 800px;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .form-label {
            font-weight: 500;
            color: #333;
        }
        .required {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    {% include 'franchisee/_navbar.html' %}

    <div class="container mt-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-ticket-alt"></i> 团购核销</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>说明：</strong>选择团购平台和套餐，输入订单号和客户手机号，生成优惠券。如果客户已注册小程序且手机号匹配，优惠券将自动保存到账户。
                </div>

                <form id="grouponVerifyForm">
                    <div class="mb-3">
                        <label for="platform" class="form-label">平台 <span class="required">*</span></label>
                        <select class="form-select" id="platform" name="platform" required>
                            <option value="">请选择平台</option>
                            {% for platform_name, packages in platforms.items() %}
                            <option value="{{ platform_name }}">{{ platform_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="package_id" class="form-label">团购套餐 <span class="required">*</span></label>
                        <select class="form-select" id="package_id" name="package_id" required disabled>
                            <option value="">请先选择平台</option>
                        </select>
                        <div class="form-text" id="packageAmountText">选择套餐后自动显示金额</div>
                    </div>

                    <div class="mb-3">
                        <label for="groupon_order_id" class="form-label">团购订单号 <span class="required">*</span></label>
                        <input type="text" class="form-control" id="groupon_order_id" name="groupon_order_id" 
                               placeholder="请输入团购平台的订单号" required>
                    </div>

                    <div class="mb-3">
                        <label for="customer_phone" class="form-label">客户手机号 <span class="required">*</span></label>
                        <input type="tel" class="form-control" id="customer_phone" name="customer_phone" 
                               placeholder="用于记录客户信息，匹配后自动保存优惠券" required>
                        <div class="form-text">如果客户已注册小程序且手机号匹配，优惠券将自动保存到账户</div>
                    </div>

                    <div class="mb-3">
                        <label for="customer_name" class="form-label">客户姓名</label>
                        <input type="text" class="form-control" id="customer_name" name="customer_name" 
                               placeholder="可选">
                    </div>

                    <div class="mb-3">
                        <label for="expire_days" class="form-label">有效期（天）</label>
                        <input type="number" class="form-control" id="expire_days" name="expire_days" 
                               value="30" min="1" max="365">
                        <div class="form-text">默认30天</div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100" id="verifyBtn">
                        <i class="fas fa-check"></i> 确认核销
                    </button>
                </form>

                <!-- 核销结果 -->
                <div id="verifyResult" class="mt-4" style="display: none;">
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle"></i> 核销成功！</h5>
                        <div class="mt-3">
                            <p><strong>优惠券代码：</strong><code id="resultCouponCode"></code></p>
                            <p><strong>优惠券名称：</strong><span id="resultCouponName"></span></p>
                            <p><strong>核销金额：</strong>¥<span id="resultAmount"></span></p>
                            <p><strong>有效期至：</strong><span id="resultExpireTime"></span></p>
                            <p id="autoSavedInfo" class="text-success" style="display: none;">
                                <i class="fas fa-check"></i> 优惠券已自动保存到客户账户
                            </p>
                        </div>
                        <div class="text-center mt-3">
                            <p class="mb-2"><strong>领取二维码</strong></p>
                            <img id="qrCodeImage" src="" alt="二维码" class="img-fluid" style="max-width: 300px;">
                            <p class="text-muted mt-2">用户扫码即可领取优惠券</p>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">继续核销</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    {% include 'admin/_ux_scripts.html' %}
    <script>
        // 套餐数据
        const packagesData = {
            {% if platforms %}
            {% for platform_name, packages in platforms.items() %}
            '{{ platform_name }}': [
                {% for pkg in packages %}
                {
                    id: {{ pkg.id }},
                    name: '{{ pkg.package_name|e }}',
                    amount: {{ pkg.package_amount }}
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ]{% if not loop.last %},{% endif %}
            {% endfor %}
            {% endif %}
        };
        
        // 调试信息
        console.log('平台数据:', packagesData);
        console.log('平台数量:', Object.keys(packagesData).length);

        // 平台选择变化
        document.getElementById('platform').addEventListener('change', function() {
            const platform = this.value;
            const packageSelect = document.getElementById('package_id');
            const packageAmountText = document.getElementById('packageAmountText');
            
            packageSelect.innerHTML = '<option value="">请选择套餐</option>';
            packageSelect.disabled = !platform;
            
            if (platform && packagesData[platform]) {
                packagesData[platform].forEach(pkg => {
                    const option = document.createElement('option');
                    option.value = pkg.id;
                    option.textContent = `${pkg.name} - ¥${pkg.amount}`;
                    option.dataset.amount = pkg.amount;
                    packageSelect.appendChild(option);
                });
                packageAmountText.textContent = '选择套餐后自动显示金额';
            } else {
                packageAmountText.textContent = '选择套餐后自动显示金额';
            }
        });

        // 套餐选择变化
        document.getElementById('package_id').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const amount = selectedOption.dataset.amount;
            if (amount) {
                document.getElementById('packageAmountText').textContent = `核销金额：¥${amount}`;
            }
        });

        // 提交表单
        document.getElementById('grouponVerifyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                platform: document.getElementById('platform').value,
                package_id: parseInt(document.getElementById('package_id').value),
                groupon_order_id: document.getElementById('groupon_order_id').value.trim(),
                customer_phone: document.getElementById('customer_phone').value.trim(),
                customer_name: document.getElementById('customer_name').value.trim(),
                expire_days: parseInt(document.getElementById('expire_days').value) || 30
            };

            // 验证
            if (!formData.platform || !formData.package_id || !formData.groupon_order_id || !formData.customer_phone) {
                alert('请填写所有必填字段');
                return;
            }

            // 禁用按钮
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 核销中...';

            fetch('/franchisee/groupon/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i class="fas fa-check"></i> 确认核销';

                if (data.status === 'success') {
                    // 显示结果
                    document.getElementById('resultCouponCode').textContent = data.data.coupon_code;
                    document.getElementById('resultCouponName').textContent = data.data.coupon_name;
                    document.getElementById('resultAmount').textContent = data.data.verify_amount;
                    document.getElementById('resultExpireTime').textContent = data.data.expire_time;
                    document.getElementById('qrCodeImage').src = data.data.qr_code_url;
                    
                    if (data.data.auto_saved) {
                        document.getElementById('autoSavedInfo').style.display = 'block';
                    } else {
                        document.getElementById('autoSavedInfo').style.display = 'none';
                    }
                    
                    document.getElementById('verifyResult').style.display = 'block';
                    document.getElementById('grouponVerifyForm').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert(data.message || '核销失败');
                }
            })
            .catch(error => {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i class="fas fa-check"></i> 确认核销';
                console.error('核销失败:', error);
                alert('网络错误，请重试');
            });
        });

        function resetForm() {
            document.getElementById('grouponVerifyForm').reset();
            document.getElementById('verifyResult').style.display = 'none';
            document.getElementById('package_id').disabled = true;
            document.getElementById('package_id').innerHTML = '<option value="">请先选择平台</option>';
            document.getElementById('packageAmountText').textContent = '选择套餐后自动显示金额';
        }
    </script>
</body>
</html>
