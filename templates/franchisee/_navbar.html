<!-- 加盟商统一导航栏 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
        <a class="navbar-brand" href="/franchisee/dashboard">
            <i class="fas fa-building"></i> {{ account.company_name }}
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/franchisee/dashboard' %}active{% endif %}" href="/franchisee/dashboard">
                        <i class="fas fa-home"></i> 首页
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/franchisee/orders' %}active{% endif %}" href="/franchisee/orders">
                        <i class="fas fa-shopping-cart"></i> 订单管理
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/franchisee/groupon/verify' %}active{% endif %}" href="/franchisee/groupon/verify">
                        <i class="fas fa-ticket-alt"></i> 团购核销
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/franchisee/groupon/records' %}active{% endif %}" href="/franchisee/groupon/records">
                        <i class="fas fa-list"></i> 核销记录
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.path == '/franchisee/coupons' %}active{% endif %}" href="/franchisee/coupons">
                        <i class="fas fa-gift"></i> 优惠券管理
                    </a>
                </li>
                <li class="nav-item">
                    <button class="nav-link btn btn-link text-white" onclick="showSelectionQRCode({{ account.id }})" style="border: none; background: none; padding: 0.5rem 1rem; cursor: pointer; text-decoration: none;">
                        <i class="fas fa-images"></i> 选片系统
                    </button>
                </li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i> {{ account.contact_person or account.username }}
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/franchisee/change-password">
                            <i class="fas fa-key"></i> 修改密码
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/franchisee/logout">
                            <i class="fas fa-sign-out-alt"></i> 退出登录
                        </a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- 选片系统模态框 -->
<div class="modal fade" id="selectionQRCodeModal" tabindex="-1" aria-labelledby="selectionQRCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectionQRCodeModalLabel">选片系统</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 选项卡 -->
                <ul class="nav nav-tabs mb-3" id="selectionTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="qrcode-tab" data-bs-toggle="tab" data-bs-target="#qrcode-pane" type="button" role="tab">
                            <i class="fas fa-qrcode"></i> 扫码选片
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane" type="button" role="tab">
                            <i class="fas fa-search"></i> 手动查询
                        </button>
                    </li>
                </ul>
                
                <!-- 选项卡内容 -->
                <div class="tab-content" id="selectionTabContent">
                    <!-- 扫码选片 -->
                    <div class="tab-pane fade show active" id="qrcode-pane" role="tabpanel">
                        <div class="text-center">
                            <p class="text-muted mb-3">用户扫描此二维码后，可进入小程序查看自己的订单并进行选片</p>
                            <div id="qrcodeContainer" class="mb-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                            </div>
                            <p class="text-muted small">二维码有效期：5分钟</p>
                        </div>
                    </div>
                    
                    <!-- 手动查询 -->
                    <div class="tab-pane fade" id="search-pane" role="tabpanel">
                        <form id="searchOrderForm" onsubmit="searchOrdersForSelection(event)">
                            <div class="mb-3">
                                <label for="searchPhone" class="form-label">手机号</label>
                                <input type="tel" class="form-control" id="searchPhone" placeholder="请输入11位手机号" maxlength="11">
                            </div>
                            <div class="mb-3">
                                <label for="searchOrderNumber" class="form-label">订单号</label>
                                <input type="text" class="form-control" id="searchOrderNumber" placeholder="请输入订单号（可选）">
                                <small class="form-text text-muted">手机号和订单号至少填写一个</small>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" id="searchOrderBtn">
                                    <i class="fas fa-search"></i> 查询订单
                                </button>
                            </div>
                        </form>
                        <div id="searchResultContainer" class="mt-3" style="display: none;">
                            <hr>
                            <h6>查询结果：</h6>
                            <div id="searchResultList"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="refreshQRCodeBtn" onclick="refreshQRCode()" style="display: none;">刷新二维码</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentFranchiseeId = null;
    let currentToken = null;

    function showSelectionQRCode(franchiseeId) {
        currentFranchiseeId = franchiseeId;
        const modal = new bootstrap.Modal(document.getElementById('selectionQRCodeModal'));
        modal.show();
        
        // 切换到扫码选片标签页并生成二维码
        const qrcodeTab = document.getElementById('qrcode-tab');
        const qrcodePane = document.getElementById('qrcode-pane');
        const searchTab = document.getElementById('search-tab');
        const searchPane = document.getElementById('search-pane');
        
        // 激活扫码选片标签
        qrcodeTab.classList.add('active');
        qrcodePane.classList.add('show', 'active');
        searchTab.classList.remove('active');
        searchPane.classList.remove('show', 'active');
        
        // 显示刷新按钮
        document.getElementById('refreshQRCodeBtn').style.display = 'inline-block';
        
        generateQRCode(franchiseeId);
    }

    function generateQRCode(franchiseeId) {
        const container = document.getElementById('qrcodeContainer');
        container.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">加载中...</span></div>';

        fetch('/admin/photo-selection/generate-qrcode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                franchisee_id: franchiseeId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentToken = data.token;
                container.innerHTML = `<img src="${data.qrcode}" alt="选片二维码" class="img-fluid" style="max-width: 300px;">`;
            } else {
                container.innerHTML = `<div class="alert alert-danger">${data.message || '生成二维码失败'}</div>`;
            }
        })
        .catch(error => {
            console.error('生成二维码失败:', error);
            container.innerHTML = `<div class="alert alert-danger">生成二维码失败，请重试</div>`;
        });
    }

    function refreshQRCode() {
        if (currentFranchiseeId) {
            generateQRCode(currentFranchiseeId);
        }
    }

    // 手动查询订单
    function searchOrdersForSelection(event) {
        event.preventDefault();
        
        const phone = document.getElementById('searchPhone').value.trim();
        const orderNumber = document.getElementById('searchOrderNumber').value.trim();
        const searchBtn = document.getElementById('searchOrderBtn');
        const resultContainer = document.getElementById('searchResultContainer');
        const resultList = document.getElementById('searchResultList');

        if (!phone && !orderNumber) {
            alert('请至少填写手机号或订单号');
            return;
        }

        // 验证手机号格式
        if (phone && (!/^1[3-9]\d{9}$/.test(phone))) {
            alert('手机号格式不正确，请输入11位数字');
            return;
        }

        // 显示加载状态
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 查询中...';
        resultContainer.style.display = 'none';

        fetch('/api/photo-selection/search-orders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                phone: phone || undefined,
                order_number: orderNumber || undefined,
                franchisee_id: currentFranchiseeId
            })
        })
        .then(response => response.json())
        .then(data => {
            searchBtn.disabled = false;
            searchBtn.innerHTML = '<i class="fas fa-search"></i> 查询订单';

            if (data.success && data.orders && data.orders.length > 0) {
                // 显示查询结果
                let html = `<div class="list-group">`;
                data.orders.forEach(order => {
                    const statusText = getStatusText(order.status);
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">订单号：${order.order_number}</h6>
                                <span class="badge bg-${getStatusBadgeColor(order.status)}">${statusText}</span>
                            </div>
                            <p class="mb-1">客户：${order.customer_name || '未填写'}</p>
                            <p class="mb-1">手机：${order.customer_phone || '未填写'}</p>
                            <small class="text-muted">创建时间：${new Date(order.created_at).toLocaleString('zh-CN')}</small>
                            <div class="mt-2">
                                <a href="/admin/photo-selection/${order.id}" class="btn btn-sm btn-primary" target="_blank">
                                    <i class="fas fa-images"></i> 进入选片
                                </a>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
                resultList.innerHTML = html;
                resultContainer.style.display = 'block';
            } else {
                resultList.innerHTML = `<div class="alert alert-warning">${data.message || '未找到符合条件的订单'}</div>`;
                resultContainer.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('查询订单失败:', error);
            searchBtn.disabled = false;
            searchBtn.innerHTML = '<i class="fas fa-search"></i> 查询订单';
            resultList.innerHTML = `<div class="alert alert-danger">查询失败，请重试</div>`;
            resultContainer.style.display = 'block';
        });
    }

    // 获取状态文本
    function getStatusText(status) {
        const statusMap = {
            'pending': '待处理',
            'paid': '已支付',
            'shooting': '拍摄中',
            'retouching': '美颜中',
            'ai_processing': 'AI处理中',
            'pending_selection': '待选片',
            'selection_completed': '选片完成',
            'printing': '打印中',
            'pending_shipment': '待发货',
            'shipped': '已发货',
            'completed': '已完成'
        };
        return statusMap[status] || status;
    }

    // 获取状态徽章颜色
    function getStatusBadgeColor(status) {
        const colorMap = {
            'pending': 'secondary',
            'paid': 'info',
            'shooting': 'warning',
            'retouching': 'warning',
            'ai_processing': 'warning',
            'pending_selection': 'primary',
            'selection_completed': 'success',
            'printing': 'info',
            'pending_shipment': 'warning',
            'shipped': 'success',
            'completed': 'success'
        };
        return colorMap[status] || 'secondary';
    }

    // 监听标签切换，切换时隐藏刷新按钮（仅在扫码选片时显示）
    document.addEventListener('DOMContentLoaded', function() {
        const qrcodeTab = document.getElementById('qrcode-tab');
        const searchTab = document.getElementById('search-tab');
        const refreshBtn = document.getElementById('refreshQRCodeBtn');

        if (qrcodeTab) {
            qrcodeTab.addEventListener('shown.bs.tab', function() {
                refreshBtn.style.display = 'inline-block';
            });
        }
        if (searchTab) {
            searchTab.addEventListener('shown.bs.tab', function() {
                refreshBtn.style.display = 'none';
            });
        }
    });
</script>
