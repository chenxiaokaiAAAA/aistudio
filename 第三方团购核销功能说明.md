# 第三方团购核销功能说明

## 功能概述

第三方团购核销功能允许用户在小程序中通过第三方团购平台（如美团、大众点评等）的券码进行核销，核销成功后自动生成对应金额的免费拍摄券。

## 功能特点

1. **API配置管理**：在管理后台配置第三方团购平台的API接口
2. **一键导入**：根据手机号自动查询并导入团购券码列表
3. **手动输入**：支持手动输入第三方平台的团购券码
4. **自动核销**：验证券码有效性后自动核销并生成优惠券
5. **自动发放**：核销成功后自动生成并发放免费拍摄券

## 配置步骤

### 1. 在管理后台配置API

1. 进入 **优惠券管理** 页面
2. 点击 **第三方团购API配置** 按钮
3. 填写配置信息：
   - **团购平台**：选择平台（美团/大众点评/自定义）
   - **API基础地址**：第三方平台的API基础URL（必填）
   - **验证券码接口路径**：用于验证券码是否有效的接口路径（默认：`/api/v1/verify`）
   - **核销券码接口路径**：用于核销券码的接口路径（默认：`/api/v1/redeem`）
   - **查询券码接口路径**：用于根据手机号查询券码列表的接口路径（默认：`/api/v1/query`）
   - **API密钥**：第三方平台提供的API密钥（用于身份验证）
   - **API密钥（Secret）**：第三方平台提供的API密钥Secret（用于签名验证）
   - **配置状态**：启用/禁用
   - **备注**：配置说明
4. 点击 **测试连接** 验证API是否可访问
5. 点击 **保存配置**

### 2. API接口规范

#### 验证券码接口（verify_endpoint）

**请求方式**：POST

**请求参数**：
```json
{
  "code": "券码"
}
```

**响应格式**：
```json
{
  "success": true,
  "data": {
    "code": "券码",
    "amount": 100.0,
    "status": "unused",
    "expire_time": "2026-12-31 23:59:59"
  }
}
```

#### 核销券码接口（redeem_endpoint）

**请求方式**：POST

**请求参数**：
```json
{
  "code": "券码",
  "phone": "手机号"
}
```

**响应格式**：
```json
{
  "success": true,
  "message": "核销成功"
}
```

#### 查询券码接口（query_endpoint）

**请求方式**：POST

**请求参数**：
```json
{
  "phone": "手机号"
}
```

**响应格式**：
```json
{
  "success": true,
  "data": [
    {
      "code": "券码1",
      "amount": 100.0,
      "status": "unused"
    },
    {
      "code": "券码2",
      "amount": 200.0,
      "status": "unused"
    }
  ]
}
```

## 使用流程

### 小程序端使用

1. **进入第三方团购核销页面**
   - 在"我的"页面点击"第三方团购核销"入口

2. **一键导入券码**
   - 输入手机号
   - 点击"查询券码"
   - 系统自动调用第三方API查询该手机号下的所有券码
   - 显示券码列表（包含券码、金额、状态）

3. **核销券码**
   - **方式1**：从券码列表中点击"核销"按钮
   - **方式2**：手动输入券码，点击"验证并核销"
   - 系统会先验证券码是否有效
   - 验证通过后调用第三方API进行核销
   - 核销成功后自动生成免费拍摄券

4. **查看结果**
   - 核销成功后显示生成的优惠券信息
   - 包括：优惠券代码、名称、金额、有效期

## API接口说明

### 小程序端API

#### 1. 查询券码列表

**接口**：`POST /api/miniprogram/third-party-groupon/query`

**请求参数**：
```json
{
  "phone": "13800138000"
}
```

**响应**：
```json
{
  "status": "success",
  "data": {
    "codes": [
      {
        "code": "券码1",
        "amount": 100.0,
        "status": "unused"
      }
    ]
  }
}
```

#### 2. 验证券码

**接口**：`POST /api/miniprogram/third-party-groupon/verify`

**请求参数**：
```json
{
  "code": "券码"
}
```

**响应**：
```json
{
  "status": "success",
  "data": {
    "code": "券码",
    "amount": 100.0,
    "status": "unused",
    "expire_time": "2026-12-31 23:59:59"
  }
}
```

#### 3. 核销券码

**接口**：`POST /api/miniprogram/third-party-groupon/redeem`

**请求参数**：
```json
{
  "code": "券码",
  "phone": "13800138000",
  "openid": "用户openid",
  "user_id": "用户ID",
  "expire_days": 30
}
```

**响应**：
```json
{
  "status": "success",
  "message": "核销成功，优惠券已生成",
  "data": {
    "coupon_id": 123,
    "coupon_code": "ABC12345",
    "coupon_name": "团购核销券-100.0元",
    "amount": 100.0,
    "expire_time": "2026-02-20 18:32:00"
  }
}
```

### 管理后台API

#### 1. 获取配置

**接口**：`GET /api/admin/third-party-groupon/config`

**响应**：
```json
{
  "success": true,
  "data": {
    "platform": "meituan",
    "api_base_url": "https://api.example.com",
    "verify_endpoint": "/api/v1/verify",
    "redeem_endpoint": "/api/v1/redeem",
    "query_endpoint": "/api/v1/query",
    "api_key": "xxx",
    "api_secret": "xxx",
    "status": "active",
    "notes": "备注"
  }
}
```

#### 2. 保存配置

**接口**：`POST /api/admin/third-party-groupon/config`

**请求参数**：
```json
{
  "platform": "meituan",
  "api_base_url": "https://api.example.com",
  "verify_endpoint": "/api/v1/verify",
  "redeem_endpoint": "/api/v1/redeem",
  "query_endpoint": "/api/v1/query",
  "api_key": "xxx",
  "api_secret": "xxx",
  "status": "active",
  "notes": "备注"
}
```

#### 3. 测试连接

**接口**：`POST /api/admin/third-party-groupon/test`

**请求参数**：
```json
{
  "api_base_url": "https://api.example.com"
}
```

## 数据存储

配置信息存储在 `ai_config` 表中：

- **config_key**：`third_party_groupon_api`
- **config_value**：JSON格式的配置数据
- **description**：配置说明

## 注意事项

1. **API配置**：必须先在管理后台配置第三方团购API，否则小程序端无法使用
2. **API规范**：第三方平台的API必须符合上述接口规范
3. **权限控制**：所有用户都可以使用第三方团购核销功能（与店员专用的"团购核销"不同）
4. **券码唯一性**：系统会检查券码是否已核销，避免重复核销
5. **自动发放**：如果提供了用户信息（openid或user_id），优惠券会自动发放到用户账户
6. **错误处理**：如果第三方API调用失败，会返回相应的错误信息

## 相关文件

- 管理后台API：`aistudio/app/routes/admin_third_party_groupon_api.py`
- 小程序API：`aistudio/app/routes/miniprogram/third_party_groupon.py`
- 管理后台页面：`aistudio/templates/admin/coupons.html`（配置入口）
- 小程序页面：
  - `aistudio-小程序/pages/third-party-groupon/third-party-groupon.wxml`
  - `aistudio-小程序/pages/third-party-groupon/third-party-groupon.js`
  - `aistudio-小程序/pages/third-party-groupon/third-party-groupon.wxss`
  - `aistudio-小程序/pages/third-party-groupon/third-party-groupon.json`

## 后续扩展

1. **支持更多平台**：可以扩展支持更多第三方团购平台
2. **签名验证**：实现API签名验证逻辑（目前预留了api_secret字段）
3. **批量核销**：支持批量核销多个券码
4. **核销记录**：记录核销历史，方便查询和统计
