# 数据库迁移说明

## 新增字段：enable_in_workflow

### 字段信息
- **表名**: `meitu_api_config`
- **字段名**: `enable_in_workflow`
- **类型**: `BOOLEAN`
- **默认值**: `0` (False)
- **说明**: 是否在订单处理流程中启用美颜API

### 迁移方法

#### 方法1：使用迁移脚本（推荐）

1. **运行迁移脚本**：
   ```bash
   cd AI-studio
   python scripts/database/add_meitu_enable_in_workflow_field.py
   ```

2. **如果数据库路径不在默认位置**，可以指定路径：
   ```bash
   python scripts/database/add_meitu_enable_in_workflow_field.py instance/pet_painting.db
   ```

3. **脚本会自动**：
   - 备份数据库（带时间戳）
   - 检查字段是否已存在
   - 添加新字段
   - 验证迁移结果

#### 方法2：自动迁移（启动时自动执行）

项目启动时会自动检查并添加缺失的字段，所以**直接启动项目即可**，系统会自动执行迁移。

#### 方法3：手动SQL迁移

如果以上方法都不行，可以手动执行SQL：

```sql
-- 连接到数据库
sqlite3 instance/pet_painting.db

-- 检查字段是否已存在
PRAGMA table_info(meitu_api_config);

-- 如果 enable_in_workflow 字段不存在，执行：
ALTER TABLE meitu_api_config 
ADD COLUMN enable_in_workflow BOOLEAN DEFAULT 0 NOT NULL;

-- 验证
PRAGMA table_info(meitu_api_config);
```

### 验证迁移

迁移完成后，可以通过以下方式验证：

1. **检查数据库结构**：
   ```python
   import sqlite3
   conn = sqlite3.connect('instance/pet_painting.db')
   cursor = conn.cursor()
   cursor.execute("PRAGMA table_info(meitu_api_config)")
   columns = [row[1] for row in cursor.fetchall()]
   print('enable_in_workflow' in columns)  # 应该返回 True
   ```

2. **在代码中检查**：
   ```python
   from app.models import MeituAPIConfig
   config = MeituAPIConfig.query.first()
   if hasattr(config, 'enable_in_workflow'):
       print("✅ 字段已存在")
   ```

### 注意事项

1. **备份数据库**：迁移前建议手动备份数据库
2. **默认值**：新字段默认值为 `False`（关闭），需要在管理后台手动开启
3. **兼容性**：如果字段已存在，迁移脚本会跳过，不会重复添加

### 回滚（如果需要）

如果需要回滚，可以执行：

```sql
-- ⚠️ 注意：SQLite不支持直接删除列，需要重建表
-- 如果需要回滚，建议从备份恢复数据库
```

### 迁移脚本位置

- 脚本文件：`AI-studio/scripts/database/add_meitu_enable_in_workflow_field.py`
- 自动迁移：`AI-studio/test_server.py` 的 `migrate_database()` 函数

