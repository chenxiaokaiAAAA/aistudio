# 服务启动说明

## 架构说明

```
管理后台（192.168.2.54）
    ↓ HTTP请求
http://192.168.2.54:18888
    ↓
frp服务端（192.168.2.54:7000）
    ↓ 转发
frp客户端（sm003）
    ↓ 转发到本地
打印代理服务（sm003:127.0.0.1:8888）
    ↓ 调用
本地打印机（\\sm003\HP OfficeJet Pro 7730 series）
```

## 需要启动的服务

### 在 sm003（门店电脑）上需要启动：

#### 1. ✅ 打印代理服务（必须启动）

**作用：** 实际执行打印操作，连接打印机

**启动方式：**
```cmd
# 方式一：使用批处理文件
双击运行：start_print_proxy.bat

# 方式二：命令行
set LOCAL_PRINTER_PATH=\\sm003\HP OfficeJet Pro 7730 series
set PRINT_PROXY_PORT=8888
set PRINT_PROXY_API_KEY=test-key-123
python print_proxy_server.py
```

**验证：**
- 看到 "Running on http://0.0.0.0:8888" 表示启动成功
- 访问 http://127.0.0.1:8888/health 应该返回JSON响应

#### 2. ✅ frp客户端（必须启动）

**作用：** 将本地打印代理服务（8888端口）映射到服务端（18888端口）

**启动方式：**
```cmd
# 方式一：使用批处理文件
双击运行：启动客户端.bat

# 方式二：命令行
cd frp_0.66.0_windows_amd64
frpc.exe -c frpc.toml
```

**验证：**
- 看到 "login to server success" 表示连接成功
- 看到 "[print_proxy] start proxy success" 表示代理启动成功

---

### 在 192.168.2.54（服务端）上需要启动：

#### 3. ✅ frp服务端（必须启动）

**作用：** 接收客户端连接，转发请求

**启动方式：**
```cmd
# 方式一：使用批处理文件
双击运行：启动服务端.bat

# 方式二：命令行
cd frp_0.66.0_windows_amd64
frps.exe -c frps.toml
```

**验证：**
- 看到 "start frps success" 表示启动成功
- 看到 "[print_proxy] new proxy success" 表示客户端已连接

---

## 重要说明

### ❗ 为什么打印代理服务必须启动？

1. **frp只是网络转发工具**：frp客户端只是将网络请求转发到本地，但**不能直接打印**
2. **打印代理服务才是实际执行打印的程序**：它负责：
   - 接收打印请求
   - 处理图片/文档
   - 调用Windows打印API
   - 发送到打印机

### 如果只启动frp客户端，不启动打印代理服务会怎样？

- ✅ frp客户端可以成功连接到服务端
- ❌ 但管理后台发送打印请求时会失败
- ❌ 错误信息：连接被拒绝或超时

---

## 启动顺序建议

### 第一次启动（按顺序）：

1. **在 192.168.2.54 启动 frp服务端**
   ```
   运行：启动服务端.bat
   等待看到：start frps success
   ```

2. **在 sm003 启动打印代理服务**
   ```
   运行：start_print_proxy.bat
   等待看到：Running on http://0.0.0.0:8888
   ```

3. **在 sm003 启动 frp客户端**
   ```
   运行：启动客户端.bat
   等待看到：login to server success
   ```

4. **在管理后台配置并测试**
   ```
   地址：http://192.168.2.54:18888
   API密钥：test-key-123
   点击"测试打印"
   ```

---

## 日常使用

### 开机自启动（推荐）

为了确保服务持续运行，建议将以下服务设置为开机自启动：

#### sm003（门店电脑）：
1. **打印代理服务** - 使用NSSM设置为Windows服务
2. **frp客户端** - 使用NSSM设置为Windows服务

#### 192.168.2.54（服务端）：
1. **frp服务端** - 使用NSSM设置为Windows服务

---

## 故障排查

### 问题：测试打印失败

**检查清单：**

1. ✅ **打印代理服务是否运行？**
   - 在sm003上检查：`netstat -an | findstr 8888`
   - 应该看到：`TCP    0.0.0.0:8888          0.0.0.0:0              LISTENING`

2. ✅ **frp客户端是否运行？**
   - 查看客户端窗口，应该看到 "login to server success"

3. ✅ **frp服务端是否运行？**
   - 在192.168.2.54上检查：`netstat -an | findstr 7000`
   - 应该看到：`TCP    0.0.0.0:7000          0.0.0.0:0              LISTENING`

4. ✅ **管理后台配置是否正确？**
   - 地址：`http://192.168.2.54:18888`
   - API密钥：`test-key-123`（如果设置了）

### 问题：frp客户端连接失败

**可能原因：**
- frp服务端未启动
- 网络连接问题
- token不匹配

**解决：**
- 检查服务端是否运行
- 检查两个配置文件中的 `auth.token` 是否一致

---

## 总结

**必须启动的服务：**
1. ✅ sm003：打印代理服务（print_proxy_server.py）
2. ✅ sm003：frp客户端（frpc.exe）
3. ✅ 192.168.2.54：frp服务端（frps.exe）

**三个服务缺一不可！**
