# 快速部署到阿里云服务器

## 您的信息
- **服务器IP**: 121.43.143.59
- **GitHub Token**: `YOUR_GITHUB_TOKEN`
- **项目目录**: /root/project_code
- **数据目录**: /root/project_data

## 最简单的方式（3步完成）

### 步骤1：连接服务器

```bash
# 使用密码连接（如果忘记了SSH密钥）
ssh root@121.43.143.59
# 输入服务器密码
```

### 步骤2：在服务器上执行（复制粘贴以下命令）

```bash
# 设置GitHub Token
export GITHUB_TOKEN="YOUR_GITHUB_TOKEN"

# 进入项目目录
cd /root/project_code

# 克隆仓库（使用Token）
git clone https://${GITHUB_TOKEN}@github.com/chenxiaokaiAAAA/aistudio.git .

# 配置Git凭据（避免后续需要输入）
git config --global credential.helper store
echo "https://${GITHUB_TOKEN}@github.com" > ~/.git-credentials
chmod 600 ~/.git-credentials

# 执行自动部署
chmod +x scripts/deployment/deploy_aliyun.sh
GITHUB_TOKEN="${GITHUB_TOKEN}" scripts/deployment/deploy_aliyun.sh
```

### 步骤3：上传数据库和图片文件

**方式1：使用WinSCP（图形界面，最简单）**

1. 下载WinSCP：https://winscp.net/
2. 新建会话：
   - 文件协议：`SFTP`
   - 主机名：`121.43.143.59`
   - 端口：`22`
   - 用户名：`root`
   - 密码：输入服务器密码
3. 连接后，拖拽上传：
   - `instance/pet_painting.db` → `/root/project_code/instance/`
   - `uploads/` → `/root/project_data/user_images/`
   - `final_works/` → `/root/project_data/user_images/`
   - `hd_images/` → `/root/project_data/user_images/`

**方式2：使用PowerShell脚本**

```powershell
# 在本地PowerShell执行
powershell -ExecutionPolicy Bypass -File scripts\deployment\upload_to_aliyun.ps1
```

**方式3：使用SCP命令（需要密码）**

```powershell
# 上传数据库
scp instance/pet_painting.db root@121.43.143.59:/root/project_code/instance/

# 上传图片（先压缩）
Compress-Archive -Path uploads -DestinationPath uploads.zip
scp uploads.zip root@121.43.143.59:/root/project_data/

# 在服务器上解压
ssh root@121.43.143.59
cd /root/project_data
unzip uploads.zip -d user_images/
```

---

## 完整命令清单（复制粘贴）

### 在服务器上执行（一次性执行）

```bash
# ===== 设置GitHub Token =====
export GITHUB_TOKEN="YOUR_GITHUB_TOKEN"

# ===== 更新系统 =====
apt update && apt upgrade -y

# ===== 安装软件 =====
apt install -y python3 python3-pip python3-venv nginx git unzip

# ===== 创建目录 =====
mkdir -p /root/project_code
mkdir -p /root/project_data/user_images/{uploads,final_works,hd_images}
mkdir -p /root/project_data/logs
mkdir -p /root/project_data/backups

# ===== 克隆代码 =====
cd /root/project_code
git clone https://${GITHUB_TOKEN}@github.com/chenxiaokaiAAAA/aistudio.git .

# ===== 配置Git凭据 =====
git config --global credential.helper store
echo "https://${GITHUB_TOKEN}@github.com" > ~/.git-credentials
chmod 600 ~/.git-credentials

# ===== 创建虚拟环境 =====
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# ===== 创建必要目录 =====
mkdir -p logs uploads final_works hd_images static instance backups

# ===== 创建符号链接 =====
ln -sf /root/project_data/user_images/uploads uploads
ln -sf /root/project_data/user_images/final_works final_works
ln -sf /root/project_data/user_images/hd_images hd_images

# ===== 配置环境变量 =====
cat > .env << 'EOF'
FLASK_ENV=production
SERVER_ENV=production
SECRET_KEY=$(openssl rand -hex 32)
DATABASE_URL=sqlite:///instance/pet_painting.db
UPLOAD_FOLDER=/root/project_data/user_images/uploads
FINAL_FOLDER=/root/project_data/user_images/final_works
HD_FOLDER=/root/project_data/user_images/hd_images
EOF

# ===== 配置Nginx =====
cp config/nginx_linux.conf /etc/nginx/sites-available/aistudio
sed -i "s|/opt/aistudio|/root/project_code|g" /etc/nginx/sites-available/aistudio
sed -i "s|alias /opt/aistudio/uploads/|alias /root/project_data/user_images/uploads/|g" /etc/nginx/sites-available/aistudio
sed -i "s|alias /opt/aistudio/final_works/|alias /root/project_data/user_images/final_works/|g" /etc/nginx/sites-available/aistudio
sed -i "s|alias /opt/aistudio/hd_images/|alias /root/project_data/user_images/hd_images/|g" /etc/nginx/sites-available/aistudio
ln -sf /etc/nginx/sites-available/aistudio /etc/nginx/sites-enabled/
nginx -t
systemctl restart nginx

# ===== 创建Systemd服务 =====
cat > /etc/systemd/system/aistudio.service << 'EOF'
[Unit]
Description=AI Studio Gunicorn Application Server
After=network.target

[Service]
Type=notify
User=root
Group=root
WorkingDirectory=/root/project_code
Environment="PATH=/root/project_code/venv/bin"
EnvironmentFile=/root/project_code/.env
ExecStart=/root/project_code/venv/bin/python /root/project_code/start_production.py
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable aistudio

# ===== 配置防火墙 =====
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 22/tcp
ufw --force enable

# ===== 完成 =====
echo "部署完成！"
echo "下一步："
echo "  1. 上传数据库文件到 /root/project_code/instance/"
echo "  2. 上传图片文件到 /root/project_data/user_images/"
echo "  3. 启动服务: systemctl start aistudio"
```

---

## 启动服务

```bash
# 启动服务
systemctl start aistudio

# 查看状态
systemctl status aistudio

# 查看日志
journalctl -u aistudio -f
```

---

## 查找SSH密钥（如果需要）

如果以后需要使用SSH密钥，可以在以下位置查找：

```powershell
# Windows PowerShell搜索
Get-ChildItem -Path C:\Users\$env:USERNAME -Recurse -Filter "*.pem" -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\Users\$env:USERNAME -Recurse -Filter "*.key" -ErrorAction SilentlyContinue
```

常见位置：
- `C:\Users\您的用户名\.ssh\`
- `C:\Users\您的用户名\Downloads\`
- `C:\Users\您的用户名\Desktop\`
- 项目目录下的 `aliyun-key\` 文件夹
