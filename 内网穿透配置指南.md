# 内网穿透配置指南

## 问题说明

当前打印代理服务运行在门店本地，IP地址是 `192.168.2.186:8888`（内网IP）。  
阿里云服务器无法直接访问这个内网地址，需要配置内网穿透。

## 快速解决方案（推荐）

### 方案1：使用花生壳（最简单，国内服务）⭐ **推荐**

**优点：**
- 国内服务，速度快
- 操作简单，图形界面
- 有免费版（每月1GB流量，足够使用）

**步骤：**

1. **注册账号**
   - 访问：https://hsk.oray.com
   - 注册免费账号

2. **下载客户端**
   - 下载花生壳Windows客户端
   - 安装并登录

3. **添加内网映射**
   - 点击"内网映射" → "添加映射"
   - 配置如下：
     ```
     应用名称：打印代理服务
     应用图标：自定义
     内网主机：127.0.0.1
     内网端口：8888
     映射类型：HTTP
     外网域名：系统自动分配（如：xxxxx.gicp.net）
     外网端口：系统自动分配（如：12345）
     ```
   - 点击"保存"

4. **获取外网地址**
   - 映射成功后，会显示外网地址，例如：`http://xxxxx.gicp.net:12345`
   - 复制这个地址

5. **在阿里云配置**
   - 登录管理后台 → 打印配置
   - 填写"打印代理服务地址"：`http://xxxxx.gicp.net:12345`
   - 填写"打印代理服务API密钥"（如果设置了）
   - 点击"测试打印"验证

**注意事项：**
- 免费版每月1GB流量，超出后需要付费
- 外网地址和端口是固定的，不会变化
- 需要保持花生壳客户端运行

---

### 方案2：使用frp（免费开源，需要公网服务器）

**适用场景：** 如果您已经有一台阿里云服务器（或其他有公网IP的服务器）

**步骤：**

#### 2.1 在阿里云服务器安装frp服务端

```bash
# 下载frp（Linux版本）
wget https://github.com/fatedier/frp/releases/download/v0.52.3/frp_0.52.3_linux_amd64.tar.gz
tar -xzf frp_0.52.3_linux_amd64.tar.gz
cd frp_0.52.3_linux_amd64

# 编辑服务端配置 frps.ini
cat > frps.ini << EOF
[common]
bind_port = 7000
token = your-secret-token-123456  # 设置一个安全的token
EOF

# 启动服务端（后台运行）
nohup ./frps -c frps.ini > frps.log 2>&1 &
```

#### 2.2 在门店电脑安装frp客户端

1. **下载frp客户端（Windows版本）**
   - 访问：https://github.com/fatedier/frp/releases
   - 下载 `frp_0.52.3_windows_amd64.zip`
   - 解压到门店电脑

2. **编辑客户端配置 frpc.ini**
   ```ini
   [common]
   server_addr = 您的阿里云服务器公网IP  # 例如：47.xxx.xxx.xxx
   server_port = 7000
   token = your-secret-token-123456  # 与服务端一致

   [print_proxy]
   type = tcp
   local_ip = 127.0.0.1
   local_port = 8888
   remote_port = 18888  # 公网服务器上的端口
   ```

3. **启动客户端**
   ```bash
   # 在门店电脑运行
   frpc.exe -c frpc.ini
   ```

4. **在阿里云配置**
   - 登录管理后台 → 打印配置
   - 填写"打印代理服务地址"：`http://您的阿里云服务器IP:18888`
   - 例如：`http://47.xxx.xxx.xxx:18888`
   - 填写"打印代理服务API密钥"（如果设置了）
   - 点击"测试打印"验证

**注意事项：**
- 需要确保阿里云服务器防火墙开放 7000 和 18888 端口
- frp客户端需要保持运行（可以设置为Windows服务）

---

### 方案3：使用ZeroTier（VPN方案，完全免费）

**优点：**
- 完全免费，无流量限制
- 安全性高（加密VPN）
- 不需要公网服务器

**步骤：**

1. **注册账号**
   - 访问：https://www.zerotier.com
   - 注册免费账号

2. **创建网络**
   - 登录后，点击"Create A Network"
   - 复制 Network ID（例如：`a0b1c2d3e4f5g6h7`）

3. **在门店电脑安装ZeroTier**
   - 下载Windows客户端：https://www.zerotier.com/download/
   - 安装并运行
   - 点击"Join Network"，输入 Network ID
   - 在ZeroTier网站后台，勾选该设备授权（Authorize）

4. **在阿里云服务器安装ZeroTier**
   - 下载Linux客户端
   - 安装并加入同一个网络
   - 在ZeroTier网站后台授权

5. **获取门店电脑的ZeroTier IP**
   - 在门店电脑的ZeroTier客户端，查看分配的IP（例如：`10.147.20.100`）

6. **在阿里云配置**
   - 登录管理后台 → 打印配置
   - 填写"打印代理服务地址"：`http://10.147.20.100:8888`（ZeroTier IP）
   - 填写"打印代理服务API密钥"（如果设置了）
   - 点击"测试打印"验证

**注意事项：**
- 两台设备都需要安装ZeroTier并加入同一网络
- ZeroTier IP是虚拟IP，只在ZeroTier网络内有效

---

### 方案4：使用ngrok（简单但地址会变化）

**步骤：**

1. **注册账号**
   - 访问：https://ngrok.com
   - 注册免费账号

2. **获取authtoken**
   - 登录后，在Dashboard获取authtoken

3. **在门店电脑安装ngrok**
   ```bash
   # 下载ngrok: https://ngrok.com/download
   # 配置authtoken
   ngrok config add-authtoken YOUR_AUTHTOKEN
   
   # 启动隧道
   ngrok http 8888
   ```

4. **获取公网地址**
   - 会显示类似：`https://abc123.ngrok.io`
   - 复制这个地址

5. **在阿里云配置**
   - 登录管理后台 → 打印配置
   - 填写"打印代理服务地址"：`https://abc123.ngrok.io`
   - 填写"打印代理服务API密钥"（如果设置了）
   - 点击"测试打印"验证

**注意事项：**
- 免费版每次重启ngrok，地址会变化，需要重新配置
- 有流量限制

---

## 方案对比

| 方案 | 难度 | 费用 | 稳定性 | 推荐度 |
|------|------|------|--------|--------|
| 花生壳 | ⭐ 简单 | 免费（有限制） | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| frp | ⭐⭐⭐ 中等 | 免费 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| ZeroTier | ⭐⭐ 简单 | 免费 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| ngrok | ⭐ 简单 | 免费（有限制） | ⭐⭐⭐ | ⭐⭐⭐ |

## 推荐选择

- **如果您没有公网服务器**：推荐使用 **花生壳** 或 **ZeroTier**
- **如果您有阿里云服务器**：推荐使用 **frp**（可以复用现有服务器）
- **临时测试**：可以使用 **ngrok**

## 配置完成后测试

1. 确保打印代理服务正在运行（门店电脑）
2. 确保内网穿透工具正在运行
3. 在阿里云管理后台 → 打印配置 → 点击"测试打印"
4. 如果成功，会打印一张测试页

## 常见问题

### Q: 为什么阿里云无法访问 192.168.2.186:8888？
A: 因为这是内网IP，只能在局域网内访问。阿里云服务器在公网，无法直接访问内网地址。

### Q: 内网穿透会影响打印速度吗？
A: 会有轻微延迟（通常几十毫秒），但不会影响正常使用。

### Q: 哪个方案最稳定？
A: frp（自建服务器）最稳定，其次是花生壳。

### Q: 免费方案有流量限制吗？
A: 花生壳免费版每月1GB，ngrok免费版有流量限制，frp和ZeroTier无限制。

## 下一步

配置完成后，请：
1. 在阿里云管理后台配置打印代理服务地址
2. 测试打印功能
3. 将内网穿透工具设置为开机自启动（确保服务持续运行）
