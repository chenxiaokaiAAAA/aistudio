# 临时图混入订单问题分析报告

## 问题描述

加盟商下单的两个订单（PET17616535610004 和 PET17616528910004）中，混入了一张以前的临时图。

## 问题详情

### 订单1：PET17616528910004
- **订单创建时间**: 2025-10-28 20:01:31
- **客户**: EK/PN1483 小露
- **订单状态**: pending
- **图片来源**: franchisee（加盟商）

**订单包含的图片**:
1. ❌ **1761562338_0_ComfyUI_temp_rxjtz_00001_.jpg** - 临时图/AI生成图（不应该出现在订单中）
2. ✅ **1761652891_0_WechatIMG8141.jpg** - 正确上传的用户图片

### 订单2：PET17616535610004
- **订单创建时间**: 2025-10-28 20:12:41
- **客户**: EK/PN1483 小露
- **订单状态**: pending
- **图片来源**: franchisee（加盟商）

**订单包含的图片**:
1. ❌ **1761563558_0_00002_.png** - 旧文件的图片
2. ✅ **1761653561_0_1.jpg** - 正确上传的用户图片
3. ✅ **1761653561_1_2.jpg** - 正确上传的用户图片
4. ✅ **1761653561_2_3.jpg** - 正确上传的用户图片

## 问题分析

### 1. 临时图文件特征
- 文件名包含 `ComfyUI_temp_` 关键字
- 这是AI生成的效果图临时文件
- 时间戳: 1761562338 (对应时间: 2025-10-27 10:52:18)
- 该文件是在订单创建前一天生成的

### 2. 问题根本原因

**后端代码缺少文件名验证**（`franchisee_routes.py` 第553-562行）：

```python
# 保存图片
saved_filenames = []
for i, file in enumerate(files):
    if file and allowed_file(file.filename):
        filename = secure_filename(file.filename)
        timestamp = int(time.time())
        unique_filename = f"{timestamp}_{i}_{filename}"
        file_path = os.path.join(app.config['UPLOAD_FOLDER'], unique_filename)
        file.save(file_path)
        saved_filenames.append(unique_filename)
```

问题：
- 后端直接保存所有前端提交的文件
- 没有验证文件名的合法性
- 没有检查文件是否为临时图、AI生成图等不应该出现在订单中的文件
- 临时图文件的名称格式与正常上传的图片格式一致，所以没有被过滤

### 3. 可能的上传场景

加盟商在下单时，可能：
1. 艾特选了之前生成的AI效果图
2. 文件选择器显示了历史文件，无意中选择了临时图
3. 或者前端在某些情况下预填充了临时图

## 解决方案

### 已实施：添加文件名验证

修改文件：`franchisee_routes.py` 第553-571行

```python
# 保存图片
saved_filenames = []
for i, file in enumerate(files):
    if file and allowed_file(file.filename):
        filename = secure_filename(file.filename)
        
        # 检查文件名是否包含不应该出现在订单中的关键字
        # 防止临时图、AI生成的效果图等混入订单
        forbidden_keywords = ['ComfyUI_temp', '_temp_', 'ComfyUI', 'temp_temp']
        if any(keyword in filename for keyword in forbidden_keywords):
            print(f"⚠️ 检测到包含禁用关键字的文件名: {filename}, 跳过此文件")
            flash(f'文件 {filename} 包含非法字符，请重新上传正确的图片', 'warning')
            continue
        
        timestamp = int(time.time())
        unique_filename = f"{timestamp}_{i}_{filename}"
        file_path = os.path.join(app.config['UPLOAD_FOLDER'], unique_filename)
        file.save(file_path)
        saved_filenames.append(unique_filename)
```

### 实施效果

1. ✅ **自动检测临时图**: 当文件名包含禁用关键字时，自动跳过该文件
2. ✅ **用户提示**: 显示友好提示，告知用户需要重新上传正确的图片
3. ✅ **日志记录**: 在控制台记录检测到的非法文件名，便于排查问题
4. ✅ **保护现有数据**: 不影响现有订单，只防止新订单混入临时图

## 数据清理建议

### 需要手动处理的两笔订单

**订单 PET17616528910004**:
- 建议从 `order_image` 表中删除图片ID为124的记录
- ↔图片路径: `1761562338_0_ComfyUI_temp_rxjtz_00001_.jpg`

**订单 PET17616535610004**:
- 建议从 `order_image` 表中删除图片ID为125的记录
- 图片路径: `1761563558_0_00002_.png`

### 清理步骤

1. 连接到数据库
2. 删除 `order_image` 表中的非法图片记录
3. 更新订单的 `original_image` 字段（如果需要）

## 预防措施

### 1. 后端验证（已实施）
- 在文件保存前验证文件名
- 检查禁用关键字

### 2. 前端改进（建议）
- 在文件上传前验证文件名
- 提示用户不要选择临时图
- 限制文件选择器只显示有效文件

### 3. 文件管理（建议）
- 定期清理 uploads 文件夹中的临时图
- 将临时图存储到单独的临时文件夹
- 设置临时文件的过期时间

## 相关文件

- `franchisee_routes.py` - 加盟商下单逻辑
- `instance/pet_painting.db` - 数据库
- `uploads/` - 上传文件存储目录

## 报告日期

2025-10-28

