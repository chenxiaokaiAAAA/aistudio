# 用户昵称头像问题分析

## 问题描述
用户反馈：用户的昵称默认是"微信用户"，无法自动识别用户自己的微信名称跟头像。

## 问题分析

### 1. 当前用户信息获取流程

#### 小程序端 (moeart-wx)
1. **app.js** 中的 `getUserInfo()` 方法：
   - 使用 `wx.getSetting()` 检查授权状态
   - 如果已授权，调用 `wx.getUserInfo()` 获取用户信息
   - 调用 `registerUser()` 注册用户

2. **pages/mine/mine.js** 中的用户信息获取：
   - 使用 `getUserProfile()` 方法（新API）
   - 使用 `tryGetUserInfo()` 方法（兼容旧版本）
   - 设置默认用户信息为"微信用户"

#### 后端处理 (pet-painting-system)
1. **用户注册接口** `/api/user/register`：
   - 接收 `userInfo` 参数
   - 提取 `nickName` 和 `avatarUrl`
   - 存储到 `promotion_users` 表

### 2. 问题根源分析

#### 问题1: 微信API变更
- 微信小程序在2021年4月后，`wx.getUserInfo()` 不再返回用户信息
- 需要使用 `wx.getUserProfile()` 获取用户信息
- 但 `wx.getUserProfile()` 需要用户主动点击触发

#### 问题2: 授权流程问题
- 小程序启动时自动调用 `getUserInfo()` 可能失败
- 用户没有主动授权，导致获取不到真实用户信息
- 默认使用"微信用户"作为昵称

#### 问题3: 用户信息传递问题
- 前端获取到用户信息后，可能没有正确传递给后端
- 后端接收到的 `userInfo` 可能为空或默认值

### 3. 当前代码问题点

#### 小程序端问题
```javascript
// app.js 中的问题
getUserInfo: function() {
    wx.getSetting({
        success: res => {
            if (res.authSetting['scope.userInfo']) {
                // 这里可能获取不到用户信息（API已废弃）
                wx.getUserInfo({
                    success: res => {
                        this.globalData.userInfo = res.userInfo;
                        this.registerUser(res.userInfo); // 可能传递空信息
                    }
                });
            }
        }
    });
}
```

#### 后端处理问题
```python
# 后端可能接收到空的用户信息
nickname=user_info.get('nickName', ''),  # 默认为空字符串
avatar_url=user_info.get('avatarUrl', ''),  # 默认为空字符串
```

## 解决方案

### 方案1: 修复小程序端用户信息获取

#### 1.1 更新 app.js 中的用户信息获取逻辑
```javascript
// 新的用户信息获取方法
getUserInfo: function() {
    // 先尝试获取已授权的用户信息
    wx.getSetting({
        success: res => {
            if (res.authSetting['scope.userInfo']) {
                // 使用新的API获取用户信息
                wx.getUserProfile({
                    desc: '用于完善会员资料',
                    success: (res) => {
                        console.log('获取用户信息成功:', res.userInfo);
                        this.globalData.userInfo = res.userInfo;
                        this.registerUser(res.userInfo);
                    },
                    fail: (err) => {
                        console.log('获取用户信息失败:', err);
                        // 使用默认信息
                        this.registerUser({
                            nickName: '微信用户',
                            avatarUrl: '/images/default-avatar.png'
                        });
                    }
                });
            } else {
                // 未授权，使用默认信息
                this.registerUser({
                    nickName: '微信用户',
                    avatarUrl: '/images/default-avatar.png'
                });
            }
        }
    });
}
```

#### 1.2 在用户主动操作时获取真实信息
```javascript
// 在用户点击"我的"页面时获取真实用户信息
onShow() {
    // 检查是否需要更新用户信息
    this.checkAndUpdateUserInfo();
}

checkAndUpdateUserInfo() {
    const currentUserInfo = wx.getStorageSync('userInfo');
    if (!currentUserInfo || currentUserInfo.nickName === '微信用户') {
        // 提示用户授权获取真实信息
        this.showUserInfoAuthModal();
    }
}

showUserInfoAuthModal() {
    wx.showModal({
        title: '完善个人信息',
        content: '是否允许获取您的微信昵称和头像？',
        success: (res) => {
            if (res.confirm) {
                this.getUserProfile();
            }
        }
    });
}
```

### 方案2: 优化后端用户信息处理

#### 2.1 增强用户注册接口
```python
@app.route('/api/user/register', methods=['POST'])
def register_user():
    try:
        data = request.get_json()
        user_id = data.get('userId')
        user_info = data.get('userInfo', {})
        
        # 检查用户信息是否有效
        nickname = user_info.get('nickName', '').strip()
        avatar_url = user_info.get('avatarUrl', '').strip()
        
        # 如果用户信息为空或默认值，尝试从其他渠道获取
        if not nickname or nickname == '微信用户':
            # 可以尝试从微信接口获取用户信息
            nickname = get_user_nickname_from_wechat(user_id)
        
        if not avatar_url:
            avatar_url = '/static/images/default-avatar.png'
        
        # 创建用户时使用处理后的信息
        new_user = PromotionUser(
            user_id=user_id,
            nickname=nickname,
            avatar_url=avatar_url,
            # ... 其他字段
        )
        
    except Exception as e:
        # 错误处理
        pass
```

#### 2.2 添加用户信息更新接口
```python
@app.route('/api/user/update-info', methods=['POST'])
def update_user_info():
    """更新用户信息接口"""
    try:
        data = request.get_json()
        user_id = data.get('userId')
        user_info = data.get('userInfo', {})
        
        # 查找现有用户
        user = PromotionUser.query.filter_by(user_id=user_id).first()
        if user:
            # 更新用户信息
            if user_info.get('nickName'):
                user.nickname = user_info['nickName']
            if user_info.get('avatarUrl'):
                user.avatar_url = user_info['avatarUrl']
            
            db.session.commit()
            
            return jsonify({
                'success': True,
                'message': '用户信息更新成功'
            })
        else:
            return jsonify({
                'success': False,
                'message': '用户不存在'
            }), 404
            
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'更新失败: {str(e)}'
        }), 500
```

### 方案3: 添加用户信息管理功能

#### 3.1 在小程序中添加用户信息管理页面
```javascript
// 用户信息管理页面
Page({
    data: {
        userInfo: null,
        hasRealInfo: false
    },
    
    onLoad() {
        this.loadUserInfo();
    },
    
    loadUserInfo() {
        const userInfo = wx.getStorageSync('userInfo');
        this.setData({
            userInfo: userInfo,
            hasRealInfo: userInfo && userInfo.nickName !== '微信用户'
        });
    },
    
    updateUserInfo() {
        wx.getUserProfile({
            desc: '用于完善会员资料',
            success: (res) => {
                // 更新本地存储
                wx.setStorageSync('userInfo', res.userInfo);
                
                // 同步到后端
                this.syncUserInfoToServer(res.userInfo);
                
                this.setData({
                    userInfo: res.userInfo,
                    hasRealInfo: true
                });
                
                wx.showToast({
                    title: '信息更新成功',
                    icon: 'success'
                });
            },
            fail: (err) => {
                wx.showToast({
                    title: '获取信息失败',
                    icon: 'none'
                });
            }
        });
    },
    
    syncUserInfoToServer(userInfo) {
        wx.request({
            url: 'https://moeart.cc/api/user/update-info',
            method: 'POST',
            data: {
                userId: wx.getStorageSync('userId'),
                userInfo: userInfo
            },
            success: (res) => {
                console.log('用户信息同步成功:', res.data);
            },
            fail: (err) => {
                console.error('用户信息同步失败:', err);
            }
        });
    }
});
```

## 实施建议

### 优先级1: 立即修复
1. 更新小程序端的用户信息获取逻辑
2. 添加用户主动授权获取真实信息的入口
3. 优化后端用户信息处理

### 优先级2: 功能增强
1. 添加用户信息管理页面
2. 实现用户信息更新接口
3. 添加默认头像和昵称处理

### 优先级3: 用户体验优化
1. 添加用户信息完善提示
2. 实现渐进式信息收集
3. 添加用户信息验证机制

## 测试验证

### 测试步骤
1. 更新小程序代码
2. 测试新用户注册流程
3. 测试用户信息更新功能
4. 验证后端数据存储

### 预期结果
- 新用户注册时能获取到真实微信昵称和头像
- 现有用户可以更新个人信息
- 后端数据库存储正确的用户信息
- 分佣管理页面显示真实用户信息

## 总结

用户昵称和头像问题的根本原因是微信API变更和授权流程问题。通过更新用户信息获取逻辑、添加用户主动授权机制、优化后端处理，可以解决这个问题。

建议先实施优先级1的修复，然后逐步完善其他功能。
