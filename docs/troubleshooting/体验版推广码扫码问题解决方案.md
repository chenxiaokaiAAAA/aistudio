# 体验版推广码扫码问题解决方案

## 问题描述
用户反馈：A用户通过小程序生成推广码，后端已经生成了对应的小程序码，并携带推广信息，B用户扫A用户的小程序码，则没有任何信息携带，无法绑定推广关系。

## 问题分析

### 1. 后端生成的小程序码参数
从日志分析，后端生成的小程序码参数是正确的：
```json
{
  "scene": "p=PET2ZO0Q7&u=USER1758780888812",
  "page": "pages/index/index",
  "env_version": "trial",
  "width": 300,
  "auto_color": false,
  "line_color": {"r": 0, "g": 0, "b": 0}
}
```

### 2. 小程序码生成成功
- ✅ Scene参数长度符合要求: 31 <= 32
- ✅ 页面路径正确: pages/index/index
- ✅ 环境版本: trial (体验版)
- ✅ 小程序码生成成功，保存为: `static\qrcodes\qrcode_PET2ZO0Q7_USER1758780888812.jpg`

### 3. 理论上的扫码流程
1. 用户扫码进入体验版小程序
2. 小程序启动时，`app.js` 的 `onLaunch` 方法被调用
3. 检测到二维码场景 (scene: 1047)
4. 解析 `query.scene` 参数
5. 提取推广码和用户ID
6. 存储推广信息到本地
7. 调用推广追踪API

## 可能的问题原因

### 1. 体验版代码未更新
- 体验版小程序可能没有包含最新的推广功能代码
- 即使扫码进入体验版，也无法处理推广参数

### 2. 体验版配置问题
- 体验版的小程序配置可能有问题
- 推广功能无法正常工作

### 3. 体验版网络问题
- 体验版可能无法正常访问后端API
- 推广追踪API调用失败

### 4. 体验版存储问题
- 体验版可能无法正常使用本地存储
- 推广信息无法持久化保存

## 解决方案

### 方案1: 检查体验版代码更新
1. 确保体验版包含最新的 `app.js` 代码
2. 确认推广功能代码已部署到体验版
3. 验证体验版的版本号

### 方案2: 添加详细调试日志
在体验版 `app.js` 中添加以下调试代码：

```javascript
// 在onLaunch方法开始处添加
console.log('=== 体验版启动调试 ===');
console.log('启动参数:', options);
console.log('Scene值:', options.scene);
console.log('Query:', options.query);
console.log('Query.scene:', options.query ? options.query.scene : 'undefined');

// 在推广参数解析后添加
console.log('=== 推广参数解析结果 ===');
console.log('解析的推广码:', promotionCode);
console.log('解析的用户ID:', userId);
console.log('存储的推广信息:', {
    referrerUserId: wx.getStorageSync('referrerUserId'),
    referrerPromotionCode: wx.getStorageSync('referrerPromotionCode')
});
```

### 方案3: 测试API调用
1. 测试推广追踪API调用
2. 检查网络请求是否成功
3. 验证API响应数据

### 方案4: 检查存储功能
1. 测试 `wx.setStorageSync` 是否正常工作
2. 检查存储的推广信息是否正确
3. 验证数据持久性

## 立即执行的修复步骤

### 步骤1: 更新体验版代码
1. 将最新的 `app.js` 代码部署到体验版
2. 确保包含完整的推广功能逻辑
3. 验证代码更新成功

### 步骤2: 添加调试日志
1. 在体验版 `app.js` 中添加详细的调试日志
2. 记录所有启动参数和推广参数解析过程
3. 记录API调用和存储操作

### 步骤3: 重新测试
1. 重新生成推广码
2. 扫码进入体验版小程序
3. 查看小程序控制台输出
4. 检查推广信息是否正确存储

### 步骤4: 验证功能
1. 检查推广追踪API是否调用成功
2. 验证推广信息是否持久化保存
3. 测试用户注册时的推广关系绑定

## 调试代码示例

### 完整的调试版 app.js
```javascript
App({
  onLaunch: function (options) {
    console.log('🚀🚀🚀 体验版小程序启动！🚀🚀🚀');
    console.log('=== 体验版启动调试 ===');
    console.log('启动参数:', options);
    console.log('scene值:', options.scene);
    console.log('scene类型:', typeof options.scene);
    console.log('query参数:', options.query);
    console.log('query.scene值:', options.query ? options.query.scene : 'undefined');
    
    // 强制检查所有可能的参数
    console.log('=== 强制参数检查 ===');
    if (options.query) {
      console.log('query对象存在，检查所有属性:');
      for (const key in options.query) {
        console.log(`query.${key}:`, options.query[key]);
      }
    }
    
    // 检查是否有任何包含推广信息的参数
    const allParams = JSON.stringify(options);
    if (allParams.includes('PET2ZO0Q7') || allParams.includes('USER1758780888812')) {
      console.log('🎯 发现推广相关参数！');
      console.log('包含推广信息的参数:', allParams);
    }
    
    // 处理二维码启动场景（1047/1048/1049）
    if ((options.scene === 1047 || options.scene === 1048 || options.scene === 1049) && options.query && options.query.scene) {
      console.log('=== 处理二维码启动场景的推广参数 ===');
      console.log('发现query.scene参数:', options.query.scene);
      
      try {
        const scene = decodeURIComponent(options.query.scene);
        console.log('解码后的scene:', scene);
        
        // 手动解析scene参数（兼容性更好）
        const params = {};
        for (const item of scene.split('&')) {
          if (item.includes('=')) {
            const [key, value] = item.split('=', 2);
            params[key] = value;
          }
        }
        console.log('解析参数p:', params.p);
        console.log('解析参数u:', params.u);
        
        // 如果解析成功，存储推广信息
        const promotionCode = params.p;
        const userId = params.u;
        if (promotionCode && userId) {
          wx.setStorageSync('referrerUserId', userId);
          wx.setStorageSync('referrerPromotionCode', promotionCode);
          console.log('存储推广信息:', { userId, promotionCode });
          
          // 保存推广参数到全局数据，用于注册时传递
          this.globalData.promotionParams = `p=${promotionCode}&u=${userId}`;
          console.log('保存推广参数到全局数据:', this.globalData.promotionParams);
          
          // 立即调用推广追踪API，不等待弹窗
          console.log('🚀 立即调用推广追踪API');
          this.trackPromotion(promotionCode, userId);
          
          // 显示推广追踪窗口
          this.showPromotionTrackingWindow(promotionCode, userId);
        } else {
          console.error('推广参数解析失败:', { promotionCode, userId });
        }
      } catch (e) {
        console.error('解析scene参数失败:', e);
      }
    }
    
    // 强制测试：不管什么场景，只要有scene参数就尝试解析
    if (options.query && options.query.scene) {
      console.log('=== 强制测试scene参数解析 ===');
      console.log('当前scene值:', options.scene);
      console.log('强制测试scene参数:', options.query.scene);
      console.log('强制测试：忽略scene值，直接解析参数');
      
      try {
        const scene = decodeURIComponent(options.query.scene);
        console.log('强制解码后的scene:', scene);
        
        // 手动解析scene参数（兼容性更好）
        const params = {};
        for (const item of scene.split('&')) {
          if (item.includes('=')) {
            const [key, value] = item.split('=', 2);
            params[key] = value;
          }
        }
        console.log('强制解析参数p:', params.p);
        console.log('强制解析参数u:', params.u);
        
        const promotionCode = params.p;
        const userId = params.u;
        console.log('强制解析参数p:', promotionCode);
        console.log('强制解析参数u:', userId);
        
        if (promotionCode && userId) {
          console.log('✅ 强制解析成功，立即处理推广信息');
          this.trackPromotion(promotionCode, userId);
        }
      } catch (e) {
        console.error('强制解析scene参数失败:', e);
      }
    }
    
    // 检查全局推广参数
    if (this.globalData.promotionParams) {
      console.log('=== 检查全局推广参数 ===');
      console.log('全局推广参数:', this.globalData.promotionParams);
    }
  },

  // 推广追踪方法
  trackPromotion: function(promotionCode, referrerUserId) {
    console.log('=== 推广追踪API调用 ===');
    console.log('推广参数:', { promotionCode, referrerUserId });
    
    // 存储推广信息
    wx.setStorageSync('referrerUserId', referrerUserId);
    wx.setStorageSync('referrerPromotionCode', promotionCode);
    
    // 调用推广追踪API
    wx.request({
      url: 'https://photogooo/api/promotion/track',
      method: 'POST',
      data: {
        promotionCode: promotionCode,
        referrerUserId: referrerUserId,
        visitorUserId: wx.getStorageSync('userId') || 'UNKNOWN_USER',
        visitTime: new Date().getTime()
      },
      success: (res) => {
        console.log('✅ 推广追踪API调用成功:', res.data);
      },
      fail: (err) => {
        console.error('❌ 推广追踪API调用失败:', err);
      }
    });
  },

  // 显示推广追踪窗口
  showPromotionTrackingWindow: function(promotionCode, referrerUserId) {
    console.log('=== 显示推广追踪窗口 ===');
    console.log('推广码:', promotionCode);
    console.log('推荐人ID:', referrerUserId);
    
    wx.showModal({
      title: '推广追踪',
      content: `您通过推广码 ${promotionCode} 进入小程序\n推荐人将获得您的订单分佣\n\n推广信息已记录！`,
      showCancel: false,
      confirmText: '知道了'
    });
  },

  globalData: {
    userInfo: null,
    userId: null,
    promotionCode: null,
    promotionParams: null // 添加推广参数，用于注册时传递
  }
});
```

## 测试验证

### 测试步骤
1. 更新体验版代码，添加调试日志
2. 重新生成推广码
3. 扫码进入体验版小程序
4. 查看小程序控制台输出
5. 检查推广信息是否正确存储
6. 验证API调用是否成功

### 预期结果
- 控制台应该显示详细的启动参数
- 应该成功解析推广参数
- 应该成功存储推广信息
- 应该成功调用推广追踪API
- 应该显示推广追踪窗口

### 如果仍然失败
1. 检查体验版是否真的更新了代码
2. 检查网络连接是否正常
3. 检查后端API是否正常工作
4. 考虑修改 `env_version` 为 `release` 测试正式版

## 总结

问题很可能出在体验版小程序的代码更新上。建议：

1. **立即执行**: 更新体验版代码，添加详细调试日志
2. **重新测试**: 生成新的推广码并扫码测试
3. **查看日志**: 根据控制台输出定位具体问题
4. **逐步排查**: 从代码更新 → 参数解析 → 存储 → API调用

如果问题仍然存在，可以考虑修改后端的小程序码生成参数，将 `env_version` 改为 `release`，测试正式版是否正常工作。
