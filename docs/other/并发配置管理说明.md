# 并发配置管理说明

## 📋 概述

所有并发、队列、线程相关的配置都已集成到系统配置页面（`/admin/system-config`），可以在管理后台灵活调整，无需修改代码。

## ⚙️ 可配置项

### 1. ComfyUI最大并发数
- **配置键**：`comfyui_max_concurrency`
- **默认值**：10
- **范围**：1-50
- **说明**：同时处理ComfyUI任务的最大数量
- **建议值**：
  - 10台设备：10-15
  - 20台设备：15-20
  - 根据ComfyUI服务器性能调整

### 2. API最大并发数
- **配置键**：`api_max_concurrency`
- **默认值**：5
- **范围**：1-20
- **说明**：同时处理API任务的最大数量
- **建议值**：
  - 根据API服务商限流调整
  - 一般建议3-10

### 3. 任务队列最大大小
- **配置键**：`task_queue_max_size`
- **默认值**：100
- **范围**：10-500
- **说明**：任务队列能容纳的最大任务数
- **建议值**：
  - 40-50个排队任务：100
  - 100+个排队任务：200-300

### 4. 任务队列工作线程数
- **配置键**：`task_queue_workers`
- **默认值**：3
- **范围**：1-10
- **说明**：处理队列任务的工作线程数
- **建议值**：
  - 根据服务器CPU核心数调整
  - 一般建议3-5

## 🔧 配置方式

### 方式1：通过管理后台配置（推荐）

1. 登录管理后台
2. 访问：`/admin/system-config`
3. 找到"并发和队列配置"卡片
4. 修改相应配置值
5. 点击"保存并发和队列配置"
6. **重启服务**使配置生效

### 方式2：通过数据库直接修改

```sql
-- 更新ComfyUI并发数
UPDATE ai_config SET config_value = '15' WHERE config_key = 'comfyui_max_concurrency';

-- 更新API并发数
UPDATE ai_config SET config_value = '8' WHERE config_key = 'api_max_concurrency';

-- 更新队列大小
UPDATE ai_config SET config_value = '200' WHERE config_key = 'task_queue_max_size';

-- 更新工作线程数
UPDATE ai_config SET config_value = '5' WHERE config_key = 'task_queue_workers';
```

## ⚠️ 重要提示

### 配置生效方式

1. **信号量配置**（ComfyUI和API并发数）：
   - 配置保存在数据库后，**需要重启服务**才能生效
   - 因为信号量在服务启动时初始化

2. **队列配置**（队列大小和工作线程数）：
   - 配置保存在数据库后，**需要重启服务**才能生效
   - 因为队列在服务启动时初始化

### 配置建议

#### 10台设备场景
```json
{
  "comfyui_max_concurrency": 10,
  "api_max_concurrency": 5,
  "task_queue_max_size": 100,
  "task_queue_workers": 3
}
```

#### 20台设备场景
```json
{
  "comfyui_max_concurrency": 20,
  "api_max_concurrency": 8,
  "task_queue_max_size": 200,
  "task_queue_workers": 5
}
```

#### 高并发场景（50+设备）
```json
{
  "comfyui_max_concurrency": 30,
  "api_max_concurrency": 10,
  "task_queue_max_size": 300,
  "task_queue_workers": 8
}
```

## 🔍 配置读取逻辑

### 代码实现

所有配置都通过 `app/utils/config_loader.py` 统一读取：

```python
from app.utils.config_loader import get_int_config

# 读取ComfyUI并发数
comfyui_concurrency = get_int_config('comfyui_max_concurrency', 10)

# 读取API并发数
api_concurrency = get_int_config('api_max_concurrency', 5)
```

### 读取优先级

1. 从数据库 `ai_config` 表读取
2. 如果不存在，使用默认值
3. 应用启动时，如果配置不存在，会自动创建默认配置

## 📊 配置监控

### 查看当前配置

可以通过以下方式查看当前配置：

1. **管理后台**：访问 `/admin/system-config` 页面
2. **数据库查询**：
   ```sql
   SELECT config_key, config_value, description 
   FROM ai_config 
   WHERE config_key IN (
     'comfyui_max_concurrency',
     'api_max_concurrency',
     'task_queue_max_size',
     'task_queue_workers'
   );
   ```

### 查看队列统计

可以通过任务队列服务查看队列状态：

```python
from app.services.task_queue_service import get_queue_stats

stats = get_queue_stats()
print(f"队列大小: {stats['queue_size']}/{stats['queue_maxsize']}")
print(f"工作线程数: {stats['worker_count']}")
print(f"已处理: {stats['total_processed']}")
```

## 🚀 配置优化建议

### 根据服务器性能调整

- **CPU核心数**：工作线程数建议 = CPU核心数 - 1
- **内存大小**：队列大小建议根据内存情况调整
- **网络带宽**：API并发数根据网络带宽调整

### 根据业务量调整

- **设备数量**：ComfyUI并发数 ≈ 设备数量
- **排队任务数**：队列大小 = 预计最大排队数 × 1.5
- **任务处理时间**：工作线程数 = 预计并发任务数 ÷ 平均处理时间

## 📝 配置变更记录

建议在修改配置时记录变更原因：

1. 在配置描述中记录变更原因
2. 或者通过数据库记录变更日志

---

**文档版本**：v1.0  
**创建时间**：2025-01-XX  
**最后更新**：2025-01-XX
