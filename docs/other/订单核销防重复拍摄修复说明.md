# 订单核销防重复拍摄修复说明

## 问题描述

1. **核销页面高度问题**：页面内容与导航栏重叠，需要整体下移
2. **重复拍摄问题**：订单核销后可以重复拍摄，应该只能拍摄一次

## 修复内容

### 1. 核销页面高度修复

**文件：** `AI-小程序/pages/order/qrcode.wxss`

**修改内容：**
- 将导航栏改为 `position: fixed`，固定在顶部
- 为容器添加 `padding-top: 88rpx`，为导航栏留出空间
- 增加手动输入区域的顶部间距（`margin-top: 40rpx`）
- 为按钮区域和帮助区域添加左右边距

### 2. 后端订单检查逻辑 - 防止重复拍摄

**文件：** `AI-studio/test_server.py`

**修改位置：** `/api/miniprogram/order/check` 接口（`android_check_order` 函数）

**修改内容：**
- 检查订单是否已经有照片（`OrderImage` 记录）
- 如果订单已经有照片，返回错误信息："该订单已经拍摄过，不能重复拍摄"
- 返回 `success: False` 和 `has_photos: True` 字段

**代码逻辑：**
```python
# 检查订单是否已经拍摄过（已有照片）
images = OrderImage.query.filter_by(order_id=order.id).all()
has_photos = len(images) > 0

# 如果订单已经有照片，说明已经拍摄过，不能再拍摄
if has_photos:
    return jsonify({
        'success': False,
        'message': '该订单已经拍摄过，不能重复拍摄',
        'order': {
            'order_id': order.order_number,
            'status': order.status,
            'is_paid': is_paid,
            'has_photos': True,
            'photos': image_urls
        }
    }), 400
```

### 3. 安卓APP需要处理的逻辑

**注意：** 安卓APP需要检查后端返回的 `success` 字段和 `has_photos` 字段

**建议修改位置：** `OrderActivity.java` 或 `ScanActivity.java`

**需要添加的检查：**
```java
// 检查订单是否已经拍摄过
if (response.has("has_photos") && response.getBoolean("has_photos")) {
    // 显示提示：该订单已经拍摄过，不能重复拍摄
    showMessage("该订单已经拍摄过，不能重复拍摄");
    return;
}
```

## 需要重启的服务

### 后端服务（必须重启）
```bash
cd AI-studio
python start.py
```

### 小程序（需要重新编译）
在微信开发者工具中：
1. 点击"清除缓存"
2. 点击"编译"按钮（或按 `Ctrl+B`）

### 安卓APP（需要重新编译）
在Android Studio中：
1. 点击 "Build" → "Rebuild Project"
2. 或者直接运行APP

## 测试步骤

### 1. 测试页面高度
- 进入小程序，打开订单列表
- 点击"核销"按钮
- 验证：页面内容不再与导航栏重叠，整体布局正常

### 2. 测试防重复拍摄

**第一次拍摄：**
1. 在小程序中创建订单
2. 在安卓APP中扫描二维码或输入订单号
3. 应该能正常进入拍摄页面
4. 拍摄并上传照片
5. 上传成功后，订单应该已经有照片

**第二次尝试拍摄（应该被阻止）：**
1. 在安卓APP中再次扫描同一个订单的二维码或输入订单号
2. 后端应该返回错误：`success: False, message: '该订单已经拍摄过，不能重复拍摄'`
3. 安卓APP应该显示错误提示，不允许进入拍摄页面

## 注意事项

1. **订单状态判断**：
   - 后端检查订单是否有照片（`OrderImage` 记录）
   - 如果有照片，说明已经拍摄过，不能再拍摄

2. **安卓APP处理**：
   - 需要检查后端返回的 `success` 字段
   - 如果 `success: false` 且 `has_photos: true`，应该显示错误提示
   - 不应该允许进入拍摄页面

3. **订单状态更新**：
   - 照片上传成功后，订单状态会更新为 `completed`
   - 但防重复拍摄主要检查是否有照片，而不是订单状态

## 后续优化建议

1. **添加订单状态字段**：
   - 可以考虑添加一个 `shooting_status` 字段（`not_started`, `shooting`, `completed`）
   - 更明确地标识订单的拍摄状态

2. **安卓APP错误处理**：
   - 完善错误提示，显示具体的错误原因
   - 区分"订单未支付"、"订单已拍摄"等不同错误
