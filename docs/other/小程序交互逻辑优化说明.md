# 小程序交互逻辑优化说明

## 修复内容

### 1. 修复风格库图片显示问题

**问题：** 风格库图片无法显示，因为代码将HTTP转换为HTTPS，但本地服务器只支持HTTP。

**修复：**
- `pages/style/style.js`：使用 `convertToHttps` 工具函数（本地环境保持HTTP）
- `pages/style/style-detail/style-detail.js`：使用 `convertToHttps` 工具函数
- `pages/custom/select-style/select-style.js`：已经使用 `convertToHttps`，无需修改

### 2. 调整产品馆交互逻辑

**需求：**
- 产品馆作为主入口
- **已绑定风格库的产品**：显示风格库选择页面，只显示该产品绑定的风格主题
- **未绑定风格库的产品**：直接进入提交订单页面（跳过风格选择）

**修复：**

#### 2.1 产品馆页面 (`pages/product/product.js`)

**修改 `startCustom` 方法：**
```javascript
// 判断产品是否绑定了风格库
const hasStyleBindings = product && (
  (product.style_category_codes && product.style_category_codes.length > 0) ||
  (product.style_category_ids && product.style_category_ids.length > 0) ||
  (product.allowed_styles && product.allowed_styles.length > 0)
);

if (hasStyleBindings) {
  // 产品绑定了风格库，跳转到选择风格页面
  wx.navigateTo({
    url: '/pages/custom/select-style/select-style'
  });
} else {
  // 产品没有绑定风格库，直接进入提交订单页面
  wx.navigateTo({
    url: '/pages/custom/confirm-order/confirm-order'
  });
}
```

**修改 `startCustomFromModal` 方法：**
- 同样添加产品类型判断
- 保存完整产品信息（包含绑定关系）到 `app.globalData.currentProduct`

#### 2.2 风格选择页面 (`pages/custom/select-style/select-style.js`)

**修改 `loadStyles` 方法：**
1. 检查是否从产品馆进入
2. 如果从产品馆进入，调用API时传递 `productId` 参数
3. 后端根据 `productId` 返回该产品绑定的风格分类
4. 前端过滤显示，只显示绑定的风格分类

**代码：**
```javascript
// 如果从产品馆进入，传递产品ID参数以获取绑定的风格分类
let apiUrl = `${config.getApiBaseUrl()}/styles`;
if (selectedProduct && currentProduct) {
  const productId = currentProduct.code || currentProduct.id || selectedProduct;
  apiUrl += `?productId=${productId}`;
  console.log('从产品馆进入，请求绑定的风格分类，产品ID:', productId);
}
```

### 3. 后端API支持产品过滤

**修改：** `AI-studio/test_server.py` 的 `/api/miniprogram/styles` 接口

**新增功能：**
- 支持 `productId` 查询参数
- 如果指定了 `productId`，只返回该产品绑定的风格分类
- 如果没有指定，返回所有风格分类（兼容直接访问风格库的情况）

**代码：**
```python
@app.route('/api/miniprogram/styles', methods=['GET'])
def miniprogram_get_styles():
    """获取所有风格分类和图片，支持按产品过滤"""
    try:
        # 获取产品ID参数（可选）
        product_id = request.args.get('productId') or request.args.get('product_id')
        
        # 如果指定了产品ID，只返回该产品绑定的风格分类
        if product_id:
            product = Product.query.filter_by(code=product_id, is_active=True).first()
            if product:
                bindings = ProductStyleCategory.query.filter_by(product_id=product.id).all()
                bound_category_ids = [binding.style_category_id for binding in bindings]
                
                if bound_category_ids:
                    categories = StyleCategory.query.filter(
                        StyleCategory.id.in_(bound_category_ids),
                        StyleCategory.is_active == True
                    ).order_by(StyleCategory.sort_order).all()
                else:
                    categories = []
            else:
                categories = StyleCategory.query.filter_by(is_active=True).order_by(StyleCategory.sort_order).all()
        else:
            categories = StyleCategory.query.filter_by(is_active=True).order_by(StyleCategory.sort_order).all()
        # ... 后续处理
```

## 需要重启的服务

### 后端服务（必须重启）
```bash
cd AI-studio
python start.py
```

### 小程序（需要重新编译）
在微信开发者工具中：
1. 点击"编译"按钮（或按 `Ctrl+B`）
2. 或者：点击"清除缓存" → "重新编译"

## 修复后的流程

### 1. 已绑定风格库的产品流程
1. 用户在产品馆选择产品（如"证件照"、"AI写真"等，只要绑定了风格库）
2. 选择规格
3. **跳转到风格选择页面**（只显示该产品绑定的风格分类）
4. 选择风格
5. 跳转到确认订单页面
6. 填写订单信息
7. 提交订单

### 2. 未绑定风格库的产品流程
1. 用户在产品馆选择产品（未绑定风格库的产品）
2. 选择规格
3. **直接跳转到确认订单页面**（跳过风格选择）
4. 填写订单信息
5. 提交订单

### 3. 直接访问风格库
1. 用户直接点击"风格库"菜单
2. **显示所有风格分类**（不进行产品过滤）
3. 选择风格后，跳转到产品选择页面

## 测试步骤

1. **测试已绑定风格库的产品**：
   - 进入产品馆
   - 选择一个已绑定风格库的产品（如"证件照"、"AI写真"等）
   - 选择规格
   - 应该进入风格选择页面
   - 应该只显示该产品绑定的风格分类

2. **测试未绑定风格库的产品**：
   - 进入产品馆
   - 选择一个未绑定风格库的产品
   - 选择规格
   - 应该直接进入确认订单页面（不显示风格选择）

3. **测试直接访问风格库**：
   - 直接点击"风格库"菜单
   - 应该显示所有风格分类
   - 图片应该正常显示

4. **测试图片显示**：
   - 所有页面的图片应该正常显示
   - 本地环境使用HTTP，生产环境使用HTTPS

## 注意事项

1. **产品绑定关系**：
   - 产品与风格分类的绑定关系在管理后台配置
   - 通过 `ProductStyleCategory` 表管理
   - 前端通过产品的 `style_category_codes` 字段获取绑定关系

2. **产品绑定关系判断**：
   - 通过产品的 `style_category_codes`、`style_category_ids` 或 `allowed_styles` 字段判断
   - 如果这些字段存在且长度大于0，说明产品绑定了风格库
   - 产品与风格分类的绑定关系在管理后台配置（`ProductStyleCategory` 表）

3. **风格库直接访问**：
   - 直接访问风格库时，不传递 `productId` 参数
   - 后端返回所有风格分类
   - 兼容旧版本的访问方式
