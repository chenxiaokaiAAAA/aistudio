# 代码拆分说明

## 已完成的拆分

### 1. payment.js 拆分（高优先级）

已创建以下模块：

#### 1.1 订单创建模块
**文件：** `utils/payment/order-creator.js`

**功能：**
- `createOrder()` - 创建订单（单个或分组）
- `createOrderGroup()` - 创建分组订单（多个二级分类时）

**使用方式：**
```javascript
const OrderCreator = require('../../utils/payment/order-creator');

OrderCreator.createOrder({
  currentOrder: this.data.orderInfo,
  openid: openid,
  skipPayment: SKIP_REAL_PAYMENT,
  pageData: this.data,
  onSuccess: (result) => {
    // 订单创建成功
    if (result.shouldCreatePayment) {
      // 创建支付
    }
  },
  onFail: (error) => {
    // 订单创建失败
  }
});
```

#### 1.2 支付处理模块
**文件：** `utils/payment/payment-handler.js`

**功能：**
- `createPayment()` - 创建支付订单
- `notifyBackendCompleteFreeOrder()` - 通知后端完成0元订单

**使用方式：**
```javascript
const PaymentHandler = require('../../utils/payment/payment-handler');

PaymentHandler.createPayment({
  currentOrder: currentOrder,
  openid: openid,
  finalAmount: this.data.finalAmount,
  discountAmount: this.data.discountAmount,
  selectedCoupon: this.data.selectedCoupon,
  skipPayment: SKIP_REAL_PAYMENT,
  onSuccess: (result) => {
    // 支付成功
  },
  onFail: (error) => {
    // 支付失败
  }
});
```

#### 1.3 优惠券处理模块
**文件：** `utils/payment/coupon-handler.js`

**功能：**
- `loadAvailableCoupons()` - 加载可用优惠券
- `selectBestCoupon()` - 选择最优优惠券
- `checkSelectedCoupon()` - 检查选择的优惠券
- `clearSelectedCoupon()` - 清除优惠券选择

**使用方式：**
```javascript
const CouponHandler = require('../../utils/payment/coupon-handler');

// 加载优惠券
CouponHandler.loadAvailableCoupons(
  this.data.originalAmount,
  (result) => {
    this.setData({
      availableCoupons: result.availableCoupons,
      selectedCoupon: result.selectedCoupon,
      discountAmount: result.discountAmount,
      finalAmount: result.finalAmount
    });
  },
  (error) => {
    console.error('加载优惠券失败:', error);
  }
);
```

#### 1.4 订单类型选择模块
**文件：** `utils/payment/order-mode-selector.js`

**功能：**
- `updateOrderMode()` - 更新订单类型
- `confirmOrderMode()` - 确认订单类型（支付成功后）

**使用方式：**
```javascript
const OrderModeSelector = require('../../utils/payment/order-mode-selector');

OrderModeSelector.confirmOrderMode({
  orderMode: this.data.selectedOrderMode,
  orderNumbers: this.data.createdOrderNumbers,
  onSuccess: (result) => {
    // 订单类型更新成功
    if (result.isMultipleOrders) {
      // 多个订单：跳转到订单列表
    } else {
      // 单个订单：跳转到成功页面
    }
  },
  onFail: (error) => {
    // 订单类型更新失败
  }
});
```

## 下一步工作

### 2. 重构 payment.js 使用新模块

需要修改 `pages/payment/payment.js`，将原来的函数调用替换为模块调用。

**示例：**
```javascript
// 原来的代码
this.createOrderFirst(currentOrder, openid, skipPayment);

// 改为
const OrderCreator = require('../../utils/payment/order-creator');
OrderCreator.createOrder({
  currentOrder: currentOrder,
  openid: openid,
  skipPayment: skipPayment,
  pageData: this.data,
  onSuccess: (result) => {
    if (result.shouldCreatePayment) {
      this.createPaymentAfterOrder(currentOrder, openid, skipPayment);
    }
  }
});
```

### 3. 继续拆分其他文件

- `pages/product-detail/product-detail.js` - 提取样式选择、尺寸选择逻辑
- `pages/cart/cart.js` - 提取分组逻辑到工具函数
- `utils/api.js` - 完善API调用封装

## 注意事项

1. **保持向后兼容**：重构时确保原有功能不受影响
2. **逐步替换**：先创建模块，再逐步替换原代码
3. **测试验证**：每次拆分后都要测试功能是否正常
