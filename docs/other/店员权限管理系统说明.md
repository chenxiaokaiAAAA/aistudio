# 店员权限管理系统说明

## 功能概述

店员权限管理系统允许加盟商管理员为门店店员配置不同的权限，实现精细化的权限控制。店员可以通过手机号或openid进行匹配，配置不同的查看权限。

## 功能特点

1. **灵活的匹配方式**：支持通过手机号或openid匹配用户，建议优先使用手机号
2. **细粒度权限控制**：可以配置不同的权限项（查看今天的订单、查看门店图片等）
3. **类似加盟商管理**：作为加盟商管理页面下的子用户管理，逻辑清晰

## 数据库表结构

### StaffUser（店员用户表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| franchisee_id | Integer | 关联的加盟商ID（外键） |
| phone | String(20) | 手机号（优先使用） |
| openid | String(100) | 微信openid（备用） |
| name | String(50) | 姓名 |
| role | String(50) | 角色（staff店员、manager经理、supervisor主管） |
| permissions | Text | 权限配置（JSON格式） |
| status | String(20) | 状态（active正常、inactive停用） |
| notes | Text | 备注信息 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 权限配置（permissions字段，JSON格式）

```json
{
  "view_today_orders": true,      // 查看今天的订单
  "view_store_images": true,      // 查看门店用户生成的图片
  "view_all_orders": false,        // 查看全部订单
  "view_statistics": false,        // 查看统计数据
  "groupon_verify": true           // 团购核销（在小程序中生成团购核销优惠券）
}
```

## 使用说明

### 1. 创建数据库表

运行数据库迁移脚本：

```bash
python scripts/创建店员用户表.py
```

### 2. 在管理后台配置店员权限

1. 进入 **加盟商管理** → 选择加盟商 → **详情页**
2. 点击 **子用户管理** 标签页
3. 点击 **添加子用户** 按钮
4. 填写信息：
   - **手机号**（推荐）：用于匹配用户，建议优先使用
   - **OpenID**：如果未填写手机号，则必须填写openid
   - **姓名**：店员姓名
   - **角色**：选择角色（店员/经理/主管）
   - **权限配置**：勾选相应的权限项
     - ✅ 查看今天的订单
     - ✅ 查看门店用户生成的图片
     - ✅ 查看全部订单
     - ✅ 查看统计数据
     - ✅ **团购核销**（重要：只有勾选此权限的店员才能在小程序中看到"团购核销"入口）
   - **备注**：可选
5. 点击 **保存**

### 3. 编辑和删除店员

- **编辑**：在子用户列表中点击 **编辑** 按钮，可以修改店员信息和权限
- **删除**：点击 **删除** 按钮，确认后删除该店员

## 权限说明

### 权限项详解

1. **查看今天的订单** (`view_today_orders`)
   - 可以查看该加盟商今天的订单记录
   - 适用于需要查看当日订单的店员

2. **查看门店用户生成的图片** (`view_store_images`)
   - 可以查看该门店用户生成的图片
   - 适用于需要查看客户图片的店员

3. **查看全部订单** (`view_all_orders`)
   - 可以查看该加盟商的所有订单记录（不限时间）
   - 适用于需要查看历史订单的经理或主管

4. **查看统计数据** (`view_statistics`)
   - 可以查看该加盟商的统计数据
   - 适用于需要查看业务数据的经理或主管

5. **团购核销** (`groupon_verify`)
   - 可以在小程序中生成团购核销优惠券
   - 适用于需要处理团购订单核销的店员
   - 只有具有此权限的店员才能在小程序的"我的"页面看到"团购核销"入口

## 匹配逻辑

系统会按照以下优先级匹配用户：

1. **优先使用手机号**：如果配置了手机号，系统会优先通过手机号匹配用户
2. **备用openid**：如果未配置手机号，则使用openid进行匹配
3. **至少需要一种**：必须至少配置手机号或openid之一

## API接口

### 获取店员信息

```python
# 通过手机号查找店员
staff = StaffUser.query.filter_by(
    franchisee_id=franchisee_id,
    phone=phone
).first()

# 通过openid查找店员
staff = StaffUser.query.filter_by(
    franchisee_id=franchisee_id,
    openid=openid
).first()
```

### 检查权限

```python
import json

# 解析权限
permissions = json.loads(staff.permissions) if staff.permissions else {}

# 检查权限
if permissions.get('view_today_orders'):
    # 允许查看今天的订单
    pass
```

## 注意事项

1. **手机号优先**：建议优先使用手机号进行匹配，更便于管理
2. **唯一性约束**：同一加盟商下，手机号或openid不能重复
3. **权限验证**：在实际使用中，需要在相应的API接口中验证店员权限
4. **状态管理**：可以通过设置状态为 `inactive` 来停用店员，而不需要删除

## 后续开发

权限验证逻辑需要在相应的API接口中实现，例如：

- 订单查询API：根据 `view_today_orders` 或 `view_all_orders` 权限过滤订单
- 图片查看API：根据 `view_store_images` 权限过滤图片
- 统计API：根据 `view_statistics` 权限控制访问
- **团购核销API**：已实现，根据 `groupon_verify` 权限控制访问（`/api/miniprogram/groupon/verify`）

## 相关文件

- 模型定义：`aistudio/app/models.py` (StaffUser类)
- 路由定义：`aistudio/app/routes/staff_permission.py`
- 模板文件：
  - `aistudio/templates/admin/staff_list.html` - 店员列表
  - `aistudio/templates/admin/staff_add.html` - 添加店员
  - `aistudio/templates/admin/staff_edit.html` - 编辑店员
- 数据库迁移：`aistudio/scripts/创建店员用户表.py`
