# 登录授权页面文档

## 页面概述

登录授权页面是小程序的入口页面，采用海马体风格设计，包含隐私保护协议弹窗和自动注册功能。

**页面路径**: `pages/login/login`

## 功能特性

### 1. 隐私保护协议
- 首次打开小程序时显示隐私保护协议弹窗
- 用户必须同意协议才能继续使用
- 协议状态保存在本地存储中

### 2. 自动授权注册
- 用户同意协议后，自动获取微信openid
- 自动生成用户ID和推广码
- 自动注册用户到后端系统
- 注册成功后自动跳转到首页

### 3. 海马体风格设计
- 绿色渐变背景（#a8e6cf → #7dd3a0 → #5cb88d）
- 抽象装饰元素动画
- 白色圆角弹窗
- 绿色同意按钮，灰色不同意按钮

## 页面结构

### WXML结构
```
login-page
├── bg-container (背景容器)
│   ├── bg-gradient (渐变背景)
│   └── bg-decoration (装饰元素)
├── content-wrapper (主内容)
│   └── brand-section (品牌区域)
│       ├── brand-logo (Logo)
│       ├── brand-name (品牌名称)
│       └── brand-slogan (品牌标语)
├── privacy-modal (隐私协议弹窗)
│   └── modal-content
│       ├── modal-header (标题)
│       ├── modal-body (内容)
│       └── modal-footer (按钮)
├── loading-mask (加载遮罩)
└── footer-brand (底部品牌标识)
```

## 核心方法

### 1. onLoad(options)
页面加载时执行：
- 检查是否已登录
- 检查是否已同意隐私协议
- 显示隐私协议弹窗或开始授权流程

### 2. handleAgree()
用户点击"同意"按钮：
- 保存同意状态到本地存储
- 关闭弹窗
- 开始授权和注册流程

### 3. handleDisagree()
用户点击"不同意"按钮：
- 显示提示信息
- 保持弹窗显示

### 4. startAuthAndRegister()
开始授权和注册流程：
1. 获取openId
2. 生成用户ID和推广码
3. 获取用户信息（可选）
4. 注册用户到后端
5. 保存到本地存储
6. 跳转到首页

### 5. getOpenId()
获取微信openId：
- 先检查本地存储
- 调用wx.login获取code
- 请求后端接口获取openId
- 支持多种响应格式

### 6. getUserProfile()
获取用户信息（可选）：
- 使用wx.getUserProfile
- 不强制要求，失败时使用默认信息

### 7. generateUserInfo(openId)
生成用户ID和推广码：
- 基于openId生成稳定的用户信息
- 使用userGenerator工具

### 8. registerUser(data)
注册用户到后端：
- 发送用户信息到后端API
- 包含userId、promotionCode、openId等

## 数据存储

### 本地存储字段
- `hasAgreedPrivacy`: 是否已同意隐私协议
- `openId`: 微信openId
- `userId`: 用户ID
- `promotionCode`: 推广码
- `isRegistered`: 是否已注册
- `userInfo`: 用户信息（可选）

## 样式设计

### 颜色方案
- **主背景**: 绿色渐变 (#a8e6cf → #7dd3a0 → #5cb88d)
- **弹窗背景**: 白色 (#fff)
- **同意按钮**: 绿色渐变 (#5cb88d → #7dd3a0)
- **不同意按钮**: 灰色 (#f5f5f5)
- **文字颜色**: 
  - 标题: #333
  - 正文: #666
  - 链接: #5cb88d

### 动画效果
- 背景装饰元素浮动动画
- 弹窗滑入动画
- 品牌区域淡入动画

## API接口

### 1. 获取openId
```
POST /api/user/openid
Body: { code: string }
Response: { success: true, openid: string }
```

### 2. 注册用户
```
POST /api/user/register
Body: {
  userId: string,
  promotionCode: string,
  openId: string,
  userInfo: object,
  phoneNumber: string,
  promotion_params: object
}
Response: { success: true }
```

## 错误处理

1. **获取openId失败**: 显示错误提示，允许重试
2. **注册失败**: 显示错误提示，允许重试
3. **用户拒绝授权**: 使用默认用户信息继续注册

## 页面跳转

- **成功注册后**: 使用`wx.switchTab`跳转到首页
- **switchTab失败**: 使用`wx.reLaunch`作为降级方案

## 注意事项

1. 隐私协议弹窗只在首次打开时显示
2. 用户信息获取是可选的，不强制要求
3. 所有关键数据都会保存到本地存储
4. 注册流程是自动的，用户无需手动操作

## 维护说明

### 修改隐私政策内容
编辑 `login.wxml` 中的 `modal-text` 部分

### 修改品牌信息
编辑 `login.wxml` 中的 `brand-section` 部分

### 修改样式
编辑 `login.wxss` 文件，主要修改：
- `.bg-gradient`: 背景渐变颜色
- `.modal-content`: 弹窗样式
- `.btn-agree`: 同意按钮样式

### 修改API接口
编辑 `login.js` 中的：
- `getOpenId()`: openId接口地址
- `registerUser()`: 注册接口地址

## 版本历史

- **v1.0.0** (2024-01-XX): 初始版本，海马体风格设计
