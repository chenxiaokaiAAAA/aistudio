# 登录流程重构说明（海马体风格）

## 概述

按照海马体小程序的登录逻辑，重构了登录流程，分为两个阶段：
1. **隐私保护授权**：首次打开小程序时的隐私协议确认
2. **用户登录注册**：提交订单前的登录/注册流程

## 页面结构

### 1. 隐私保护页面（pages/login/login）

**功能**：
- 只做隐私保护协议确认
- 不涉及任何用户注册或openID注册
- 同意后直接进入首页

**流程**：
1. 首次打开小程序，检查是否已同意隐私协议
2. 如果未同意，显示隐私协议弹窗
3. 用户点击"同意"后，保存同意状态
4. 直接跳转到首页

**文件位置**：
- `pages/login/login.wxml`
- `pages/login/login.js`
- `pages/login/login.wxss`
- `pages/login/login.json`

### 2. 登录注册页面（pages/auth-login/auth-login）

**功能**：
- 当用户准备提交订单时弹出
- 提供两种登录方式：
  - **快捷登录**：获取手机号授权，自动登录/注册
  - **手机号安全登录**：跳转到手机号登录页面

**流程**：
1. 用户点击"快捷登录"
2. 获取微信手机号授权
3. 调用后端接口获取手机号
4. 检查用户是否已注册
5. 如果已注册，直接登录；如果未注册，自动注册
6. 登录成功后返回之前的页面

**文件位置**：
- `pages/auth-login/auth-login.wxml`
- `pages/auth-login/auth-login.js`
- `pages/auth-login/auth-login.wxss`
- `pages/auth-login/auth-login.json`

### 3. 手机号登录页面（pages/phone-login/phone-login）

**功能**：
- 输入手机号
- 同意隐私协议
- 发送验证码

**流程**：
1. 用户输入手机号
2. 检查是否同意隐私协议（未同意时显示弹窗）
3. 点击提交按钮，发送验证码
4. 跳转到验证码输入页面

**文件位置**：
- `pages/phone-login/phone-login.wxml`
- `pages/phone-login/phone-login.js`
- `pages/phone-login/phone-login.wxss`
- `pages/phone-login/phone-login.json`

### 4. 验证码输入页面（pages/verify-code/verify-code）

**功能**：
- 输入4位验证码
- 自动验证
- 重新发送验证码

**流程**：
1. 显示手机号（部分隐藏）
2. 用户输入4位验证码
3. 输入完成后自动验证
4. 验证成功后，检查用户是否已注册
5. 如果已注册，直接登录；如果未注册，自动注册
6. 登录成功后返回之前的页面

**文件位置**：
- `pages/verify-code/verify-code.wxml`
- `pages/verify-code/verify-code.js`
- `pages/verify-code/verify-code.wxss`
- `pages/verify-code/verify-code.json`

## 登录状态检查

在以下页面提交订单前会检查登录状态：
- `pages/custom/confirm-order/confirm-order.js`
- `pages/order/order.js`
- `pages/shop-detail/shop-detail.js`

**检查逻辑**：
```javascript
checkLoginStatus() {
  const userId = wx.getStorageSync('userId');
  const userPhone = wx.getStorageSync('userPhone');
  return !!(userId && userPhone);
}
```

**未登录处理**：
- 显示提示弹窗
- 用户确认后跳转到登录页面
- 保存当前页面路径作为返回URL
- 登录成功后自动返回

## 数据存储

### 本地存储字段

- `hasAgreedPrivacy`: 是否已同意隐私协议
- `userId`: 用户ID
- `userPhone`: 用户手机号
- `openId`: 微信openId
- `promotionCode`: 推广码
- `isRegistered`: 是否已注册

## API接口

### 1. 获取手机号
```
POST /api/user/getPhoneNumber
Body: { code: string }
Response: { success: true, phoneNumber: string }
```

### 2. 检查用户是否存在
```
POST /api/user/check
Body: { phoneNumber: string, openId: string }
Response: { success: true, exists: boolean, userId: string }
```

### 3. 发送短信验证码
```
POST /api/user/sendSmsCode
Body: { phoneNumber: string }
Response: { success: true }
```

### 4. 验证短信验证码
```
POST /api/user/verifySmsCode
Body: { phoneNumber: string, code: string }
Response: { success: true }
```

### 5. 用户注册
```
POST /api/user/register
Body: {
  userId: string,
  promotionCode: string,
  openId: string,
  phoneNumber: string,
  userInfo: object
}
Response: { success: true }
```

## 页面跳转流程

### 快捷登录流程
```
订单页面 → 登录页面 → 获取手机号授权 → 自动注册/登录 → 返回订单页面
```

### 手机号安全登录流程
```
订单页面 → 登录页面 → 手机号登录页面 → 验证码页面 → 自动注册/登录 → 返回订单页面
```

## 注意事项

1. **隐私协议**：首次打开小程序时必须同意，后续不再显示
2. **登录时机**：只在提交订单时检查登录状态
3. **自动注册**：未注册用户会自动完成注册
4. **返回逻辑**：登录成功后自动返回之前的页面
5. **页面路径**：使用`returnUrl`参数保存返回路径

## 维护说明

### 修改登录页面样式
编辑对应的 `.wxss` 文件

### 修改登录逻辑
编辑对应的 `.js` 文件

### 添加新的登录方式
1. 创建新页面
2. 在 `app.json` 中注册
3. 在 `auth-login` 页面添加入口

## 版本历史

- **v2.0.0** (2024-01-XX): 重构登录流程，采用海马体风格
