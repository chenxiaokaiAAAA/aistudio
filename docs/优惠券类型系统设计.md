# 优惠券类型系统设计文档

## 一、优惠券类型分类

### 1. 基础类型（现有）
- **discount** - 折扣券：按百分比折扣
- **cash** - 现金券：固定金额减免
- **free** - 免费券：无门槛免费拍摄

### 2. 新增类型
- **groupon_verify** - 团购核销券：通过团购平台购买，到店核销后生成
- **share_reward** - 分享奖励券：用户分享作品，朋友下单后双方获得
- **random_code** - 随机码免拍券：门店核销后生成的随机码券

## 二、优惠券来源（source_type）

### 1. 系统发放（system）
- 新用户注册券
- 活动优惠券
- 系统自动发放

### 2. 团购核销（groupon）
- 团购平台购买
- 门店核销后生成

### 3. 分享奖励（share）
- 分享作品给朋友
- 朋友下单后获得

### 4. 门店生成（store）
- 门店工作人员手动生成
- 随机码免拍券

## 三、团购核销流程

### 1. 流程说明
1. 用户在团购平台购买优惠券
2. 用户到门店核销
3. 门店工作人员在管理后台：
   - 选择"团购核销"功能
   - 输入团购订单信息
   - 输入核销金额
   - 系统自动生成随机码免拍券
4. 生成二维码供用户扫码领取
5. 用户扫码领取优惠券

### 2. 数据模型扩展
- `Coupon.source_type` - 优惠券来源类型
- `Coupon.groupon_order_id` - 团购订单ID（可选）
- `Coupon.verify_amount` - 核销金额（团购券使用）
- `Coupon.is_random_code` - 是否为随机码券
- `Coupon.qr_code_url` - 领取二维码URL

## 四、分享领券机制

### 1. 流程说明
1. 用户分享作品给朋友（通过小程序分享功能）
2. 朋友通过分享链接进入小程序
3. 朋友下单后：
   - 分享者获得分享奖励券（可配置金额）
   - 被分享者获得新用户优惠券（可配置金额）
4. 优惠券自动发放到账户

### 2. 数据模型扩展
- `Coupon.share_reward_amount` - 分享奖励金额
- `Coupon.share_reward_type` - 分享奖励类型（分享者/被分享者）
- `ShareRecord` - 分享记录表（记录分享关系）

## 五、优惠券选择逻辑

### 1. 优先级规则
1. **第一优先级**：无门槛拍摄券（min_amount = 0）
   - 优先选择金额最大的无门槛券
2. **第二优先级**：有门槛券中优惠金额最大的
   - 计算实际可优惠金额
   - 选择优惠金额最大的券

### 2. 选择算法
```python
def select_best_coupon(user_coupons, order_amount):
    # 1. 筛选可用优惠券
    available = filter_available_coupons(user_coupons, order_amount)
    
    # 2. 优先选择无门槛券
    no_threshold = [c for c in available if c.min_amount == 0]
    if no_threshold:
        return max(no_threshold, key=lambda c: c.value)
    
    # 3. 选择优惠金额最大的券
    return max(available, key=lambda c: calculate_discount(c, order_amount))
```

## 六、订单核销二维码

### 1. 功能说明
- 0元支付成功后，自动生成订单核销二维码
- 用户可到机器上扫码核销拍摄
- 二维码包含订单号、验证码等信息

### 2. 实现方式
- 订单支付成功后生成二维码
- 二维码内容：订单号 + 验证码
- 机器端扫码验证订单有效性

## 七、数据库表结构扩展

### 1. Coupon表扩展字段
```sql
ALTER TABLE coupons ADD COLUMN source_type VARCHAR(20) DEFAULT 'system' COMMENT '来源类型';
ALTER TABLE coupons ADD COLUMN groupon_order_id VARCHAR(100) COMMENT '团购订单ID';
ALTER TABLE coupons ADD COLUMN verify_amount DECIMAL(10,2) COMMENT '核销金额';
ALTER TABLE coupons ADD COLUMN is_random_code BOOLEAN DEFAULT FALSE COMMENT '是否随机码券';
ALTER TABLE coupons ADD COLUMN qr_code_url VARCHAR(500) COMMENT '领取二维码URL';
ALTER TABLE coupons ADD COLUMN share_reward_amount DECIMAL(10,2) COMMENT '分享奖励金额';
ALTER TABLE coupons ADD COLUMN share_reward_type VARCHAR(20) COMMENT '分享奖励类型';
```

### 2. 新增ShareRecord表
```sql
CREATE TABLE share_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    sharer_user_id VARCHAR(50) NOT NULL COMMENT '分享者用户ID',
    shared_user_id VARCHAR(50) COMMENT '被分享者用户ID',
    share_type VARCHAR(20) DEFAULT 'work' COMMENT '分享类型：work作品分享',
    work_id INT COMMENT '作品ID',
    order_id INT COMMENT '下单订单ID',
    sharer_coupon_id INT COMMENT '分享者获得的优惠券ID',
    shared_coupon_id INT COMMENT '被分享者获得的优惠券ID',
    status VARCHAR(20) DEFAULT 'pending' COMMENT '状态：pending待下单, completed已完成',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_sharer (sharer_user_id),
    INDEX idx_shared (shared_user_id),
    INDEX idx_order (order_id)
);
```

## 八、管理后台功能

### 1. 优惠券类型管理
- 创建不同类型的优惠券
- 设置优惠券来源
- 配置分享奖励规则

### 2. 团购核销功能
- 团购订单核销界面
- 生成随机码免拍券
- 生成领取二维码

### 3. 分享奖励配置
- 配置分享者奖励金额
- 配置被分享者奖励金额
- 查看分享记录

### 4. 优惠券统计
- 按类型统计发放数量
- 按来源统计使用情况
- 分享奖励统计
