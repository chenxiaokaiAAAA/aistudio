# 测试扩展计划

**目标**: 将测试覆盖率从30%提升到>70%  
**当前状态**: 12个测试用例  
**目标状态**: 100+个测试用例

---

## 📊 当前测试覆盖情况

### 已完成的测试 ✅

1. **模型测试** (`tests/test_models.py`) - 4个测试
   - ✅ User模型创建和关联
   - ✅ Order模型创建和状态转换

2. **工具函数测试** (`tests/test_utils.py`) - 8个测试
   - ✅ 字符串清理
   - ✅ 手机号验证
   - ✅ 邮箱验证
   - ✅ URL验证
   - ✅ 订单号验证
   - ✅ 搜索查询清理（SQL注入防护）
   - ✅ 文件名清理（路径遍历防护）
   - ✅ 分页参数验证

3. **异常处理测试** (`tests/test_exceptions.py`) - 新增
   - ✅ APIError基类
   - ✅ ValidationError
   - ✅ AuthenticationError
   - ✅ PermissionError
   - ✅ NotFoundError
   - ✅ ServerError
   - ✅ handle_api_error函数

4. **装饰器测试** (`tests/test_decorators.py`) - 新增
   - ✅ admin_required装饰器
   - ✅ operator_required装饰器
   - ✅ admin_api_required装饰器
   - ✅ handle_api_errors装饰器

**当前总计**: 约20个测试用例

---

## 🎯 测试扩展计划

### 第一阶段：核心工具和工具函数测试（优先级：高）

#### 1. 扩展validators测试 ✅ 部分完成
- [x] 基础验证函数测试（已完成）
- [ ] 边界情况测试
- [ ] 特殊字符处理测试
- [ ] 性能测试（大量数据）

#### 2. 配置服务测试
- [ ] `app/utils/config_service.py`
  - [ ] 配置加载优先级测试
  - [ ] 环境变量覆盖测试
  - [ ] 数据库配置读取测试
  - [ ] 默认值回退测试

#### 3. 日志配置测试
- [ ] `app/utils/logger_config.py`
  - [ ] 日志级别配置测试
  - [ ] 文件日志测试
  - [ ] 日志轮转测试
  - [ ] 生产/开发环境日志差异测试

#### 4. 性能优化工具测试
- [ ] `app/utils/performance_optimizer.py`
  - [ ] 图片压缩测试
  - [ ] 缩略图生成测试
  - [ ] 缓存响应头测试
  - [ ] ETag生成测试

### 第二阶段：业务逻辑测试（优先级：高）

#### 1. 认证和授权测试
- [ ] `app/routes/auth.py`
  - [ ] 登录功能测试
  - [ ] 登出功能测试
  - [ ] 密码验证测试
  - [ ] 会话管理测试

#### 2. 订单管理测试
- [ ] `app/routes/admin_orders_*.py`
  - [ ] 订单列表查询测试
  - [ ] 订单详情查询测试
  - [ ] 订单状态更新测试
  - [ ] 订单筛选和分页测试

#### 3. 产品管理测试
- [ ] `app/routes/admin_products_api.py`
  - [ ] 产品创建测试
  - [ ] 产品更新测试
  - [ ] 产品删除测试
  - [ ] 产品列表查询测试

#### 4. 用户管理测试
- [ ] `app/routes/admin_users_api.py`
  - [ ] 用户列表查询测试
  - [ ] 用户创建测试
  - [ ] 用户更新测试
  - [ ] 权限管理测试

### 第三阶段：API接口集成测试（优先级：中）

#### 1. 小程序API测试
- [ ] `app/routes/miniprogram/`
  - [ ] 产品列表API测试
  - [ ] 订单创建API测试
  - [ ] 用户信息API测试
  - [ ] 支付相关API测试

#### 2. 管理后台API测试
- [ ] `app/routes/admin_*.py`
  - [ ] 仪表板统计API测试
  - [ ] 数据导出API测试
  - [ ] 配置管理API测试

#### 3. AI任务API测试
- [ ] `app/routes/ai_*.py`
  - [ ] AI任务创建测试
  - [ ] AI任务查询测试
  - [ ] AI任务状态更新测试

### 第四阶段：服务和工具测试（优先级：中）

#### 1. 缓存服务测试
- [ ] `app/services/cache_service.py`
  - [ ] 缓存设置和获取测试
  - [ ] 缓存失效测试
  - [ ] 缓存装饰器测试
  - [ ] Redis连接失败处理测试

#### 2. 文件上传服务测试
- [ ] `app/services/file_upload_service.py`
  - [ ] 文件上传测试
  - [ ] 图片压缩测试
  - [ ] 文件类型验证测试
  - [ ] 文件大小限制测试

#### 3. AI提供者服务测试
- [ ] `app/services/ai_provider_service.py`
  - [ ] API调用测试
  - [ ] 错误处理测试
  - [ ] 重试机制测试

### 第五阶段：边界和错误处理测试（优先级：低）

#### 1. 错误处理测试
- [ ] 数据库连接失败测试
- [ ] Redis连接失败测试
- [ ] 文件系统错误测试
- [ ] 网络请求超时测试

#### 2. 边界情况测试
- [ ] 空数据测试
- [ ] 大数据量测试
- [ ] 并发请求测试
- [ ] 内存限制测试

#### 3. 安全测试
- [ ] SQL注入防护测试
- [ ] XSS防护测试
- [ ] CSRF防护测试
- [ ] 权限绕过测试

---

## 📝 测试用例编写规范

### 1. 测试文件命名
- 测试文件: `test_<module_name>.py`
- 测试类: `Test<ClassName>`
- 测试方法: `test_<functionality>`

### 2. 测试结构
```python
# -*- coding: utf-8 -*-
"""
模块功能测试
"""
import pytest
from app.module import function

class TestFunction:
    """功能测试类"""
    
    def test_normal_case(self):
        """测试正常情况"""
        result = function(input)
        assert result == expected
    
    def test_edge_case(self):
        """测试边界情况"""
        # ...
    
    def test_error_case(self):
        """测试错误情况"""
        with pytest.raises(ExpectedError):
            function(invalid_input)
```

### 3. 测试覆盖要求
- **单元测试**: 覆盖所有公共函数
- **集成测试**: 覆盖主要API端点
- **边界测试**: 覆盖边界情况和错误情况
- **性能测试**: 覆盖关键性能路径

---

## 🛠️ 测试工具配置

### 1. pytest配置 ✅
- [x] `pytest.ini` 已配置
- [x] 测试标记已定义
- [x] 日志配置已设置

### 2. 测试覆盖率工具
```bash
# 运行测试并生成覆盖率报告
pytest tests/ --cov=app --cov-report=html --cov-report=term

# 查看覆盖率报告
# HTML报告: htmlcov/index.html
# 终端报告: 直接显示在终端
```

### 3. 持续集成配置（可选）
- [ ] GitHub Actions配置
- [ ] 自动运行测试
- [ ] 覆盖率报告上传

---

## 📈 进度跟踪

### 当前进度
- **已完成**: 20个测试用例
- **目标**: 100+个测试用例
- **覆盖率**: 约30%
- **目标覆盖率**: >70%

### 下一步行动
1. ✅ 配置代码规范检查工具（black, flake8）
2. ⏳ 扩展validators测试（边界情况）
3. ⏳ 添加配置服务测试
4. ⏳ 添加认证和授权测试
5. ⏳ 添加订单管理测试

---

## 🎯 里程碑

### 里程碑1：工具函数测试完成（目标：40个测试用例）
- [x] 异常处理测试
- [x] 装饰器测试
- [ ] validators扩展测试
- [ ] 配置服务测试
- [ ] 日志配置测试

### 里程碑2：业务逻辑测试完成（目标：70个测试用例）
- [ ] 认证和授权测试
- [ ] 订单管理测试
- [ ] 产品管理测试
- [ ] 用户管理测试

### 里程碑3：API集成测试完成（目标：100个测试用例）
- [ ] 小程序API测试
- [ ] 管理后台API测试
- [ ] AI任务API测试

### 里程碑4：完整测试覆盖（目标：>70%覆盖率）
- [ ] 所有核心功能测试
- [ ] 边界情况测试
- [ ] 错误处理测试
- [ ] 性能测试

---

**最后更新**: 2026-02-06  
**负责人**: 开发团队  
**预计完成时间**: 2-3周
