# 订单状态流转说明

## 状态定义

订单状态按照以下流程依次流转：

1. **paid** (已支付) - 客户下单并完成支付
2. **shooting** (正在拍摄) - 客户上传照片/自拍机拍摄完成
3. **retouching** (美颜处理中) - 美颜API处理中
4. **ai_processing** (AI任务处理中) - AI任务创建并处理中
5. **pending_selection** (待选片) - AI任务完成，等待客户选片
6. **selection_completed** (已选片) - 客户完成选片
7. **printing** (打印中) - 开始打印
8. **pending_shipment** (待发货) - 打印完成，等待发货
9. **shipped** (已发货) - 已发货

## 状态流转触发条件

### 1. paid (已支付)
- **触发时机**：客户下单并完成支付
- **初始状态**：新订单默认状态为 `paid`
- **相关字段**：`payment_time` 设置为支付时间

### 2. shooting (正在拍摄)
- **触发时机**：
  - 小程序上传照片完成
  - 自拍机上传照片完成
- **相关字段**：`shooting_completed_at` 设置为拍摄完成时间

### 3. retouching (美颜处理中)
- **触发时机**：
  - 美颜API任务创建
  - 后台上传精修图
- **相关字段**：`retouch_completed_at` 设置为美颜完成时间

### 4. ai_processing (AI任务处理中)
- **触发时机**：
  - AI任务创建（create_api_task）
  - 美颜完成后自动创建AI任务
- **说明**：可能有多个AI任务，所有任务完成后才进入下一状态

### 5. pending_selection (待选片)
- **触发时机**：
  - 所有AI任务完成（status='completed'）
  - 有至少一张效果图生成
- **说明**：此时客户可以开始选片

### 6. selection_completed (已选片)
- **触发时机**：
  - 客户完成选片并提交
  - 创建ShopOrder记录
- **相关字段**：选片信息保存在ShopOrder表中

### 7. printing (打印中)
- **触发时机**：
  - 开始打印（本地打印或远程打印）
  - 打印任务提交成功
- **说明**：区分电子照片打印和实物产品打印

### 8. pending_shipment (待发货)
- **触发时机**：
  - 打印完成
  - 准备发货
- **说明**：等待录入物流信息

### 9. shipped (已发货)
- **触发时机**：
  - 录入物流信息
  - 发货单号填写完成
- **相关字段**：`logistics_info` 保存物流信息

## 状态映射（向后兼容）

为了兼容旧数据，保留以下状态映射：

- `pending` -> `paid` (待支付/待处理)
- `processing` -> `ai_processing` (处理中)
- `manufacturing` -> `printing` (制作中/打印中)
- `completed` -> `selection_completed` (已完成/已选片)
- `shipped` -> `shipped` (已发货，保持不变)
- `hd_ready` -> `pending_selection` (高清图就绪/待选片)

## 状态显示名称

| 状态值 | 显示名称 | 说明 |
|--------|---------|------|
| paid | 已支付 | 客户已支付 |
| shooting | 正在拍摄 | 拍摄进行中 |
| retouching | 美颜处理中 | 美颜API处理中 |
| ai_processing | AI任务处理中 | AI任务处理中 |
| pending_selection | 待选片 | 等待客户选片 |
| selection_completed | 已选片 | 客户已完成选片 |
| printing | 打印中 | 打印进行中 |
| pending_shipment | 待发货 | 等待发货 |
| shipped | 已发货 | 已发货 |

## 注意事项

1. **状态只能向前流转**：不能从后面的状态回退到前面的状态
2. **状态可以跳过**：某些订单可能跳过某些状态（如不需要美颜的订单）
3. **状态检查**：在更新状态前，应该检查当前状态是否允许更新到目标状态
