# é¡¹ç›®é‡æ„è¯´æ˜æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜é‡æ„åçš„é¡¹ç›®ç»“æ„ã€æ¨¡å—èŒè´£å’Œå¼€å‘æŒ‡å—ã€‚é‡æ„å°†åŸæœ¬çš„ `test_server.py`ï¼ˆ11000+è¡Œï¼‰æ‹†åˆ†ä¸ºæ¨¡å—åŒ–ç»“æ„ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

---

## ğŸ“ é¡¹ç›®ç›®å½•ç»“æ„

```
AI-studio/
â”œâ”€â”€ app/                          # åº”ç”¨æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py              # Flaskåº”ç”¨åˆå§‹åŒ–ï¼ˆBlueprintæ³¨å†Œï¼‰
â”‚   â”œâ”€â”€ models.py                # æ•°æ®åº“æ¨¡å‹ï¼ˆ25ä¸ªæ¨¡å‹ç±»ï¼‰
â”‚   â”œâ”€â”€ routes/                   # è·¯ç”±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ admin.py             # ç®¡ç†åå°è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ miniprogram.py       # å°ç¨‹åºAPIè·¯ç”±
â”‚   â”‚   â”œâ”€â”€ order.py             # è®¢å•è·¯ç”±
â”‚   â”‚   â””â”€â”€ payment.py           # æ”¯ä»˜è·¯ç”±
â”‚   â”œâ”€â”€ services/                 # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ order_service.py     # è®¢å•ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ payment_service.py   # æ”¯ä»˜ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ helpers.py           # é€šç”¨å·¥å…·å‡½æ•°
â”‚       â””â”€â”€ image_utils.py       # å›¾ç‰‡å¤„ç†å·¥å…·
â”‚
â”œâ”€â”€ test_server.py               # ä¸»å…¥å£æ–‡ä»¶ï¼ˆå‘åå…¼å®¹ï¼‰
â”œâ”€â”€ start.py                      # å¯åŠ¨è„šæœ¬
â”‚
â”œâ”€â”€ config/                       # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ config.yml
â”‚   â””â”€â”€ nginx.conf
â”‚
â”œâ”€â”€ data/                         # æ•°æ®æ–‡ä»¶
â”‚   â”œâ”€â”€ backups/                 # æ•°æ®åº“å¤‡ä»½
â”‚   â”œâ”€â”€ exports/                 # å¯¼å‡ºæ•°æ®
â”‚   â””â”€â”€ reports/                 # æŠ¥å‘Šæ–‡ä»¶
â”‚
â”œâ”€â”€ docs/                         # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ api/                     # APIæ–‡æ¡£
â”‚   â”œâ”€â”€ database/                # æ•°æ®åº“æ–‡æ¡£
â”‚   â”œâ”€â”€ deployment/              # éƒ¨ç½²æ–‡æ¡£
â”‚   â”œâ”€â”€ features/                # åŠŸèƒ½æ–‡æ¡£
â”‚   â””â”€â”€ é¡¹ç›®é‡æ„è¯´æ˜.md          # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ scripts/                      # è„šæœ¬ç›®å½•
â”‚   â”œâ”€â”€ database/                # æ•°æ®åº“è„šæœ¬
â”‚   â”œâ”€â”€ tools/                   # å·¥å…·è„šæœ¬
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ batch/                        # æ‰¹å¤„ç†æ–‡ä»¶
â”‚   â”œâ”€â”€ setup/                   # å®‰è£…è„šæœ¬
â”‚   â”œâ”€â”€ maintenance/             # ç»´æŠ¤è„šæœ¬
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ static/                       # é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ css/
â”‚   â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ images/
â”‚   â””â”€â”€ uploads/
â”‚
â”œâ”€â”€ templates/                    # HTMLæ¨¡æ¿
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ logs/                         # æ—¥å¿—æ–‡ä»¶
    â”œâ”€â”€ app.log
    â””â”€â”€ error.log
```

---

## ğŸ—ï¸ æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. `app/models.py` - æ•°æ®åº“æ¨¡å‹

**èŒè´£**ï¼šå®šä¹‰æ‰€æœ‰æ•°æ®åº“æ¨¡å‹ç±»

**åŒ…å«çš„æ¨¡å‹**ï¼ˆ25ä¸ªï¼‰ï¼š
- `Product`, `ProductSize`, `ProductSizePetOption`, `ProductImage`, `ProductStyleCategory`, `ProductCustomField`
- `StyleCategory`, `StyleImage`
- `HomepageBanner`, `WorksGallery`, `HomepageConfig`
- `User`, `UserVisit`
- `Order`, `OrderImage`
- `PhotoSignup`
- `PromotionUser`, `Commission`, `Withdrawal`, `PromotionTrack`
- `Coupon`, `UserCoupon`
- `FranchiseeAccount`, `FranchiseeRecharge`, `SelfieMachine`

**ä½¿ç”¨æ–¹å¼**ï¼š
```python
from app.models import Order, OrderImage, Product
# æˆ–ä» test_server å¯¼å…¥ï¼ˆå‘åå…¼å®¹ï¼‰
from test_server import Order, OrderImage
```

---

### 2. `app/routes/` - è·¯ç”±æ¨¡å—

#### 2.1 `app/routes/admin.py` - ç®¡ç†åå°è·¯ç”±

**èŒè´£**ï¼šç®¡ç†åå°ç›¸å…³çš„æ‰€æœ‰è·¯ç”±

**ä¸»è¦è·¯ç”±**ï¼š
- `/admin/dashboard` - ç®¡ç†åå°é¦–é¡µ
- `/admin/order/<id>` - è®¢å•è¯¦æƒ…
- `/admin/styles` - é£æ ¼ç®¡ç†
- `/admin/sizes` - å°ºå¯¸ç®¡ç†
- `/admin/homepage` - é¦–é¡µé…ç½®
- `/admin/works-gallery` - ä½œå“å±•ç¤º
- `/admin/photo-signups` - æ‘„å½±æŠ¥å
- `/admin/merchants` - å•†å®¶ç®¡ç†
- `/admin/orders/export` - è®¢å•å¯¼å‡º

**Blueprintåç§°**ï¼š`admin_bp`  
**URLå‰ç¼€**ï¼š`/admin`

---

#### 2.2 `app/routes/miniprogram.py` - å°ç¨‹åºAPIè·¯ç”±

**èŒè´£**ï¼šå°ç¨‹åºç›¸å…³çš„æ‰€æœ‰APIæ¥å£

**ä¸»è¦è·¯ç”±**ï¼š
- `/api/miniprogram/orders` (POST) - æäº¤è®¢å•
- `/api/miniprogram/orders` (GET) - è·å–è®¢å•åˆ—è¡¨
- `/api/miniprogram/order/<order_number>` - è·å–è®¢å•è¯¦æƒ…
- `/api/miniprogram/order/qrcode` - ç”Ÿæˆè®¢å•äºŒç»´ç 
- `/api/miniprogram/order/check` - æ£€æŸ¥è®¢å•çŠ¶æ€ï¼ˆAndroid Appæ ¸é”€ï¼‰
- `/api/miniprogram/order/upload` - ä¸Šä¼ ç…§ç‰‡ï¼ˆAndroid Appæ‹æ‘„åå›ä¼ ï¼‰
- `/api/miniprogram/products` - è·å–äº§å“åˆ—è¡¨
- `/api/miniprogram/styles` - è·å–é£æ ¼åˆ—è¡¨
- `/api/miniprogram/banners` - è·å–è½®æ’­å›¾
- `/api/miniprogram/upload` - é€šç”¨å›¾ç‰‡ä¸Šä¼ 

**Blueprintåç§°**ï¼š`miniprogram_bp`  
**URLå‰ç¼€**ï¼š`/api/miniprogram`

---

#### 2.3 `app/routes/order.py` - è®¢å•è·¯ç”±

**èŒè´£**ï¼šè®¢å•ç›¸å…³çš„è·¯ç”±ï¼ˆç½‘é¡µç‰ˆå’ŒAPIï¼‰

**ä¸»è¦è·¯ç”±**ï¼š
- `/order` (GET, POST) - åˆ›å»ºè®¢å•é¡µé¢å’Œåˆ›å»ºè®¢å•ï¼ˆç½‘é¡µç‰ˆï¼‰
- `/order/status` (GET, POST) - è®¢å•çŠ¶æ€æŸ¥è¯¢é¡µé¢
- `/api/order/<order_id>/logistics` - è·å–è®¢å•ç‰©æµä¿¡æ¯
- `/api/order/complete-free` - å®Œæˆ0å…ƒè®¢å•æ”¯ä»˜ï¼ˆä½¿ç”¨ä¼˜æƒ åˆ¸ï¼‰

**Blueprintåç§°**ï¼š`order_bp`  
**URLå‰ç¼€**ï¼šæ— ï¼ˆç›´æ¥ä½¿ç”¨æ ¹è·¯å¾„ï¼‰

---

#### 2.4 `app/routes/payment.py` - æ”¯ä»˜è·¯ç”±

**èŒè´£**ï¼šæ”¯ä»˜ç›¸å…³çš„æ‰€æœ‰APIæ¥å£

**ä¸»è¦è·¯ç”±**ï¼š
- `/api/payment/create` - åˆ›å»ºæ”¯ä»˜è®¢å•
- `/api/payment/notify` - æ”¯ä»˜ç»“æœé€šçŸ¥ï¼ˆå¾®ä¿¡å›è°ƒï¼‰
- `/api/user/openid` - è·å–ç”¨æˆ·OpenID

**Blueprintåç§°**ï¼š`payment_bp`, `user_bp`  
**URLå‰ç¼€**ï¼š`/api/payment`, `/api/user`

---

### 3. `app/services/` - ä¸šåŠ¡é€»è¾‘å±‚

#### 3.1 `app/services/order_service.py` - è®¢å•ä¸šåŠ¡é€»è¾‘

**èŒè´£**ï¼šå°è£…è®¢å•ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘

**ä¸»è¦å‡½æ•°**ï¼š
- `create_miniprogram_order()` - åˆ›å»ºå°ç¨‹åºè®¢å•
- `get_miniprogram_orders()` - è·å–å°ç¨‹åºè®¢å•åˆ—è¡¨
- `get_order_by_number()` - é€šè¿‡è®¢å•å·æŸ¥è¯¢è®¢å•
- `check_order_for_verification()` - æ£€æŸ¥è®¢å•æ˜¯å¦å¯ä»¥æ ¸é”€ï¼ˆAndroid Appï¼‰
- `upload_order_photos()` - ä¸Šä¼ è®¢å•ç…§ç‰‡ï¼ˆAndroid Appï¼‰
- `update_order_status_service()` - æ›´æ–°è®¢å•çŠ¶æ€
- `update_order_images_service()` - æ›´æ–°è®¢å•å›¾ç‰‡
- `delete_order_image_service()` - åˆ é™¤è®¢å•å›¾ç‰‡
- `generate_order_qrcode_service()` - ç”Ÿæˆè®¢å•äºŒç»´ç 

**ä½¿ç”¨æ–¹å¼**ï¼š
```python
from app.services.order_service import create_miniprogram_order
# åœ¨è·¯ç”±ä¸­è°ƒç”¨
result = create_miniprogram_order(data, db, Order, ...)
```

---

#### 3.2 `app/services/payment_service.py` - æ”¯ä»˜ä¸šåŠ¡é€»è¾‘

**èŒè´£**ï¼šå°è£…æ”¯ä»˜ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘

**ä¸»è¦å‡½æ•°**ï¼š
- `create_payment_order()` - åˆ›å»ºæ”¯ä»˜è®¢å•
- `handle_payment_notify()` - å¤„ç†æ”¯ä»˜ç»“æœé€šçŸ¥
- `get_user_openid_service()` - è·å–ç”¨æˆ·OpenID

**ä½¿ç”¨æ–¹å¼**ï¼š
```python
from app.services.payment_service import create_payment_order
# åœ¨è·¯ç”±ä¸­è°ƒç”¨
result = create_payment_order(data, db, Order, ...)
```

---

### 4. `app/utils/` - å·¥å…·å‡½æ•°

#### 4.1 `app/utils/helpers.py` - é€šç”¨å·¥å…·å‡½æ•°

**èŒè´£**ï¼šæä¾›é€šç”¨çš„å·¥å…·å‡½æ•°

**ä¸»è¦å‡½æ•°**ï¼š
- **å¾®ä¿¡æ”¯ä»˜ç›¸å…³**ï¼š
  - `generate_sign()` - ç”Ÿæˆå¾®ä¿¡æ”¯ä»˜ç­¾å
  - `verify_sign()` - éªŒè¯å¾®ä¿¡æ”¯ä»˜ç­¾å
  - `dict_to_xml()`, `xml_to_dict()` - XMLè½¬æ¢
  - `generate_nonce_str()` - ç”Ÿæˆéšæœºå­—ç¬¦ä¸²

- **æ•°æ®è§£æ**ï¼š
  - `parse_shipping_info()` - è§£ææ”¶è´§ä¿¡æ¯
  - `get_product_id_from_size()` - æ ¹æ®å°ºå¯¸è·å–äº§å“ID

- **æ¨å¹¿ç å’Œç”¨æˆ·**ï¼š
  - `generate_promotion_code()` - ç”Ÿæˆæ¨å¹¿ç 
  - `generate_stable_promotion_code()` - ç”Ÿæˆç¨³å®šæ¨å¹¿ç 
  - `validate_promotion_code()` - éªŒè¯æ¨å¹¿ç 
  - `check_user_has_placed_order()` - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸‹è¿‡å•
  - `check_user_eligible_for_commission()` - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰èµ„æ ¼è·å¾—æ¨å¹¿æ”¶ç›Š

- **ä¼˜æƒ åˆ¸**ï¼š
  - `generate_coupon_code()` - ç”Ÿæˆä¼˜æƒ åˆ¸ä»£ç 
  - `validate_coupon_code()` - éªŒè¯ä¼˜æƒ åˆ¸ä»£ç 
  - `create_coupon()` - åˆ›å»ºä¼˜æƒ åˆ¸
  - `get_user_coupons()` - è·å–ç”¨æˆ·ä¼˜æƒ åˆ¸åˆ—è¡¨
  - `can_user_get_coupon()` - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥é¢†å–ä¼˜æƒ åˆ¸
  - `user_get_coupon()` - ç”¨æˆ·é¢†å–ä¼˜æƒ åˆ¸
  - `can_use_coupon()` - æ£€æŸ¥ä¼˜æƒ åˆ¸æ˜¯å¦å¯ä»¥ä½¿ç”¨
  - `calculate_discount_amount()` - è®¡ç®—ä¼˜æƒ é‡‘é¢
  - `use_coupon()` - ä½¿ç”¨ä¼˜æƒ åˆ¸

- **æ–‡ä»¶å¤„ç†**ï¼š
  - `allowed_file()` - æ£€æŸ¥æ–‡ä»¶æ‰©å±•åæ˜¯å¦å…è®¸
  - `generate_production_info()` - ç”Ÿæˆåˆ¶ä½œä¿¡æ¯æ–‡æœ¬
  - `generate_smart_filename()` - ç”Ÿæˆæ™ºèƒ½æ–‡ä»¶å
  - `generate_smart_image_name()` - ç”Ÿæˆæ™ºèƒ½å›¾ç‰‡æ–‡ä»¶å

- **äºŒç»´ç **ï¼š
  - `generate_qr_code()` - ç”ŸæˆäºŒç»´ç 

**ä½¿ç”¨æ–¹å¼**ï¼š
```python
from app.utils.helpers import generate_sign, parse_shipping_info
```

---

#### 4.2 `app/utils/image_utils.py` - å›¾ç‰‡å¤„ç†å·¥å…·

**èŒè´£**ï¼šæä¾›å›¾ç‰‡å¤„ç†ç›¸å…³çš„å·¥å…·å‡½æ•°

**ä¸»è¦å‡½æ•°**ï¼š
- `add_watermark_to_image()` - ä¸ºå›¾ç‰‡æ·»åŠ æ°´å°

**ä½¿ç”¨æ–¹å¼**ï¼š
```python
from app.utils.image_utils import add_watermark_to_image
```

---

### 5. `app/__init__.py` - åº”ç”¨åˆå§‹åŒ–

**èŒè´£**ï¼šFlaskåº”ç”¨å·¥å‚å‡½æ•°å’ŒBlueprintæ³¨å†Œ

**ä¸»è¦åŠŸèƒ½**ï¼š
- åˆ›å»ºFlaskåº”ç”¨å®ä¾‹
- é…ç½®æ•°æ®åº“è¿æ¥
- åˆå§‹åŒ–æ‰©å±•ï¼ˆSQLAlchemy, LoginManagerï¼‰
- æ³¨å†Œæ‰€æœ‰Blueprint

**å½“å‰æ³¨å†Œçš„Blueprint**ï¼š
- `admin_bp` - ç®¡ç†åå°è·¯ç”±
- `miniprogram_bp` - å°ç¨‹åºAPIè·¯ç”±
- `order_bp` - è®¢å•è·¯ç”±
- `payment_bp` - æ”¯ä»˜è·¯ç”±
- `user_bp` - ç”¨æˆ·è·¯ç”±

---

## ğŸ”„ ä»£ç ç»„ç»‡åŸåˆ™

### 1. åˆ†å±‚æ¶æ„

```
è·¯ç”±å±‚ (routes/)
    â†“ è°ƒç”¨
ä¸šåŠ¡é€»è¾‘å±‚ (services/)
    â†“ è°ƒç”¨
å·¥å…·å‡½æ•°å±‚ (utils/)
    â†“ ä½¿ç”¨
æ•°æ®æ¨¡å‹å±‚ (models/)
```

### 2. ä¾èµ–æ³¨å…¥

ä¸ºäº†é¿å…å¾ªç¯å¯¼å…¥ï¼ŒæœåŠ¡å±‚å‡½æ•°é€šè¿‡å‚æ•°æ¥æ”¶ä¾èµ–ï¼š
- `db` å®ä¾‹
- æ¨¡å‹ç±»ï¼ˆ`Order`, `OrderImage` ç­‰ï¼‰
- é…ç½®å¯¹è±¡ï¼ˆ`WECHAT_PAY_CONFIG` ç­‰ï¼‰
- å·¥å…·å‡½æ•°

**ç¤ºä¾‹**ï¼š
```python
# åœ¨è·¯ç”±ä¸­è°ƒç”¨æœåŠ¡å±‚
from app.services.order_service import create_miniprogram_order
from test_server import db, Order, OrderImage

result = create_miniprogram_order(
    data, 
    db, 
    Order, 
    OrderImage, 
    ...
)
```

### 3. å‘åå…¼å®¹

- `test_server.py` ä»ç„¶ä½œä¸ºä¸»å…¥å£ç‚¹
- æ‰€æœ‰æ¨¡å‹ã€é…ç½®ã€æœªè¿ç§»çš„è·¯ç”±ä»åœ¨ `test_server.py` ä¸­
- `start.py` ç»§ç»­ä» `test_server` å¯¼å…¥

---

## ğŸš€ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„è·¯ç”±

1. **ç¡®å®šè·¯ç”±ç±»å‹**ï¼š
   - ç®¡ç†åå°è·¯ç”± â†’ `app/routes/admin.py`
   - å°ç¨‹åºAPIè·¯ç”± â†’ `app/routes/miniprogram.py`
   - è®¢å•ç›¸å…³è·¯ç”± â†’ `app/routes/order.py`
   - æ”¯ä»˜ç›¸å…³è·¯ç”± â†’ `app/routes/payment.py`

2. **åœ¨å¯¹åº”çš„Blueprintä¸­æ·»åŠ è·¯ç”±**ï¼š
```python
# app/routes/miniprogram.py
@miniprogram_bp.route('/new-endpoint', methods=['GET', 'POST'])
def new_endpoint():
    # ä»test_serverè·å–å¿…è¦çš„å¯¹è±¡
    import sys
    if 'test_server' in sys.modules:
        test_server_module = sys.modules['test_server']
        Order = test_server_module.Order
        db = test_server_module.db
        app = test_server_module.app
    
    # å®ç°è·¯ç”±é€»è¾‘
    ...
```

3. **å¦‚æœé€»è¾‘å¤æ‚ï¼Œè€ƒè™‘åˆ›å»ºæœåŠ¡å±‚å‡½æ•°**ï¼š
```python
# app/services/order_service.py
def new_order_function(data, db, Order, ...):
    # ä¸šåŠ¡é€»è¾‘
    ...
    return result

# app/routes/miniprogram.py
from app.services.order_service import new_order_function

@miniprogram_bp.route('/new-endpoint', methods=['POST'])
def new_endpoint():
    data = request.get_json()
    result = new_order_function(data, db, Order, ...)
    return jsonify(result)
```

---

### æ·»åŠ æ–°çš„å·¥å…·å‡½æ•°

1. **ç¡®å®šå‡½æ•°ç±»å‹**ï¼š
   - é€šç”¨å·¥å…·å‡½æ•° â†’ `app/utils/helpers.py`
   - å›¾ç‰‡å¤„ç†å‡½æ•° â†’ `app/utils/image_utils.py`

2. **åœ¨å¯¹åº”çš„æ–‡ä»¶ä¸­æ·»åŠ å‡½æ•°**ï¼š
```python
# app/utils/helpers.py
def new_helper_function(param1, param2):
    """å‡½æ•°è¯´æ˜"""
    # å®ç°é€»è¾‘
    ...
    return result
```

3. **åœ¨éœ€è¦çš„åœ°æ–¹å¯¼å…¥ä½¿ç”¨**ï¼š
```python
from app.utils.helpers import new_helper_function
```

---

### æ·»åŠ æ–°çš„æ•°æ®åº“æ¨¡å‹

1. **åœ¨ `app/models.py` ä¸­æ·»åŠ æ¨¡å‹ç±»**ï¼š
```python
# app/models.py
class NewModel(db.Model):
    __tablename__ = 'new_table'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    # ...
```

2. **åœ¨ `test_server.py` ä¸­å¯¼å…¥æ¨¡å‹**ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
```python
# test_server.py
from app.models import NewModel
```

---

### æ·»åŠ æ–°çš„æœåŠ¡å±‚å‡½æ•°

1. **ç¡®å®šæœåŠ¡ç±»å‹**ï¼š
   - è®¢å•ç›¸å…³ â†’ `app/services/order_service.py`
   - æ”¯ä»˜ç›¸å…³ â†’ `app/services/payment_service.py`
   - å…¶ä»–ä¸šåŠ¡é€»è¾‘ â†’ åˆ›å»ºæ–°çš„æœåŠ¡æ–‡ä»¶

2. **åœ¨å¯¹åº”çš„æ–‡ä»¶ä¸­æ·»åŠ å‡½æ•°**ï¼š
```python
# app/services/order_service.py
def new_service_function(data, db, Order, ...):
    """
    æ–°æœåŠ¡å‡½æ•°
    
    Args:
        data: è¾“å…¥æ•°æ®
        db: æ•°æ®åº“å®ä¾‹
        Order: Orderæ¨¡å‹ç±»
        ...
    
    Returns:
        tuple: (success: bool, result: dict, error_message: str)
    """
    try:
        # ä¸šåŠ¡é€»è¾‘
        ...
        return True, result, None
    except Exception as e:
        return False, None, str(e)
```

3. **åœ¨è·¯ç”±ä¸­è°ƒç”¨**ï¼š
```python
from app.services.order_service import new_service_function

@miniprogram_bp.route('/endpoint', methods=['POST'])
def endpoint():
    data = request.get_json()
    success, result, error = new_service_function(data, db, Order, ...)
    if success:
        return jsonify(result)
    else:
        return jsonify({'error': error}), 400
```

---

## ğŸ“ ä»£ç è¿ç§»çŠ¶æ€

### âœ… å·²è¿ç§»çš„æ¨¡å—

- âœ… æ•°æ®åº“æ¨¡å‹ï¼ˆ25ä¸ªï¼‰â†’ `app/models.py`
- âœ… é€šç”¨å·¥å…·å‡½æ•° â†’ `app/utils/helpers.py`
- âœ… å›¾ç‰‡å¤„ç†å‡½æ•° â†’ `app/utils/image_utils.py`
- âœ… è®¢å•ä¸šåŠ¡é€»è¾‘ â†’ `app/services/order_service.py`
- âœ… æ”¯ä»˜ä¸šåŠ¡é€»è¾‘ â†’ `app/services/payment_service.py`
- âœ… ç®¡ç†åå°è·¯ç”± â†’ `app/routes/admin.py`
- âœ… å°ç¨‹åºAPIè·¯ç”± â†’ `app/routes/miniprogram.py`
- âœ… è®¢å•è·¯ç”± â†’ `app/routes/order.py`
- âœ… æ”¯ä»˜è·¯ç”± â†’ `app/routes/payment.py`

### â³ ä»åœ¨ `test_server.py` ä¸­çš„å†…å®¹

ä»¥ä¸‹å†…å®¹ä»åœ¨ `test_server.py` ä¸­ï¼Œåç»­å¯æ ¹æ®éœ€è¦è¿ç§»ï¼š

- å…¶ä»–è·¯ç”±ï¼ˆå¦‚ `/`, `/login`, `/works-gallery` ç­‰ï¼‰
- æ¨¡æ¿è¿‡æ»¤å™¨ï¼ˆ`size_name_filter`, `from_json_filter` ç­‰ï¼‰
- ä¸Šä¸‹æ–‡å¤„ç†å™¨ï¼ˆ`inject_server_config`ï¼‰
- å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼ˆ`async_worker`, `submit_async_task`ï¼‰
- å…¶ä»–å·¥å…·å‡½æ•°ï¼ˆå¦‚ `allowed_file`ï¼‰
- é€šçŸ¥ç³»ç»Ÿç›¸å…³ä»£ç 
- æ‰“å°æœºç³»ç»Ÿç›¸å…³ä»£ç 

---

## ğŸ”§ å¼€å‘æ³¨æ„äº‹é¡¹

### 1. é¿å…å¾ªç¯å¯¼å…¥

- æœåŠ¡å±‚å‡½æ•°é€šè¿‡å‚æ•°æ¥æ”¶ä¾èµ–ï¼Œè€Œä¸æ˜¯ç›´æ¥å¯¼å…¥
- è·¯ç”±å±‚ä» `test_server` æ¨¡å—åŠ¨æ€è·å–å¯¹è±¡

### 2. æ•°æ®åº“æ“ä½œ

- ä½¿ç”¨ `db.session` è¿›è¡Œæ•°æ®åº“æ“ä½œ
- è®°å¾— `commit()` æˆ– `rollback()`
- åœ¨å¼‚å¸¸å¤„ç†ä¸­è°ƒç”¨ `rollback()`

### 3. é”™è¯¯å¤„ç†

- æœåŠ¡å±‚å‡½æ•°è¿”å› `(success, result, error_message)` å…ƒç»„
- è·¯ç”±å±‚æ ¹æ®è¿”å›å€¼æ„é€ HTTPå“åº”

### 4. æ—¥å¿—è®°å½•

- ä½¿ç”¨ `print()` è®°å½•å…³é”®æ“ä½œ
- é‡è¦é”™è¯¯ä½¿ç”¨ `traceback.print_exc()` æ‰“å°å®Œæ•´å †æ ˆ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **APIæ–‡æ¡£**ï¼š`docs/api/`
- **æ•°æ®åº“æ–‡æ¡£**ï¼š`docs/database/`
- **éƒ¨ç½²æ–‡æ¡£**ï¼š`docs/deployment/`
- **åŠŸèƒ½æ–‡æ¡£**ï¼š`docs/features/`
- **APIæ¥å£æ–‡æ¡£ï¼ˆå‚å®¶ç‰ˆï¼‰**ï¼š`APIæ¥å£æ–‡æ¡£-å‚å®¶ç‰ˆ.md`

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **ç»§ç»­è¿ç§»å‰©ä½™è·¯ç”±**ï¼š
   - å°†å…¶ä»–è·¯ç”±è¿ç§»åˆ°å¯¹åº”çš„Blueprint
   - åˆ›å»º `app/routes/common.py` å­˜æ”¾é€šç”¨è·¯ç”±

2. **å®Œå–„æœåŠ¡å±‚**ï¼š
   - åˆ›å»º `app/services/notification_service.py` å¤„ç†é€šçŸ¥é€»è¾‘
   - åˆ›å»º `app/services/printer_service.py` å¤„ç†æ‰“å°æœºé€»è¾‘

3. **é…ç½®ç®¡ç†**ï¼š
   - åˆ›å»º `app/config.py` ç»Ÿä¸€ç®¡ç†é…ç½®
   - ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶

4. **æµ‹è¯•**ï¼š
   - ä¸ºæœåŠ¡å±‚å‡½æ•°ç¼–å†™å•å…ƒæµ‹è¯•
   - ä¸ºè·¯ç”±ç¼–å†™é›†æˆæµ‹è¯•

5. **æ–‡æ¡£**ï¼š
   - ä¸ºæ¯ä¸ªæ¨¡å—æ·»åŠ è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²
   - åˆ›å»ºAPIä½¿ç”¨ç¤ºä¾‹

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- ä»£ç æ³¨é‡Š
- ç›¸å…³åŠŸèƒ½æ–‡æ¡£
- APIæ¥å£æ–‡æ¡£

---

**æœ€åæ›´æ–°**ï¼š2026-01-14  
**ç‰ˆæœ¬**ï¼šv1.0ï¼ˆé‡æ„åï¼‰
