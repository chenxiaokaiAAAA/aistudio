# 证件照尺寸颜色选择功能实现方案

## 需求说明

在小程序证件照产品选择页面，将规格选择改为复选框形式：
- **第一排**：选择尺寸（单选）
- **第二排**：选择颜色（单选）

## 实现方案

### 方案一：使用 ProductCustomField（推荐）

利用现有的 `ProductCustomField` 表来存储颜色选项，尺寸继续使用 `ProductSize` 表。

#### 1. 数据库结构（已存在）

- `ProductSize` 表：存储尺寸信息
  - `size_name`: 尺寸名称（如"1寸"、"2寸"）
  - `price`: 价格

- `ProductCustomField` 表：存储自定义字段（可用于存储颜色选项）
  - `field_name`: 字段名称（如"颜色"、"背景色"）
  - `field_type`: 字段类型（`select`）
  - `field_options`: 选项列表（JSON格式，如 `["红底","蓝底","白底"]`）

#### 2. 管理后台配置步骤

在管理后台编辑产品页面（`/admin/sizes`），需要：

1. **配置尺寸**（现有功能）：
   - 在"尺寸规格"部分添加尺寸，如：
     - 尺寸名称：`1寸`
     - 尺寸名称：`2寸`
     - 尺寸名称：`小2寸`

2. **配置颜色选项**（新增功能）：
   - 在"自定义字段"部分添加颜色字段：
     - 字段名称：`背景色` 或 `颜色`
     - 字段类型：`select`（下拉选择）
     - 字段选项：`红底,蓝底,白底`（逗号分隔）
     - 是否必填：`是`

#### 3. 需要修改的文件

##### 3.1 管理后台 - 产品编辑页面

**文件：** `AI-studio/templates/admin/sizes.html`

**需要添加：**
- 在尺寸编辑区域下方，添加"颜色选项"配置区域
- 允许管理员为产品添加颜色自定义字段
- 显示颜色选项列表，支持添加/删除颜色选项

**示例代码位置：** 在尺寸编辑区域（`<div id="edit-sizes-{{ product.id }}">`）之后添加：

```html
<!-- 颜色选项配置 -->
<h6 class="mb-2"><i class="fas fa-palette"></i> 颜色选项</h6>
<div class="alert alert-info mb-3" style="font-size: 0.85rem; padding: 8px;">
    <strong>说明：</strong>配置证件照的背景颜色选项，用户在小程序中选择颜色时会显示这些选项。
</div>
<div id="edit-colors-{{ product.id }}">
    {% for custom_field in product.custom_fields %}
    {% if custom_field.field_name == '背景色' or custom_field.field_name == '颜色' %}
    <div class="color-options-container mb-3 p-3 border rounded">
        <div class="row mb-2">
            <div class="col-md-6">
                <label class="form-label small">颜色选项（逗号分隔）</label>
                <input type="text" class="form-control" 
                       name="color_options" 
                       value="{{ custom_field.field_options }}" 
                       placeholder="如: 红底,蓝底,白底">
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
    {% if not product.custom_fields or not product.custom_fields|selectattr('field_name', 'equalto', '背景色')|list %}
    <div class="color-options-container mb-3 p-3 border rounded">
        <div class="row mb-2">
            <div class="col-md-6">
                <label class="form-label small">颜色选项（逗号分隔）</label>
                <input type="text" class="form-control" 
                       name="color_options" 
                       placeholder="如: 红底,蓝底,白底">
            </div>
        </div>
    </div>
    {% endif %}
</div>
```

##### 3.2 后端API - 保存颜色选项

**文件：** `AI-studio/test_server.py`

**需要修改：** 产品编辑保存接口，处理颜色选项的保存：

```python
# 在处理产品编辑的POST请求中，添加颜色选项处理逻辑
if 'color_options' in request.form:
    color_options = request.form.get('color_options', '').strip()
    if color_options:
        # 查找或创建"背景色"自定义字段
        color_field = ProductCustomField.query.filter_by(
            product_id=product_id,
            field_name='背景色'
        ).first()
        
        if not color_field:
            color_field = ProductCustomField(
                product_id=product_id,
                field_name='背景色',
                field_type='select',
                field_options=color_options,
                is_required=True,
                sort_order=0
            )
            db.session.add(color_field)
        else:
            color_field.field_options = color_options
        
        db.session.commit()
```

##### 3.3 小程序前端 - 产品选择页面

**文件：** `AI-小程序/pages/product/product.wxml`

**需要修改：** 将规格选择改为两排复选框：

```xml
<!-- 规格选择 -->
<view class="spec-selection">
    <!-- 第一排：选择尺寸 -->
    <view class="spec-row">
        <text class="info-title">选择尺寸:</text>
        <view class="spec-options">
            <view class="spec-item {{selectedSize === item.size_name ? 'selected' : ''}}" 
                  wx:for="{{sizeOptions}}" wx:key="id" 
                  bindtap="selectSize" data-size="{{item.size_name}}" data-size-id="{{item.id}}">
                <text class="spec-label">{{item.size_name}}</text>
            </view>
        </view>
    </view>
    
    <!-- 第二排：选择颜色 -->
    <view class="spec-row" wx:if="{{colorOptions.length > 0}}">
        <text class="info-title">选择颜色:</text>
        <view class="spec-options">
            <view class="spec-item {{selectedColor === item ? 'selected' : ''}}" 
                  wx:for="{{colorOptions}}" wx:key="*this" 
                  bindtap="selectColor" data-color="{{item}}">
                <text class="spec-label">{{item}}</text>
            </view>
        </view>
    </view>
</view>
```

**文件：** `AI-小程序/pages/product/product.js`

**需要修改：** 添加尺寸和颜色的选择逻辑：

```javascript
data: {
    // ... 现有数据
    selectedSize: '',      // 选中的尺寸
    selectedColor: '',     // 选中的颜色
    sizeOptions: [],       // 尺寸选项列表
    colorOptions: []       // 颜色选项列表
},

// 加载产品数据时，解析尺寸和颜色选项
loadProducts() {
    // ... 现有代码
    // 处理产品数据，分离尺寸和颜色
    const products = res.data.data.map(product => {
        // 提取尺寸选项
        const sizes = product.sizes || [];
        product.sizeOptions = sizes.map(size => ({
            id: size.id,
            size_name: size.name,
            price: size.price
        }));
        
        // 提取颜色选项（从自定义字段中）
        const colorField = product.custom_fields?.find(field => 
            field.field_name === '背景色' || field.field_name === '颜色'
        );
        if (colorField && colorField.field_options) {
            // 解析颜色选项（逗号分隔或JSON格式）
            let colorOptions = [];
            try {
                // 尝试解析为JSON
                colorOptions = JSON.parse(colorField.field_options);
            } catch (e) {
                // 如果不是JSON，按逗号分隔
                colorOptions = colorField.field_options.split(',').map(c => c.trim());
            }
            product.colorOptions = colorOptions;
        } else {
            product.colorOptions = [];
        }
        
        return product;
    });
},

// 选择尺寸
selectSize(e) {
    const sizeName = e.currentTarget.dataset.size;
    const sizeId = e.currentTarget.dataset.sizeId;
    this.setData({
        selectedSize: sizeName,
        currentSizeId: sizeId
    });
    
    // 更新选中的规格（组合尺寸和颜色）
    this.updateSelectedSpec();
},

// 选择颜色
selectColor(e) {
    const color = e.currentTarget.dataset.color;
    this.setData({
        selectedColor: color
    });
    
    // 更新选中的规格（组合尺寸和颜色）
    this.updateSelectedSpec();
},

// 更新选中的规格（组合尺寸和颜色）
updateSelectedSpec() {
    const { selectedSize, selectedColor } = this.data;
    if (selectedSize && selectedColor) {
        const specName = `${selectedSize}-${selectedColor}`;
        // 计算价格（尺寸价格）
        const currentProduct = this.data.currentProduct;
        const selectedSizeObj = currentProduct.sizeOptions.find(s => s.size_name === selectedSize);
        const price = selectedSizeObj ? selectedSizeObj.price : 0;
        
        this.setData({
            selectedSpec: specName,
            selectedSpecPrice: `¥${price}`
        });
    }
},

// 从弹窗开始定制（修改）
startCustomFromModal(e) {
    const { selectedSize, selectedColor } = this.data;
    
    if (!selectedSize) {
        wx.showToast({
            title: '请选择尺寸',
            icon: 'none'
        });
        return;
    }
    
    if (!selectedColor && this.data.colorOptions.length > 0) {
        wx.showToast({
            title: '请选择颜色',
            icon: 'none'
        });
        return;
    }
    
    // ... 后续逻辑
}
```

##### 3.4 小程序前端 - 样式调整

**文件：** `AI-小程序/pages/product/product.wxss`

**需要添加：** 两排选择的样式：

```css
.spec-row {
    margin-bottom: 30rpx;
}

.spec-row:last-child {
    margin-bottom: 0;
}

.spec-options {
    display: flex;
    flex-wrap: wrap;
    gap: 20rpx;
    margin-top: 20rpx;
}

.spec-item {
    padding: 20rpx 40rpx;
    border: 2rpx solid #ddd;
    border-radius: 8rpx;
    background-color: #fff;
    text-align: center;
    min-width: 120rpx;
}

.spec-item.selected {
    border-color: #FF6B6B;
    background-color: #FFF5F5;
}

.spec-label {
    font-size: 28rpx;
    color: #333;
}
```

### 方案二：扩展 ProductSize 表（不推荐）

如果希望更简单的实现，可以在 `ProductSize` 表中添加 `background_color` 字段，但这样不够灵活。

## 实施步骤

### 第一步：修改管理后台

1. 在 `AI-studio/templates/admin/sizes.html` 中添加颜色选项配置区域
2. 在 `AI-studio/test_server.py` 中添加颜色选项的保存逻辑
3. 在 `AI-studio/test_server.py` 的 `/api/miniprogram/products` 接口中，返回颜色选项数据

### 第二步：修改小程序前端

1. 修改 `AI-小程序/pages/product/product.wxml`，改为两排选择
2. 修改 `AI-小程序/pages/product/product.js`，添加尺寸和颜色的选择逻辑
3. 修改 `AI-小程序/pages/product/product.wxss`，添加样式

### 第三步：测试

1. 在管理后台为"证件照"产品配置：
   - 尺寸：1寸、2寸、小2寸
   - 颜色：红底、蓝底、白底
2. 在小程序产品馆中测试选择功能
3. 验证订单提交时，规格信息正确保存

## 注意事项

1. **向后兼容**：确保现有产品（没有颜色选项）仍能正常工作
2. **数据格式**：颜色选项可以存储为逗号分隔的字符串，或JSON数组
3. **订单保存**：订单的 `size` 字段应保存为 `"1寸-红底"` 这样的组合格式
4. **价格计算**：目前价格只基于尺寸，如果颜色影响价格，需要调整价格计算逻辑

## 后续优化

1. 如果颜色影响价格，可以在 `ProductCustomField` 中添加价格配置
2. 可以添加颜色预览图片
3. 可以支持多选（如果业务需要）
