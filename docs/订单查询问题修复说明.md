# 订单查询问题修复说明

## 问题描述

用户创建订单后，跳过了支付，但在订单详情页面提示"找不到订单"。

## 问题原因

1. **开发模式下openid不一致**：
   - 后端每次生成不同的测试openid（使用uuid）
   - 前端也每次生成不同的测试openid（使用Date.now()）
   - 导致创建订单时使用的openid和查询订单时使用的openid不一致

2. **查询方式单一**：
   - 订单查询接口只支持通过openid查询
   - 如果openid不匹配，就无法查询到订单

## 修复方案

### 1. 使用固定的测试openid（开发模式）

**后端修改** (`AI-studio/test_server.py`)：
```python
# 修改前：每次生成不同的openid
test_openid = f"test_openid_{uuid.uuid4().hex[:16]}"

# 修改后：使用固定的openid
test_openid = "test_openid_dev_mode_fixed"
```

**前端修改** (`AI-小程序/pages/payment/payment.js`)：
```javascript
// 修改前：每次生成不同的openid
var testOpenid = 'test_openid_' + Date.now();

// 修改后：使用固定的openid
var testOpenid = 'test_openid_dev_mode_fixed';
```

### 2. 添加通过订单号查询的接口

**新增接口** (`AI-studio/test_server.py`)：
```python
@app.route('/api/miniprogram/order/<order_number>', methods=['GET'])
def miniprogram_get_order_by_number(order_number):
    """小程序通过订单号查询单个订单（不依赖openid）"""
    # 直接通过订单号查询，不依赖openid
    order = Order.query.filter_by(order_number=order_number).first()
    # ... 返回订单数据
```

### 3. 订单详情页面增加备用查询逻辑

**修改** (`AI-小程序/pages/order-detail/order-detail.js`)：
```javascript
// 如果通过openid查询不到，尝试通过订单号直接查询
if (!serverOrder) {
  console.log('尝试通过订单号直接查询订单:', orderId);
  this.loadOrderByOrderNumber(orderId);
}
```

## 修复后的流程

1. **创建订单**：
   - 使用固定的测试openid：`test_openid_dev_mode_fixed`
   - 订单保存到数据库，包含openid和订单号

2. **查询订单列表**：
   - 通过openid查询（使用固定的测试openid）
   - 应该能正常查询到订单

3. **查询订单详情**：
   - 优先通过openid查询订单列表，然后在列表中查找
   - 如果找不到，自动通过订单号直接查询
   - 确保即使openid不匹配也能查询到订单

## 需要重启的服务

### 后端服务（必须重启）
```bash
cd AI-studio
python start.py
```

### 小程序（需要重新编译）
在微信开发者工具中：
1. 点击"编译"按钮
2. 或者点击"清除缓存" → "重新编译"

## 测试步骤

1. **清除旧的测试数据**（可选）：
   - 清除小程序本地存储的openid
   - 或者清除数据库中的测试订单

2. **创建新订单**：
   - 在小程序中创建订单
   - 跳过支付
   - 应该能正常创建订单

3. **查看订单列表**：
   - 进入"我的订单"页面
   - 应该能看到刚创建的订单

4. **查看订单详情**：
   - 点击订单进入详情页
   - 应该能正常显示订单信息

## 注意事项

1. **开发模式标志**：
   - 后端：`DEV_MODE_SKIP_OPENID = True`
   - 前端：`SKIP_REAL_PAYMENT = true`
   - 上线前需要改为 `False`

2. **固定openid仅用于开发**：
   - 生产环境会使用真实的微信openid
   - 不会出现openid不一致的问题

3. **订单号查询接口**：
   - 不依赖openid，可以直接通过订单号查询
   - 适合用于订单详情页的备用查询方式

## 验证修复

修复后，应该能看到：
1. 控制台日志显示使用固定的测试openid
2. 订单创建成功
3. 订单列表能正常显示
4. 订单详情能正常显示（即使openid不匹配，也能通过订单号查询）
