# 图片显示问题修复说明

## 问题描述

订单详情页面获取到的图片地址是正确的（控制台显示），但是图片无法显示，显示为空白窗口，点击也是黑屏。

## 问题原因

代码将本地HTTP地址转换为HTTPS，但本地开发服务器只支持HTTP，导致图片无法加载。

**具体问题：**
- 服务器返回的图片URL：`http://192.168.2.54:8000/media/original/android_6c636055_photo0.jpg`
- 代码错误地转换为：`https://192.168.2.54:8000/media/original/android_6c636055_photo0.jpg`
- 本地服务器不支持HTTPS，所以图片无法加载

## 修复内容

### 1. 修复 `processImageUrl` 方法

**修改前：**
```javascript
processImageUrl(url) {
  if (!url) return '';
  
  // 如果是相对路径，补全为完整URL
  if (url.startsWith('/media/')) {
    return `${config.getBaseUrl()}${url}`;
  }
  
  // 如果是http协议，转换为https
  if (url.startsWith('http://')) {
    return url.replace('http://', 'https://');
  }
  
  return url;
}
```

**修改后：**
```javascript
processImageUrl(url) {
  if (!url) return '';
  
  // 如果是相对路径，补全为完整URL
  if (url.startsWith('/media/')) {
    return `${config.getBaseUrl()}${url}`;
  }
  
  // 使用convertToHttps工具函数处理URL（本地环境保持HTTP，生产环境转换为HTTPS）
  return convertToHttps(url);
}
```

### 2. 修复本地订单图片处理逻辑

**修改前：**
```javascript
// 转换HTTP为HTTPS
if (Array.isArray(images)) {
  images = images.map(img => {
    if (typeof img === 'string' && img.startsWith('http://')) {
      const httpsUrl = img.replace('http://', 'https://');
      console.log('转换图片URL:', img, '->', httpsUrl);
      return httpsUrl;
    }
    return img;
  });
}
```

**修改后：**
```javascript
// 使用convertToHttps工具函数处理URL（会根据环境决定是否转换）
if (Array.isArray(images)) {
  images = images.map(img => {
    if (typeof img === 'string') {
      const processedUrl = convertToHttps(img);
      if (img !== processedUrl) {
        console.log('处理图片URL:', img, '->', processedUrl);
      }
      return processedUrl;
    }
    return img;
  });
}
```

### 3. 修复服务器订单图片处理逻辑

同样使用 `convertToHttps` 工具函数，确保根据环境配置正确处理URL。

## `convertToHttps` 工具函数逻辑

**位置：** `AI-小程序/utils/api.js`

**逻辑：**
```javascript
const convertToHttps = (url) => {
  if (!url) return url;
  
  // 如果URL包含photogooo，替换为当前配置的地址
  if (url.includes('photogooo')) {
    const baseUrl = config.getBaseUrl();
    url = url.replace(/https?:\/\/moeart\.cc/g, baseUrl);
    url = url.replace(/moeart\.cc/g, baseUrl.replace(/https?:\/\//, ''));
  }
  
  // 如果是http协议且当前环境是生产环境，转换为https
  // 本地环境保持http
  if (url.startsWith('http://') && config.ENV === 'production') {
    return url.replace('http://', 'https://');
  }
  
  return url;
};
```

**关键点：**
- 本地环境（`ENV === 'local'`）：保持HTTP，不转换
- 生产环境（`ENV === 'production'`）：转换为HTTPS

## 需要重新编译

### 小程序（必须重新编译）
在微信开发者工具中：
1. 点击"编译"按钮（或按 `Ctrl+B`）
2. 或者：点击"清除缓存" → "重新编译"

## 修复后的效果

1. **本地环境**：
   - 图片URL保持HTTP格式：`http://192.168.2.54:8000/media/original/xxx.jpg`
   - 图片可以正常加载和显示

2. **生产环境**：
   - 图片URL转换为HTTPS格式：`https://photogooo/media/original/xxx.jpg`
   - 符合微信小程序的安全要求

## 测试步骤

1. **重新编译小程序**

2. **测试图片显示**：
   - 在小程序中查看订单详情
   - 应该能看到"自拍机拍摄的图片"区域
   - 应该能看到安卓APP上传的图片正常显示
   - 点击图片应该能正常预览

3. **检查控制台**：
   - 图片URL应该保持HTTP格式（本地环境）
   - 不应该看到HTTP到HTTPS的转换日志

## 注意事项

1. **环境配置**：
   - 确保 `config.js` 中的 `ENV` 设置为 `'local'`（本地开发）
   - 生产环境需要设置为 `'production'`

2. **微信小程序限制**：
   - 本地开发环境可以使用HTTP
   - 生产环境必须使用HTTPS
   - 代码已经自动处理这个差异

3. **图片加载**：
   - 如果图片仍然无法显示，检查：
     - 后端服务器是否正常运行
     - 图片文件是否真实存在
     - 网络连接是否正常
