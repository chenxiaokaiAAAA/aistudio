# 商城功能说明

## 功能概述

商城功能是用户在收到AI写真或证件照后的二次购买入口，用户可以将已完成的照片定制成实物产品（如相框、T恤、抱枕等）。

## 功能特点

1. **独立的产品体系**：商城产品与原有的AI写真产品完全区分开
2. **关联原始订单**：商城订单可以关联到原始AI写真订单
3. **完整的订单流程**：从浏览商品、选择规格、下单到支付的完整流程

## 数据库模型

### ShopProduct（商城产品表）
- `id`: 主键
- `code`: 产品代码（唯一）
- `name`: 产品名称
- `description`: 产品描述
- `category`: 产品分类（photo_frame, t_shirt, pillow等）
- `image_url`: 主图URL
- `is_active`: 是否启用
- `sort_order`: 排序

### ShopProductImage（商城产品图片表）
- `id`: 主键
- `product_id`: 关联产品ID
- `image_url`: 图片URL
- `sort_order`: 排序
- `is_active`: 是否启用

### ShopProductSize（商城产品规格表）
- `id`: 主键
- `product_id`: 关联产品ID
- `size_name`: 规格名称（如：A4尺寸、红色、大号）
- `price`: 价格
- `stock`: 库存（0表示不限）
- `is_active`: 是否启用
- `sort_order`: 排序

### ShopOrder（商城订单表）
- `id`: 主键
- `order_number`: 商城订单号（唯一）
- `original_order_id`: 关联的原始订单ID（可选）
- `original_order_number`: 原始订单号（冗余字段）
- `customer_name`: 收货人姓名
- `customer_phone`: 联系电话
- `openid`: 微信openid
- `customer_address`: 收货地址
- `product_id`: 产品ID
- `product_name`: 产品名称（冗余）
- `size_id`: 规格ID
- `size_name`: 规格名称（冗余）
- `image_url`: 使用的图片URL（来自原始订单）
- `quantity`: 数量
- `price`: 单价
- `total_price`: 总价
- `status`: 订单状态（pending, paid, processing, shipped, completed, cancelled）
- `logistics_info`: 物流信息（JSON格式）
- `payment_time`: 支付时间
- `transaction_id`: 微信支付交易号

## 管理后台功能

### 访问路径
- 商城产品管理：`/admin/shop/products`
- 商城订单管理：`/admin/shop/orders`

### 功能列表
1. **产品管理**
   - 添加商城产品
   - 编辑产品信息
   - 删除产品
   - 上传产品图片（支持多图）
   - 配置产品规格（尺寸/颜色等）
   - 设置价格和库存
   - 启用/禁用产品

2. **订单管理**
   - 查看商城订单列表
   - 筛选订单（按状态、搜索）
   - 查看订单详情
   - 更新订单状态
   - 填写物流信息

## 小程序端功能

### 页面路径
- 商城列表页：`/pages/shop/shop`
- 商品详情页：`/pages/shop-detail/shop-detail`

### API接口
- 获取商城产品列表：`GET /api/miniprogram/shop/products`
- 获取商品详情：`GET /api/miniprogram/shop/products/<product_id>`
- 创建商城订单：`POST /api/miniprogram/shop/orders`
- 获取用户订单列表：`GET /api/miniprogram/shop/orders?openid=xxx`

### 功能流程
1. **进入商城**
   - 从订单详情页点击"进入商城"按钮（订单状态为已完成或已发货时显示）
   - 或直接访问商城页面

2. **浏览商品**
   - 查看商品列表
   - 点击商品查看详情

3. **选择商品**
   - 选择规格（尺寸/颜色等）
   - 选择数量
   - 查看价格

4. **下单**
   - 填写收货信息
   - 提交订单
   - 跳转到支付页面

## 使用说明

### 管理员操作

1. **添加商城产品**
   - 登录管理后台
   - 访问"商城产品管理"
   - 填写产品信息（代码、名称、描述、分类）
   - 上传产品图片
   - 添加产品规格（如：A4尺寸 ¥99、A3尺寸 ¥149）
   - 设置价格和库存
   - 保存产品

2. **管理订单**
   - 访问"商城订单管理"
   - 查看订单列表
   - 更新订单状态
   - 填写物流信息

### 用户操作

1. **从订单详情进入商城**
   - 在订单详情页，当订单状态为"已完成"或"已发货"时
   - 点击"进入商城"按钮
   - 系统会自动关联原始订单

2. **浏览和购买**
   - 浏览商品列表
   - 选择感兴趣的商品
   - 选择规格和数量
   - 填写收货信息
   - 提交订单并支付

## 注意事项

1. **产品分类**：建议使用以下分类代码
   - `photo_frame`: 相框
   - `t_shirt`: T恤
   - `pillow`: 抱枕
   - `mug`: 马克杯
   - `other`: 其他

2. **库存管理**：库存设置为0表示不限库存，大于0表示有限库存

3. **订单关联**：商城订单可以关联到原始AI写真订单，用于：
   - 自动获取用户信息
   - 使用原始订单的效果图
   - 统计二次购买转化率

4. **图片使用**：商城订单会使用原始订单的效果图，确保用户看到的是最终成品

## 后续扩展

1. **购物车功能**：支持多商品一起下单
2. **优惠券支持**：商城订单可以使用优惠券
3. **评价系统**：用户可以对商品进行评价
4. **推荐系统**：根据用户历史订单推荐相关商品
5. **库存预警**：库存不足时自动提醒管理员
