# AI拍照机项目结构梳理和优化方案

## 📋 目录

1. [项目结构评估](#项目结构评估)
2. [目录整理方案](#目录整理方案)
3. [需要修改的模块清单](#需要修改的模块清单)
4. [API接口文档（厂家版）](#api接口文档厂家版)
5. [服务器路径配置说明](#服务器路径配置说明)
6. [性能优化建议](#性能优化建议)

---

## 项目结构评估

### 当前项目结构

```
AI-自拍机项目/
├── AI-studio/              # 后端服务（Flask）
│   ├── test_server.py      # 主服务文件（12601行，需要拆分）
│   ├── *.py                # 235个Python脚本（需要整理）
│   ├── *.md                # 98个说明文档（需要整理）
│   ├── *.bat               # 31个批处理脚本（需要整理）
│   ├── templates/          # HTML模板
│   ├── static/             # 静态资源
│   ├── uploads/            # 上传文件
│   ├── hd_images/          # 效果图
│   └── instance/           # 数据库文件
├── AI-小程序/              # 微信小程序前端
│   ├── pages/              # 页面文件
│   ├── utils/              # 工具函数
│   ├── config.js           # 配置文件
│   └── *.md                # 56个说明文档（需要整理）
├── android-app/            # Android应用
│   ├── app/src/main/java/  # Java源代码
│   ├── ApiService.java     # API服务类
│   └── *.md                # 说明文档
└── GOGO-写真-V2-AI模板板块/ # AI模板相关（可独立）
```

### 问题分析

#### 1. **代码组织问题**
- ❌ `test_server.py` 文件过大（12601行），包含所有路由、模型、业务逻辑
- ❌ 235个Python脚本散落在根目录，难以管理
- ❌ 98个MD文档散落在根目录，查找困难
- ❌ 31个批处理脚本未分类

#### 2. **性能影响评估**
- ✅ **当前影响较小**：文件数量不影响运行时性能
- ⚠️ **潜在问题**：
  - `test_server.py` 过大，影响代码维护和团队协作
  - 大量脚本在根目录，可能影响IDE索引速度
  - 但**不影响并发操作**（Flask多线程/多进程）

#### 3. **维护性问题**
- ❌ 文档分散，难以查找
- ❌ 脚本未分类，难以定位
- ❌ 配置分散，难以统一管理

---

## 目录整理方案

### 建议的新目录结构

```
AI-studio/
├── app/                          # 主应用目录
│   ├── __init__.py              # Flask应用初始化
│   ├── models.py                # 数据库模型（从test_server.py拆分）
│   ├── routes/                  # 路由模块（拆分）
│   │   ├── __init__.py
│   │   ├── admin.py             # 管理后台路由
│   │   ├── miniprogram.py       # 小程序API路由
│   │   ├── order.py              # 订单相关路由
│   │   └── payment.py           # 支付相关路由
│   ├── services/                # 业务逻辑服务
│   │   ├── order_service.py
│   │   ├── payment_service.py
│   │   └── notification_service.py
│   └── utils/                   # 工具函数
│       ├── config.py            # 配置管理
│       └── helpers.py
├── scripts/                     # 脚本目录（整理所有.py脚本）
│   ├── database/                # 数据库相关脚本
│   │   ├── migrations/          # 数据库迁移脚本
│   │   └── maintenance/        # 数据库维护脚本
│   ├── setup/                   # 安装配置脚本
│   ├── tools/                   # 工具脚本
│   └── tests/                   # 测试脚本
├── docs/                        # 文档目录（整理所有.md文档）
│   ├── api/                     # API文档
│   ├── deployment/              # 部署文档
│   ├── features/                # 功能说明文档
│   ├── troubleshooting/         # 问题排查文档
│   └── README.md                # 文档索引
├── batch/                       # 批处理脚本目录
│   ├── setup/                   # 安装配置
│   ├── maintenance/             # 维护脚本
│   └── deployment/              # 部署脚本
├── config/                      # 配置文件目录
│   ├── server_config.py        # 服务器配置（已存在）
│   ├── printer_config.py       # 冲印系统配置
│   └── nginx.conf              # Nginx配置
├── templates/                   # HTML模板（保持不变）
├── static/                      # 静态资源（保持不变）
├── uploads/                     # 上传文件（保持不变）
├── hd_images/                   # 效果图（保持不变）
├── instance/                    # 数据库文件（保持不变）
├── requirements.txt             # Python依赖
├── start.py                     # 启动脚本（主入口）
└── test_server.py              # 保留（向后兼容，逐步迁移）
```

### 整理步骤

#### 阶段1：文档整理（不影响运行）
1. 创建 `docs/` 目录结构
2. 移动所有 `.md` 文件到对应分类目录
3. 创建 `docs/README.md` 索引文件

#### 阶段2：脚本整理（不影响运行）
1. 创建 `scripts/` 目录结构
2. 移动所有 `.py` 脚本到对应分类目录
3. 更新批处理脚本中的路径引用

#### 阶段3：代码重构（需要测试）
1. 拆分 `test_server.py` 为模块化结构
2. 创建 `app/` 目录结构
3. 逐步迁移路由和业务逻辑

---

## 需要修改的模块清单

### 🔴 高优先级（必须修复）

#### 1. **支付模块** ⚠️ 当前已跳过
- **状态**：开发模式已跳过真实支付
- **位置**：
  - `AI-studio/test_server.py` (第86-100行：微信支付配置)
  - `AI-小程序/pages/payment/payment.js` (SKIP_REAL_PAYMENT = true)
- **需要修复**：
  - [ ] 恢复真实微信支付流程
  - [ ] 配置生产环境支付参数
  - [ ] 测试支付回调接口
  - [ ] 处理支付失败场景

#### 2. **通知模块** ⚠️ 当前已禁用
- **状态**：所有通知调用已注释
- **位置**：
  - `AI-studio/test_server.py` (多处：notify_new_order, wechat_notify)
  - `AI-studio/order_notification.py` (桌面通知)
  - `AI-studio/wechat_notification.py` (微信通知)
- **需要修复**：
  - [ ] 恢复订单通知功能
  - [ ] 配置企业微信机器人
  - [ ] 测试通知发送
  - [ ] 处理通知失败重试

#### 3. **服务器路径配置** ⚠️ 需要修改
- **状态**：当前使用本地IP `192.168.2.54:8000`
- **位置**：
  - `AI-studio/server_config.py` (ENV = 'local')
  - `AI-小程序/config.js` (ENV = 'local')
  - `android-app/ApiService.java` (BASE_URL = "http://192.168.2.54:8000")
- **需要修改**：
  - [ ] 切换到生产环境配置
  - [ ] 更新所有URL为 `https://moeart.cc`
  - [ ] 配置SSL证书
  - [ ] 测试生产环境连接

### 🟡 中优先级（建议修复）

#### 4. **订单价格逻辑** ✅ 已修复
- **状态**：已修复订单详情页更新时价格被重置的问题
- **位置**：`AI-studio/test_server.py` (第3658-3677行)

#### 5. **数据库迁移脚本**
- **状态**：多个迁移脚本散落在根目录
- **需要整理**：
  - [ ] 统一迁移脚本到 `scripts/database/migrations/`
  - [ ] 创建迁移脚本索引
  - [ ] 文档化迁移流程

#### 6. **代码模块化**
- **状态**：`test_server.py` 过大，需要拆分
- **需要重构**：
  - [ ] 拆分数据库模型
  - [ ] 拆分路由模块
  - [ ] 拆分业务逻辑服务

### 🟢 低优先级（优化项）

#### 7. **性能优化**
- [ ] 数据库查询优化
- [ ] 图片压缩和缓存
- [ ] API响应时间优化

#### 8. **代码质量**
- [ ] 添加单元测试
- [ ] 代码注释完善
- [ ] 错误处理优化

---

## API接口文档（厂家版）

### 概述

本文档提供给厂家，说明小程序和Android App调用的API接口。

### 基础信息

- **生产环境地址**：`https://moeart.cc`
- **API基础路径**：`/api/miniprogram`
- **请求格式**：JSON
- **响应格式**：JSON

### 小程序API接口

#### 1. 获取用户OpenID
- **接口**：`GET /api/user/openid`
- **说明**：小程序登录后获取用户唯一标识
- **参数**：
  ```json
  {
    "code": "微信登录code"
  }
  ```
- **响应**：
  ```json
  {
    "success": true,
    "openid": "用户OpenID"
  }
  ```

#### 2. 获取产品列表
- **接口**：`GET /api/miniprogram/products`
- **说明**：获取所有可用产品配置
- **响应**：
  ```json
  {
    "status": "success",
    "products": [
      {
        "id": 1,
        "name": "证件照",
        "price": 60.0,
        "sizes": [...],
        "color_options": ["红底", "蓝底", "白底"]
      }
    ]
  }
  ```

#### 3. 获取风格列表
- **接口**：`GET /api/miniprogram/styles?productId=1`
- **说明**：获取产品绑定的风格列表
- **参数**：`productId`（可选，指定产品ID）
- **响应**：
  ```json
  {
    "status": "success",
    "categories": [
      {
        "code": "style1",
        "name": "风格名称",
        "images": [...]
      }
    ]
  }
  ```

#### 4. 提交订单
- **接口**：`POST /api/miniprogram/orders`
- **说明**：创建新订单
- **请求体**：
  ```json
  {
    "openid": "用户OpenID",
    "productName": "证件照",
    "selectedSpec": "1寸-红底",
    "totalPrice": 60.0,
    "customerName": "客户姓名",
    "customerPhone": "手机号"
  }
  ```
- **响应**：
  ```json
  {
    "status": "success",
    "orderId": "PET20250114123456ABCD"
  }
  ```

#### 5. 创建支付订单
- **接口**：`POST /api/payment/create`
- **说明**：创建微信支付订单
- **请求体**：
  ```json
  {
    "orderId": "订单号",
    "totalPrice": 60.0,
    "openid": "用户OpenID"
  }
  ```
- **响应**：
  ```json
  {
    "success": true,
    "payment": {
      "prepay_id": "微信支付预支付ID",
      "timeStamp": "时间戳",
      "nonceStr": "随机字符串",
      "package": "prepay_id=xxx",
      "signType": "MD5",
      "paySign": "签名"
    }
  }
  ```

#### 6. 获取订单列表
- **接口**：`GET /api/miniprogram/orders?openid=xxx`
- **说明**：获取用户的订单列表
- **参数**：`openid`（用户OpenID）
- **响应**：
  ```json
  {
    "status": "success",
    "orders": [
      {
        "orderId": "订单号",
        "productName": "证件照",
        "status": "processing",
        "statusText": "处理中",
        "totalPrice": 60.0,
        "hdImage": "效果图URL"
      }
    ]
  }
  ```

#### 7. 获取订单详情
- **接口**：`GET /api/miniprogram/order/<order_number>`
- **说明**：获取单个订单的详细信息
- **响应**：
  ```json
  {
    "status": "success",
    "order": {
      "orderId": "订单号",
      "productName": "证件照",
      "status": "completed",
      "hdImage": "效果图URL",
      "shootingCompletedAt": "拍摄完成时间",
      "completedAt": "制作完成时间"
    }
  }
  ```

#### 8. 生成订单二维码
- **接口**：`GET /api/miniprogram/order/qrcode?orderId=xxx`
- **说明**：生成订单核销二维码
- **响应**：
  ```json
  {
    "success": true,
    "qrImage": "data:image/png;base64,...",
    "qrContent": "order:订单号"
  }
  ```

### Android App API接口

#### 1. 检查订单状态（核销）
- **接口**：`GET /api/miniprogram/order/check`
- **说明**：Android App扫描二维码后检查订单是否可核销
- **参数**：
  - `orderId`：订单号
  - `machineSerialNumber`：自拍机序列号
- **响应**：
  ```json
  {
    "success": true,
    "order": {
      "orderId": "订单号",
      "is_paid": true,
      "has_photos": false,
      "product_name": "证件照",
      "status": "paid"
    }
  }
  ```
- **错误响应**：
  ```json
  {
    "success": false,
    "message": "该订单已经拍摄过，不能重复拍摄"
  }
  ```

#### 2. 上传照片
- **接口**：`POST /api/miniprogram/order/upload`
- **说明**：Android App拍摄后上传照片
- **请求格式**：`multipart/form-data`
- **参数**：
  - `orderId`：订单号
  - `machineSerialNumber`：自拍机序列号
  - `photos`：照片文件（可多个）
- **响应**：
  ```json
  {
    "success": true,
    "message": "照片上传成功",
    "orderId": "订单号"
  }
  ```
- **业务逻辑**：
  - 上传成功后，订单状态自动更新为 `processing`（处理中）
  - 记录 `shooting_completed_at`（拍摄完成时间）
  - 通过 `machineSerialNumber` 关联订单到对应的加盟商和门店

### 订单状态说明

| 状态值 | 中文显示 | 说明 |
|--------|---------|------|
| `unpaid` | 待支付 | 订单已创建，等待支付 |
| `paid` | 已支付 | 已支付，等待拍摄 |
| `processing` | 处理中 | 自拍机已拍摄，等待后台制作效果图 |
| `completed` | 已完成 | 效果图已制作完成 |

### 错误码说明

| 错误码 | 说明 |
|--------|------|
| 400 | 请求参数错误 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

## 服务器路径配置说明

### 当前配置

#### 后端配置 (`AI-studio/server_config.py`)
```python
ENV = 'local'  # 当前为本地环境

SERVER_CONFIG = {
    'local': {
        'base_url': 'http://192.168.2.54:8000',
        'api_base_url': 'http://192.168.2.54:8000/api',
        ...
    },
    'production': {
        'base_url': 'https://moeart.cc',
        'api_base_url': 'https://moeart.cc/api',
        ...
    }
}
```

#### 小程序配置 (`AI-小程序/config.js`)
```javascript
const ENV = 'local';  // 当前为本地环境

SERVER_CONFIG = {
  local: {
    baseUrl: 'http://192.168.2.54:8000',
    apiBaseUrl: 'http://192.168.2.54:8000/api/miniprogram',
    ...
  },
  production: {
    baseUrl: 'https://moeart.cc',
    apiBaseUrl: 'https://moeart.cc/api/miniprogram',
    ...
  }
}
```

#### Android App配置 (`android-app/ApiService.java`)
```java
private static final String BASE_URL = "http://192.168.2.54:8000/api/miniprogram";
```

### 切换到生产环境

#### 步骤1：修改后端配置
```bash
# 方法1：使用批处理脚本
AI-studio/switch_env_production.bat

# 方法2：手动修改
# 编辑 AI-studio/server_config.py
ENV = 'production'  # 改为 'production'
```

#### 步骤2：修改小程序配置
```javascript
// 编辑 AI-小程序/config.js
const ENV = 'production';  // 改为 'production'
```

#### 步骤3：修改Android App配置
```java
// 编辑 android-app/app/src/main/java/com/aphoto/camera/ApiService.java
private static final String BASE_URL = "https://moeart.cc/api/miniprogram";
```

#### 步骤4：配置SSL证书
- 确保Nginx配置了SSL证书
- 测试HTTPS连接
- 更新微信小程序合法域名配置

---

## 性能优化建议

### 1. 代码层面
- ✅ **当前状态**：不影响并发操作
- ⚠️ **建议**：
  - 拆分大文件，提高代码可维护性
  - 使用Flask Blueprint组织路由
  - 添加数据库连接池

### 2. 数据库层面
- ✅ **当前状态**：SQLite，适合中小规模
- ⚠️ **建议**（如果订单量大）：
  - 考虑迁移到PostgreSQL或MySQL
  - 添加数据库索引
  - 优化慢查询

### 3. 文件存储
- ✅ **当前状态**：本地文件存储
- ⚠️ **建议**（如果文件量大）：
  - 考虑使用对象存储（OSS/COS）
  - 添加CDN加速
  - 图片压缩和缩略图

### 4. 缓存策略
- ⚠️ **建议**：
  - 添加Redis缓存
  - 缓存产品列表、风格列表
  - 缓存订单状态查询

---

## 总结

### 立即执行（不影响运行）
1. ✅ 整理文档到 `docs/` 目录
2. ✅ 整理脚本到 `scripts/` 目录
3. ✅ 整理批处理脚本到 `batch/` 目录

### 后续修复（需要测试）
1. ⚠️ 恢复支付模块
2. ⚠️ 恢复通知模块
3. ⚠️ 切换到生产环境配置
4. ⚠️ 代码模块化重构

### 长期优化
1. 🔄 性能优化
2. 🔄 代码质量提升
3. 🔄 测试覆盖

---

**文档版本**：v1.0  
**最后更新**：2026-01-14  
**维护者**：开发团队
