# ä»£ç æ‹†åˆ†å®Œæˆæ€»ç»“

**å®Œæˆæ—¶é—´**: 2026-02-01

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. `app/routes/user_api.py` æ‹†åˆ†ï¼ˆ1570è¡Œ â†’ 7ä¸ªæ¨¡å—ï¼‰

**æ‹†åˆ†ç»“æœï¼š**

| æ¨¡å—æ–‡ä»¶ | åŠŸèƒ½ | è·¯ç”±æ•° | è¡Œæ•° |
|---------|------|--------|------|
| `user_api/auth.py` | ç”¨æˆ·è®¤è¯ | 3ä¸ª | ~370è¡Œ |
| `user_api/profile.py` | ç”¨æˆ·ä¿¡æ¯ç®¡ç† | 3ä¸ª | ~200è¡Œ |
| `user_api/promotion.py` | æ¨å¹¿ç›¸å…³ | 4ä¸ª | ~250è¡Œ |
| `user_api/commission.py` | ä½£é‡‘æç° | 2ä¸ª | ~150è¡Œ |
| `user_api/visit.py` | è®¿é—®ç»Ÿè®¡ | 2ä¸ª | ~200è¡Œ |
| `user_api/messages.py` | æ¶ˆæ¯ç®¡ç† | 4ä¸ª | ~200è¡Œ |
| `user_api/coupons.py` | ä¼˜æƒ åˆ¸ | 1ä¸ª | ~80è¡Œ |
| `user_api/__init__.py` | ä¸»è“å›¾æ•´åˆ | - | ~20è¡Œ |

**æ‹†åˆ†è¯¦æƒ…ï¼š**

#### `user_api/auth.py` - ç”¨æˆ·è®¤è¯æ¨¡å—
- `/api/user/check` - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
- `/api/user/openid` - è·å–ç”¨æˆ·openid
- `/api/user/register` - ç”¨æˆ·æ³¨å†Œ

#### `user_api/profile.py` - ç”¨æˆ·ä¿¡æ¯ç®¡ç†æ¨¡å—
- `/api/user/update-info` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- `/api/user/phone` - è§£å¯†è·å–ç”¨æˆ·æ‰‹æœºå·
- `/api/user/update-phone` - æ›´æ–°ç”¨æˆ·æ‰‹æœºå·

#### `user_api/promotion.py` - æ¨å¹¿ç›¸å…³æ¨¡å—
- `/api/user/check-promotion-eligibility` - æ£€æŸ¥æ¨å¹¿èµ„æ ¼
- `/api/user/update-promotion-eligibility` - æ›´æ–°æ¨å¹¿èµ„æ ¼
- `/api/user/request-subscription-after-payment` - æ”¯ä»˜åè®¢é˜…è¯·æ±‚
- `/api/user/subscription-status` - æ›´æ–°è®¢é˜…çŠ¶æ€

#### `user_api/commission.py` - ä½£é‡‘æç°æ¨¡å—
- `/api/user/commission` - è·å–ç”¨æˆ·åˆ†ä½£æ•°æ®
- `/api/user/withdrawals` - è·å–ç”¨æˆ·æç°ç”³è¯·è®°å½•

#### `user_api/visit.py` - è®¿é—®ç»Ÿè®¡æ¨¡å—
- `/api/user/visit` - è®°å½•ç”¨æˆ·è®¿é—®ï¼ˆæ”¯æŒå¼‚æ­¥å¤„ç†ï¼‰
- `/api/user/visit/stats` - è·å–ç”¨æˆ·è®¿é—®ç»Ÿè®¡

#### `user_api/messages.py` - æ¶ˆæ¯ç®¡ç†æ¨¡å—
- `/api/user/messages/unread-count` - è·å–æœªè¯»æ¶ˆæ¯æ•°é‡
- `/api/user/messages` - è·å–æ¶ˆæ¯åˆ—è¡¨
- `/api/user/messages/check` - æ£€æŸ¥æ–°æ¶ˆæ¯
- `/api/user/messages/read` - æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»

#### `user_api/coupons.py` - ä¼˜æƒ åˆ¸æ¨¡å—
- `/api/user/coupons/available-count` - è·å–å¯é¢†å–çš„ä¼˜æƒ åˆ¸æ•°é‡

---

### 2. AI æœåŠ¡å•†æ¨¡å—åŒ–å®Œå–„

**å·²å®Œæˆï¼š**
- âœ… å®Œå–„ `app/services/api_providers/__init__.py`
- âœ… æ³¨å†Œæ‰€æœ‰æœåŠ¡å•†ï¼ˆnano-banana, nano-banana-edits, gemini-native, veo-video, runninghub-rhart-edit, runninghub-comfyui-workflowï¼‰
- âœ… `ai_provider_service.py` å·²æ”¯æŒæ¸è¿›å¼é‡æ„ï¼ˆä¼˜å…ˆä½¿ç”¨æ¨¡å—åŒ–å®ç°ï¼Œå¤±è´¥åˆ™å›é€€åˆ°æ—§ä»£ç ï¼‰

**å½“å‰çŠ¶æ€ï¼š**
- `ai_provider_service.py` ä¸­ä»æœ‰éƒ¨åˆ†æ—§ä»£ç ï¼ˆçº¦2300è¡Œï¼‰
- å·²å®ç°çš„æœåŠ¡å•†ä¼šä¼˜å…ˆä½¿ç”¨æ¨¡å—åŒ–å®ç°
- æœªå®ç°çš„æœåŠ¡å•†ä¼šå›é€€åˆ°æ—§ä»£ç 

**å»ºè®®ï¼š**
- åç»­å¯ä»¥é€æ­¥å°† `ai_provider_service.py` ä¸­çš„æ—§ä»£ç è¿ç§»åˆ°å¯¹åº”çš„ Provider ç±»
- æ‰€æœ‰æœåŠ¡å•†éƒ½è¿ç§»å®Œæˆåï¼Œå¯ä»¥åˆ é™¤æ—§ä»£ç 

---

## ğŸ“Š æ‹†åˆ†æˆæœ

### æ–‡ä»¶å¤§å°å˜åŒ–

**æ‹†åˆ†å‰ï¼š**
- `user_api.py`: 1570è¡Œï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰

**æ‹†åˆ†åï¼š**
- `user_api/` ç›®å½•: 8ä¸ªæ–‡ä»¶ï¼Œæ€»è®¡çº¦1470è¡Œ
- æ¯ä¸ªæ¨¡å—çº¦ 80-370 è¡Œï¼ŒèŒè´£æ¸…æ™°

### ä»£ç è´¨é‡æå‡

- âœ… **æ¨¡å—èŒè´£æ›´æ¸…æ™°** - æ¯ä¸ªæ–‡ä»¶åŠŸèƒ½å•ä¸€
- âœ… **ä¾¿äºç»´æŠ¤** - ä»£ç ç»„ç»‡æ›´åˆç†
- âœ… **ä¾¿äºæµ‹è¯•** - æ¨¡å—åŒ–åæ›´æ˜“æµ‹è¯•
- âœ… **ä¾¿äºåä½œ** - ä¸åŒå¼€å‘è€…å¯ä»¥å¹¶è¡Œå¼€å‘ä¸åŒæ¨¡å—

---

## ğŸ”§ æŠ€æœ¯å®ç°

### è“å›¾æ³¨å†Œæ–¹å¼

æ‰€æœ‰å­æ¨¡å—ç›´æ¥åœ¨ä¸»è“å›¾ä¸Šæ³¨å†Œè·¯ç”±ï¼š

```python
# user_api/__init__.py
user_api_bp = Blueprint('user_api', __name__, url_prefix='/api/user')

# user_api/auth.py
from . import user_api_bp

@user_api_bp.route('/check', methods=['POST'])
def check_user():
    ...
```

### æ¨¡å‹è·å–æ–¹å¼

æ‰€æœ‰å­æ¨¡å—ä½¿ç”¨ç»Ÿä¸€çš„ `get_models()` å‡½æ•°ï¼š

```python
def get_models():
    """è·å–æ•°æ®åº“æ¨¡å‹å’Œé…ç½®ï¼ˆå»¶è¿Ÿå¯¼å…¥ï¼‰"""
    if 'test_server' not in sys.modules:
        return None
    test_server_module = sys.modules['test_server']
    return {
        'db': test_server_module.db,
        'User': test_server_module.User,
        ...
    }
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šæ‰€æœ‰è·¯ç”±URLè·¯å¾„ä¿æŒä¸å˜ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
2. **å¯¼å…¥æ–¹å¼**ï¼š`test_server.py` ä¸­çš„å¯¼å…¥æ–¹å¼ä¿æŒä¸å˜ï¼š
   ```python
   from app.routes.user_api import user_api_bp
   ```
3. **å¤‡ä»½æ–‡ä»¶**ï¼šåŸ `user_api.py` å·²å¤‡ä»½ä¸º `user_api.py.backup`ï¼ˆå¦‚æœéœ€è¦å¯ä»¥æ¢å¤ï¼‰

---

## ğŸ“‹ åç»­å»ºè®®

### å¯é€‰ä¼˜åŒ–

1. **ç»Ÿä¸€ `get_models()` å‡½æ•°**
   - å½“å‰æ¯ä¸ªå­æ¨¡å—éƒ½æœ‰è‡ªå·±çš„ `get_models()` å‡½æ•°
   - å¯ä»¥åˆ›å»º `app/utils/user_api_helpers.py` ç»Ÿä¸€ç®¡ç†

2. **AI æœåŠ¡å•†ä»£ç è¿ç§»**
   - ç»§ç»­å°† `ai_provider_service.py` ä¸­çš„æ—§ä»£ç è¿ç§»åˆ° Provider ç±»
   - æ‰€æœ‰æœåŠ¡å•†è¿ç§»å®Œæˆåï¼Œåˆ é™¤æ—§ä»£ç 

3. **æµ‹è¯•è¦†ç›–**
   - ä¸ºæ¯ä¸ªæ¨¡å—æ·»åŠ å•å…ƒæµ‹è¯•
   - ç¡®ä¿æ‰€æœ‰è·¯ç”±æ­£å¸¸å·¥ä½œ

---

## âœ… éªŒè¯

- âœ… æ¨¡å—å¯¼å…¥æµ‹è¯•é€šè¿‡
- âœ… è“å›¾æ³¨å†Œæ­£å¸¸
- âœ… æ— è¯­æ³•é”™è¯¯
- âœ… è·¯ç”±è·¯å¾„ä¿æŒä¸å˜

---

**æ‹†åˆ†å®Œæˆï¼** ğŸ‰
