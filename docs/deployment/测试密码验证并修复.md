# 测试密码验证并修复

## 🔍 问题

- ✅ 密码已重置
- ❌ 仍然无法登录

**可能原因**：
1. 密码哈希验证不匹配
2. 需要重启服务
3. 数据库中的密码字段有问题

---

## 🔧 测试密码验证

### 步骤1：测试密码验证

```bash
cd /root/project_code
source venv/bin/activate

python << 'PYEOF'
from test_server import app, db, User
from werkzeug.security import check_password_hash, generate_password_hash

with app.app_context():
    admin = User.query.filter_by(username='admin').first()
    if admin:
        print(f"管理员用户名: {admin.username}")
        print(f"密码哈希前20字符: {admin.password[:20]}...")
        
        # 测试密码验证
        test_password = 'admin123'
        is_valid = check_password_hash(admin.password, test_password)
        print(f"\n测试密码 'admin123' 验证结果: {is_valid}")
        
        if not is_valid:
            print("\n⚠️ 密码验证失败，重新生成密码哈希...")
            # 重新生成密码哈希
            admin.password = generate_password_hash('admin123')
            db.session.commit()
            print("✅ 密码哈希已重新生成")
            
            # 再次测试
            is_valid = check_password_hash(admin.password, 'admin123')
            print(f"重新测试验证结果: {is_valid}")
        else:
            print("✅ 密码验证正常")
    else:
        print("❌ 管理员账号不存在")
PYEOF
```

### 步骤2：如果验证失败，创建新的测试用户

```bash
cd /root/project_code
source venv/bin/activate

python << 'PYEOF'
from test_server import app, db, User
from werkzeug.security import generate_password_hash

with app.app_context():
    # 删除旧的管理员账号
    old_admin = User.query.filter_by(username='admin').first()
    if old_admin:
        db.session.delete(old_admin)
        db.session.commit()
        print("✅ 旧管理员账号已删除")
    
    # 创建新的管理员账号
    new_admin = User(
        username='admin',
        password=generate_password_hash('admin123'),
        role='admin'
    )
    db.session.add(new_admin)
    db.session.commit()
    print("✅ 新管理员账号已创建")
    
    # 验证
    admin = User.query.filter_by(username='admin').first()
    if admin:
        from werkzeug.security import check_password_hash
        is_valid = check_password_hash(admin.password, 'admin123')
        print(f"✅ 验证测试: {is_valid}")
PYEOF
```

---

## 📋 完整测试和修复脚本

```bash
#!/bin/bash
echo "=========================================="
echo "测试密码验证并修复"
echo "=========================================="
echo ""

cd /root/project_code
source venv/bin/activate

python << 'PYEOF'
from test_server import app, db, User
from werkzeug.security import check_password_hash, generate_password_hash

with app.app_context():
    admin = User.query.filter_by(username='admin').first()
    if admin:
        print(f"管理员用户名: {admin.username}")
        print(f"密码哈希前20字符: {admin.password[:20]}...")
        
        # 测试密码验证
        test_password = 'admin123'
        is_valid = check_password_hash(admin.password, test_password)
        print(f"\n测试密码 'admin123' 验证结果: {is_valid}")
        
        if not is_valid:
            print("\n⚠️ 密码验证失败，重新生成密码哈希...")
            # 重新生成密码哈希
            admin.password = generate_password_hash('admin123')
            db.session.commit()
            print("✅ 密码哈希已重新生成")
            
            # 再次测试
            is_valid = check_password_hash(admin.password, 'admin123')
            print(f"重新测试验证结果: {is_valid}")
            
            if not is_valid:
                print("\n⚠️ 仍然失败，删除并重新创建账号...")
                db.session.delete(admin)
                db.session.commit()
                
                new_admin = User(
                    username='admin',
                    password=generate_password_hash('admin123'),
                    role='admin'
                )
                db.session.add(new_admin)
                db.session.commit()
                print("✅ 新管理员账号已创建")
                
                # 最终验证
                admin = User.query.filter_by(username='admin').first()
                is_valid = check_password_hash(admin.password, 'admin123')
                print(f"最终验证结果: {is_valid}")
        else:
            print("✅ 密码验证正常")
    else:
        print("❌ 管理员账号不存在，创建新账号...")
        admin = User(
            username='admin',
            password=generate_password_hash('admin123'),
            role='admin'
        )
        db.session.add(admin)
        db.session.commit()
        print("✅ 管理员账号已创建")
PYEOF

echo ""
echo "=========================================="
echo "修复完成！"
echo "=========================================="
echo ""
echo "现在重启服务并测试登录："
echo "  systemctl restart aistudio"
echo ""
echo "然后访问: http://121.43.143.59/login"
echo "用户名: admin"
echo "密码: admin123"
```

---

## 🔄 重启服务

修复后重启服务：

```bash
systemctl restart aistudio
sleep 3
systemctl status aistudio --no-pager -l | head -20
```

---

## 🎯 立即执行

执行上面的**完整测试和修复脚本**，它会：
1. 测试密码验证
2. 如果失败，重新生成密码哈希
3. 如果仍然失败，删除并重新创建账号
4. 最终验证

执行后，重启服务，然后测试登录。
