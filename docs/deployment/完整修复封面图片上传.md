# å®Œæ•´ä¿®å¤é£æ ¼åˆ†ç±»å°é¢å›¾ç‰‡ä¸Šä¼ å¤±è´¥

## ğŸ” é—®é¢˜åˆ†æ

å°é¢å›¾ç‰‡ä¸Šä¼ ä½¿ç”¨ `/api/admin/upload-image` æ¥å£ï¼Œä¸Šä¼ åˆ° `uploads/` ç›®å½•ï¼Œç„¶åé€šè¿‡ `/media/original/` è®¿é—®ã€‚

å¯èƒ½çš„é—®é¢˜ï¼š
1. **ä¸Šä¼ ç›®å½•æƒé™ä¸è¶³**
2. **Nginx ç¼ºå°‘ `/media/original/` location é…ç½®**
3. **æ–‡ä»¶ä¿å­˜åæ— æ³•è®¿é—®**

---

## ğŸ”§ å®Œæ•´ä¿®å¤æ­¥éª¤

### æ­¥éª¤1ï¼šä¿®å¤ä¸Šä¼ ç›®å½•æƒé™

```bash
# ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨
mkdir -p /root/project_code/uploads
mkdir -p /root/project_code/static/images

# è®¾ç½®æƒé™
chmod -R 755 /root/project_code/uploads
chmod -R 755 /root/project_code/static
find /root/project_code/uploads -type d -exec chmod 755 {} \;
find /root/project_code/uploads -type f -exec chmod 644 {} \;
```

### æ­¥éª¤2ï¼šæ£€æŸ¥å¹¶ä¿®å¤ Nginx é…ç½®

```bash
# æ£€æŸ¥å½“å‰é…ç½®
grep -A 5 "location /media/" /etc/nginx/sites-available/aistudio
```

å¦‚æœç¼ºå°‘ `/media/original/` locationï¼Œéœ€è¦æ·»åŠ ï¼š

```bash
# ç¼–è¾‘ Nginx é…ç½®
nano /etc/nginx/sites-available/aistudio
```

åœ¨ `location /static/` ä¹‹åæ·»åŠ ï¼š

```nginx
# ä¸Šä¼ æ–‡ä»¶å¤„ç†
location /uploads/ {
    alias /root/project_code/uploads/;
    expires 7d;
    access_log off;
}

# åª’ä½“æ–‡ä»¶å¤„ç†ï¼ˆåŸå›¾ï¼‰
location /media/original/ {
    alias /root/project_code/uploads/;
    expires 7d;
    add_header Cache-Control "public";
    access_log off;
}

# åª’ä½“æ–‡ä»¶å¤„ç†ï¼ˆæ•ˆæœå›¾ï¼‰
location /media/final/ {
    alias /root/project_code/final_works/;
    expires 30d;
    add_header Cache-Control "public, immutable";
    access_log off;
}

# é«˜æ¸…å›¾ç‰‡å¤„ç†
location /media/hd/ {
    alias /root/project_code/hd_images/;
    expires 30d;
    add_header Cache-Control "public, immutable";
    access_log off;
}
```

### æ­¥éª¤3ï¼šæµ‹è¯•å¹¶é‡å¯

```bash
# æµ‹è¯•é…ç½®
nginx -t

# é‡å¯ Nginx
systemctl restart nginx

# é‡å¯åº”ç”¨
systemctl restart aistudio
```

---

## ğŸ¯ ä¸€é”®ä¿®å¤è„šæœ¬

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd /root/project_code

# åˆ›å»ºä¿®å¤è„šæœ¬
cat > /tmp/fix_cover_upload.sh << 'EOF'
#!/bin/bash
echo "ä¿®å¤å°é¢å›¾ç‰‡ä¸Šä¼ é—®é¢˜..."

# 1. åˆ›å»ºç›®å½•
mkdir -p /root/project_code/uploads
mkdir -p /root/project_code/static/images
mkdir -p /root/project_code/final_works
mkdir -p /root/project_code/hd_images

# 2. è®¾ç½®æƒé™
chmod -R 755 /root/project_code/uploads
chmod -R 755 /root/project_code/static
chmod -R 755 /root/project_code/final_works
chmod -R 755 /root/project_code/hd_images
find /root/project_code/uploads -type d -exec chmod 755 {} \;
find /root/project_code/uploads -type f -exec chmod 644 {} \;

# 3. æ£€æŸ¥ Nginx é…ç½®
NGINX_CONFIG="/etc/nginx/sites-available/aistudio"

if ! grep -q "location /media/original/" "$NGINX_CONFIG"; then
    echo "æ·»åŠ  /media/original/ location..."
    # åœ¨ /static/ location åæ·»åŠ 
    sed -i '/location \/static\/ {/,/}/a\\n    # ä¸Šä¼ æ–‡ä»¶å¤„ç†\n    location /uploads/ {\n        alias /root/project_code/uploads/;\n        expires 7d;\n        access_log off;\n    }\n\n    # åª’ä½“æ–‡ä»¶å¤„ç†ï¼ˆåŸå›¾ï¼‰\n    location /media/original/ {\n        alias /root/project_code/uploads/;\n        expires 7d;\n        add_header Cache-Control "public";\n        access_log off;\n    }\n\n    # åª’ä½“æ–‡ä»¶å¤„ç†ï¼ˆæ•ˆæœå›¾ï¼‰\n    location /media/final/ {\n        alias /root/project_code/final_works/;\n        expires 30d;\n        add_header Cache-Control "public, immutable";\n        access_log off;\n    }\n\n    # é«˜æ¸…å›¾ç‰‡å¤„ç†\n    location /media/hd/ {\n        alias /root/project_code/hd_images/;\n        expires 30d;\n        add_header Cache-Control "public, immutable";\n        access_log off;\n    }' "$NGINX_CONFIG"
fi

# 4. æµ‹è¯•å¹¶é‡å¯
nginx -t && systemctl restart nginx
systemctl restart aistudio

echo "âœ… ä¿®å¤å®Œæˆ"
EOF

chmod +x /tmp/fix_cover_upload.sh
/tmp/fix_cover_upload.sh
```

---

## ğŸ“ éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥ç›®å½•æƒé™

```bash
ls -ld /root/project_code/uploads
ls -ld /root/project_code/static
```

åº”è¯¥æ˜¾ç¤º `drwxr-xr-x` (755)

### 2. æ£€æŸ¥ Nginx é…ç½®

```bash
grep -A 5 "location /media/original/" /etc/nginx/sites-available/aistudio
```

åº”è¯¥çœ‹åˆ°é…ç½®å­˜åœ¨

### 3. æµ‹è¯•ä¸Šä¼ 

åœ¨ç®¡ç†åå°ï¼š
1. è¿›å…¥ï¼š**é£æ ¼ç®¡ç†** â†’ **é£æ ¼åˆ†ç±»ç®¡ç†**
2. é€‰æ‹©ä¸€ä¸ªåˆ†ç±»ï¼Œç‚¹å‡»"ç¼–è¾‘"
3. å°è¯•ä¸Šä¼ å°é¢å›¾ç‰‡
4. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹ Network æ ‡ç­¾
5. æ£€æŸ¥ä¸Šä¼ è¯·æ±‚æ˜¯å¦æˆåŠŸï¼ˆ200ï¼‰

### 4. æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹ä¸Šä¼ æ—¥å¿—
tail -f /root/project_code/logs/error.log | grep -i "upload\|image"

# æˆ–æŸ¥çœ‹ systemd æ—¥å¿—
journalctl -u aistudio -f | grep -i "upload\|image"
```

---

## ğŸ” å¦‚æœä»ç„¶å¤±è´¥

### æ£€æŸ¥è¯¦ç»†é”™è¯¯

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -50 /root/project_code/logs/error.log

# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
tail -20 /var/log/nginx/error.log

# æµ‹è¯•ä¸Šä¼ ç›®å½•å†™å…¥
touch /root/project_code/uploads/test.txt && rm /root/project_code/uploads/test.txt
```

### æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶

```bash
# æ£€æŸ¥ Nginx é…ç½®
grep "client_max_body_size" /etc/nginx/sites-available/aistudio

# å¦‚æœæ²¡æœ‰æˆ–å¤ªå°ï¼Œæ·»åŠ ï¼ˆåœ¨ server å—ä¸­ï¼‰
# client_max_body_size 100M;
```

### æ‰‹åŠ¨æµ‹è¯•ä¸Šä¼ æ¥å£

```bash
# åˆ›å»ºä¸€ä¸ªæµ‹è¯•å›¾ç‰‡
echo "test" > /tmp/test.txt

# æµ‹è¯•ä¸Šä¼ æ¥å£ï¼ˆéœ€è¦å…ˆç™»å½•è·å– cookieï¼‰
curl -X POST http://localhost:8000/api/admin/upload-image \
  -H "Cookie: session=YOUR_SESSION_COOKIE" \
  -F "image=@/tmp/test.txt"
```

---

## ğŸ“‹ å¸¸è§é”™è¯¯

### é”™è¯¯1ï¼šPermission denied

**åŸå› **ï¼šç›®å½•æƒé™ä¸è¶³

**è§£å†³**ï¼š
```bash
chmod -R 755 /root/project_code/uploads
```

### é”™è¯¯2ï¼š404 Not Found

**åŸå› **ï¼šNginx ç¼ºå°‘ `/media/original/` location

**è§£å†³**ï¼šæŒ‰ç…§æ­¥éª¤2æ·»åŠ  Nginx é…ç½®

### é”™è¯¯3ï¼š413 Request Entity Too Large

**åŸå› **ï¼šæ–‡ä»¶è¶…è¿‡å¤§å°é™åˆ¶

**è§£å†³**ï¼š
```bash
# åœ¨ Nginx é…ç½®ä¸­æ·»åŠ 
client_max_body_size 100M;
```

### é”™è¯¯4ï¼šæ–‡ä»¶ä¿å­˜æˆåŠŸä½†æ— æ³•è®¿é—®

**åŸå› **ï¼šNginx é…ç½®è·¯å¾„ä¸æ­£ç¡®

**è§£å†³**ï¼šæ£€æŸ¥ Nginx é…ç½®ä¸­çš„ `alias` è·¯å¾„æ˜¯å¦æ­£ç¡®
