# ä¿®å¤é£æ ¼åˆ†ç±»å°é¢æ›¿æ¢å¤±è´¥

## ğŸ” é—®é¢˜åˆ†æ

é£æ ¼åˆ†ç±»å°é¢æ›¿æ¢å¤±è´¥ï¼Œå¯èƒ½çš„åŸå› ï¼š
1. **æ–‡ä»¶ä¸Šä¼ è·¯å¾„é—®é¢˜** - ä¸Šä¼ çš„æ–‡ä»¶æ²¡æœ‰ä¿å­˜åˆ°æ­£ç¡®ä½ç½®
2. **æƒé™é—®é¢˜** - ä¸Šä¼ ç›®å½•æ²¡æœ‰å†™å…¥æƒé™
3. **Nginx é…ç½®é—®é¢˜** - åª’ä½“æ–‡ä»¶è·¯å¾„é…ç½®ä¸æ­£ç¡®
4. **æ–‡ä»¶å¤§å°é™åˆ¶** - è¶…è¿‡ä¸Šä¼ å¤§å°é™åˆ¶

---

## ğŸ”§ æ’æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥ä¸Šä¼ ç›®å½•æƒé™

```bash
# æ£€æŸ¥ä¸Šä¼ ç›®å½•
ls -ld /root/project_code/uploads
ls -ld /root/project_code/static/images

# æ£€æŸ¥æƒé™
chmod -R 755 /root/project_code/uploads
chmod -R 755 /root/project_code/static
find /root/project_code/uploads -type d -exec chmod 755 {} \;
find /root/project_code/uploads -type f -exec chmod 644 {} \;
```

### æ­¥éª¤2ï¼šæ£€æŸ¥ Nginx åª’ä½“æ–‡ä»¶é…ç½®

```bash
# æ£€æŸ¥ Nginx é…ç½®
grep -A 5 "location /media/" /etc/nginx/sites-available/aistudio
grep -A 5 "location /uploads/" /etc/nginx/sites-available/aistudio
```

åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
```nginx
location /uploads/ {
    alias /root/project_code/uploads/;
    expires 7d;
    access_log off;
}

location /media/original/ {
    alias /root/project_code/uploads/;
    expires 7d;
    add_header Cache-Control "public";
    access_log off;
}
```

### æ­¥éª¤3ï¼šæ£€æŸ¥åº”ç”¨æ—¥å¿—

```bash
# æŸ¥çœ‹åº”ç”¨é”™è¯¯æ—¥å¿—
tail -50 /root/project_code/logs/error.log | grep -i "cover\|upload\|image"

# æŸ¥çœ‹ Gunicorn æ—¥å¿—
journalctl -u aistudio -n 50 | grep -i "cover\|upload\|image"
```

### æ­¥éª¤4ï¼šæ£€æŸ¥æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶

```bash
# æ£€æŸ¥ Nginx é…ç½®ä¸­çš„ client_max_body_size
grep "client_max_body_size" /etc/nginx/sites-available/aistudio

# æ£€æŸ¥ Flask é…ç½®
grep "MAX_CONTENT_LENGTH" /root/project_code/test_server.py
```

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤ä¸Šä¼ ç›®å½•æƒé™

```bash
# ç¡®ä¿ä¸Šä¼ ç›®å½•å­˜åœ¨
mkdir -p /root/project_code/uploads
mkdir -p /root/project_code/static/images

# è®¾ç½®æƒé™
chmod -R 755 /root/project_code/uploads
chmod -R 755 /root/project_code/static
find /root/project_code/uploads -type d -exec chmod 755 {} \;
find /root/project_code/uploads -type f -exec chmod 644 {} \;

# é‡å¯æœåŠ¡
systemctl restart aistudio
```

### æ–¹æ¡ˆ2ï¼šæ£€æŸ¥å¹¶ä¿®å¤ Nginx é…ç½®

å¦‚æœ Nginx é…ç½®ä¸­ç¼ºå°‘ `/uploads/` æˆ– `/media/` locationï¼Œæ·»åŠ ï¼š

```bash
# ç¼–è¾‘ Nginx é…ç½®
nano /etc/nginx/sites-available/aistudio
```

æ·»åŠ ä»¥ä¸‹é…ç½®ï¼ˆåœ¨ `location /static/` ä¹‹åï¼‰ï¼š

```nginx
# ä¸Šä¼ æ–‡ä»¶å¤„ç†
location /uploads/ {
    alias /root/project_code/uploads/;
    expires 7d;
    access_log off;
}

# åª’ä½“æ–‡ä»¶å¤„ç†ï¼ˆåŸå›¾ï¼‰
location /media/original/ {
    alias /root/project_code/uploads/;
    expires 7d;
    add_header Cache-Control "public";
    access_log off;
}

# åª’ä½“æ–‡ä»¶å¤„ç†ï¼ˆæ•ˆæœå›¾ï¼‰
location /media/final/ {
    alias /root/project_code/final_works/;
    expires 30d;
    add_header Cache-Control "public, immutable";
    access_log off;
}
```

ç„¶åæµ‹è¯•å¹¶é‡å¯ï¼š

```bash
nginx -t && systemctl restart nginx
```

### æ–¹æ¡ˆ3ï¼šæ£€æŸ¥æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶

ç¡®ä¿ Nginx å’Œ Flask éƒ½å…è®¸è¶³å¤Ÿå¤§çš„æ–‡ä»¶ï¼š

```bash
# æ£€æŸ¥ Nginx
grep "client_max_body_size" /etc/nginx/sites-available/aistudio

# å¦‚æœæ²¡æœ‰æˆ–å¤ªå°ï¼Œæ·»åŠ ï¼ˆåœ¨ server å—ä¸­ï¼‰
# client_max_body_size 100M;
```

---

## ğŸ¯ å®Œæ•´ä¿®å¤è„šæœ¬

```bash
#!/bin/bash
echo "ä¿®å¤é£æ ¼åˆ†ç±»å°é¢æ›¿æ¢é—®é¢˜..."

# 1. åˆ›å»ºç›®å½•
mkdir -p /root/project_code/uploads
mkdir -p /root/project_code/static/images
mkdir -p /root/project_code/final_works

# 2. è®¾ç½®æƒé™
chmod -R 755 /root/project_code/uploads
chmod -R 755 /root/project_code/static
chmod -R 755 /root/project_code/final_works
find /root/project_code/uploads -type d -exec chmod 755 {} \;
find /root/project_code/uploads -type f -exec chmod 644 {} \;

# 3. æ£€æŸ¥ Nginx é…ç½®
echo "æ£€æŸ¥ Nginx é…ç½®..."
if ! grep -q "location /uploads/" /etc/nginx/sites-available/aistudio; then
    echo "æ·»åŠ  /uploads/ location..."
    # åœ¨ /static/ location åæ·»åŠ 
    sed -i '/location \/static\/ {/a\\n    # ä¸Šä¼ æ–‡ä»¶å¤„ç†\n    location /uploads/ {\n        alias /root/project_code/uploads/;\n        expires 7d;\n        access_log off;\n    }' /etc/nginx/sites-available/aistudio
fi

# 4. æµ‹è¯•å¹¶é‡å¯
nginx -t && systemctl restart nginx
systemctl restart aistudio

echo "âœ… ä¿®å¤å®Œæˆ"
```

---

## ğŸ“ éªŒè¯

ä¿®å¤åï¼Œåœ¨ç®¡ç†åå°ï¼š
1. è¿›å…¥ï¼š**é£æ ¼ç®¡ç†** â†’ **é£æ ¼åˆ†ç±»ç®¡ç†**
2. é€‰æ‹©ä¸€ä¸ªåˆ†ç±»
3. ç‚¹å‡»"ç¼–è¾‘"
4. å°è¯•ä¸Šä¼ å°é¢å›¾ç‰‡
5. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
6. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ï¼š`tail -f /root/project_code/logs/error.log`

---

## ğŸ” å¦‚æœä»ç„¶å¤±è´¥

æ£€æŸ¥åº”ç”¨æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f /root/project_code/logs/error.log

# æˆ–æŸ¥çœ‹ systemd æ—¥å¿—
journalctl -u aistudio -f
```

ç„¶åæ ¹æ®é”™è¯¯ä¿¡æ¯è¿›ä¸€æ­¥æ’æŸ¥ã€‚
