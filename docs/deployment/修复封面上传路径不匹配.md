# ä¿®å¤å°é¢ä¸Šä¼ è·¯å¾„ä¸åŒ¹é…é—®é¢˜

## ğŸ” é—®é¢˜å‘ç°

ä»ä½ çš„æˆªå›¾çœ‹åˆ°ï¼š
- **ä¸Šä¼ ç›®å½•**ï¼š`/root/project_code/uploads/`ï¼ˆä½ åˆ›å»ºçš„ï¼‰
- **Nginx é…ç½®**ï¼šå¯èƒ½æŒ‡å‘ `/root/project_data/user_images/uploads/`ï¼ˆä¸åŒ¹é…ï¼‰

è¿™ä¼šå¯¼è‡´æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œä½†æ— æ³•é€šè¿‡ `/media/original/` è®¿é—®ã€‚

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®æ”¹ Nginx é…ç½®åŒ¹é…å®é™…è·¯å¾„ï¼ˆæ¨èï¼‰

```bash
# æ£€æŸ¥å½“å‰ Nginx é…ç½®
grep -A 5 "location /media/original/" /etc/nginx/sites-available/aistudio

# å¦‚æœè·¯å¾„ä¸åŒ¹é…ï¼Œä¿®æ”¹ Nginx é…ç½®
sed -i 's|alias /root/project_data/user_images/uploads/;|alias /root/project_code/uploads/;|' /etc/nginx/sites-available/aistudio

# åŒæ—¶æ£€æŸ¥å…¶ä»–åª’ä½“è·¯å¾„
sed -i 's|alias /root/project_data/user_images/final_works/;|alias /root/project_code/final_works/;|' /etc/nginx/sites-available/aistudio
sed -i 's|alias /root/project_data/user_images/hd_images/;|alias /root/project_code/hd_images/;|' /etc/nginx/sites-available/aistudio

# æµ‹è¯•å¹¶é‡å¯
nginx -t && systemctl restart nginx
```

### æ–¹æ¡ˆ2ï¼šå¦‚æœ Nginx é…ç½®ä¸­ç¼ºå°‘ /media/original/ï¼Œæ·»åŠ å®ƒ

```bash
# ç¼–è¾‘ Nginx é…ç½®
nano /etc/nginx/sites-available/aistudio
```

åœ¨ `location /static/` ä¹‹åæ·»åŠ ï¼š

```nginx
# ä¸Šä¼ æ–‡ä»¶å¤„ç†
location /uploads/ {
    alias /root/project_code/uploads/;
    expires 7d;
    access_log off;
}

# åª’ä½“æ–‡ä»¶å¤„ç†ï¼ˆåŸå›¾ï¼‰
location /media/original/ {
    alias /root/project_code/uploads/;
    expires 7d;
    add_header Cache-Control "public";
    access_log off;
}

# åª’ä½“æ–‡ä»¶å¤„ç†ï¼ˆæ•ˆæœå›¾ï¼‰
location /media/final/ {
    alias /root/project_code/final_works/;
    expires 30d;
    add_header Cache-Control "public, immutable";
    access_log off;
}

# é«˜æ¸…å›¾ç‰‡å¤„ç†
location /media/hd/ {
    alias /root/project_code/hd_images/;
    expires 30d;
    add_header Cache-Control "public, immutable";
    access_log off;
}
```

ç„¶åï¼š

```bash
# æµ‹è¯•å¹¶é‡å¯
nginx -t && systemctl restart nginx
```

---

## ğŸ¯ å®Œæ•´æ£€æŸ¥å’Œä¿®å¤è„šæœ¬

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd /root/project_code

# 1. æ£€æŸ¥å½“å‰ Nginx é…ç½®
echo "=== æ£€æŸ¥ Nginx é…ç½® ==="
grep -A 3 "location /media/original/" /etc/nginx/sites-available/aistudio || echo "âš ï¸  /media/original/ location ä¸å­˜åœ¨"

# 2. æ£€æŸ¥ä¸Šä¼ ç›®å½•
echo ""
echo "=== æ£€æŸ¥ä¸Šä¼ ç›®å½• ==="
ls -ld /root/project_code/uploads 2>/dev/null || echo "âš ï¸  ä¸Šä¼ ç›®å½•ä¸å­˜åœ¨"

# 3. ä¿®å¤è·¯å¾„ä¸åŒ¹é…
echo ""
echo "=== ä¿®å¤è·¯å¾„ä¸åŒ¹é… ==="
NGINX_CONFIG="/etc/nginx/sites-available/aistudio"

# å¦‚æœé…ç½®å­˜åœ¨ä½†è·¯å¾„ä¸å¯¹ï¼Œä¿®å¤å®ƒ
if grep -q "location /media/original/" "$NGINX_CONFIG"; then
    # æ£€æŸ¥è·¯å¾„
    CURRENT_PATH=$(grep -A 3 "location /media/original/" "$NGINX_CONFIG" | grep "alias" | awk '{print $2}' | tr -d ';')
    echo "å½“å‰é…ç½®è·¯å¾„: $CURRENT_PATH"
    
    if [ "$CURRENT_PATH" != "/root/project_code/uploads/" ]; then
        echo "ä¿®å¤è·¯å¾„ä¸åŒ¹é…..."
        sed -i 's|alias /root/project_data/user_images/uploads/;|alias /root/project_code/uploads/;|' "$NGINX_CONFIG"
        sed -i 's|alias /root/project_data/user_images/final_works/;|alias /root/project_code/final_works/;|' "$NGINX_CONFIG"
        sed -i 's|alias /root/project_data/user_images/hd_images/;|alias /root/project_code/hd_images/;|' "$NGINX_CONFIG"
        echo "âœ… è·¯å¾„å·²ä¿®å¤"
    else
        echo "âœ… è·¯å¾„é…ç½®æ­£ç¡®"
    fi
else
    echo "âš ï¸  /media/original/ location ä¸å­˜åœ¨ï¼Œéœ€è¦æ·»åŠ "
    echo "è¯·å‚è€ƒæ–¹æ¡ˆ2æ‰‹åŠ¨æ·»åŠ "
fi

# 4. ç¡®ä¿ç›®å½•å­˜åœ¨å¹¶è®¾ç½®æƒé™
echo ""
echo "=== ç¡®ä¿ç›®å½•å’Œæƒé™ ==="
mkdir -p /root/project_code/uploads
mkdir -p /root/project_code/final_works
mkdir -p /root/project_code/hd_images
chmod -R 755 /root/project_code/uploads
chmod -R 755 /root/project_code/final_works
chmod -R 755 /root/project_code/hd_images
echo "âœ… ç›®å½•å’Œæƒé™å·²è®¾ç½®"

# 5. æµ‹è¯•å¹¶é‡å¯
echo ""
echo "=== æµ‹è¯•å¹¶é‡å¯ Nginx ==="
if nginx -t; then
    systemctl restart nginx
    echo "âœ… Nginx å·²é‡å¯"
else
    echo "âŒ Nginx é…ç½®æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
fi

# 6. éªŒè¯
echo ""
echo "=== éªŒè¯é…ç½® ==="
echo "Nginx é…ç½®ï¼š"
grep -A 3 "location /media/original/" /etc/nginx/sites-available/aistudio
echo ""
echo "ç›®å½•æƒé™ï¼š"
ls -ld /root/project_code/uploads
```

---

## ğŸ“ éªŒè¯ä¿®å¤

ä¿®å¤åï¼Œæµ‹è¯•ï¼š

```bash
# 1. æ£€æŸ¥ Nginx é…ç½®
grep -A 3 "location /media/original/" /etc/nginx/sites-available/aistudio

# åº”è¯¥çœ‹åˆ°ï¼š
# location /media/original/ {
#     alias /root/project_code/uploads/;
#     ...
# }

# 2. æµ‹è¯•è®¿é—®ï¼ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼‰
echo "test" > /root/project_code/uploads/test.txt
curl -I http://localhost/media/original/test.txt

# åº”è¯¥è¿”å› 200 OK

# 3. åœ¨ç®¡ç†åå°æµ‹è¯•ä¸Šä¼ å°é¢å›¾ç‰‡
```

---

## âš ï¸ é‡è¦æç¤º

ç¡®ä¿ä»¥ä¸‹è·¯å¾„ä¸€è‡´ï¼š
- **Flask ä¸Šä¼ è·¯å¾„**ï¼š`/root/project_code/uploads/`
- **Nginx alias è·¯å¾„**ï¼š`/root/project_code/uploads/`
- **è®¿é—® URL**ï¼š`/media/original/æ–‡ä»¶å`

å¦‚æœè·¯å¾„ä¸ä¸€è‡´ï¼Œæ–‡ä»¶ä¸Šä¼ æˆåŠŸä½†æ— æ³•è®¿é—®ã€‚
