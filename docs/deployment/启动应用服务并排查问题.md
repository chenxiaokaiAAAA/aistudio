# 启动应用服务并排查问题

## 当前状态

- ✅ Nginx服务：运行中
- ❌ aistudio服务：未启动（inactive (dead)）
- ❌ 8000端口：未监听

## 立即操作

### 步骤1：启动应用服务

```bash
# 启动服务
systemctl start aistudio

# 查看状态
systemctl status aistudio
```

### 步骤2：如果启动失败，查看日志

```bash
# 查看详细日志
journalctl -u aistudio -n 50 --no-pager

# 或实时查看日志
journalctl -u aistudio -f
```

### 步骤3：检查常见问题

```bash
# 1. 检查Python虚拟环境
cd /root/project_code
source venv/bin/activate
which python
python --version

# 2. 检查Gunicorn是否安装
pip list | grep gunicorn

# 3. 检查启动脚本是否存在
ls -la start_production.py

# 4. 检查环境变量文件
cat .env

# 5. 检查目录权限
ls -la /root/project_code
```

---

## 常见问题排查

### 问题1：Gunicorn未安装

```bash
cd /root/project_code
source venv/bin/activate
pip install gunicorn
systemctl restart aistudio
```

### 问题2：启动脚本路径错误

检查服务文件：
```bash
cat /etc/systemd/system/aistudio.service
```

确保路径正确：
- `WorkingDirectory=/root/project_code`
- `ExecStart=/root/project_code/venv/bin/python /root/project_code/start_production.py`

### 问题3：权限问题

```bash
# 检查文件权限
chmod +x /root/project_code/start_production.py
chmod +x /root/project_code/gunicorn.conf.py
```

### 问题4：数据库文件不存在

```bash
# 创建instance目录
mkdir -p /root/project_code/instance

# 如果数据库文件不存在，应用会自动创建
```

---

## 完整启动流程

```bash
# 1. 进入项目目录
cd /root/project_code

# 2. 激活虚拟环境
source venv/bin/activate

# 3. 检查依赖
pip list | grep -E "flask|gunicorn"

# 4. 检查启动脚本
ls -la start_production.py

# 5. 手动测试启动（看是否有错误）
python start_production.py

# 如果手动启动成功，按Ctrl+C停止，然后使用systemd启动
# 6. 启动systemd服务
systemctl start aistudio

# 7. 查看状态
systemctl status aistudio

# 8. 查看日志
journalctl -u aistudio -f
```

---

## 验证服务运行

```bash
# 1. 检查服务状态
systemctl status aistudio

# 2. 检查端口监听
netstat -tlnp | grep 8000
# 或
ss -tlnp | grep 8000

# 3. 测试访问
curl http://localhost:8000/admin/

# 4. 测试通过Nginx访问
curl http://121.43.143.59/admin/
```

---

## 如果手动启动成功但systemd启动失败

检查服务文件配置：

```bash
# 查看服务文件
cat /etc/systemd/system/aistudio.service

# 重新创建服务文件
cat > /etc/systemd/system/aistudio.service << 'EOF'
[Unit]
Description=AI Studio Gunicorn Application Server
After=network.target

[Service]
Type=notify
User=root
Group=root
WorkingDirectory=/root/project_code
Environment="PATH=/root/project_code/venv/bin"
EnvironmentFile=/root/project_code/.env
ExecStart=/root/project_code/venv/bin/python /root/project_code/start_production.py
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

# 重新加载并启动
systemctl daemon-reload
systemctl start aistudio
systemctl status aistudio
```
