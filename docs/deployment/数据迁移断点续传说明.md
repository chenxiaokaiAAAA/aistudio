# 数据迁移断点续传说明

## 📊 当前迁移状态

根据最新检查（2026-02-03）：
- **迁移进度**: 60.9%
- **已迁移**: 28 个表（347 行数据）
- **待迁移**: 11 个表（383 行数据）
- **空表**: 9 个表

## 🛠️ 可用工具

### 1. 检查迁移进度
```bash
python scripts/database/check_migration_progress.py
```
显示详细的迁移进度，包括：
- 哪些表已迁移
- 哪些表未迁移
- 每个表的行数对比

### 2. 继续迁移（断点续传）
```bash
python migrate_data_auto.py
```
**改进功能**：
- ✅ 自动检测已迁移的表并跳过
- ✅ 只迁移未完成的表
- ✅ 支持部分迁移的表继续迁移
- ✅ 自动处理重复数据（跳过）

### 3. 清空PostgreSQL数据（重新开始）
```bash
python scripts/database/clear_postgresql_data.py
```
⚠️ **警告**: 此操作会删除PostgreSQL中的所有数据，表结构会保留。

## 📋 待迁移的表

根据最新检查，以下表需要迁移：

1. `ai_tasks` - 99 行
2. `coupons` - 10 行
3. `franchisee_accounts` - 1 行
4. `order_image` - 88 行
5. `orders` - 109 行
6. `product_size_pet_options` - 47 行
7. `selfie_machines` - 2 行
8. `shop_orders` - 11 行
9. `staff_users` - 1 行
10. `user` - 8 行
11. `user_coupons` - 7 行

**总计**: 383 行数据待迁移

## 🚀 继续迁移步骤

### 方法1: 直接继续（推荐）
迁移脚本已支持断点续传，直接运行即可：

```bash
cd "E:\AI-STUDIO\aistudio -V14"
$env:DATABASE_URL="postgresql://aistudio_user:a3183683@localhost:5432/pet_painting"
python migrate_data_auto.py
```

脚本会自动：
1. 检查每个表的迁移状态
2. 跳过已完全迁移的表
3. 继续迁移未完成的表
4. 处理重复数据错误（自动跳过）

### 方法2: 先检查再迁移
```bash
# 1. 检查当前状态
python scripts/database/check_migration_progress.py

# 2. 继续迁移
python migrate_data_auto.py
```

## ⚠️ 注意事项

1. **PostgreSQL中缺失的表**: 
   - 有 7 个表在PostgreSQL中不存在（可能是备份表或临时表）
   - 这些表会被自动跳过，不影响迁移

2. **外键依赖**: 
   - 迁移脚本已按依赖顺序处理表
   - 如果遇到外键错误，可能是依赖顺序问题

3. **重复数据**: 
   - 如果遇到重复键错误，脚本会自动跳过该行
   - 这是正常行为，不会中断迁移

4. **中断恢复**: 
   - 如果迁移再次中断，可以随时重新运行脚本
   - 已迁移的表会被自动跳过

## ✅ 迁移完成后

迁移完成后，建议：

1. **验证数据完整性**
   ```bash
   python scripts/database/check_migration_progress.py
   ```
   确认所有表都已迁移完成

2. **备份SQLite数据库**
   ```bash
   # 备份SQLite数据库
   copy instance\pet_painting.db instance\pet_painting.db.backup_迁移前
   ```

3. **测试应用功能**
   - 切换到PostgreSQL环境
   - 测试关键功能
   - 验证数据正确性

## 📝 常见问题

### Q: 迁移中断了怎么办？
A: 直接重新运行 `python migrate_data_auto.py`，脚本会自动跳过已迁移的表。

### Q: 如何知道哪些表已迁移？
A: 运行 `python scripts/database/check_migration_progress.py` 查看详细进度。

### Q: 想重新开始迁移怎么办？
A: 先运行 `python scripts/database/clear_postgresql_data.py` 清空数据，然后重新运行迁移脚本。

### Q: 迁移过程中出现错误怎么办？
A: 
- 查看错误信息
- 如果是重复数据错误，这是正常的，会自动跳过
- 如果是其他错误，检查表结构是否匹配
- 可以继续运行脚本，已迁移的数据不会重复

---

**最后更新**: 2026-02-03  
**状态**: 迁移进行中（60.9%）
