# 阿里云服务器部署完整指南

## 服务器信息
- **公网IP**: 121.43.143.59
- **项目目录**: /root/project_code
- **数据目录**: /root/project_data

## 部署步骤

### 第一步：连接服务器

#### Windows 使用 PowerShell 或 CMD

```powershell
# 使用SSH密钥连接（推荐）
ssh -i aliyun-key/your-key.pem root@121.43.143.59

# 或使用密码连接
ssh root@121.43.143.59
```

#### 如果使用 PuTTY（Windows）

1. 打开 PuTTY
2. Host Name: `121.43.143.59`
3. Port: `22`
4. Connection Type: `SSH`
5. 在 Connection > SSH > Auth 中加载私钥文件
6. 点击 Open 连接

---

### 第二步：在服务器上克隆项目

```bash
# 1. 进入项目目录
cd /root/project_code

# 2. 克隆GitHub仓库
git clone https://github.com/chenxiaokaiAAAA/aistudio.git .

# 或如果仓库是私有的，使用SSH方式
# git clone git@github.com:chenxiaokaiAAAA/aistudio.git .
```

---

### 第三步：创建Python虚拟环境

```bash
# 1. 安装Python3和pip（如果还没有）
apt update
apt install python3 python3-pip python3-venv -y

# 2. 进入项目目录
cd /root/project_code

# 3. 创建虚拟环境
python3 -m venv venv

# 4. 激活虚拟环境
source venv/bin/activate

# 5. 升级pip
pip install --upgrade pip

# 6. 安装依赖
pip install -r requirements.txt
```

---

### 第四步：创建必要的目录

```bash
# 在项目目录下创建
cd /root/project_code
mkdir -p logs uploads final_works hd_images static instance backups

# 或使用数据目录（推荐）
mkdir -p /root/project_data/user_images
mkdir -p /root/project_data/logs
mkdir -p /root/project_data/backups
```

---

### 第五步：从本地传输数据库和图片文件

#### 方法1：使用 SCP 命令（Windows PowerShell）

```powershell
# 1. 传输数据库文件
scp -i aliyun-key/your-key.pem instance/pet_painting.db root@121.43.143.59:/root/project_code/instance/

# 2. 传输图片文件（压缩后传输更快）
# 先在本地压缩
Compress-Archive -Path uploads -DestinationPath uploads.zip
Compress-Archive -Path final_works -DestinationPath final_works.zip
Compress-Archive -Path hd_images -DestinationPath hd_images.zip

# 传输压缩包
scp -i aliyun-key/your-key.pem uploads.zip root@121.43.143.59:/root/project_data/
scp -i aliyun-key/your-key.pem final_works.zip root@121.43.143.59:/root/project_data/
scp -i aliyun-key/your-key.pem hd_images.zip root@121.43.143.59:/root/project_data/

# 3. 在服务器上解压
ssh -i aliyun-key/your-key.pem root@121.43.143.59
cd /root/project_data
unzip uploads.zip -d user_images/
unzip final_works.zip -d user_images/
unzip hd_images.zip -d user_images/
```

#### 方法2：使用 WinSCP（图形界面，推荐）

1. 下载并安装 WinSCP
2. 新建会话：
   - 文件协议：`SFTP`
   - 主机名：`121.43.143.59`
   - 端口：`22`
   - 用户名：`root`
   - 私钥文件：选择 `aliyun-key` 目录中的密钥文件
3. 连接后：
   - 左侧：本地文件
   - 右侧：服务器文件
   - 拖拽上传数据库和图片文件

#### 方法3：使用 rsync（如果已安装）

```bash
# 在本地执行（需要安装Git Bash或WSL）
rsync -avz -e "ssh -i aliyun-key/your-key.pem" \
  instance/pet_painting.db \
  root@121.43.143.59:/root/project_code/instance/

rsync -avz -e "ssh -i aliyun-key/your-key.pem" \
  uploads/ \
  root@121.43.143.59:/root/project_data/user_images/uploads/

rsync -avz -e "ssh -i aliyun-key/your-key.pem" \
  final_works/ \
  root@121.43.143.59:/root/project_data/user_images/final_works/

rsync -avz -e "ssh -i aliyun-key/your-key.pem" \
  hd_images/ \
  root@121.43.143.59:/root/project_data/user_images/hd_images/
```

---

### 第六步：配置环境变量

```bash
# 在服务器上创建 .env 文件
cd /root/project_code
nano .env
```

添加以下内容：

```bash
FLASK_ENV=production
SERVER_ENV=production
SECRET_KEY=your-secret-key-here-change-this
DATABASE_URL=sqlite:///instance/pet_painting.db
UPLOAD_FOLDER=/root/project_data/user_images/uploads
FINAL_FOLDER=/root/project_data/user_images/final_works
HD_FOLDER=/root/project_data/user_images/hd_images
```

保存：`Ctrl+O`，回车，`Ctrl+X`

---

### 第七步：配置图片路径（如果使用数据目录）

如果图片存储在 `/root/project_data`，需要更新配置：

```bash
# 方式1：通过管理后台配置
# 登录管理后台 → 系统配置 → 图片路径配置
# 修改路径为：
# - 上传原图文件夹: /root/project_data/user_images/uploads
# - 完成效果图文件夹: /root/project_data/user_images/final_works
# - 高清图文件夹: /root/project_data/user_images/hd_images

# 方式2：创建符号链接
cd /root/project_code
ln -s /root/project_data/user_images/uploads uploads
ln -s /root/project_data/user_images/final_works final_works
ln -s /root/project_data/user_images/hd_images hd_images
```

---

### 第八步：配置Nginx

```bash
# 1. 安装Nginx
apt install nginx -y

# 2. 复制配置文件
cp /root/project_code/config/nginx_linux.conf /etc/nginx/sites-available/aistudio

# 3. 编辑配置文件
nano /etc/nginx/sites-available/aistudio
```

修改以下内容：
- `server_name`: 您的域名（如果有）
- `ssl_certificate`: SSL证书路径
- `alias` 路径：修改为实际路径
  - `/opt/aistudio/static/` → `/root/project_code/static/`
  - `/opt/aistudio/uploads/` → `/root/project_data/user_images/uploads/`
  - `/opt/aistudio/final_works/` → `/root/project_data/user_images/final_works/`
  - `/opt/aistudio/hd_images/` → `/root/project_data/user_images/hd_images/`

```bash
# 4. 创建符号链接
ln -s /etc/nginx/sites-available/aistudio /etc/nginx/sites-enabled/

# 5. 测试配置
nginx -t

# 6. 重启Nginx
systemctl restart nginx
```

---

### 第九步：创建Systemd服务

```bash
# 创建服务文件
nano /etc/systemd/system/aistudio.service
```

添加以下内容：

```ini
[Unit]
Description=AI Studio Gunicorn Application Server
After=network.target

[Service]
Type=notify
User=root
Group=root
WorkingDirectory=/root/project_code
Environment="PATH=/root/project_code/venv/bin"
EnvironmentFile=/root/project_code/.env
ExecStart=/root/project_code/venv/bin/python /root/project_code/start_production.py
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

```bash
# 重新加载systemd
systemctl daemon-reload

# 启动服务
systemctl start aistudio

# 设置开机自启
systemctl enable aistudio

# 查看状态
systemctl status aistudio

# 查看日志
journalctl -u aistudio -f
```

---

### 第十步：配置防火墙

```bash
# 允许HTTP和HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# 允许SSH（如果还没允许）
ufw allow 22/tcp

# 启用防火墙
ufw enable

# 查看状态
ufw status
```

---

## 快速部署脚本

我为您创建了一个自动化部署脚本，可以简化部署过程。

---

## 验证部署

### 1. 检查服务状态

```bash
# 检查Gunicorn服务
systemctl status aistudio

# 检查Nginx服务
systemctl status nginx

# 检查端口监听
netstat -tlnp | grep 8000
```

### 2. 测试访问

```bash
# 本地测试
curl http://localhost:8000/admin/

# 或通过浏览器访问
# http://121.43.143.59:8000/admin/
```

---

## 常见问题

### Q1: 如何查看日志？

```bash
# 应用日志
tail -f /root/project_code/logs/error.log
tail -f /root/project_code/logs/access.log

# Systemd日志
journalctl -u aistudio -f

# Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### Q2: 如何重启服务？

```bash
# 重启应用
systemctl restart aistudio

# 重启Nginx
systemctl restart nginx
```

### Q3: 如何更新代码？

```bash
cd /root/project_code
git pull origin master
systemctl restart aistudio
```

---

## 下一步

部署完成后，请：
1. 配置SSL证书（如果使用HTTPS）
2. 在管理后台配置图片路径
3. 测试所有功能
4. 设置定期备份
