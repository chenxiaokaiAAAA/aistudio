# 推广码功能部署说明

## 📋 功能概述

已为您的系统添加了完整的推广码功能，包括：
- ✅ 用户注册和推广码生成
- ✅ 推广码验证
- ✅ 分佣计算和记录
- ✅ 推广访问追踪
- ✅ 小程序订单支持推广码
- ✅ 分佣数据查询和统计

## 🔧 已完成的修改

### 1. 数据库模型更新
- 在 `Order` 表中添加了 `promotion_code` 和 `referrer_user_id` 字段
- 新增了 `PromotionUser`、`Commission`、`PromotionTrack` 三个表

### 2. API接口添加
- `/api/user/register` - 用户注册
- `/api/user/commission` - 获取分佣数据
- `/api/promotion/track` - 推广访问追踪
- `/api/test/commission` - 测试分佣功能
- `/api/promotion/validate` - 验证推广码
- `/api/promotion/stats` - 获取推广统计

### 3. 订单提交接口更新
- 支持 `promotionCode` 和 `referrerUserId` 参数
- 自动计算和记录分佣（10%佣金率）
- 验证推广码有效性

## 🚀 部署步骤

### 1. 重启应用
```bash
# 停止当前应用
pkill -f python

# 启动应用（会自动创建新的数据库表）
python start.py
```

### 2. 验证部署
```bash
# 运行测试脚本
python test_promotion_api.py
```

### 3. 检查数据库
新的数据库表会自动创建：
- `promotion_users` - 推广用户表
- `commissions` - 分佣记录表  
- `promotion_tracks` - 推广访问追踪表

## 📱 小程序集成

### 订单提交时添加推广码参数：
```javascript
// 小程序订单数据
const orderData = {
    // ... 原有订单字段
    promotionCode: "PETCT5R",        // 推广码
    referrerUserId: "USER123456"      // 推广者用户ID
};
```

### 用户注册：
```javascript
// 用户注册
const registerData = {
    userId: "USER123456",
    openId: "wx_openid",
    userInfo: {
        nickName: "用户昵称",
        avatarUrl: "头像URL"
    }
};
```

## 🧪 测试接口

### 1. 用户注册测试
```bash
curl -X POST https://photogooo/api/user/register \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "USER1758272437351",
    "openId": "test_openid",
    "userInfo": {
      "nickName": "测试用户",
      "avatarUrl": "https://example.com/avatar.jpg"
    }
  }'
```

### 2. 分佣测试
```bash
curl -X POST https://photogooo/api/test/commission \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "USER1758272437351",
    "testAmount": 100
  }'
```

### 3. 获取分佣数据
```bash
curl "https://photogooo/api/user/commission?userId=USER1758272437351"
```

## 📊 功能特性

### 推广码生成
- 基于用户ID生成8位唯一推广码
- 支持自定义推广码
- 自动验证推广码唯一性

### 分佣计算
- 默认10%佣金率
- 订单完成时自动结算
- 支持分佣状态跟踪（pending/completed/cancelled）

### 推广统计
- 总访问数统计
- 总订单数统计
- 总收益统计
- 分佣记录查询

## ⚠️ 注意事项

1. **数据库备份**：部署前请备份现有数据库
2. **测试环境**：建议先在测试环境验证功能
3. **监控日志**：部署后监控应用日志确保无错误
4. **API限流**：考虑为推广相关API添加限流保护

## 🔍 故障排除

### 常见问题：

1. **数据库表创建失败**
   - 检查数据库连接
   - 确认SQLAlchemy版本兼容性
   - 查看应用启动日志

2. **API接口404**
   - 确认应用已重启
   - 检查路由注册
   - 验证URL路径

3. **分佣计算错误**
   - 检查订单价格格式
   - 验证推广码有效性
   - 查看分佣记录表

## 📞 技术支持

如遇到问题，请提供：
- 错误日志
- 测试用例
- 数据库状态
- 网络环境信息

---

**部署完成后，您的推广码功能就可以正常使用了！** 🎉
