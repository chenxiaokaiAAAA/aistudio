# 尺寸配置表使用说明

## 📋 概述

`size_config.py` 是一个独立的尺寸配置表，用于统一管理：
- ✅ 产品尺寸检查标准
- ✅ 发送给厂家的尺寸格式
- ✅ 验证规则（DPI、误差范围等）

## 🚀 快速开始

### 1. 添加新产品尺寸配置

如果厂家要求 **15.20cm x 20.30cm** 的尺寸，按以下步骤添加：

#### 步骤1：在 `size_config.py` 的 `SIZE_MAPPING` 中添加配置

```python
# 根据订单中的尺寸标识（可能是产品ID或尺寸名称）
'YOUR_PRODUCT_KEY': {
    'product_id': 'YOUR_PRODUCT_ID',  # 厂家产品ID
    'product_name': '产品名称',
    'width_cm': 15.20,  # 标准宽度
    'height_cm': 20.30,  # 标准高度
    'manufacturer_width_cm': 15.20,  # 厂家要求的精确宽度（重要！）
    'manufacturer_height_cm': 20.30,  # 厂家要求的精确高度（重要！）
    'dpi': 300,  # DPI要求
    'tolerance_percent': 3,  # 误差范围（3%表示允许97%-103%的误差）
},
```

#### 步骤2：确认订单中的尺寸标识

确认订单表中的 `size` 字段的值是什么，例如：
- 如果是产品ID：`'33676'`
- 如果是尺寸名称：`'12寸-（30x30cm）肌理油画框'`
- 如果是自定义值：需要在配置中使用相同的key

### 2. 示例配置

#### 示例1：标准配置

```python
'15.20x20.30': {
    'product_id': 'PROD_001',
    'product_name': '15.20cm x 20.30cm 定制画框',
    'width_cm': 15.20,
    'height_cm': 20.30,
    'manufacturer_width_cm': 15.20,  # 厂家要求的精确尺寸
    'manufacturer_height_cm': 20.30,
    'dpi': 300,
    'tolerance_percent': 3,  # 3%误差
},
```

#### 示例2：厂家要求与标准尺寸不同

```python
'CUSTOM_SIZE': {
    'product_id': 'PROD_002',
    'product_name': '特殊尺寸产品',
    'width_cm': 15.0,  # 系统标准尺寸
    'height_cm': 20.0,  # 系统标准尺寸
    'manufacturer_width_cm': 15.20,  # 厂家要求的精确尺寸（不同！）
    'manufacturer_height_cm': 20.30,  # 厂家要求的精确尺寸（不同！）
    'dpi': 300,
    'tolerance_percent': 2,  # 更严格的误差要求
},
```

## 📝 配置项说明

### VALIDATION_CONFIG（验证规则配置）

```python
VALIDATION_CONFIG = {
    'enabled': True,  # 是否启用尺寸验证
    'default_dpi': 300,  # 默认DPI
    'tolerance_percent': 5,  # 默认误差百分比
    'strict_mode': False,  # 严格模式：True=完全匹配，False=允许误差
}
```

### SEND_FORMAT_CONFIG（发送格式配置）

```python
SEND_FORMAT_CONFIG = {
    'width_decimals': 2,  # 宽度小数点位数（发送给厂家）
    'height_decimals': 2,  # 高度小数点位数（发送给厂家）
    'size_format': 'cm',  # 尺寸单位：'cm' 或 'mm'
    'include_pixel_size': True,  # 是否包含像素尺寸
    'include_dpi': True,  # 是否包含DPI信息
}
```

### SIZE_MAPPING（产品尺寸映射）

每个产品配置包含：

| 字段 | 类型 | 说明 | 必填 |
|------|------|------|------|
| product_id | string | 厂家产品ID | ✅ |
| product_name | string | 产品名称 | ✅ |
| width_cm | float | 标准宽度（厘米） | ✅ |
| height_cm | float | 标准高度（厘米） | ✅ |
| manufacturer_width_cm | float | 厂家要求的宽度（优先使用） | ✅ |
| manufacturer_height_cm | float | 厂家要求的高度（优先使用） | ✅ |
| dpi | int | DPI要求 | ❌（默认300） |
| tolerance_percent | float | 误差百分比 | ❌（默认5%） |

## 🔍 常见问题

### Q1: 如何找到订单中的尺寸标识？

**方法1：查看数据库**
```sql
SELECT DISTINCT size FROM "order" ORDER BY size;
```

**方法2：查看订单详情**
访问管理后台，查看订单详情页面的尺寸字段

**方法3：查看日志**
发送订单时，日志会显示：`订单尺寸字段: 'xxx'`

### Q2: 厂家要求的尺寸与标准尺寸不同怎么办？

使用 `manufacturer_width_cm` 和 `manufacturer_height_cm` 字段：

```python
'SIZE_KEY': {
    'width_cm': 15.0,  # 系统标准
    'height_cm': 20.0,  # 系统标准
    'manufacturer_width_cm': 15.20,  # 厂家要求（优先使用）
    'manufacturer_height_cm': 20.30,  # 厂家要求（优先使用）
    ...
}
```

发送给厂家时会使用 `manufacturer_width_cm` 和 `manufacturer_height_cm`。

### Q3: 如何调整误差范围？

**全局调整：**
```python
VALIDATION_CONFIG = {
    'tolerance_percent': 3,  # 改为3%
}
```

**单个产品调整：**
```python
'PRODUCT_KEY': {
    ...
    'tolerance_percent': 2,  # 该产品使用2%误差
}
```

### Q4: 如何禁用某个产品的尺寸验证？

```python
VALIDATION_CONFIG = {
    'enabled': False,  # 禁用所有验证
}
```

或者为该产品设置很大的误差范围：
```python
'PRODUCT_KEY': {
    ...
    'tolerance_percent': 100,  # 100%误差 = 不验证
}
```

### Q5: 如何添加尺寸别名？

如果订单中可能使用多种标识指向同一产品：

```python
SIZE_ALIAS_MAPPING = {
    '12寸': '33673',
    '30x30cm': '33673',
    '30x30': '33673',
}
```

## 🛠️ 调试技巧

### 1. 查看发送给厂家的尺寸

在发送订单时，日志会显示：
```
找到尺寸配置: 15.20cm x 20.30cm
使用厂家要求的尺寸: 15.20cm x 20.30cm
```

### 2. 查看验证结果

验证失败时，错误信息会包含：
- 要求的尺寸（cm 和 px）
- 实际图片尺寸
- 误差范围

### 3. 测试配置

创建一个测试脚本：

```python
from size_config import SIZE_MAPPING, VALIDATION_CONFIG

# 测试查找配置
def test_size_config(size_key):
    if size_key in SIZE_MAPPING:
        config = SIZE_MAPPING[size_key]
        print(f"找到配置:")
        print(f"  产品ID: {config['product_id']}")
        print(f"  厂家要求: {config['manufacturer_width_cm']}cm x {config['manufacturer_height_cm']}cm")
    else:
        print(f"未找到配置: {size_key}")

# 测试
test_size_config('YOUR_SIZE_KEY')
```

## 📌 针对您的问题

根据错误信息：
```
尺寸要求为：15.20cm x 20.30cm
```

请按以下步骤添加配置：

1. **确认订单中的尺寸标识**
   - 查看订单 `size` 字段的值

2. **添加配置**
   ```python
   'YOUR_SIZE_KEY': {  # 替换为实际的尺寸标识
       'product_id': 'YOUR_PRODUCT_ID',  # 替换为实际的产品ID
       'product_name': '15.20cm x 20.30cm 产品',
       'width_cm': 15.20,
       'height_cm': 20.30,
       'manufacturer_width_cm': 15.20,  # 厂家要求的精确尺寸
       'manufacturer_height_cm': 20.30,  # 厂家要求的精确尺寸
       'dpi': 300,
       'tolerance_percent': 3,  # 建议3%误差
   },
   ```

3. **重启服务器**
   - 配置修改后需要重启服务器才能生效

4. **测试发送**
   - 重新发送订单，查看是否使用正确的尺寸

## 📞 支持

如果遇到问题：
1. 检查配置语法是否正确
2. 确认订单中的尺寸标识与配置key匹配
3. 查看服务器日志了解详细信息
4. 使用测试脚本验证配置






