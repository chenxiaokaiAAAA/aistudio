# 重置管理员密码

## 🔍 问题

- ✅ 登录页面可以访问
- ❌ 密码错误，无法登录

**可能原因**：
1. 数据库中的管理员账号密码不正确
2. 数据库文件没有正确恢复
3. 需要创建新的管理员账号

---

## 🔧 解决方案

### 方法1：检查并重置管理员密码（推荐）

在服务器上执行：

```bash
cd /root/project_code
source venv/bin/activate

# 重置管理员密码
python << 'EOF'
from test_server import app, db, User
from werkzeug.security import generate_password_hash

with app.app_context():
    # 查找管理员账号
    admin = User.query.filter_by(username='admin').first()
    
    if admin:
        # 重置密码为 admin123
        admin.password = generate_password_hash('admin123')
        db.session.commit()
        print("✅ 管理员密码已重置为: admin123")
    else:
        # 创建管理员账号
        admin = User(
            username='admin',
            password=generate_password_hash('admin123'),
            role='admin'
        )
        db.session.add(admin)
        db.session.commit()
        print("✅ 管理员账号已创建: admin/admin123")
    
    # 验证
    admin = User.query.filter_by(username='admin').first()
    if admin:
        print(f"✅ 管理员账号存在: {admin.username}, 角色: {admin.role}")
    else:
        print("❌ 管理员账号不存在")
EOF
```

### 方法2：使用 SQLite 直接修改

```bash
cd /root/project_code
source venv/bin/activate

# 使用 Python 直接修改数据库
python << 'EOF'
import sqlite3
from werkzeug.security import generate_password_hash

# 连接数据库
conn = sqlite3.connect('/root/project_code/instance/pet_painting.db')
cursor = conn.cursor()

# 生成新密码哈希
new_password = generate_password_hash('admin123')

# 更新或插入管理员账号
cursor.execute("SELECT id FROM user WHERE username = 'admin'")
admin = cursor.fetchone()

if admin:
    # 更新密码
    cursor.execute("UPDATE user SET password = ? WHERE username = 'admin'", (new_password,))
    print("✅ 管理员密码已更新为: admin123")
else:
    # 创建管理员账号
    cursor.execute("""
        INSERT INTO user (username, password, role, created_at)
        VALUES (?, ?, ?, datetime('now'))
    """, ('admin', new_password, 'admin'))
    print("✅ 管理员账号已创建: admin/admin123")

conn.commit()
conn.close()
print("✅ 数据库已更新")
EOF
```

### 方法3：检查数据库中的用户

```bash
cd /root/project_code
source venv/bin/activate

# 查看所有用户
python << 'EOF'
from test_server import app, db, User

with app.app_context():
    users = User.query.all()
    print(f"数据库中共有 {len(users)} 个用户:")
    for user in users:
        print(f"  - 用户名: {user.username}, 角色: {user.role}")
    
    # 检查管理员
    admin = User.query.filter_by(username='admin').first()
    if admin:
        print(f"\n✅ 管理员账号存在: {admin.username}")
        print(f"   角色: {admin.role}")
    else:
        print("\n❌ 管理员账号不存在")
EOF
```

---

## 📋 完整重置脚本（一键执行）

```bash
#!/bin/bash
echo "=========================================="
echo "重置管理员密码"
echo "=========================================="
echo ""

cd /root/project_code
source venv/bin/activate

python << 'PYEOF'
from test_server import app, db, User
from werkzeug.security import generate_password_hash

with app.app_context():
    # 查找或创建管理员账号
    admin = User.query.filter_by(username='admin').first()
    
    if admin:
        # 重置密码
        admin.password = generate_password_hash('admin123')
        db.session.commit()
        print("✅ 管理员密码已重置为: admin123")
    else:
        # 创建管理员账号
        admin = User(
            username='admin',
            password=generate_password_hash('admin123'),
            role='admin'
        )
        db.session.add(admin)
        db.session.commit()
        print("✅ 管理员账号已创建: admin/admin123")
    
    # 验证
    admin = User.query.filter_by(username='admin').first()
    if admin:
        print(f"✅ 验证成功: 用户名={admin.username}, 角色={admin.role}")
    else:
        print("❌ 验证失败")
PYEOF

echo ""
echo "=========================================="
echo "重置完成！"
echo "=========================================="
echo ""
echo "现在可以使用以下账号登录："
echo "  用户名: admin"
echo "  密码: admin123"
echo ""
echo "请刷新登录页面后重试。"
```

---

## 🎯 立即执行

在服务器上执行上面的**完整重置脚本**，它会：
1. 查找管理员账号
2. 如果存在，重置密码为 `admin123`
3. 如果不存在，创建新账号
4. 验证账号

执行后，刷新登录页面，使用 `admin` / `admin123` 登录。

---

## 🔍 如果仍然失败

如果重置后仍然无法登录，检查：

```bash
# 查看数据库文件
ls -lh /root/project_code/instance/pet_painting.db

# 检查数据库连接
cd /root/project_code
source venv/bin/activate
python -c "from test_server import app, db; app.app_context().push(); print('数据库连接正常')"
```

---

## ✅ 执行后

执行重置脚本后，告诉我结果。如果成功，应该可以登录了！
