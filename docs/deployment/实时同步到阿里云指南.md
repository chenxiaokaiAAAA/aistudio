# 实时同步到阿里云服务器指南

## 📋 概述

本工具可以帮你将本地修改的**代码、数据库、图片**实时同步到阿里云服务器。

## 🚀 快速使用

### 方法1：使用批处理脚本（推荐）

直接运行根目录的批处理脚本：

```cmd
快速同步到阿里云.bat
```

然后选择要同步的内容：
- `1` - 只同步代码（通过Git）
- `2` - 只同步数据库
- `3` - 只同步图片
- `4` - 同步所有（代码+数据库+图片）

### 方法2：使用PowerShell脚本

```powershell
# 同步所有
.\scripts\deployment\同步到阿里云服务器.ps1 -All

# 只同步代码
.\scripts\deployment\同步到阿里云服务器.ps1 -CodeOnly

# 只同步数据库
.\scripts\deployment\同步到阿里云服务器.ps1 -DatabaseOnly

# 只同步图片
.\scripts\deployment\同步到阿里云服务器.ps1 -ImagesOnly
```

## 📦 同步内容说明

### 1. 代码同步（通过Git）

**流程：**
1. 检查本地是否有未提交的更改
2. 如果有，询问是否提交并推送到GitHub
3. 在服务器上执行 `git pull` 拉取最新代码

**优点：**
- ✅ 有版本控制
- ✅ 可以回滚
- ✅ 自动处理代码冲突

**适用场景：**
- 代码文件修改
- 配置文件更新
- 文档更新

### 2. 数据库同步

**同步文件：**
- `instance/pet_painting.db` → `/root/project_code/instance/pet_painting.db`

**流程：**
1. 检查本地数据库文件是否存在
2. 使用 `scp` 上传到服务器
3. 设置正确的文件权限

**适用场景：**
- 本地测试后需要更新服务器数据库
- 数据库结构变更
- 数据迁移

**⚠️ 注意：**
- 会覆盖服务器上的数据库
- 建议先备份服务器数据库

### 3. 图片同步

**同步目录：**
- `uploads/` - 用户上传的图片
- `final_works/` - AI生成的效果图
- `hd_images/` - 高清图片

**流程：**
1. 检查每个图片目录
2. 使用 `rsync` 或 `scp -r` 同步
3. 保持目录结构

**适用场景：**
- 本地测试上传的图片
- 批量导入图片
- 图片资源更新

## ⚙️ 配置说明

### 服务器配置

脚本默认配置：
- **服务器IP**: `121.43.143.59`
- **用户名**: `root`
- **远程路径**: `/root/project_code`
- **密钥路径**: `aliyun-key\your-key.pem`

### 修改配置

编辑 `scripts/deployment/同步到阿里云服务器.ps1`：

```powershell
param(
    [string]$ServerIP = "你的服务器IP",
    [string]$ServerUser = "root",
    [string]$KeyPath = "aliyun-key\your-key.pem",
    [string]$RemotePath = "/root/project_code"
)
```

## 🔧 前置要求

### Windows 系统

1. **OpenSSH 客户端**（Windows 10/11 自带）
   - 设置 → 应用 → 可选功能 → OpenSSH 客户端

2. **PowerShell 5.1+**（Windows 10/11 自带）

3. **rsync**（可选，用于高效同步图片）
   - 下载：https://github.com/librsync/librsync
   - 或使用 Git Bash 自带的 rsync

### 服务器端

1. **Git** 已安装
2. **SSH** 服务正常运行
3. **项目目录** 已存在：`/root/project_code`

## 📝 使用示例

### 示例1：只同步代码

```powershell
.\scripts\deployment\同步到阿里云服务器.ps1 -CodeOnly
```

**场景：** 修改了代码，需要快速部署

### 示例2：只同步数据库

```powershell
.\scripts\deployment\同步到阿里云服务器.ps1 -DatabaseOnly
```

**场景：** 本地测试后，需要更新服务器数据库

### 示例3：完整同步

```powershell
.\scripts\deployment\同步到阿里云服务器.ps1 -All
```

**场景：** 全面更新，包括代码、数据库、图片

## ⚠️ 注意事项

### 数据库同步

1. **会覆盖服务器数据库**，建议先备份：
   ```bash
   # 在服务器上执行
   cp /root/project_code/instance/pet_painting.db /root/project_code/instance/pet_painting.db.backup
   ```

2. **确保数据库文件完整**，不要中断上传

### 图片同步

1. **首次同步可能较慢**（文件较多）
2. **增量同步**：后续只同步修改的文件
3. **磁盘空间**：确保服务器有足够空间

### 代码同步

1. **Git冲突**：如果服务器有未提交的更改，可能需要手动解决
2. **服务重启**：代码更新后建议重启服务

## 🔄 工作流程建议

### 日常开发流程

1. **本地开发** → 修改代码
2. **本地测试** → 确保功能正常
3. **提交到GitHub** → 使用 `完整同步到GitHub并部署.bat`
4. **同步到服务器** → 使用 `快速同步到阿里云.bat` 选择"1. 只同步代码"
5. **重启服务** → 脚本会询问是否重启

### 数据库更新流程

1. **本地修改数据库** → 测试数据
2. **备份服务器数据库** → 在服务器上执行备份命令
3. **同步数据库** → 使用 `快速同步到阿里云.bat` 选择"2. 只同步数据库"
4. **验证数据** → 检查服务器上的数据

### 图片更新流程

1. **本地添加图片** → 上传到本地目录
2. **同步图片** → 使用 `快速同步到阿里云.bat` 选择"3. 只同步图片"
3. **验证图片** → 检查服务器上的图片

## 🐛 故障排查

### SSH连接失败

```powershell
# 测试SSH连接
ssh -i aliyun-key\your-key.pem root@121.43.143.59
```

### 权限问题

```bash
# 在服务器上检查权限
ls -la /root/project_code/instance/pet_painting.db
chmod 644 /root/project_code/instance/pet_painting.db
```

### Git拉取失败

```bash
# 在服务器上检查Git状态
cd /root/project_code
git status
git pull origin master
```

## 📌 总结

- **代码同步**：使用Git，有版本控制
- **数据库同步**：直接上传文件，会覆盖
- **图片同步**：增量同步，保持目录结构
- **灵活选择**：可以单独同步某一类文件

这样你就可以灵活地选择同步内容，既保证了代码的版本控制，又能实时同步数据库和图片！
