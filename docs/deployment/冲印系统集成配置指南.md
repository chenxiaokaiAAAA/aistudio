# 冲印系统集成配置指南

## 概述

本指南将帮助您配置萌宠绘系统与冲印系统的自动传片功能。当用户确认制作后，订单状态会变为"待发货"，系统将自动将成品图片发送到冲印系统进行制作。

## 系统架构

```
用户确认制作 → 订单状态变为"待发货" → 自动发送到冲印系统 → 冲印系统处理订单
```

## 配置步骤

### 1. 获取冲印系统信息

联系您的冲印系统提供商，获取以下信息：
- **API地址**: 冲印系统接收订单的接口地址
- **影楼编号**: 冲印系统分配给您的唯一标识
- **影楼名称**: 您的店铺名称
- **系统代号**: 您的系统在冲印系统中的标识（通常是"YT"）

### 2. 配置系统参数

#### 方法一：通过管理界面配置（推荐）

1. 登录管理后台
2. 访问"冲印系统配置"页面
3. 填写以下信息：
   - API地址：`http://服务器IP:5995/api/ODSGate/NewOrder`
   - 来源系统代号：`YT`
   - 影楼编号：从冲印系统提供商获取
   - 影楼名称：您的店铺名称
4. 启用"自动传片功能"
5. 点击"保存配置"

#### 方法二：手动配置文件

编辑 `printer_config.py` 文件：

```python
PRINTER_SYSTEM_CONFIG = {
    'api_url': 'http://您的服务器IP:5995/api/ODSGate/NewOrder',
    'source_app_id': 'YT',
    'shop_id': '您的影楼编号',
    'shop_name': '您的影楼名称',
    'enabled': True,
    'timeout': 30,
    'retry_times': 3,
}
```

### 3. 文件访问配置

确保成品图片可以通过HTTP访问：

#### 外网对接方式（推荐）
- 确保您的服务器可以通过外网访问
- 修改 `printer_client.py` 中的 `_get_file_url` 方法：
```python
def _get_file_url(self, image_path):
    filename = os.path.basename(image_path)
    base_url = "http://your-domain.com"  # 替换为您的域名
    return f"{base_url}/static/final/{filename}"
```

#### 内网对接方式
- 如果冲印系统与您的服务器在同一内网
- 修改 `_get_file_url` 方法返回本地路径：
```python
def _get_file_url(self, image_path):
    return image_path  # 直接返回本地路径
```

### 4. 测试配置

1. 在管理界面点击"测试连接"按钮
2. 检查服务器日志确认连接成功
3. 创建一个测试订单，上传成品图片，将状态改为"待发货"
4. 观察日志确认订单已发送到冲印系统

## 工作流程详解

### 订单状态流转

1. **待制作** (`pending`): 订单刚创建，等待制作
2. **已完成** (`completed`): 制作完成，等待用户确认
3. **待发货** (`shipped`): 用户确认制作，**自动发送到冲印系统**
4. **已发货** (`processing`): 冲印系统已发货

### 自动传片触发条件

当订单状态更新为 `shipped` 时，系统会：
1. 检查是否有成品图片 (`final_image` 字段)
2. 验证图片文件是否存在
3. 构建订单数据（包含收件人信息、图片信息等）
4. 发送到冲印系统API
5. 记录发送结果

### 订单数据结构

发送到冲印系统的数据包含：

```json
{
  "source_app_id": "YT",
  "order_id": "YT_123",
  "order_no": "MP20240101123456",
  "order_time": "2024-01-01 12:34:56",
  "push_time": "2024-01-01 12:35:00",
  "remark": "萌宠绘定制订单 MP20240101123456",
  "shop_id": "您的影楼编号",
  "shop_name": "您的影楼名称",
  "shipping_receiver": {
    "name": "客户姓名",
    "mobile": "客户手机号",
    "province": "广东省",
    "city": "深圳市",
    "city_part": "南山区",
    "street": "详细地址",
    "corp_name": ""
  },
  "sub_orders": [{
    "sub_order_id": "MP20240101123456_1",
    "customer_name": "客户姓名",
    "product_id": "CUSTOM_PRODUCT",
    "product_name": "定制油画 A4",
    "shop_product_sn": "MP20240101123456",
    "remark": "订单备注",
    "num": 1,
    "photos": [{
      "page_type": 0,
      "index": 1,
      "num": 1,
      "file_name": "final_xxx.jpg",
      "pix_width": 2480,
      "pix_height": 3508,
      "dpi": 300,
      "width": 21.0,
      "height": 29.7,
      "file_url": "http://your-domain.com/static/final/final_xxx.jpg"
    }]
  }]
}
```

## 故障排除

### 常见问题

1. **订单未发送到冲印系统**
   - 检查 `printer_config.py` 是否存在
   - 确认 `enabled` 设置为 `True`
   - 检查订单是否有 `final_image`
   - 查看服务器日志

2. **连接失败**
   - 检查API地址是否正确
   - 确认网络连接
   - 验证冲印系统服务是否正常

3. **图片无法访问**
   - 检查文件路径是否正确
   - 确认Web服务器配置
   - 验证文件权限

### 日志监控

系统会在以下情况记录日志：
- 订单发送成功
- 订单发送失败
- 配置错误
- 网络异常

查看日志位置：
- 控制台输出
- 应用日志文件

## 安全注意事项

1. **API安全**: 确保冲印系统API有适当的访问控制
2. **文件安全**: 成品图片应设置适当的访问权限
3. **数据保护**: 客户信息传输应使用HTTPS
4. **备份**: 定期备份配置文件

## 维护建议

1. **定期测试**: 建议每周测试一次连接
2. **监控日志**: 关注发送失败的订单
3. **更新配置**: 冲印系统变更时及时更新配置
4. **性能优化**: 大量订单时考虑异步处理

## 联系支持

如果在配置过程中遇到问题，请：
1. 查看本文档的故障排除部分
2. 检查服务器日志
3. 联系技术支持团队

---

**注意**: 本集成方案基于冲印系统传片接口协议V2.2版本，如有协议更新请及时调整配置。

