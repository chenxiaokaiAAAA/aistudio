# 微信支付配置说明

## 已完成的配置

### 1. 导入模块 ✅
在 `start.py` 和 `test_server.py` 中添加了必要的导入：
- `hashlib` - 用于生成MD5签名
- `time` - 用于时间戳
- `random` - 用于生成随机字符串
- `string` - 用于字符串操作
- `requests` - 用于HTTP请求
- `xml.etree.ElementTree` - 用于XML处理

### 2. 微信支付配置 ✅
在 `test_server.py` 中添加了 `WECHAT_PAY_CONFIG` 配置字典：
```python
WECHAT_PAY_CONFIG = {
    'appid': 'your_miniprogram_appid',  # 替换为你的小程序AppID
    'mch_id': 'your_merchant_id',       # 替换为你的商户号
    'api_key': 'your_api_key',          # 替换为你的API密钥
    'notify_url': 'https://moeart.cc/api/payment/notify',
    'app_secret': 'your_app_secret'     # 替换为你的小程序AppSecret
}
```

### 3. 辅助函数 ✅
- `generate_sign()` - 生成微信支付签名
- `verify_sign()` - 验证微信支付签名
- `dict_to_xml()` - 字典转XML格式
- `xml_to_dict()` - XML转字典格式
- `generate_nonce_str()` - 生成随机字符串

### 4. API接口 ✅
- **创建支付订单接口** `/api/payment/create` (POST)
- **支付结果通知接口** `/api/payment/notify` (POST)
- **获取用户openid接口** `/api/user/openid` (POST)

### 5. 依赖更新 ✅
在 `requirements.txt` 中添加了 `requests==2.31.0`

## 需要配置的参数

### 在 `test_server.py` 中替换以下参数：

1. **your_miniprogram_appid** → 你的小程序AppID
2. **your_merchant_id** → 你的商户号
3. **your_api_key** → 你的API密钥
4. **your_app_secret** → 你的小程序AppSecret

## 部署步骤

1. **安装依赖**：
   ```bash
   pip install requests
   ```

2. **配置参数**：
   在 `test_server.py` 中替换 `WECHAT_PAY_CONFIG` 中的占位符

3. **重启Flask应用**：
   ```bash
   python start.py
   ```

4. **配置微信商户平台**：
   - 登录微信商户平台
   - 设置支付通知URL: `https://moeart.cc/api/payment/notify`

## 测试接口

### 测试获取openid
```bash
curl -X POST https://moeart.cc/api/user/openid \
  -H "Content-Type: application/json" \
  -d '{"code":"test_code"}'
```

### 测试创建支付订单
```bash
curl -X POST https://moeart.cc/api/payment/create \
  -H "Content-Type: application/json" \
  -d '{"orderId":"TEST123","totalPrice":"15.00","openid":"test_openid"}'
```

## API接口说明

### 1. 创建支付订单 `/api/payment/create`
**请求参数**：
- `orderId`: 订单号
- `totalPrice`: 总价格（元）
- `openid`: 用户openid

**响应**：
```json
{
  "success": true,
  "data": {
    "appId": "小程序AppID",
    "timeStamp": "时间戳",
    "nonceStr": "随机字符串",
    "package": "prepay_id=xxx",
    "signType": "MD5",
    "paySign": "支付签名"
  }
}
```

### 2. 支付结果通知 `/api/payment/notify`
微信支付系统会调用此接口通知支付结果，自动更新订单状态。

### 3. 获取用户openid `/api/user/openid`
**请求参数**：
- `code`: 微信小程序登录code

**响应**：
```json
{
  "success": true,
  "data": {
    "openid": "用户openid",
    "session_key": "会话密钥"
  }
}
```

## 注意事项

1. **安全性**：确保API密钥等敏感信息不要泄露
2. **HTTPS**：生产环境必须使用HTTPS
3. **签名验证**：所有支付相关接口都包含签名验证
4. **错误处理**：所有接口都包含完整的错误处理机制
5. **日志记录**：支付成功后会记录日志便于排查问题

## 小程序前端调用示例

```javascript
// 1. 获取用户openid
wx.login({
  success: function(res) {
    if (res.code) {
      // 调用后端接口获取openid
      wx.request({
        url: 'https://moeart.cc/api/user/openid',
        method: 'POST',
        data: { code: res.code },
        success: function(result) {
          const openid = result.data.data.openid;
          // 使用openid创建支付订单
        }
      });
    }
  }
});

// 2. 创建支付订单
wx.request({
  url: 'https://moeart.cc/api/payment/create',
  method: 'POST',
  data: {
    orderId: 'ORDER123',
    totalPrice: '15.00',
    openid: openid
  },
  success: function(result) {
    if (result.data.success) {
      // 调用微信支付
      wx.requestPayment({
        ...result.data.data,
        success: function() {
          console.log('支付成功');
        },
        fail: function() {
          console.log('支付失败');
        }
      });
    }
  }
});
```













