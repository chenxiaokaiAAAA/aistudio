# 阿里云 ECS 杭州 → 香港 迁移指南

> 香港服务器**无需 ICP 备案**，手机、小程序可直接访问  
> 更新日期：2026-02-06

---

## 一、为什么迁到香港

| 地域 | ICP 备案 | 手机/小程序访问 |
|------|----------|-----------------|
| 杭州（华东1） | 必须备案 | 未备案会被运营商拦截 |
| 香港 | 无需备案 | 可直接访问 |

---

## 二、迁移方式概览

阿里云 **不支持** 直接把现有 ECS 改地域，需要**新购香港 ECS** 后迁移数据。

| 方式 | 适用场景 | 难度 |
|------|----------|------|
| 自定义镜像跨地域复制 | 系统、软件、配置一起迁 | 中等 |
| 手动迁移 | 全新安装 + 数据迁移 | 较繁琐 |

---

## 三、方式一：镜像迁移（推荐）

### 3.1 在杭州 ECS 上创建系统盘快照

1. 阿里云控制台 → **云服务器 ECS** → **实例**
2. 找到杭州实例 → 更多 → **磁盘和镜像** → **创建快照**
3. 选择**系统盘**，创建快照，等待完成

### 3.2 用快照创建自定义镜像

1. **存储与快照** → **快照** → 找到刚创建的快照
2. 操作 → **创建自定义镜像**
3. 镜像名称如：`aistudio-hangzhou-20260206`

### 3.3 复制镜像到香港地域

1. **镜像** → **自定义镜像** → 找到该镜像
2. 操作 → **复制镜像**
3. 目标地域选择：**中国（香港）**
4. 等待复制完成（约 10–30 分钟）

### 3.4 用镜像创建香港 ECS

1. **实例与镜像** → **镜像** → 切换到**香港**地域
2. 找到复制过来的镜像 → **创建实例**
3. 配置：选择与杭州相近的规格、Ubuntu 系统
4. 网络：选择**专有网络 VPC**，建议新建或选香港 VPC
5. 安全组：放行 22、80、443、8000 等端口
6. 购买并创建

### 3.5 获取新 ECS 公网 IP

创建完成后，记下香港 ECS 的**公网 IP**。

---

## 四、方式二：手动迁移（无镜像时）

若镜像复制失败或想全新部署，可手动迁移：

### 4.1 新购香港 ECS

- 地域：中国（香港）
- 系统：Ubuntu 22.04 或与杭州一致
- 规格：按业务需求选择

### 4.2 在杭州服务器上打包数据

```bash
# 数据库导出
pg_dump -U aistudio_user -d pet_painting -F p -f /tmp/pet_painting_backup.sql

# 项目代码打包（排除 venv、__pycache__）
cd /root
tar czvf project_code.tar.gz project_code/

# 用户数据打包
tar czvf project_data.tar.gz project_data/

# 证书
tar czvf ssl_certs.tar.gz /etc/nginx/ssl/
```

### 4.3 传到香港服务器

```bash
# 从杭州传到本机，再传到香港（或直接 scp 到香港）
scp /tmp/pet_painting_backup.sql root@香港IP:/tmp/
scp project_code.tar.gz root@香港IP:/root/
scp project_data.tar.gz root@香港IP:/root/
scp ssl_certs.tar.gz root@香港IP:/tmp/
```

### 4.4 在香港服务器上部署

参考 `云端部署更新指南-2026.md`，完成：

- 安装 PostgreSQL、Redis、Nginx、Python
- 导入数据库
- 解压代码和数据
- 配置 Nginx、SSL、systemd 服务
- 配置 `.env`（DATABASE_URL 等）

---

## 五、切换域名解析

### 5.1 修改 DNS 解析

1. 阿里云 → **云解析 DNS**（或域名所在服务商）
2. 找到 `photogooo.com` 的解析记录
3. 将 **A 记录** 的 IP 改为**香港 ECS 公网 IP**
4. TTL 可设小一点（如 300 秒）便于快速生效

### 5.2 等待生效

- 通常 5–30 分钟
- 可用 `nslookup photogooo.com` 检查是否已解析到新 IP

---

## 六、注意事项

### 6.1 香港与大陆网络差异

- **延迟**：香港到大陆用户延迟通常 50–100ms，比杭州略高
- **带宽**：香港按流量计费较多，注意流量与费用
- **访问稳定性**：香港无需备案，手机、小程序访问不受运营商拦截

### 6.2 数据一致性

- 迁移前建议**停服或只读**，避免迁移期间有新数据
- 迁移完成后做一次完整功能测试

### 6.3 费用

- 香港 ECS 价格通常高于大陆
- 可在阿里云价格计算器查看：https://www.aliyun.com/price/product#/ecs/detail

---

## 七、迁移检查清单

- [ ] 杭州 ECS 快照/镜像已创建
- [ ] 镜像已复制到香港（或手动迁移完成）
- [ ] 香港 ECS 已创建并可 SSH 登录
- [ ] PostgreSQL、Redis、Nginx、应用已正常运行
- [ ] 数据库已导入，数据完整
- [ ] SSL 证书已部署，HTTPS 正常
- [ ] DNS 已切换到香港 IP
- [ ] 手机、小程序可正常访问
- [ ] 确认无误后，可释放杭州 ECS 节省费用
