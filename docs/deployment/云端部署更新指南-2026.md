# 云端 Linux 部署更新指南

> 适用于：本地调试完成后，在云端 Linux 服务器部署 PostgreSQL、Redis、缓存及更新代码  
> 域名：photogooo.com（统一使用）  
> 更新日期：2026-02-06

---

## 一、部署前准备

### 1.1 本地确认清单

- [ ] 本地已使用 PostgreSQL 调试通过
- [ ] 本地已使用 Redis 调试通过
- [ ] `.env` 配置正确（可复制到云端）
- [ ] 域名证书已申请（如 `23379374_photogooo.com_nginx` 或类似）

### 1.2 证书文件说明

若证书申请后得到类似 `23379374_photogooo.com_nginx` 的文件夹，通常包含：

- `*.pem` 或 `*.crt` - 证书文件
- `*.key` - 私钥文件

部署时需重命名或复制为：

- `/etc/nginx/ssl/photogooo.pem` - 证书
- `/etc/nginx/ssl/photogooo.key` - 私钥

---

## 二、云端部署步骤

### 2.1 安装 PostgreSQL（若未安装）

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install postgresql postgresql-contrib -y

# 启动并设置开机自启
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### 2.2 创建数据库和用户

```bash
sudo -u postgres psql
```

在 psql 中执行：

```sql
CREATE DATABASE pet_painting;
CREATE USER aistudio_user WITH PASSWORD '你的密码';
GRANT ALL PRIVILEGES ON DATABASE pet_painting TO aistudio_user;
\c pet_painting
GRANT ALL ON SCHEMA public TO aistudio_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO aistudio_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO aistudio_user;
\q
```

或使用项目脚本：

```bash
python scripts/database/setup_postgresql.py
```

### 2.3 安装 Redis（若未安装）

```bash
# Ubuntu/Debian
sudo apt install redis-server -y

# 启动并设置开机自启
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 验证
redis-cli ping
# 应返回: PONG
```

### 2.4 更新代码

```bash
# 进入项目目录（根据实际路径修改）
cd /opt/aistudio
# 或 cd /root/project_code

# 方式1: 使用 Git 拉取
git pull origin main

# 方式2: 使用 scp 从本地上传
# 本地执行: scp -r E:\AI-STUDIO\aistudio-V14\* user@服务器IP:/opt/aistudio/
```

### 2.5 安装/更新 Python 依赖

```bash
cd /opt/aistudio  # 或你的项目路径
source venv/bin/activate

pip install -r requirements.txt
# 确保包含: psycopg2-binary, redis, python-dotenv, flask-compress
```

### 2.6 配置 .env 环境变量

在项目根目录创建或编辑 `.env`：

```env
# 生产环境（SECRET_KEY 必须设置，否则应用无法启动）
FLASK_ENV=production
SECRET_KEY=你的强密钥

# PostgreSQL
DATABASE_URL=postgresql://aistudio_user:你的密码@localhost:5432/pet_painting

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# 其他
UPLOAD_FOLDER=uploads
FINAL_FOLDER=final_works
HD_FOLDER=hd_images
```

### 2.7 初始化数据库表结构（新库）

**方式 A：本地 PostgreSQL 直接导出导入（推荐，最简单）**

若本地已用 PostgreSQL 调试好，直接导出再导入云端即可，无需 SQLite 迁移。

**本地 Windows 导出：**

```cmd
# 进入 PostgreSQL bin 目录（按实际版本修改 15/16/18）
cd "C:\Program Files\PostgreSQL\18\bin"

# 推荐：纯 SQL 格式（-F p），兼容所有 PostgreSQL 版本
pg_dump -U postgres -d pet_painting -F p -f C:\Users\Administrator\pet_painting.sql

# 或 Custom 格式（-F c），需云端 pg_restore 版本与本地一致
pg_dump -U postgres -d pet_painting -F c -f C:\Users\Administrator\pet_painting.dump
```

**上传到云端：**

```cmd
# 在本地 CMD 执行
scp C:\Users\Administrator\pet_painting.sql root@你的服务器IP:/root/
```

**云端 Linux 导入：**

```bash
# 若为 .sql 格式（推荐，兼容所有版本）
sudo -u postgres psql -d pet_painting -f /root/pet_painting.sql

# 若为 .dump 格式（需 pg_restore 版本与导出时一致，否则可能报 unsupported version）
sudo -u postgres pg_restore -U postgres -d pet_painting -c /root/pet_painting.dump
```

**导入前清空（可选）**：若数据库已有数据，可先清空再导入：

```bash
sudo -u postgres psql -d pet_painting -c "
DO \$\$ DECLARE r RECORD;
BEGIN
  FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public') LOOP
    EXECUTE 'TRUNCATE TABLE \"' || r.tablename || '\" CASCADE';
  END LOOP;
END \$\$;
"
```

**方式 B：使用云端自动迁移脚本（从 SQLite 迁移）**

```bash
cd /root/project_code
source venv/bin/activate
python scripts/deployment/cloud_db_migrate.py
```

该脚本会：加载 .env、创建表结构、若存在 `instance/pet_painting.db` 则自动迁移数据。

**或手动方式：**

```bash
# 若为全新数据库，需创建表
python scripts/database/setup_postgresql.py
# 选择选项 2 创建表结构

# 或执行权限脚本（若表已存在）
psql -U aistudio_user -d pet_painting -f grant_postgresql_permissions.sql
```

### 2.8 部署域名证书

```bash
# 创建 SSL 目录
sudo mkdir -p /etc/nginx/ssl

# 上传证书（在本地执行）
# scp 你的证书.pem user@服务器:/etc/nginx/ssl/photogooo.pem
# scp 你的私钥.key user@服务器:/etc/nginx/ssl/photogooo.key

# 若证书在 23379374_photogooo.com_nginx 文件夹内：
# scp 23379374_photogooo.com_nginx/*.pem user@服务器:/tmp/
# scp 23379374_photogooo.com_nginx/*.key user@服务器:/tmp/
# 然后在服务器上执行：
sudo cp /tmp/证书.pem /etc/nginx/ssl/photogooo.pem
sudo cp /tmp/私钥.key /etc/nginx/ssl/photogooo.key
sudo chmod 644 /etc/nginx/ssl/photogooo.pem
sudo chmod 600 /etc/nginx/ssl/photogooo.key
```

### 2.9 配置 Nginx（使用 photogooo.com）

```bash
# 复制配置
sudo cp config/nginx_linux_site.conf /etc/nginx/sites-available/aistudio

# 编辑配置，将 server_name 改为你的域名
sudo nano /etc/nginx/sites-available/aistudio
# 修改: server_name photogooo.com www.photogooo.com;
# 修改: alias 路径为你的实际项目路径

# 创建软链接
sudo ln -sf /etc/nginx/sites-available/aistudio /etc/nginx/sites-enabled/

# 若使用 photogooo.com 而非 photogooo，需修改
# server_name photogooo.com www.photogooo.com;
# ssl_certificate /etc/nginx/ssl/photogooo.pem;
# ssl_certificate_key /etc/nginx/ssl/photogooo.key;

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 2.10 重启应用服务

```bash
# 若使用 systemd 服务
sudo systemctl restart aistudio
# 或
sudo systemctl restart gunicorn

# 若使用手动启动
# 先停止旧进程，再启动
pkill -f gunicorn
cd /opt/aistudio
source venv/bin/activate
gunicorn -c gunicorn.conf.py test_server:app
```

---

## 三、验证部署

### 3.1 检查服务状态

```bash
# PostgreSQL
sudo systemctl status postgresql

# Redis
redis-cli ping

# Nginx
sudo systemctl status nginx

# 应用
curl -I http://localhost:8000/
```

### 3.2 检查 Redis 缓存

```bash
# 方式1：检查 Redis 服务
sudo systemctl status redis-server
redis-cli ping
# 返回 PONG 表示 Redis 正常运行

# 方式2：测试应用层缓存（推荐）
cd /root/project_code
source venv/bin/activate
python scripts/test_cache.py
# 输出 "缓存可用: 是" 表示 Redis 已正确接入应用
```

### 3.3 检查域名访问

```bash
curl -I https://photogooo.com/
# 或
curl -I https://你的域名/
```

---

## 四、配置更新（统一域名）

部署后需在管理后台更新以下配置为 `https://photogooo.com`：

1. **系统配置** → 服务器 URL：`https://photogooo.com`
2. **小程序配置** → 服务器地址、支付回调 URL
3. **冲印系统** → file_access_base_url
4. **加盟商二维码** → 扫码链接中的域名

---

## 五、常见问题

### 5.1 数据库连接失败

- 检查 `DATABASE_URL` 格式
- 检查 PostgreSQL 是否允许本地连接：`pg_hba.conf`
- 检查防火墙：`sudo ufw status`

### 5.2 Redis 连接失败

- 检查 `redis-cli ping`
- 检查 `.env` 中 `REDIS_HOST`、`REDIS_PORT`

### 5.3 证书不生效

- 确认证书路径正确
- 确认证书未过期
- `sudo nginx -t` 检查配置

### 5.4 静态文件 404

- 检查 Nginx 中 `alias` 路径是否与项目实际路径一致

### 5.5 应用反复重启 / SECRET_KEY 错误

- 在 `.env` 中必须设置 `SECRET_KEY=你的强密钥`
- 安装 python-dotenv：`pip install python-dotenv`，否则 .env 可能无法加载

---

## 六、相关文档

- **统一部署文档.md** - 快速部署参考
- **docs/deployment/PostgreSQL快速设置步骤.md** - PostgreSQL 详细步骤
- **docs/deployment/Redis安装和配置指南.md** - Redis 配置
- **docs/deployment/生产环境部署指南.md** - 完整部署流程
- **阿里云服务器-域名证书部署.md** - 证书部署

---

**最后更新**: 2026-02-06
