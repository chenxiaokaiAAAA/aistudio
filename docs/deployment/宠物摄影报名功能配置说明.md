# 宠物摄影报名功能配置说明

## 功能概述

本次更新为小程序添加了宠物摄影报名功能，主要包括：

1. **数据库模型扩展** - 新增 `PhotoSignup` 表存储报名信息
2. **轮播图功能扩展** - 支持设置为表单类型的轮播图
3. **API接口** - 新增报名提交、查询、状态更新等API

## 数据库模型

### PhotoSignup 模型
```python
class PhotoSignup(db.Model):
    """宠物摄影报名表"""
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), nullable=False)                # 用户姓名
    phone = db.Column(db.String(20), nullable=False)               # 联系电话
    pet_breed = db.Column(db.String(50), nullable=False)            # 宠物品种
    pet_weight = db.Column(db.String(50), nullable=False)            # 宠物体重
    pet_age = db.Column(db.String(50), nullable=False)              # 宠物年龄
    pet_character = db.Column(db.String(500))                      # 宠物性格
    available_date = db.Column(db.String(50))                       # 预约时间
    additional_notes = db.Column(db.String(500))                    # 备注
    
    # 推广相关字段
    user_id = db.Column(db.String(100))
    referrer_user_id = db.Column(db.String(100))
    referrer_promotion_code = db.Column(db.String(50))
    source = db.Column(db.String(50), default='miniprogram_carousel')
    
    # 状态字段
    status = db.Column(db.String(20), default='pending')    # pending, contacted, scheduled, completed, cancelled
    notes = db.Column(db.String(1000))                      # 内部备注
    
    submit_time = db.Column(db.DateTime, default=datetime.utcnow)
    contact_time = db.Column(db.DateTime)
    schedule_time = db.Column(db.DateTime)
    complete_time = db.Column(db.DateTime)
```

### HomepageBanner 模型扩展
新增字段：
```python
type = db.Column(db.String(20), default='link')           # banner类型：link, photo_signup
promotion_params = db.Column(db.Text)                      # 推广参数JSON字符串
```

## API接口

### 1. 提交报名
- **URL**: `POST /api/photo-signup/submit`
- **请求参数**:
```json
{
    "name": "张三",
    "phone": "13800138000",
    "petBreed": "金毛",
    "petWeight": "大型犬",
    "petAge": "2岁",
    "petCharacter": "温顺活泼",
    "availableDate": "周末",
    "additionalNotes": "希望拍摄户外照片",
    "userId": "user_123",
    "referrerUserId": "ref_456",
    "referrerPromotionCode": "PROMO001",
    "source": "miniprogram_carousel"
}
```

- **响应**:
```json
{
    "success": true,
    "message": "报名提交成功",
    "signupId": 123
}
```

### 2. 获取报名列表（管理员）
- **URL**: `GET /api/photo-signup/list`
- **参数**: 
  - `page`: 页码 (默认1)
  - `per_page`: 每页数量 (默认20)
  - `status`: 状态筛选 (可选)

### 3. 更新报名状态（管理员）
- **URL**: `PUT /api/photo-signup/{signup_id}/update-status`
- **请求参数**:
```json
{
    "status": "contacted",  // pending, contacted, scheduled, completed, cancelled
    "notes": "已电话联系用户"
}
```

### 4. 管理轮播图配置
- **创建轮播图**: `POST /api/admin/homepage/banners`
- **更新轮播图**: `PUT /api/admin/homepage/banners/{banner_id}`
- **获取轮播图**: `GET /api/admin/homepage/banners`

支持的新字段：
```json
{
    "type": "photo_signup",
    "promotion_params": {
        "promotionCode": "PROMO001",
        "userId": "USER123"
    }
}
```

### 5. 小程序获取轮播图
- **URL**: `GET /api/miniprogram/banners`

## 配置说明

### 如何在管理后台配置表单轮播图

1. **登录管理后台**
   - 访问 `http://photogooo/admin` (或测试环境对应地址)

2. **配置首页轮播图**
   - 进入轮播图管理页面
   - 点击"新增轮播图"

3. **设置表单类型轮播图**
   ```
   轮播图配置示例：
   - 标题: "宠物摄影报名"
   - 副标题: "专业拍摄服务"
   - 图片URL: 上传轮播图图片
   - 类型: photo_signup
   - 排序: 1
   - 状态: 启用
   - 推广参数: 
     {
       "promotionCode": "PET_PHOTO_001",
       "userId": "ADMIN001"
     }
   ```

4. **表单轮播图数据结构**
   当类型设为 `photo_signup` 时：
   - `link` 字段可以留空或设为前端表单页面路径
   - `promotion_params` 包含推广参数JSON

### 前端小程序集成

前端小程序可以通过以下方式识别轮播图类型：

```javascript
// 获取轮播图数据
wx.request({
  url: 'http://photogooo/api/miniprogram/banners',
  success: function(res) {
    res.data.forEach(banner => {
      if (banner.type === 'photo_signup') {
        // 显示表单入口轮播图
        // banner.promotion_params 包含推广参数
      }
    });
  }
});
```

### 状态管理

报名状态有以下几种：
- `pending`: 待联系
- `contacted`: 已联系
- `scheduled`: 已预约
- `completed`: 已完成
- `cancelled`: 已取消

管理员可以通过状态更新API来维护客户跟进流程。

## 部署说明

1. **数据库迁移**
   - 重启应用服务器后，新表会自动创建
   - 无需手动执行SQL命令

2. **测试验证**
   - 测试报名提交接口
   - 测试管理后台轮播图配置
   - 验证前端小程序轮播图显示

3. **推广追踪**
   - 系统会记录推广来源信息
   - 支持分佣和推广统计

## 注意事项

1. **表单验证**: API会验证手机号格式和必填字段
2. **推广参数**: 建议在轮播图中配置推广信息以便统计
3. **数据安全**: 管理系统应该添加适当的权限验证
4. **联系方式**: 建议在报名成功后及时联系客户

## 故障排除

### 常见问题

1. **数据库连接错误**
   - 检查数据库配置
   - 确认应用程序重启

2. **API无法访问**
   - 检查服务器状态
   - 确认路由配置正确

3. **推广参数丢失**
   - 检查promotion_params JSON格式
   - 确认前端正确传递参数

如有问题请联系开发团队。
