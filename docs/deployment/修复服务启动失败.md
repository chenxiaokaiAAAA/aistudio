# 修复 aistudio 服务启动失败

## 问题原因

服务配置文件使用了 `Type=notify`，但 `start_production.py` 脚本没有实现 systemd notify 功能，导致服务启动失败。

## 解决方案

### 方法1：修改服务类型（推荐）

将服务类型从 `notify` 改为 `simple`，这样 systemd 会直接运行命令，不需要等待通知。

### 方法2：检查其他可能的问题

1. `.env` 文件是否存在
2. 虚拟环境路径是否正确
3. 启动脚本是否有执行权限

---

## 立即执行（在服务器上）

### 步骤1：查看当前服务配置

```bash
cat /etc/systemd/system/aistudio.service
```

### 步骤2：修复服务配置

```bash
cat > /etc/systemd/system/aistudio.service << 'EOF'
[Unit]
Description=AI Studio Gunicorn Application Server
After=network.target

[Service]
Type=simple
User=root
Group=root
WorkingDirectory=/root/project_code
Environment="PATH=/root/project_code/venv/bin"
EnvironmentFile=/root/project_code/.env
ExecStart=/root/project_code/venv/bin/python /root/project_code/start_production.py
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=3
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
```

### 步骤3：检查必要文件

```bash
# 检查 .env 文件是否存在
ls -la /root/project_code/.env

# 如果不存在，创建它
cd /root/project_code
cat > .env << 'ENVEOF'
FLASK_ENV=production
SERVER_ENV=production
ENVEOF

# 检查启动脚本
ls -la /root/project_code/start_production.py

# 给启动脚本执行权限
chmod +x /root/project_code/start_production.py
```

### 步骤4：重新加载并启动

```bash
# 重新加载 systemd
systemctl daemon-reload

# 启动服务
systemctl start aistudio

# 查看状态
systemctl status aistudio
```

### 步骤5：如果还是失败，查看详细日志

```bash
# 查看完整日志
journalctl -u aistudio -n 100 --no-pager

# 或实时查看
journalctl -u aistudio -f
```

---

## 完整排查命令（复制粘贴执行）

```bash
# 1. 修复服务配置
cat > /etc/systemd/system/aistudio.service << 'EOF'
[Unit]
Description=AI Studio Gunicorn Application Server
After=network.target

[Service]
Type=simple
User=root
Group=root
WorkingDirectory=/root/project_code
Environment="PATH=/root/project_code/venv/bin"
EnvironmentFile=/root/project_code/.env
ExecStart=/root/project_code/venv/bin/python /root/project_code/start_production.py
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=3
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# 2. 确保 .env 文件存在
cd /root/project_code
if [ ! -f .env ]; then
    cat > .env << 'ENVEOF'
FLASK_ENV=production
SERVER_ENV=production
ENVEOF
    echo "✓ 已创建 .env 文件"
fi

# 3. 给启动脚本执行权限
chmod +x /root/project_code/start_production.py

# 4. 重新加载 systemd
systemctl daemon-reload

# 5. 启动服务
systemctl start aistudio

# 6. 查看状态
systemctl status aistudio

# 7. 如果失败，查看日志
journalctl -u aistudio -n 50 --no-pager
```

---

## 常见错误及解决方案

### 错误1：EnvironmentFile 不存在

**错误信息**：
```
Failed to load environment files: No such file or directory
```

**解决**：
```bash
# 创建 .env 文件
cd /root/project_code
cat > .env << 'EOF'
FLASK_ENV=production
SERVER_ENV=production
EOF
```

### 错误2：Python 路径错误

**错误信息**：
```
/bin/python: No such file or directory
```

**解决**：
```bash
# 检查虚拟环境路径
ls -la /root/project_code/venv/bin/python

# 如果不存在，重新创建虚拟环境
cd /root/project_code
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 错误3：启动脚本导入错误

**错误信息**：
```
ModuleNotFoundError: No module named 'test_server'
```

**解决**：
```bash
# 检查 test_server.py 是否存在
ls -la /root/project_code/test_server.py

# 如果不存在，检查项目结构
cd /root/project_code
ls -la *.py
```

### 错误4：Gunicorn 未安装

**错误信息**：
```
ModuleNotFoundError: No module named 'gunicorn'
```

**解决**：
```bash
cd /root/project_code
source venv/bin/activate
pip install gunicorn
```

---

## 验证服务运行

```bash
# 1. 检查服务状态
systemctl status aistudio

# 2. 检查端口监听
netstat -tlnp | grep 8000
# 或
ss -tlnp | grep 8000

# 3. 测试访问
curl http://localhost:8000/admin/

# 4. 测试通过Nginx访问
curl http://121.43.143.59/admin/
```

---

## 如果问题仍然存在

请执行以下命令并发送输出：

```bash
# 1. 查看服务配置
cat /etc/systemd/system/aistudio.service

# 2. 查看完整日志
journalctl -u aistudio --no-pager

# 3. 手动测试启动
cd /root/project_code
source venv/bin/activate
python start_production.py
```

手动启动时如果出现错误，请把错误信息发给我。
