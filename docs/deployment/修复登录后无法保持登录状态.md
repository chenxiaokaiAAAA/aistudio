# ä¿®å¤ç™»å½•åæ— æ³•ä¿æŒç™»å½•çŠ¶æ€

## ğŸ” é—®é¢˜åˆ†æ

ä» Network æ ‡ç­¾çœ‹ï¼š
- âœ… ç™»å½• POST è¯·æ±‚è¿”å› 302ï¼ˆæˆåŠŸï¼‰
- âœ… é‡å®šå‘åˆ° `/admin/dashboard`
- âŒ `/admin/dashboard` åˆé‡å®šå‘å›ç™»å½•é¡µï¼ˆ302 â†’ 302 â†’ 200ï¼‰

**è¯´æ˜**ï¼šç™»å½•æˆåŠŸï¼Œä½†æ— æ³•ä¿æŒç™»å½•çŠ¶æ€ï¼Œè®¿é—® dashboard æ—¶è¢«è¦æ±‚é‡æ–°ç™»å½•ã€‚

---

## ğŸ”§ å¯èƒ½çš„åŸå› 

1. **Session/Cookie é…ç½®é—®é¢˜**
2. **Flask-Login é…ç½®é—®é¢˜**
3. **SECRET_KEY ä¸ä¸€è‡´**
4. **Cookie åŸŸåé—®é¢˜**

---

## ğŸ”§ ç«‹å³ä¿®å¤

### æ­¥éª¤1ï¼šæ£€æŸ¥ SECRET_KEY

```bash
# æ£€æŸ¥ SECRET_KEY é…ç½®
grep "SECRET_KEY" /root/project_code/test_server.py
grep "SECRET_KEY" /root/project_code/.env 2>/dev/null || echo ".envæ–‡ä»¶ä¸å­˜åœ¨"
```

### æ­¥éª¤2ï¼šæ£€æŸ¥ Flask-Login é…ç½®

```bash
# æ£€æŸ¥ login_manager é…ç½®
grep -A 10 "login_manager" /root/project_code/test_server.py | head -15
```

### æ­¥éª¤3ï¼šæµ‹è¯• Session

```bash
cd /root/project_code
source venv/bin/activate

python << 'PYEOF'
from test_server import app
print("SECRET_KEY:", app.config.get('SECRET_KEY', 'æœªè®¾ç½®'))
print("SESSION_COOKIE_SECURE:", app.config.get('SESSION_COOKIE_SECURE', 'æœªè®¾ç½®'))
print("SESSION_COOKIE_HTTPONLY:", app.config.get('SESSION_COOKIE_HTTPONLY', 'æœªè®¾ç½®'))
PYEOF
```

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç¡®ä¿ SECRET_KEY è®¾ç½®æ­£ç¡®

```bash
# æ£€æŸ¥å¹¶è®¾ç½® SECRET_KEY
cd /root/project_code
source venv/bin/activate

python << 'PYEOF'
from test_server import app
import os

# æ£€æŸ¥å½“å‰ SECRET_KEY
current_key = app.config.get('SECRET_KEY', 'change-me-in-production')
print(f"å½“å‰ SECRET_KEY: {current_key[:20]}...")

# å¦‚æœä½¿ç”¨é»˜è®¤å€¼ï¼Œè®¾ç½®ä¸€ä¸ªå›ºå®šçš„å¯†é’¥
if current_key == 'change-me-in-production':
    # åœ¨ .env æ–‡ä»¶ä¸­è®¾ç½®
    import subprocess
    with open('.env', 'a') as f:
        f.write('\nSECRET_KEY=your-secret-key-here-change-in-production\n')
    print("âœ… å·²åœ¨ .env ä¸­æ·»åŠ  SECRET_KEY")
else:
    print("âœ… SECRET_KEY å·²è®¾ç½®")
PYEOF
```

### æ–¹æ¡ˆ2ï¼šæ£€æŸ¥å¹¶ä¿®å¤ Cookie è®¾ç½®

```bash
# æ£€æŸ¥ Nginx é…ç½®ä¸­çš„ proxy è®¾ç½®
grep -A 5 "proxy_set_header" /etc/nginx/sites-available/aistudio | grep -E "Host|X-Forwarded"
```

---

## ğŸ“‹ å®Œæ•´ä¿®å¤è„šæœ¬

```bash
#!/bin/bash
echo "=========================================="
echo "ä¿®å¤ç™»å½•çŠ¶æ€ä¿æŒé—®é¢˜"
echo "=========================================="
echo ""

# 1. æ£€æŸ¥ SECRET_KEY
echo "[1/3] æ£€æŸ¥ SECRET_KEY..."
cd /root/project_code
source venv/bin/activate

python << 'PYEOF'
from test_server import app
import os

current_key = app.config.get('SECRET_KEY', 'change-me-in-production')
print(f"å½“å‰ SECRET_KEY: {current_key[:30]}...")

if current_key == 'change-me-in-production':
    # ç”Ÿæˆä¸€ä¸ªå›ºå®šçš„å¯†é’¥
    import secrets
    new_key = secrets.token_hex(32)
    
    # æ›´æ–° .env æ–‡ä»¶
    env_content = ""
    if os.path.exists('.env'):
        with open('.env', 'r') as f:
            env_content = f.read()
    
    if 'SECRET_KEY' not in env_content:
        with open('.env', 'a') as f:
            f.write(f'\nSECRET_KEY={new_key}\n')
        print(f"âœ… å·²ç”Ÿæˆå¹¶è®¾ç½®æ–°çš„ SECRET_KEY")
    else:
        print("âš ï¸  .env ä¸­å·²æœ‰ SECRET_KEYï¼Œä½†åº”ç”¨æœªè¯»å–")
else:
    print("âœ… SECRET_KEY å·²è®¾ç½®")
PYEOF

echo ""
# 2. æ£€æŸ¥ Nginx Cookie è®¾ç½®
echo "[2/3] æ£€æŸ¥ Nginx é…ç½®..."
grep -A 3 "proxy_set_header Host" /etc/nginx/sites-available/aistudio | head -5

echo ""
# 3. é‡å¯æœåŠ¡
echo "[3/3] é‡å¯æœåŠ¡..."
systemctl restart aistudio
sleep 3
systemctl status aistudio --no-pager -l | head -15

echo ""
echo "=========================================="
echo "ä¿®å¤å®Œæˆï¼"
echo "=========================================="
echo ""
echo "ç°åœ¨è¯·ï¼š"
echo "  1. æ¸…é™¤æµè§ˆå™¨ Cookie"
echo "  2. é‡æ–°è®¿é—®: http://121.43.143.59/login"
echo "  3. ä½¿ç”¨ admin/admin123 ç™»å½•"
```

---

## ğŸ¯ ç«‹å³æ‰§è¡Œ

æ‰§è¡Œä¸Šé¢çš„**å®Œæ•´ä¿®å¤è„šæœ¬**ï¼Œå®ƒä¼šï¼š
1. æ£€æŸ¥å¹¶è®¾ç½® SECRET_KEY
2. æ£€æŸ¥ Nginx é…ç½®
3. é‡å¯æœåŠ¡

---

## ğŸŒ æµè§ˆå™¨ç«¯æ“ä½œ

ä¿®å¤åï¼Œåœ¨æµè§ˆå™¨ä¸­ï¼š
1. **æ¸…é™¤ Cookie**ï¼š
   - æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
   - Application æ ‡ç­¾ â†’ Cookies â†’ åˆ é™¤æ‰€æœ‰
   - æˆ–æŒ‰ `Ctrl + Shift + Delete` æ¸…é™¤

2. **é‡æ–°ç™»å½•**ï¼š
   - è®¿é—®ï¼š`http://121.43.143.59/login`
   - ä½¿ç”¨ `admin` / `admin123` ç™»å½•

---

## ğŸ“ æ‰§è¡Œå

æ‰§è¡Œä¿®å¤è„šæœ¬åï¼Œæ¸…é™¤æµè§ˆå™¨ Cookieï¼Œç„¶åé‡æ–°ç™»å½•ã€‚

å¦‚æœä»ç„¶ä¸è¡Œï¼Œå‘Šè¯‰æˆ‘ç»“æœï¼Œæˆ‘ä¼šç»§ç»­æ’æŸ¥ã€‚
