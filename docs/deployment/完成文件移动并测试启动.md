# 完成文件移动并测试启动

## ✅ 当前状态

- ✅ `start_production.py` 文件已存在
- ⚠️ 还有 `aistudio` 子目录，里面有 `.git`、`.gitignore`、`instance` 等

---

## 🔧 完成文件移动

### 步骤1：移动剩余文件

```bash
# 移动 aistudio 子目录中的所有文件（排除 .git）
cd /root/project_code
if [ -d aistudio ]; then
    # 移动 .gitignore（如果不存在）
    if [ -f aistudio/.gitignore ] && [ ! -f .gitignore ]; then
        cp aistudio/.gitignore .
    fi
    
    # 移动 instance 目录（如果不存在或合并）
    if [ -d aistudio/instance ]; then
        if [ ! -d instance ]; then
            mv aistudio/instance .
        else
            # 合并 instance 目录
            cp -r aistudio/instance/* instance/ 2>/dev/null || true
        fi
    fi
    
    # 删除 aistudio 子目录（保留 .git 在子目录中，或删除整个目录）
    rm -rf aistudio
    echo "✅ 文件已移动"
fi
```

### 步骤2：设置权限

```bash
# 设置文件权限
chmod +x /root/project_code/start_production.py
chmod -R 755 /root/project_code/static 2>/dev/null || true
chmod 755 /root/project_code/instance 2>/dev/null || true
chmod 644 /root/project_code/instance/pet_painting.db 2>/dev/null || true
```

### 步骤3：测试启动

```bash
# 测试启动
cd /root/project_code
source venv/bin/activate
python start_production.py
```

---

## 📋 完整脚本

```bash
#!/bin/bash
echo "=========================================="
echo "完成文件移动并测试启动"
echo "=========================================="
echo ""

# 1. 移动剩余文件
echo "[1/4] 移动剩余文件..."
cd /root/project_code
if [ -d aistudio ]; then
    # 移动 .gitignore
    if [ -f aistudio/.gitignore ] && [ ! -f .gitignore ]; then
        cp aistudio/.gitignore .
        echo "✅ .gitignore 已移动"
    fi
    
    # 处理 instance 目录
    if [ -d aistudio/instance ]; then
        if [ ! -d instance ]; then
            mv aistudio/instance .
            echo "✅ instance 目录已移动"
        else
            cp -r aistudio/instance/* instance/ 2>/dev/null || true
            echo "✅ instance 目录已合并"
        fi
    fi
    
    # 删除 aistudio 子目录
    rm -rf aistudio
    echo "✅ aistudio 子目录已删除"
else
    echo "无 aistudio 子目录"
fi
echo ""

# 2. 设置权限
echo "[2/4] 设置权限..."
chmod +x /root/project_code/start_production.py
chmod -R 755 /root/project_code/static 2>/dev/null || true
chmod 755 /root/project_code/instance 2>/dev/null || true
chmod 644 /root/project_code/instance/pet_painting.db 2>/dev/null || true
echo "✅ 权限已设置"
echo ""

# 3. 验证文件
echo "[3/4] 验证关键文件..."
ls -la /root/project_code/start_production.py
ls -la /root/project_code/test_server.py
ls -la /root/project_code/instance/pet_painting.db 2>/dev/null || echo "⚠️ 数据库文件不存在"
echo ""

# 4. 测试启动
echo "[4/4] 测试启动..."
cd /root/project_code
source venv/bin/activate
echo "开始测试启动（按 Ctrl+C 停止）..."
python start_production.py
```

---

## 🎯 立即执行

执行上面的**完整脚本**，它会：
1. 移动剩余文件
2. 设置权限
3. 验证文件
4. 测试启动

如果手动启动成功（看到 Gunicorn 启动信息），按 `Ctrl+C` 停止，然后重启服务：

```bash
systemctl restart aistudio
systemctl status aistudio
```

---

## 📝 执行后

执行脚本后告诉我：
1. 文件是否都移动完成
2. 手动启动是否成功
3. 如果启动失败，具体的错误信息

这样我可以继续排查。
