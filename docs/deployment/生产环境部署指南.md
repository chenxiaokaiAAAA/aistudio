# 生产环境部署指南

## 概述

本文档介绍如何在阿里云Linux服务器上部署AI拍照机系统，使用Flask + Gunicorn + Nginx的标准生产环境架构。

## 架构说明

```
用户请求 → Nginx (反向代理) → Gunicorn (WSGI服务器) → Flask应用
```

- **Nginx**: 处理静态文件、SSL、反向代理、负载均衡
- **Gunicorn**: 运行Python应用，支持多进程/多线程
- **Flask**: 应用框架

## 前置要求

1. **服务器环境**
   - Linux系统（Ubuntu 20.04+ / CentOS 7+）
   - Python 3.8+
   - 至少2GB内存
   - 至少20GB磁盘空间

2. **已安装软件**
   - Python 3.8+
   - pip
   - Nginx
   - Git（用于代码拉取）

## 部署步骤

### 1. 准备服务器环境

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y  # Ubuntu
# 或
sudo yum update -y  # CentOS

# 安装Python和pip
sudo apt install python3 python3-pip python3-venv -y  # Ubuntu
# 或
sudo yum install python3 python3-pip -y  # CentOS

# 安装Nginx
sudo apt install nginx -y  # Ubuntu
# 或
sudo yum install nginx -y  # CentOS
```

### 2. 创建项目目录

```bash
# 创建项目目录（根据实际情况修改路径）
sudo mkdir -p /opt/aistudio
sudo chown $USER:$USER /opt/aistudio
cd /opt/aistudio
```

### 3. 上传项目代码

```bash
# 方式1: 使用Git克隆
git clone <your-repo-url> .

# 方式2: 使用scp上传
# 在本地执行: scp -r /path/to/project user@server:/opt/aistudio/
```

### 4. 创建Python虚拟环境

```bash
cd /opt/aistudio
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

### 5. 配置环境变量

```bash
# 创建环境变量文件
nano .env

# 添加以下内容（根据实际情况修改）
export FLASK_ENV=production
export SERVER_ENV=production
export SECRET_KEY=your-secret-key-here
export DATABASE_URL=sqlite:///instance/pet_painting.db
export UPLOAD_FOLDER=uploads
export FINAL_FOLDER=final_works
export HD_FOLDER=hd_images
```

### 6. 创建必要的目录

```bash
mkdir -p logs uploads final_works hd_images static instance
```

### 7. 配置Gunicorn

```bash
# 使用项目根目录的gunicorn.conf.py
# 如果需要修改，编辑 gunicorn.conf.py
nano gunicorn.conf.py
```

### 8. 配置Nginx

```bash
# 复制Nginx配置文件
sudo cp config/nginx_linux.conf /etc/nginx/sites-available/aistudio
# 或 CentOS: sudo cp config/nginx_linux.conf /etc/nginx/conf.d/aistudio.conf

# 编辑配置文件，修改以下内容：
# - server_name: 您的域名
# - ssl_certificate: SSL证书路径
# - alias路径: 项目实际路径
sudo nano /etc/nginx/sites-available/aistudio

# 创建符号链接（Ubuntu）
sudo ln -s /etc/nginx/sites-available/aistudio /etc/nginx/sites-enabled/

# 测试Nginx配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 9. 配置SSL证书

```bash
# 创建SSL证书目录
sudo mkdir -p /etc/nginx/ssl

# 上传您的SSL证书
# 方式1: 使用scp从本地上传
# scp your-cert.pem user@server:/etc/nginx/ssl/photogooo.pem
# scp your-key.key user@server:/etc/nginx/ssl/photogooo.key

# 方式2: 使用Let's Encrypt（推荐）
sudo apt install certbot python3-certbot-nginx -y
sudo certbot --nginx -d photogooo -d www.photogooo
```

### 10. 创建Systemd服务（推荐）

```bash
# 创建服务文件
sudo nano /etc/systemd/system/aistudio.service
```

添加以下内容：

```ini
[Unit]
Description=AI Studio Gunicorn Application Server
After=network.target

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/opt/aistudio
Environment="PATH=/opt/aistudio/venv/bin"
EnvironmentFile=/opt/aistudio/.env
ExecStart=/opt/aistudio/venv/bin/python /opt/aistudio/start_production.py
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

```bash
# 重新加载systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start aistudio

# 设置开机自启
sudo systemctl enable aistudio

# 查看服务状态
sudo systemctl status aistudio

# 查看日志
sudo journalctl -u aistudio -f
```

### 11. 手动启动（不使用systemd）

```bash
cd /opt/aistudio
source venv/bin/activate
python start_production.py
```

## 配置说明

### 图片路径配置

1. 登录管理后台: `https://your-domain.com/admin/`
2. 进入"系统配置" → "图片路径配置"
3. 配置以下内容：
   - **存储类型**: 选择"本地存储"或"阿里云OSS"
   - **本地路径**: 配置各个文件夹路径
   - **OSS配置**: 如果使用OSS，填写OSS相关配置

### 服务器URL配置

在系统配置中设置：
- **服务器基础URL**: `https://your-domain.com`
- **API基础URL**: `https://your-domain.com/api`
- **媒体文件URL**: `https://your-domain.com/media`
- **静态文件URL**: `https://your-domain.com/static`

## 常用命令

### 服务管理

```bash
# 启动服务
sudo systemctl start aistudio

# 停止服务
sudo systemctl stop aistudio

# 重启服务
sudo systemctl restart aistudio

# 查看状态
sudo systemctl status aistudio

# 查看日志
sudo journalctl -u aistudio -f
```

### Nginx管理

```bash
# 重启Nginx
sudo systemctl restart nginx

# 重新加载配置（不中断服务）
sudo systemctl reload nginx

# 查看Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 应用日志

```bash
# 查看应用日志
tail -f /opt/aistudio/logs/access.log
tail -f /opt/aistudio/logs/error.log
tail -f /opt/aistudio/logs/startup.log
```

## 性能优化建议

1. **Worker进程数**: 根据CPU核心数调整 `gunicorn.conf.py` 中的 `workers`
2. **数据库优化**: 如果使用SQLite，考虑迁移到PostgreSQL或MySQL
3. **静态文件**: 使用CDN加速静态文件访问
4. **图片存储**: 使用OSS存储，减轻服务器压力
5. **缓存**: 考虑使用Redis缓存热点数据

## 安全建议

1. **防火墙**: 只开放80和443端口
2. **SSL证书**: 必须使用HTTPS
3. **密钥管理**: 不要将密钥提交到代码仓库
4. **定期备份**: 设置数据库和文件的定期备份
5. **日志监控**: 定期检查日志，发现异常及时处理

## 故障排查

### 服务无法启动

```bash
# 检查Python环境
which python3
python3 --version

# 检查依赖
pip list

# 检查日志
tail -f logs/error.log
sudo journalctl -u aistudio -n 50
```

### Nginx 502错误

```bash
# 检查Gunicorn是否运行
ps aux | grep gunicorn

# 检查端口是否被占用
netstat -tlnp | grep 8000

# 检查Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

### 静态文件404

```bash
# 检查文件权限
ls -la /opt/aistudio/static/

# 检查Nginx配置中的路径是否正确
sudo nginx -t
```

## 备份策略

```bash
# 备份数据库
cp instance/pet_painting.db backups/pet_painting_$(date +%Y%m%d).db

# 备份上传文件
tar -czf backups/uploads_$(date +%Y%m%d).tar.gz uploads/

# 备份配置文件
tar -czf backups/config_$(date +%Y%m%d).tar.gz config/ .env
```

## 更新部署

```bash
# 1. 备份当前版本
cp -r /opt/aistudio /opt/aistudio_backup_$(date +%Y%m%d)

# 2. 拉取最新代码
cd /opt/aistudio
git pull

# 3. 更新依赖
source venv/bin/activate
pip install -r requirements.txt

# 4. 重启服务
sudo systemctl restart aistudio

# 5. 检查服务状态
sudo systemctl status aistudio
```

## 联系支持

如遇到问题，请查看：
- 应用日志: `/opt/aistudio/logs/`
- Nginx日志: `/var/log/nginx/`
- Systemd日志: `sudo journalctl -u aistudio`
