# ä¿®å¤åŠ ç›Ÿå•†ç™»å½•æ— ååº”é—®é¢˜

## ğŸ” é—®é¢˜ç°è±¡

- æœ¬åœ°æœåŠ¡å™¨ç™»å½•æ­£å¸¸
- é˜¿é‡Œäº‘æœåŠ¡å™¨ç™»å½•åæ²¡æœ‰ååº”
- æŸ¥çœ‹æ—¥å¿—ä¹Ÿæ²¡æœ‰åŠ¨é™

## ğŸ”§ é—®é¢˜åŸå› 

### ä¸»è¦åŸå› ï¼šCookieé…ç½®é—®é¢˜

åœ¨ `test_server.py` ä¸­ï¼Œå¦‚æœç¯å¢ƒå˜é‡è®¾ç½®ä¸º `production`ï¼Œä¼šå¯ç”¨ `SESSION_COOKIE_SECURE = True`ã€‚

**é—®é¢˜**ï¼š
- `Secure` Cookie **åªèƒ½é€šè¿‡ HTTPS ä¼ è¾“**
- å¦‚æœæœåŠ¡å™¨ä½¿ç”¨ **HTTP**ï¼ŒCookie æ— æ³•è®¾ç½®
- å¯¼è‡´ Session æ— æ³•ä¿å­˜ï¼Œç™»å½•åç«‹å³å¤±æ•ˆ

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šè‡ªåŠ¨ä¿®å¤ï¼ˆæ¨èï¼‰

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd /root/project_code
bash scripts/deployment/ä¿®å¤åŠ ç›Ÿå•†ç™»å½•é—®é¢˜.sh
systemctl restart aistudio
```

### æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨ä¿®å¤

#### æ­¥éª¤1ï¼šä¿®å¤Cookieé…ç½®

ç¼–è¾‘ `test_server.py`ï¼Œæ‰¾åˆ°ä»¥ä¸‹ä»£ç ï¼ˆçº¦ç¬¬155-162è¡Œï¼‰ï¼š

```python
# Secure cookies in production
is_production = os.environ.get('FLASK_ENV') == 'production' or os.environ.get('ENV') == 'production'
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['REMEMBER_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
app.config['REMEMBER_COOKIE_SAMESITE'] = 'Lax'
if is_production:
    app.config['SESSION_COOKIE_SECURE'] = True
    app.config['REMEMBER_COOKIE_SECURE'] = True
```

æ›¿æ¢ä¸ºï¼š

```python
# Secure cookies in production
is_production = os.environ.get('FLASK_ENV') == 'production' or os.environ.get('ENV') == 'production'
use_https = os.environ.get('USE_HTTPS', 'false').lower() == 'true'
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['REMEMBER_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
app.config['REMEMBER_COOKIE_SAMESITE'] = 'Lax'
# åªåœ¨çœŸæ­£ä½¿ç”¨HTTPSæ—¶æ‰å¯ç”¨Secure Cookie
# HTTPç¯å¢ƒä¸‹ç¦ç”¨Secure Cookieï¼ˆå¦åˆ™Cookieæ— æ³•è®¾ç½®ï¼Œå¯¼è‡´ç™»å½•å¤±è´¥ï¼‰
if is_production and use_https:
    app.config['SESSION_COOKIE_SECURE'] = True
    app.config['REMEMBER_COOKIE_SECURE'] = True
else:
    # HTTPç¯å¢ƒä¸‹ç¦ç”¨Secure Cookie
    app.config['SESSION_COOKIE_SECURE'] = False
    app.config['REMEMBER_COOKIE_SECURE'] = False
```

#### æ­¥éª¤2ï¼šæ·»åŠ ç™»å½•è°ƒè¯•æ—¥å¿—

ç¼–è¾‘ `app/routes/franchisee/frontend.py`ï¼Œåœ¨ç™»å½•å‡½æ•°ä¸­æ·»åŠ æ—¥å¿—ï¼š

```python
@bp.route('/login', methods=['GET', 'POST'])
def franchisee_login():
    """åŠ ç›Ÿå•†ç™»å½•é¡µé¢"""
    import logging
    logger = logging.getLogger(__name__)
    
    # ... åŸæœ‰ä»£ç  ...
    
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        
        logger.info(f"[åŠ ç›Ÿå•†ç™»å½•] å°è¯•ç™»å½•: username={username}")
        
        # ... éªŒè¯é€»è¾‘ ...
        
        if account and check_password_hash(account.password, password):
            # ... ç™»å½•æˆåŠŸé€»è¾‘ ...
            logger.info(f"[åŠ ç›Ÿå•†ç™»å½•] ç™»å½•æˆåŠŸ: username={username}, franchisee_id={account.id}")
            logger.info(f"[åŠ ç›Ÿå•†ç™»å½•] Sessionè®¾ç½®: franchisee_id={session.get('franchisee_id')}")
            # ...
```

#### æ­¥éª¤3ï¼šé‡å¯æœåŠ¡

```bash
systemctl restart aistudio
```

#### æ­¥éª¤4ï¼šæŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
journalctl -u aistudio -f

# æˆ–æŸ¥çœ‹åº”ç”¨æ—¥å¿—æ–‡ä»¶
tail -f /root/project_code/logs/app.log
```

## ğŸ” éªŒè¯ä¿®å¤

1. **å°è¯•ç™»å½•**ï¼šè®¿é—®åŠ ç›Ÿå•†ç™»å½•é¡µé¢ï¼Œè¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
2. **æŸ¥çœ‹æ—¥å¿—**ï¼šåº”è¯¥èƒ½çœ‹åˆ°ç™»å½•ç›¸å…³çš„æ—¥å¿—è¾“å‡º
3. **æ£€æŸ¥Session**ï¼šç™»å½•æˆåŠŸåï¼Œåº”è¯¥èƒ½æ­£å¸¸è·³è½¬åˆ°dashboard

## ğŸ“‹ æ—¥å¿—ç¤ºä¾‹

ä¿®å¤åï¼Œç™»å½•æ—¶åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼æ—¥å¿—ï¼š

```
[åŠ ç›Ÿå•†ç™»å½•] å°è¯•ç™»å½•: username=testuser
[åŠ ç›Ÿå•†ç™»å½•] ç™»å½•æˆåŠŸ: username=testuser, franchisee_id=1
[åŠ ç›Ÿå•†ç™»å½•] Sessionè®¾ç½®: franchisee_id=1, company=æµ‹è¯•å…¬å¸
[åŠ ç›Ÿå•†ç™»å½•] é‡å®šå‘åˆ°: /franchisee/dashboard
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¦‚æœä½¿ç”¨HTTPS**ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ `USE_HTTPS=true` å¹¶é‡å¯æœåŠ¡
2. **å¦‚æœä½¿ç”¨HTTP**ï¼šç¡®ä¿ `SESSION_COOKIE_SECURE = False`
3. **æ£€æŸ¥Nginxé…ç½®**ï¼šç¡®ä¿ä»£ç†é…ç½®æ­£ç¡®

## ğŸš¨ å¦‚æœä»ç„¶å¤±è´¥

1. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**ï¼š
   ```bash
   systemctl status aistudio
   ```

2. **æ£€æŸ¥ç«¯å£ç›‘å¬**ï¼š
   ```bash
   netstat -tlnp | grep 8000
   ```

3. **æ£€æŸ¥Nginxé…ç½®**ï¼š
   ```bash
   nginx -t
   systemctl status nginx
   ```

4. **æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—**ï¼š
   ```bash
   journalctl -u aistudio -n 100 --no-pager
   tail -100 /root/project_code/logs/error.log
   ```
