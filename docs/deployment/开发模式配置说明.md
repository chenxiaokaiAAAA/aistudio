# 开发模式配置说明

## 📋 当前启用的开发模式

### 1. OpenID获取 - 开发模式
**文件：** `test_server.py` 第 4420 行

**配置：**
```python
DEV_MODE_SKIP_OPENID = True  # ⚠️ 上线前改为 False
```

**功能：**
- 跳过真实的微信openid验证
- 返回测试openid：`test_openid_xxxxxxxx`
- 避免因微信配置问题导致无法创建订单

### 2. 支付功能 - 开发模式
**文件：** `pages/payment/payment.js` 第 447 行

**配置：**
```javascript
const SKIP_REAL_PAYMENT = true; // ⚠️ 上线前改为 false
```

**功能：**
- 跳过真实的微信支付
- 直接完成订单
- 方便测试完整流程

### 3. 前端OpenID容错处理
**文件：** `pages/payment/payment.js`

**功能：**
- 如果openid获取失败，自动使用测试openid继续流程
- 兼容两种返回格式：`{success: true}` 或 `{data: {success: true}}`

## 🔧 证件照订单流程

### 当前流程（已优化）

1. **用户选择产品**：证件照
2. **填写订单信息**：姓名、电话、地址等
3. **确认订单信息**：不需要上传图片
4. **支付订单**：开发模式下跳过真实支付
5. **生成二维码**：支付后显示二维码
6. **到店拍摄**：用安卓APP扫码拍摄
7. **照片回传**：拍摄后自动上传到订单

### 订单状态

- **创建时**：`status = 'unpaid'`（未支付）
- **支付后**：`status = 'pending'`（待制作）
- **拍摄完成**：`status = 'completed'`（已完成）

### 图片处理

- **创建订单时**：`original_image = ''`（空，不需要图片）
- **拍摄后**：通过 `/api/miniprogram/order/upload` 接口上传照片
- **照片关联**：上传后自动关联到订单

## ⚠️ 上线前检查清单

### 后端（test_server.py）

- [ ] 第 4420 行：`DEV_MODE_SKIP_OPENID = False`
- [ ] 确保微信配置正确：`WECHAT_PAY_CONFIG['appid']` 和 `app_secret`

### 前端（payment.js）

- [ ] 第 447 行：`SKIP_REAL_PAYMENT = false`
- [ ] 测试真实支付流程
- [ ] 验证openid获取正常

## 📝 相关文件

- `test_server.py` - 后端主文件
  - 第 4416 行：`/api/user/openid` 接口
  - 第 5423 行：`/api/miniprogram/orders` 订单创建接口
- `pages/payment/payment.js` - 支付页面
  - 第 368 行：openid检查逻辑
  - 第 443 行：支付订单创建逻辑

## 🎯 当前状态

✅ **开发模式已启用**
- OpenID：使用测试openid
- 支付：跳过真实支付
- 订单：可以正常创建（不要求图片）
- 流程：可以完整测试

## 🔄 如何恢复生产模式

### 后端
```python
# test_server.py 第 4420 行
DEV_MODE_SKIP_OPENID = False  # 改为 False
```

### 前端
```javascript
// pages/payment/payment.js 第 447 行
const SKIP_REAL_PAYMENT = false;  // 改为 false
```
