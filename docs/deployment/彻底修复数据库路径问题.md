# å½»åº•ä¿®å¤æ•°æ®åº“è·¯å¾„é—®é¢˜

## ðŸ” å½“å‰çŠ¶æ€

- âŒ æœåŠ¡ä»åœ¨é‡å¯å¾ªçŽ¯ï¼š`activating (auto-restart)`
- âŒ æ•°æ®åº“é”™è¯¯ä»ç„¶å­˜åœ¨ï¼š`unable to open database file`
- âš ï¸ è¿›ç¨‹é€€å‡ºçŠ¶æ€ï¼š`status=0/SUCCESS`ï¼ˆä½†åº”ç”¨å®žé™…å¤±è´¥ï¼‰

---

## ðŸ”§ å®Œæ•´è¯Šæ–­å’Œä¿®å¤

### æ­¥éª¤1ï¼šå…¨é¢æ£€æŸ¥

```bash
echo "=== 1. æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶ ==="
ls -la /root/project_code/instance/pet_painting.db

echo ""
echo "=== 2. æ£€æŸ¥å½“å‰é…ç½® ==="
grep "SQLALCHEMY_DATABASE_URI" /root/project_code/test_server.py

echo ""
echo "=== 3. æ£€æŸ¥å·¥ä½œç›®å½• ==="
pwd

echo ""
echo "=== 4. æµ‹è¯•æ•°æ®åº“è¿žæŽ¥ ==="
cd /root/project_code
source venv/bin/activate
python -c "
import sqlite3
import os
db_path = '/root/project_code/instance/pet_painting.db'
print(f'æ•°æ®åº“è·¯å¾„: {db_path}')
print(f'æ–‡ä»¶å­˜åœ¨: {os.path.exists(db_path)}')
print(f'æ–‡ä»¶æƒé™: {oct(os.stat(db_path).st_mode) if os.path.exists(db_path) else \"N/A\"}')
try:
    conn = sqlite3.connect(db_path)
    print('âœ… æ•°æ®åº“è¿žæŽ¥æˆåŠŸ')
    conn.close()
except Exception as e:
    print(f'âŒ æ•°æ®åº“è¿žæŽ¥å¤±è´¥: {e}')
"
```

### æ­¥éª¤2ï¼šä¿®æ”¹é…ç½®ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰

```bash
# åœæ­¢æœåŠ¡
systemctl stop aistudio

# å¤‡ä»½
cp /root/project_code/test_server.py /root/project_code/test_server.py.bak2

# ä¿®æ”¹ä¸ºç»å¯¹è·¯å¾„ï¼ˆæ³¨æ„ï¼šSQLite URI ç»å¯¹è·¯å¾„éœ€è¦4ä¸ªæ–œæ ï¼‰
sed -i "s|sqlite:///.*pet_painting.db|sqlite:////root/project_code/instance/pet_painting.db|g" /root/project_code/test_server.py

# éªŒè¯
echo "ä¿®æ”¹åŽçš„é…ç½®:"
grep "SQLALCHEMY_DATABASE_URI" /root/project_code/test_server.py
```

### æ­¥éª¤3ï¼šç¡®ä¿æƒé™æ­£ç¡®

```bash
# è®¾ç½®ç›®å½•å’Œæ–‡ä»¶æƒé™
chmod 755 /root/project_code/instance
chmod 644 /root/project_code/instance/pet_painting.db
chown root:root /root/project_code/instance/pet_painting.db

# éªŒè¯æƒé™
ls -la /root/project_code/instance/
```

### æ­¥éª¤4ï¼šé‡å¯å¹¶éªŒè¯

```bash
# é‡å¯æœåŠ¡
systemctl restart aistudio

# ç­‰å¾…å¯åŠ¨
sleep 5

# æŸ¥çœ‹çŠ¶æ€
systemctl status aistudio --no-pager -l | head -25

# æŸ¥çœ‹æ—¥å¿—
journalctl -u aistudio -n 30 --no-pager | tail -20
```

---

## ðŸš¨ å¦‚æžœä»ç„¶å¤±è´¥ï¼šä½¿ç”¨çŽ¯å¢ƒå˜é‡

å¦‚æžœç›´æŽ¥ä¿®æ”¹æ–‡ä»¶ä¸è¡Œï¼Œä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼š

```bash
# ç¼–è¾‘ .env æ–‡ä»¶
cat > /root/project_code/.env << 'EOF'
FLASK_ENV=production
SERVER_ENV=production
DATABASE_URL=sqlite:////root/project_code/instance/pet_painting.db
EOF

# éªŒè¯
cat /root/project_code/.env

# é‡å¯æœåŠ¡
systemctl restart aistudio
sleep 5
systemctl status aistudio --no-pager -l | head -25
```

---

## ðŸ“‹ å®Œæ•´ä¸€é”®ä¿®å¤è„šæœ¬

```bash
#!/bin/bash
echo "=========================================="
echo "å½»åº•ä¿®å¤æ•°æ®åº“è·¯å¾„é—®é¢˜"
echo "=========================================="
echo ""

# 1. åœæ­¢æœåŠ¡
echo "[1/6] åœæ­¢æœåŠ¡..."
systemctl stop aistudio
sleep 2

# 2. æ£€æŸ¥æ–‡ä»¶
echo ""
echo "[2/6] æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶..."
if [ -f /root/project_code/instance/pet_painting.db ]; then
    echo "âœ… æ•°æ®åº“æ–‡ä»¶å­˜åœ¨"
    ls -lh /root/project_code/instance/pet_painting.db
else
    echo "âŒ æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼"
    exit 1
fi

# 3. è®¾ç½®æƒé™
echo ""
echo "[3/6] è®¾ç½®æƒé™..."
chmod 755 /root/project_code/instance
chmod 644 /root/project_code/instance/pet_painting.db
chown root:root /root/project_code/instance/pet_painting.db
echo "âœ… æƒé™å·²è®¾ç½®"

# 4. å¤‡ä»½å¹¶ä¿®æ”¹é…ç½®
echo ""
echo "[4/6] ä¿®æ”¹é…ç½®..."
cp /root/project_code/test_server.py /root/project_code/test_server.py.bak2
sed -i "s|sqlite:///.*pet_painting.db|sqlite:////root/project_code/instance/pet_painting.db|g" /root/project_code/test_server.py
echo "âœ… é…ç½®å·²ä¿®æ”¹"
echo "ä¿®æ”¹åŽçš„é…ç½®:"
grep "SQLALCHEMY_DATABASE_URI" /root/project_code/test_server.py

# 5. è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
echo ""
echo "[5/6] è®¾ç½®çŽ¯å¢ƒå˜é‡..."
cat > /root/project_code/.env << 'ENVEOF'
FLASK_ENV=production
SERVER_ENV=production
DATABASE_URL=sqlite:////root/project_code/instance/pet_painting.db
ENVEOF
echo "âœ… çŽ¯å¢ƒå˜é‡å·²è®¾ç½®"

# 6. é‡å¯æœåŠ¡
echo ""
echo "[6/6] é‡å¯æœåŠ¡..."
systemctl restart aistudio
sleep 5

echo ""
echo "=========================================="
echo "ä¿®å¤å®Œæˆï¼ŒæŸ¥çœ‹çŠ¶æ€ï¼š"
echo "=========================================="
systemctl status aistudio --no-pager -l | head -25

echo ""
echo "=========================================="
echo "æ£€æŸ¥ç«¯å£ï¼š"
echo "=========================================="
netstat -tlnp | grep 8000 || echo "âš ï¸ ç«¯å£æœªç›‘å¬"

echo ""
echo "=========================================="
echo "æœ€æ–°æ—¥å¿—ï¼š"
echo "=========================================="
journalctl -u aistudio -n 20 --no-pager | tail -15
```

---

## ðŸŽ¯ æ‰§è¡Œé¡ºåº

1. **å…ˆæ‰§è¡Œå®Œæ•´è¯Šæ–­**ï¼ˆæ­¥éª¤1ï¼‰
2. **å¦‚æžœæ–‡ä»¶å­˜åœ¨ä¸”æƒé™æ­£ç¡®ï¼Œæ‰§è¡Œä¿®å¤**ï¼ˆæ­¥éª¤2-4ï¼‰
3. **å¦‚æžœä»ç„¶å¤±è´¥ï¼Œä½¿ç”¨çŽ¯å¢ƒå˜é‡æ–¹æ¡ˆ**ï¼ˆæ­¥éª¤5ï¼‰
4. **æŠŠç»“æžœå‘ç»™æˆ‘**

---

## ðŸ“ å…³é”®ç‚¹

1. **SQLite URI ç»å¯¹è·¯å¾„æ ¼å¼**ï¼š`sqlite:////absolute/path`ï¼ˆ4ä¸ªæ–œæ ï¼‰
2. **æ–‡ä»¶æƒé™**ï¼šç›®å½•755ï¼Œæ–‡ä»¶644
3. **çŽ¯å¢ƒå˜é‡ä¼˜å…ˆçº§**ï¼šå¦‚æžœè®¾ç½®äº† `DATABASE_URL` çŽ¯å¢ƒå˜é‡ï¼Œä¼šè¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„è®¾ç½®
