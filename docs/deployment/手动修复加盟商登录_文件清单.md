# æ‰‹åŠ¨ä¿®å¤åŠ ç›Ÿå•†ç™»å½•é—®é¢˜ - æ–‡ä»¶æ¸…å•

## ğŸ“‹ éœ€è¦æ›¿æ¢çš„æ–‡ä»¶

### æ–‡ä»¶1ï¼š`test_server.py`ï¼ˆçº¦ç¬¬154-162è¡Œï¼‰

**ä½ç½®**ï¼š`/root/project_code/test_server.py`

**éœ€è¦æ›¿æ¢çš„ä»£ç **ï¼š

æ‰¾åˆ°è¿™æ®µä»£ç ï¼ˆçº¦ç¬¬154-162è¡Œï¼‰ï¼š
```python
# Secure cookies in production
is_production = os.environ.get('FLASK_ENV') == 'production' or os.environ.get('ENV') == 'production'
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['REMEMBER_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
app.config['REMEMBER_COOKIE_SAMESITE'] = 'Lax'
if is_production:
    app.config['SESSION_COOKIE_SECURE'] = True
    app.config['REMEMBER_COOKIE_SECURE'] = True
```

**æ›¿æ¢ä¸º**ï¼š
```python
# Secure cookies in production
is_production = os.environ.get('FLASK_ENV') == 'production' or os.environ.get('ENV') == 'production'
use_https = os.environ.get('USE_HTTPS', 'false').lower() == 'true'
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['REMEMBER_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
app.config['REMEMBER_COOKIE_SAMESITE'] = 'Lax'
# åªåœ¨çœŸæ­£ä½¿ç”¨HTTPSæ—¶æ‰å¯ç”¨Secure Cookie
# HTTPç¯å¢ƒä¸‹ç¦ç”¨Secure Cookieï¼ˆå¦åˆ™Cookieæ— æ³•è®¾ç½®ï¼Œå¯¼è‡´ç™»å½•å¤±è´¥ï¼‰
if is_production and use_https:
    app.config['SESSION_COOKIE_SECURE'] = True
    app.config['REMEMBER_COOKIE_SECURE'] = True
else:
    # HTTPç¯å¢ƒä¸‹ç¦ç”¨Secure Cookie
    app.config['SESSION_COOKIE_SECURE'] = False
    app.config['REMEMBER_COOKIE_SECURE'] = False
```

---

### æ–‡ä»¶2ï¼š`app/routes/franchisee/frontend.py`ï¼ˆçº¦ç¬¬25-58è¡Œï¼‰

**ä½ç½®**ï¼š`/root/project_code/app/routes/franchisee/frontend.py`

**éœ€è¦æ›¿æ¢çš„ä»£ç **ï¼š

æ‰¾åˆ° `franchisee_login` å‡½æ•°ï¼ˆçº¦ç¬¬25-58è¡Œï¼‰ï¼š
```python
def franchisee_login():
    """åŠ ç›Ÿå•†ç™»å½•é¡µé¢"""
    models = get_models()
    if not models:
        flash('ç³»ç»Ÿæœªåˆå§‹åŒ–', 'error')
        return render_template('franchisee/login.html')
    
    FranchiseeAccount = models['FranchiseeAccount']
    
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        
        if not username or not password:
            flash('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error')
            return render_template('franchisee/login.html')
        
        account = FranchiseeAccount.query.filter_by(username=username).first()
        
        if account and check_password_hash(account.password, password):
            if account.status != 'active':
                flash('è´¦æˆ·å·²è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error')
                return render_template('franchisee/login.html')
            
            session['franchisee_id'] = account.id
            session['franchisee_username'] = account.username
            session['franchisee_company'] = account.company_name
            
            flash(f'æ¬¢è¿å›æ¥ï¼Œ{account.company_name}', 'success')
            return redirect(url_for('franchisee.franchisee_frontend.dashboard'))
        else:
            flash('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error')
    
    return render_template('franchisee/login.html')
```

**æ›¿æ¢ä¸º**ï¼š
```python
def franchisee_login():
    """åŠ ç›Ÿå•†ç™»å½•é¡µé¢"""
    import logging
    logger = logging.getLogger(__name__)
    
    models = get_models()
    if not models:
        logger.error("[åŠ ç›Ÿå•†ç™»å½•] ç³»ç»Ÿæœªåˆå§‹åŒ–")
        flash('ç³»ç»Ÿæœªåˆå§‹åŒ–', 'error')
        return render_template('franchisee/login.html')
    
    FranchiseeAccount = models['FranchiseeAccount']
    
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        
        logger.info(f"[åŠ ç›Ÿå•†ç™»å½•] å°è¯•ç™»å½•: username={username}")
        
        if not username or not password:
            logger.warning(f"[åŠ ç›Ÿå•†ç™»å½•] ç”¨æˆ·åæˆ–å¯†ç ä¸ºç©º")
            flash('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error')
            return render_template('franchisee/login.html')
        
        account = FranchiseeAccount.query.filter_by(username=username).first()
        
        if account and check_password_hash(account.password, password):
            if account.status != 'active':
                logger.warning(f"[åŠ ç›Ÿå•†ç™»å½•] è´¦æˆ·è¢«ç¦ç”¨: username={username}, status={account.status}")
                flash('è´¦æˆ·å·²è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'error')
                return render_template('franchisee/login.html')
            
            session['franchisee_id'] = account.id
            session['franchisee_username'] = account.username
            session['franchisee_company'] = account.company_name
            
            logger.info(f"[åŠ ç›Ÿå•†ç™»å½•] ç™»å½•æˆåŠŸ: username={username}, franchisee_id={account.id}")
            logger.info(f"[åŠ ç›Ÿå•†ç™»å½•] Sessionè®¾ç½®: franchisee_id={session.get('franchisee_id')}, company={session.get('franchisee_company')}")
            
            flash(f'æ¬¢è¿å›æ¥ï¼Œ{account.company_name}', 'success')
            redirect_url = url_for('franchisee.franchisee_frontend.dashboard')
            logger.info(f"[åŠ ç›Ÿå•†ç™»å½•] é‡å®šå‘åˆ°: {redirect_url}")
            return redirect(redirect_url)
        else:
            logger.warning(f"[åŠ ç›Ÿå•†ç™»å½•] ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯: username={username}")
            flash('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error')
    
    return render_template('franchisee/login.html')
```

---

## ğŸ”§ æ“ä½œæ­¥éª¤

### åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

1. **å¤‡ä»½åŸæ–‡ä»¶**ï¼š
   ```bash
   cd /root/project_code
   cp test_server.py test_server.py.bak
   cp app/routes/franchisee/frontend.py app/routes/franchisee/frontend.py.bak
   ```

2. **ç¼–è¾‘æ–‡ä»¶**ï¼š
   ```bash
   # ç¼–è¾‘ test_server.py
   nano test_server.py
   # æ‰¾åˆ°ç¬¬154-162è¡Œï¼Œæ›¿æ¢ä¸ºä¸Šé¢çš„ä»£ç 
   
   # ç¼–è¾‘ frontend.py
   nano app/routes/franchisee/frontend.py
   # æ‰¾åˆ° franchisee_login å‡½æ•°ï¼Œæ›¿æ¢ä¸ºä¸Šé¢çš„ä»£ç 
   ```

3. **é‡å¯æœåŠ¡**ï¼š
   ```bash
   systemctl restart aistudio
   ```

4. **æŸ¥çœ‹æ—¥å¿—**ï¼š
   ```bash
   journalctl -u aistudio -f
   ```

---

## âœ… éªŒè¯ä¿®å¤

ä¿®å¤åï¼Œå°è¯•ç™»å½•æ—¶åº”è¯¥èƒ½çœ‹åˆ°æ—¥å¿—ï¼š

```
[åŠ ç›Ÿå•†ç™»å½•] å°è¯•ç™»å½•: username=xxx
[åŠ ç›Ÿå•†ç™»å½•] ç™»å½•æˆåŠŸ: username=xxx, franchisee_id=1
[åŠ ç›Ÿå•†ç™»å½•] Sessionè®¾ç½®: franchisee_id=1, company=xxx
[åŠ ç›Ÿå•†ç™»å½•] é‡å®šå‘åˆ°: /franchisee/dashboard
```

---

## ğŸ“ å¿«é€Ÿå‘½ä»¤ï¼ˆä¸€é”®æ‰§è¡Œï¼‰

```bash
cd /root/project_code && \
cp test_server.py test_server.py.bak && \
cp app/routes/franchisee/frontend.py app/routes/franchisee/frontend.py.bak && \
echo "âœ… å·²å¤‡ä»½ï¼Œè¯·æ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶åæ‰§è¡Œ: systemctl restart aistudio"
```
