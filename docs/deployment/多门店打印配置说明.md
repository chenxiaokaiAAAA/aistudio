# 多门店打印配置说明

## 问题

如果多个门店使用**同一个打印代理服务地址和API密钥**，后台如何区分打印任务最终发送到哪个门店的打印机？

## 当前架构

### 正确的架构（推荐）

**每个门店应该运行自己的打印代理服务实例**，使用不同的地址或端口：

```
门店A（厦门SM商城）
  ├── 自拍机：XMSM_001
  ├── 打印代理服务：http://192.168.2.100:8888
  └── 打印机：\\sm003\HP OfficeJet Pro 7730 series

门店B（北京朝阳店）
  ├── 自拍机：BJSM_001
  ├── 打印代理服务：http://192.168.2.101:8888  （不同的IP或端口）
  └── 打印机：\\printer-bj\Canon PIXMA
```

### 工作流程

1. **订单关联自拍机**：订单通过 `selfie_machine_id` 关联到自拍机
2. **查找打印机配置**：根据 `selfie_machine_id` 查找对应的打印机配置
3. **发送到对应代理**：打印请求发送到该门店的打印代理服务地址
4. **代理服务打印**：打印代理服务使用它配置的打印机进行打印

## 配置示例

### 门店A配置

**在打印配置页面：**
- 自拍机序列号：`XMSM_001`
- 打印代理服务地址：`http://192.168.2.100:8888`
- API密钥：`test-key-123`

**在门店A的电脑上运行打印代理服务：**
```bash
# 设置环境变量
set LOCAL_PRINTER_PATH=\\sm003\HP OfficeJet Pro 7730 series
set PRINT_PROXY_PORT=8888
set PRINT_PROXY_API_KEY=test-key-123

# 运行服务
python print_proxy_server.py
```

### 门店B配置

**在打印配置页面：**
- 自拍机序列号：`BJSM_001`
- 打印代理服务地址：`http://192.168.2.101:8888`  （不同的IP）
- API密钥：`test-key-123`  （可以相同，也可以不同）

**在门店B的电脑上运行打印代理服务：**
```bash
# 设置环境变量
set LOCAL_PRINTER_PATH=\\printer-bj\Canon PIXMA
set PRINT_PROXY_PORT=8888
set PRINT_PROXY_API_KEY=test-key-123

# 运行服务
python print_proxy_server.py
```

## 如何区分打印任务？

### 方式1：不同的打印代理服务地址（推荐）

**每个门店使用不同的IP地址或端口：**
- 门店A：`http://192.168.2.100:8888`
- 门店B：`http://192.168.2.101:8888`
- 门店C：`http://192.168.2.102:8888`

**优点：**
- ✅ 简单清晰，每个门店独立
- ✅ 易于管理和排查问题
- ✅ 一个门店的打印服务故障不影响其他门店

### 方式2：通过frp内网穿透（如果门店没有公网IP）

**每个门店使用不同的frp远程端口：**
- 门店A：`http://192.168.2.54:18888`  （frp映射到门店A的8888端口）
- 门店B：`http://192.168.2.54:18889`  （frp映射到门店B的8888端口）
- 门店C：`http://192.168.2.54:18890`  （frp映射到门店C的8888端口）

**frp配置示例（门店A）：**
```toml
# frpc.toml (门店A)
serverAddr = "192.168.2.54"
serverPort = 7000
auth.token = "your-secret-token-123456"

[[proxies]]
name = "print_proxy_store_a"
type = "tcp"
localIP = "127.0.0.1"
localPort = 8888
remotePort = 18888  # 门店A使用18888端口
```

**frp配置示例（门店B）：**
```toml
# frpc.toml (门店B)
serverAddr = "192.168.2.54"
serverPort = 7000
auth.token = "your-secret-token-123456"

[[proxies]]
name = "print_proxy_store_b"
type = "tcp"
localIP = "127.0.0.1"
localPort = 8888
remotePort = 18889  # 门店B使用18889端口（不同）
```

## 后台如何区分？

后台通过以下逻辑区分打印任务：

1. **订单关联自拍机**：`order.selfie_machine_id = 'XMSM_001'`
2. **查找打印机配置**：根据 `selfie_machine_id` 查找配置
   ```python
   # 查找配置：local_printer_proxy_url_XMSM_001
   # 返回：http://192.168.2.100:8888
   ```
3. **发送到对应地址**：打印请求发送到 `http://192.168.2.100:8888`
4. **打印代理服务**：该服务运行在门店A的电脑上，使用门店A的打印机

## 重要提示

### ✅ 推荐做法

1. **每个门店运行独立的打印代理服务**
2. **使用不同的IP地址或端口**
3. **每个门店配置自己的打印机路径**

### ❌ 不推荐的做法

1. **多个门店共享同一个打印代理服务地址**
   - 如果必须共享，需要在打印请求中传递打印机路径参数
   - 这需要修改 `print_proxy_server.py` 支持动态打印机选择

2. **所有门店使用相同的打印机路径**
   - 这会导致所有打印任务都发送到同一台打印机

## 当前实现

当前系统已经支持多门店打印配置：

1. ✅ 每个自拍机可以配置独立的打印代理服务地址
2. ✅ 后台根据订单的 `selfie_machine_id` 自动选择对应的配置
3. ✅ 打印请求发送到对应的打印代理服务地址

**只需要确保：**
- 每个门店运行自己的打印代理服务实例
- 每个门店使用不同的IP地址或端口
- 在打印配置页面为每个自拍机配置正确的打印代理服务地址

## 示例：完整的配置流程

### 步骤1：在门店A的电脑上运行打印代理服务

```bash
# 门店A（IP: 192.168.2.100）
set LOCAL_PRINTER_PATH=\\sm003\HP OfficeJet Pro 7730 series
set PRINT_PROXY_PORT=8888
set PRINT_PROXY_API_KEY=test-key-123
python print_proxy_server.py
```

### 步骤2：在门店B的电脑上运行打印代理服务

```bash
# 门店B（IP: 192.168.2.101）
set LOCAL_PRINTER_PATH=\\printer-bj\Canon PIXMA
set PRINT_PROXY_PORT=8888
set PRINT_PROXY_API_KEY=test-key-123
python print_proxy_server.py
```

### 步骤3：在后台配置打印代理服务地址

**访问：** `/admin/printer`

**门店打印机配置：**
- XMSM_001（门店A）：
  - 打印代理服务地址：`http://192.168.2.100:8888`
  - API密钥：`test-key-123`
  
- BJSM_001（门店B）：
  - 打印代理服务地址：`http://192.168.2.101:8888`
  - API密钥：`test-key-123`

### 步骤4：测试打印

1. 订单关联到 `XMSM_001` → 打印请求发送到 `http://192.168.2.100:8888` → 门店A的打印机
2. 订单关联到 `BJSM_001` → 打印请求发送到 `http://192.168.2.101:8888` → 门店B的打印机

## 总结

**后台通过不同的打印代理服务地址来区分不同门店的打印任务。**

- 每个门店运行自己的打印代理服务实例
- 每个门店使用不同的IP地址或端口
- 后台根据订单的 `selfie_machine_id` 查找对应的打印代理服务地址
- 打印请求发送到对应的地址，自然就区分开了

**如果多个门店必须使用同一个打印代理服务地址，需要修改 `print_proxy_server.py` 支持在请求中传递打印机路径参数。**
