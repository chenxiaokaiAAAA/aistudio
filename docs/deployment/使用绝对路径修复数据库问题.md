# 使用绝对路径修复数据库问题

## 🔍 问题

即使修改了配置，仍然报错 `unable to open database file`。

**可能原因**：
1. SQLite 相对路径解析问题
2. 工作目录不正确
3. 需要使用绝对路径

---

## 🔧 解决方案：使用绝对路径

### 步骤1：验证当前配置

```bash
# 查看当前配置
grep "SQLALCHEMY_DATABASE_URI" /root/project_code/test_server.py
```

### 步骤2：修改为绝对路径

```bash
# 修改为绝对路径（SQLite URI格式：4个斜杠表示绝对路径）
sed -i "s|sqlite:///instance/pet_painting.db|sqlite:////root/project_code/instance/pet_painting.db|g" /root/project_code/test_server.py

# 验证修改
grep "SQLALCHEMY_DATABASE_URI" /root/project_code/test_server.py
```

**注意**：SQLite URI 中，绝对路径需要 **4个斜杠**：`sqlite:////absolute/path`

---

## ✅ 完整修复命令

```bash
echo "=== 1. 查看当前配置 ==="
grep "SQLALCHEMY_DATABASE_URI" /root/project_code/test_server.py

echo ""
echo "=== 2. 修改为绝对路径 ==="
sed -i "s|sqlite:///.*pet_painting.db|sqlite:////root/project_code/instance/pet_painting.db|g" /root/project_code/test_server.py

echo ""
echo "=== 3. 验证修改 ==="
grep "SQLALCHEMY_DATABASE_URI" /root/project_code/test_server.py

echo ""
echo "=== 4. 确认文件存在 ==="
ls -lh /root/project_code/instance/pet_painting.db

echo ""
echo "=== 5. 重启服务 ==="
systemctl restart aistudio
sleep 3

echo ""
echo "=== 6. 查看状态 ==="
systemctl status aistudio --no-pager -l | head -20

echo ""
echo "=== 7. 检查端口 ==="
netstat -tlnp | grep 8000

echo ""
echo "=== 8. 查看最新日志 ==="
journalctl -u aistudio -n 30 --no-pager | tail -15
```

---

## 🔍 如果仍然失败

### 方法1：检查文件权限

```bash
# 检查文件权限
ls -la /root/project_code/instance/pet_painting.db

# 设置权限
chmod 644 /root/project_code/instance/pet_painting.db
chmod 755 /root/project_code/instance
```

### 方法2：手动测试数据库连接

```bash
cd /root/project_code
source venv/bin/activate
python -c "
import sqlite3
try:
    conn = sqlite3.connect('/root/project_code/instance/pet_painting.db')
    print('✅ 数据库连接成功')
    conn.close()
except Exception as e:
    print(f'❌ 数据库连接失败: {e}')
"
```

### 方法3：检查 SELinux（如果启用）

```bash
# 检查 SELinux 状态
getenforce 2>/dev/null || echo "SELinux未安装"

# 如果启用，可能需要设置上下文
# chcon -R -t httpd_sys_rw_content_t /root/project_code/instance/
```

---

## 📋 替代方案：使用环境变量

如果直接修改文件不行，可以使用环境变量：

```bash
# 编辑 .env 文件
echo "DATABASE_URL=sqlite:////root/project_code/instance/pet_painting.db" >> /root/project_code/.env

# 验证
cat /root/project_code/.env
```

然后重启服务。

---

## 🎯 推荐执行顺序

1. **先执行完整修复命令**（使用绝对路径）
2. **如果失败，检查文件权限**
3. **如果还失败，手动测试数据库连接**
4. **把结果发给我**
