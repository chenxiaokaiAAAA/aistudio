# 生产环境启动说明

## 概述

生产环境使用 **Gunicorn + Nginx** 架构，而不是直接使用 `python start.py`。

## 启动方式对比

| 环境 | 启动方式 | 说明 |
|------|---------|------|
| **开发环境** | `python start.py` | 使用Flask内置服务器，支持热重载 |
| **生产环境** | `python start_production.py` 或 systemd | 使用Gunicorn，多进程，高性能 |

## 生产环境启动方法

### 方法1：使用 systemd 服务（推荐）⭐

这是最推荐的方式，服务会自动启动、自动重启。

#### 1. 创建服务文件

```bash
sudo nano /etc/systemd/system/aistudio.service
```

#### 2. 添加以下内容

```ini
[Unit]
Description=AI Studio Gunicorn Application Server
After=network.target

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/opt/aistudio
Environment="PATH=/opt/aistudio/venv/bin"
EnvironmentFile=/opt/aistudio/.env
ExecStart=/opt/aistudio/venv/bin/python /opt/aistudio/start_production.py
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

**注意**：请根据实际情况修改：
- `WorkingDirectory`: 项目实际路径（如 `/opt/aistudio`）
- `User/Group`: 运行用户（如 `www-data` 或您的用户名）
- `EnvironmentFile`: 环境变量文件路径

#### 3. 重新加载 systemd

```bash
sudo systemctl daemon-reload
```

#### 4. 启动服务

```bash
# 启动服务
sudo systemctl start aistudio

# 设置开机自启
sudo systemctl enable aistudio

# 查看服务状态
sudo systemctl status aistudio

# 查看日志
sudo journalctl -u aistudio -f
```

#### 5. 常用命令

```bash
# 启动服务
sudo systemctl start aistudio

# 停止服务
sudo systemctl stop aistudio

# 重启服务
sudo systemctl restart aistudio

# 查看状态
sudo systemctl status aistudio

# 查看日志
sudo journalctl -u aistudio -f
sudo journalctl -u aistudio -n 50  # 查看最近50行
```

---

### 方法2：直接使用 start_production.py

适合临时测试或调试。

#### 1. 激活虚拟环境

```bash
cd /opt/aistudio
source venv/bin/activate
```

#### 2. 启动服务

```bash
python start_production.py
```

#### 3. 停止服务

按 `Ctrl + C` 停止

**注意**：这种方式服务不会自动重启，如果进程崩溃需要手动重启。

---

### 方法3：直接使用 Gunicorn 命令

适合高级用户，可以更精细地控制参数。

#### 1. 激活虚拟环境

```bash
cd /opt/aistudio
source venv/bin/activate
```

#### 2. 启动 Gunicorn

```bash
# 使用配置文件
gunicorn --config gunicorn.conf.py test_server:app

# 或直接指定参数
gunicorn \
    --bind 0.0.0.0:8000 \
    --workers 5 \
    --worker-class sync \
    --timeout 120 \
    --access-logfile logs/access.log \
    --error-logfile logs/error.log \
    --log-level info \
    --pid gunicorn.pid \
    test_server:app
```

#### 3. 停止服务

```bash
# 使用PID文件停止
kill -TERM $(cat gunicorn.pid)

# 或查找进程停止
pkill -f gunicorn
```

---

## 完整部署流程

### 1. 准备环境

```bash
# 创建项目目录
sudo mkdir -p /opt/aistudio
sudo chown $USER:$USER /opt/aistudio
cd /opt/aistudio

# 上传代码（或使用git clone）
# git clone <your-repo-url> .

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

### 2. 配置环境变量

```bash
# 创建 .env 文件
nano .env
```

添加以下内容：

```bash
FLASK_ENV=production
SERVER_ENV=production
SECRET_KEY=your-secret-key-here
DATABASE_URL=sqlite:///instance/pet_painting.db
UPLOAD_FOLDER=uploads
FINAL_FOLDER=final_works
HD_FOLDER=hd_images
```

### 3. 创建必要目录

```bash
mkdir -p logs uploads final_works hd_images static instance backups
```

### 4. 配置 Nginx

```bash
# 复制配置文件
sudo cp config/nginx_linux.conf /etc/nginx/sites-available/aistudio

# 编辑配置（修改域名和路径）
sudo nano /etc/nginx/sites-available/aistudio

# 创建符号链接
sudo ln -s /etc/nginx/sites-available/aistudio /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 5. 配置 SSL 证书

```bash
# 使用 Let's Encrypt（推荐）
sudo apt install certbot python3-certbot-nginx -y
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

### 6. 创建 systemd 服务

按照上面的"方法1"创建服务。

### 7. 启动服务

```bash
sudo systemctl start aistudio
sudo systemctl enable aistudio
```

---

## 验证服务运行

### 1. 检查服务状态

```bash
sudo systemctl status aistudio
```

应该看到 `active (running)` 状态。

### 2. 检查端口监听

```bash
netstat -tlnp | grep 8000
# 或
ss -tlnp | grep 8000
```

应该看到 `0.0.0.0:8000` 在监听。

### 3. 检查进程

```bash
ps aux | grep gunicorn
```

应该看到多个 worker 进程。

### 4. 测试访问

```bash
# 测试本地访问
curl http://localhost:8000/admin/

# 测试通过Nginx访问
curl https://your-domain.com/admin/
```

---

## 故障排查

### 服务无法启动

```bash
# 查看详细日志
sudo journalctl -u aistudio -n 100 --no-pager

# 检查Python环境
which python3
python3 --version

# 检查依赖
pip list | grep gunicorn
```

### 端口被占用

```bash
# 查看端口占用
sudo lsof -i :8000
# 或
sudo netstat -tlnp | grep 8000

# 停止占用端口的进程
sudo kill -9 <PID>
```

### 权限问题

```bash
# 检查文件权限
ls -la /opt/aistudio/

# 修改所有者
sudo chown -R www-data:www-data /opt/aistudio/
```

### 查看应用日志

```bash
# 查看Gunicorn日志
tail -f /opt/aistudio/logs/access.log
tail -f /opt/aistudio/logs/error.log
tail -f /opt/aistudio/logs/startup.log
```

---

## 性能优化建议

### 1. Worker 进程数

根据服务器CPU核心数调整 `gunicorn.conf.py`：

```python
workers = cpu_count * 2 + 1
```

### 2. 超时时间

根据AI任务处理时间调整：

```python
timeout = 120  # 秒，可根据实际情况调整
```

### 3. 数据库优化

如果使用SQLite，考虑迁移到PostgreSQL或MySQL。

### 4. 使用 OSS 存储

在系统配置中切换到OSS存储，减轻服务器压力。

---

## 注意事项

1. **不要使用 `python start.py`**：这是开发环境启动方式
2. **必须使用 HTTPS**：生产环境必须配置SSL证书
3. **定期备份**：数据库和重要文件要定期备份
4. **监控日志**：定期检查日志，发现异常及时处理
5. **防火墙配置**：只开放必要端口（80、443）

---

## 快速参考

```bash
# 启动服务
sudo systemctl start aistudio

# 停止服务
sudo systemctl stop aistudio

# 重启服务
sudo systemctl restart aistudio

# 查看状态
sudo systemctl status aistudio

# 查看日志
sudo journalctl -u aistudio -f

# 查看应用日志
tail -f /opt/aistudio/logs/error.log
```
