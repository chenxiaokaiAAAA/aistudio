# 同步后图片 404 与 /docs API 文档打不开说明

## 一、图片 404（/media/original/ 等）

### 原因
- 服务器 Nginx 配置中，`/media/original/`、`/media/final/`、`/media/hd/` 指向的是 **`/root/project_data/user_images/`** 下的子目录。
- 同步脚本之前把 `uploads`、`final_works`、`hd_images` 传到的是 **`/root/project_code/`** 下，和 Nginx 使用的路径不一致，所以访问 `/media/original/xxx` 会 404。

### 已做修改
- 同步脚本已改为：**媒体目录**（`uploads`、`final_works`、`hd_images`）统一同步到 **`/root/project_data/user_images/`** 对应子目录，与 Nginx 配置一致。
- 同步前会自动在服务器上执行 `mkdir -p`，确保目标目录存在。

### 你需要做的
1. **再执行一次「同步全部」或「仅同步图片」**  
   图片会传到 Nginx 实际使用的路径，小程序配置页、风格分类等图片应能正常显示。
2. **确认服务器 Nginx 配置**  
   确认站点配置里类似：
   - `location /media/original/ { alias /root/project_data/user_images/uploads/; }`
   - `location /media/final/ { alias /root/project_data/user_images/final_works/; }`
   - `location /media/hd/ { alias /root/project_data/user_images/hd_images/; }`  
   若你改过 Nginx 路径，请把 `scripts/deployment/sync_to_aliyun.py` 里的 `REMOTE_MEDIA_BASE` 改成与 Nginx 一致。

---

## 二、/docs API 文档打不开（404）

### 原因
- `/docs` 由 Flask 应用里的 `swagger_api.py` 注册，依赖 **flasgger**。
- 若服务器 Python 环境里未安装 `flasgger`，`init_swagger` 会失败，`/docs` 路由不会注册，访问即 404。

### 你需要做的（在服务器上）

1. **进入项目目录并激活虚拟环境**
   ```bash
   cd /root/project_code
   source venv/bin/activate
   ```

2. **安装 flasgger**
   ```bash
   pip install flasgger
   ```

3. **重启应用**
   ```bash
   sudo systemctl restart aistudio
   ```

4. **验证**
   - 浏览器访问：`http://121.43.143.59/docs`  
   - 若仍 404，查看应用启动日志中是否有 “Swagger/OpenAPI 文档已启用” 或 “Flasgger 未安装” 等提示。

---

## 三、全量覆盖仍显示「0 个文件上传」

- 若选「2. 全量」后 WinSCP 仍显示「上传 0 个文件，跳过 N 个」：
  1. 确认提示里是「全量覆盖」而不是「增量同步」。
  2. 媒体目录已改为同步到 Nginx 路径，**请再跑一次「同步全部」并选全量**，重点看 `uploads`、`final_works`、`hd_images` 是否传到 `/root/project_data/user_images/`。
  3. 若仍异常，可查看脚本生成的 `.winscp_temp_script.log`，确认是否使用了 `-criteria=none`。

---

## 四、小结

| 问题           | 处理方式 |
|----------------|----------|
| 图片 404       | 使用当前同步脚本再执行「同步全部」或「仅同步图片」，保证媒体目录同步到 `/root/project_data/user_images/`，并确认 Nginx 指向该路径。 |
| /docs 打不开   | 在服务器项目 venv 中执行 `pip install flasgger` 并 `systemctl restart aistudio`。 |
| 全量仍 0 上传  | 确认选的是全量；媒体目录会同步到上述 Nginx 路径，再同步一次并查看日志。 |
