# åŒæ­¥åå›¾ç‰‡ 404 ä¸ /docs API æ–‡æ¡£æ‰“ä¸å¼€è¯´æ˜

## ä¸€ã€å›¾ç‰‡ 404ï¼ˆ/media/original/ ç­‰ï¼‰

### åŸå› 
- æœåŠ¡å™¨ Nginx é…ç½®ä¸­ï¼Œ`/media/original/`ã€`/media/final/`ã€`/media/hd/` æŒ‡å‘çš„æ˜¯ **`/root/project_data/user_images/`** ä¸‹çš„å­ç›®å½•ã€‚
- åŒæ­¥è„šæœ¬ä¹‹å‰æŠŠ `uploads`ã€`final_works`ã€`hd_images` ä¼ åˆ°çš„æ˜¯ **`/root/project_code/`** ä¸‹ï¼Œå’Œ Nginx ä½¿ç”¨çš„è·¯å¾„ä¸ä¸€è‡´ï¼Œæ‰€ä»¥è®¿é—® `/media/original/xxx` ä¼š 404ã€‚

### å·²åšä¿®æ”¹
- åŒæ­¥è„šæœ¬å·²æ”¹ä¸ºï¼š**åª’ä½“ç›®å½•**ï¼ˆ`uploads`ã€`final_works`ã€`hd_images`ï¼‰ç»Ÿä¸€åŒæ­¥åˆ° **`/root/project_data/user_images/`** å¯¹åº”å­ç›®å½•ï¼Œä¸ Nginx é…ç½®ä¸€è‡´ã€‚
- åŒæ­¥å‰ä¼šè‡ªåŠ¨åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ `mkdir -p`ï¼Œç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨ã€‚

### ä½ éœ€è¦åšçš„
1. **å†æ‰§è¡Œä¸€æ¬¡ã€ŒåŒæ­¥å…¨éƒ¨ã€æˆ–ã€Œä»…åŒæ­¥å›¾ç‰‡ã€**  
   å›¾ç‰‡ä¼šä¼ åˆ° Nginx å®é™…ä½¿ç”¨çš„è·¯å¾„ï¼Œå°ç¨‹åºé…ç½®é¡µã€é£æ ¼åˆ†ç±»ç­‰å›¾ç‰‡åº”èƒ½æ­£å¸¸æ˜¾ç¤ºã€‚
2. **ç¡®è®¤æœåŠ¡å™¨ Nginx é…ç½®**  
   ç¡®è®¤ç«™ç‚¹é…ç½®é‡Œç±»ä¼¼ï¼š
   - `location /media/original/ { alias /root/project_data/user_images/uploads/; }`
   - `location /media/final/ { alias /root/project_data/user_images/final_works/; }`
   - `location /media/hd/ { alias /root/project_data/user_images/hd_images/; }`  
   è‹¥ä½ æ”¹è¿‡ Nginx è·¯å¾„ï¼Œè¯·æŠŠ `scripts/deployment/sync_to_aliyun.py` é‡Œçš„ `REMOTE_MEDIA_BASE` æ”¹æˆä¸ Nginx ä¸€è‡´ã€‚

---

## äºŒã€/docs API æ–‡æ¡£æ‰“ä¸å¼€ï¼ˆ404 æˆ–è®¿é—®å‡ºé”™ï¼‰

### åŸå› 
- `/docs` ç”± Flask åº”ç”¨é‡Œçš„ `swagger_api.py` æ³¨å†Œï¼Œä¾èµ– **flasgger**ã€‚
- è‹¥æœåŠ¡å™¨ Python ç¯å¢ƒé‡Œæœªå®‰è£… `flasgger`ï¼Œ`init_swagger` ä¼šå¤±è´¥ï¼Œ`/docs` è·¯ç”±ä¸ä¼šæ³¨å†Œï¼Œè®¿é—®å³ 404ã€‚
- å®æ—¶æ—¥å¿—ï¼ˆ`journalctl -u aistudio -f`ï¼‰åªæ˜¾ç¤º**æ–°äº§ç”Ÿçš„æ—¥å¿—**ï¼Œå¯åŠ¨æ—¶çš„ â€œFlasgger æœªå®‰è£…â€ æˆ– â€œæ–‡æ¡£å·²å¯ç”¨â€ åœ¨**å¯åŠ¨é‚£ä¸€æ®µ**çš„æ—¥å¿—é‡Œï¼Œéœ€è¦çœ‹å®Œæ•´å¯åŠ¨è¾“å‡ºã€‚

### åœ¨æœåŠ¡å™¨ä¸Šæ’æŸ¥ï¼ˆSSH ç™»å½•åæ‰§è¡Œï¼‰

1. **çœ‹å¯åŠ¨æ—¶æ˜¯å¦æ³¨å†Œäº†æ–‡æ¡£ï¼ˆçœ‹å†å²æ—¥å¿—ï¼Œä¸æ˜¯ -fï¼‰**
   ```bash
   journalctl -u aistudio -n 500 --no-pager | grep -E "Swagger|Flasgger|æ–‡æ¡£"
   ```
   - è‹¥å‡ºç° **â€œFlasgger æœªå®‰è£…â€**ï¼šè¯´æ˜æœªå®‰è£… flasggerï¼ŒæŒ‰ä¸‹é¢æ­¥éª¤å®‰è£…å¹¶é‡å¯ã€‚
   - è‹¥å‡ºç° **â€œSwagger/OpenAPI æ–‡æ¡£å·²å¯ç”¨â€**ï¼šè¯´æ˜è·¯ç”±å·²æ³¨å†Œï¼Œå†æŒ‰ä¸‹é¢ç¬¬ 3 æ­¥æµ‹æœ¬æœºæ˜¯å¦å¯è®¿é—®ã€‚

2. **ç¡®è®¤æ˜¯å¦å·²å®‰è£… flasgger**
   ```bash
   cd /root/project_code
   source venv/bin/activate
   pip show flasgger
   ```
   - è‹¥æ— è¾“å‡ºï¼šæœªå®‰è£…ï¼Œæ‰§è¡Œ `pip install flasgger`ï¼Œç„¶å `sudo systemctl restart aistudio`ã€‚

3. **åœ¨æœåŠ¡å™¨æœ¬æœºæµ‹ /docs æ˜¯å¦å¯è®¿é—®**
   ```bash
   curl -s -o /dev/null -w "%{http_code}\n" http://127.0.0.1:8000/docs
   ```
   - è¾“å‡º **200**ï¼šåº”ç”¨æ­£å¸¸ï¼Œé—®é¢˜å¯èƒ½åœ¨ Nginx æˆ–å¤–ç½‘è®¿é—®ã€‚
   - è¾“å‡º **404**ï¼šåº”ç”¨å†…æœªæ³¨å†Œ /docsï¼Œå¤šåŠæ˜¯ flasgger æœªå®‰è£…æˆ– init_swagger å¤±è´¥ï¼Œå®‰è£… flasgger å¹¶é‡å¯åå†æµ‹ã€‚

4. **è®¿é—® /docs æ—¶çœ‹å®æ—¶æ—¥å¿—**
   - ç»ˆç«¯è¿è¡Œï¼š`journalctl -u aistudio -f`
   - æµè§ˆå™¨è®¿é—®ï¼š`http://121.43.143.59/docs`
   - è‹¥å‡ºç°ä¸€è¡Œ **â€œAPI æ–‡æ¡£é¡µ /docs è¢«è®¿é—®â€**ï¼šè¯´æ˜è¯·æ±‚å·²åˆ°åº”ç”¨ä¸”è·¯ç”±å­˜åœ¨ï¼›è‹¥æ²¡æœ‰ä»»ä½•æ–°è¾“å‡ºä¸”é¡µé¢ 404ï¼Œè¯´æ˜è¯·æ±‚æœªåˆ°åº”ç”¨æˆ–è·¯ç”±æœªæ³¨å†Œã€‚

### ä½ éœ€è¦åšçš„ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šï¼‰

1. **è¿›å…¥é¡¹ç›®ç›®å½•å¹¶æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ**
   ```bash
   cd /root/project_code
   source venv/bin/activate
   ```

2. **å®‰è£… flasgger**
   ```bash
   pip install flasgger
   ```

3. **é‡å¯åº”ç”¨**
   ```bash
   sudo systemctl restart aistudio
   ```

4. **éªŒè¯**
   - æµè§ˆå™¨è®¿é—®ï¼š`http://121.43.143.59/docs`  
   - è‹¥ä» 404ï¼ŒæŒ‰ä¸Šé¢ã€Œåœ¨æœåŠ¡å™¨ä¸Šæ’æŸ¥ã€ç¬¬ 1ã€3 æ­¥å†çœ‹å¯åŠ¨æ—¥å¿—å’Œ curl ç»“æœã€‚

---

## ä¸‰ã€å…¨é‡è¦†ç›–ä»æ˜¾ç¤ºã€Œ0 ä¸ªæ–‡ä»¶ä¸Šä¼ ã€

- è‹¥é€‰ã€Œ2. å…¨é‡ã€å WinSCP ä»æ˜¾ç¤ºã€Œä¸Šä¼  0 ä¸ªæ–‡ä»¶ï¼Œè·³è¿‡ N ä¸ªã€ï¼š
  1. ç¡®è®¤æç¤ºé‡Œæ˜¯ã€Œå…¨é‡è¦†ç›–ã€è€Œä¸æ˜¯ã€Œå¢é‡åŒæ­¥ã€ã€‚
  2. åª’ä½“ç›®å½•å·²æ”¹ä¸ºåŒæ­¥åˆ° Nginx è·¯å¾„ï¼Œ**è¯·å†è·‘ä¸€æ¬¡ã€ŒåŒæ­¥å…¨éƒ¨ã€å¹¶é€‰å…¨é‡**ï¼Œé‡ç‚¹çœ‹ `uploads`ã€`final_works`ã€`hd_images` æ˜¯å¦ä¼ åˆ° `/root/project_data/user_images/`ã€‚
  3. è‹¥ä»å¼‚å¸¸ï¼Œå¯æŸ¥çœ‹è„šæœ¬ç”Ÿæˆçš„ `.winscp_temp_script.log`ï¼Œç¡®è®¤æ˜¯å¦ä½¿ç”¨äº† `-criteria=none`ã€‚

---

## å››ã€ç®¡ç†åå°ç‚¹å‡»é¡µé¢æ—¶ journalctl æ²¡æœ‰æ–°æ—¥å¿—

### åŸå› 
- Gunicorn çš„ `errorlog` ä¹‹å‰æŒ‡å‘ `logs/error.log` æ–‡ä»¶ã€‚
- åº”ç”¨çš„è¯·æ±‚æ—¥å¿—ï¼ˆ`ğŸ“¥ è¯·æ±‚` / `ğŸ“¤ å“åº”`ï¼‰é€šè¿‡ worker çš„ stdout è¢« Gunicorn æ•è·åï¼Œå†™å…¥çš„æ˜¯ **error æ—¥å¿—æ–‡ä»¶**ï¼Œä¸ä¼šè¾“å‡ºåˆ° systemdï¼Œæ‰€ä»¥ `journalctl -u aistudio -f` çœ‹ä¸åˆ°ã€‚

### å·²åšä¿®æ”¹
- åœ¨ `gunicorn.conf.py` ä¸­å°† **`errorlog = "logs/error.log"`** æ”¹ä¸º **`errorlog = "-"`**ï¼ˆè¾“å‡ºåˆ° stderrï¼‰ã€‚
- è¿™æ · Gunicorn å’Œåº”ç”¨/worker çš„æ—¥å¿—ä¼šå†™åˆ° stderrï¼Œç”± systemd æ•è·ï¼Œ**`journalctl -u aistudio -f` å°±èƒ½å®æ—¶çœ‹åˆ°è¯·æ±‚æ—¥å¿—**ã€‚
- è®¿é—®æ—¥å¿—ä»å†™åœ¨ `logs/access.log`ï¼Œä¸å—å½±å“ã€‚

### ä½ éœ€è¦åšçš„
1. æŠŠæ›´æ–°åçš„ `gunicorn.conf.py` åŒæ­¥åˆ°æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ç”¨ã€Œä»…åŒæ­¥ä»£ç ã€æˆ–ã€ŒåŒæ­¥å…¨éƒ¨ã€ï¼‰ã€‚
2. åœ¨æœåŠ¡å™¨ä¸Šé‡å¯ï¼š`sudo systemctl restart aistudio`ã€‚
3. å†å¼€ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œï¼š`journalctl -u aistudio -f`ï¼Œåœ¨ç®¡ç†åå°ç‚¹å‡»é¡µé¢ï¼Œåº”èƒ½çœ‹åˆ° `ğŸ“¥ è¯·æ±‚`ã€`ğŸ“¤ å“åº”` ç­‰æ–°æ—¥å¿—ã€‚

### è‹¥æš‚ä¸æ”¹é…ç½®
- åœ¨æœåŠ¡å™¨ä¸Šå¯ç›´æ¥çœ‹åº”ç”¨/é”™è¯¯æ—¥å¿—æ–‡ä»¶ï¼š`tail -f /root/project_code/logs/error.log`ï¼Œç‚¹å‡»é¡µé¢æ—¶è¿™é‡Œä¼šæœ‰è¾“å‡ºã€‚

---

## äº”ã€å°ç»“

| é—®é¢˜           | å¤„ç†æ–¹å¼ |
|----------------|----------|
| å›¾ç‰‡ 404       | ä½¿ç”¨å½“å‰åŒæ­¥è„šæœ¬å†æ‰§è¡Œã€ŒåŒæ­¥å…¨éƒ¨ã€æˆ–ã€Œä»…åŒæ­¥å›¾ç‰‡ã€ï¼Œä¿è¯åª’ä½“ç›®å½•åŒæ­¥åˆ° `/root/project_data/user_images/`ï¼Œå¹¶ç¡®è®¤ Nginx æŒ‡å‘è¯¥è·¯å¾„ã€‚ |
| /docs æ‰“ä¸å¼€   | åœ¨æœåŠ¡å™¨é¡¹ç›® venv ä¸­æ‰§è¡Œ `pip install flasgger` å¹¶ `systemctl restart aistudio`ã€‚ |
| å…¨é‡ä» 0 ä¸Šä¼   | ç¡®è®¤é€‰çš„æ˜¯å…¨é‡ï¼›åª’ä½“ç›®å½•ä¼šåŒæ­¥åˆ°ä¸Šè¿° Nginx è·¯å¾„ï¼Œå†åŒæ­¥ä¸€æ¬¡å¹¶æŸ¥çœ‹æ—¥å¿—ã€‚ |
| journalctl æ— æ–°æ—¥å¿— | å°† `gunicorn.conf.py` ä¸­ `errorlog` æ”¹ä¸º `"-"` å¹¶åŒæ­¥ã€é‡å¯ï¼›æˆ–ç›´æ¥ `tail -f /root/project_code/logs/error.log` æŸ¥çœ‹è¯·æ±‚æ—¥å¿—ã€‚ |
| AI ä»»åŠ¡ã€Œè¾“å‡ºå›¾ç‰‡ã€404ï¼ˆ/media/final/ï¼‰ | åº”ç”¨æŠŠæ•ˆæœå›¾å†™åˆ° `/root/project_code/final_works/`ï¼ŒNginx å¿…é¡»æŒ‡å‘æ­¤å¤„ã€‚å°†ç«™ç‚¹é…ç½®é‡Œ `location /media/final/` çš„ alias æ”¹ä¸º `/root/project_code/final_works/`ï¼Œ`/media/hd/` æ”¹ä¸º `/root/project_code/hd_images/`ï¼Œç„¶å `sudo nginx -t && sudo systemctl reload nginx`ã€‚ |
| æµ‹è¯•å·¥ä½œæµ / AI ä»»åŠ¡ / ç¾é¢œä»»åŠ¡å¤±è´¥ï¼šUniqueViolation (id)=(x) å·²å­˜åœ¨ | PostgreSQL è‡ªå¢åºåˆ—æœªåŒæ­¥ï¼ˆå¸¸è§äº pg_dump æ¢å¤åï¼‰ã€‚åœ¨æœåŠ¡å™¨é¡¹ç›®ç›®å½•æ‰§è¡Œï¼š`python scripts/database/fix_postgresql_sequences.py`ï¼ˆä¼šä¿®å¤ ordersã€order_imageã€ai_tasksã€meitu_api_call_logã€selection_ordersã€style_imageã€style_categoryã€operation_logsã€couponsã€user_coupons ç­‰ï¼‰ï¼Œå†é‡è¯•ã€‚ |
| ä»»åŠ¡å®Œæˆä½†ã€Œè¾“å…¥/è¾“å‡ºå›¾ç‰‡ã€404ï¼ˆå›¾ç‰‡æ— æ³•æ˜¾ç¤ºï¼‰ | 1ï¼‰ç¡®ä¿ Nginx çš„ `/media/original/` ä¸åº”ç”¨çš„ **UPLOAD_FOLDER** æŒ‡å‘åŒä¸€ç›®å½•ï¼šåº”ç”¨é»˜è®¤å†™å…¥é¡¹ç›®ä¸‹çš„ `uploads`ï¼ˆå¦‚ `/root/project_code/uploads/`ï¼‰ï¼Œè‹¥ Nginx ä½¿ç”¨ `alias /root/project_data/user_images/uploads/`ï¼Œåˆ™éœ€åœ¨æœåŠ¡å™¨ä¸Šè®¾ç½®ç¯å¢ƒå˜é‡ `UPLOAD_FOLDER=/root/project_data/user_images/uploads` å¹¶é‡å¯åº”ç”¨ï¼Œæˆ–æŠŠ Nginx çš„ `/media/original/` æ”¹ä¸ºæŒ‡å‘ `project_code/uploads/`ã€‚2ï¼‰`/media/final/` å¿…é¡»æŒ‡å‘åº”ç”¨å†™å…¥çš„ `final_works`ï¼ˆå¦‚ `/root/project_code/final_works/`ï¼‰ï¼Œä¸ä¸Šè¡¨ã€ŒAI ä»»åŠ¡è¾“å‡ºå›¾ç‰‡ 404ã€ä¸€è‡´ã€‚3ï¼‰ä»£ç å·²å¯¹åª’ä½“ URL åšç¼–ç ã€åç«¯å¯¹ filename åšè§£ç ï¼Œé¿å…æ–‡ä»¶åå«ç©ºæ ¼ç­‰å¯¼è‡´ 404ã€‚ |
