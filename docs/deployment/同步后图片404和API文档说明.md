# 同步后图片 404 与 /docs API 文档打不开说明

## 一、图片 404（/media/original/ 等）

### 原因
- 服务器 Nginx 配置中，`/media/original/`、`/media/final/`、`/media/hd/` 指向的是 **`/root/project_data/user_images/`** 下的子目录。
- 同步脚本之前把 `uploads`、`final_works`、`hd_images` 传到的是 **`/root/project_code/`** 下，和 Nginx 使用的路径不一致，所以访问 `/media/original/xxx` 会 404。

### 已做修改
- 同步脚本已改为：**媒体目录**（`uploads`、`final_works`、`hd_images`）统一同步到 **`/root/project_data/user_images/`** 对应子目录，与 Nginx 配置一致。
- 同步前会自动在服务器上执行 `mkdir -p`，确保目标目录存在。

### 你需要做的
1. **再执行一次「同步全部」或「仅同步图片」**  
   图片会传到 Nginx 实际使用的路径，小程序配置页、风格分类等图片应能正常显示。
2. **确认服务器 Nginx 配置**  
   确认站点配置里类似：
   - `location /media/original/ { alias /root/project_data/user_images/uploads/; }`
   - `location /media/final/ { alias /root/project_data/user_images/final_works/; }`
   - `location /media/hd/ { alias /root/project_data/user_images/hd_images/; }`  
   若你改过 Nginx 路径，请把 `scripts/deployment/sync_to_aliyun.py` 里的 `REMOTE_MEDIA_BASE` 改成与 Nginx 一致。

---

## 二、/docs API 文档打不开（404 或访问出错）

### 原因
- `/docs` 由 Flask 应用里的 `swagger_api.py` 注册，依赖 **flasgger**。
- 若服务器 Python 环境里未安装 `flasgger`，`init_swagger` 会失败，`/docs` 路由不会注册，访问即 404。
- 实时日志（`journalctl -u aistudio -f`）只显示**新产生的日志**，启动时的 “Flasgger 未安装” 或 “文档已启用” 在**启动那一段**的日志里，需要看完整启动输出。

### 在服务器上排查（SSH 登录后执行）

1. **看启动时是否注册了文档（看历史日志，不是 -f）**
   ```bash
   journalctl -u aistudio -n 500 --no-pager | grep -E "Swagger|Flasgger|文档"
   ```
   - 若出现 **“Flasgger 未安装”**：说明未安装 flasgger，按下面步骤安装并重启。
   - 若出现 **“Swagger/OpenAPI 文档已启用”**：说明路由已注册，再按下面第 3 步测本机是否可访问。

2. **确认是否已安装 flasgger**
   ```bash
   cd /root/project_code
   source venv/bin/activate
   pip show flasgger
   ```
   - 若无输出：未安装，执行 `pip install flasgger`，然后 `sudo systemctl restart aistudio`。

3. **在服务器本机测 /docs 是否可访问**
   ```bash
   curl -s -o /dev/null -w "%{http_code}\n" http://127.0.0.1:8000/docs
   ```
   - 输出 **200**：应用正常，问题可能在 Nginx 或外网访问。
   - 输出 **404**：应用内未注册 /docs，多半是 flasgger 未安装或 init_swagger 失败，安装 flasgger 并重启后再测。

4. **访问 /docs 时看实时日志**
   - 终端运行：`journalctl -u aistudio -f`
   - 浏览器访问：`http://121.43.143.59/docs`
   - 若出现一行 **“API 文档页 /docs 被访问”**：说明请求已到应用且路由存在；若没有任何新输出且页面 404，说明请求未到应用或路由未注册。

### 你需要做的（在服务器上）

1. **进入项目目录并激活虚拟环境**
   ```bash
   cd /root/project_code
   source venv/bin/activate
   ```

2. **安装 flasgger**
   ```bash
   pip install flasgger
   ```

3. **重启应用**
   ```bash
   sudo systemctl restart aistudio
   ```

4. **验证**
   - 浏览器访问：`http://121.43.143.59/docs`  
   - 若仍 404，按上面「在服务器上排查」第 1、3 步再看启动日志和 curl 结果。

---

## 三、全量覆盖仍显示「0 个文件上传」

- 若选「2. 全量」后 WinSCP 仍显示「上传 0 个文件，跳过 N 个」：
  1. 确认提示里是「全量覆盖」而不是「增量同步」。
  2. 媒体目录已改为同步到 Nginx 路径，**请再跑一次「同步全部」并选全量**，重点看 `uploads`、`final_works`、`hd_images` 是否传到 `/root/project_data/user_images/`。
  3. 若仍异常，可查看脚本生成的 `.winscp_temp_script.log`，确认是否使用了 `-criteria=none`。

---

## 四、管理后台点击页面时 journalctl 没有新日志

### 原因
- Gunicorn 的 `errorlog` 之前指向 `logs/error.log` 文件。
- 应用的请求日志（`📥 请求` / `📤 响应`）通过 worker 的 stdout 被 Gunicorn 捕获后，写入的是 **error 日志文件**，不会输出到 systemd，所以 `journalctl -u aistudio -f` 看不到。

### 已做修改
- 在 `gunicorn.conf.py` 中将 **`errorlog = "logs/error.log"`** 改为 **`errorlog = "-"`**（输出到 stderr）。
- 这样 Gunicorn 和应用/worker 的日志会写到 stderr，由 systemd 捕获，**`journalctl -u aistudio -f` 就能实时看到请求日志**。
- 访问日志仍写在 `logs/access.log`，不受影响。

### 你需要做的
1. 把更新后的 `gunicorn.conf.py` 同步到服务器（例如用「仅同步代码」或「同步全部」）。
2. 在服务器上重启：`sudo systemctl restart aistudio`。
3. 再开一个终端执行：`journalctl -u aistudio -f`，在管理后台点击页面，应能看到 `📥 请求`、`📤 响应` 等新日志。

### 若暂不改配置
- 在服务器上可直接看应用/错误日志文件：`tail -f /root/project_code/logs/error.log`，点击页面时这里会有输出。

---

## 五、小结

| 问题           | 处理方式 |
|----------------|----------|
| 图片 404       | 使用当前同步脚本再执行「同步全部」或「仅同步图片」，保证媒体目录同步到 `/root/project_data/user_images/`，并确认 Nginx 指向该路径。 |
| /docs 打不开   | 在服务器项目 venv 中执行 `pip install flasgger` 并 `systemctl restart aistudio`。 |
| 全量仍 0 上传  | 确认选的是全量；媒体目录会同步到上述 Nginx 路径，再同步一次并查看日志。 |
| journalctl 无新日志 | 将 `gunicorn.conf.py` 中 `errorlog` 改为 `"-"` 并同步、重启；或直接 `tail -f /root/project_code/logs/error.log` 查看请求日志。 |
| AI 任务「输出图片」404（/media/final/） | 应用把效果图写到 `/root/project_code/final_works/`，Nginx 必须指向此处。将站点配置里 `location /media/final/` 的 alias 改为 `/root/project_code/final_works/`，`/media/hd/` 改为 `/root/project_code/hd_images/`，然后 `sudo nginx -t && sudo systemctl reload nginx`。 |
