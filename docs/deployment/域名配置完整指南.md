# 域名配置完整指南

## 概述

域名配置需要在**两个地方**修改：
1. **Nginx配置** - 处理HTTP/HTTPS请求和SSL证书
2. **系统配置（管理后台）** - 用于生成二维码、图片链接等

---

## 需要配置的地方

### 1. Nginx配置（必须修改）

**位置**：`/etc/nginx/sites-available/aistudio`

**需要修改的内容**：
- `server_name` - 域名
- `ssl_certificate` - SSL证书路径（如果使用HTTPS）
- `ssl_certificate_key` - SSL证书密钥路径

### 2. 系统配置（管理后台）（必须修改）

**位置**：管理后台 → 系统配置 → 服务器URL配置

**需要修改的内容**：
- 服务器基础URL：`https://your-domain.com`
- API基础URL：`https://your-domain.com/api`
- 媒体文件URL：`https://your-domain.com/media`
- 静态文件URL：`https://your-domain.com/static`

---

## 配置步骤

### 步骤1：配置Nginx（在服务器上执行）

```bash
# 编辑Nginx配置
nano /etc/nginx/sites-available/aistudio
```

修改以下内容：

```nginx
# HTTP服务器
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;  # ← 修改这里
    
    # 重定向到HTTPS（如果使用HTTPS）
    return 301 https://$server_name$request_uri;
}

# HTTPS服务器
server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;  # ← 修改这里
    
    # SSL证书（如果使用HTTPS）
    ssl_certificate /etc/nginx/ssl/your-domain.com.pem;  # ← 修改这里
    ssl_certificate_key /etc/nginx/ssl/your-domain.com.key;  # ← 修改这里
    
    # ... 其他配置 ...
}
```

**测试并重启**：
```bash
nginx -t
systemctl restart nginx
```

### 步骤2：配置系统URL（在管理后台）

1. 登录管理后台：`http://121.43.143.59:8000/admin/`
2. 进入：**系统配置** → **服务器URL配置**
3. 修改以下URL：
   - **服务器基础URL**：`https://your-domain.com`
   - **API基础URL**：`https://your-domain.com/api`
   - **媒体文件URL**：`https://your-domain.com/media`
   - **静态文件URL**：`https://your-domain.com/static`
4. 点击"保存服务器URL配置"

---

## 快速切换域名脚本

我为您创建了一个快速切换域名的脚本：

```bash
# 在服务器上执行
bash /root/project_code/scripts/deployment/switch_domain.sh your-domain.com
```

---

## 临时使用IP地址

如果域名还没注册，可以暂时使用IP地址：

### Nginx配置（使用IP）

```nginx
server {
    listen 80;
    server_name 121.43.143.59;  # 使用IP地址
    
    # ... 其他配置保持不变 ...
}
```

### 系统配置（使用IP）

在管理后台配置：
- **服务器基础URL**：`http://121.43.143.59:8000`
- **API基础URL**：`http://121.43.143.59:8000/api`
- **媒体文件URL**：`http://121.43.143.59:8000/media`
- **静态文件URL**：`http://121.43.143.59:8000/static`

**注意**：使用IP时，小程序可能无法正常访问（微信要求使用域名），所以建议尽快配置域名。

---

## 域名注册后的完整配置流程

### 1. 注册域名并解析

- 在域名服务商（如阿里云）注册域名
- 添加A记录：`your-domain.com` → `121.43.143.59`
- 添加A记录：`www.your-domain.com` → `121.43.143.59`

### 2. 申请SSL证书

**方式1：使用Let's Encrypt（免费）**

```bash
# 安装certbot
apt install certbot python3-certbot-nginx -y

# 申请证书
certbot --nginx -d your-domain.com -d www.your-domain.com

# 自动续期
certbot renew --dry-run
```

**方式2：使用阿里云SSL证书**

1. 在阿里云控制台申请SSL证书
2. 下载证书文件
3. 上传到服务器：`/etc/nginx/ssl/`

### 3. 修改Nginx配置

```bash
nano /etc/nginx/sites-available/aistudio
```

修改域名和证书路径，然后：
```bash
nginx -t
systemctl restart nginx
```

### 4. 修改系统配置

在管理后台修改服务器URL配置。

---

## 配置检查清单

- [ ] Nginx配置中的 `server_name` 已修改
- [ ] SSL证书已配置（如果使用HTTPS）
- [ ] 域名DNS解析已生效（ping域名能通）
- [ ] 管理后台的服务器URL配置已更新
- [ ] 测试访问：`https://your-domain.com/admin/`
- [ ] 测试API：`https://your-domain.com/api/`
- [ ] 测试图片访问：`https://your-domain.com/media/`

---

## 常见问题

### Q1: 修改域名后，旧的二维码还能用吗？

**A**: 不能。二维码中包含的是旧的URL，需要重新生成。建议：
- 在系统配置中更新URL后，通知用户重新扫码
- 或设置旧域名的重定向

### Q2: 小程序需要域名吗？

**A**: 是的，微信小程序要求使用HTTPS域名，不能使用IP地址。

### Q3: 可以先配置IP，后续再改域名吗？

**A**: 可以，但需要注意：
- 使用IP时，小程序可能无法正常使用
- 后续改域名时，需要同时修改Nginx和系统配置
- 建议尽快配置域名

---

## 快速参考

### 修改Nginx域名
```bash
nano /etc/nginx/sites-available/aistudio
# 修改 server_name
nginx -t && systemctl restart nginx
```

### 修改系统URL
管理后台 → 系统配置 → 服务器URL配置 → 保存

### 验证配置
```bash
# 测试Nginx
curl -I http://your-domain.com

# 测试应用
curl http://your-domain.com/admin/
```
