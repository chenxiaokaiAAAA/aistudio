# 微信小程序连接生产服务器排查指南

> 当小程序配置为生产环境 `https://photogooo.com` 后出现 `net::ERR_CONNECTION_CLOSED` 或 `request:fail` 时的排查步骤

---

## 一、微信小程序域名白名单（最常见原因）

**微信小程序要求所有请求的域名必须在微信公众平台后台配置，否则请求会被拦截。**

### 配置步骤

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **开发** → **开发管理** → **开发设置**
3. 找到 **服务器域名**，点击「修改」
4. 在 **request合法域名** 中添加：
   ```
   https://photogooo.com
   ```
5. 保存并等待生效（通常几分钟）

### 注意事项

- 域名必须使用 **HTTPS**
- 不能带端口号（如 `https://photogooo.com:443` 错误）
- 正式发布前必须配置，否则真机无法请求

---

## 二、微信开发者工具设置

在**开发调试阶段**，可临时绕过域名校验：

1. 微信开发者工具 → **详情** → **本地设置**
2. 勾选 **「不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书」**
3. 重新编译运行

> 此设置仅对开发者工具生效，真机预览/正式版仍需配置域名白名单。

---

## 三、服务器端检查

### 3.1 确认服务是否运行

在服务器上执行：

```bash
# 检查 aistudio 应用
sudo systemctl status aistudio

# 检查 Nginx
sudo systemctl status nginx

# 检查 8000 端口
ss -tlnp | grep 8000
```

### 3.2 测试 API 是否可访问

**Windows CMD**（整行复制执行，不要换行）：

```cmd
curl -X POST https://photogooo.com/api/user/visit -H "Content-Type: application/json" -d "{\"sessionId\":\"test123\",\"type\":\"launch\"}"
```

**PowerShell**：

```powershell
Invoke-RestMethod -Uri "https://photogooo.com/api/user/visit" -Method POST -ContentType "application/json" -Body '{"sessionId":"test123","type":"launch"}'
```

**Linux / Git Bash**：

```bash
curl -X POST https://photogooo.com/api/user/visit -H "Content-Type: application/json" -d '{"sessionId":"test123","type":"launch"}'
```

- 若返回 JSON（如 `{"success":true,...}`），说明服务正常
- 若出现 `Connection was reset` 或 `Bad hostname`，检查服务器、防火墙、SSL 证书

### 3.3 防火墙与安全组

- **阿里云 ECS**：控制台 → 安全组 → 入方向规则，确保放行 **443（HTTPS）**
- **服务器防火墙**：`sudo ufw status`，确保 443 已开放

---

## 四、小程序配置检查

### 4.1 config.js

确认 `ENV = 'production'` 且 production 配置正确：

```javascript
production: {
  baseUrl: 'https://photogooo.com',
  apiBaseUrl: 'https://photogooo.com/api/miniprogram',
  apiUrl: 'https://photogooo.com/api',
  staticUrl: 'https://photogooo.com/static',
  mediaUrl: 'https://photogooo.com/media'
}
```

### 4.2 硬编码 URL 已修复

`utils/userGenerator.js` 中原先硬编码的 `https://photogooo`（缺少 .com）已改为使用 `config.getApiUrl()`，请确保使用最新代码。

---

## 五、常见错误对照

| 错误信息 | 可能原因 | 处理方式 |
|---------|---------|---------|
| `net::ERR_CONNECTION_CLOSED` | 1. 域名未加入白名单<br>2. 服务器未启动/不可达<br>3. 防火墙拦截 | 按上述一、二、三节逐项检查 |
| `request:fail` | 同上，或网络不稳定 | 同上 |
| `url not in domain list` | 域名未配置白名单 | 在微信公众平台添加 request 合法域名 |
| 开发者工具可访问，真机不行 | 真机强制校验域名 | 配置 request 合法域名 |

---

## 六、管理后台「小程序配置」保存失败

若保存时提示 `Unexpected token '<'` 或类似错误，通常表示接口返回了 HTML 而非 JSON，可能原因：

1. **登录已过期**：退出管理后台后重新登录，再尝试保存
2. **会话失效**：刷新页面（F5）后重新登录
3. **服务器错误**：查看服务器日志 `journalctl -u aistudio -n 50` 或 gunicorn 日志，确认是否有 500 错误

---

## 七、快速检查清单

- [ ] 微信公众平台已添加 `https://photogooo.com` 到 request 合法域名
- [ ] 开发者工具已勾选「不校验合法域名」（开发阶段）
- [ ] 服务器 aistudio、Nginx 正常运行
- [ ] `curl https://photogooo.com/api/user/visit` 可正常返回
- [ ] 阿里云安全组已放行 443 端口
- [ ] config.js 中 production 的 URL 为 `https://photogooo.com`（含 .com）
