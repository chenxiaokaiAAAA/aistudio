# ä¿®å¤ç³»ç»Ÿé…ç½®ä¿å­˜åæ¢å¤é»˜è®¤é—®é¢˜

## ğŸ” é—®é¢˜åŸå› 

ä»£ç é€»è¾‘é—®é¢˜ï¼šè¯»å–é…ç½®æ—¶**ä¼˜å…ˆä½¿ç”¨ `server_config.py`**ï¼Œè€Œä¸æ˜¯æ•°æ®åº“ã€‚

å³ä½¿ä½ åœ¨ç®¡ç†åå°ä¿å­˜äº†é…ç½®åˆ°æ•°æ®åº“ï¼Œåˆ·æ–°æ—¶è¿˜æ˜¯ä¼šä» `server_config.py` è¯»å–é»˜è®¤å€¼ã€‚

---

## âœ… å·²ä¿®å¤

å·²ä¿®æ”¹ `app/routes/admin.py`ï¼Œæ”¹ä¸ºï¼š
1. **ä¼˜å…ˆä»æ•°æ®åº“è¯»å–**é…ç½®
2. å¦‚æœæ•°æ®åº“æ²¡æœ‰ï¼Œæ‰ä» `server_config.py` è¯»å–

---

## ğŸ”§ éƒ¨ç½²ä¿®å¤

### æ–¹æ³•1ï¼šä¸Šä¼ ä¿®æ”¹åçš„æ–‡ä»¶ï¼ˆæ¨èï¼‰

å°†ä¿®æ”¹åçš„ `app/routes/admin.py` ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Šå¤‡ä»½åŸæ–‡ä»¶
cp /root/project_code/app/routes/admin.py /root/project_code/app/routes/admin.py.bak

# ä¸Šä¼ ä¿®æ”¹åçš„æ–‡ä»¶ï¼ˆä½¿ç”¨ WinSCP æˆ–å…¶ä»–å·¥å…·ï¼‰
# æˆ–ç›´æ¥ç¼–è¾‘æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶
```

### æ–¹æ³•2ï¼šç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šä¿®æ”¹

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd /root/project_code

# å¤‡ä»½åŸæ–‡ä»¶
cp app/routes/admin.py app/routes/admin.py.bak

# ä¿®æ”¹ä»£ç ï¼ˆä½¿ç”¨ sed æˆ– nanoï¼‰
nano app/routes/admin.py
```

æ‰¾åˆ°ç¬¬ 240-257 è¡Œï¼Œæ›¿æ¢ä¸ºï¼š

```python
        # è·å–æœåŠ¡å™¨URLé…ç½®ï¼ˆä¼˜å…ˆä»æ•°æ®åº“è¯»å–ï¼Œå¦‚æœæ•°æ®åº“æ²¡æœ‰åˆ™ä»server_configè¯»å–ï¼‰
        # å…ˆå°è¯•ä»æ•°æ®åº“è·å–
        db_url_configs = {}
        for config in ai_configs:
            if config.config_key == 'server_base_url':
                db_url_configs['server_base_url'] = config.config_value
            elif config.config_key == 'server_api_url':
                db_url_configs['server_api_url'] = config.config_value
            elif config.config_key == 'server_media_url':
                db_url_configs['server_media_url'] = config.config_value
            elif config.config_key == 'server_static_url':
                db_url_configs['server_static_url'] = config.config_value
        
        # å¦‚æœæ•°æ®åº“æœ‰é…ç½®ï¼Œä½¿ç”¨æ•°æ®åº“çš„ï¼›å¦åˆ™ä½¿ç”¨server_configçš„
        if db_url_configs:
            configs.update(db_url_configs)
        else:
            # å¦‚æœæ•°æ®åº“æ²¡æœ‰é…ç½®ï¼Œä»server_configè¯»å–
            try:
                from server_config import get_base_url, get_api_base_url, get_media_url, get_static_url
                configs['server_base_url'] = get_base_url()
                configs['server_api_url'] = get_api_base_url()
                configs['server_media_url'] = get_media_url()
                configs['server_static_url'] = get_static_url()
            except:
                # å¦‚æœserver_configä¹Ÿä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤å€¼
                pass
```

### æ–¹æ³•3ï¼šä½¿ç”¨ Python è„šæœ¬è‡ªåŠ¨ä¿®æ”¹

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd /root/project_code

python3 << 'PYEOF'
import re

with open('app/routes/admin.py', 'r', encoding='utf-8') as f:
    content = f.read()

# æŸ¥æ‰¾å¹¶æ›¿æ¢é…ç½®è¯»å–é€»è¾‘
old_pattern = r'''        # è·å–æœåŠ¡å™¨URLé…ç½®ï¼ˆä»server_configæˆ–æ•°æ®åº“ï¼‰
        try:
            from server_config import get_base_url, get_api_base_url, get_media_url, get_static_url
            configs\['server_base_url'\] = get_base_url\(\)
            configs\['server_api_url'\] = get_api_base_url\(\)
            configs\['server_media_url'\] = get_media_url\(\)
            configs\['server_static_url'\] = get_static_url\(\)
        except:
            # å¦‚æœserver_configä¸å¯ç”¨ï¼Œä»æ•°æ®åº“è·å–
            for config in ai_configs:
                if config\.config_key == 'server_base_url':
                    configs\['server_base_url'\] = config\.config_value
                elif config\.config_key == 'server_api_url':
                    configs\['server_api_url'\] = config\.config_value
                elif config\.config_key == 'server_media_url':
                    configs\['server_media_url'\] = config\.config_value
                elif config\.config_key == 'server_static_url':
                    configs\['server_static_url'\] = config\.config_value'''

new_code = '''        # è·å–æœåŠ¡å™¨URLé…ç½®ï¼ˆä¼˜å…ˆä»æ•°æ®åº“è¯»å–ï¼Œå¦‚æœæ•°æ®åº“æ²¡æœ‰åˆ™ä»server_configè¯»å–ï¼‰
        # å…ˆå°è¯•ä»æ•°æ®åº“è·å–
        db_url_configs = {}
        for config in ai_configs:
            if config.config_key == 'server_base_url':
                db_url_configs['server_base_url'] = config.config_value
            elif config.config_key == 'server_api_url':
                db_url_configs['server_api_url'] = config.config_value
            elif config.config_key == 'server_media_url':
                db_url_configs['server_media_url'] = config.config_value
            elif config.config_key == 'server_static_url':
                db_url_configs['server_static_url'] = config.config_value
        
        # å¦‚æœæ•°æ®åº“æœ‰é…ç½®ï¼Œä½¿ç”¨æ•°æ®åº“çš„ï¼›å¦åˆ™ä½¿ç”¨server_configçš„
        if db_url_configs:
            configs.update(db_url_configs)
        else:
            # å¦‚æœæ•°æ®åº“æ²¡æœ‰é…ç½®ï¼Œä»server_configè¯»å–
            try:
                from server_config import get_base_url, get_api_base_url, get_media_url, get_static_url
                configs['server_base_url'] = get_base_url()
                configs['server_api_url'] = get_api_base_url()
                configs['server_media_url'] = get_media_url()
                configs['server_static_url'] = get_static_url()
            except:
                # å¦‚æœserver_configä¹Ÿä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤å€¼
                pass'''

content = re.sub(old_pattern, new_code, content, flags=re.MULTILINE | re.DOTALL)

with open('app/routes/admin.py', 'w', encoding='utf-8') as f:
    f.write(content)

print("âœ… ä»£ç å·²ä¿®æ”¹")
PYEOF

# é‡å¯æœåŠ¡
systemctl restart aistudio
echo "âœ… æœåŠ¡å·²é‡å¯"
```

---

## ğŸ“ éªŒè¯ä¿®å¤

ä¿®å¤åï¼š

1. **é‡å¯æœåŠ¡**ï¼š
   ```bash
   systemctl restart aistudio
   ```

2. **åœ¨ç®¡ç†åå°æµ‹è¯•**ï¼š
   - è¿›å…¥ï¼š**ç³»ç»Ÿé…ç½®** â†’ **æœåŠ¡å™¨URLé…ç½®**
   - ä¿®æ”¹URLä¸ºï¼š`http://121.43.143.59`
   - ç‚¹å‡»ä¿å­˜
   - **åˆ·æ–°é¡µé¢**ï¼ˆF5ï¼‰
   - æ£€æŸ¥æ˜¯å¦ä¿æŒä½ è®¾ç½®çš„å€¼

3. **æ£€æŸ¥æ•°æ®åº“**ï¼ˆå¯é€‰ï¼‰ï¼š
   ```bash
   cd /root/project_code
   source venv/bin/activate
   python3 << 'PYEOF'
   from test_server import app, db
   from app.models import AIConfig
   with app.app_context():
       configs = AIConfig.query.filter(AIConfig.config_key.like('server_%')).all()
       for c in configs:
           print(f"{c.config_key}: {c.config_value}")
   PYEOF
   ```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

ä¿®å¤åï¼Œç³»ç»Ÿé…ç½®çš„ä¼˜å…ˆçº§ï¼š
1. **æ•°æ®åº“é…ç½®**ï¼ˆç®¡ç†åå°ä¿å­˜çš„ï¼‰â† ä¼˜å…ˆ
2. **server_config.py**ï¼ˆæ–‡ä»¶é…ç½®ï¼‰â† å¤‡ç”¨

è¿™æ ·ä½ åœ¨ç®¡ç†åå°ä¿®æ”¹çš„é…ç½®ä¼šç”Ÿæ•ˆï¼Œä¸ä¼šè¢« `server_config.py` è¦†ç›–ã€‚
