# 管理后台添加自定义字段按钮修复说明

## 问题描述

在管理后台编辑产品页面，点击"+ 添加字段"按钮没有任何反应。

## 问题原因

1. 模态框中的按钮事件监听器在表单克隆后没有正确绑定
2. 函数作用域问题，模态框中的按钮无法访问到函数

## 修复内容

### 1. 将函数提升到全局作用域

**修改：** `AI-studio/templates/admin/sizes.html`

- 将 `addCustomField`、`removeCustomField`、`toggleFieldOptions` 函数提升到 `window` 对象
- 确保这些函数在模态框中也能访问

### 2. 在模态框打开时重新绑定事件

**修改位置：** `openEditModal` 函数中，在表单克隆后

**添加的代码：**
```javascript
// 为模态框内的"添加自定义字段"按钮绑定事件
const addCustomFieldBtns = formClone.querySelectorAll('.add-custom-field-btn');
addCustomFieldBtns.forEach(btn => {
    btn.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        const btnProductId = btn.dataset.productId || btn.getAttribute('data-product-id');
        if (btnProductId) {
            window.addCustomField(btnProductId);
        } else {
            alert('按钮配置错误，请刷新页面重试');
        }
    };
});
```

### 3. 修复HTML中的onclick属性

**修改：** 将所有 `onclick="toggleFieldOptions(this)"` 改为 `onclick="window.toggleFieldOptions(this)"`
**修改：** 将所有 `onclick="removeCustomField(this)"` 改为 `onclick="window.removeCustomField(this)"`

### 4. 增强错误处理和日志

- 添加了 `console.log` 用于调试
- 添加了容器查找的错误处理
- 优先在模态框中查找容器，如果没找到再在主页面查找

## 测试步骤

1. **刷新管理后台页面**
   - 访问 `/admin/sizes`
   - 按 `F5` 刷新页面（清除缓存）

2. **测试添加产品时的自定义字段**
   - 点击"添加产品"
   - 在"自定义字段"区域，点击"+ 添加字段"
   - 应该能正常添加字段

3. **测试编辑产品时的自定义字段**
   - 点击某个产品卡片，打开编辑模态框
   - 在"自定义字段"区域，点击"+ 添加字段"
   - 应该能正常添加字段

4. **测试字段类型切换**
   - 添加一个自定义字段
   - 将字段类型改为"下拉选择"
   - 应该显示"字段选项"输入框

5. **测试删除字段**
   - 添加一个自定义字段
   - 点击"删除"按钮
   - 应该能正常删除字段

## 如果仍然没有反应

1. **检查浏览器控制台**
   - 按 `F12` 打开开发者工具
   - 查看 Console 标签页
   - 查看是否有错误信息

2. **清除浏览器缓存**
   - 按 `Ctrl+Shift+Delete` 清除缓存
   - 或者按 `Ctrl+F5` 强制刷新

3. **检查按钮的data-product-id属性**
   - 在浏览器中右键点击"+ 添加字段"按钮
   - 选择"检查元素"
   - 查看按钮是否有 `data-product-id` 属性

## 配置颜色字段的步骤

1. 点击"+ 添加字段"按钮
2. 填写字段信息：
   - **字段名称**：`背景色` 或 `颜色`
   - **字段类型**：选择 `下拉选择`
   - **字段选项**：`红底,蓝底,白底`（用逗号分隔，不要有空格）
   - **是否必填**：勾选 `是`
3. 点击"保存"按钮

保存后，小程序端就会显示两排选择：第一排选择尺寸，第二排选择颜色。
