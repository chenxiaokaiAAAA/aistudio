# èŒå® ç»˜ç³»ç»Ÿ - åŠŸèƒ½è¯´æ˜æ–‡æ¡£

> **å¤‡ä»½æ—¶é—´**: 2025-09-19 18:37:52  
> **ç³»ç»Ÿç‰ˆæœ¬**: v2.0 (åŒ…å«æ¨å¹¿ç å’Œåˆ†ä½£åŠŸèƒ½)  
> **åˆ†ä½£æ¯”ä¾‹**: 20%

## ğŸ“ é¡¹ç›®ç»“æ„

```
pet-painting-system/
â”œâ”€â”€ test_server.py              # ä¸»åº”ç”¨æ–‡ä»¶ (Flaskåº”ç”¨)
â”œâ”€â”€ start.py                    # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ instance/
â”‚   â””â”€â”€ pet_painting.db         # SQLiteæ•°æ®åº“
â”œâ”€â”€ templates/                  # HTMLæ¨¡æ¿
â”‚   â”œâ”€â”€ admin/                  # åå°ç®¡ç†æ¨¡æ¿
â”‚   â””â”€â”€ ...
â”œâ”€â”€ static/                     # é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ qrcodes/               # å°ç¨‹åºç å­˜å‚¨
â”‚   â””â”€â”€ ...
â”œâ”€â”€ uploads/                   # åŸå§‹å›¾ç‰‡ä¸Šä¼ ç›®å½•
â”œâ”€â”€ final_works/              # æœ€ç»ˆä½œå“å­˜å‚¨ç›®å½•
â””â”€â”€ backup_20250919_183752/   # å¤‡ä»½ç›®å½•
```

## ğŸ—„ï¸ æ•°æ®åº“è¡¨ç»“æ„

### æ ¸å¿ƒè¡¨
- **`order`** - è®¢å•è¡¨
  - `id`, `order_number`, `customer_name`, `customer_phone`
  - `size`, `style_name`, `product_name`
  - `original_image`, `final_image`, `hd_image`
  - `status`, `shipping_info`, `merchant_id`
  - `created_at`, `completed_at`, `commission`, `price`
  - `external_platform`, `external_order_number`, `source_type`
  - `printer_send_status`, `printer_send_time`
  - `promotion_code`, `referrer_user_id` (æ–°å¢æ¨å¹¿å­—æ®µ)

- **`order_image`** - è®¢å•å›¾ç‰‡è¡¨
  - `id`, `order_id`, `path`, `created_at`

- **`user`** - ç”¨æˆ·è¡¨ (ç®¡ç†å‘˜/å•†å®¶)
  - `id`, `username`, `password`, `role`
  - `commission_rate` (é»˜è®¤20%), `qr_code`, `contact_person`

### æ¨å¹¿ç›¸å…³è¡¨
- **`promotion_users`** - æ¨å¹¿ç”¨æˆ·è¡¨
  - `id`, `user_id`, `promotion_code`, `open_id`
  - `nickname`, `avatar_url`, `total_earnings`, `total_orders`

- **`commissions`** - åˆ†ä½£è®°å½•è¡¨
  - `id`, `order_id`, `referrer_user_id`
  - `amount`, `rate`, `status`, `create_time`, `complete_time`

- **`promotion_tracks`** - æ¨å¹¿è®¿é—®è¿½è¸ªè¡¨
  - `id`, `promotion_code`, `referrer_user_id`
  - `visitor_user_id`, `visit_time`, `create_time`

## ğŸŒ APIæ¥å£è¯´æ˜

### å°ç¨‹åºAPI (æ— éœ€ç™»å½•)
- **`POST /api/miniprogram/orders`** - æäº¤è®¢å•
  - æ”¯æŒæ¨å¹¿ç å’Œåˆ†ä½£è®¡ç®— (20%)
- **`GET /api/miniprogram/orders`** - è·å–è®¢å•åˆ—è¡¨
- **`POST /api/miniprogram/upload`** - ä¸Šä¼ å›¾ç‰‡
- **`GET /api/miniprogram/works`** - è·å–ä½œå“åˆ—è¡¨

### æ¨å¹¿ç API (æ— éœ€ç™»å½•)
- **`POST /api/user/register`** - ç”¨æˆ·æ³¨å†Œ
- **`GET /api/user/commission`** - è·å–ç”¨æˆ·åˆ†ä½£æ•°æ®
- **`POST /api/promotion/track`** - æ¨å¹¿è®¿é—®è¿½è¸ª
- **`POST /api/promotion/validate`** - éªŒè¯æ¨å¹¿ç 
- **`GET /api/promotion/stats`** - è·å–æ¨å¹¿ç»Ÿè®¡
- **`POST /api/test/commission`** - æµ‹è¯•åˆ†ä½£åŠŸèƒ½
- **`POST /api/qrcode/generate`** - ç”Ÿæˆå°ç¨‹åºç 

### åå°ç®¡ç†API (éœ€è¦ç™»å½•)
- **`GET /api/admin/promotion/commissions`** - è·å–åˆ†ä½£è®°å½•
- **`GET /api/admin/promotion/users`** - è·å–æ¨å¹¿ç”¨æˆ·
- **`GET /api/admin/promotion/commission/<id>`** - è·å–åˆ†ä½£è¯¦æƒ…
- **`PUT /api/admin/promotion/commission/<id>/status`** - æ›´æ–°åˆ†ä½£çŠ¶æ€

## ğŸ–¥ï¸ åå°ç®¡ç†é¡µé¢

### ä¸»è¦é¡µé¢
- **`/admin/dashboard`** - è®¢å•ç®¡ç†ä¸»é¡µ
- **`/admin/promotion`** - å°ç¨‹åºåˆ†ä½£ç®¡ç†
- **`/admin/merchants`** - å•†å®¶ç®¡ç†
- **`/admin/styles`** - é£æ ¼ç®¡ç†
- **`/admin/sizes`** - äº§å“é…ç½®

### æ¸…ç†åŠŸèƒ½
- **`/admin/cleanup`** - æ¸…ç†è¿‡æœŸå›¾ç‰‡
  - æ¸…ç†æ¡ä»¶: åˆ›å»ºæ—¶é—´è¶…è¿‡7å¤©çš„å›¾ç‰‡
  - æ¸…ç†èŒƒå›´: `uploads/` å’Œ `final_works/` ç›®å½•

## ğŸ”§ å…³é”®åŠŸèƒ½è¯´æ˜

### 1. è®¢å•çŠ¶æ€æµè½¬
```
pending â†’ processing â†’ manufacturing â†’ shipped â†’ completed
         â†“
       hd_ready (é«˜æ¸…å›¾ç‰‡ä¸Šä¼ å)
```

### 2. åˆ†ä½£è®¡ç®—é€»è¾‘
- **åˆ†ä½£æ¯”ä¾‹**: 20%
- **è§¦å‘æ¡ä»¶**: è®¢å•åŒ…å«æœ‰æ•ˆæ¨å¹¿ç 
- **è®¡ç®—æ–¹å¼**: `è®¢å•é‡‘é¢ Ã— 0.2`
- **çŠ¶æ€ç®¡ç†**: pending â†’ completed

### 3. å›¾ç‰‡å¤„ç†æµç¨‹
1. ç”¨æˆ·ä¸Šä¼  â†’ `uploads/` (åŸå§‹å›¾ç‰‡)
2. AIå¤„ç† â†’ `final_works/` (æœ€ç»ˆä½œå“)
3. é«˜æ¸…ä¸Šä¼  â†’ æ›´æ–°è®¢å•çŠ¶æ€ä¸º `hd_ready`

### 4. äº§å“IDæ˜ å°„
- å°ç¨‹åºäº§å“åç§° â†’ åç«¯äº§å“ID
- æ”¯æŒæ™ºèƒ½åŒ¹é…å’Œåå‘æŸ¥æ‰¾
- é…ç½®æ–‡ä»¶: `printer_config.py`

## ğŸš€ å¯åŠ¨å’Œéƒ¨ç½²

### æœ¬åœ°å¯åŠ¨
```bash
python start.py
```

### ç”Ÿäº§éƒ¨ç½²
- ä½¿ç”¨ Nginx åå‘ä»£ç†
- é…ç½®æ–‡ä»¶: `nginx.conf`
- é™æ€æ–‡ä»¶æœåŠ¡: `/media/original/`, `/media/final/`

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. æ–‡ä»¶è·¯å¾„
- **ä¸»åº”ç”¨**: `test_server.py` (ä¸æ˜¯ `app.py`)
- **å¯åŠ¨è„šæœ¬**: `start.py`
- **æ•°æ®åº“**: `instance/pet_painting.db`

### 2. æ¨å¹¿ç åŠŸèƒ½
- åˆ†ä½£æ¯”ä¾‹å·²æ›´æ–°ä¸º20%
- æ”¯æŒå°ç¨‹åºç ç”Ÿæˆ
- åå°å¯æŸ¥çœ‹åˆ†ä½£è®°å½•

### 3. å›¾ç‰‡æ¸…ç†
- è‡ªåŠ¨æ¸…ç†7å¤©å‰çš„å›¾ç‰‡
- æ‰‹åŠ¨æ¸…ç†æŒ‰é’®åœ¨åå°ç®¡ç†
- æ¸…ç†èŒƒå›´: uploads/ å’Œ final_works/

### 4. æ•°æ®åº“å¤‡ä»½
- å®šæœŸå¤‡ä»½ `instance/pet_painting.db`
- å¤‡ä»½ç›®å½•: `backup_YYYYMMDD_HHMMSS/`

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜
1. **å›¾ç‰‡æ— æ³•è®¿é—®**: æ£€æŸ¥ Nginx é…ç½®å’Œæ–‡ä»¶æƒé™
2. **åˆ†ä½£è®¡ç®—é”™è¯¯**: ç¡®è®¤åˆ†ä½£æ¯”ä¾‹ä¸º20%
3. **è®¢å•çŠ¶æ€å¼‚å¸¸**: æ£€æŸ¥çŠ¶æ€æµè½¬é€»è¾‘
4. **æ¨å¹¿ç æ— æ•ˆ**: éªŒè¯æ¨å¹¿ç ç”Ÿæˆå’ŒéªŒè¯é€»è¾‘

### æ—¥å¿—ä½ç½®
- Flaskåº”ç”¨æ—¥å¿—: æ§åˆ¶å°è¾“å‡º
- é”™è¯¯ä¿¡æ¯: æŸ¥çœ‹ `test_server.py` ä¸­çš„ print è¯­å¥

## ğŸ“ è”ç³»ä¿¡æ¯
- **ç³»ç»Ÿç®¡ç†å‘˜**: éœ€è¦ç™»å½•åå°ç®¡ç†
- **æŠ€æœ¯æ”¯æŒ**: æŸ¥çœ‹ä»£ç æ³¨é‡Šå’Œæ­¤æ–‡æ¡£
- **æ›´æ–°è®°å½•**: è®°å½•åœ¨æ­¤æ–‡æ¡£çš„ç‰ˆæœ¬ä¿¡æ¯ä¸­

---
**æœ€åæ›´æ–°**: 2025-09-19 18:37:52  
**æ›´æ–°å†…å®¹**: æ¸…ç†å†å²è®¢å•ï¼Œæ›´æ–°åˆ†ä½£æ¯”ä¾‹ä¸º20%ï¼Œæ·»åŠ æ¨å¹¿ç åŠŸèƒ½
