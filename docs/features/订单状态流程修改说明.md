# 订单状态流程修改说明

## 📋 修改概述

调整了订单状态流程，使其更符合实际业务流程：

### 修改前：
- 自拍机上传照片后 → 订单状态变为 `completed`（已完成）

### 修改后：
- 自拍机上传照片后 → 订单状态变为 `manufacturing`（制作中）
- 后台上传效果图后 → 订单状态自动变为 `completed`（已完成）

## ✅ 修改内容

### 1. 自拍机上传照片接口 (`/api/miniprogram/order/upload`)

**文件：** `AI-studio/test_server.py` (第 6911-6916 行)

**修改前：**
```python
# 更新订单状态为已完成（证件照拍摄完成）
if order.status in ['pending', 'unpaid', 'paid', 'manufacturing']:
    order.status = 'completed'
    order.completed_at = datetime.now()
    print(f"✅ 订单 {order.order_number} 状态已更新为已完成（拍摄完成）")
```

**修改后：**
```python
# 更新订单状态为制作中（证件照拍摄完成，等待后台制作效果图）
if order.status in ['pending', 'unpaid', 'paid']:
    order.status = 'manufacturing'
    print(f"✅ 订单 {order.order_number} 状态已更新为制作中（拍摄完成，等待制作效果图）")
# 如果已经是制作中状态，保持不变
```

### 2. 后台上传效果图接口 (`/admin/order/<order_id>`)

**文件：** `AI-studio/test_server.py` (第 3630-3636 行)

**修改前：**
```python
order.hd_image = filename
print(f"订单hd_image字段更新为: {filename}")

# 如果订单状态为"待发货"，自动切换为"高清放大"
if order.status == 'shipped':
    order.status = 'hd_ready'
    print(f"订单状态自动切换为: hd_ready")
```

**修改后：**
```python
order.hd_image = filename
print(f"订单hd_image字段更新为: {filename}")

# ⭐ 如果订单状态为"制作中"，上传效果图后自动切换为"已完成"
if order.status == 'manufacturing':
    order.status = 'completed'
    order.completed_at = datetime.now()
    print(f"✅ 订单 {order.order_number} 状态已更新为已完成（效果图制作完成）")
# 如果订单状态为"待发货"，自动切换为"高清放大"（兼容旧流程）
elif order.status == 'shipped':
    order.status = 'hd_ready'
    print(f"订单状态自动切换为: hd_ready")
```

### 3. 状态映射文本更新

**文件：** `AI-studio/test_server.py` (多处)

将所有状态映射中的 `'manufacturing': '厂家制作中'` 更新为 `'manufacturing': '制作中'`

**更新位置：**
- 第 6077 行：小程序订单列表接口
- 第 6165 行：小程序订单详情接口
- 第 6294 行：小程序更新订单状态接口

**完整状态映射：**
```python
status_map = {
    'unpaid': '待支付',
    'pending': '待制作',
    'paid': '已支付',
    'manufacturing': '制作中',  # 自拍机拍摄完成，等待后台制作效果图
    'completed': '已完成',  # 效果图制作完成
    'shipped': '已发货',
    'hd_ready': '高清放大',
    'processing': '处理中'
}
```

## 🔄 新的订单状态流程

### 完整流程：

1. **用户下单** → `unpaid`（待支付）
2. **用户支付** → `paid`（已支付）
3. **自拍机上传照片** → `manufacturing`（制作中）⭐ **新增**
4. **后台上传效果图** → `completed`（已完成）⭐ **自动更新**

### 状态说明：

- **`unpaid`（待支付）**：用户已下单但未支付
- **`paid`（已支付）**：用户已支付，等待拍摄
- **`manufacturing`（制作中）**：自拍机已拍摄完成，等待后台制作效果图
- **`completed`（已完成）**：效果图已制作完成，订单完成

## 📱 小程序显示效果

### 订单列表：
- 已支付：显示"已支付"
- 制作中：显示"制作中"（自拍机拍摄完成，等待制作效果图）
- 已完成：显示"已完成"（效果图制作完成）

### 订单详情：
- 制作中状态：显示"制作中"，提示"照片处理中，请稍候..."
- 已完成状态：显示"已完成"，显示效果图

## ⚠️ 注意事项

1. **向后兼容**：
   - 如果订单已经是 `manufacturing` 状态，上传照片时不会重复更新
   - 如果订单状态是 `shipped`，上传效果图时仍会切换为 `hd_ready`（兼容旧流程）

2. **状态自动更新**：
   - 上传效果图后，如果订单状态是 `manufacturing`，会自动更新为 `completed`
   - 同时会设置 `completed_at` 时间戳

3. **手动状态修改**：
   - 管理员仍可以在后台手动修改订单状态
   - 但如果上传了效果图，状态会自动更新为 `completed`

## ✅ 测试建议

1. **测试自拍机上传照片**：
   - 创建订单并支付
   - 使用自拍机上传照片
   - 检查订单状态是否为 `manufacturing`（制作中）

2. **测试后台上传效果图**：
   - 在管理后台打开订单详情
   - 上传效果图（hd_image）
   - 检查订单状态是否自动更新为 `completed`（已完成）

3. **测试小程序显示**：
   - 在小程序"我的订单"查看订单列表
   - 检查状态显示是否正确
   - 在订单详情查看状态和效果图

## 📝 相关文件

- `AI-studio/test_server.py` - 后端主文件
  - 第 6911-6916 行：自拍机上传照片状态更新
  - 第 3630-3636 行：后台上传效果图状态更新
  - 第 6077、6165、6294 行：状态映射文本
