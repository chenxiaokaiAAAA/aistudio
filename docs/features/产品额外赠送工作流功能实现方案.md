# 产品额外赠送工作流功能实现方案

## 📋 需求说明

用户希望在产品（如证件照）中，除了常规的主工作流（1+1：产品+工作流）外，还能额外赠送2个工作流任务。例如：
- 证件照产品：常规是"证件照+衬衫风格"
- 额外赠送：2个AI写真主题（API模板）

## 🎯 实现方案

### 1. 数据模型设计

创建了 `ProductBonusWorkflow` 模型，用于存储产品的额外赠送工作流配置：

```python
class ProductBonusWorkflow(db.Model):
    """产品额外赠送工作流配置表"""
    - product_id: 关联的产品ID
    - workflow_type: 工作流类型（'api_template' 或 'style_image'）
    - api_template_id: API模板ID（当workflow_type='api_template'时使用）
    - style_image_id: 风格图片ID（当workflow_type='style_image'时使用）
    - workflow_name: 赠送工作流名称（用于显示）
    - workflow_description: 描述
    - is_active: 是否启用
    - sort_order: 排序
```

### 2. 业务流程

1. **配置阶段**（管理后台）：
   - 在产品编辑页面配置赠送工作流
   - 选择工作流类型（API模板或风格图片）
   - 关联具体的API模板或风格图片

2. **订单创建阶段**：
   - 用户选择产品 → 选择尺寸规格 → 选择风格 → 提交订单
   - 系统创建主工作流任务（常规流程）

3. **赠送工作流创建阶段**（自动）：
   - 在主工作流任务创建成功后
   - 系统自动查找产品配置的赠送工作流
   - 为每个赠送工作流创建对应的任务

### 3. 核心代码实现

#### 3.1 数据模型
- **文件**: `app/models.py`
- **模型**: `ProductBonusWorkflow`

#### 3.2 服务函数
- **文件**: `app/services/bonus_workflow_service.py`
- **函数**: `create_bonus_workflows_for_order()`
  - 根据订单查找产品
  - 查找产品配置的赠送工作流
  - 为每个赠送工作流创建任务（API任务或ComfyUI任务）

#### 3.3 集成点
- **文件**: `app/services/image_processing_service.py`
- **位置**: `process_order_images()` 函数
- **逻辑**: 在主工作流任务创建成功后，自动调用 `create_bonus_workflows_for_order()`

### 4. 数据库迁移

- **文件**: `scripts/database/add_product_bonus_workflow_table.py`
- **功能**: 创建 `product_bonus_workflows` 表

## 📝 使用说明

### 配置步骤（管理后台）

1. **进入产品编辑页面**
   - 访问：`/admin/sizes`
   - 找到要配置的产品，点击编辑

2. **配置赠送工作流**（待实现管理界面）
   - 在"赠送工作流"区域，点击"+ 添加赠送工作流"
   - 选择工作流类型：
     - **API模板**：选择已配置的API模板
     - **风格图片**：选择风格图片（使用ComfyUI工作流）
   - 填写工作流名称和描述
   - 设置排序和启用状态

3. **保存配置**
   - 点击"保存"按钮

### 工作流程

1. **用户下单**：
   - 选择证件照产品
   - 选择尺寸规格（如"1寸"）
   - 选择颜色（如"红底"）
   - 选择风格（如"衬衫风格"）
   - 提交订单

2. **系统处理**：
   - 创建主工作流任务（证件照+衬衫风格）
   - 自动查找产品配置的赠送工作流
   - 创建2个赠送的AI写真任务

3. **结果**：
   - 订单包含1个主工作流任务 + 2个赠送工作流任务
   - 用户可以在选片页面看到所有任务的结果

## 🔧 技术细节

### API模板类型

当 `workflow_type='api_template'` 时：
- 使用 `create_api_task()` 创建API任务
- 从API模板配置中获取：
  - 提示词（`default_prompt` 或 `prompts_json` 的第一个）
  - 图片尺寸（`default_size`）
  - 图片比例（`default_aspect_ratio`）
  - 上传配置（`upload_config`）
- 使用订单的原图作为参考图

### 风格图片类型

当 `workflow_type='style_image'` 时：
- 使用 `create_ai_task()` 创建ComfyUI工作流任务
- 从风格图片配置中获取工作流参数
- 使用订单的原图作为输入图片

### 错误处理

- 如果产品没有配置赠送工作流，不影响主流程
- 如果某个赠送工作流创建失败，记录错误但继续处理其他工作流
- 所有错误都会记录日志，便于排查

## 📊 数据库表结构

```sql
CREATE TABLE product_bonus_workflows (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    product_id INTEGER NOT NULL,
    workflow_type VARCHAR(20) NOT NULL DEFAULT 'api_template',
    api_template_id INTEGER,
    style_image_id INTEGER,
    workflow_name VARCHAR(200),
    workflow_description TEXT,
    is_active BOOLEAN DEFAULT 1,
    sort_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (product_id) REFERENCES products(id),
    FOREIGN KEY (api_template_id) REFERENCES api_templates(id),
    FOREIGN KEY (style_image_id) REFERENCES style_image(id)
);
```

## ⚠️ 注意事项

1. **产品代码识别**：
   - 系统通过订单的 `product_type` 或 `product_name` 来识别产品
   - 确保订单中正确保存了产品代码

2. **工作流类型**：
   - API模板类型：需要先配置好API模板
   - 风格图片类型：需要先配置好风格图片的工作流参数

3. **任务关联**：
   - API任务会关联到订单（如果AITask支持order_id字段）
   - ComfyUI任务会自动关联到订单

4. **性能考虑**：
   - 赠送工作流的创建是异步的，不会阻塞主流程
   - 如果创建失败，会在日志中记录，但不影响订单状态

## 🚀 后续优化

1. **管理界面**：
   - 在产品编辑页面添加赠送工作流配置界面
   - 支持添加、编辑、删除赠送工作流
   - 支持拖拽排序

2. **统计功能**：
   - 统计每个赠送工作流的使用次数
   - 统计赠送工作流的成功率

3. **条件配置**：
   - 支持按订单金额、用户等级等条件配置赠送工作流
   - 支持按时间段配置（如活动期间）

## 📝 待完成事项

- [x] 创建ProductBonusWorkflow模型
- [x] 创建bonus_workflow_service服务函数
- [x] 集成到订单处理流程
- [x] 创建数据库迁移脚本
- [ ] 在管理后台添加配置界面
- [ ] 测试完整流程
