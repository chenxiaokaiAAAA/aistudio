# 小程序分佣管理功能增强说明

## 修改概述

根据用户需求，在小程序分佣管理页面添加了两个重要功能：
1. **用户自己的订单数据显示** - 显示用户自己下单的订单数量
2. **按访问数排序功能** - 可以按访问数对用户进行排序，方便查看访问最频繁的用户

## 修改的文件

### 1. 后端API修改 (`test_server.py`)

#### 修改了 `/api/admin/promotion/users` 接口
- **新增排序参数支持**：
  - `sortBy`: 排序字段（visits, create_time, update_time, total_earnings, total_orders）
  - `sortOrder`: 排序方向（asc, desc）
- **新增用户自己订单数统计**：
  - 通过查询 `orders` 表中 `customer_phone` 字段匹配用户手机号
  - 在返回数据中添加 `own_orders` 字段

#### 新增 `/api/admin/promotion/user/own-orders` 接口
- **功能**：获取指定用户自己下单的详细订单信息
- **参数**：`userId` 或 `promotionCode`
- **返回**：用户信息和订单列表

### 2. 前端界面修改 (`templates/admin/promotion_management.html`)

#### 用户管理表格增强
- **新增"自己订单数"列**：显示用户自己下单的订单数量
- **新增排序下拉菜单**：
  - 访问数（高到低/低到高）
  - 注册时间（新到旧/旧到新）
  - 总收益（高到低/低到高）

#### 新增功能按钮
- **"自己订单"按钮**：点击可查看用户自己下单的详细订单列表
- **排序功能**：通过下拉菜单选择不同的排序方式

#### 新增模态框
- **用户自己订单详情模态框**：
  - 显示用户基本信息
  - 显示用户所有自己下单的订单
  - 包含订单号、客户信息、尺寸、风格、状态等详细信息

## 功能特点

### 1. 用户自己订单统计
- 通过手机号匹配用户自己的订单
- 在用户列表中直接显示自己订单数量
- 点击"自己订单"按钮可查看详细订单信息

### 2. 访问数排序功能
- 支持按访问数从高到低或从低到高排序
- 方便管理员快速识别访问最频繁的用户
- 同时支持其他字段的排序（注册时间、总收益等）

### 3. 用户体验优化
- 排序操作简单直观，通过下拉菜单选择
- 订单详情以模态框形式展示，不影响主界面
- 表格布局清晰，信息展示完整

## 技术实现

### 后端技术
- 使用 SQLAlchemy 进行数据库查询
- 支持动态排序和条件查询
- 通过手机号关联用户和订单数据

### 前端技术
- 使用 Bootstrap 5 组件和样式
- JavaScript 动态加载和渲染数据
- 模态框展示详细信息

## 使用方法

### 查看用户自己订单
1. 进入"小程序分佣管理"页面
2. 点击"推广用户总数"卡片进入用户管理
3. 在用户列表中可以看到"自己订单数"列
4. 点击用户行的"自己订单"按钮查看详细订单信息

### 按访问数排序
1. 在用户管理页面点击"排序"下拉菜单
2. 选择"访问数（高到低）"或"访问数（低到高）"
3. 系统会自动重新加载数据并按访问数排序

## 注意事项

1. **数据准确性**：用户自己订单的统计基于手机号匹配，确保用户手机号信息准确
2. **性能考虑**：排序功能会重新查询数据库，大量用户时可能需要等待
3. **权限控制**：所有功能都需要管理员登录权限

## 后续扩展建议

1. 可以添加更多排序字段（如最后访问时间、订单金额等）
2. 可以添加筛选功能（如按时间范围、订单状态等）
3. 可以添加导出功能，将用户数据导出为Excel文件
4. 可以添加图表展示，更直观地显示用户访问趋势

---

**修改完成时间**：2024年12月19日  
**修改人员**：AI助手  
**版本**：v1.0








