# 加盟商充值赠送功能

## 📋 功能概述

为加盟商充值功能添加了**赠送金额**选项，管理员在充值时可以设置赠送金额，赠送部分不会显示给加盟商。

## ✨ 功能特点

- ✅ **充值金额**：加盟商显示的金额
- 🎁 **赠送金额**：系统内部分配，不显示给加盟商
- 💰 **实际到账**：充值金额 + 赠送金额

## 🚀 使用方法

### 1. 数据库迁移

```bash
python add_franchisee_bonus_migration.py
```

或者重启服务器，系统会自动创建新字段：
```bash
python start.py
```

### 2. 使用充值功能

1. 登录管理员后台
2. 进入 **加盟商管理** → 选择要充值的加盟商
3. 点击 **充值** 按钮
4. 填写信息：
   - **充值金额**：加盟商将看到的金额（必填）
   - **赠送金额**：额外赠送的金额（可选，默认0）
   - **充值类型**：选择充值类型
   - **说明**：填写充值说明

5. 查看预览并确认充值

### 3. 示例

**充值场景**：
- 充值金额：¥1000
- 赠送金额：¥200
- 实际到账：¥1200

**结果**：
- 加盟商看到：充值了 ¥1000
- 后台记录：（含赠送¥200）
- 实际余额增加：¥1200

## 📊 数据字段

### FranchiseeRecharge 表新增字段

- `amount`: 充值金额（加盟商看到的金额）
- `bonus_amount`: 赠送金额（内部记录）
- `total_amount`: 实际充值总额（amount + bonus_amount）

## 🔍 查看记录

### 管理员后台
- **充值记录**会显示：`+¥1000`（含赠送¥200）
- 可以看到完整的充值详情

### 加盟商后台
- **充值记录**只显示：`+¥1000`
- 赠送金额**不会显示**给加盟商

## ⚙️ 技术实现

### 数据库模型
```python
class FranchiseeRecharge(db.Model):
    amount = db.Column(db.Float, nullable=False)  # 充值金额
    bonus_amount = db.Column(db.Float, default=0.0)  # 赠送金额
    total_amount = db.Column(db.Float, nullable=False)  # 实际总额
```

### 充值逻辑
```python
total_amount = amount + bonus_amount  # 计算实际总额
account.total_quota += total_amount   # 增加额度（使用总额）
account.remaining_quota += total_amount
```

### 显示逻辑
- **管理员**：显示 `amount` + `bonus_amount`
- **加盟商**：只显示 `amount`

## 📝 注意事项

1. 赠送金额默认为 0，不填写则不赠送
2. 赠送金额会实际计入账户余额
3. 加盟商无法看到赠送记录
4. 充值记录中的 description 字段会自动记录完整信息

## 🎯 适用场景

- **促销活动**：给予加盟商充值赠送
- **额度调整**：内部调整额度
- **补偿退款**：通过赠送方式补偿

---

**更新日期**: 2025-01-XX  
**版本**: 1.0



