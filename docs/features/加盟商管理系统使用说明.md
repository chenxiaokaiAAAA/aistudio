# 加盟商管理系统使用说明

## 📋 功能概述

加盟商管理系统为AI拍照机定制系统新增了专门的加盟商渠道管理功能，支持额度预充值、自动扣费、独立管理页面等特性。

## 🏗️ 系统架构

### 数据库模型
- **FranchiseeAccount**: 加盟商账户表
- **FranchiseeRecharge**: 加盟商充值记录表
- **Order**: 订单表（新增加盟商关联字段）

### 核心功能
1. **管理员后台管理**
   - 加盟商账户创建、编辑、充值
   - 额度管理和统计
   - 订单关联和追踪

2. **加盟商独立管理页面**
   - 登录验证
   - 额度查看
   - 订单管理
   - 充值记录查看

3. **额度扣除系统**
   - 订单创建时自动检查额度
   - 实时扣除加盟商余额
   - 防止超额下单

## 🚀 使用流程

### 1. 管理员操作

#### 创建加盟商账户
1. 登录管理员后台
2. 点击"🏢 加盟商管理"
3. 点击"添加加盟商"
4. 填写基本信息：
   - 用户名（用于登录）
   - 密码
   - 公司名称
   - 联系人信息
   - 初始充值额度
5. 点击"创建账户"

#### 为加盟商充值
1. 在加盟商列表中找到目标账户
2. 点击"充值"按钮
3. 输入充值金额和说明
4. 选择充值类型（手动充值/退款/调整）
5. 确认充值

#### 生成加盟商二维码
1. 进入加盟商详情页面
2. 点击"下载二维码"按钮
3. 将二维码提供给加盟商使用

### 2. 加盟商操作

#### 登录管理页面
1. 访问 `/franchisee/login`
2. 输入用户名和密码
3. 登录后进入管理面板

#### 查看账户信息
- 剩余额度
- 使用统计
- 最近订单
- 充值记录

#### 管理订单
- 查看通过自己渠道产生的订单
- 筛选和搜索订单
- 查看订单详情

### 3. 用户下单流程

#### 通过加盟商二维码下单
1. 用户扫描加盟商二维码
2. 系统自动识别加盟商身份
3. 用户正常下单
4. 系统自动从加盟商账户扣除相应金额
5. 订单关联到对应加盟商

## 🔧 API接口

### 加盟商相关接口

#### 检查额度
```
POST /franchisee/api/check-quota
{
    "qr_code": "FRANCH_ABC123",
    "order_amount": 299.0
}
```

#### 扣除额度
```
POST /franchisee/api/deduct-quota
{
    "franchisee_id": 1,
    "order_id": "ORDER123",
    "amount": 299.0
}
```

#### 获取账户信息
```
GET /franchisee/api/account-info/FRANCH_ABC123
```

#### 验证二维码
```
POST /franchisee/api/validate-qrcode
{
    "qr_code": "FRANCH_ABC123"
}
```

### 小程序订单接口（已集成）

在小程序订单提交时，支持 `franchiseeQrCode` 参数：

```json
{
    "orderId": "ORDER123",
    "customerName": "张三",
    "customerPhone": "13800138000",
    "totalPrice": 299.0,
    "franchiseeQrCode": "FRANCH_ABC123",
    // ... 其他订单字段
}
```

## 📊 数据统计

### 管理员可查看
- 加盟商总数
- 总充值金额
- 总使用金额
- 各加盟商使用情况
- 订单关联统计

### 加盟商可查看
- 个人剩余额度
- 使用统计
- 订单列表
- 充值记录

## 🔒 安全特性

1. **权限控制**
   - 管理员权限验证
   - 加盟商登录验证
   - 会话管理

2. **额度保护**
   - 实时额度检查
   - 防止超额下单
   - 事务性操作

3. **数据完整性**
   - 外键约束
   - 数据验证
   - 错误处理

## 🎯 使用场景

### 场景1：连锁店加盟
- 连锁店申请加盟商账户
- 预充值一定额度
- 客户通过连锁店二维码下单
- 系统自动从连锁店账户扣费

### 场景2：代理商分销
- 代理商获得加盟商账户
- 代理商推广产品
- 客户通过代理商渠道下单
- 代理商获得订单管理权限

### 场景3：企业团购
- 企业申请加盟商账户
- 预充值团购额度
- 员工通过企业二维码下单
- 统一管理和结算

## 📝 注意事项

1. **额度管理**
   - 确保加盟商账户有足够余额
   - 及时处理充值请求
   - 监控异常使用情况

2. **二维码安全**
   - 定期更新二维码
   - 防止二维码泄露
   - 监控异常扫码行为

3. **数据备份**
   - 定期备份加盟商数据
   - 保护充值记录
   - 确保数据安全

## 🆘 故障排除

### 常见问题

1. **加盟商无法登录**
   - 检查账户状态是否为"正常"
   - 验证用户名密码
   - 确认账户未被禁用

2. **额度扣除失败**
   - 检查账户余额是否充足
   - 验证二维码是否正确
   - 查看系统日志

3. **订单未关联加盟商**
   - 检查订单中的 `franchisee_id` 字段
   - 验证二维码扫描是否正确
   - 确认订单创建流程

### 技术支持

如遇到技术问题，请：
1. 查看系统日志
2. 检查数据库状态
3. 联系技术支持团队

## 📈 未来扩展

1. **多级加盟商体系**
2. **自动结算功能**
3. **财务报表生成**
4. **移动端APP**
5. **API开放平台**

---

*最后更新：2025年1月*






