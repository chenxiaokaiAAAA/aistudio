# 自拍机设备管理功能完成说明

## 📋 功能概述

实现了在一个加盟商账户下管理多台自拍机设备的功能。现在一个加盟商可以添加、编辑、删除多台自拍机设备，每台设备都有独立的名称、序列号、位置等信息。

## ✅ 已完成的功能

### 1. 数据库模型

#### 新增 `SelfieMachine` 模型 (`test_server.py`)

```python
class SelfieMachine(db.Model):
    """自拍机设备表"""
    __tablename__ = 'selfie_machines'
    
    id = db.Column(db.Integer, primary_key=True)
    franchisee_id = db.Column(db.Integer, db.ForeignKey('franchisee_accounts.id'), nullable=False)
    machine_name = db.Column(db.String(100), nullable=False)  # 自拍机名称
    machine_serial_number = db.Column(db.String(100), unique=True, nullable=False)  # 自拍机序列号（唯一）
    location = db.Column(db.String(200))  # 设备位置（可选）
    status = db.Column(db.String(20), default='active')  # active, inactive, maintenance
    notes = db.Column(db.Text)  # 备注信息
    created_at = db.Column(db.DateTime, default=datetime.now)
    updated_at = db.Column(db.DateTime, default=datetime.now, onupdate=datetime.now)
    
    # 关联关系
    franchisee = db.relationship('FranchiseeAccount', backref=db.backref('selfie_machines', lazy=True, cascade='all, delete-orphan'))
```

**特点：**
- 一个加盟商可以有多台设备（一对多关系）
- 设备序列号全局唯一
- 支持设备位置、状态、备注等信息

### 2. 数据库迁移脚本

**文件：** `create_selfie_machines_table.py` 和 `create_selfie_machines_table.bat`

**功能：**
- 自动创建 `selfie_machines` 表
- 如果表已存在，会跳过创建
- 验证表结构

**使用方法：**
```bash
# Windows
create_selfie_machines_table.bat

# 或直接运行Python脚本
python create_selfie_machines_table.py
```

### 3. 后端路由 (`franchisee_routes.py`)

#### 3.1 设备列表获取
- 在 `admin_franchisee_detail` 路由中，自动获取该加盟商的所有设备列表
- 传递给模板 `machines` 变量

#### 3.2 添加设备
- **路由：** `POST /franchisee/admin/accounts/<account_id>/machines/add`
- **功能：** 为指定加盟商添加新设备
- **验证：** 检查设备名称和序列号是否为空，序列号是否已存在

#### 3.3 编辑设备
- **路由：** `POST /franchisee/admin/accounts/<account_id>/machines/<machine_id>/edit`
- **功能：** 编辑设备信息（名称、序列号、位置、状态、备注）
- **验证：** 检查序列号是否被其他设备使用

#### 3.4 删除设备
- **路由：** `POST /franchisee/admin/accounts/<account_id>/machines/<machine_id>/delete`
- **功能：** 删除设备
- **验证：** 检查是否有关联的订单，如果有则阻止删除

### 4. 订单关联逻辑更新 (`test_server.py`)

#### 4.1 核销接口 (`/api/miniprogram/order/check`)
- 修改为通过 `SelfieMachine` 表查找设备
- 通过设备找到对应的加盟商
- 更新订单的加盟商和门店信息

#### 4.2 上传接口 (`/api/miniprogram/order/upload`)
- 同样修改为通过 `SelfieMachine` 表查找设备
- 确保订单正确关联到加盟商

### 5. 前端界面 (`templates/admin/franchisee_detail.html`)

#### 5.1 设备管理标签页
- 在加盟商详情页面添加"自拍机设备"标签页
- 显示设备列表（名称、序列号、位置、状态、备注、创建时间）
- 提供"添加设备"按钮

#### 5.2 添加设备模态框
- 表单字段：
  - 设备名称（必填）
  - 设备序列号（必填，全局唯一）
  - 设备位置（可选）
  - 备注（可选）

#### 5.3 编辑设备模态框
- 表单字段：
  - 设备名称（必填）
  - 设备序列号（必填）
  - 设备位置（可选）
  - 状态（正常/停用/维护中）
  - 备注（可选）

#### 5.4 JavaScript 函数
- `editMachine()`: 打开编辑模态框并填充数据
- `confirmDeleteMachine()`: 确认删除设备

### 6. 页面简化

#### 6.1 加盟商添加页面 (`franchisee_add.html`)
- 移除了"自拍机名称"和"自拍机序列号"字段
- 只保留"门店名称"字段
- 提示用户：设备请在创建账户后在详情页面管理

#### 6.2 加盟商编辑页面 (`franchisee_edit.html`)
- 移除了"自拍机名称"和"自拍机序列号"字段
- 只保留"门店名称"字段
- 提示用户：设备请在详情页面的"自拍机设备"标签页管理

## 🔄 使用流程

### 1. 创建加盟商账户

1. 进入"加盟商管理" → "添加账户"
2. 填写基本信息（公司名称、联系人等）
3. **只填写门店名称**（必填）
4. 保存

### 2. 添加自拍机设备

1. 进入加盟商详情页面
2. 点击"自拍机设备"标签页
3. 点击"添加设备"按钮
4. 填写设备信息：
   - 设备名称：如 `SM商城-1号机`
   - 设备序列号：如 `XMSM_001`（必须与安卓APP配置一致）
   - 设备位置：如 `1楼大厅`（可选）
   - 备注：（可选）
5. 保存

### 3. 管理多台设备

- 可以为同一个加盟商添加多台设备
- 每台设备有独立的名称和序列号
- 可以单独编辑或删除每台设备
- 删除设备前会检查是否有关联订单

### 4. 订单自动关联

当用户通过小程序下单，到自拍机核销时：

1. 安卓APP传递自拍机序列号（如：`XMSM_001`）
2. 后端通过 `SelfieMachine` 表查找设备
3. 通过设备找到对应的加盟商
4. 自动更新订单的 `franchisee_id`、`store_name`、`selfie_machine_id` 等字段

## 📊 数据关系

```
FranchiseeAccount (加盟商账户)
    ├── store_name (门店名称)
    └── selfie_machines (一对多关系)
        ├── SelfieMachine 1
        │   ├── machine_name (设备名称)
        │   ├── machine_serial_number (序列号)
        │   ├── location (位置)
        │   └── status (状态)
        ├── SelfieMachine 2
        └── SelfieMachine 3

Order (订单)
    ├── franchisee_id (关联到 FranchiseeAccount)
    ├── store_name (门店名称，来自 FranchiseeAccount)
    └── selfie_machine_id (自拍机序列号，来自 SelfieMachine)
```

## ⚠️ 注意事项

1. **数据库迁移**：
   - 首次使用前，需要运行 `create_selfie_machines_table.bat` 创建设备表

2. **序列号唯一性**：
   - 设备序列号必须全局唯一
   - 不能与其他加盟商的设备重复
   - 必须与安卓APP配置的序列号完全一致

3. **删除限制**：
   - 如果设备关联了订单，无法删除
   - 需要先处理相关订单才能删除设备

4. **兼容性**：
   - `FranchiseeAccount` 表中的 `machine_name` 和 `machine_serial_number` 字段仍然保留（为了兼容性）
   - 但主要逻辑已切换到使用 `SelfieMachine` 表

## 🔧 迁移现有数据（可选）

如果之前已经在 `FranchiseeAccount` 表中填写了设备信息，可以运行迁移脚本将数据迁移到 `SelfieMachine` 表：

```python
# 迁移脚本示例（需要创建）
# 将 FranchiseeAccount.machine_serial_number 迁移到 SelfieMachine 表
```

## ✅ 完成状态

- [x] 创建 SelfieMachine 数据库模型
- [x] 创建数据库迁移脚本
- [x] 在加盟商详情页面添加设备管理界面
- [x] 添加设备管理的后端路由（添加、编辑、删除）
- [x] 修改订单关联逻辑，通过设备表查找加盟商
- [x] 从加盟商添加/编辑页面移除单个设备字段
- [x] 添加设备管理的 JavaScript 函数

## 📝 下一步

1. **运行数据库迁移脚本**：
   ```bash
   python create_selfie_machines_table.py
   ```

2. **重启后端服务**

3. **测试功能**：
   - 创建加盟商账户
   - 在详情页面添加设备
   - 测试订单关联功能

4. **迁移现有数据**（如果有）：
   - 将现有 `FranchiseeAccount.machine_serial_number` 迁移到 `SelfieMachine` 表
