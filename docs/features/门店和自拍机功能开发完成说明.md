# é—¨åº—å’Œè‡ªæ‹æœºåŠŸèƒ½å¼€å‘å®Œæˆè¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡å¼€å‘å®Œæˆäº†åŠ ç›Ÿå•†ç®¡ç†é¡µé¢çš„å¢å¼ºåŠŸèƒ½ï¼Œæ·»åŠ äº†é—¨åº—ä¿¡æ¯å’Œè‡ªæ‹æœºä¿¡æ¯çš„ç®¡ç†ï¼Œå¹¶ç¡®ä¿è®¢å•è®°å½•ä¸­åŒ…å«è¿™äº›ä¿¡æ¯ã€‚

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ•°æ®åº“æ¨¡å‹å¢å¼º

#### FranchiseeAccount æ¨¡å‹æ–°å¢å­—æ®µ
- `store_name` (TEXT): é—¨åº—åç§°
- `machine_name` (TEXT): è‡ªæ‹æœºåç§°
- `machine_serial_number` (TEXT): è‡ªæ‹æœºåºåˆ—å·

#### Order æ¨¡å‹å·²æœ‰å­—æ®µï¼ˆå·²ç¡®è®¤ï¼‰
- `store_name` (String): é—¨åº—åç§°
- `selfie_machine_id` (String): è‡ªæ‹æœºåºåˆ—å·
- `external_platform` (String): è‡ªæ‹æœºåç§°ï¼ˆå¤ç”¨ç°æœ‰å­—æ®µï¼‰
- `external_order_number` (String): è‡ªæ‹æœºåºåˆ—å·ï¼ˆå¤ç”¨ç°æœ‰å­—æ®µï¼‰

### 2. æ•°æ®åº“è¿ç§»è„šæœ¬

**æ–‡ä»¶**: `add_franchisee_store_machine_fields.py` å’Œ `add_franchisee_store_machine_fields.bat`

**åŠŸèƒ½**:
- è‡ªåŠ¨æ£€æµ‹å¹¶æ·»åŠ æ–°å­—æ®µåˆ° `franchisee_accounts` è¡¨
- å¦‚æœå­—æ®µå·²å­˜åœ¨ï¼Œä¼šè·³è¿‡æ·»åŠ 
- æä¾›è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—

**ä½¿ç”¨æ–¹æ³•**:
```bash
# Windows
add_franchisee_store_machine_fields.bat

# æˆ–ç›´æ¥è¿è¡ŒPythonè„šæœ¬
python add_franchisee_store_machine_fields.py
```

### 3. åŠ ç›Ÿå•†ç®¡ç†é¡µé¢å¢å¼º

#### 3.1 åŠ ç›Ÿå•†æ·»åŠ é¡µé¢ (`templates/admin/franchisee_add.html`)

**æ–°å¢å­—æ®µ**:
- é—¨åº—åç§°ï¼ˆå¿…å¡«ï¼‰
- è‡ªæ‹æœºåç§°ï¼ˆå¯é€‰ï¼‰
- è‡ªæ‹æœºåºåˆ—å·ï¼ˆå¯é€‰ï¼‰

**ä½ç½®**: åœ¨"åˆå§‹å……å€¼é¢åº¦"å­—æ®µä¹‹åï¼Œ"åˆ›å»ºè´¦æˆ·"æŒ‰é’®ä¹‹å‰

#### 3.2 åŠ ç›Ÿå•†ç¼–è¾‘é¡µé¢ (`templates/admin/franchisee_edit.html`)

**æ–°å¢å­—æ®µ**:
- é—¨åº—åç§°ï¼ˆå¿…å¡«ï¼‰
- è‡ªæ‹æœºåç§°ï¼ˆå¯é€‰ï¼‰
- è‡ªæ‹æœºåºåˆ—å·ï¼ˆå¯é€‰ï¼‰

**ä½ç½®**: åœ¨"åŸºæœ¬ä¿¡æ¯"ä¹‹åï¼Œ"å‚å®¶IDé…ç½®"ä¹‹å‰

#### 3.3 åŠ ç›Ÿå•†è¯¦æƒ…é¡µé¢ (`templates/admin/franchisee_detail.html`)

**æ–°å¢æ˜¾ç¤ºåŒºåŸŸ**:
- é—¨åº—åç§°
- è‡ªæ‹æœºåç§°
- è‡ªæ‹æœºåºåˆ—å·

**ä½ç½®**: åœ¨"åŸºæœ¬ä¿¡æ¯"å¡ç‰‡ä¸­ï¼Œå…¬å¸åœ°å€ä¹‹å

### 4. åç«¯é€»è¾‘å¢å¼º

#### 4.1 åŠ ç›Ÿå•†æ·»åŠ é€»è¾‘ (`franchisee_routes.py`)

**ä¿®æ”¹ä½ç½®**: `admin_add_franchisee` å‡½æ•°

**åŠŸèƒ½**:
- ä»è¡¨å•è·å–é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯
- åœ¨åˆ›å»ºåŠ ç›Ÿå•†è´¦æˆ·æ—¶ä¿å­˜è¿™äº›ä¿¡æ¯

```python
store_name = request.form.get('store_name', '').strip() or None
machine_name = request.form.get('machine_name', '').strip() or None
machine_serial_number = request.form.get('machine_serial_number', '').strip() or None

franchisee = FranchiseeAccount(
    # ... å…¶ä»–å­—æ®µ
    store_name=store_name,
    machine_name=machine_name,
    machine_serial_number=machine_serial_number
)
```

#### 4.2 åŠ ç›Ÿå•†ç¼–è¾‘é€»è¾‘ (`franchisee_routes.py`)

**ä¿®æ”¹ä½ç½®**: `admin_edit_franchisee` å‡½æ•°

**åŠŸèƒ½**:
- ä»è¡¨å•è·å–é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯
- æ›´æ–°åŠ ç›Ÿå•†è´¦æˆ·æ—¶ä¿å­˜è¿™äº›ä¿¡æ¯

```python
account.store_name = request.form.get('store_name', '').strip() or None
account.machine_name = request.form.get('machine_name', '').strip() or None
account.machine_serial_number = request.form.get('machine_serial_number', '').strip() or None
```

#### 4.3 è®¢å•åˆ›å»ºé€»è¾‘ (`test_server.py`)

**ä¿®æ”¹ä½ç½®**: `miniprogram_submit_order` å‡½æ•°

**åŠŸèƒ½**:
- å½“è®¢å•å…³è”åˆ°åŠ ç›Ÿå•†æ—¶ï¼Œè‡ªåŠ¨ä»åŠ ç›Ÿå•†ä¿¡æ¯ä¸­è·å–é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯
- å°†è¿™äº›ä¿¡æ¯è®°å½•åˆ°è®¢å•ä¸­

**é€»è¾‘æµç¨‹**:
1. å¦‚æœè®¢å•æœ‰å…³è”çš„åŠ ç›Ÿå•†ï¼ˆé€šè¿‡ `franchiseeQrCode`ï¼‰
2. ä»åŠ ç›Ÿå•†è´¦æˆ·ä¸­è·å–ï¼š
   - `store_name` â†’ è®¢å•çš„ `store_name`
   - `machine_name` â†’ è®¢å•çš„ `external_platform`ï¼ˆè‡ªæ‹æœºåç§°ï¼‰
   - `machine_serial_number` â†’ è®¢å•çš„ `selfie_machine_id` å’Œ `external_order_number`ï¼ˆè‡ªæ‹æœºåºåˆ—å·ï¼‰
3. å¦‚æœåŠ ç›Ÿå•†æ²¡æœ‰è®¾ç½®è¿™äº›ä¿¡æ¯ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼š
   - `external_platform` = 'miniprogram'
   - `external_order_number` = è®¢å•å·

**ä»£ç ç¤ºä¾‹**:
```python
# ä»åŠ ç›Ÿå•†ä¿¡æ¯ä¸­è·å–é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯
store_name = franchisee.store_name
selfie_machine_name = franchisee.machine_name
selfie_machine_id = franchisee.machine_serial_number

# åˆ›å»ºè®¢å•æ—¶è®°å½•è¿™äº›ä¿¡æ¯
new_order = Order(
    # ... å…¶ä»–å­—æ®µ
    external_platform=selfie_machine_name or 'miniprogram',
    external_order_number=selfie_machine_id or order_number,
    store_name=store_name,
    selfie_machine_id=selfie_machine_id,
    franchisee_id=franchisee_id
)
```

## ğŸ“ å­—æ®µæ˜ å°„å…³ç³»

### åŠ ç›Ÿå•†è´¦æˆ· â†’ è®¢å•è®°å½•

| åŠ ç›Ÿå•†è´¦æˆ·å­—æ®µ | è®¢å•è®°å½•å­—æ®µ | è¯´æ˜ |
|--------------|------------|------|
| `store_name` | `store_name` | é—¨åº—åç§° |
| `machine_name` | `external_platform` | è‡ªæ‹æœºåç§°ï¼ˆå¤ç”¨å¤–éƒ¨æ¸ é“å­—æ®µï¼‰ |
| `machine_serial_number` | `selfie_machine_id` | è‡ªæ‹æœºåºåˆ—å· |
| `machine_serial_number` | `external_order_number` | è‡ªæ‹æœºåºåˆ—å·ï¼ˆå¤ç”¨å¤–éƒ¨è®¢å•å·å­—æ®µï¼‰ |
| `id` | `franchisee_id` | åŠ ç›Ÿå•†IDï¼ˆå…³è”å…³ç³»ï¼‰ |

## ğŸ”„ ä½¿ç”¨æµç¨‹

### 1. åˆ›å»º/ç¼–è¾‘åŠ ç›Ÿå•†è´¦æˆ·

1. è¿›å…¥"åŠ ç›Ÿå•†ç®¡ç†" â†’ "æ·»åŠ è´¦æˆ·" æˆ– "ç¼–è¾‘è´¦æˆ·"
2. å¡«å†™åŸºæœ¬ä¿¡æ¯ï¼ˆå…¬å¸åç§°ã€è”ç³»äººç­‰ï¼‰
3. **å¡«å†™é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯**:
   - é—¨åº—åç§°ï¼ˆå¿…å¡«ï¼‰
   - è‡ªæ‹æœºåç§°ï¼ˆå¯é€‰ï¼‰
   - è‡ªæ‹æœºåºåˆ—å·ï¼ˆå¯é€‰ï¼‰
4. ä¿å­˜

### 2. è®¢å•è‡ªåŠ¨è®°å½•

å½“ç”¨æˆ·é€šè¿‡å°ç¨‹åºä¸‹å•ï¼Œä¸”è®¢å•å…³è”åˆ°åŠ ç›Ÿå•†æ—¶ï¼š

1. ç³»ç»Ÿè‡ªåŠ¨ä»åŠ ç›Ÿå•†è´¦æˆ·ä¸­è·å–é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯
2. å°†è¿™äº›ä¿¡æ¯è®°å½•åˆ°è®¢å•ä¸­
3. åœ¨è®¢å•åˆ—è¡¨å’Œè®¢å•è¯¦æƒ…ä¸­å¯ä»¥çœ‹åˆ°ï¼š
   - é—¨åº—åç§°ï¼ˆæ˜¾ç¤ºåœ¨"æ¥æºï¼ˆé—¨åº—ï¼‰"åˆ—ï¼‰
   - è‡ªæ‹æœºåç§°ï¼ˆæ˜¾ç¤ºåœ¨"è‡ªæ‹æœºåç§°"å­—æ®µï¼‰
   - è‡ªæ‹æœºåºåˆ—å·ï¼ˆæ˜¾ç¤ºåœ¨"è‡ªæ‹æœºåºåˆ—å·"å­—æ®µï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**: é¦–æ¬¡ä½¿ç”¨å‰ï¼Œéœ€è¦è¿è¡Œ `add_franchisee_store_machine_fields.bat` æ·»åŠ æ–°å­—æ®µ
2. **é—¨åº—åç§°å¿…å¡«**: åœ¨æ·»åŠ /ç¼–è¾‘åŠ ç›Ÿå•†æ—¶ï¼Œé—¨åº—åç§°æ˜¯å¿…å¡«é¡¹ï¼Œç¡®ä¿è®¢å•åˆ—è¡¨èƒ½æ­£ç¡®æ˜¾ç¤ºé—¨åº—ä¿¡æ¯
3. **å‘åå…¼å®¹**: å¦‚æœåŠ ç›Ÿå•†æ²¡æœ‰è®¾ç½®é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯ï¼Œè®¢å•ä¼šä½¿ç”¨é»˜è®¤å€¼ï¼ˆ`external_platform='miniprogram'`ï¼‰
4. **ç°æœ‰è®¢å•**: ç°æœ‰æµ‹è¯•è®¢å•ä¸ä¼šè‡ªåŠ¨è¿ç§»ï¼Œå› ä¸ºéƒ½æ˜¯æµ‹è¯•æ•°æ®ï¼Œåç»­ä¼šåˆ é™¤

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

1. **æ‰¹é‡å¯¼å…¥**: å¯ä»¥è€ƒè™‘æ·»åŠ æ‰¹é‡å¯¼å…¥åŠŸèƒ½ï¼Œä¸€æ¬¡æ€§å¯¼å…¥å¤šä¸ªé—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯
2. **è‡ªæ‹æœºç®¡ç†**: å¦‚æœä¸€å®¶é—¨åº—æœ‰å¤šå°è‡ªæ‹æœºï¼Œå¯ä»¥è€ƒè™‘åˆ›å»ºç‹¬ç«‹çš„"è‡ªæ‹æœºç®¡ç†"æ¨¡å—
3. **ç»Ÿè®¡æŠ¥è¡¨**: å¯ä»¥åŸºäºé—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯ç”Ÿæˆæ›´è¯¦ç»†çš„ç»Ÿè®¡æŠ¥è¡¨
4. **è®¢å•ç­›é€‰**: åœ¨è®¢å•åˆ—è¡¨ä¸­å¯ä»¥æŒ‰é—¨åº—æˆ–è‡ªæ‹æœºè¿›è¡Œç­›é€‰

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `AI-studio/test_server.py`: è®¢å•æ¨¡å‹å’Œè®¢å•åˆ›å»ºé€»è¾‘
- `AI-studio/franchisee_routes.py`: åŠ ç›Ÿå•†ç®¡ç†è·¯ç”±
- `AI-studio/templates/admin/franchisee_add.html`: åŠ ç›Ÿå•†æ·»åŠ é¡µé¢
- `AI-studio/templates/admin/franchisee_edit.html`: åŠ ç›Ÿå•†ç¼–è¾‘é¡µé¢
- `AI-studio/templates/admin/franchisee_detail.html`: åŠ ç›Ÿå•†è¯¦æƒ…é¡µé¢
- `AI-studio/add_franchisee_store_machine_fields.py`: æ•°æ®åº“è¿ç§»è„šæœ¬
- `AI-studio/add_franchisee_store_machine_fields.bat`: æ•°æ®åº“è¿ç§»æ‰¹å¤„ç†æ–‡ä»¶

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ï¼Œç¡®è®¤å­—æ®µæ·»åŠ æˆåŠŸ
- [ ] åˆ›å»ºæ–°åŠ ç›Ÿå•†è´¦æˆ·ï¼Œå¡«å†™é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯
- [ ] ç¼–è¾‘ç°æœ‰åŠ ç›Ÿå•†è´¦æˆ·ï¼Œæ›´æ–°é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯
- [ ] æŸ¥çœ‹åŠ ç›Ÿå•†è¯¦æƒ…ï¼Œç¡®è®¤é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯æ˜¾ç¤ºæ­£ç¡®
- [ ] é€šè¿‡å°ç¨‹åºåˆ›å»ºè®¢å•ï¼ˆå…³è”åˆ°åŠ ç›Ÿå•†ï¼‰ï¼Œç¡®è®¤è®¢å•ä¸­è®°å½•äº†é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯
- [ ] åœ¨è®¢å•åˆ—è¡¨å’Œè®¢å•è¯¦æƒ…ä¸­ï¼Œç¡®è®¤é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯æ˜¾ç¤ºæ­£ç¡®

---

**å¼€å‘å®Œæˆæ—¶é—´**: 2026-01-13
**å¼€å‘è€…**: AI Assistant
