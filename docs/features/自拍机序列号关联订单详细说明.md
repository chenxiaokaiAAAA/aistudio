# 自拍机序列号关联订单详细说明

## 📋 三个核心问题解答

### 问题1：管理后台需要填写什么信息？

在**加盟商管理** → **添加账户** 或 **编辑账户** 页面，需要填写以下信息：

#### 必填字段：
- **门店名称** (`store_name`): 如 `厦门SM商城`、`北京朝阳店`
  - 这个字段会显示在订单列表的"来源（门店）"列
  - 用于区分不同门店的订单

#### 可选但建议填写：
- **自拍机名称** (`machine_name`): 如 `自拍机-001`、`SM商城-1号机`
  - 这个字段会记录到订单的"自拍机名称"字段
  - 用于标识具体的自拍机设备

- **自拍机序列号** (`machine_serial_number`): 如 `SN20240101001`、`MACHINE_SM_001`
  - ⭐ **这是关键字段**，用于关联订单和加盟商
  - 必须与安卓APP中配置的序列号**完全一致**
  - 建议使用统一的命名规则，如：`门店代码_设备编号`

#### 填写示例：

```
门店名称: 厦门SM商城
自拍机名称: SM商城-1号机
自拍机序列号: XMSM_001
```

**重要提示：**
- 如果一个加盟商有多个门店，每个门店需要创建**独立的加盟商账户**
- 如果一个门店有多台自拍机，每台自拍机需要**不同的序列号**，但可以属于同一个加盟商账户

---

### 问题2：小程序二维码是统一的还是专属的？

#### 当前实现：**订单专属二维码**

- 每个订单生成**独立的二维码**
- 二维码内容格式：`order:订单ID`（如：`order:PET123456789`）
- 用户在小程序的"我的订单"页面点击"核销"按钮，会显示该订单的专属二维码

#### 二维码生成位置：
- **小程序端**：`pages/order/qrcode` 页面
- **后端API**：`/api/miniprogram/order/qrcode` 接口

#### 二维码特点：
- ✅ **订单专属**：每个订单有唯一的二维码
- ❌ **不是设备专属**：二维码本身不包含设备信息
- ✅ **通用格式**：所有订单的二维码格式相同，只是订单ID不同

#### 是否需要修改为设备专属二维码？

**方案A：保持订单专属（推荐）**
- 优点：简单，不需要修改现有逻辑
- 缺点：需要安卓APP从设备本身获取序列号

**方案B：改为设备专属（需要开发）**
- 优点：二维码包含设备信息，安卓APP可以直接获取
- 缺点：需要修改二维码生成和解析逻辑，复杂度较高

**建议：使用方案A**，因为：
1. 安卓APP可以本地配置序列号（更灵活）
2. 不需要修改小程序二维码生成逻辑
3. 订单二维码仍然可以通用，兼容性更好

---

### 问题3：安卓APP如何获取自拍机序列号？

#### 核心问题：
如果用户扫码的是**通用订单二维码**（格式：`order:订单ID`），安卓APP需要从哪里获取自拍机序列号？

#### 解决方案：**安卓APP本地配置**

安卓APP需要在**设备本地**保存自拍机序列号，有以下几种实现方式：

##### 方式1：配置文件（推荐）

在安卓APP的配置文件中（如 `config.properties` 或 `SharedPreferences`）保存序列号：

```java
// 配置文件示例
selfie_machine_serial_number = XMSM_001
```

**配置步骤：**
1. 在管理后台获取自拍机序列号（如：`XMSM_001`）
2. 在安卓APP的配置文件中设置该序列号
3. 安卓APP在调用核销和上传接口时，读取配置文件中的序列号

##### 方式2：设备标识符

使用安卓设备的唯一标识符（如 `ANDROID_ID`、`Serial Number`）作为序列号：

```java
// 获取设备序列号
String deviceSerial = Build.SERIAL;
// 或使用 ANDROID_ID
String androidId = Settings.Secure.getString(getContentResolver(), Settings.Secure.ANDROID_ID);
```

**注意：** 需要在管理后台的"自拍机序列号"字段中填写相同的值

##### 方式3：手动输入（临时方案）

在安卓APP中提供一个设置界面，让管理员手动输入序列号。

---

## 🔄 完整工作流程

### 场景：用户到"厦门SM商城"的自拍机核销

#### 步骤1：管理后台配置

1. 进入 **加盟商管理** → **添加账户**（或编辑现有账户）
2. 填写信息：
   ```
   公司名称: 厦门SM商城
   门店名称: 厦门SM商城
   自拍机名称: SM商城-1号机
   自拍机序列号: XMSM_001
   ```
3. 保存

#### 步骤2：安卓APP配置

1. 在安卓APP的配置文件中设置：
   ```
   selfie_machine_serial_number = XMSM_001
   ```
   （必须与管理后台的"自拍机序列号"完全一致）

#### 步骤3：用户下单

1. 用户在小程序下单（**没有扫描加盟商二维码**）
2. 订单创建时：
   - `franchisee_id`: `NULL`
   - `store_name`: `NULL`
   - `selfie_machine_id`: `NULL`

#### 步骤4：用户到自拍机核销

1. 用户在小程序"我的订单"页面点击"核销"
2. 显示订单专属二维码（内容：`order:PET123456789`）
3. 用户用安卓APP扫描二维码
4. 安卓APP解析二维码，获取订单ID：`PET123456789`
5. 安卓APP从本地配置读取自拍机序列号：`XMSM_001`
6. 安卓APP调用核销接口：
   ```
   GET /api/miniprogram/order/check?orderId=PET123456789&machineSerialNumber=XMSM_001
   ```

#### 步骤5：后端自动关联

1. 后端接收请求，查找订单 `PET123456789`
2. 发现订单的 `franchisee_id` 为空
3. 通过自拍机序列号 `XMSM_001` 查找加盟商：
   ```sql
   SELECT * FROM franchisee_accounts 
   WHERE machine_serial_number = 'XMSM_001' AND status = 'active'
   ```
4. 找到加盟商：`FranchiseeAccount(id=1, company_name='厦门SM商城', store_name='厦门SM商城', machine_serial_number='XMSM_001')`
5. 更新订单：
   - `franchisee_id`: `1`
   - `store_name`: `'厦门SM商城'`
   - `selfie_machine_id`: `'XMSM_001'`
   - `external_platform`: `'SM商城-1号机'`
   - `external_order_number`: `'XMSM_001'`
6. 提交数据库更改

#### 步骤6：用户拍摄并上传

1. 用户拍摄照片
2. 安卓APP上传照片时，再次传递序列号：
   ```
   POST /api/miniprogram/order/upload
   Form Data:
     orderId: PET123456789
     machineSerialNumber: XMSM_001
     photos: [文件]
   ```
3. 如果订单仍未关联，会再次尝试关联（双重保险）

#### 步骤7：管理后台查看

1. 进入 **订单管理** → **订单列表**
2. 订单的"来源（门店）"列显示：`厦门SM商城`
3. 进入订单详情：
   - **门店**: `厦门SM商城`
   - **自拍机名称**: `SM商城-1号机`
   - **自拍机序列号**: `XMSM_001`

---

## 📱 安卓APP集成代码示例

### 1. 读取本地配置的序列号

```java
public class MachineConfig {
    private static final String PREF_NAME = "machine_config";
    private static final String KEY_SERIAL_NUMBER = "serial_number";
    
    // 获取自拍机序列号
    public static String getSerialNumber(Context context) {
        SharedPreferences prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE);
        String serialNumber = prefs.getString(KEY_SERIAL_NUMBER, "");
        
        // 如果没有配置，使用设备序列号作为默认值
        if (serialNumber.isEmpty()) {
            serialNumber = Build.SERIAL;
        }
        
        return serialNumber;
    }
    
    // 设置自拍机序列号（管理员配置）
    public static void setSerialNumber(Context context, String serialNumber) {
        SharedPreferences prefs = context.getSharedPreferences(PREF_NAME, Context.MODE_PRIVATE);
        prefs.edit().putString(KEY_SERIAL_NUMBER, serialNumber).apply();
    }
}
```

### 2. 调用核销接口

```java
public void checkOrder(String orderId) {
    // 获取自拍机序列号
    String machineSerialNumber = MachineConfig.getSerialNumber(this);
    
    // 构建请求URL
    String url = baseUrl + "/api/miniprogram/order/check" 
               + "?orderId=" + orderId
               + "&machineSerialNumber=" + machineSerialNumber;
    
    // 发送请求
    OkHttpClient client = new OkHttpClient();
    Request request = new Request.Builder()
        .url(url)
        .get()
        .build();
    
    // ... 处理响应
}
```

### 3. 调用上传接口

```java
public void uploadPhotos(String orderId, List<File> photoFiles) {
    // 获取自拍机序列号
    String machineSerialNumber = MachineConfig.getSerialNumber(this);
    
    // 构建请求体
    MultipartBody.Builder builder = new MultipartBody.Builder()
        .setType(MultipartBody.FORM)
        .addFormDataPart("orderId", orderId)
        .addFormDataPart("machineSerialNumber", machineSerialNumber); // ⭐ 关键
    
    // 添加照片文件
    for (File file : photoFiles) {
        RequestBody fileBody = RequestBody.create(
            MediaType.parse("image/jpeg"), 
            file
        );
        builder.addFormDataPart("photos", file.getName(), fileBody);
    }
    
    RequestBody requestBody = builder.build();
    
    // 发送请求
    Request request = new Request.Builder()
        .url(baseUrl + "/api/miniprogram/order/upload")
        .post(requestBody)
        .build();
    
    // ... 处理响应
}
```

---

## ⚠️ 重要注意事项

### 1. 序列号必须唯一且一致

- 管理后台的"自拍机序列号"必须与安卓APP配置的序列号**完全一致**
- 建议使用统一的命名规则，避免大小写、空格等问题
- 建议格式：`门店代码_设备编号`（如：`XMSM_001`、`BJ_CY_002`）

### 2. 一个加盟商可以有多台自拍机

如果"厦门SM商城"有3台自拍机：
- 方案A：创建3个独立的加盟商账户（推荐）
  - 账户1：门店名称=`厦门SM商城-1号店`，序列号=`XMSM_001`
  - 账户2：门店名称=`厦门SM商城-2号店`，序列号=`XMSM_002`
  - 账户3：门店名称=`厦门SM商城-3号店`，序列号=`XMSM_003`

- 方案B：使用同一个加盟商账户，但序列号不同（需要修改代码支持）

**建议使用方案A**，因为：
- 可以分别统计每个门店的订单
- 可以分别设置每个门店的额度
- 逻辑更清晰，维护更方便

### 3. 序列号配置方式

**推荐方式：**
1. 在管理后台创建加盟商账户时，填写自拍机序列号
2. 将序列号记录在设备标签上（如：`设备序列号: XMSM_001`）
3. 在安卓APP安装时，由管理员在配置界面输入序列号
4. 安卓APP将序列号保存到本地配置文件

**备选方式：**
- 使用设备硬件序列号（`Build.SERIAL`）
- 在管理后台填写相同的硬件序列号

---

## ✅ 检查清单

### 管理后台配置
- [ ] 创建加盟商账户
- [ ] 填写门店名称（必填）
- [ ] 填写自拍机名称（可选）
- [ ] 填写自拍机序列号（建议填写）
- [ ] 记录序列号到设备标签

### 安卓APP配置
- [ ] 实现序列号读取功能（从配置文件或设备标识）
- [ ] 在核销接口调用时传递序列号
- [ ] 在上传接口调用时传递序列号
- [ ] 提供管理员配置界面（可选）

### 测试验证
- [ ] 用户在小程序下单（不扫描加盟商二维码）
- [ ] 用户到自拍机核销
- [ ] 检查订单是否自动关联到正确的加盟商
- [ ] 检查管理后台订单列表是否显示正确的门店信息
- [ ] 检查订单详情是否显示完整的自拍机信息

---

## 📝 总结

1. **管理后台需要填写**：
   - 门店名称（必填）
   - 自拍机名称（可选）
   - 自拍机序列号（建议填写，用于关联订单）

2. **小程序二维码**：
   - 当前是订单专属的，格式：`order:订单ID`
   - 不需要修改为设备专属

3. **安卓APP获取序列号**：
   - 从本地配置文件读取（推荐）
   - 或使用设备硬件序列号
   - 在调用核销和上传接口时传递序列号参数

4. **关联逻辑**：
   - 后端通过自拍机序列号查找对应的加盟商
   - 自动更新订单的 `franchisee_id`、`store_name`、`selfie_machine_id` 等字段
   - 无需用户手动操作，全自动完成
