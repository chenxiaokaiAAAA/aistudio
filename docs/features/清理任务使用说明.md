# 图片清理任务使用说明

## 功能说明

定期清理1个月以前已发货订单的图片文件，释放服务器存储空间。

### 清理任务类型

#### 1. 用户上传原图清理（uploads文件夹）
- **清理条件**：
  1. 订单创建时间：超过1个月（30天）以前
  2. 订单状态：已发货（shipped）
  3. 清理范围：只删除用户上传的原图（uploads文件夹）
  4. 保留规则：订单未完成的图片暂时保留

#### 2. 效果图清理（final_works文件夹）
- **清理条件**：
  1. 订单创建时间：超过1个月（30天）以前
  2. 订单状态：已发货（shipped）
  3. 清理范围：删除效果图（final_works文件夹），包括有水印和无水印版本
  4. 保留规则：订单未完成的图片暂时保留

## 使用方法

### 方法1：独立脚本运行（推荐用于测试）

#### 用户上传原图清理

**预览模式（不会实际删除）**
```bash
python cleanup_old_uploaded_images.py
```

**执行实际删除**
```bash
python cleanup_old_uploaded_images.py --execute
```

**自定义清理天数**
```bash
# 清理60天以前的订单
python cleanup_old_uploaded_images.py --execute --days 60
```

#### 效果图清理

**预览模式（不会实际删除）**
```bash
python cleanup_old_final_images.py
```

**执行实际删除**
```bash
python cleanup_old_final_images.py --execute
```

**自定义清理天数**
```bash
# 清理60天以前的订单
python cleanup_old_final_images.py --execute --days 60
```

### 方法2：通过定时任务系统运行

#### 手动执行清理任务

**执行用户上传原图清理**
```bash
python scheduled_cleanup.py --run-uploaded-cleanup
```

**执行效果图清理**
```bash
python scheduled_cleanup.py --run-final-cleanup
```

#### 启动定时调度器（每天自动执行）
```bash
python scheduled_cleanup.py --schedule
```

#### 查看任务日志
```bash
python scheduled_cleanup.py --log
```

### 方法3：配置系统定时任务

#### Windows任务计划程序

1. 运行以下命令生成批处理文件：
```bash
python scheduled_cleanup.py --windows-task
```

2. 按照提示在Windows任务计划程序中设置：
   - 触发器：每天
   - 开始时间：03:00
   - 操作：启动程序 -> `run_cleanup_task.bat`

#### Linux Cron任务

1. 运行以下命令查看cron配置：
```bash
python scheduled_cleanup.py --linux-cron
```

2. 按照提示添加cron任务：
```bash
crontab -e
```

3. 添加以下行（每天凌晨3点执行）：
```
0 3 * * * cd /path/to/project && python scheduled_cleanup.py --run-uploaded-cleanup
```

## 定时任务配置

默认配置：
- **用户上传原图清理**：
  - 执行时间：每天凌晨3:00
  - 清理天数：30天（1个月）
  - 订单状态：已发货（shipped）
  - 清理目录：uploads/

- **效果图清理**：
  - 执行时间：每天凌晨3:30
  - 清理天数：30天（1个月）
  - 订单状态：已发货（shipped）
  - 清理目录：final_works/

如需修改，可以编辑 `scheduled_cleanup.py` 中的 `setup_schedule()` 方法。

## 安全说明

1. **预览模式**：默认使用预览模式，不会实际删除文件
2. **双重验证**：只删除已发货且超过1个月的订单图片
3. **日志记录**：所有清理操作都会记录日志
4. **错误处理**：删除失败的文件会记录错误信息，不会影响其他文件
5. **完整清理**：效果图清理会同时删除有水印和无水印版本

## 注意事项

1. ⚠️ **首次运行建议使用预览模式**，确认要删除的文件无误后再执行实际删除
2. ⚠️ **删除操作不可逆**，请确保已做好数据备份
3. ⚠️ 只删除指定文件夹中的图片，不影响其他文件夹
4. ✅ 订单未完成的图片会保留，不会误删
5. ✅ 效果图清理会自动检测并删除对应的 `clean_` 前缀无水印版本

## 输出示例

```
============================================================
开始清理用户上传的原图
============================================================
清理条件：
  - 订单创建时间：2024-11-25 10:00:00 之前（30天前）
  - 订单状态：已发货（shipped）
  - 清理目录：uploads/
模式：执行模式（将删除文件）
============================================================

找到 15 个符合条件的订单

开始处理订单图片...
------------------------------------------------------------

订单号: PET20241125123456
  创建时间: 2024-11-20 14:30:00
  状态: shipped
  ✓ 找到原图: mp_12345_abc123.jpg (245.67 KB)
    → 已删除
  ✓ 找到图片: mp_12345_def456.jpg (189.23 KB)
    → 已删除

============================================================
清理完成统计：
  处理的订单数: 15
  找到的文件数: 28
  未找到的文件数: 2
  删除失败数: 0
  释放空间: 12.45 MB
============================================================

✓ 文件已实际删除
```

## 故障排查

如果遇到问题，请检查：

1. **数据库连接**：确保数据库文件存在且可访问
2. **文件权限**：确保对 `uploads/` 文件夹有删除权限
3. **路径配置**：检查 `test_server.py` 中的 `UPLOAD_FOLDER` 配置
4. **日志文件**：查看 `cleanup_task_log.json` 了解详细错误信息

