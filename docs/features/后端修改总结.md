# 后端API修改总结

## 概述
根据新的订单流程要求，对 Flask 后端进行了以下修改：

**新流程：风格选择 → 产品选择 → 确认订单 → 支付 → 订单详情 → 传图**

**调整点：**
- 在确认订单页移除上传图片步骤
- 在订单详情页增加"传图"按钮
- 后端支持订单创建后再上传图片
- 状态管理：未传图显示原图，完成后显示效果图

## 已完成的后端修改

### 1. 添加更新订单图片接口 ✅

**接口：** `PUT /api/miniprogram/orders/<order_id>/images`

**功能：** 更新订单图片
- 支持通过订单号查找订单
- 删除旧的订单图片记录
- 添加新的订单图片
- 自动更新订单状态（如有图片则改为待制作）
- 兼容 `uploadedImages` 和 `images` 两种数据格式

**请求示例：**
```json
{
  "images": ["http://tmp/test1.jpg", "http://tmp/test2.jpg"],
  "uploadedImages": [
    {
      "url": "http://tmp/test_upload1.jpg",
      "filename": "test_upload1.jpg"
    }
  ]
}
```

**响应示例：**
```json
{
  "status": "success",
  "message": "订单图片更新成功",
  "images": ["https://photogooo/media/original/image1.jpg"],
  "imageCount": 1
}
```

### 2. 修改订单创建接口 ✅

**文件：** `test_server.py` 第 3793 行

**修改内容：**
- 将 `original_image` 字段初始设置为空字符串
- 支持订单创建时不包含图片
- 图片可以后续通过更新接口添加

**修改前：**
```python
original_image=data.get('uploadedImages', [{}])[0].get('url', '') if data.get('uploadedImages') else '',
```

**修改后：**
```python
original_image='',  # 初始为空，后续通过更新接口添加图片
```

### 3. 修改Order模型 ✅

**文件：** `test_server.py` 第 797 行

**修改内容：**
- 将 `original_image` 字段的 `nullable=False` 改为允许空值
- 支持订单无图片的初始状态

**修改前：**
```python
original_image = db.Column(db.String(200), nullable=False)
```

**修改后：**
```python
original_image = db.Column(db.String(200))
```

### 4. 更新订单查询接口 ✅

**文件：** `test_server.py` 第 4032-4035 行

**修改内容：**
- 添加兼容性字段 `originalImages`
- 更新状态映射，添加 `unpaid` 状态为"待上传图片"

**新增字段：**
```python
'images': image_urls,  # 使用URL格式的图片
'originalImages': image_urls,  # 兼容前端字段名
'finalImage': final_image_url,  # 使用URL格式的最终图片
'finalImageNoWatermark': final_image_no_watermark_url
```

**状态映射：**
```python
status_map = {
    'unpaid': '待上传图片',
    'pending': '待制作',
    'completed': '已完成',
    'shipped': '已发货',
    'hd_ready': '高清放大',
    'manufacturing': '厂家制作中',
    'processing': '处理中'
}
```

### 5. 添加辅助函数 ✅

**文件：** `test_server.py` 第 4316-4319 行

**功能：** 获取订单图片列表的辅助函数

```python
def get_order_images(order_id):
    """获取订单图片列表"""
    order_images = OrderImage.query.filter_by(order_id=order_id).all()
    return [img.path for img in order_images]
```

## API接口列表

### 现有的订单接口

1. **创建订单：** `POST /api/miniprogram/orders`
   - 支持创建不含图片的订单
   - 初始状态为 `unpaid`

2. **查询订单：** `GET /api/miniprogram/orders`
   - 返回订单列表包含图片信息
   - 支持多种查询方式（openid/phone/userId）

3. **更新订单状态：** `PUT /api/miniprogram/orders/<order_id>/status`
   - 状态映射包含新的 `unpaid` 状态

### 新增的接口

4. **更新订单图片：** `PUT /api/miniprogram/orders/<order_id>/images`
   - 支持订单创建后上传图片
   - 自动更新订单状态

## 状态流转

```
订单创建(unpaid) → 上传图片 → 待制作(pending) → 制作完成(completed) → 发货(shipped)
```

## 测试建议

1. **完整流程测试**
   - 创建不含图片的订单
   - 支付订单（状态保持为 unpaid）
   - 在订单详情页上传图片
   - 验证状态更新为 pending

2. **图片上传测试**
   - 测试上传单张图片
   - 测试上传多张图片
   - 测试替换原有图片

3. **状态显示测试**
   - 未传图时显示上传按钮和相应状态
   - 传图后显示原图
   - 制作完成后显示效果图

4. **兼容性测试**
   - 确保现有订单不受影响
   - 测试不同状态下的图片显示

## 注意事项

1. **数据库迁移**
   - 现有 Order 表的 `original_image` 字段需要允许空值
   - 可能需要手动执行 SQL 更新字段约束

2. **图片存储**
   - 临时图片会创建占位符
   - 实际生产环境需要处理真实图片上传

3. **状态管理**
   - 新状态 `unpaid` 表示"待上传图片"
   - 上传图片后自动转为 `pending` 状态

4. **前端兼容**
   - 提供 `originalImages` 字段兼容前端
   - 保持现有接口返回格式

## 文件清单

**修改的文件：**
- `test_server.py` - 主要的 API 修改
- `test_new_order_flow.py` - 测试脚本（新增）

**新增文件：**
- `后端修改总结.md` - 本文档

所有修改已完成，后端API已准备就绪！

