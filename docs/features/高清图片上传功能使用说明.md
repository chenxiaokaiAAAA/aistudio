# 高清图片上传功能使用说明

## 功能概述

现在您的系统已经支持高清图片上传功能！当订单状态变为"待发货"后，您可以上传一张高清放大图，系统会自动发送给厂家。

## 新的订单状态流程

```
待制作 → 已完成 → 待发货 → 高清放大 → 已发货
```

### 状态说明：
- **待制作** (`pending`): 订单刚创建，等待制作
- **已完成** (`completed`): 制作完成，等待用户确认
- **待发货** (`shipped`): 用户确认制作，**可以上传高清图片**
- **高清放大** (`hd_ready`): 已上传高清图片，**自动发送给厂家**
- **已发货** (`processing`): 厂家已发货

## 使用方法

### 1. 启动服务器
使用您现有的启动方式：
```bash
python start.py
```

### 2. 上传高清图片
1. 登录管理后台：`http://moeart.cc/admin/`
2. 进入订单详情页面
3. 当订单状态为"待发货"时，在"高清放大图"区域上传高清图片
4. 上传完成后，将订单状态改为"高清放大"
5. 系统会自动将高清图片发送给厂家

### 3. 管理界面功能
- **三栏布局**: 原图 | 效果图 | 高清放大图
- **状态提示**: 显示当前订单状态和可执行操作
- **上传功能**: 支持高清图片上传和下载
- **自动传片**: 状态变为"高清放大"时自动发送给厂家

## 技术实现

### 数据库更新
- 添加了 `hd_image` 字段存储高清图片文件名
- 更新了订单状态枚举，支持 `hd_ready` 状态
- 数据库已自动迁移，无需手动操作

### 文件存储
- 高清图片存储在 `hd_images/` 文件夹
- 文件命名格式：`hd_{uuid}_{原文件名}`
- 支持通过 `/media/hd/` 和 `/download/hd/` 访问

### 自动传片
- 当订单状态更新为 `hd_ready` 时触发
- 自动检查高清图片是否存在
- 发送成功后状态自动变为 `processing`（已发货）
- 完整的错误处理和日志记录

## 配置冲印系统

### 1. 基本配置
编辑 `printer_config.py` 文件：
```python
PRINTER_SYSTEM_CONFIG = {
    'api_url': 'http://您的服务器IP:5995/api/ODSGate/NewOrder',
    'source_app_id': 'YT',
    'shop_id': '您的影楼编号',
    'shop_name': '您的影楼名称',
    'enabled': True,  # 启用自动传片
    'timeout': 30,
    'retry_times': 3,
}
```

### 2. 文件访问配置
确保高清图片可以通过HTTP访问：
```python
# 在 printer_client.py 中配置
base_url = "http://your-domain.com"  # 替换为您的域名
```

## 工作流程示例

1. **用户下单** → 状态：待制作
2. **制作完成** → 状态：已完成
3. **用户确认** → 状态：待发货
4. **上传高清图** → 在管理后台上传高清放大图
5. **状态更新** → 状态：高清放大
6. **自动传片** → 系统自动发送给厂家
7. **厂家发货** → 状态：已发货

## 注意事项

### 文件要求
- 支持常见图片格式（JPG、PNG等）
- 建议使用高分辨率图片（300DPI以上）
- 文件大小限制：100MB（可在配置中调整）

### 网络要求
- 确保服务器可以访问冲印系统API
- 高清图片必须可通过HTTP访问
- 建议使用HTTPS确保传输安全

### 错误处理
- 上传失败会在日志中记录
- 传片失败不会影响订单状态更新
- 支持重试机制（最多3次）

## 故障排除

### 常见问题

1. **高清图片无法上传**
   - 检查文件格式和大小
   - 确认服务器磁盘空间充足
   - 查看服务器日志

2. **自动传片失败**
   - 检查冲印系统配置
   - 确认网络连接正常
   - 验证图片文件存在

3. **状态更新异常**
   - 检查数据库连接
   - 确认订单ID正确
   - 查看错误日志

### 日志监控
系统会在以下情况记录日志：
- 高清图片上传成功/失败
- 自动传片成功/失败
- 状态更新操作
- 配置错误

## 联系支持

如果在使用过程中遇到问题：
1. 查看服务器控制台日志
2. 检查数据库状态
3. 验证配置文件
4. 联系技术支持

---

**更新完成！** 您现在可以使用 `python start.py` 启动服务器，体验新的高清图片上传功能了！

