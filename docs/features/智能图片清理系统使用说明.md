# 智能图片清理系统使用说明

## 功能概述

本系统实现了基于订单状态的智能图片清理机制，主要特点：

- **按需清理**: 只清理已发货订单的高清图片，发货后10天自动清理
- **数据保留**: 清理图片文件但保留数据库记录
- **云端备份**: 支持将清理的图片备份到百度云
- **按需恢复**: 用户需要时可从百度云恢复图片

## 系统架构

### 核心组件

1. **SmartImageCleanup** (`smart_image_cleanup.py`)
   - 智能图片清理器
   - 基于订单状态和发货时间清理高清图片
   - 维护清理日志

2. **BaiduCloudBackup** (`baidu_cloud_backup.py`)
   - 百度云备份管理器
   - 自动备份清理的图片到云端
   - 支持图片恢复功能

3. **ScheduledCleanupTask** (`scheduled_cleanup.py`)
   - 定时任务管理器
   - 支持Windows任务计划程序和Linux cron
   - 自动执行清理和备份任务

## 数据库更新

### 新增字段

系统会自动为订单表添加 `shipped_at` 字段：

```sql
ALTER TABLE orders ADD COLUMN shipped_at DATETIME;
```

### 字段说明

- `shipped_at`: 订单发货时间
- 当订单状态更新为 `shipped` 或 `processing` 时自动设置
- 用于计算清理时间（发货后10天）

## 使用方法

### 1. 初始化系统

首次运行需要添加发货时间字段：

```bash
python smart_image_cleanup.py
```

### 2. 配置百度云备份（可选）

```bash
python baidu_cloud_backup.py
```

选择 "1. 设置百度云配置"，按提示输入：
- 应用Key (app_key)
- 应用Secret (secret_key)  
- 授权码 (authorization_code)

### 3. 手动执行清理

```bash
# 执行完整任务（清理+备份）
python scheduled_cleanup.py --run-full

# 只执行清理
python scheduled_cleanup.py --run-task

# 只执行备份
python scheduled_cleanup.py --run-backup
```

### 4. 设置定时任务

#### Windows系统

```bash
# 创建Windows任务计划程序配置
python scheduled_cleanup.py --windows-task
```

然后按提示在Windows任务计划程序中设置：
- 触发器: 每天
- 开始时间: 02:00
- 操作: 启动程序 -> `run_cleanup_task.bat`

#### Linux系统

```bash
# 创建Linux cron配置
python scheduled_cleanup.py --linux-cron
```

然后按提示添加cron任务：
```bash
crontab -e
# 添加以下行
0 2 * * * cd /path/to/project && python scheduled_cleanup.py --run-task
```

### 5. 启动定时调度器

```bash
python scheduled_cleanup.py --schedule
```

## 清理规则

### 清理条件

高清图片会在以下条件下被清理：

1. 订单状态为 `shipped` 或 `processing`（已发货）
2. 发货时间早于当前时间10天
3. 订单有高清图片文件

### 清理流程

1. **检查订单**: 查找符合条件的订单
2. **记录信息**: 记录清理信息到日志文件
3. **删除文件**: 删除本地高清图片文件
4. **更新数据库**: 清空 `hd_image` 字段（保留订单记录）
5. **备份到云端**: 如果配置了百度云，自动备份文件

## 备份和恢复

### 备份功能

- 自动备份清理的图片到百度云
- 记录备份状态和路径
- 支持备份失败重试

### 恢复功能

```bash
# 恢复指定订单的图片
python baidu_cloud_backup.py
# 选择 "4. 恢复图片"
# 输入订单号
```

### 备份状态

- `pending`: 等待备份
- `completed`: 备份完成
- `failed`: 备份失败
- `skipped`: 跳过备份（文件不存在）

## 监控和日志

### 查看清理日志

```bash
python smart_image_cleanup.py
# 选择查看清理日志选项
```

### 查看备份状态

```bash
python baidu_cloud_backup.py
# 选择 "5. 查看备份状态"
```

### 查看任务日志

```bash
python scheduled_cleanup.py --log
```

## 配置选项

### 清理配置

在 `smart_image_cleanup.py` 中可调整：

```python
self.hd_cleanup_days = 10  # 高清图片发货后10天清理
```

### 备份配置

在 `baidu_cloud_backup.py` 中可调整：

```python
"backup_folder": "/pet_painting_backup",  # 百度云备份目录
"auto_backup": True,  # 是否自动备份
"backup_retention_days": 365  # 备份保留天数
```

## 文件结构

```
pet-painting-system/
├── smart_image_cleanup.py      # 智能清理器
├── baidu_cloud_backup.py       # 百度云备份
├── scheduled_cleanup.py         # 定时任务
├── image_cleanup_log.json       # 清理日志
├── baidu_cloud_config.json     # 百度云配置
├── cleanup_task_log.json        # 任务日志
└── hd_images/                   # 高清图片目录
```

## 注意事项

1. **数据安全**: 清理前确保已备份重要数据
2. **网络连接**: 百度云备份需要稳定的网络连接
3. **存储空间**: 定期检查本地和云端存储空间
4. **权限设置**: 确保脚本有文件读写权限
5. **定时任务**: 建议在服务器空闲时间执行清理任务

## 故障排除

### 常见问题

1. **清理失败**: 检查文件权限和磁盘空间
2. **备份失败**: 检查百度云配置和网络连接
3. **定时任务不执行**: 检查任务计划程序配置
4. **数据库错误**: 确保数据库连接正常

### 日志分析

查看相关日志文件：
- `image_cleanup_log.json`: 清理记录
- `cleanup_task_log.json`: 任务执行记录
- 控制台输出: 实时执行状态

## 技术支持

如遇到问题，请检查：
1. 日志文件中的错误信息
2. 网络连接状态
3. 文件权限设置
4. 数据库连接状态

系统会自动记录详细的执行日志，便于问题诊断和解决。




