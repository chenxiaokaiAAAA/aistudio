# è®¢å•å…³è”åŠ ç›Ÿå•†åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å½“ç”¨æˆ·é€šè¿‡å°ç¨‹åºä¸‹å•æ—¶ï¼Œå¦‚æœè®¢å•æ²¡æœ‰å…³è”åŠ ç›Ÿå•†ï¼ˆæ¯”å¦‚ç”¨æˆ·æ²¡æœ‰æ‰«æåŠ ç›Ÿå•†äºŒç»´ç ï¼‰ï¼Œç³»ç»Ÿå¯ä»¥åœ¨ç”¨æˆ·åˆ°è‡ªæ‹æœºæ ¸é”€æ—¶ï¼Œé€šè¿‡è‡ªæ‹æœºåºåˆ—å·è‡ªåŠ¨å…³è”åˆ°å¯¹åº”çš„åŠ ç›Ÿå•†å’Œé—¨åº—ã€‚

## ğŸ”„ å·¥ä½œæµç¨‹

### åœºæ™¯1ï¼šç”¨æˆ·ä¸‹å•æ—¶å·²å…³è”åŠ ç›Ÿå•†ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
1. ç”¨æˆ·åœ¨å°ç¨‹åºä¸‹å•æ—¶æ‰«æäº†åŠ ç›Ÿå•†äºŒç»´ç 
2. è®¢å•åˆ›å»ºæ—¶è‡ªåŠ¨å…³è”åŠ ç›Ÿå•†ï¼Œè®°å½•é—¨åº—å’Œè‡ªæ‹æœºä¿¡æ¯
3. ç”¨æˆ·åˆ°è‡ªæ‹æœºæ ¸é”€æ—¶ï¼Œè®¢å•å·²ç»æœ‰å…³è”ä¿¡æ¯

### åœºæ™¯2ï¼šç”¨æˆ·ä¸‹å•æ—¶æœªå…³è”åŠ ç›Ÿå•†ï¼ˆæ–°å¢é€»è¾‘ï¼‰â­
1. ç”¨æˆ·åœ¨å°ç¨‹åºä¸‹å•æ—¶**æ²¡æœ‰**æ‰«æåŠ ç›Ÿå•†äºŒç»´ç 
2. è®¢å•åˆ›å»ºæ—¶ `franchisee_id` ä¸ºç©ºï¼Œ`store_name` å’Œ `selfie_machine_id` ä¹Ÿä¸ºç©º
3. ç”¨æˆ·åˆ°è‡ªæ‹æœºæ ¸é”€æ—¶ï¼š
   - å®‰å“APPåœ¨è°ƒç”¨æ ¸é”€æ¥å£æ—¶ï¼Œä¼ é€’è‡ªæ‹æœºåºåˆ—å·ï¼ˆ`machineSerialNumber`ï¼‰
   - åç«¯é€šè¿‡è‡ªæ‹æœºåºåˆ—å·æŸ¥æ‰¾å¯¹åº”çš„åŠ ç›Ÿå•†
   - å¦‚æœæ‰¾åˆ°ï¼Œè‡ªåŠ¨æ›´æ–°è®¢å•çš„ `franchisee_id`ã€`store_name`ã€`selfie_machine_id` ç­‰å­—æ®µ
4. ç”¨æˆ·æ‹æ‘„å®Œæˆåä¸Šä¼ ç…§ç‰‡æ—¶ï¼Œå¦‚æœè®¢å•ä»æœªå…³è”ï¼Œä¼šå†æ¬¡å°è¯•å…³è”

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æ ¸é”€æ¥å£ (`/api/miniprogram/order/check`)

**æ–°å¢å‚æ•°ï¼š**
- `machineSerialNumber` (å¯é€‰): è‡ªæ‹æœºåºåˆ—å·
- `machine_serial_number` (å¯é€‰): è‡ªæ‹æœºåºåˆ—å·ï¼ˆå¤‡ç”¨å‚æ•°åï¼‰
- `selfie_machine_id` (å¯é€‰): è‡ªæ‹æœºåºåˆ—å·ï¼ˆå¤‡ç”¨å‚æ•°åï¼‰

**é€»è¾‘ï¼š**
```python
# å¦‚æœè®¢å•è¿˜æ²¡æœ‰å…³è”åŠ ç›Ÿå•†ï¼Œä¸”æä¾›äº†è‡ªæ‹æœºåºåˆ—å·
if not order.franchisee_id and machine_serial_number:
    # é€šè¿‡è‡ªæ‹æœºåºåˆ—å·æŸ¥æ‰¾å¯¹åº”çš„åŠ ç›Ÿå•†
    franchisee = FranchiseeAccount.query.filter_by(
        machine_serial_number=machine_serial_number,
        status='active'
    ).first()
    
    if franchisee:
        # æ›´æ–°è®¢å•çš„åŠ ç›Ÿå•†ä¿¡æ¯
        order.franchisee_id = franchisee.id
        order.store_name = franchisee.store_name
        order.selfie_machine_id = machine_serial_number
        order.external_platform = franchisee.machine_name or 'miniprogram'
        order.external_order_number = machine_serial_number
        db.session.commit()
```

### 2. ä¸Šä¼ ç…§ç‰‡æ¥å£ (`/api/miniprogram/order/upload`)

**æ–°å¢å‚æ•°ï¼š**
- `machineSerialNumber` (å¯é€‰): è‡ªæ‹æœºåºåˆ—å·ï¼ˆé€šè¿‡ `request.form` ä¼ é€’ï¼‰

**é€»è¾‘ï¼š**
- ä¸æ ¸é”€æ¥å£ç›¸åŒçš„å…³è”é€»è¾‘
- å¦‚æœæ ¸é”€æ—¶æ²¡æœ‰æä¾›åºåˆ—å·ï¼Œåœ¨ä¸Šä¼ ç…§ç‰‡æ—¶ä»å¯ä»¥å…³è”

## ğŸ“± å®‰å“APPé›†æˆ

### éœ€è¦ä¿®æ”¹çš„åœ°æ–¹

å®‰å“APPéœ€è¦åœ¨è°ƒç”¨æ ¸é”€å’Œä¸Šä¼ æ¥å£æ—¶ï¼Œä¼ é€’è‡ªæ‹æœºåºåˆ—å·ï¼š

#### 1. æ ¸é”€æ¥å£è°ƒç”¨

```java
// åœ¨è°ƒç”¨ /api/miniprogram/order/check æ—¶
String machineSerialNumber = getMachineSerialNumber(); // è·å–è‡ªæ‹æœºåºåˆ—å·
String url = baseUrl + "/api/miniprogram/order/check?orderId=" + orderId 
           + "&machineSerialNumber=" + machineSerialNumber;
```

#### 2. ä¸Šä¼ ç…§ç‰‡æ¥å£è°ƒç”¨

```java
// åœ¨è°ƒç”¨ /api/miniprogram/order/upload æ—¶
String machineSerialNumber = getMachineSerialNumber(); // è·å–è‡ªæ‹æœºåºåˆ—å·

// ä½¿ç”¨ multipart/form-data
RequestBody requestBody = new MultipartBody.Builder()
    .setType(MultipartBody.FORM)
    .addFormDataPart("orderId", orderId)
    .addFormDataPart("machineSerialNumber", machineSerialNumber) // æ–°å¢
    .addFormDataPart("photos", filename, fileBody)
    .build();
```

## ğŸ“Š è®¢å•å­—æ®µæ›´æ–°

å½“é€šè¿‡è‡ªæ‹æœºåºåˆ—å·å…³è”åŠ ç›Ÿå•†æ—¶ï¼Œä»¥ä¸‹å­—æ®µä¼šè¢«æ›´æ–°ï¼š

| è®¢å•å­—æ®µ | æ¥æº | è¯´æ˜ |
|---------|------|------|
| `franchisee_id` | `FranchiseeAccount.id` | åŠ ç›Ÿå•†ID |
| `store_name` | `FranchiseeAccount.store_name` | é—¨åº—åç§° |
| `selfie_machine_id` | ä¼ å…¥çš„ `machine_serial_number` | è‡ªæ‹æœºåºåˆ—å· |
| `external_platform` | `FranchiseeAccount.machine_name` | è‡ªæ‹æœºåç§°ï¼ˆå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ 'miniprogram'ï¼‰ |
| `external_order_number` | ä¼ å…¥çš„ `machine_serial_number` | è‡ªæ‹æœºåºåˆ—å· |

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è‡ªæ‹æœºåºåˆ—å·å¿…é¡»å”¯ä¸€**: æ¯ä¸ªè‡ªæ‹æœºçš„åºåˆ—å·å¿…é¡»åœ¨ `franchisee_accounts` è¡¨ä¸­å”¯ä¸€ï¼Œä¸”å¯¹åº”çš„åŠ ç›Ÿå•†çŠ¶æ€ä¸º `active`

2. **å…³è”æ—¶æœº**: 
   - ä¼˜å…ˆåœ¨æ ¸é”€æ—¶å…³è”ï¼ˆ`/api/miniprogram/order/check`ï¼‰
   - å¦‚æœæ ¸é”€æ—¶æ²¡æœ‰æä¾›åºåˆ—å·ï¼Œä¼šåœ¨ä¸Šä¼ ç…§ç‰‡æ—¶å†æ¬¡å°è¯•å…³è”ï¼ˆ`/api/miniprogram/order/upload`ï¼‰

3. **ä¸ä¼šè¦†ç›–å·²æœ‰å…³è”**: å¦‚æœè®¢å•å·²ç»å…³è”äº†åŠ ç›Ÿå•†ï¼ˆ`franchisee_id` ä¸ä¸ºç©ºï¼‰ï¼Œä¸ä¼šå› ä¸ºæä¾›äº†ä¸åŒçš„è‡ªæ‹æœºåºåˆ—å·è€Œæ›´æ”¹å…³è”å…³ç³»

4. **é”™è¯¯å¤„ç†**: å¦‚æœé€šè¿‡åºåˆ—å·æ‰¾ä¸åˆ°å¯¹åº”çš„åŠ ç›Ÿå•†ï¼Œä¸ä¼šé˜»æ­¢æ ¸é”€æˆ–ä¸Šä¼ æµç¨‹ï¼Œåªæ˜¯ä¸ä¼šå…³è”åŠ ç›Ÿå•†

## ğŸ” è°ƒè¯•å’Œæ—¥å¿—

å½“æˆåŠŸå…³è”åŠ ç›Ÿå•†æ—¶ï¼Œåç«¯ä¼šè¾“å‡ºæ—¥å¿—ï¼š
```
âœ… è®¢å• PET123456789 å·²é€šè¿‡è‡ªæ‹æœºåºåˆ—å· MACHINE001 å…³è”åˆ°åŠ ç›Ÿå•†: å¦é—¨SMå•†åŸ (é—¨åº—: å¦é—¨SMå•†åŸ)
```

å¦‚æœå…³è”å¤±è´¥ï¼Œä¼šè¾“å‡ºè­¦å‘Šæ—¥å¿—ï¼š
```
âš ï¸  é€šè¿‡è‡ªæ‹æœºåºåˆ—å·å…³è”åŠ ç›Ÿå•†å¤±è´¥: [é”™è¯¯ä¿¡æ¯]
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·åœ¨å°ç¨‹åºä¸‹å•ï¼Œåˆ°"å¦é—¨SMå•†åŸ"çš„è‡ªæ‹æœºæ ¸é”€

1. **ç”¨æˆ·åœ¨å°ç¨‹åºä¸‹å•**
   - è®¢å•å·: `PET123456789`
   - `franchisee_id`: `NULL`
   - `store_name`: `NULL`
   - `selfie_machine_id`: `NULL`

2. **ç”¨æˆ·åˆ°è‡ªæ‹æœºæ ¸é”€**
   - è‡ªæ‹æœºåºåˆ—å·: `MACHINE_SM_001`
   - å®‰å“APPè°ƒç”¨: `GET /api/miniprogram/order/check?orderId=PET123456789&machineSerialNumber=MACHINE_SM_001`

3. **åç«¯è‡ªåŠ¨å…³è”**
   - æŸ¥æ‰¾ `machine_serial_number = 'MACHINE_SM_001'` çš„åŠ ç›Ÿå•†
   - æ‰¾åˆ°: `FranchiseeAccount(id=1, company_name='å¦é—¨SMå•†åŸ', store_name='å¦é—¨SMå•†åŸ', machine_serial_number='MACHINE_SM_001')`
   - æ›´æ–°è®¢å•:
     - `franchisee_id`: `1`
     - `store_name`: `'å¦é—¨SMå•†åŸ'`
     - `selfie_machine_id`: `'MACHINE_SM_001'`
     - `external_platform`: `'è‡ªæ‹æœº001'` (å¦‚æœè®¾ç½®äº† `machine_name`)

4. **ç®¡ç†åå°æŸ¥çœ‹**
   - è®¢å•åˆ—è¡¨çš„"æ¥æºï¼ˆé—¨åº—ï¼‰"åˆ—æ˜¾ç¤º: `å¦é—¨SMå•†åŸ`
   - è®¢å•è¯¦æƒ…çš„"é—¨åº—"å­—æ®µæ˜¾ç¤º: `å¦é—¨SMå•†åŸ`
   - è®¢å•è¯¦æƒ…çš„"è‡ªæ‹æœºåç§°"å­—æ®µæ˜¾ç¤º: `è‡ªæ‹æœº001`
   - è®¢å•è¯¦æƒ…çš„"è‡ªæ‹æœºåºåˆ—å·"å­—æ®µæ˜¾ç¤º: `MACHINE_SM_001`

## âœ… å®ŒæˆçŠ¶æ€

- [x] åç«¯æ ¸é”€æ¥å£æ”¯æŒæ¥æ”¶è‡ªæ‹æœºåºåˆ—å·
- [x] åç«¯ä¸Šä¼ æ¥å£æ”¯æŒæ¥æ”¶è‡ªæ‹æœºåºåˆ—å·
- [x] é€šè¿‡è‡ªæ‹æœºåºåˆ—å·æŸ¥æ‰¾åŠ ç›Ÿå•†é€»è¾‘
- [x] è‡ªåŠ¨æ›´æ–°è®¢å•çš„åŠ ç›Ÿå•†å’Œé—¨åº—ä¿¡æ¯
- [ ] å®‰å“APPé›†æˆï¼ˆéœ€è¦å®‰å“å¼€å‘äººå‘˜ä¿®æ”¹ï¼‰
- [ ] æµ‹è¯•éªŒè¯
