# 小程序前端修复说明

## 问题描述

由于安全修复，订单查询接口现在**必须使用openid**，不再支持手机号查询。

## 修复方案

### 1. 获取用户openid

在小程序启动时获取用户的openid：

```javascript
// 在app.js或页面onLoad中
wx.login({
  success: function(res) {
    if (res.code) {
      // 调用后端接口获取openid
      wx.request({
        url: 'https://photogooo/api/user/openid',
        method: 'POST',
        data: { 
          code: res.code 
        },
        success: function(result) {
          if (result.data.data.success) {
            const openid = result.data.data.openid;
            // 保存到本地存储
            wx.setStorageSync('userOpenId', openid);
            console.log('获取openid成功:', openid);
          }
        },
        fail: function(error) {
          console.error('获取openid失败:', error);
        }
      });
    }
  }
});
```

### 2. 修改订单查询代码

**修改前（错误的方式）**：
```javascript
// ❌ 这种方式已被禁用
wx.request({
  url: 'https://photogooo/api/miniprogram/orders',
  data: {
    phone: '13799319030'  // 不再支持
  },
  success: function(res) {
    // 处理订单数据
  }
});
```

**修改后（正确的方式）**：
```javascript
// ✅ 使用openid查询
const openid = wx.getStorageSync('userOpenId');
if (openid) {
  wx.request({
    url: 'https://photogooo/api/miniprogram/orders',
    data: {
      openid: openid  // 使用openid
    },
    success: function(res) {
      if (res.data.status === 'success') {
        const orders = res.data.orders;
        console.log('查询到订单:', orders);
        // 处理订单数据
      }
    },
    fail: function(error) {
      console.error('查询订单失败:', error);
    }
  });
} else {
  console.error('未获取到openid，请重新登录');
}
```

### 3. 修改作品查询代码

同样需要修改作品查询接口：

```javascript
// ✅ 使用openid查询作品
const openid = wx.getStorageSync('userOpenId');
if (openid) {
  wx.request({
    url: 'https://photogooo/api/miniprogram/works',
    data: {
      openid: openid  // 使用openid
    },
    success: function(res) {
      if (res.data.status === 'success') {
        const works = res.data.works;
        console.log('查询到作品:', works);
        // 处理作品数据
      }
    }
  });
}
```

### 4. 完整的用户登录流程

```javascript
// 完整的用户登录和初始化流程
function initUser() {
  // 1. 获取openid
  wx.login({
    success: function(loginRes) {
      if (loginRes.code) {
        wx.request({
          url: 'https://photogooo/api/user/openid',
          method: 'POST',
          data: { code: loginRes.code },
          success: function(openidRes) {
            if (openidRes.data.data.success) {
              const openid = openidRes.data.data.openid;
              wx.setStorageSync('userOpenId', openid);
              
              // 2. 注册或更新用户信息
              wx.request({
                url: 'https://photogooo/api/user/register',
                method: 'POST',
                data: {
                  openId: openid,
                  userInfo: {
                    nickName: '用户昵称',
                    avatarUrl: '头像URL'
                  }
                },
                success: function(registerRes) {
                  console.log('用户注册/更新成功');
                  // 3. 查询用户订单
                  queryUserOrders(openid);
                }
              });
            }
          }
        });
      }
    }
  });
}

function queryUserOrders(openid) {
  wx.request({
    url: 'https://photogooo/api/miniprogram/orders',
    data: { openid: openid },
    success: function(res) {
      if (res.data.status === 'success') {
        const orders = res.data.orders;
        console.log('用户订单:', orders);
        // 更新页面数据
      }
    }
  });
}
```

## 注意事项

1. **openid是唯一的**：每个微信用户对应一个唯一的openid
2. **openid不会变化**：同一用户在不同设备上的openid是相同的
3. **需要重新登录**：用户需要重新进入小程序以获取openid
4. **向后兼容**：已存在的订单数据不受影响，只是查询方式改变

## 测试验证

修复后，用户应该能够：
1. 正常获取openid
2. 成功查询到自己的订单
3. 无法查询到其他用户的订单
4. 手机号查询被正确拒绝

## 错误处理

如果遇到问题，请检查：
1. 是否正确获取了openid
2. 是否将openid保存到了本地存储
3. 查询时是否使用了正确的参数名（openid而不是phone）
4. 网络请求是否成功

