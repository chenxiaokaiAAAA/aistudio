# 充值赠送功能数据安全性说明

## ✅ 不会影响原有数据

### 1. 新字段都有默认值

```python
bonus_amount = db.Column(db.Float, default=0.0)  # 默认值是0
```

所有旧的充值记录，`bonus_amount` 自动为 0，不会影响原有数据。

### 2. 数据库迁移脚本保护

迁移脚本会：
- ✅ 检查字段是否已存在（避免重复迁移）
- ✅ 为旧记录设置默认值（`bonus_amount = 0`）
- ✅ 将旧记录的 `total_amount` 设置为原来的 `amount`（保证逻辑一致）

### 3. 兼容性处理

#### 旧数据表现：
```sql
-- 旧的充值记录（迁移后）
amount = 1000
bonus_amount = 0        ← 自动设为0
total_amount = 1000     ← 等于 amount
```

#### 新数据表现：
```sql
-- 新的充值记录
amount = 1000
bonus_amount = 200      ← 新功能
total_amount = 1200     ← amount + bonus_amount
```

### 4. 不影响加盟商视图

- **旧记录显示**：`+¥1000`（和之前完全一样）
- **新记录显示**：`+¥1000`（如果有赠送，加盟商看不到）

## 🔒 数据迁移流程

```
1. 检查表是否存在 → 如果不存在，跳过
2. 检查字段是否已存在 → 如果已存在，跳过
3. 添加新字段（带默认值0）
4. 更新旧记录：bonus_amount = 0
5. 更新旧记录：total_amount = amount
6. 提交事务
```

## ⚠️ 注意事项

### 完全安全：
- ✅ 旧数据不会丢失
- ✅ 旧数据不会改变
- ✅ 只是添加新字段
- ✅ 所有字段都有默认值
- ✅ 可以随时回滚

### 如果出问题：
```sql
-- 如果迁移失败，可以手动回滚：
-- 注意：SQLite 不支持 DROP COLUMN，但可以：
-- 1. 备份旧表
-- 2. 重新创建表（使用旧字段）
-- 3. 恢复数据
```

## 🧪 测试建议

1. **备份数据库**
   ```bash
   copy pet_painting.db pet_painting.db.backup
   ```

2. **运行迁移脚本**
   ```bash
   python add_franchisee_bonus_migration.py
   ```

3. **检查数据**
   ```sql
   SELECT amount, bonus_amount, total_amount FROM franchisee_recharges LIMIT 5;
   ```

4. **恢复（如果需要）**
   ```bash
   copy pet_painting.db.backup pet_p献血ing.db
   ```

## 📊 实际效果

### 迁移前后对比

| 字段 | 迁移前 | 迁移后 |
|------|--------|--------|
| amount | 1000 | 1000 ✅ 不变 |
| bonus_amount | ❌ 不存在 | 0 ✅ 自动添加 |
| total_amount | ❌ 不存在 | 1000 ✅ 等于amount |
| 余额 | 1000 | 1000 ✅ 不变 |

## ✅ 总结

**完全不会影响原有数据！**

- 新字段都有默认值
- 旧记录自动填充默认值
- 加盟商看到的数据完全一样
- 可以安全运行迁移



