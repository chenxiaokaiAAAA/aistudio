# 管理后台统计和筛选功能修改说明

## 📋 修改内容

### 1. 顶部统计卡片修改

**修改前：**
- 总订单数
- 小程序订单
- 网页订单
- 加盟商订单

**修改后：**
- ✅ **总订单数**（保留）
- ❌ **小程序订单**（已取消）
- ✅ **每日订单**（今天创建的订单数，原"网页订单"）
- ✅ **每日业绩总额**（今天完成的订单总金额，原"加盟商订单"）

### 2. 订单来源筛选修改

**修改前：**
- 全部来源
- 小程序
- 网页版
- 加盟商

**修改后：**
- ✅ **全部门店**（默认）
- ✅ **按加盟商（门店）筛选**：显示所有已添加的加盟商列表

**说明：**
- 不再显示"小程序"、"网页版"等选项
- 所有订单都来自小程序，通过门店（加盟商）来区分
- 默认显示全部订单

### 3. 订单列表显示修改

**修改前：**
- 来源列显示：小程序、网页版、加盟商等

**修改后：**
- 来源列显示：
  - 如果有门店（franchisee_id），显示门店名称（加盟商公司名称）
  - 如果有自拍机名称（external_platform），显示自拍机名称
  - 否则显示"未分配门店"

### 4. 订单详情字段说明修改

**修改前：**
- 商家：显示商家用户名
- 外部渠道：显示外部渠道名称
- 外部订单号：显示外部订单号

**修改后：**
- ✅ **门店**：显示门店名称（优先显示加盟商公司名称，其次显示商家用户名）
- ✅ **自拍机名称**：原"外部渠道"字段，显示自拍机的机器名称
- ✅ **自拍机序列号**：原"外部订单号"字段，显示自拍机的序列号

## 🔧 技术实现

### 后端修改（`test_server.py`）

#### 1. 统计计算逻辑

```python
# 总订单数（保持不变）
total_orders = Order.query.filter(Order.status != 'unpaid').count()

# 每日订单数（今天创建的订单）
today = datetime.now().date()
daily_orders = Order.query.filter(
    db.func.date(Order.created_at) == today,
    Order.status != 'unpaid'
).count()

# 每日业绩总额（今天完成的订单总金额）
daily_revenue = Order.query.filter(
    db.func.date(Order.completed_at) == today,
    Order.status == 'completed'
).with_entities(db.func.sum(Order.price)).scalar() or 0.0
```

#### 2. 筛选逻辑修改

```python
# 获取筛选参数
franchisee_id = request.args.get('franchisee_id', '')  # 改为按加盟商ID筛选

# 按加盟商（门店）筛选
if franchisee_id:
    query = query.filter(Order.franchisee_id == int(franchisee_id))

# 获取所有加盟商（门店）列表
franchisees = FranchiseeAccount.query.filter_by(status='active').order_by(FranchiseeAccount.company_name).all()
```

#### 3. 预加载关系优化

```python
# 使用joinedload预加载franchisee_account关系，避免N+1查询
from sqlalchemy.orm import joinedload
orders = query.options(joinedload(Order.franchisee_account)).order_by(Order.created_at.desc()).all()
```

### 前端修改（`templates/admin/dashboard.html`）

#### 1. 统计卡片

```html
<!-- 修改为3列布局 -->
<div class="col-md-4">
    <div class="card bg-primary text-white">
        <h5 class="card-title">总订单数</h5>
        <h3>{{ total_orders }}</h3>
    </div>
</div>
<div class="col-md-4">
    <div class="card bg-info text-white">
        <h5 class="card-title">每日订单</h5>
        <h3>{{ daily_orders }}</h3>
    </div>
</div>
<div class="col-md-4">
    <div class="card bg-warning text-white">
        <h5 class="card-title">每日业绩总额</h5>
        <h3>¥{{ '%.2f'|format(daily_revenue) }}</h3>
    </div>
</div>
```

#### 2. 筛选器

```html
<select class="form-select" id="franchisee_id" name="franchisee_id">
    <option value="">全部门店</option>
    {% for franchisee in franchisees %}
    <option value="{{ franchisee.id }}">{{ franchisee.company_name }}</option>
    {% endfor %}
</select>
```

#### 3. 订单列表来源显示

```html
{% if order.franchisee_id and order.franchisee_account %}
    <span class="badge bg-warning">{{ order.franchisee_account.company_name }}</span>
{% elif order.external_platform %}
    <span class="badge bg-info">{{ order.external_platform }}</span>
{% else %}
    <span class="badge bg-secondary">未分配门店</span>
{% endif %}
```

### 订单详情修改（`templates/admin/order_details.html`）

```html
<p><strong>门店:</strong> 
    {% if order.franchisee_id and order.franchisee_account %}
        {{ order.franchisee_account.company_name }}
    {% elif order.merchant %}
        {{ order.merchant.username }}
    {% else %}
        无
    {% endif %}
</p>

<p><strong>自拍机名称:</strong> {{ order.external_platform or '—' }}</p>
<p><strong>自拍机序列号:</strong> {{ order.external_order_number or '—' }}</p>
```

## 📝 字段说明

### 订单模型字段映射

| 显示名称 | 数据库字段 | 说明 |
|---------|-----------|------|
| 门店 | `franchisee_id` → `FranchiseeAccount.company_name` | 订单所属门店（加盟商） |
| 自拍机名称 | `external_platform` | 自拍机的机器名称 |
| 自拍机序列号 | `external_order_number` | 自拍机的序列号 |

### 未来扩展

根据需求，未来订单将包含：
- **门店信息**：通过 `franchisee_id` 关联到 `FranchiseeAccount`
- **自拍机ID**：通过 `external_platform` 和 `external_order_number` 存储
- **门店+自拍机ID**：用于判断是哪家门店、哪台设备产生的订单

## ⚠️ 注意事项

1. **每日订单数**：统计的是今天创建的订单（`created_at`），排除未支付订单
2. **每日业绩总额**：统计的是今天完成的订单总金额（`completed_at`），只统计状态为`completed`的订单
3. **订单来源筛选**：现在按门店（加盟商）筛选，不再按来源类型（小程序/网页版）筛选
4. **订单列表来源显示**：优先显示门店名称，如果没有门店则显示自拍机名称，都没有则显示"未分配门店"

## 📍 加盟商管理页面访问

**访问路径：** `/franchisee/admin/accounts`

**访问方式：**
1. 在管理后台首页左侧菜单中，点击"🏢 加盟商管理"
2. 或直接访问：`http://你的服务器地址/franchisee/admin/accounts`

**功能说明：**
- 查看所有加盟商账户列表
- 添加新加盟商
- 编辑加盟商信息
- 为加盟商充值
- 查看加盟商详情和订单统计

**注意：** 只有管理员（`role='admin'`）才能看到"加盟商管理"菜单项。

## 🔄 后续开发计划（待实现）

以下功能是**计划中的功能**，目前**尚未实现**：

1. **加盟商管理页面增强**（待开发）：
   - 添加门店信息字段（目前只有公司名称）
   - 添加自拍机名称字段（目前没有此字段）
   - 添加自拍机序列号字段（目前没有此字段）
   - 一个加盟商可以管理多个门店
   - 一个门店可以有多台自拍机

2. **订单记录增强**（待开发）：
   - 确保每个订单都记录门店信息（目前通过`franchisee_id`关联）
   - 确保每个订单都记录自拍机ID（目前通过`external_platform`和`external_order_number`存储）
   - 通过门店+自拍机ID判断订单来源

3. **数据迁移**（待开发）：
   - 将现有订单的`external_platform`和`external_order_number`正确映射到自拍机信息
   - 将现有订单的`franchisee_id`正确关联到门店

## ✅ 测试要点

1. **统计卡片**：
   - 验证总订单数正确显示
   - 验证每日订单数正确计算（今天创建的订单）
   - 验证每日业绩总额正确计算（今天完成的订单总金额）

2. **筛选功能**：
   - 验证可以按门店筛选订单
   - 验证默认显示全部订单
   - 验证筛选后订单列表正确更新

3. **订单列表**：
   - 验证来源列正确显示门店名称
   - 验证没有门店的订单显示"未分配门店"

4. **订单详情**：
   - 验证门店字段正确显示
   - 验证自拍机名称和序列号正确显示
