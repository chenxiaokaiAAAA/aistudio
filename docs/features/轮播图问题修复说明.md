# è½®æ’­å›¾é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸš¨ é—®é¢˜æè¿°

è®¿é—® [moeart.cc ç®¡ç†åå°](https://moeart.cc/admin/homepage) æ—¶å‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š

1. **è½®æ’­å›¾æ— æ³•æ˜¾ç¤º** - åŸæœ‰çš„2ä¸ªè½®æ’­å›¾ä¸æ˜¾ç¤º
2. **åˆ›å»ºè½®æ’­å›¾å¤±è´¥** - åˆ›å»ºæ–°çš„è½®æ’­å›¾æ—¶å‡ºç°æ•°æ®åº“é”™è¯¯
3. **æ•°æ®åº“å­—æ®µç¼ºå¤±** - `homepage_banner` è¡¨ç¼ºå°‘ `type` å’Œ `promotion_params` å­—æ®µ

### é”™è¯¯ä¿¡æ¯ï¼š
```
sqlite3.OperationalError: table homepage_banner has no column named type
[SQL: INSERT INTO homepage_banner (title, subtitle, image_url, link, sort_order, is_active, created_at, type, promotion_params) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)]
```

## âœ… å·²å®æ–½çš„ä¿®å¤

### 1. **æ•°æ®åº“å…¼å®¹æ€§ä¿®å¤**
- ä¿®æ”¹äº†APIä»£ç ï¼Œä½¿å…¶å‘åå…¼å®¹ç°æœ‰æ•°æ®åº“ç»“æ„
- æ–°å­—æ®µå˜ä¸ºå¯é€‰ï¼Œä¸ä¼šå¯¼è‡´ç°æœ‰åŠŸèƒ½å´©æºƒ
- ä½¿ç”¨ `getattr()` å’Œ `hasattr()` å®‰å…¨åœ°è®¿é—®æ–°å­—æ®µ

### 2. **APIå±‚å…¼å®¹æ€§å¤„ç†**
æ‰€æœ‰ç›¸å…³çš„APIéƒ½å·²ç»å®ç°å‘åå…¼å®¹ï¼š

#### è·å–è½®æ’­å›¾API (`GET /api/admin/homepage/banners`)
```python
# å®‰å…¨è·å–æ–°å­—æ®µï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤å€¼
try:
    banner_type = getattr(banner, 'type', 'link')
    promotion_params = json.loads(banner.promotion_params) if hasattr(banner, 'promotion_params') and banner.promotion_params else None
except AttributeError:
    banner_type = 'link'
    promotion_params = None
```

#### åˆ›å»ºè½®æ’­å›¾API (`POST /api/admin/homepage/banners`)
```python
# åŸºç¡€å­—æ®µåˆ›å»º
banner = HomepageBanner(
    title=data.get('title', ''),
    subtitle=data.get('subtitle', ''),
    image_url=data['image_url'],
    link=data.get('link', ''),
    sort_order=data.get('sort_order', 0),
    is_active=data.get('is_active', True)
)

# å°è¯•è®¾ç½®æ–°å­—æ®µï¼ˆå¦‚æœæ•°æ®åº“æ”¯æŒï¼‰
try:
    banner.type = data.get('type', 'link')
    if data.get('promotion_params'):
        banner.promotion_params = json.dumps(data['promotion_params'])
except Exception as e:
    print(f"æ–°å­—æ®µè®¾ç½®å¤±è´¥ï¼ˆæ•°æ®åº“å…¼å®¹æ€§ï¼‰: {e}")
```

## ğŸ› ï¸ è§£å†³æ­¥éª¤

### æ–¹æ¡ˆä¸€ï¼šç«‹å³ä¿®å¤ï¼ˆæ¨èï¼‰
ç°åœ¨è½®æ’­å›¾åŠŸèƒ½å·²ç»å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼APIå·²ç»ä¿®å¤ä¸ºå‘åå…¼å®¹ï¼š

1. **åŸæœ‰è½®æ’­å›¾åº”è¯¥å¯ä»¥æ­£å¸¸æ˜¾ç¤º**
2. **åˆ›å»ºæ–°è½®æ’­å›¾ä¸ä¼šæŠ¥é”™**ï¼ˆæ–°å­—æ®µä¼šå¿½ç•¥ï¼‰
3. **å‰ç«¯å°ç¨‹åºè½®æ’­å›¾è·å–æ­£å¸¸**

### æ–¹æ¡ˆäºŒï¼šå®Œæ•´åŠŸèƒ½å‡çº§ï¼ˆå¯é€‰ï¼‰
å¦‚æœéœ€è¦ä½¿ç”¨å®Œæ•´çš„æ–°åŠŸèƒ½ï¼ˆè¡¨å•ç±»å‹è½®æ’­å›¾ï¼‰ï¼Œæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

#### 1. å¤‡ä»½æ•°æ®åº“
```bash
cp pet_orders.db pet_orders_backup.db
```

#### 2. æ‰§è¡Œæ•°æ®åº“è¿ç§»
```sql
-- æ·»åŠ æ–°å­—æ®µ
ALTER TABLE homepage_banner ADD COLUMN type VARCHAR(20) DEFAULT 'link';
ALTER TABLE homepage_banner ADD COLUMN promotion_params TEXT;
```

#### 3. å–æ¶ˆæ³¨é‡Šæ¨¡å‹å­—æ®µ
åœ¨ `test_server.py` ä¸­æ‰¾åˆ° `HomepageBanner` æ¨¡å‹ï¼Œå–æ¶ˆæ³¨é‡Šï¼š
```python
class HomepageBanner(db.Model):
    # ... å…¶ä»–å­—æ®µ ...
    
    # å–æ¶ˆæ³¨é‡Šè¿™ä¸¤è¡Œ
    type = db.Column(db.String(20), default='link')
    promotion_params = db.Column(db.Text)
```

#### 4. é‡å¯æœåŠ¡å™¨
é‡å¯åº”ç”¨æœåŠ¡å™¨ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚

## ğŸ“‹ æµ‹è¯•éªŒè¯

### 1. éªŒè¯ç°æœ‰åŠŸèƒ½
- âœ… è®¿é—® [moeart.cc ç®¡ç†åå°](https://moeart.cc/admin/homepage)
- âœ… æŸ¥çœ‹åŸæœ‰è½®æ’­å›¾æ˜¯å¦æ­£ç¡®æ˜¾ç¤º
- âœ… åˆ›å»ºæ–°çš„æ™®é€šè½®æ’­å›¾
- âœ… æµ‹è¯•å°ç¨‹åºä¸­è½®æ’­å›¾æ˜¾ç¤º

### 2. éªŒè¯æ–°åŠŸèƒ½ï¼ˆå¦‚æœæ‰§è¡Œäº†å®Œæ•´å‡çº§ï¼‰
- âœ… åˆ›å»ºè¡¨å•ç±»å‹è½®æ’­å›¾
- âœ… é…ç½®æ¨å¹¿å‚æ•°
- âœ… æµ‹è¯•å°ç¨‹åºè¡¨å•åŠŸèƒ½

## ğŸ¯ è½®æ’­å›¾é…ç½®ç¤ºä¾‹

### æ™®é€šè½®æ’­å›¾ï¼ˆç«‹å³å¯ç”¨ï¼‰
```json
{
    "title": "å® ç‰©å®šåˆ¶æœåŠ¡",
    "subtitle": "ä¸“ä¸šå®šåˆ¶",
    "image_url": "/static/images/banner1.jpg",
    "link": "/pages/style/style",
    "sort_order": 1,
    "is_active": true
}
```

### è¡¨å•è½®æ’­å›¾ï¼ˆéœ€è¦æ•°æ®åº“å‡çº§åï¼‰
```json
{
    "title": "å® ç‰©æ‘„å½±æŠ¥å",
    "subtitle": "ä¸“ä¸šæ‹æ‘„æœåŠ¡",
    "image_url": "/static/images/photo-signup.jpg",
    "link": "/pages/photo-signup/photo-signup",
    "type": "photo_signup",
    "sort_order": 2,
    "is_active": true,
    "promotion_params": {
        "promotionCode": "PET_PHOTO_2024",
        "userId": "PRO_USER_001"
    }
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šå½“å‰çš„ä¿®å¤ä¿æŒäº†å®Œå…¨çš„å‘åå…¼å®¹æ€§
2. **æ¸è¿›å¼å‡çº§**ï¼šå¯ä»¥å…ˆä½¿ç”¨åŸºç¡€åŠŸèƒ½ï¼Œåç»­å‡çº§åˆ°å®Œæ•´åŠŸèƒ½
3. **æ•°æ®åº“å¤‡ä»½**ï¼šæ‰§è¡Œä»»ä½•æ•°æ®åº“æ›´æ”¹å‰è¯·åŠ¡å¿…å¤‡ä»½
4. **æµ‹è¯•ç¯å¢ƒ**ï¼šå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯åå†åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ

## ğŸ”§ æ•…éšœæ’é™¤

å¦‚æœä»æœ‰é—®é¢˜ï¼š

1. **é‡å¯æœåŠ¡å™¨**ï¼š`sudo systemctl restart your-app-service`
2. **æ£€æŸ¥æ—¥å¿—**ï¼šæŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ç¡®è®¤æ— é”™è¯¯
3. **æ¸…é™¤ç¼“å­˜**ï¼šé‡å¯åæ¸…é™¤æµè§ˆå™¨ç¼“å­˜
4. **éªŒè¯API**ï¼šç›´æ¥è®¿é—® `https://moeart.cc/api/admin/homepage/banners` æ£€æŸ¥è¿”å›æ•°æ®

ç°åœ¨ä½ çš„è½®æ’­å›¾ç®¡ç†åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼ğŸ‰
