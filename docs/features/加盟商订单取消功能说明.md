# 加盟商订单取消功能说明

## 🎯 功能概述

管理员可以在加盟商详情页面中取消加盟商的订单，取消后会自动返还扣除的资金到加盟商账户。

## ✨ 功能特点

- ✅ **自动返还资金** - 取消订单后，扣除的金额自动返还到加盟商账户
- ✅ **记录取消原因** - 可以填写取消原因，便于追溯
- ✅ **状态保护** - 已完成的订单不能取消
- ✅ **完整记录** - 取消操作会记录到充值记录中
- ✅ **实时反馈** - 操作后立即刷新页面显示最新状态

## 📍 使用位置

**管理后台 → 加盟商管理 → 加盟商详情 → 订单记录标签页**

## 🚀 使用步骤

### 1. 进入加盟商详情页面
- 登录管理后台
- 点击左侧菜单"🏢 加盟商管理"
- 找到要操作的加盟商，点击"详情"

### 2. 找到要取消的订单
- 点击"订单记录"标签页
- 在订单列表中找到需要取消的订单

### 3. 点击取消订单按钮
- 找到目标订单的"操作"列
- 点击红色的"取消订单"按钮

### 4. 确认取消
- 弹出确认对话框
- 显示订单号和将返还的金额
- （可选）填写取消原因
- 点击"确认取消"

### 5. 完成
- 系统自动返还资金
- 订单状态变为"已取消"
- 页面自动刷新显示最新状态

## 💰 资金返还说明

### 返还金额
- 返还金额 = 订单扣除金额（franchisee_deduction）
- 如果没有扣除金额，则返还订单总价

### 账户更新
- page退款金额会自动加到"剩余额度"中
- 同时从"已用额度"中扣除

### 记录保存
- 退款记录会保存在"充值记录"中
- 记录类型显示为"退款"
- 记录说明包含取消原因

## ⚠️ 注意事项

### 不能取消的订单
- ❌ 已取消的订单
- ❌ 已完成的订单（status = 'completed'）
- ❌ 已发货的订单（status = 'shipped'）

### 可以取消的订单
- ✅ 待制作（pending）
- ✅ 处理中（processing）
- ✅ 高清放大（hd_ready）
- ✅ 厂家制作中（manufacturing）

## 📊 状态变化

```
订单状态: pending/processing → cancelled
账户额度: remaining_quota + 退款金额
充值记录: 新增一条"退款"类型记录
```

## 🔍 查看退款记录

### 方法1：在加盟商详情页面
1. 进入加盟商详情
2. 点击"充值记录"标签页
3. 可以看到退款记录（类型显示为"退款"）

### 方法2：充值记录格式
```
充值金额: +¥99.00
类型: [退款]
操作员: admin
说明: 订单 PET20250101001 取消退款 - 客户下错订单，重新下单
时间: 2025-01-01 14:30
```

## 💡 使用场景

### 场景1：客户下错订单
**情况**: 加盟商客户选错了产品尺寸
**操作**: 取消订单 → 填写原因"客户选错尺寸，重新下单"
**结果**: 资金返还，客户可以重新下单

### 场景2：重复订单
**情况**: 客户不小心提交了两次相同的订单
**操作**: 取消其中一个订单 → 填写原因"重复订单"
**结果**: 退回多余的扣除

### 场景3：客户要求取消
**情况**: 客户改变主意，要求取消订单
**操作**: 取消订单 → 填写原因"客户要求取消"
**结果**: 完成客户需求

## 🎨 界面说明

### 订单列表显示
- 待取消的订单：显示红色"取消订单"按钮
- 已取消的订单：状态显示为红色的"已取消"标签
- 不能取消的订单：显示"查看"按钮

### 取消确认对话框
```
┌─────────────────────────────┐
│  取消订单              [×]  │
├─────────────────────────────┤
│  订单号: PET20250101001     │
│  将返还金额: ¥99.00         │
│                             │
│  取消原因:                  │
│  [_______________________]  │
│  [_______________________]  │
│                             │
│        [取消]  [确认取消]    │
└─────────────────────────────┘
```

## 🛠️ 技术实现

### API接口
- **路径**: `/franchisee/api/cancel-order/<order_id>`
- **方法**: POST
- **权限**: 仅管理员
- **参数**: `{ "reason": "取消原因" }`

### 执行流程
1. 验证订单是否属于加盟商
2. 检查订单状态是否允许取消
3. 返还资金到加盟商账户
4. 记录退款到充值记录
5. 更新订单状态为'cancelled'
6. 提交数据库变更

### 安全检查
- ✅ 只有管理员可以取消订单
- ✅ 只能取消加盟商订单
- ✅ 不能取消已完成/已发货订单
- ✅ 自动记录操作日志

---

**创建时间**: 2025-01-01  
**版本**: 1.0  
**状态**: ✅ 已上线


