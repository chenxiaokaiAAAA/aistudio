# 加盟商月度报表导出功能

## 📋 功能概述

为加盟商管理添加了月度报表导出功能，管理员可以导出指定月份所有加盟商的充值、赠送、消费和余额统计数据。

## ✨ 功能特点

- ✅ 按月导出加盟商数据
- ✅ 统计当月充值金额
- ✅ 统计当月赠送金额
- ✅ 统计当月消费金额
- ✅ 显示当前余额
- ✅ 包含完整的额度信息
- ✅ CSV格式，Excel完美兼容

## 🚀 使用方法

### 1. 访问导出功能

1. 登录管理员后台
2. 进入 **加盟商管理**
3. 点击右上角 **📥 导出月度报表** 按钮
4. 在弹出的对话框中输入要导出的月份（格式：YYYY-MM）
5. 点击确定，自动下载CSV文件

### 2. 导出示例

**输入月份**：`2025-01`

**导出的文件**：`franchisee_report_2025-01.csv`

## 📊 导出字段说明

CSV文件包含以下字段：

| 字段 | 说明 |
|------|------|
| 公司名称 | 加盟商公司名称 |
| 用户名 | 加盟商登录用户名 |
| 联系人 | 联系人姓名 |
| 联系电话 | 联系电话 |
| **当月充值金额** | 当月实际充值金额（不包含赠送） |
| **当月赠送金额** | 当月赠送的金额 |
| **当月消费金额** | 当月消费/扣除的金额 |
| **当前余额** | 当前剩余额度 |
| 总额度 | 历史累计总额度 |
| 已使用额度 | 累计已使用额度 |
| 剩余额度 | 当前剩余额度 |
| 状态 | 账户状态（正常/未激活/已暂停） |

## 💡 使用场景

### 财务对账
- 按月导出加盟商的充值、消费数据
- 核对财务收支情况
- 分析加盟商的活跃度

### 报表分析
- 统计各加盟商的充值情况
- 对比不同月份的消费趋势
- 评估赠送活动的效果

### 数据备份
- 定期导出月度数据作为备份
- 方便后续查询和分析

## 📝 使用示例

### 导出2025年1月的数据

1. 点击 **📥 导出月度报表** 按钮
2. 在对话框中输入：`2025-01`
3. 点击确定
4. 文件自动下载：`franchisee_report_2025-01.csv`

### 导出当前月份数据

1. 点击 **📥 导出月度报表** 按钮
2. 直接点击确定（使用默认月份）
3. 文件自动下载

## 🔧 技术实现

### 后端路由

```python
@franchisee_bp.route('/admin/accounts/export')
```

**功能**：
- 根据月份参数查询数据
- 统计当月充值、赠送、消费金额
- 生成CSV文件
- 返回文件下载响应

### 数据统计逻辑

1. **当月充值金额**：查询当月所有 `FranchiseeRecharge.amount` 的总和
2. **当月赠送金额**：查询当月所有 `FranchiseeRecharge.bonus_amount` 的总和
3. **当月消费金额**：查询当月所有 `Order.franchisee_deduction` 的总和
4. **当前余额**：直接使用 `account.remaining_quota`

### 前端功能

```javascript
function exportMonthlyReport() {
    // 提示用户输入月份
    // 验证月份格式
    // 触发下载
}
```

## 📋 导出数据示例

```csv
公司名称,用户名,联系人,联系电话,当月充值金额,当月赠送金额,当月消费金额,当前余额,总额度,已使用额度,剩余额度,状态
北京宠物有限公司,bj001,张三,13800138000,1000.00,200.00,500.00,700.00,5000.00,4300.00,700.00,active
上海萌宠馆,sh001,李四,13900139000,2000.00,0.00,1500.00,500.00,8000.00,7500.00,500.00,active
```

## ⚠️ 注意事项

1. **月份格式**：必须使用 `YYYY-MM` 格式，例如：`2025-01`
2. **时区说明**：数据统计基于服务器时区
3. **数据范围**：只统计指定月份的数据
4. **Excel兼容**：CSV文件使用 UTF-8 with BOM 编码，Excel可以完美打开

## 🎯 权限控制

- 仅管理员（admin）可以访问导出功能
- 其他角色访问会被重定向到管理后台

---

**更新日期**: 2025-01-20  
**版本**: 1.0



