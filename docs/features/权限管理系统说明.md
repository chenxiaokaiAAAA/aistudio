# 权限管理系统说明

## 🎯 角色概述

系统现在支持三种角色：

### 1. admin (超级管理员)
- ✅ 所有权限
- ✅ 可以管理加盟商
- ✅ 可以充值
- ✅ 可以取消订单
- ✅ 全部功能

### 2. operator (营运管理员) 🆕
- ✅ 可以管理订单
- ✅ 可以管理产品、风格
- ✅ 可以查看统计数据
- ✅ 可以导出数据
- ✅ 可以手动填写快递物流信息（包括加盟商订单）
- ❌ 不能管理加盟商
- ❌ 不能充值
- ❌ 不能取消加盟商订单

### 3. merchant (商家)
- ✅ 查看自己的订单
- ✅ 管理自己的信息
- ❌ 不能访问管理后台

---

## 👤 已创建的账户

### 营运管理员账户
- **用户名**: `operator`
- **密码**: `operator123`
- **角色**: `operator`
- **权限**: 受限管理员

### 超级管理员账户
- **用户名**: `admin`
- **密码**: `admin123`
- **角色**: `admin`
- **权限**: 全部权限

---

## 🔒 权限控制清单

### operator 不能访问的功能

#### 加盟商管理相关
- ❌ `/franchisee/admin/accounts` - 加盟商列表
- ❌ `/franchisee/admin/accounts/add` - 添加加盟商
- ❌ `/franchisee/admin/accounts/<id>/recharge` - 充值
- ❌ `/franchisee/admin/accounts/<id>/edit` - 编辑加盟商
- ❌ `/franchisee/admin/accounts/<id>` - 加盟商详情
- ❌ `/franchisee/api/cancel-order/<id>` - 取消加盟商订单

#### 系统管理相关
- ❌ `/admin/cleanup` - 清理过期图片
- ❌ 其他需要超级管理员权限的功能

### operator 可以访问的功能

#### 订单管理
- ✅ 查看所有订单
- ✅ 查看订单详情
- ✅ 导出订单数据
- ✅ 更新订单状态
- ✅ 手动填写快递物流信息（包括加盟商订单）
- ✅ `/admin/order/<id>/manual-logistics` - 手动录入快递单号
- ❌ 删除订单（需确认是否为受限功能）

#### 产品管理
- ✅ 管理产品尺寸
- ✅ 管理产品价格
- ✅ 上传产品图片

#### 风格管理
- ✅ 管理艺术风格
- ✅ 上传风格图片
- ✅ 设置风格分类

#### 数据统计
- ✅ 查看订单统计
- ✅ 查看收益统计
- ✅ 导出数据

---

## 📝 使用说明

### 以营运管理员身份登录

1. 访问登录页面
2. 输入用户名: `operator`
3. 输入密码: `operator123`
4. 登录后会进入管理后台
5. 可以看到所有订单、产品等
6. 但看不到"加盟商管理"菜单

### 以超级管理员身份登录

1. 访问登录页面
2. 输入用户名: `admin`
3. 输入密码: `admin123`
4. 登录后拥有全部权限
5. 包括加盟商管理和充值功能

---

## 🔧 技术实现

### 角色定义
```python
# User 模型
role = db.Column(db.String(20), nullable=False)  
# 可选值: 'admin', 'operator', 'merchant'
```

### 权限检查

**旧方式**:
```python
if current_user.role != 'admin':
    return redirect(url_for('admin_dashboard'))
```

**新方式** (加盟商功能):
```python
if current_user.role != 'admin':  # 只有超级管理员
    flash('权限不足', 'error')
    return redirect(url_for('admin_dashboard'))
```

**未来改进**:
```python
from permission_helpers import can_manage_franchisee

if not can_manage_franchisee(current_user):
    flash('权限不足：此功能需要超级管理员权限', 'error')
    return redirect(url_for('admin_dashboard'))
```

---

## 🚀 后续扩展

### 可以添加的权限控制

1. **订单删除权限** - 某些管理员不能删除订单
2. **价格修改权限** - 只有特定管理员可以修改价格
3. **数据导出权限** - 限制谁可以导出敏感数据
4. **日志查看权限** - 限制查看系统日志的权限

### 添加新角色的步骤

1. 修改 User 模型的注释
2. 更新登录逻辑
3. 在需要权限控制的地方添加检查
4. 更新前端菜单显示

---

## ✅ 已完成的功能

- ✅ 创建营运管理员角色
- ✅ 创建营运管理员账户 (`operator`)
- ✅ 更新用户模型支持新角色
- ✅ 更新登录逻辑
- ✅ 限制加盟商管理功能（仅超级管理员）
- ✅ 限制充值功能（仅超级管理员）
- ✅ 开通营运管理员手动填写快递物流信息权限

---

## 📊 菜单可见性

### operator 看到的菜单
- 订单管理 ✅
- 签约商家管理 ✅
- 风格管理 ✅
- 产品配置 ✅
- 宠物摄影报名 ✅
- 作品展示管理 ✅
- 小程序分佣管理 ✅
- 优惠券管理 ✅
- ~~加盟商管理~~ ❌ (不显示)
- ~~清理过期图片~~ ❌ (不显示)

---

**创建时间**: 2025-01-01  
**版本**: 1.0  
**状态**: ✅ 已上线


