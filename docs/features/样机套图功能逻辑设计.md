# 样机套图功能 - 整体功能逻辑设计

## 一、背景与目标

将独立的「样机套图」脚本（基于 psd-tools + Pillow，支持 PSD 智能对象替换）集成到 AI-STUDIO 项目中，实现：

1. **管理后台**：在产品导航下新增「样机套图」配置页面，管理 PSD 模板及与产品的绑定关系
2. **选片流程**：当用户选中的产品绑定了样机模板时，在选片页面/选片后模块提供「样机预览」能力
3. **可扩展**：后续可灵活调整植入位置（选片页内 / 选片后独立模块）

---

## 二、现有样机脚本能力

| 能力 | 说明 |
|------|------|
| PSD 模板扫描 | 扫描目录下所有 `.psd` 文件，自动检测智能对象图层 |
| 智能对象替换 | 优先使用名为 `photogo` 的智能对象，否则取第一个 |
| 图片适配 | 用户原图等比例缩放 + 中心裁剪，适配智能对象尺寸，无拉伸 |
| 输出格式 | 支持 PSD（保留图层）或 JPG（扁平图） |
| 依赖 | `psd-tools`、`Pillow`、`streamlit`（集成时改为 Flask API） |

---

## 三、整体功能逻辑架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           管理后台（产品管理）                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  产品管理  │  商城产品  │  样机套图  ← 新增入口                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        样机套图配置页面                                      │
│  • 上传/配置 PSD 模板（路径、智能图层名、预览图）                             │
│  • 模板 ↔ 产品 多对多绑定（如：挂画相框.psd ↔ 相框产品）                     │
│  • 启用/禁用、排序                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        选片流程（用户侧）                                    │
│                                                                             │
│  选片列表 → 选片详情（选图片 + 选产品 + 选尺寸）                              │
│                    │                                                        │
│                    ▼                                                        │
│  【方案 A】选片详情页内：若订单中已选产品有绑定样机 → 显示「样机预览」按钮     │
│  【方案 B】选片后模块：选片完成 → 进入样机预览/生成环节（可后续实现）          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        样机预览 / 生成                                       │
│  • 用户选择一张已选图片 + 选择一个可用样机模板                                │
│  • 后端调用 psd-tools 替换智能对象 → 生成套图                                │
│  • 返回 JPG 预览 / 下载                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、数据模型设计

### 4.1 样机模板表 `mockup_templates`

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| name | String(100) | 模板名称（如「挂画相框」「抱枕」） |
| psd_path | String(500) | PSD 文件路径（相对或绝对） |
| smart_layer_name | String(100) | 智能对象图层名（默认 `photogo`） |
| preview_image_url | String(500) | 预览图 URL（可选，用于管理端展示） |
| is_active | Boolean | 是否启用 |
| sort_order | Integer | 排序 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 4.2 模板-产品绑定表 `mockup_template_products`

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键 |
| template_id | Integer | 样机模板 ID |
| product_id | Integer | 产品 ID（关联 `products` 表） |
| created_at | DateTime | 创建时间 |

- 唯一约束：`(template_id, product_id)` 不重复
- 一个模板可绑定多个产品，一个产品可绑定多个模板

---

## 五、管理后台功能

### 5.1 导航入口

- 位置：**产品管理** 下拉菜单
- 新增菜单项：`样机套图` → `/admin/mockup-templates`
- 权限：复用 `products` 权限（或新增 `mockup_templates` 权限）

### 5.2 样机套图配置页面

| 功能 | 说明 |
|------|------|
| 模板列表 | 展示所有 PSD 模板，支持启用/禁用、排序、删除 |
| 添加模板 | 上传 PSD 或填写 PSD 路径，自动解析智能对象图层名 |
| 编辑模板 | 修改名称、智能图层名、预览图 |
| 绑定产品 | 为每个模板选择可绑定的产品（多选，从现有产品库选择） |
| 预览 | 使用占位图或实际 PSD 渲染图作为预览 |

### 5.3 技术实现要点

- PSD 文件存储：建议统一放在项目目录下（如 `data/mockup_templates/`），路径存相对路径
- 智能图层解析：复用样机脚本中的 `scan_psd_templates()` 逻辑，在添加/编辑时自动检测

---

## 六、选片流程植入逻辑

### 6.1 判断「是否显示样机预览」

```
订单中已选产品 ID 列表 = 从选片数据中提取（selected_images → products → product_id）
可用样机模板 = 根据 product_id 查询 mockup_template_products 得到 template_id 列表
若 可用样机模板 非空 → 显示「样机预览」入口
```

### 6.2 方案 A：选片详情页内植入

- 位置：选片详情页（`photo_selection_detail.html`）右侧产品/尺寸选择区域附近
- 触发条件：当前订单中至少有一个已选产品绑定了样机模板
- 交互：增加「样机预览」按钮或折叠面板，点击后弹出/展开样机选择与预览区域

### 6.3 方案 B：选片后独立模块（后续）

- 位置：选片确认后、支付前的中间环节，或作为选片完成后的附加功能
- 流程：选片完成 → 进入「样机套图」步骤 → 用户选择图片+模板 → 生成套图 → 可下载或加入订单附件

### 6.4 推荐实现顺序

1. 先实现 **方案 A**（选片详情页内），开发量小、验证流程快
2. 后续若需要更独立体验，再实现 **方案 B**

---

## 七、样机生成 API 设计

### 7.1 获取订单可用样机模板

```
GET /api/admin/mockup/order/<order_id>/templates
响应：{ "code": 0, "data": [ { "id", "name", "preview_image_url", "smart_layer_name" }, ... ] }
逻辑：根据订单选片中的 product_id 查询绑定的模板
```

### 7.2 生成样机套图

```
POST /api/admin/mockup/generate
请求：{ "template_id": 1, "image_url": "选片图片URL或本地路径", "output_format": "jpg" }
响应：{ "code": 0, "data": { "preview_url": "...", "download_url": "..." } }
逻辑：调用 psd-tools 替换智能对象，保存到临时/媒体目录，返回访问 URL
```

### 7.3 依赖与部署

- 将 `psd-tools`、`Pillow` 加入项目 `requirements.txt`
- 样机生成逻辑封装为独立服务（如 `app/services/mockup_service.py`），便于复用和测试

---

## 八、文件结构建议

```
app/
├── models.py                    # 新增 MockupTemplate, MockupTemplateProduct
├── routes/
│   ├── admin_routes.py          # 新增 /admin/mockup-templates 页面路由
│   └── admin_mockup_api.py      # 新增 样机 CRUD、绑定产品、生成套图 API
├── services/
│   └── mockup_service.py        # 样机生成核心逻辑（复用样机脚本 replace 函数）
templates/admin/
├── mockup_templates.html        # 样机套图配置页面
templates/admin/
└── photo_selection_detail.html  # 增加样机预览入口（方案 A）
```

---

## 九、实施步骤建议

| 步骤 | 内容 | 优先级 |
|------|------|--------|
| 1 | 数据模型：MockupTemplate、MockupTemplateProduct，迁移脚本 | 高 |
| 2 | 管理后台：导航入口 + 样机套图配置页面（CRUD + 产品绑定） | 高 |
| 3 | 样机服务：mockup_service 封装 PSD 替换逻辑 | 高 |
| 4 | API：获取订单可用模板、生成套图 | 高 |
| 5 | 选片详情页：根据产品绑定显示「样机预览」按钮，调用生成 API | 高 |
| 6 | 选片后独立模块（方案 B） | 低，后续迭代 |

---

## 十、与现有样机脚本的对应关系

| 样机脚本 | 集成后 |
|----------|--------|
| `scan_psd_templates()` | 管理端添加模板时调用，或定时扫描目录 |
| `replace_psd_smart_object()` | `mockup_service.generate_mockup()` 核心逻辑 |
| Streamlit 上传/选择 | 改为 Flask 接口，选片图片来自订单已选图片 |
| 模板选择下拉框 | 管理端配置 + 选片页根据产品动态展示 |

---

## 十一、注意事项

1. **PSD 路径**：生产环境需考虑 PSD 文件存储位置（本地/OSS），路径需可配置
2. **性能**：PSD 替换为 CPU 密集型，可考虑异步任务队列（如 Celery）处理大批量
3. **安全**：生成接口需校验订单归属、权限，防止越权访问
4. **临时文件**：生成后的 JPG 及时清理或按策略保留

---

*文档版本：v1.0 | 创建日期：2026-02-07*
