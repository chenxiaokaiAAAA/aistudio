# 问题修复说明

## 修复的问题

### 1. ✅ 路由路径错误

**问题**：访问 `/admin/api-provider-config` 返回404

**原因**：实际路由是 `/admin/ai-provider/config`

**修复**：
- 修复了 `templates/admin/styles.html` 中的链接
- 从 `/admin/api-provider-config` 改为 `/admin/ai-provider/config`

### 2. ✅ 导航栏跳转登录页问题

**问题**：多个管理页面点击左上角后跳转到登录页

**原因**：导航栏链接设置为 `href="/"`，应该指向 `/admin/dashboard`

**修复**：
- `templates/admin/styles.html`：`href="/"` → `href="/admin/dashboard"`
- `templates/admin/ai_tasks.html`：`href="/"` → `href="/admin/dashboard"`
- `templates/admin/meitu_tasks.html`：`href="/"` → `href="/admin/dashboard"`

### 3. ✅ 数据库字段缺失问题

**问题**：`no such column: api_provider_configs.is_sync_api`

**原因**：数据库表缺少 `is_sync_api` 字段

**修复方案**：

#### 方案1：手动运行迁移脚本（推荐）

```bash
cd AI-studio
python scripts/database/add_is_sync_api_field.py instance/pet_painting.db
```

#### 方案2：自动迁移（已添加）

在 `app/routes/ai_provider.py` 的 `get_api_configs()` 函数中添加了自动检测和迁移逻辑：
- 如果检测到字段不存在，自动执行迁移
- 添加字段并设置默认值

#### 方案3：重启服务器

`test_server.py` 中的 `migrate_database()` 函数会在启动时自动检查并添加字段（7306-7319行）。

**迁移脚本功能**：
1. 检查 `api_provider_configs` 表是否存在
2. 检查 `is_sync_api` 字段是否存在
3. 如果不存在，添加字段：`BOOLEAN DEFAULT 0 NOT NULL`
4. 根据 `api_type` 自动设置值：`gemini-native` 类型设为 `1`（同步API）

## 验证修复

### 1. 验证路由

访问以下URL应该能正常打开：
- ✅ `http://127.0.0.1:8000/admin/ai-provider/config` - API服务商配置页面
- ✅ `http://127.0.0.1:8000/admin/styles` - 风格管理页面
- ✅ `http://127.0.0.1:8000/admin/ai/tasks` - AI任务管理页面
- ✅ `http://127.0.0.1:8000/admin/meitu/tasks` - 美图任务管理页面

### 2. 验证导航栏

点击各页面的左上角"AI自拍机-后台"链接，应该跳转到 `/admin/dashboard` 而不是登录页。

### 3. 验证数据库字段

**方法1：通过API验证**
访问 `http://127.0.0.1:8000/admin/ai-provider/config`，应该能正常加载配置列表，不再报错。

**方法2：通过SQL验证**
```sql
PRAGMA table_info(api_provider_configs);
```
应该能看到 `is_sync_api` 字段。

**方法3：通过Python验证**
```python
from test_server import db, APIProviderConfig
config = APIProviderConfig.query.first()
print(hasattr(config, 'is_sync_api'))  # 应该返回 True
```

## 如果问题仍然存在

### 数据库字段仍然缺失

1. **检查数据库文件路径**：
   ```python
   # 在 test_server.py 中查看数据库路径
   print(db.engine.url)
   ```

2. **手动执行SQL**：
   ```sql
   ALTER TABLE api_provider_configs ADD COLUMN is_sync_api BOOLEAN DEFAULT 0 NOT NULL;
   UPDATE api_provider_configs SET is_sync_api = 1 WHERE api_type = 'gemini-native';
   ```

3. **检查迁移是否执行**：
   - 查看服务器启动日志，应该看到 "is_sync_api 字段添加成功"
   - 如果没有，检查 `migrate_database()` 函数是否被调用

### 路由仍然404

1. **检查Blueprint注册**：
   ```python
   # 在 test_server.py 中应该看到
   from app.routes.ai_provider import ai_provider_bp
   app.register_blueprint(ai_provider_bp)
   ```

2. **检查路由前缀**：
   ```python
   # ai_provider.py 中
   ai_provider_bp = Blueprint('ai_provider', __name__, url_prefix='/admin/ai-provider')
   ```

3. **重启服务器**：确保新的路由被注册

## 修复文件清单

1. ✅ `templates/admin/styles.html` - 修复API配置链接和导航栏
2. ✅ `templates/admin/ai_tasks.html` - 修复导航栏
3. ✅ `templates/admin/meitu_tasks.html` - 修复导航栏
4. ✅ `app/routes/ai_provider.py` - 添加自动迁移逻辑

## 注意事项

1. **数据库备份**：在执行迁移前，建议先备份数据库
2. **重启服务器**：修复后需要重启服务器才能生效
3. **权限检查**：确保数据库文件有写入权限

---

**修复时间**：2025-01-XX  
**修复版本**：v1.0
