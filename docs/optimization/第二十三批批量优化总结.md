# 第二十三批批量优化总结

**优化日期**: 2026-02-05  
**状态**: ✅ 已完成

---

## 🎯 优化目标

继续批量优化剩余接口的N+1查询问题。

---

## ✅ 已优化接口

### 1. 小程序商城产品列表接口优化 ✅

**文件**: `app/routes/miniprogram/shop.py` - `miniprogram_get_shop_products()`

**问题**:
- 在循环中为每个产品查询ShopProductImage和ShopProductSize
- N+1查询：1次查询产品 + N次查询图片 + N次查询规格

**优化前**:
```python
for product in products:
    images = ShopProductImage.query.filter_by(
        product_id=product.id, is_active=True
    ).order_by(ShopProductImage.sort_order.asc()).all()  # N次查询
    
    sizes = ShopProductSize.query.filter_by(
        product_id=product.id, is_active=True
    ).order_by(ShopProductSize.sort_order.asc()).all()  # N次查询
```

**优化后**:
```python
# 优化N+1查询：批量查询所有产品的图片和规格
product_ids = [product.id for product in products]
images_map = {}
sizes_map = {}

if product_ids:
    # 批量查询所有产品的图片（1次查询）
    all_images = ShopProductImage.query.filter(
        ShopProductImage.product_id.in_(product_ids),
        ShopProductImage.is_active == True
    ).order_by(ShopProductImage.sort_order.asc()).all()
    for img in all_images:
        if img.product_id not in images_map:
            images_map[img.product_id] = []
        images_map[img.product_id].append(img)
    
    # 批量查询所有产品的规格（1次查询）
    all_sizes = ShopProductSize.query.filter(
        ShopProductSize.product_id.in_(product_ids),
        ShopProductSize.is_active == True
    ).order_by(ShopProductSize.sort_order.asc()).all()
    for size in all_sizes:
        if size.product_id not in sizes_map:
            sizes_map[size.product_id] = []
        sizes_map[size.product_id].append(size)

# 从映射中获取数据（无额外查询）
for product in products:
    images = images_map.get(product.id, [])
    sizes = sizes_map.get(product.id, [])
```

**优化效果**:
- 查询次数：从 1 + 2N 次减少到 3 次
- 性能提升：预计 80-90%（当产品数量>10时）

---

### 2. 选片提交返回结果优化 ✅

**文件**: `app/routes/photo_selection.py` - `photo_selection_submit()`

**问题**:
- 在返回结果时，循环中查询ShopProductSize计算总价
- N+1查询：N次查询尺寸

**优化前**:
```python
'total_price': sum([float(ShopProductSize.query.get(so.size_id).price) * so.quantity 
                   for so in ShopOrder.query.filter(ShopOrder.order_number.in_(created_orders)).all() 
                   if so.size_id])
```

**优化后**:
```python
# 优化N+1查询：批量查询所有订单和尺寸，计算总价
total_price = 0
if created_orders and ShopOrder and ShopProductSize:
    shop_orders = ShopOrder.query.filter(ShopOrder.order_number.in_(created_orders)).all()
    if shop_orders:
        size_ids = [so.size_id for so in shop_orders if so.size_id]
        if size_ids:
            sizes_map = {s.id: s for s in ShopProductSize.query.filter(ShopProductSize.id.in_(size_ids)).all()}
            total_price = sum([float(sizes_map.get(so.size_id).price) * so.quantity 
                              for so in shop_orders 
                              if so.size_id and so.size_id in sizes_map])
```

**优化效果**:
- 查询次数：从 N 次减少到 2 次（1次订单 + 1次批量尺寸查询）
- 性能提升：预计 85-95%（当订单数量>10时）

---

### 3. 开始打印接口优化 ✅

**文件**: `app/routes/photo_selection.py` - `start_print()`

**问题**:
- 在循环中为每个商城订单查询ShopProduct和AITask
- N+1查询：N次查询产品 + N次查询AI任务

**优化前**:
```python
for shop_order in shop_orders:
    if ShopProduct and shop_order.product_id:
        product = ShopProduct.query.get(shop_order.product_id)  # N次查询
    
    if shop_order.original_order_id:
        tasks = AITask.query.filter_by(order_id=shop_order.original_order_id, status='completed').all()  # N次查询
```

**优化后**:
```python
# 优化N+1查询：批量查询所有产品信息和AI任务
ShopProduct = models.get('ShopProduct')
products_map = {}
if ShopProduct and shop_orders:
    product_ids = [so.product_id for so in shop_orders if so.product_id]
    if product_ids:
        all_products = ShopProduct.query.filter(ShopProduct.id.in_(product_ids)).all()
        for product in all_products:
            products_map[product.id] = product

# 批量查询所有订单的AI任务（避免N+1查询）
ai_tasks_map = {}
if AITask and shop_orders:
    original_order_ids = [so.original_order_id for so in shop_orders if so.original_order_id]
    if original_order_ids:
        all_ai_tasks = AITask.query.filter(
            AITask.order_id.in_(original_order_ids),
            AITask.status == 'completed'
        ).all()
        for task in all_ai_tasks:
            if task.order_id not in ai_tasks_map:
                ai_tasks_map[task.order_id] = []
            ai_tasks_map[task.order_id].append(task)

# 从映射中获取数据（无额外查询）
for shop_order in shop_orders:
    if shop_order.product_id and shop_order.product_id in products_map:
        product = products_map[shop_order.product_id]
    
    if shop_order.original_order_id and shop_order.original_order_id in ai_tasks_map:
        tasks = ai_tasks_map[shop_order.original_order_id]
```

**优化效果**:
- 查询次数：从 2N 次减少到 2 次（1次产品 + 1次AI任务）
- 性能提升：预计 85-95%（当订单数量>10时）

---

## 📊 优化统计

- **优化接口数**: 3个
- **解决N+1查询**: 5个（ShopProductImage、ShopProductSize、ShopProduct、AITask）
- **预计性能提升**: 80-95%（当数据量>10时）

---

## 🔄 下一步计划

继续查找和优化其他接口的N+1查询问题，重点关注：
1. 循环中的数据库查询
2. 缺少批量加载的关联数据查询
3. 缺少分页的大数据量查询
