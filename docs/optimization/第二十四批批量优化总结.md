# 第二十四批批量优化总结

**优化日期**: 2026-02-05  
**状态**: ✅ 已完成

---

## 🎯 优化目标

继续批量优化剩余接口的N+1查询问题。

---

## ✅ 已优化接口

### 1. 加盟商月度报表导出优化 ✅

**文件**: `app/routes/franchisee/admin.py` - `export_franchisee_monthly_report()`

**问题**:
- 在循环中为每个加盟商查询3次数据库（充值金额、赠送金额、消费金额）
- N+1查询：N次查询充值 + N次查询赠送 + N次查询消费

**优化前**:
```python
for account in accounts:
    # 当月充值金额（amount字段）
    recharge_amount = db.session.query(
        func.sum(FranchiseeRecharge.amount)
    ).filter(
        FranchiseeRecharge.franchisee_id == account.id,
        ...
    ).scalar() or 0  # N次查询
    
    # 当月赠送金额（bonus_amount字段）
    bonus_amount = db.session.query(
        func.sum(FranchiseeRecharge.bonus_amount)
    ).filter(
        FranchiseeRecharge.franchisee_id == account.id,
        ...
    ).scalar() or 0  # N次查询
    
    # 当月消费金额（扣除金额）
    consumption_amount = db.session.query(
        func.sum(Order.franchisee_deduction)
    ).filter(
        Order.franchisee_id == account.id,
        ...
    ).scalar() or 0  # N次查询
```

**优化后**:
```python
# 优化N+1查询：批量查询所有加盟商的统计数据
account_ids = [account.id for account in accounts]
recharge_stats_map = {}
bonus_stats_map = {}
consumption_stats_map = {}

if account_ids:
    # 批量查询所有加盟商的充值金额（1次查询）
    recharge_stats = db.session.query(
        FranchiseeRecharge.franchisee_id,
        func.sum(FranchiseeRecharge.amount).label('total_amount')
    ).filter(
        FranchiseeRecharge.franchisee_id.in_(account_ids),
        ...
    ).group_by(FranchiseeRecharge.franchisee_id).all()
    recharge_stats_map = {row[0]: float(row[1] or 0) for row in recharge_stats}
    
    # 批量查询所有加盟商的赠送金额（1次查询）
    bonus_stats = db.session.query(
        FranchiseeRecharge.franchisee_id,
        func.sum(FranchiseeRecharge.bonus_amount).label('total_bonus')
    ).filter(
        FranchiseeRecharge.franchisee_id.in_(account_ids),
        ...
    ).group_by(FranchiseeRecharge.franchisee_id).all()
    bonus_stats_map = {row[0]: float(row[1] or 0) for row in bonus_stats}
    
    # 批量查询所有加盟商的消费金额（1次查询）
    consumption_stats = db.session.query(
        Order.franchisee_id,
        func.sum(Order.franchisee_deduction).label('total_consumption')
    ).filter(
        Order.franchisee_id.in_(account_ids),
        ...
    ).group_by(Order.franchisee_id).all()
    consumption_stats_map = {row[0]: float(row[1] or 0) for row in consumption_stats}

# 从批量查询的映射中获取统计数据（无额外查询）
for account in accounts:
    recharge_amount = recharge_stats_map.get(account.id, 0)
    bonus_amount = bonus_stats_map.get(account.id, 0)
    consumption_amount = consumption_stats_map.get(account.id, 0)
```

**优化效果**:
- 查询次数：从 `3N` 次减少到 `3` 次
- 性能提升：预计 90-95%（当加盟商数量>10时）

---

### 2. 加盟商订单列表每日业绩计算优化 ✅

**文件**: `app/routes/franchisee/frontend.py` - `franchisee_orders()`

**问题**:
- 在循环中为每个订单号查询订单总金额
- N+1查询：N次查询订单总金额

**优化前**:
```python
completed_order_numbers = db.session.query(Order.order_number).filter(
    Order.franchisee_id == franchisee_id,
    func.date(Order.completed_at) == today,
    Order.status == 'completed'
).distinct().all()

daily_revenue = 0.0
for order_number_tuple in completed_order_numbers:
    order_number = order_number_tuple[0]
    # 计算该订单号下所有订单的总金额
    order_total = db.session.query(func.sum(Order.price)).filter(
        Order.franchisee_id == franchisee_id,
        Order.order_number == order_number
    ).scalar() or 0.0  # N次查询
    daily_revenue += float(order_total)
```

**优化后**:
```python
# 计算每日业绩总额（今天完成的订单总金额，使用数据库聚合函数，避免N+1查询）
daily_revenue = db.session.query(func.sum(Order.price)).filter(
    Order.franchisee_id == franchisee_id,
    func.date(Order.completed_at) == today,
    Order.status == 'completed'
).scalar() or 0.0
daily_revenue = float(daily_revenue)
```

**优化效果**:
- 查询次数：从 `1 + N` 次减少到 `1` 次
- 性能提升：预计 85-95%（当订单数量>10时）

---

## 📊 优化统计

- **优化接口数**: 2个
- **解决N+1查询**: 4个（FranchiseeRecharge充值、FranchiseeRecharge赠送、Order消费、Order每日业绩）
- **预计性能提升**: 85-95%（当数据量>10时）

---

## 🔄 下一步计划

继续查找和优化其他接口的N+1查询问题，重点关注：
1. 循环中的数据库查询
2. 缺少批量加载的关联数据查询
3. 缺少分页的大数据量查询
4. 循环中的统计计算（应使用数据库聚合函数）
