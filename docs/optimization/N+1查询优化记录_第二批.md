# N+1查询优化记录（第二批）

**优化日期**: 2026-02-04  
**状态**: ✅ 已完成

---

## 🎯 优化目标

继续优化高频接口的N+1查询问题，提升查询性能。

---

## ✅ 已优化接口

### 1. 小程序产品列表接口优化 ✅

**文件**: `app/routes/miniprogram/catalog.py` - `miniprogram_get_products()`

**问题**:
- 在循环中为每个产品查询尺寸、图片和风格分类
- N+1查询：1次查询产品 + N次查询尺寸 + N次查询图片 + N次查询风格分类

**优化前**:
```python
products = query.all()
for product in products:
    sizes = ProductSize.query.filter_by(product_id=product.id).all()  # N次查询
    product_images = ProductImage.query.filter_by(product_id=product.id).all()  # N次查询
    product_style_bindings = ProductStyleCategory.query.filter_by(product_id=product.id).all()  # N次查询
```

**优化后**:
```python
products = query.all()
product_ids = [product.id for product in products]

# 批量查询所有产品的尺寸（1次查询）
all_sizes = ProductSize.query.filter(ProductSize.product_id.in_(product_ids)).all()
sizes_map = {size.product_id: [] for size in all_sizes}
# ... 构建映射 ...

# 批量查询所有产品的图片（1次查询）
all_images = ProductImage.query.filter(ProductImage.product_id.in_(product_ids)).all()
# ... 构建映射 ...

# 批量查询所有产品的风格分类绑定（1次查询）
all_bindings = ProductStyleCategory.query.filter(ProductStyleCategory.product_id.in_(product_ids)).all()
# ... 构建映射 ...

# 从映射中获取数据（无额外查询）
for product in products:
    sizes = sizes_map.get(product.id, [])
    product_images = images_map.get(product.id, [])
    product_style_bindings = style_bindings_map.get(product.id, [])
```

**优化效果**:
- 查询次数：从 1 + 3N 次减少到 4 次
- 性能提升：预计 85-95%（当产品数量>10时）

---

### 2. 加盟商下单页面优化 ✅

**文件**: `app/routes/franchisee/frontend.py` - `franchisee_order()`

**问题**:
- 在循环中为每个产品查询尺寸、宠物选项和风格分类
- N+1查询：1次查询产品 + N次查询尺寸 + N*M次查询宠物选项 + N次查询风格分类

**优化前**:
```python
for product in products:
    sizes = ProductSize.query.filter_by(product_id=product.id).all()  # N次查询
    for size in sizes:
        pet_options = ProductSizePetOption.query.filter_by(size_id=size.id).all()  # N*M次查询
    product_style_relations = ProductStyleCategory.query.filter_by(product_id=product.id).all()  # N次查询
```

**优化后**:
```python
product_ids = [product.id for product in products]

# 批量查询所有产品的尺寸（1次查询）
all_sizes = ProductSize.query.filter(ProductSize.product_id.in_(product_ids)).all()
sizes_map = {size.product_id: [] for size in all_sizes}
# ... 构建映射 ...

# 批量查询所有尺寸的宠物选项（1次查询）
size_ids = [size.id for sizes in sizes_map.values() for size in sizes]
all_pet_options = ProductSizePetOption.query.filter(ProductSizePetOption.size_id.in_(size_ids)).all()
pet_options_map = {opt.size_id: [] for opt in all_pet_options}
# ... 构建映射 ...

# 批量查询所有产品的风格分类绑定（1次查询）
all_style_bindings = ProductStyleCategory.query.filter(ProductStyleCategory.product_id.in_(product_ids)).all()
# ... 构建映射 ...

# 从映射中获取数据（无额外查询）
for product in products:
    sizes = sizes_map.get(product.id, [])
    for size in sizes:
        pet_options = pet_options_map.get(size.id, [])
    product_style_relations = style_bindings_map.get(product.id, [])
```

**优化效果**:
- 查询次数：从 1 + N + N*M + N 次减少到 4 次
- 性能提升：预计 90-95%（当产品数量>10且每个产品有多个尺寸时）

---

## 📊 优化统计

### 已优化接口（第二批）
- ✅ 小程序产品列表接口（miniprogram/catalog.py）
- ✅ 加盟商下单页面（franchisee/frontend.py）

### 优化效果
- **查询次数减少**: 从 O(N) 或 O(N*M) 降到 O(1)
- **性能提升**: 预计 85-95%（当数据量>10时）
- **内存使用**: 略有增加（存储映射），但可接受

---

## 🔄 待优化接口

根据性能分析，还有约188个可能的N+1查询问题。建议继续优化高频接口。

---

**最后更新**: 2026-02-04  
**状态**: ✅ 已优化2个接口（第二批）
