# 产品馆 → 风格库 → 产品详情 交互流程

## 完整流程

```
产品馆(选择证件照) → 风格库(选风格) → 产品详情页(选规格) → 定制流程
```

## 数据流与字段

### 1. 产品馆选择证件照
- **触发**: 点击一级分类「证件照」
- **逻辑**: `isIdPhotoCategory()` 判断 → 查找该分类下的证件照产品
- **匹配条件**: `p.category_id === categoryId` 或 `p.categoryId === categoryId`
- **注意**: `categoryId` 来自 `data-category-id`，可能是字符串，需类型兼容

### 2. 跳转到风格库
- **传参**: `stylePageParams = { productCode, categoryId, categoryName, categoryCode }`
- **风格 API**: `GET /api/miniprogram/styles?productId={code}` 
- **匹配**: 风格分类通过 `categoryName`/`categoryCode` 匹配「证件照」

### 3. 风格库选择风格 → 产品详情
- **传参**: `productId`(即 productCode)、`styleId`、`styleName`、`styleCode`
- **产品详情**: 用 `productId` 在 products 中查找 `p.id == productId || p.code == productId`

### 4. API 返回格式（关键）

**产品 API** (`/api/miniprogram/products`) 返回:
```json
{
  "id": "idphoto-02",   // 当前用 code 作为 id
  "code": "idphoto-02",
  "category_id": 1,
  "subcategory_id": 2,
  ...
}
```

**风格 API** (`/api/miniprogram/styles?productId=idphoto-02`):
- 按产品 code 查找产品
- 返回该产品绑定的风格分类及图片
- 若 `style_image` 表无数据 → 显示「该分类下暂无风格」

## 迁移后需检查

1. **category_id 类型**: 前端 `categoryId` 可能为字符串，需 `Number()` 或宽松比较
2. **产品 id**: API 返回数字 id，前端查找需同时支持 `p.id` 和 `p.code`，且 dataset 返回字符串需用 `==` 宽松比较
3. **风格图片**: `style_image` 表需有数据，否则风格库/产品详情显示「该产品暂无可选风格」
4. **产品尺寸**: `product_sizes` 表需有数据，否则规格/尺寸选择区域不显示
5. **风格缓存**: 管理后台保存产品风格绑定后会自动清除该产品的风格缓存；也可调用 `GET /styles/refresh?productId=xxx` 手动清除
6. **接口与后台同步**: 产品、风格接口支持 `?refresh=1` 参数绕过缓存；产品馆、风格库、产品详情页默认带 `refresh=1` 确保与后台数据一致
7. **二级分类联动**: 产品馆选择二级分类后点击产品，跳转产品详情时会传 `subcategoryName`；产品详情按**映射**过滤风格（产品馆二级分类名 → 风格库二级分类名，两者独立，名称可不同；后续可在产品编辑页做绑定配置）
8. **风格图片需绑定二级分类**: 若过滤后仍显示全部风格，说明 `style_image` 表的 `subcategory_id` 未设置；需在管理后台「风格管理」→ 编辑风格分类 → 为每张风格图片选择对应的二级分类（女/男/儿童等）

## 二级分类未显示排查

若小程序中产品馆/风格库的二级分类未显示，可按以下步骤排查：

1. **运行接口测试**：`python scripts/tools/test_miniprogram_api.py`（需本地服务运行在 8000 端口）
   - 检查 `product-categories` 返回的 `二级分类数` 是否 > 0
   - 检查 `styles` 返回的 `subcats` 数量

2. **小程序调试**：打开微信开发者工具控制台，查看「处理后的分类数据」日志
   - 若 `subcategoriesCount` 为 0，说明接口返回空或请求的服务器与后台数据不一致

3. **接口修复**（已实施）：
   - `product-categories`：`is_active` 过滤改为包含 NULL（兼容历史数据）
   - 产品馆 `loadCategories` 增加 `?refresh=1`，并输出二级分类调试日志

4. **二级分类映射**：产品馆二级分类与风格库二级分类独立，通过前端映射关联（如 女→女士、男→男士、儿童→男童+女童）；后续可在产品编辑页增加绑定配置
