# 创建订单失败：UniqueViolation 重复键修复

## 问题现象

- 小程序支付页点击「确认支付」后报错：`订单组1创建失败`
- 控制台错误：`psycopg2.errors.UniqueViolation: 错误:重复键`

## 原因

按二级分类分组创建订单时，同一批次的多个商品会共用**同一个订单号**（`order_number`），每个商品对应一条 `orders` 表记录。若数据库中 `orders.order_number` 存在唯一约束，插入第二条相同订单号的记录时会触发 `UniqueViolation`。

## 解决方案

移除 `orders` 表中 `order_number` 的唯一约束（模型层已支持多记录共用订单号，数据库需同步）。

### 方法一：Python 脚本（推荐）

```bash
# 确保已设置 DATABASE_URL
python scripts/database/remove_order_number_unique_postgresql.py
```

Windows 可直接运行：
```
scripts\tools\fix_order_unique_constraint.bat
```

### 方法二：SQL 直接执行

```bash
psql -U aistudio_user -d pet_painting -f scripts/database/remove_order_number_unique_postgresql.sql
```

或手动执行：
```sql
ALTER TABLE orders DROP CONSTRAINT IF EXISTS orders_order_number_key;
```

### 验证

执行后再次在小程序支付页创建订单，应能正常完成。
