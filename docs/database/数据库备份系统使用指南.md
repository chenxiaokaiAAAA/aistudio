# 数据库备份系统使用指南

## 📋 概述

数据库备份系统用于自动备份和恢复所有数据库文件，确保数据安全。系统支持定时备份、手动备份、备份历史查看等功能。

## 🎯 功能特点

### 现有备份功能
- ✅ **手动备份**: `safe_backup_current.py` - 手动创建当前数据库的备份
- ✅ **图片清理备份**: `scheduled_cleanup.py` - 备份已清理的图片到百度云
  - 每天 02:00 执行清理任务
  - 每天 12:00 执行备份任务

### 新增数据库备份功能
- ✅ **自动备份**: 每天凌晨3点自动备份所有数据库文件
- ✅ **手动备份**: 随时手动触发数据库备份
- ✅ **历史管理**: 自动保留最近30天的备份，自动清理旧备份
- ✅ **备份日志**: 记录每次备份的详细信息
- ✅ **统计信息**: 查看备份目录的统计信息

## 🚀 快速开始

### 1. 手动执行备份

```bash
# 执行一次完整备份
python database_backup_scheduler.py --run
```

**输出示例**:
```
========================================================================================
🔰 开始执行数据库备份任务 - 2025-10-28 22:30:00
========================================================================================
✅ 备份成功: pet_painting.db.20251028_223000.bak (2,456,789 字节)
✅ 备份成功: pet_painting.db.20251028_223000.bak (1,234,567 字节)
✅ 清理完成，删除了 5 个旧备份文件

========================================================================================
✅ 备份任务完成
   备份文件数: 2
   总大小: 3,691,356 字节 (3.52 MB)
   删除旧备份: 5
   备份目录总文件: 60
   备份目录总大小: 245,678,901 字节 (234.24 MB)
========================================================================================
```

### 2. 查看备份历史

```bash
python database_backup_scheduler.py --history
```

**输出示例**:
```
📋 备份历史（最近20条）:
================================================================================

时间: 2025-10-28T22:30:00
状态: completed
备份文件数: 2
总大小: 3,691,356 字节
```

### 3. 查看统计信息

```bash
python database_backup_scheduler.py --stats
```

**输出示例**:
```
📊 备份统计:
  总文件数: 60
  总大小: 245,678,901 字节 (234.24 MB)
```

### 4. 启动定时备份调度器

```bash
python database_backup_scheduler.py --schedule
```

这将启动后台调度器，自动在每天凌晨3点执行备份。

## ⏰ 定时备份配置

### Windows系统

#### 方法1：使用调度器（推荐）

```bash
# 启动调度器（需要保持命令行窗口打开）
python database_backup_scheduler.py --schedule
```

#### 方法2：使用Windows任务计划程序

```bash
# 1. 创建Windows任务脚本
python database_backup_scheduler.py --windows-task

# 2. 在Windows任务计划程序中设置:
#    - 触发器: 每天 03:00
#    - 操作: 启动程序 -> run_database_backup.bat
```

### Linux系统

使用cron设置定时任务:

```bash
# 编辑crontab
crontab -e

# 添加以下行（每天凌晨3点执行备份）
0 3 * * * cd /path/to/pet-painting-system && python database_backup_scheduler.py --run
```

## 📁 备份文件说明

### 备份位置

所有备份文件存储在:
```
instance/backups/
```

### 文件命名格式

```
{数据库文件名}.{时间戳}.bak

例如:
pet_painting.db.20251028_223000.bak
```

### 备份保留策略

- **保留天数**: 30天
- **自动清理**: 超过30天的备份文件会被自动删除
- **手动清理**: 可以随时手动删除旧备份

## 🔍 备份文件结构

```
instance/backups/
├── pet_painting.db.20251001_030000.bak
├── pet_painting.db.20251002_030000.bak
├── pet_painting.db.20251003_030000.bak
└── ...
```

## 📊 日志记录

备份系统会记录每次备份的详细信息到 `database_backup_log.json`:

```json
[
  {
    "timestamp": "2025-10-28T03:00:00",
    "status": "completed",
    "backups": [
      {
        "backup_name": "pet_painting.db.20251028_030000.bak",
        "backup_path": "instance/backups/pet_painting.db.20251028_030000.bak",
        "original_path": "instance/pet_painting.db",
        "size": 2456789,
        "timestamp": "20251028_030000"
      }
    ],
    "backed_up_count": 1,
    "total_size": 2456789,
    "deleted_count": 1,
    "backup_stats": {
      "total_files": 30,
      "total_size": 123456789
    }
  }
]
```

## 🛡️ 恢复数据库

### 方法1：手动恢复

```bash
# 1. 找到需要恢复的备份文件
ls instance/backups/

# 2. 复制备份文件覆盖当前数据库
cp instance/backups/pet_painting.db.20251028_030000.bak instance/pet_painting.db

# 3. 重启应用
```

### 方法2：使用现有恢复工具

```bash
# 使用现有的恢复工具
python restore_from_backup.py
```

## 📈 备份统计

### 备份配置

系统会自动备份以下数据库文件:
- `instance/pet_painting.db` - 主数据库
- `pet_painting.db` - 根目录数据库（如果存在）

### 备份时间

- **默认**: 每天凌晨 3:00
- **可选**: 每12小时备份一次（需要修改代码）

### 备份大小

根据实际数据量，每个备份文件大约:
- 小型系统 (< 10MB): 通常 < 5MB
- 中型系统 (10-100MB): 通常 10-50MB
- 大型系统 (> 100MB): 可能 > 100MB

## ⚠️ 注意事项

1. **磁盘空间**: 确保备份目录有足够的磁盘空间
   - 30天备份大约占用: 备份大小 × 30
   - 建议预留至少 500MB 空间

2. **备份一致性**: 
   - 备份是在数据库运行时进行的（文件复制）
   - 对于SQLite数据库，这是安全的（事务一致性）

3. **备份完整性**:
   - 备份后会自动验证文件大小
   - 建议定期检查备份文件

4. **灾难恢复**:
   - 建议定期将备份复制到其他服务器或云存储
   - 可以使用 `baidu_cloud_backup.py` 上传到百度云

## 🔧 配置选项

### 修改保留天数

编辑 `database_backup_scheduler.py`:

```python
self.retention_days = 30  # 修改为需要的天数
```

### 修改备份时间

编辑 `database_backup_scheduler.py`:

```python
# 每天凌晨3点执行备份
schedule.every().day.at("03:00").do(self.run_backup_task)

# 修改为其他时间，例如每天晚上11点
schedule.every().day.at("23:00").do(self.run_backup_task)
```

### 修改备份目录

编辑 `database_backup_scheduler.py`:

```python
BACKUP_DIR = 'instance/backups'  # 修改为其他目录
```

## 📞 故障排除

### 问题1: 备份失败

**症状**: 备份任务显示失败

**解决**:
1. 检查数据库文件是否被占用
2. 检查磁盘空间是否充足
3. 检查备份目录权限

### 问题2: 备份文件过大

**症状**: 备份文件占用过多磁盘空间

**解决**:
1. 减少保留天数
2. 手动删除旧备份
3. 考虑将备份上传到云存储

### 问题3: 定时任务不执行

**症状**: Windows定时任务不运行

**解决**:
1. 检查任务计划程序中的任务状态
2. 验证Python路径是否正确
3. 检查日志文件查看错误信息

## 📝 维护建议

### 日常维护

1. **每周检查**: 查看备份历史，确认备份正常运行
2. **每月清理**: 手动清理不需要的旧备份
3. **每季度测试**: 测试恢复流程，确保备份可用

### 监控要点

- 备份文件大小变化
- 备份执行成功率
- 磁盘空间使用情况
- 备份日志中的错误

## 🔄 与其他备份系统的关系

### 数据层级备份

1. **数据库备份** (本系统)
   - 备份所有数据库文件
   - 备份频率: 每日

2. **图片清理备份** (`scheduled_cleanup.py`)
   - 备份已清理的图片到百度云
   - 备份频率: 每日（12:00和02:00）

3. **完整系统备份** (建议)
   - 备份整个 `instance/` 目录
   - 备份频率: 每周或每月

## 📚 相关文件

- `database_backup_scheduler.py` - 数据库备份调度器
- `safe_backup_current.py` - 手动备份工具
- `scheduled_cleanup.py` - 图片清理调度器
- `baidu_cloud_backup.py` - 百度云备份管理器
- `restore_from_backup.py` - 数据库恢复工具
- `instance/backups/` - 备份文件存储目录
- `database_backup_log.json` - 备份日志文件

## ✅ 总结

通过实施这套完整的备份系统，您的数据将得到多层保护:

1. ✅ **每日自动备份** - 数据库文件每天自动备份
2. ✅ **自动清理** - 自动删除30天前的旧备份
3. ✅ **详细日志** - 记录每次备份的详细信息
4. ✅ **随时恢复** - 快速恢复任何历史备份
5. ✅ **灵活配置** - 可根据需要调整备份策略

建议立即启动定时备份，确保数据安全！


